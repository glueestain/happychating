(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function k_(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Lh={exports:{}},el={};var ZS;function Hw(){if(ZS)return el;ZS=1;var s=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(n,i,o){var u=null;if(o!==void 0&&(u=""+o),i.key!==void 0&&(u=""+i.key),"key"in i){o={};for(var d in i)d!=="key"&&(o[d]=i[d])}else o=i;return i=o.ref,{$$typeof:s,type:n,key:u,ref:i!==void 0?i:null,props:o}}return el.Fragment=e,el.jsx=t,el.jsxs=t,el}var $S;function Vw(){return $S||($S=1,Lh.exports=Hw()),Lh.exports}var Ee=Vw(),xh={exports:{}},Je={};var eb;function Gw(){if(eb)return Je;eb=1;var s=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),n=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),o=Symbol.for("react.consumer"),u=Symbol.for("react.context"),d=Symbol.for("react.forward_ref"),h=Symbol.for("react.suspense"),f=Symbol.for("react.memo"),m=Symbol.for("react.lazy"),g=Symbol.for("react.activity"),S=Symbol.iterator;function _(H){return H===null||typeof H!="object"?null:(H=S&&H[S]||H["@@iterator"],typeof H=="function"?H:null)}var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},T=Object.assign,k={};function A(H,le,Re){this.props=H,this.context=le,this.refs=k,this.updater=Re||b}A.prototype.isReactComponent={},A.prototype.setState=function(H,le){if(typeof H!="object"&&typeof H!="function"&&H!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,H,le,"setState")},A.prototype.forceUpdate=function(H){this.updater.enqueueForceUpdate(this,H,"forceUpdate")};function C(){}C.prototype=A.prototype;function U(H,le,Re){this.props=H,this.context=le,this.refs=k,this.updater=Re||b}var O=U.prototype=new C;O.constructor=U,T(O,A.prototype),O.isPureReactComponent=!0;var M=Array.isArray;function E(){}var I={H:null,A:null,T:null,S:null},w=Object.prototype.hasOwnProperty;function q(H,le,Re){var X=Re.ref;return{$$typeof:s,type:H,key:le,ref:X!==void 0?X:null,props:Re}}function z(H,le){return q(H.type,le,H.props)}function ue(H){return typeof H=="object"&&H!==null&&H.$$typeof===s}function Se(H){var le={"=":"=0",":":"=2"};return"$"+H.replace(/[=:]/g,function(Re){return le[Re]})}var Ie=/\/+/g;function Ze(H,le){return typeof H=="object"&&H!==null&&H.key!=null?Se(""+H.key):le.toString(36)}function me(H){switch(H.status){case"fulfilled":return H.value;case"rejected":throw H.reason;default:switch(typeof H.status=="string"?H.then(E,E):(H.status="pending",H.then(function(le){H.status==="pending"&&(H.status="fulfilled",H.value=le)},function(le){H.status==="pending"&&(H.status="rejected",H.reason=le)})),H.status){case"fulfilled":return H.value;case"rejected":throw H.reason}}throw H}function J(H,le,Re,X,fe){var B=typeof H;(B==="undefined"||B==="boolean")&&(H=null);var F=!1;if(H===null)F=!0;else switch(B){case"bigint":case"string":case"number":F=!0;break;case"object":switch(H.$$typeof){case s:case e:F=!0;break;case m:return F=H._init,J(F(H._payload),le,Re,X,fe)}}if(F)return fe=fe(H),F=X===""?"."+Ze(H,0):X,M(fe)?(Re="",F!=null&&(Re=F.replace(Ie,"$&/")+"/"),J(fe,le,Re,"",function(P){return P})):fe!=null&&(ue(fe)&&(fe=z(fe,Re+(fe.key==null||H&&H.key===fe.key?"":(""+fe.key).replace(Ie,"$&/")+"/")+F)),le.push(fe)),1;F=0;var x=X===""?".":X+":";if(M(H))for(var j=0;j<H.length;j++)X=H[j],B=x+Ze(X,j),F+=J(X,le,Re,B,fe);else if(j=_(H),typeof j=="function")for(H=j.call(H),j=0;!(X=H.next()).done;)X=X.value,B=x+Ze(X,j++),F+=J(X,le,Re,B,fe);else if(B==="object"){if(typeof H.then=="function")return J(me(H),le,Re,X,fe);throw le=String(H),Error("Objects are not valid as a React child (found: "+(le==="[object Object]"?"object with keys {"+Object.keys(H).join(", ")+"}":le)+"). If you meant to render a collection of children, use an array instead.")}return F}function oe(H,le,Re){if(H==null)return H;var X=[],fe=0;return J(H,X,"","",function(B){return le.call(Re,B,fe++)}),X}function pe(H){if(H._status===-1){var le=H._result;le=le(),le.then(function(Re){(H._status===0||H._status===-1)&&(H._status=1,H._result=Re)},function(Re){(H._status===0||H._status===-1)&&(H._status=2,H._result=Re)}),H._status===-1&&(H._status=0,H._result=le)}if(H._status===1)return H._result.default;throw H._result}var Te=typeof reportError=="function"?reportError:function(H){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var le=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof H=="object"&&H!==null&&typeof H.message=="string"?String(H.message):String(H),error:H});if(!window.dispatchEvent(le))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",H);return}console.error(H)},De={map:oe,forEach:function(H,le,Re){oe(H,function(){le.apply(this,arguments)},Re)},count:function(H){var le=0;return oe(H,function(){le++}),le},toArray:function(H){return oe(H,function(le){return le})||[]},only:function(H){if(!ue(H))throw Error("React.Children.only expected to receive a single React element child.");return H}};return Je.Activity=g,Je.Children=De,Je.Component=A,Je.Fragment=t,Je.Profiler=i,Je.PureComponent=U,Je.StrictMode=n,Je.Suspense=h,Je.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=I,Je.__COMPILER_RUNTIME={__proto__:null,c:function(H){return I.H.useMemoCache(H)}},Je.cache=function(H){return function(){return H.apply(null,arguments)}},Je.cacheSignal=function(){return null},Je.cloneElement=function(H,le,Re){if(H==null)throw Error("The argument must be a React element, but you passed "+H+".");var X=T({},H.props),fe=H.key;if(le!=null)for(B in le.key!==void 0&&(fe=""+le.key),le)!w.call(le,B)||B==="key"||B==="__self"||B==="__source"||B==="ref"&&le.ref===void 0||(X[B]=le[B]);var B=arguments.length-2;if(B===1)X.children=Re;else if(1<B){for(var F=Array(B),x=0;x<B;x++)F[x]=arguments[x+2];X.children=F}return q(H.type,fe,X)},Je.createContext=function(H){return H={$$typeof:u,_currentValue:H,_currentValue2:H,_threadCount:0,Provider:null,Consumer:null},H.Provider=H,H.Consumer={$$typeof:o,_context:H},H},Je.createElement=function(H,le,Re){var X,fe={},B=null;if(le!=null)for(X in le.key!==void 0&&(B=""+le.key),le)w.call(le,X)&&X!=="key"&&X!=="__self"&&X!=="__source"&&(fe[X]=le[X]);var F=arguments.length-2;if(F===1)fe.children=Re;else if(1<F){for(var x=Array(F),j=0;j<F;j++)x[j]=arguments[j+2];fe.children=x}if(H&&H.defaultProps)for(X in F=H.defaultProps,F)fe[X]===void 0&&(fe[X]=F[X]);return q(H,B,fe)},Je.createRef=function(){return{current:null}},Je.forwardRef=function(H){return{$$typeof:d,render:H}},Je.isValidElement=ue,Je.lazy=function(H){return{$$typeof:m,_payload:{_status:-1,_result:H},_init:pe}},Je.memo=function(H,le){return{$$typeof:f,type:H,compare:le===void 0?null:le}},Je.startTransition=function(H){var le=I.T,Re={};I.T=Re;try{var X=H(),fe=I.S;fe!==null&&fe(Re,X),typeof X=="object"&&X!==null&&typeof X.then=="function"&&X.then(E,Te)}catch(B){Te(B)}finally{le!==null&&Re.types!==null&&(le.types=Re.types),I.T=le}},Je.unstable_useCacheRefresh=function(){return I.H.useCacheRefresh()},Je.use=function(H){return I.H.use(H)},Je.useActionState=function(H,le,Re){return I.H.useActionState(H,le,Re)},Je.useCallback=function(H,le){return I.H.useCallback(H,le)},Je.useContext=function(H){return I.H.useContext(H)},Je.useDebugValue=function(){},Je.useDeferredValue=function(H,le){return I.H.useDeferredValue(H,le)},Je.useEffect=function(H,le){return I.H.useEffect(H,le)},Je.useEffectEvent=function(H){return I.H.useEffectEvent(H)},Je.useId=function(){return I.H.useId()},Je.useImperativeHandle=function(H,le,Re){return I.H.useImperativeHandle(H,le,Re)},Je.useInsertionEffect=function(H,le){return I.H.useInsertionEffect(H,le)},Je.useLayoutEffect=function(H,le){return I.H.useLayoutEffect(H,le)},Je.useMemo=function(H,le){return I.H.useMemo(H,le)},Je.useOptimistic=function(H,le){return I.H.useOptimistic(H,le)},Je.useReducer=function(H,le,Re){return I.H.useReducer(H,le,Re)},Je.useRef=function(H){return I.H.useRef(H)},Je.useState=function(H){return I.H.useState(H)},Je.useSyncExternalStore=function(H,le,Re){return I.H.useSyncExternalStore(H,le,Re)},Je.useTransition=function(){return I.H.useTransition()},Je.version="19.2.3",Je}var tb;function fm(){return tb||(tb=1,xh.exports=Gw()),xh.exports}var st=fm(),jh={exports:{}},tl={},Bh={exports:{}},Fh={};var nb;function zw(){return nb||(nb=1,(function(s){function e(J,oe){var pe=J.length;J.push(oe);e:for(;0<pe;){var Te=pe-1>>>1,De=J[Te];if(0<i(De,oe))J[Te]=oe,J[pe]=De,pe=Te;else break e}}function t(J){return J.length===0?null:J[0]}function n(J){if(J.length===0)return null;var oe=J[0],pe=J.pop();if(pe!==oe){J[0]=pe;e:for(var Te=0,De=J.length,H=De>>>1;Te<H;){var le=2*(Te+1)-1,Re=J[le],X=le+1,fe=J[X];if(0>i(Re,pe))X<De&&0>i(fe,Re)?(J[Te]=fe,J[X]=pe,Te=X):(J[Te]=Re,J[le]=pe,Te=le);else if(X<De&&0>i(fe,pe))J[Te]=fe,J[X]=pe,Te=X;else break e}}return oe}function i(J,oe){var pe=J.sortIndex-oe.sortIndex;return pe!==0?pe:J.id-oe.id}if(s.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var o=performance;s.unstable_now=function(){return o.now()}}else{var u=Date,d=u.now();s.unstable_now=function(){return u.now()-d}}var h=[],f=[],m=1,g=null,S=3,_=!1,b=!1,T=!1,k=!1,A=typeof setTimeout=="function"?setTimeout:null,C=typeof clearTimeout=="function"?clearTimeout:null,U=typeof setImmediate<"u"?setImmediate:null;function O(J){for(var oe=t(f);oe!==null;){if(oe.callback===null)n(f);else if(oe.startTime<=J)n(f),oe.sortIndex=oe.expirationTime,e(h,oe);else break;oe=t(f)}}function M(J){if(T=!1,O(J),!b)if(t(h)!==null)b=!0,E||(E=!0,Se());else{var oe=t(f);oe!==null&&me(M,oe.startTime-J)}}var E=!1,I=-1,w=5,q=-1;function z(){return k?!0:!(s.unstable_now()-q<w)}function ue(){if(k=!1,E){var J=s.unstable_now();q=J;var oe=!0;try{e:{b=!1,T&&(T=!1,C(I),I=-1),_=!0;var pe=S;try{t:{for(O(J),g=t(h);g!==null&&!(g.expirationTime>J&&z());){var Te=g.callback;if(typeof Te=="function"){g.callback=null,S=g.priorityLevel;var De=Te(g.expirationTime<=J);if(J=s.unstable_now(),typeof De=="function"){g.callback=De,O(J),oe=!0;break t}g===t(h)&&n(h),O(J)}else n(h);g=t(h)}if(g!==null)oe=!0;else{var H=t(f);H!==null&&me(M,H.startTime-J),oe=!1}}break e}finally{g=null,S=pe,_=!1}oe=void 0}}finally{oe?Se():E=!1}}}var Se;if(typeof U=="function")Se=function(){U(ue)};else if(typeof MessageChannel<"u"){var Ie=new MessageChannel,Ze=Ie.port2;Ie.port1.onmessage=ue,Se=function(){Ze.postMessage(null)}}else Se=function(){A(ue,0)};function me(J,oe){I=A(function(){J(s.unstable_now())},oe)}s.unstable_IdlePriority=5,s.unstable_ImmediatePriority=1,s.unstable_LowPriority=4,s.unstable_NormalPriority=3,s.unstable_Profiling=null,s.unstable_UserBlockingPriority=2,s.unstable_cancelCallback=function(J){J.callback=null},s.unstable_forceFrameRate=function(J){0>J||125<J?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):w=0<J?Math.floor(1e3/J):5},s.unstable_getCurrentPriorityLevel=function(){return S},s.unstable_next=function(J){switch(S){case 1:case 2:case 3:var oe=3;break;default:oe=S}var pe=S;S=oe;try{return J()}finally{S=pe}},s.unstable_requestPaint=function(){k=!0},s.unstable_runWithPriority=function(J,oe){switch(J){case 1:case 2:case 3:case 4:case 5:break;default:J=3}var pe=S;S=J;try{return oe()}finally{S=pe}},s.unstable_scheduleCallback=function(J,oe,pe){var Te=s.unstable_now();switch(typeof pe=="object"&&pe!==null?(pe=pe.delay,pe=typeof pe=="number"&&0<pe?Te+pe:Te):pe=Te,J){case 1:var De=-1;break;case 2:De=250;break;case 5:De=1073741823;break;case 4:De=1e4;break;default:De=5e3}return De=pe+De,J={id:m++,callback:oe,priorityLevel:J,startTime:pe,expirationTime:De,sortIndex:-1},pe>Te?(J.sortIndex=pe,e(f,J),t(h)===null&&J===t(f)&&(T?(C(I),I=-1):T=!0,me(M,pe-Te))):(J.sortIndex=De,e(h,J),b||_||(b=!0,E||(E=!0,Se()))),J},s.unstable_shouldYield=z,s.unstable_wrapCallback=function(J){var oe=S;return function(){var pe=S;S=oe;try{return J.apply(this,arguments)}finally{S=pe}}}})(Fh)),Fh}var rb;function Ww(){return rb||(rb=1,Bh.exports=zw()),Bh.exports}var qh={exports:{}},Sn={};var ib;function Yw(){if(ib)return Sn;ib=1;var s=fm();function e(h){var f="https://react.dev/errors/"+h;if(1<arguments.length){f+="?args[]="+encodeURIComponent(arguments[1]);for(var m=2;m<arguments.length;m++)f+="&args[]="+encodeURIComponent(arguments[m])}return"Minified React error #"+h+"; visit "+f+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function t(){}var n={d:{f:t,r:function(){throw Error(e(522))},D:t,C:t,L:t,m:t,X:t,S:t,M:t},p:0,findDOMNode:null},i=Symbol.for("react.portal");function o(h,f,m){var g=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:i,key:g==null?null:""+g,children:h,containerInfo:f,implementation:m}}var u=s.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function d(h,f){if(h==="font")return"";if(typeof f=="string")return f==="use-credentials"?f:""}return Sn.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=n,Sn.createPortal=function(h,f){var m=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!f||f.nodeType!==1&&f.nodeType!==9&&f.nodeType!==11)throw Error(e(299));return o(h,f,null,m)},Sn.flushSync=function(h){var f=u.T,m=n.p;try{if(u.T=null,n.p=2,h)return h()}finally{u.T=f,n.p=m,n.d.f()}},Sn.preconnect=function(h,f){typeof h=="string"&&(f?(f=f.crossOrigin,f=typeof f=="string"?f==="use-credentials"?f:"":void 0):f=null,n.d.C(h,f))},Sn.prefetchDNS=function(h){typeof h=="string"&&n.d.D(h)},Sn.preinit=function(h,f){if(typeof h=="string"&&f&&typeof f.as=="string"){var m=f.as,g=d(m,f.crossOrigin),S=typeof f.integrity=="string"?f.integrity:void 0,_=typeof f.fetchPriority=="string"?f.fetchPriority:void 0;m==="style"?n.d.S(h,typeof f.precedence=="string"?f.precedence:void 0,{crossOrigin:g,integrity:S,fetchPriority:_}):m==="script"&&n.d.X(h,{crossOrigin:g,integrity:S,fetchPriority:_,nonce:typeof f.nonce=="string"?f.nonce:void 0})}},Sn.preinitModule=function(h,f){if(typeof h=="string")if(typeof f=="object"&&f!==null){if(f.as==null||f.as==="script"){var m=d(f.as,f.crossOrigin);n.d.M(h,{crossOrigin:m,integrity:typeof f.integrity=="string"?f.integrity:void 0,nonce:typeof f.nonce=="string"?f.nonce:void 0})}}else f==null&&n.d.M(h)},Sn.preload=function(h,f){if(typeof h=="string"&&typeof f=="object"&&f!==null&&typeof f.as=="string"){var m=f.as,g=d(m,f.crossOrigin);n.d.L(h,m,{crossOrigin:g,integrity:typeof f.integrity=="string"?f.integrity:void 0,nonce:typeof f.nonce=="string"?f.nonce:void 0,type:typeof f.type=="string"?f.type:void 0,fetchPriority:typeof f.fetchPriority=="string"?f.fetchPriority:void 0,referrerPolicy:typeof f.referrerPolicy=="string"?f.referrerPolicy:void 0,imageSrcSet:typeof f.imageSrcSet=="string"?f.imageSrcSet:void 0,imageSizes:typeof f.imageSizes=="string"?f.imageSizes:void 0,media:typeof f.media=="string"?f.media:void 0})}},Sn.preloadModule=function(h,f){if(typeof h=="string")if(f){var m=d(f.as,f.crossOrigin);n.d.m(h,{as:typeof f.as=="string"&&f.as!=="script"?f.as:void 0,crossOrigin:m,integrity:typeof f.integrity=="string"?f.integrity:void 0})}else n.d.m(h)},Sn.requestFormReset=function(h){n.d.r(h)},Sn.unstable_batchedUpdates=function(h,f){return h(f)},Sn.useFormState=function(h,f,m){return u.H.useFormState(h,f,m)},Sn.useFormStatus=function(){return u.H.useHostTransitionStatus()},Sn.version="19.2.3",Sn}var ab;function Jw(){if(ab)return qh.exports;ab=1;function s(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(s)}catch(e){console.error(e)}}return s(),qh.exports=Yw(),qh.exports}var sb;function Xw(){if(sb)return tl;sb=1;var s=Ww(),e=fm(),t=Jw();function n(r){var a="https://react.dev/errors/"+r;if(1<arguments.length){a+="?args[]="+encodeURIComponent(arguments[1]);for(var l=2;l<arguments.length;l++)a+="&args[]="+encodeURIComponent(arguments[l])}return"Minified React error #"+r+"; visit "+a+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function i(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}function o(r){var a=r,l=r;if(r.alternate)for(;a.return;)a=a.return;else{r=a;do a=r,(a.flags&4098)!==0&&(l=a.return),r=a.return;while(r)}return a.tag===3?l:null}function u(r){if(r.tag===13){var a=r.memoizedState;if(a===null&&(r=r.alternate,r!==null&&(a=r.memoizedState)),a!==null)return a.dehydrated}return null}function d(r){if(r.tag===31){var a=r.memoizedState;if(a===null&&(r=r.alternate,r!==null&&(a=r.memoizedState)),a!==null)return a.dehydrated}return null}function h(r){if(o(r)!==r)throw Error(n(188))}function f(r){var a=r.alternate;if(!a){if(a=o(r),a===null)throw Error(n(188));return a!==r?null:r}for(var l=r,c=a;;){var v=l.return;if(v===null)break;var p=v.alternate;if(p===null){if(c=v.return,c!==null){l=c;continue}break}if(v.child===p.child){for(p=v.child;p;){if(p===l)return h(v),r;if(p===c)return h(v),a;p=p.sibling}throw Error(n(188))}if(l.return!==c.return)l=v,c=p;else{for(var R=!1,L=v.child;L;){if(L===l){R=!0,l=v,c=p;break}if(L===c){R=!0,c=v,l=p;break}L=L.sibling}if(!R){for(L=p.child;L;){if(L===l){R=!0,l=p,c=v;break}if(L===c){R=!0,c=p,l=v;break}L=L.sibling}if(!R)throw Error(n(189))}}if(l.alternate!==c)throw Error(n(190))}if(l.tag!==3)throw Error(n(188));return l.stateNode.current===l?r:a}function m(r){var a=r.tag;if(a===5||a===26||a===27||a===6)return r;for(r=r.child;r!==null;){if(a=m(r),a!==null)return a;r=r.sibling}return null}var g=Object.assign,S=Symbol.for("react.element"),_=Symbol.for("react.transitional.element"),b=Symbol.for("react.portal"),T=Symbol.for("react.fragment"),k=Symbol.for("react.strict_mode"),A=Symbol.for("react.profiler"),C=Symbol.for("react.consumer"),U=Symbol.for("react.context"),O=Symbol.for("react.forward_ref"),M=Symbol.for("react.suspense"),E=Symbol.for("react.suspense_list"),I=Symbol.for("react.memo"),w=Symbol.for("react.lazy"),q=Symbol.for("react.activity"),z=Symbol.for("react.memo_cache_sentinel"),ue=Symbol.iterator;function Se(r){return r===null||typeof r!="object"?null:(r=ue&&r[ue]||r["@@iterator"],typeof r=="function"?r:null)}var Ie=Symbol.for("react.client.reference");function Ze(r){if(r==null)return null;if(typeof r=="function")return r.$$typeof===Ie?null:r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case T:return"Fragment";case A:return"Profiler";case k:return"StrictMode";case M:return"Suspense";case E:return"SuspenseList";case q:return"Activity"}if(typeof r=="object")switch(r.$$typeof){case b:return"Portal";case U:return r.displayName||"Context";case C:return(r._context.displayName||"Context")+".Consumer";case O:var a=r.render;return r=r.displayName,r||(r=a.displayName||a.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case I:return a=r.displayName||null,a!==null?a:Ze(r.type)||"Memo";case w:a=r._payload,r=r._init;try{return Ze(r(a))}catch{}}return null}var me=Array.isArray,J=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,oe=t.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,pe={pending:!1,data:null,method:null,action:null},Te=[],De=-1;function H(r){return{current:r}}function le(r){0>De||(r.current=Te[De],Te[De]=null,De--)}function Re(r,a){De++,Te[De]=r.current,r.current=a}var X=H(null),fe=H(null),B=H(null),F=H(null);function x(r,a){switch(Re(B,a),Re(fe,r),Re(X,null),a.nodeType){case 9:case 11:r=(r=a.documentElement)&&(r=r.namespaceURI)?ES(r):0;break;default:if(r=a.tagName,a=a.namespaceURI)a=ES(a),r=_S(a,r);else switch(r){case"svg":r=1;break;case"math":r=2;break;default:r=0}}le(X),Re(X,r)}function j(){le(X),le(fe),le(B)}function P(r){r.memoizedState!==null&&Re(F,r);var a=X.current,l=_S(a,r.type);a!==l&&(Re(fe,r),Re(X,l))}function G(r){fe.current===r&&(le(X),le(fe)),F.current===r&&(le(F),Xo._currentValue=pe)}var V,Y;function $(r){if(V===void 0)try{throw Error()}catch(l){var a=l.stack.trim().match(/\n( *(at )?)/);V=a&&a[1]||"",Y=-1<l.stack.indexOf(`
    at`)?" (<anonymous>)":-1<l.stack.indexOf("@")?"@unknown:0:0":""}return`
`+V+r+Y}var re=!1;function ye(r,a){if(!r||re)return"";re=!0;var l=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var c={DetermineComponentFrameRoot:function(){try{if(a){var ge=function(){throw Error()};if(Object.defineProperty(ge.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(ge,[])}catch(ce){var ie=ce}Reflect.construct(r,[],ge)}else{try{ge.call()}catch(ce){ie=ce}r.call(ge.prototype)}}else{try{throw Error()}catch(ce){ie=ce}(ge=r())&&typeof ge.catch=="function"&&ge.catch(function(){})}}catch(ce){if(ce&&ie&&typeof ce.stack=="string")return[ce.stack,ie.stack]}return[null,null]}};c.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var v=Object.getOwnPropertyDescriptor(c.DetermineComponentFrameRoot,"name");v&&v.configurable&&Object.defineProperty(c.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var p=c.DetermineComponentFrameRoot(),R=p[0],L=p[1];if(R&&L){var K=R.split(`
`),ne=L.split(`
`);for(v=c=0;c<K.length&&!K[c].includes("DetermineComponentFrameRoot");)c++;for(;v<ne.length&&!ne[v].includes("DetermineComponentFrameRoot");)v++;if(c===K.length||v===ne.length)for(c=K.length-1,v=ne.length-1;1<=c&&0<=v&&K[c]!==ne[v];)v--;for(;1<=c&&0<=v;c--,v--)if(K[c]!==ne[v]){if(c!==1||v!==1)do if(c--,v--,0>v||K[c]!==ne[v]){var he=`
`+K[c].replace(" at new "," at ");return r.displayName&&he.includes("<anonymous>")&&(he=he.replace("<anonymous>",r.displayName)),he}while(1<=c&&0<=v);break}}}finally{re=!1,Error.prepareStackTrace=l}return(l=r?r.displayName||r.name:"")?$(l):""}function Be(r,a){switch(r.tag){case 26:case 27:case 5:return $(r.type);case 16:return $("Lazy");case 13:return r.child!==a&&a!==null?$("Suspense Fallback"):$("Suspense");case 19:return $("SuspenseList");case 0:case 15:return ye(r.type,!1);case 11:return ye(r.type.render,!1);case 1:return ye(r.type,!0);case 31:return $("Activity");default:return""}}function Pe(r){try{var a="",l=null;do a+=Be(r,l),l=r,r=r.return;while(r);return a}catch(c){return`
Error generating stack: `+c.message+`
`+c.stack}}var Ae=Object.prototype.hasOwnProperty,qe=s.unstable_scheduleCallback,pt=s.unstable_cancelCallback,xt=s.unstable_shouldYield,we=s.unstable_requestPaint,ze=s.unstable_now,gi=s.unstable_getCurrentPriorityLevel,wr=s.unstable_ImmediatePriority,za=s.unstable_UserBlockingPriority,vr=s.unstable_NormalPriority,ra=s.unstable_LowPriority,Cr=s.unstable_IdlePriority,yi=s.log,Me=s.unstable_setDisableYieldValue,be=null,ee=null;function ae(r){if(typeof yi=="function"&&Me(r),ee&&typeof ee.setStrictMode=="function")try{ee.setStrictMode(be,r)}catch{}}var de=Math.clz32?Math.clz32:xe,_e=Math.log,Ne=Math.LN2;function xe(r){return r>>>=0,r===0?32:31-(_e(r)/Ne|0)|0}var tt=256,bt=262144,Et=4194304;function Bt(r){var a=r&42;if(a!==0)return a;switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return r&261888;case 262144:case 524288:case 1048576:case 2097152:return r&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return r&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return r}}function Nn(r,a,l){var c=r.pendingLanes;if(c===0)return 0;var v=0,p=r.suspendedLanes,R=r.pingedLanes;r=r.warmLanes;var L=c&134217727;return L!==0?(c=L&~p,c!==0?v=Bt(c):(R&=L,R!==0?v=Bt(R):l||(l=L&~r,l!==0&&(v=Bt(l))))):(L=c&~p,L!==0?v=Bt(L):R!==0?v=Bt(R):l||(l=c&~r,l!==0&&(v=Bt(l)))),v===0?0:a!==0&&a!==v&&(a&p)===0&&(p=v&-v,l=a&-a,p>=l||p===32&&(l&4194048)!==0)?a:v}function Ln(r,a){return(r.pendingLanes&~(r.suspendedLanes&~r.pingedLanes)&a)===0}function AT(r,a){switch(r){case 1:case 2:case 4:case 8:case 64:return a+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return a+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function np(){var r=Et;return Et<<=1,(Et&62914560)===0&&(Et=4194304),r}function Td(r){for(var a=[],l=0;31>l;l++)a.push(r);return a}function uo(r,a){r.pendingLanes|=a,a!==268435456&&(r.suspendedLanes=0,r.pingedLanes=0,r.warmLanes=0)}function DT(r,a,l,c,v,p){var R=r.pendingLanes;r.pendingLanes=l,r.suspendedLanes=0,r.pingedLanes=0,r.warmLanes=0,r.expiredLanes&=l,r.entangledLanes&=l,r.errorRecoveryDisabledLanes&=l,r.shellSuspendCounter=0;var L=r.entanglements,K=r.expirationTimes,ne=r.hiddenUpdates;for(l=R&~l;0<l;){var he=31-de(l),ge=1<<he;L[he]=0,K[he]=-1;var ie=ne[he];if(ie!==null)for(ne[he]=null,he=0;he<ie.length;he++){var ce=ie[he];ce!==null&&(ce.lane&=-536870913)}l&=~ge}c!==0&&rp(r,c,0),p!==0&&v===0&&r.tag!==0&&(r.suspendedLanes|=p&~(R&~a))}function rp(r,a,l){r.pendingLanes|=a,r.suspendedLanes&=~a;var c=31-de(a);r.entangledLanes|=a,r.entanglements[c]=r.entanglements[c]|1073741824|l&261930}function ip(r,a){var l=r.entangledLanes|=a;for(r=r.entanglements;l;){var c=31-de(l),v=1<<c;v&a|r[c]&a&&(r[c]|=a),l&=~v}}function ap(r,a){var l=a&-a;return l=(l&42)!==0?1:Rd(l),(l&(r.suspendedLanes|a))!==0?0:l}function Rd(r){switch(r){case 2:r=1;break;case 8:r=4;break;case 32:r=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:r=128;break;case 268435456:r=134217728;break;default:r=0}return r}function wd(r){return r&=-r,2<r?8<r?(r&134217727)!==0?32:268435456:8:2}function sp(){var r=oe.p;return r!==0?r:(r=window.event,r===void 0?32:GS(r.type))}function op(r,a){var l=oe.p;try{return oe.p=r,a()}finally{oe.p=l}}var Si=Math.random().toString(36).slice(2),cn="__reactFiber$"+Si,wn="__reactProps$"+Si,Wa="__reactContainer$"+Si,Cd="__reactEvents$"+Si,kT="__reactListeners$"+Si,UT="__reactHandles$"+Si,lp="__reactResources$"+Si,co="__reactMarker$"+Si;function Id(r){delete r[cn],delete r[wn],delete r[Cd],delete r[kT],delete r[UT]}function Ya(r){var a=r[cn];if(a)return a;for(var l=r.parentNode;l;){if(a=l[Wa]||l[cn]){if(l=a.alternate,a.child!==null||l!==null&&l.child!==null)for(r=MS(r);r!==null;){if(l=r[cn])return l;r=MS(r)}return a}r=l,l=r.parentNode}return null}function Ja(r){if(r=r[cn]||r[Wa]){var a=r.tag;if(a===5||a===6||a===13||a===31||a===26||a===27||a===3)return r}return null}function fo(r){var a=r.tag;if(a===5||a===26||a===27||a===6)return r.stateNode;throw Error(n(33))}function Xa(r){var a=r[lp];return a||(a=r[lp]={hoistableStyles:new Map,hoistableScripts:new Map}),a}function an(r){r[co]=!0}var up=new Set,cp={};function ia(r,a){Qa(r,a),Qa(r+"Capture",a)}function Qa(r,a){for(cp[r]=a,r=0;r<a.length;r++)up.add(a[r])}var PT=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),dp={},fp={};function NT(r){return Ae.call(fp,r)?!0:Ae.call(dp,r)?!1:PT.test(r)?fp[r]=!0:(dp[r]=!0,!1)}function ou(r,a,l){if(NT(a))if(l===null)r.removeAttribute(a);else{switch(typeof l){case"undefined":case"function":case"symbol":r.removeAttribute(a);return;case"boolean":var c=a.toLowerCase().slice(0,5);if(c!=="data-"&&c!=="aria-"){r.removeAttribute(a);return}}r.setAttribute(a,""+l)}}function lu(r,a,l){if(l===null)r.removeAttribute(a);else{switch(typeof l){case"undefined":case"function":case"symbol":case"boolean":r.removeAttribute(a);return}r.setAttribute(a,""+l)}}function Fr(r,a,l,c){if(c===null)r.removeAttribute(l);else{switch(typeof c){case"undefined":case"function":case"symbol":case"boolean":r.removeAttribute(l);return}r.setAttributeNS(a,l,""+c)}}function $n(r){switch(typeof r){case"bigint":case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}function hp(r){var a=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(a==="checkbox"||a==="radio")}function LT(r,a,l){var c=Object.getOwnPropertyDescriptor(r.constructor.prototype,a);if(!r.hasOwnProperty(a)&&typeof c<"u"&&typeof c.get=="function"&&typeof c.set=="function"){var v=c.get,p=c.set;return Object.defineProperty(r,a,{configurable:!0,get:function(){return v.call(this)},set:function(R){l=""+R,p.call(this,R)}}),Object.defineProperty(r,a,{enumerable:c.enumerable}),{getValue:function(){return l},setValue:function(R){l=""+R},stopTracking:function(){r._valueTracker=null,delete r[a]}}}}function Od(r){if(!r._valueTracker){var a=hp(r)?"checked":"value";r._valueTracker=LT(r,a,""+r[a])}}function vp(r){if(!r)return!1;var a=r._valueTracker;if(!a)return!0;var l=a.getValue(),c="";return r&&(c=hp(r)?r.checked?"true":"false":r.value),r=c,r!==l?(a.setValue(r),!0):!1}function uu(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}var xT=/[\n"\\]/g;function er(r){return r.replace(xT,function(a){return"\\"+a.charCodeAt(0).toString(16)+" "})}function Md(r,a,l,c,v,p,R,L){r.name="",R!=null&&typeof R!="function"&&typeof R!="symbol"&&typeof R!="boolean"?r.type=R:r.removeAttribute("type"),a!=null?R==="number"?(a===0&&r.value===""||r.value!=a)&&(r.value=""+$n(a)):r.value!==""+$n(a)&&(r.value=""+$n(a)):R!=="submit"&&R!=="reset"||r.removeAttribute("value"),a!=null?Ad(r,R,$n(a)):l!=null?Ad(r,R,$n(l)):c!=null&&r.removeAttribute("value"),v==null&&p!=null&&(r.defaultChecked=!!p),v!=null&&(r.checked=v&&typeof v!="function"&&typeof v!="symbol"),L!=null&&typeof L!="function"&&typeof L!="symbol"&&typeof L!="boolean"?r.name=""+$n(L):r.removeAttribute("name")}function mp(r,a,l,c,v,p,R,L){if(p!=null&&typeof p!="function"&&typeof p!="symbol"&&typeof p!="boolean"&&(r.type=p),a!=null||l!=null){if(!(p!=="submit"&&p!=="reset"||a!=null)){Od(r);return}l=l!=null?""+$n(l):"",a=a!=null?""+$n(a):l,L||a===r.value||(r.value=a),r.defaultValue=a}c=c??v,c=typeof c!="function"&&typeof c!="symbol"&&!!c,r.checked=L?r.checked:!!c,r.defaultChecked=!!c,R!=null&&typeof R!="function"&&typeof R!="symbol"&&typeof R!="boolean"&&(r.name=R),Od(r)}function Ad(r,a,l){a==="number"&&uu(r.ownerDocument)===r||r.defaultValue===""+l||(r.defaultValue=""+l)}function Za(r,a,l,c){if(r=r.options,a){a={};for(var v=0;v<l.length;v++)a["$"+l[v]]=!0;for(l=0;l<r.length;l++)v=a.hasOwnProperty("$"+r[l].value),r[l].selected!==v&&(r[l].selected=v),v&&c&&(r[l].defaultSelected=!0)}else{for(l=""+$n(l),a=null,v=0;v<r.length;v++){if(r[v].value===l){r[v].selected=!0,c&&(r[v].defaultSelected=!0);return}a!==null||r[v].disabled||(a=r[v])}a!==null&&(a.selected=!0)}}function pp(r,a,l){if(a!=null&&(a=""+$n(a),a!==r.value&&(r.value=a),l==null)){r.defaultValue!==a&&(r.defaultValue=a);return}r.defaultValue=l!=null?""+$n(l):""}function gp(r,a,l,c){if(a==null){if(c!=null){if(l!=null)throw Error(n(92));if(me(c)){if(1<c.length)throw Error(n(93));c=c[0]}l=c}l==null&&(l=""),a=l}l=$n(a),r.defaultValue=l,c=r.textContent,c===l&&c!==""&&c!==null&&(r.value=c),Od(r)}function $a(r,a){if(a){var l=r.firstChild;if(l&&l===r.lastChild&&l.nodeType===3){l.nodeValue=a;return}}r.textContent=a}var jT=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function yp(r,a,l){var c=a.indexOf("--")===0;l==null||typeof l=="boolean"||l===""?c?r.setProperty(a,""):a==="float"?r.cssFloat="":r[a]="":c?r.setProperty(a,l):typeof l!="number"||l===0||jT.has(a)?a==="float"?r.cssFloat=l:r[a]=(""+l).trim():r[a]=l+"px"}function Sp(r,a,l){if(a!=null&&typeof a!="object")throw Error(n(62));if(r=r.style,l!=null){for(var c in l)!l.hasOwnProperty(c)||a!=null&&a.hasOwnProperty(c)||(c.indexOf("--")===0?r.setProperty(c,""):c==="float"?r.cssFloat="":r[c]="");for(var v in a)c=a[v],a.hasOwnProperty(v)&&l[v]!==c&&yp(r,v,c)}else for(var p in a)a.hasOwnProperty(p)&&yp(r,p,a[p])}function Dd(r){if(r.indexOf("-")===-1)return!1;switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var BT=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),FT=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function cu(r){return FT.test(""+r)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":r}function qr(){}var kd=null;function Ud(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}var es=null,ts=null;function bp(r){var a=Ja(r);if(a&&(r=a.stateNode)){var l=r[wn]||null;e:switch(r=a.stateNode,a.type){case"input":if(Md(r,l.value,l.defaultValue,l.defaultValue,l.checked,l.defaultChecked,l.type,l.name),a=l.name,l.type==="radio"&&a!=null){for(l=r;l.parentNode;)l=l.parentNode;for(l=l.querySelectorAll('input[name="'+er(""+a)+'"][type="radio"]'),a=0;a<l.length;a++){var c=l[a];if(c!==r&&c.form===r.form){var v=c[wn]||null;if(!v)throw Error(n(90));Md(c,v.value,v.defaultValue,v.defaultValue,v.checked,v.defaultChecked,v.type,v.name)}}for(a=0;a<l.length;a++)c=l[a],c.form===r.form&&vp(c)}break e;case"textarea":pp(r,l.value,l.defaultValue);break e;case"select":a=l.value,a!=null&&Za(r,!!l.multiple,a,!1)}}}var Pd=!1;function Ep(r,a,l){if(Pd)return r(a,l);Pd=!0;try{var c=r(a);return c}finally{if(Pd=!1,(es!==null||ts!==null)&&(Qu(),es&&(a=es,r=ts,ts=es=null,bp(a),r)))for(a=0;a<r.length;a++)bp(r[a])}}function ho(r,a){var l=r.stateNode;if(l===null)return null;var c=l[wn]||null;if(c===null)return null;l=c[a];e:switch(a){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(c=!c.disabled)||(r=r.type,c=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!c;break e;default:r=!1}if(r)return null;if(l&&typeof l!="function")throw Error(n(231,a,typeof l));return l}var Kr=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Nd=!1;if(Kr)try{var vo={};Object.defineProperty(vo,"passive",{get:function(){Nd=!0}}),window.addEventListener("test",vo,vo),window.removeEventListener("test",vo,vo)}catch{Nd=!1}var bi=null,Ld=null,du=null;function _p(){if(du)return du;var r,a=Ld,l=a.length,c,v="value"in bi?bi.value:bi.textContent,p=v.length;for(r=0;r<l&&a[r]===v[r];r++);var R=l-r;for(c=1;c<=R&&a[l-c]===v[p-c];c++);return du=v.slice(r,1<c?1-c:void 0)}function fu(r){var a=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&a===13&&(r=13)):r=a,r===10&&(r=13),32<=r||r===13?r:0}function hu(){return!0}function Tp(){return!1}function Cn(r){function a(l,c,v,p,R){this._reactName=l,this._targetInst=v,this.type=c,this.nativeEvent=p,this.target=R,this.currentTarget=null;for(var L in r)r.hasOwnProperty(L)&&(l=r[L],this[L]=l?l(p):p[L]);return this.isDefaultPrevented=(p.defaultPrevented!=null?p.defaultPrevented:p.returnValue===!1)?hu:Tp,this.isPropagationStopped=Tp,this}return g(a.prototype,{preventDefault:function(){this.defaultPrevented=!0;var l=this.nativeEvent;l&&(l.preventDefault?l.preventDefault():typeof l.returnValue!="unknown"&&(l.returnValue=!1),this.isDefaultPrevented=hu)},stopPropagation:function(){var l=this.nativeEvent;l&&(l.stopPropagation?l.stopPropagation():typeof l.cancelBubble!="unknown"&&(l.cancelBubble=!0),this.isPropagationStopped=hu)},persist:function(){},isPersistent:hu}),a}var aa={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(r){return r.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},vu=Cn(aa),mo=g({},aa,{view:0,detail:0}),qT=Cn(mo),xd,jd,po,mu=g({},mo,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Fd,button:0,buttons:0,relatedTarget:function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},movementX:function(r){return"movementX"in r?r.movementX:(r!==po&&(po&&r.type==="mousemove"?(xd=r.screenX-po.screenX,jd=r.screenY-po.screenY):jd=xd=0,po=r),xd)},movementY:function(r){return"movementY"in r?r.movementY:jd}}),Rp=Cn(mu),KT=g({},mu,{dataTransfer:0}),HT=Cn(KT),VT=g({},mo,{relatedTarget:0}),Bd=Cn(VT),GT=g({},aa,{animationName:0,elapsedTime:0,pseudoElement:0}),zT=Cn(GT),WT=g({},aa,{clipboardData:function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData}}),YT=Cn(WT),JT=g({},aa,{data:0}),wp=Cn(JT),XT={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},QT={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},ZT={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function $T(r){var a=this.nativeEvent;return a.getModifierState?a.getModifierState(r):(r=ZT[r])?!!a[r]:!1}function Fd(){return $T}var eR=g({},mo,{key:function(r){if(r.key){var a=XT[r.key]||r.key;if(a!=="Unidentified")return a}return r.type==="keypress"?(r=fu(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?QT[r.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Fd,charCode:function(r){return r.type==="keypress"?fu(r):0},keyCode:function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},which:function(r){return r.type==="keypress"?fu(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0}}),tR=Cn(eR),nR=g({},mu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Cp=Cn(nR),rR=g({},mo,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Fd}),iR=Cn(rR),aR=g({},aa,{propertyName:0,elapsedTime:0,pseudoElement:0}),sR=Cn(aR),oR=g({},mu,{deltaX:function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},deltaY:function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},deltaZ:0,deltaMode:0}),lR=Cn(oR),uR=g({},aa,{newState:0,oldState:0}),cR=Cn(uR),dR=[9,13,27,32],qd=Kr&&"CompositionEvent"in window,go=null;Kr&&"documentMode"in document&&(go=document.documentMode);var fR=Kr&&"TextEvent"in window&&!go,Ip=Kr&&(!qd||go&&8<go&&11>=go),Op=" ",Mp=!1;function Ap(r,a){switch(r){case"keyup":return dR.indexOf(a.keyCode)!==-1;case"keydown":return a.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Dp(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}var ns=!1;function hR(r,a){switch(r){case"compositionend":return Dp(a);case"keypress":return a.which!==32?null:(Mp=!0,Op);case"textInput":return r=a.data,r===Op&&Mp?null:r;default:return null}}function vR(r,a){if(ns)return r==="compositionend"||!qd&&Ap(r,a)?(r=_p(),du=Ld=bi=null,ns=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(a.ctrlKey||a.altKey||a.metaKey)||a.ctrlKey&&a.altKey){if(a.char&&1<a.char.length)return a.char;if(a.which)return String.fromCharCode(a.which)}return null;case"compositionend":return Ip&&a.locale!=="ko"?null:a.data;default:return null}}var mR={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function kp(r){var a=r&&r.nodeName&&r.nodeName.toLowerCase();return a==="input"?!!mR[r.type]:a==="textarea"}function Up(r,a,l,c){es?ts?ts.push(c):ts=[c]:es=c,a=ic(a,"onChange"),0<a.length&&(l=new vu("onChange","change",null,l,c),r.push({event:l,listeners:a}))}var yo=null,So=null;function pR(r){mS(r,0)}function pu(r){var a=fo(r);if(vp(a))return r}function Pp(r,a){if(r==="change")return a}var Np=!1;if(Kr){var Kd;if(Kr){var Hd="oninput"in document;if(!Hd){var Lp=document.createElement("div");Lp.setAttribute("oninput","return;"),Hd=typeof Lp.oninput=="function"}Kd=Hd}else Kd=!1;Np=Kd&&(!document.documentMode||9<document.documentMode)}function xp(){yo&&(yo.detachEvent("onpropertychange",jp),So=yo=null)}function jp(r){if(r.propertyName==="value"&&pu(So)){var a=[];Up(a,So,r,Ud(r)),Ep(pR,a)}}function gR(r,a,l){r==="focusin"?(xp(),yo=a,So=l,yo.attachEvent("onpropertychange",jp)):r==="focusout"&&xp()}function yR(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return pu(So)}function SR(r,a){if(r==="click")return pu(a)}function bR(r,a){if(r==="input"||r==="change")return pu(a)}function ER(r,a){return r===a&&(r!==0||1/r===1/a)||r!==r&&a!==a}var xn=typeof Object.is=="function"?Object.is:ER;function bo(r,a){if(xn(r,a))return!0;if(typeof r!="object"||r===null||typeof a!="object"||a===null)return!1;var l=Object.keys(r),c=Object.keys(a);if(l.length!==c.length)return!1;for(c=0;c<l.length;c++){var v=l[c];if(!Ae.call(a,v)||!xn(r[v],a[v]))return!1}return!0}function Bp(r){for(;r&&r.firstChild;)r=r.firstChild;return r}function Fp(r,a){var l=Bp(r);r=0;for(var c;l;){if(l.nodeType===3){if(c=r+l.textContent.length,r<=a&&c>=a)return{node:l,offset:a-r};r=c}e:{for(;l;){if(l.nextSibling){l=l.nextSibling;break e}l=l.parentNode}l=void 0}l=Bp(l)}}function qp(r,a){return r&&a?r===a?!0:r&&r.nodeType===3?!1:a&&a.nodeType===3?qp(r,a.parentNode):"contains"in r?r.contains(a):r.compareDocumentPosition?!!(r.compareDocumentPosition(a)&16):!1:!1}function Kp(r){r=r!=null&&r.ownerDocument!=null&&r.ownerDocument.defaultView!=null?r.ownerDocument.defaultView:window;for(var a=uu(r.document);a instanceof r.HTMLIFrameElement;){try{var l=typeof a.contentWindow.location.href=="string"}catch{l=!1}if(l)r=a.contentWindow;else break;a=uu(r.document)}return a}function Vd(r){var a=r&&r.nodeName&&r.nodeName.toLowerCase();return a&&(a==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||a==="textarea"||r.contentEditable==="true")}var _R=Kr&&"documentMode"in document&&11>=document.documentMode,rs=null,Gd=null,Eo=null,zd=!1;function Hp(r,a,l){var c=l.window===l?l.document:l.nodeType===9?l:l.ownerDocument;zd||rs==null||rs!==uu(c)||(c=rs,"selectionStart"in c&&Vd(c)?c={start:c.selectionStart,end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset}),Eo&&bo(Eo,c)||(Eo=c,c=ic(Gd,"onSelect"),0<c.length&&(a=new vu("onSelect","select",null,a,l),r.push({event:a,listeners:c}),a.target=rs)))}function sa(r,a){var l={};return l[r.toLowerCase()]=a.toLowerCase(),l["Webkit"+r]="webkit"+a,l["Moz"+r]="moz"+a,l}var is={animationend:sa("Animation","AnimationEnd"),animationiteration:sa("Animation","AnimationIteration"),animationstart:sa("Animation","AnimationStart"),transitionrun:sa("Transition","TransitionRun"),transitionstart:sa("Transition","TransitionStart"),transitioncancel:sa("Transition","TransitionCancel"),transitionend:sa("Transition","TransitionEnd")},Wd={},Vp={};Kr&&(Vp=document.createElement("div").style,"AnimationEvent"in window||(delete is.animationend.animation,delete is.animationiteration.animation,delete is.animationstart.animation),"TransitionEvent"in window||delete is.transitionend.transition);function oa(r){if(Wd[r])return Wd[r];if(!is[r])return r;var a=is[r],l;for(l in a)if(a.hasOwnProperty(l)&&l in Vp)return Wd[r]=a[l];return r}var Gp=oa("animationend"),zp=oa("animationiteration"),Wp=oa("animationstart"),TR=oa("transitionrun"),RR=oa("transitionstart"),wR=oa("transitioncancel"),Yp=oa("transitionend"),Jp=new Map,Yd="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");Yd.push("scrollEnd");function mr(r,a){Jp.set(r,a),ia(a,[r])}var gu=typeof reportError=="function"?reportError:function(r){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var a=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof r=="object"&&r!==null&&typeof r.message=="string"?String(r.message):String(r),error:r});if(!window.dispatchEvent(a))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",r);return}console.error(r)},tr=[],as=0,Jd=0;function yu(){for(var r=as,a=Jd=as=0;a<r;){var l=tr[a];tr[a++]=null;var c=tr[a];tr[a++]=null;var v=tr[a];tr[a++]=null;var p=tr[a];if(tr[a++]=null,c!==null&&v!==null){var R=c.pending;R===null?v.next=v:(v.next=R.next,R.next=v),c.pending=v}p!==0&&Xp(l,v,p)}}function Su(r,a,l,c){tr[as++]=r,tr[as++]=a,tr[as++]=l,tr[as++]=c,Jd|=c,r.lanes|=c,r=r.alternate,r!==null&&(r.lanes|=c)}function Xd(r,a,l,c){return Su(r,a,l,c),bu(r)}function la(r,a){return Su(r,null,null,a),bu(r)}function Xp(r,a,l){r.lanes|=l;var c=r.alternate;c!==null&&(c.lanes|=l);for(var v=!1,p=r.return;p!==null;)p.childLanes|=l,c=p.alternate,c!==null&&(c.childLanes|=l),p.tag===22&&(r=p.stateNode,r===null||r._visibility&1||(v=!0)),r=p,p=p.return;return r.tag===3?(p=r.stateNode,v&&a!==null&&(v=31-de(l),r=p.hiddenUpdates,c=r[v],c===null?r[v]=[a]:c.push(a),a.lane=l|536870912),p):null}function bu(r){if(50<Ho)throw Ho=0,sh=null,Error(n(185));for(var a=r.return;a!==null;)r=a,a=r.return;return r.tag===3?r.stateNode:null}var ss={};function CR(r,a,l,c){this.tag=r,this.key=l,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=a,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=c,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function jn(r,a,l,c){return new CR(r,a,l,c)}function Qd(r){return r=r.prototype,!(!r||!r.isReactComponent)}function Hr(r,a){var l=r.alternate;return l===null?(l=jn(r.tag,a,r.key,r.mode),l.elementType=r.elementType,l.type=r.type,l.stateNode=r.stateNode,l.alternate=r,r.alternate=l):(l.pendingProps=a,l.type=r.type,l.flags=0,l.subtreeFlags=0,l.deletions=null),l.flags=r.flags&65011712,l.childLanes=r.childLanes,l.lanes=r.lanes,l.child=r.child,l.memoizedProps=r.memoizedProps,l.memoizedState=r.memoizedState,l.updateQueue=r.updateQueue,a=r.dependencies,l.dependencies=a===null?null:{lanes:a.lanes,firstContext:a.firstContext},l.sibling=r.sibling,l.index=r.index,l.ref=r.ref,l.refCleanup=r.refCleanup,l}function Qp(r,a){r.flags&=65011714;var l=r.alternate;return l===null?(r.childLanes=0,r.lanes=a,r.child=null,r.subtreeFlags=0,r.memoizedProps=null,r.memoizedState=null,r.updateQueue=null,r.dependencies=null,r.stateNode=null):(r.childLanes=l.childLanes,r.lanes=l.lanes,r.child=l.child,r.subtreeFlags=0,r.deletions=null,r.memoizedProps=l.memoizedProps,r.memoizedState=l.memoizedState,r.updateQueue=l.updateQueue,r.type=l.type,a=l.dependencies,r.dependencies=a===null?null:{lanes:a.lanes,firstContext:a.firstContext}),r}function Eu(r,a,l,c,v,p){var R=0;if(c=r,typeof r=="function")Qd(r)&&(R=1);else if(typeof r=="string")R=Dw(r,l,X.current)?26:r==="html"||r==="head"||r==="body"?27:5;else e:switch(r){case q:return r=jn(31,l,a,v),r.elementType=q,r.lanes=p,r;case T:return ua(l.children,v,p,a);case k:R=8,v|=24;break;case A:return r=jn(12,l,a,v|2),r.elementType=A,r.lanes=p,r;case M:return r=jn(13,l,a,v),r.elementType=M,r.lanes=p,r;case E:return r=jn(19,l,a,v),r.elementType=E,r.lanes=p,r;default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case U:R=10;break e;case C:R=9;break e;case O:R=11;break e;case I:R=14;break e;case w:R=16,c=null;break e}R=29,l=Error(n(130,r===null?"null":typeof r,"")),c=null}return a=jn(R,l,a,v),a.elementType=r,a.type=c,a.lanes=p,a}function ua(r,a,l,c){return r=jn(7,r,c,a),r.lanes=l,r}function Zd(r,a,l){return r=jn(6,r,null,a),r.lanes=l,r}function Zp(r){var a=jn(18,null,null,0);return a.stateNode=r,a}function $d(r,a,l){return a=jn(4,r.children!==null?r.children:[],r.key,a),a.lanes=l,a.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},a}var $p=new WeakMap;function nr(r,a){if(typeof r=="object"&&r!==null){var l=$p.get(r);return l!==void 0?l:(a={value:r,source:a,stack:Pe(a)},$p.set(r,a),a)}return{value:r,source:a,stack:Pe(a)}}var os=[],ls=0,_u=null,_o=0,rr=[],ir=0,Ei=null,Ir=1,Or="";function Vr(r,a){os[ls++]=_o,os[ls++]=_u,_u=r,_o=a}function eg(r,a,l){rr[ir++]=Ir,rr[ir++]=Or,rr[ir++]=Ei,Ei=r;var c=Ir;r=Or;var v=32-de(c)-1;c&=~(1<<v),l+=1;var p=32-de(a)+v;if(30<p){var R=v-v%5;p=(c&(1<<R)-1).toString(32),c>>=R,v-=R,Ir=1<<32-de(a)+v|l<<v|c,Or=p+r}else Ir=1<<p|l<<v|c,Or=r}function ef(r){r.return!==null&&(Vr(r,1),eg(r,1,0))}function tf(r){for(;r===_u;)_u=os[--ls],os[ls]=null,_o=os[--ls],os[ls]=null;for(;r===Ei;)Ei=rr[--ir],rr[ir]=null,Or=rr[--ir],rr[ir]=null,Ir=rr[--ir],rr[ir]=null}function tg(r,a){rr[ir++]=Ir,rr[ir++]=Or,rr[ir++]=Ei,Ir=a.id,Or=a.overflow,Ei=r}var dn=null,kt=null,ut=!1,_i=null,ar=!1,nf=Error(n(519));function Ti(r){var a=Error(n(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw To(nr(a,r)),nf}function ng(r){var a=r.stateNode,l=r.type,c=r.memoizedProps;switch(a[cn]=r,a[wn]=c,l){case"dialog":at("cancel",a),at("close",a);break;case"iframe":case"object":case"embed":at("load",a);break;case"video":case"audio":for(l=0;l<Go.length;l++)at(Go[l],a);break;case"source":at("error",a);break;case"img":case"image":case"link":at("error",a),at("load",a);break;case"details":at("toggle",a);break;case"input":at("invalid",a),mp(a,c.value,c.defaultValue,c.checked,c.defaultChecked,c.type,c.name,!0);break;case"select":at("invalid",a);break;case"textarea":at("invalid",a),gp(a,c.value,c.defaultValue,c.children)}l=c.children,typeof l!="string"&&typeof l!="number"&&typeof l!="bigint"||a.textContent===""+l||c.suppressHydrationWarning===!0||SS(a.textContent,l)?(c.popover!=null&&(at("beforetoggle",a),at("toggle",a)),c.onScroll!=null&&at("scroll",a),c.onScrollEnd!=null&&at("scrollend",a),c.onClick!=null&&(a.onclick=qr),a=!0):a=!1,a||Ti(r,!0)}function rg(r){for(dn=r.return;dn;)switch(dn.tag){case 5:case 31:case 13:ar=!1;return;case 27:case 3:ar=!0;return;default:dn=dn.return}}function us(r){if(r!==dn)return!1;if(!ut)return rg(r),ut=!0,!1;var a=r.tag,l;if((l=a!==3&&a!==27)&&((l=a===5)&&(l=r.type,l=!(l!=="form"&&l!=="button")||Eh(r.type,r.memoizedProps)),l=!l),l&&kt&&Ti(r),rg(r),a===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(n(317));kt=OS(r)}else if(a===31){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(n(317));kt=OS(r)}else a===27?(a=kt,xi(r.type)?(r=Ch,Ch=null,kt=r):kt=a):kt=dn?or(r.stateNode.nextSibling):null;return!0}function ca(){kt=dn=null,ut=!1}function rf(){var r=_i;return r!==null&&(An===null?An=r:An.push.apply(An,r),_i=null),r}function To(r){_i===null?_i=[r]:_i.push(r)}var af=H(null),da=null,Gr=null;function Ri(r,a,l){Re(af,a._currentValue),a._currentValue=l}function zr(r){r._currentValue=af.current,le(af)}function sf(r,a,l){for(;r!==null;){var c=r.alternate;if((r.childLanes&a)!==a?(r.childLanes|=a,c!==null&&(c.childLanes|=a)):c!==null&&(c.childLanes&a)!==a&&(c.childLanes|=a),r===l)break;r=r.return}}function of(r,a,l,c){var v=r.child;for(v!==null&&(v.return=r);v!==null;){var p=v.dependencies;if(p!==null){var R=v.child;p=p.firstContext;e:for(;p!==null;){var L=p;p=v;for(var K=0;K<a.length;K++)if(L.context===a[K]){p.lanes|=l,L=p.alternate,L!==null&&(L.lanes|=l),sf(p.return,l,r),c||(R=null);break e}p=L.next}}else if(v.tag===18){if(R=v.return,R===null)throw Error(n(341));R.lanes|=l,p=R.alternate,p!==null&&(p.lanes|=l),sf(R,l,r),R=null}else R=v.child;if(R!==null)R.return=v;else for(R=v;R!==null;){if(R===r){R=null;break}if(v=R.sibling,v!==null){v.return=R.return,R=v;break}R=R.return}v=R}}function cs(r,a,l,c){r=null;for(var v=a,p=!1;v!==null;){if(!p){if((v.flags&524288)!==0)p=!0;else if((v.flags&262144)!==0)break}if(v.tag===10){var R=v.alternate;if(R===null)throw Error(n(387));if(R=R.memoizedProps,R!==null){var L=v.type;xn(v.pendingProps.value,R.value)||(r!==null?r.push(L):r=[L])}}else if(v===F.current){if(R=v.alternate,R===null)throw Error(n(387));R.memoizedState.memoizedState!==v.memoizedState.memoizedState&&(r!==null?r.push(Xo):r=[Xo])}v=v.return}r!==null&&of(a,r,l,c),a.flags|=262144}function Tu(r){for(r=r.firstContext;r!==null;){if(!xn(r.context._currentValue,r.memoizedValue))return!0;r=r.next}return!1}function fa(r){da=r,Gr=null,r=r.dependencies,r!==null&&(r.firstContext=null)}function fn(r){return ig(da,r)}function Ru(r,a){return da===null&&fa(r),ig(r,a)}function ig(r,a){var l=a._currentValue;if(a={context:a,memoizedValue:l,next:null},Gr===null){if(r===null)throw Error(n(308));Gr=a,r.dependencies={lanes:0,firstContext:a},r.flags|=524288}else Gr=Gr.next=a;return l}var IR=typeof AbortController<"u"?AbortController:function(){var r=[],a=this.signal={aborted:!1,addEventListener:function(l,c){r.push(c)}};this.abort=function(){a.aborted=!0,r.forEach(function(l){return l()})}},OR=s.unstable_scheduleCallback,MR=s.unstable_NormalPriority,Jt={$$typeof:U,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function lf(){return{controller:new IR,data:new Map,refCount:0}}function Ro(r){r.refCount--,r.refCount===0&&OR(MR,function(){r.controller.abort()})}var wo=null,uf=0,ds=0,fs=null;function AR(r,a){if(wo===null){var l=wo=[];uf=0,ds=fh(),fs={status:"pending",value:void 0,then:function(c){l.push(c)}}}return uf++,a.then(ag,ag),a}function ag(){if(--uf===0&&wo!==null){fs!==null&&(fs.status="fulfilled");var r=wo;wo=null,ds=0,fs=null;for(var a=0;a<r.length;a++)(0,r[a])()}}function DR(r,a){var l=[],c={status:"pending",value:null,reason:null,then:function(v){l.push(v)}};return r.then(function(){c.status="fulfilled",c.value=a;for(var v=0;v<l.length;v++)(0,l[v])(a)},function(v){for(c.status="rejected",c.reason=v,v=0;v<l.length;v++)(0,l[v])(void 0)}),c}var sg=J.S;J.S=function(r,a){Hy=ze(),typeof a=="object"&&a!==null&&typeof a.then=="function"&&AR(r,a),sg!==null&&sg(r,a)};var ha=H(null);function cf(){var r=ha.current;return r!==null?r:Ct.pooledCache}function wu(r,a){a===null?Re(ha,ha.current):Re(ha,a.pool)}function og(){var r=cf();return r===null?null:{parent:Jt._currentValue,pool:r}}var hs=Error(n(460)),df=Error(n(474)),Cu=Error(n(542)),Iu={then:function(){}};function lg(r){return r=r.status,r==="fulfilled"||r==="rejected"}function ug(r,a,l){switch(l=r[l],l===void 0?r.push(a):l!==a&&(a.then(qr,qr),a=l),a.status){case"fulfilled":return a.value;case"rejected":throw r=a.reason,dg(r),r;default:if(typeof a.status=="string")a.then(qr,qr);else{if(r=Ct,r!==null&&100<r.shellSuspendCounter)throw Error(n(482));r=a,r.status="pending",r.then(function(c){if(a.status==="pending"){var v=a;v.status="fulfilled",v.value=c}},function(c){if(a.status==="pending"){var v=a;v.status="rejected",v.reason=c}})}switch(a.status){case"fulfilled":return a.value;case"rejected":throw r=a.reason,dg(r),r}throw ma=a,hs}}function va(r){try{var a=r._init;return a(r._payload)}catch(l){throw l!==null&&typeof l=="object"&&typeof l.then=="function"?(ma=l,hs):l}}var ma=null;function cg(){if(ma===null)throw Error(n(459));var r=ma;return ma=null,r}function dg(r){if(r===hs||r===Cu)throw Error(n(483))}var vs=null,Co=0;function Ou(r){var a=Co;return Co+=1,vs===null&&(vs=[]),ug(vs,r,a)}function Io(r,a){a=a.props.ref,r.ref=a!==void 0?a:null}function Mu(r,a){throw a.$$typeof===S?Error(n(525)):(r=Object.prototype.toString.call(a),Error(n(31,r==="[object Object]"?"object with keys {"+Object.keys(a).join(", ")+"}":r)))}function fg(r){function a(Q,W){if(r){var te=Q.deletions;te===null?(Q.deletions=[W],Q.flags|=16):te.push(W)}}function l(Q,W){if(!r)return null;for(;W!==null;)a(Q,W),W=W.sibling;return null}function c(Q){for(var W=new Map;Q!==null;)Q.key!==null?W.set(Q.key,Q):W.set(Q.index,Q),Q=Q.sibling;return W}function v(Q,W){return Q=Hr(Q,W),Q.index=0,Q.sibling=null,Q}function p(Q,W,te){return Q.index=te,r?(te=Q.alternate,te!==null?(te=te.index,te<W?(Q.flags|=67108866,W):te):(Q.flags|=67108866,W)):(Q.flags|=1048576,W)}function R(Q){return r&&Q.alternate===null&&(Q.flags|=67108866),Q}function L(Q,W,te,ve){return W===null||W.tag!==6?(W=Zd(te,Q.mode,ve),W.return=Q,W):(W=v(W,te),W.return=Q,W)}function K(Q,W,te,ve){var Fe=te.type;return Fe===T?he(Q,W,te.props.children,ve,te.key):W!==null&&(W.elementType===Fe||typeof Fe=="object"&&Fe!==null&&Fe.$$typeof===w&&va(Fe)===W.type)?(W=v(W,te.props),Io(W,te),W.return=Q,W):(W=Eu(te.type,te.key,te.props,null,Q.mode,ve),Io(W,te),W.return=Q,W)}function ne(Q,W,te,ve){return W===null||W.tag!==4||W.stateNode.containerInfo!==te.containerInfo||W.stateNode.implementation!==te.implementation?(W=$d(te,Q.mode,ve),W.return=Q,W):(W=v(W,te.children||[]),W.return=Q,W)}function he(Q,W,te,ve,Fe){return W===null||W.tag!==7?(W=ua(te,Q.mode,ve,Fe),W.return=Q,W):(W=v(W,te),W.return=Q,W)}function ge(Q,W,te){if(typeof W=="string"&&W!==""||typeof W=="number"||typeof W=="bigint")return W=Zd(""+W,Q.mode,te),W.return=Q,W;if(typeof W=="object"&&W!==null){switch(W.$$typeof){case _:return te=Eu(W.type,W.key,W.props,null,Q.mode,te),Io(te,W),te.return=Q,te;case b:return W=$d(W,Q.mode,te),W.return=Q,W;case w:return W=va(W),ge(Q,W,te)}if(me(W)||Se(W))return W=ua(W,Q.mode,te,null),W.return=Q,W;if(typeof W.then=="function")return ge(Q,Ou(W),te);if(W.$$typeof===U)return ge(Q,Ru(Q,W),te);Mu(Q,W)}return null}function ie(Q,W,te,ve){var Fe=W!==null?W.key:null;if(typeof te=="string"&&te!==""||typeof te=="number"||typeof te=="bigint")return Fe!==null?null:L(Q,W,""+te,ve);if(typeof te=="object"&&te!==null){switch(te.$$typeof){case _:return te.key===Fe?K(Q,W,te,ve):null;case b:return te.key===Fe?ne(Q,W,te,ve):null;case w:return te=va(te),ie(Q,W,te,ve)}if(me(te)||Se(te))return Fe!==null?null:he(Q,W,te,ve,null);if(typeof te.then=="function")return ie(Q,W,Ou(te),ve);if(te.$$typeof===U)return ie(Q,W,Ru(Q,te),ve);Mu(Q,te)}return null}function ce(Q,W,te,ve,Fe){if(typeof ve=="string"&&ve!==""||typeof ve=="number"||typeof ve=="bigint")return Q=Q.get(te)||null,L(W,Q,""+ve,Fe);if(typeof ve=="object"&&ve!==null){switch(ve.$$typeof){case _:return Q=Q.get(ve.key===null?te:ve.key)||null,K(W,Q,ve,Fe);case b:return Q=Q.get(ve.key===null?te:ve.key)||null,ne(W,Q,ve,Fe);case w:return ve=va(ve),ce(Q,W,te,ve,Fe)}if(me(ve)||Se(ve))return Q=Q.get(te)||null,he(W,Q,ve,Fe,null);if(typeof ve.then=="function")return ce(Q,W,te,Ou(ve),Fe);if(ve.$$typeof===U)return ce(Q,W,te,Ru(W,ve),Fe);Mu(W,ve)}return null}function Le(Q,W,te,ve){for(var Fe=null,dt=null,je=W,nt=W=0,lt=null;je!==null&&nt<te.length;nt++){je.index>nt?(lt=je,je=null):lt=je.sibling;var ft=ie(Q,je,te[nt],ve);if(ft===null){je===null&&(je=lt);break}r&&je&&ft.alternate===null&&a(Q,je),W=p(ft,W,nt),dt===null?Fe=ft:dt.sibling=ft,dt=ft,je=lt}if(nt===te.length)return l(Q,je),ut&&Vr(Q,nt),Fe;if(je===null){for(;nt<te.length;nt++)je=ge(Q,te[nt],ve),je!==null&&(W=p(je,W,nt),dt===null?Fe=je:dt.sibling=je,dt=je);return ut&&Vr(Q,nt),Fe}for(je=c(je);nt<te.length;nt++)lt=ce(je,Q,nt,te[nt],ve),lt!==null&&(r&&lt.alternate!==null&&je.delete(lt.key===null?nt:lt.key),W=p(lt,W,nt),dt===null?Fe=lt:dt.sibling=lt,dt=lt);return r&&je.forEach(function(Ki){return a(Q,Ki)}),ut&&Vr(Q,nt),Fe}function Ke(Q,W,te,ve){if(te==null)throw Error(n(151));for(var Fe=null,dt=null,je=W,nt=W=0,lt=null,ft=te.next();je!==null&&!ft.done;nt++,ft=te.next()){je.index>nt?(lt=je,je=null):lt=je.sibling;var Ki=ie(Q,je,ft.value,ve);if(Ki===null){je===null&&(je=lt);break}r&&je&&Ki.alternate===null&&a(Q,je),W=p(Ki,W,nt),dt===null?Fe=Ki:dt.sibling=Ki,dt=Ki,je=lt}if(ft.done)return l(Q,je),ut&&Vr(Q,nt),Fe;if(je===null){for(;!ft.done;nt++,ft=te.next())ft=ge(Q,ft.value,ve),ft!==null&&(W=p(ft,W,nt),dt===null?Fe=ft:dt.sibling=ft,dt=ft);return ut&&Vr(Q,nt),Fe}for(je=c(je);!ft.done;nt++,ft=te.next())ft=ce(je,Q,nt,ft.value,ve),ft!==null&&(r&&ft.alternate!==null&&je.delete(ft.key===null?nt:ft.key),W=p(ft,W,nt),dt===null?Fe=ft:dt.sibling=ft,dt=ft);return r&&je.forEach(function(Kw){return a(Q,Kw)}),ut&&Vr(Q,nt),Fe}function Rt(Q,W,te,ve){if(typeof te=="object"&&te!==null&&te.type===T&&te.key===null&&(te=te.props.children),typeof te=="object"&&te!==null){switch(te.$$typeof){case _:e:{for(var Fe=te.key;W!==null;){if(W.key===Fe){if(Fe=te.type,Fe===T){if(W.tag===7){l(Q,W.sibling),ve=v(W,te.props.children),ve.return=Q,Q=ve;break e}}else if(W.elementType===Fe||typeof Fe=="object"&&Fe!==null&&Fe.$$typeof===w&&va(Fe)===W.type){l(Q,W.sibling),ve=v(W,te.props),Io(ve,te),ve.return=Q,Q=ve;break e}l(Q,W);break}else a(Q,W);W=W.sibling}te.type===T?(ve=ua(te.props.children,Q.mode,ve,te.key),ve.return=Q,Q=ve):(ve=Eu(te.type,te.key,te.props,null,Q.mode,ve),Io(ve,te),ve.return=Q,Q=ve)}return R(Q);case b:e:{for(Fe=te.key;W!==null;){if(W.key===Fe)if(W.tag===4&&W.stateNode.containerInfo===te.containerInfo&&W.stateNode.implementation===te.implementation){l(Q,W.sibling),ve=v(W,te.children||[]),ve.return=Q,Q=ve;break e}else{l(Q,W);break}else a(Q,W);W=W.sibling}ve=$d(te,Q.mode,ve),ve.return=Q,Q=ve}return R(Q);case w:return te=va(te),Rt(Q,W,te,ve)}if(me(te))return Le(Q,W,te,ve);if(Se(te)){if(Fe=Se(te),typeof Fe!="function")throw Error(n(150));return te=Fe.call(te),Ke(Q,W,te,ve)}if(typeof te.then=="function")return Rt(Q,W,Ou(te),ve);if(te.$$typeof===U)return Rt(Q,W,Ru(Q,te),ve);Mu(Q,te)}return typeof te=="string"&&te!==""||typeof te=="number"||typeof te=="bigint"?(te=""+te,W!==null&&W.tag===6?(l(Q,W.sibling),ve=v(W,te),ve.return=Q,Q=ve):(l(Q,W),ve=Zd(te,Q.mode,ve),ve.return=Q,Q=ve),R(Q)):l(Q,W)}return function(Q,W,te,ve){try{Co=0;var Fe=Rt(Q,W,te,ve);return vs=null,Fe}catch(je){if(je===hs||je===Cu)throw je;var dt=jn(29,je,null,Q.mode);return dt.lanes=ve,dt.return=Q,dt}}}var pa=fg(!0),hg=fg(!1),wi=!1;function ff(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function hf(r,a){r=r.updateQueue,a.updateQueue===r&&(a.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,callbacks:null})}function Ci(r){return{lane:r,tag:0,payload:null,callback:null,next:null}}function Ii(r,a,l){var c=r.updateQueue;if(c===null)return null;if(c=c.shared,(vt&2)!==0){var v=c.pending;return v===null?a.next=a:(a.next=v.next,v.next=a),c.pending=a,a=bu(r),Xp(r,null,l),a}return Su(r,c,a,l),bu(r)}function Oo(r,a,l){if(a=a.updateQueue,a!==null&&(a=a.shared,(l&4194048)!==0)){var c=a.lanes;c&=r.pendingLanes,l|=c,a.lanes=l,ip(r,l)}}function vf(r,a){var l=r.updateQueue,c=r.alternate;if(c!==null&&(c=c.updateQueue,l===c)){var v=null,p=null;if(l=l.firstBaseUpdate,l!==null){do{var R={lane:l.lane,tag:l.tag,payload:l.payload,callback:null,next:null};p===null?v=p=R:p=p.next=R,l=l.next}while(l!==null);p===null?v=p=a:p=p.next=a}else v=p=a;l={baseState:c.baseState,firstBaseUpdate:v,lastBaseUpdate:p,shared:c.shared,callbacks:c.callbacks},r.updateQueue=l;return}r=l.lastBaseUpdate,r===null?l.firstBaseUpdate=a:r.next=a,l.lastBaseUpdate=a}var mf=!1;function Mo(){if(mf){var r=fs;if(r!==null)throw r}}function Ao(r,a,l,c){mf=!1;var v=r.updateQueue;wi=!1;var p=v.firstBaseUpdate,R=v.lastBaseUpdate,L=v.shared.pending;if(L!==null){v.shared.pending=null;var K=L,ne=K.next;K.next=null,R===null?p=ne:R.next=ne,R=K;var he=r.alternate;he!==null&&(he=he.updateQueue,L=he.lastBaseUpdate,L!==R&&(L===null?he.firstBaseUpdate=ne:L.next=ne,he.lastBaseUpdate=K))}if(p!==null){var ge=v.baseState;R=0,he=ne=K=null,L=p;do{var ie=L.lane&-536870913,ce=ie!==L.lane;if(ce?(ot&ie)===ie:(c&ie)===ie){ie!==0&&ie===ds&&(mf=!0),he!==null&&(he=he.next={lane:0,tag:L.tag,payload:L.payload,callback:null,next:null});e:{var Le=r,Ke=L;ie=a;var Rt=l;switch(Ke.tag){case 1:if(Le=Ke.payload,typeof Le=="function"){ge=Le.call(Rt,ge,ie);break e}ge=Le;break e;case 3:Le.flags=Le.flags&-65537|128;case 0:if(Le=Ke.payload,ie=typeof Le=="function"?Le.call(Rt,ge,ie):Le,ie==null)break e;ge=g({},ge,ie);break e;case 2:wi=!0}}ie=L.callback,ie!==null&&(r.flags|=64,ce&&(r.flags|=8192),ce=v.callbacks,ce===null?v.callbacks=[ie]:ce.push(ie))}else ce={lane:ie,tag:L.tag,payload:L.payload,callback:L.callback,next:null},he===null?(ne=he=ce,K=ge):he=he.next=ce,R|=ie;if(L=L.next,L===null){if(L=v.shared.pending,L===null)break;ce=L,L=ce.next,ce.next=null,v.lastBaseUpdate=ce,v.shared.pending=null}}while(!0);he===null&&(K=ge),v.baseState=K,v.firstBaseUpdate=ne,v.lastBaseUpdate=he,p===null&&(v.shared.lanes=0),ki|=R,r.lanes=R,r.memoizedState=ge}}function vg(r,a){if(typeof r!="function")throw Error(n(191,r));r.call(a)}function mg(r,a){var l=r.callbacks;if(l!==null)for(r.callbacks=null,r=0;r<l.length;r++)vg(l[r],a)}var ms=H(null),Au=H(0);function pg(r,a){r=ti,Re(Au,r),Re(ms,a),ti=r|a.baseLanes}function pf(){Re(Au,ti),Re(ms,ms.current)}function gf(){ti=Au.current,le(ms),le(Au)}var Bn=H(null),sr=null;function Oi(r){var a=r.alternate;Re(Gt,Gt.current&1),Re(Bn,r),sr===null&&(a===null||ms.current!==null||a.memoizedState!==null)&&(sr=r)}function yf(r){Re(Gt,Gt.current),Re(Bn,r),sr===null&&(sr=r)}function gg(r){r.tag===22?(Re(Gt,Gt.current),Re(Bn,r),sr===null&&(sr=r)):Mi()}function Mi(){Re(Gt,Gt.current),Re(Bn,Bn.current)}function Fn(r){le(Bn),sr===r&&(sr=null),le(Gt)}var Gt=H(0);function Du(r){for(var a=r;a!==null;){if(a.tag===13){var l=a.memoizedState;if(l!==null&&(l=l.dehydrated,l===null||Rh(l)||wh(l)))return a}else if(a.tag===19&&(a.memoizedProps.revealOrder==="forwards"||a.memoizedProps.revealOrder==="backwards"||a.memoizedProps.revealOrder==="unstable_legacy-backwards"||a.memoizedProps.revealOrder==="together")){if((a.flags&128)!==0)return a}else if(a.child!==null){a.child.return=a,a=a.child;continue}if(a===r)break;for(;a.sibling===null;){if(a.return===null||a.return===r)return null;a=a.return}a.sibling.return=a.return,a=a.sibling}return null}var Wr=0,$e=null,_t=null,Xt=null,ku=!1,ps=!1,ga=!1,Uu=0,Do=0,gs=null,kR=0;function qt(){throw Error(n(321))}function Sf(r,a){if(a===null)return!1;for(var l=0;l<a.length&&l<r.length;l++)if(!xn(r[l],a[l]))return!1;return!0}function bf(r,a,l,c,v,p){return Wr=p,$e=a,a.memoizedState=null,a.updateQueue=null,a.lanes=0,J.H=r===null||r.memoizedState===null?ey:Nf,ga=!1,p=l(c,v),ga=!1,ps&&(p=Sg(a,l,c,v)),yg(r),p}function yg(r){J.H=Po;var a=_t!==null&&_t.next!==null;if(Wr=0,Xt=_t=$e=null,ku=!1,Do=0,gs=null,a)throw Error(n(300));r===null||Qt||(r=r.dependencies,r!==null&&Tu(r)&&(Qt=!0))}function Sg(r,a,l,c){$e=r;var v=0;do{if(ps&&(gs=null),Do=0,ps=!1,25<=v)throw Error(n(301));if(v+=1,Xt=_t=null,r.updateQueue!=null){var p=r.updateQueue;p.lastEffect=null,p.events=null,p.stores=null,p.memoCache!=null&&(p.memoCache.index=0)}J.H=ty,p=a(l,c)}while(ps);return p}function UR(){var r=J.H,a=r.useState()[0];return a=typeof a.then=="function"?ko(a):a,r=r.useState()[0],(_t!==null?_t.memoizedState:null)!==r&&($e.flags|=1024),a}function Ef(){var r=Uu!==0;return Uu=0,r}function _f(r,a,l){a.updateQueue=r.updateQueue,a.flags&=-2053,r.lanes&=~l}function Tf(r){if(ku){for(r=r.memoizedState;r!==null;){var a=r.queue;a!==null&&(a.pending=null),r=r.next}ku=!1}Wr=0,Xt=_t=$e=null,ps=!1,Do=Uu=0,gs=null}function _n(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Xt===null?$e.memoizedState=Xt=r:Xt=Xt.next=r,Xt}function zt(){if(_t===null){var r=$e.alternate;r=r!==null?r.memoizedState:null}else r=_t.next;var a=Xt===null?$e.memoizedState:Xt.next;if(a!==null)Xt=a,_t=r;else{if(r===null)throw $e.alternate===null?Error(n(467)):Error(n(310));_t=r,r={memoizedState:_t.memoizedState,baseState:_t.baseState,baseQueue:_t.baseQueue,queue:_t.queue,next:null},Xt===null?$e.memoizedState=Xt=r:Xt=Xt.next=r}return Xt}function Pu(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function ko(r){var a=Do;return Do+=1,gs===null&&(gs=[]),r=ug(gs,r,a),a=$e,(Xt===null?a.memoizedState:Xt.next)===null&&(a=a.alternate,J.H=a===null||a.memoizedState===null?ey:Nf),r}function Nu(r){if(r!==null&&typeof r=="object"){if(typeof r.then=="function")return ko(r);if(r.$$typeof===U)return fn(r)}throw Error(n(438,String(r)))}function Rf(r){var a=null,l=$e.updateQueue;if(l!==null&&(a=l.memoCache),a==null){var c=$e.alternate;c!==null&&(c=c.updateQueue,c!==null&&(c=c.memoCache,c!=null&&(a={data:c.data.map(function(v){return v.slice()}),index:0})))}if(a==null&&(a={data:[],index:0}),l===null&&(l=Pu(),$e.updateQueue=l),l.memoCache=a,l=a.data[a.index],l===void 0)for(l=a.data[a.index]=Array(r),c=0;c<r;c++)l[c]=z;return a.index++,l}function Yr(r,a){return typeof a=="function"?a(r):a}function Lu(r){var a=zt();return wf(a,_t,r)}function wf(r,a,l){var c=r.queue;if(c===null)throw Error(n(311));c.lastRenderedReducer=l;var v=r.baseQueue,p=c.pending;if(p!==null){if(v!==null){var R=v.next;v.next=p.next,p.next=R}a.baseQueue=v=p,c.pending=null}if(p=r.baseState,v===null)r.memoizedState=p;else{a=v.next;var L=R=null,K=null,ne=a,he=!1;do{var ge=ne.lane&-536870913;if(ge!==ne.lane?(ot&ge)===ge:(Wr&ge)===ge){var ie=ne.revertLane;if(ie===0)K!==null&&(K=K.next={lane:0,revertLane:0,gesture:null,action:ne.action,hasEagerState:ne.hasEagerState,eagerState:ne.eagerState,next:null}),ge===ds&&(he=!0);else if((Wr&ie)===ie){ne=ne.next,ie===ds&&(he=!0);continue}else ge={lane:0,revertLane:ne.revertLane,gesture:null,action:ne.action,hasEagerState:ne.hasEagerState,eagerState:ne.eagerState,next:null},K===null?(L=K=ge,R=p):K=K.next=ge,$e.lanes|=ie,ki|=ie;ge=ne.action,ga&&l(p,ge),p=ne.hasEagerState?ne.eagerState:l(p,ge)}else ie={lane:ge,revertLane:ne.revertLane,gesture:ne.gesture,action:ne.action,hasEagerState:ne.hasEagerState,eagerState:ne.eagerState,next:null},K===null?(L=K=ie,R=p):K=K.next=ie,$e.lanes|=ge,ki|=ge;ne=ne.next}while(ne!==null&&ne!==a);if(K===null?R=p:K.next=L,!xn(p,r.memoizedState)&&(Qt=!0,he&&(l=fs,l!==null)))throw l;r.memoizedState=p,r.baseState=R,r.baseQueue=K,c.lastRenderedState=p}return v===null&&(c.lanes=0),[r.memoizedState,c.dispatch]}function Cf(r){var a=zt(),l=a.queue;if(l===null)throw Error(n(311));l.lastRenderedReducer=r;var c=l.dispatch,v=l.pending,p=a.memoizedState;if(v!==null){l.pending=null;var R=v=v.next;do p=r(p,R.action),R=R.next;while(R!==v);xn(p,a.memoizedState)||(Qt=!0),a.memoizedState=p,a.baseQueue===null&&(a.baseState=p),l.lastRenderedState=p}return[p,c]}function bg(r,a,l){var c=$e,v=zt(),p=ut;if(p){if(l===void 0)throw Error(n(407));l=l()}else l=a();var R=!xn((_t||v).memoizedState,l);if(R&&(v.memoizedState=l,Qt=!0),v=v.queue,Mf(Tg.bind(null,c,v,r),[r]),v.getSnapshot!==a||R||Xt!==null&&Xt.memoizedState.tag&1){if(c.flags|=2048,ys(9,{destroy:void 0},_g.bind(null,c,v,l,a),null),Ct===null)throw Error(n(349));p||(Wr&127)!==0||Eg(c,a,l)}return l}function Eg(r,a,l){r.flags|=16384,r={getSnapshot:a,value:l},a=$e.updateQueue,a===null?(a=Pu(),$e.updateQueue=a,a.stores=[r]):(l=a.stores,l===null?a.stores=[r]:l.push(r))}function _g(r,a,l,c){a.value=l,a.getSnapshot=c,Rg(a)&&wg(r)}function Tg(r,a,l){return l(function(){Rg(a)&&wg(r)})}function Rg(r){var a=r.getSnapshot;r=r.value;try{var l=a();return!xn(r,l)}catch{return!0}}function wg(r){var a=la(r,2);a!==null&&Dn(a,r,2)}function If(r){var a=_n();if(typeof r=="function"){var l=r;if(r=l(),ga){ae(!0);try{l()}finally{ae(!1)}}}return a.memoizedState=a.baseState=r,a.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Yr,lastRenderedState:r},a}function Cg(r,a,l,c){return r.baseState=l,wf(r,_t,typeof c=="function"?c:Yr)}function PR(r,a,l,c,v){if(Bu(r))throw Error(n(485));if(r=a.action,r!==null){var p={payload:v,action:r,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(R){p.listeners.push(R)}};J.T!==null?l(!0):p.isTransition=!1,c(p),l=a.pending,l===null?(p.next=a.pending=p,Ig(a,p)):(p.next=l.next,a.pending=l.next=p)}}function Ig(r,a){var l=a.action,c=a.payload,v=r.state;if(a.isTransition){var p=J.T,R={};J.T=R;try{var L=l(v,c),K=J.S;K!==null&&K(R,L),Og(r,a,L)}catch(ne){Of(r,a,ne)}finally{p!==null&&R.types!==null&&(p.types=R.types),J.T=p}}else try{p=l(v,c),Og(r,a,p)}catch(ne){Of(r,a,ne)}}function Og(r,a,l){l!==null&&typeof l=="object"&&typeof l.then=="function"?l.then(function(c){Mg(r,a,c)},function(c){return Of(r,a,c)}):Mg(r,a,l)}function Mg(r,a,l){a.status="fulfilled",a.value=l,Ag(a),r.state=l,a=r.pending,a!==null&&(l=a.next,l===a?r.pending=null:(l=l.next,a.next=l,Ig(r,l)))}function Of(r,a,l){var c=r.pending;if(r.pending=null,c!==null){c=c.next;do a.status="rejected",a.reason=l,Ag(a),a=a.next;while(a!==c)}r.action=null}function Ag(r){r=r.listeners;for(var a=0;a<r.length;a++)(0,r[a])()}function Dg(r,a){return a}function kg(r,a){if(ut){var l=Ct.formState;if(l!==null){e:{var c=$e;if(ut){if(kt){t:{for(var v=kt,p=ar;v.nodeType!==8;){if(!p){v=null;break t}if(v=or(v.nextSibling),v===null){v=null;break t}}p=v.data,v=p==="F!"||p==="F"?v:null}if(v){kt=or(v.nextSibling),c=v.data==="F!";break e}}Ti(c)}c=!1}c&&(a=l[0])}}return l=_n(),l.memoizedState=l.baseState=a,c={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Dg,lastRenderedState:a},l.queue=c,l=Qg.bind(null,$e,c),c.dispatch=l,c=If(!1),p=Pf.bind(null,$e,!1,c.queue),c=_n(),v={state:a,dispatch:null,action:r,pending:null},c.queue=v,l=PR.bind(null,$e,v,p,l),v.dispatch=l,c.memoizedState=r,[a,l,!1]}function Ug(r){var a=zt();return Pg(a,_t,r)}function Pg(r,a,l){if(a=wf(r,a,Dg)[0],r=Lu(Yr)[0],typeof a=="object"&&a!==null&&typeof a.then=="function")try{var c=ko(a)}catch(R){throw R===hs?Cu:R}else c=a;a=zt();var v=a.queue,p=v.dispatch;return l!==a.memoizedState&&($e.flags|=2048,ys(9,{destroy:void 0},NR.bind(null,v,l),null)),[c,p,r]}function NR(r,a){r.action=a}function Ng(r){var a=zt(),l=_t;if(l!==null)return Pg(a,l,r);zt(),a=a.memoizedState,l=zt();var c=l.queue.dispatch;return l.memoizedState=r,[a,c,!1]}function ys(r,a,l,c){return r={tag:r,create:l,deps:c,inst:a,next:null},a=$e.updateQueue,a===null&&(a=Pu(),$e.updateQueue=a),l=a.lastEffect,l===null?a.lastEffect=r.next=r:(c=l.next,l.next=r,r.next=c,a.lastEffect=r),r}function Lg(){return zt().memoizedState}function xu(r,a,l,c){var v=_n();$e.flags|=r,v.memoizedState=ys(1|a,{destroy:void 0},l,c===void 0?null:c)}function ju(r,a,l,c){var v=zt();c=c===void 0?null:c;var p=v.memoizedState.inst;_t!==null&&c!==null&&Sf(c,_t.memoizedState.deps)?v.memoizedState=ys(a,p,l,c):($e.flags|=r,v.memoizedState=ys(1|a,p,l,c))}function xg(r,a){xu(8390656,8,r,a)}function Mf(r,a){ju(2048,8,r,a)}function LR(r){$e.flags|=4;var a=$e.updateQueue;if(a===null)a=Pu(),$e.updateQueue=a,a.events=[r];else{var l=a.events;l===null?a.events=[r]:l.push(r)}}function jg(r){var a=zt().memoizedState;return LR({ref:a,nextImpl:r}),function(){if((vt&2)!==0)throw Error(n(440));return a.impl.apply(void 0,arguments)}}function Bg(r,a){return ju(4,2,r,a)}function Fg(r,a){return ju(4,4,r,a)}function qg(r,a){if(typeof a=="function"){r=r();var l=a(r);return function(){typeof l=="function"?l():a(null)}}if(a!=null)return r=r(),a.current=r,function(){a.current=null}}function Kg(r,a,l){l=l!=null?l.concat([r]):null,ju(4,4,qg.bind(null,a,r),l)}function Af(){}function Hg(r,a){var l=zt();a=a===void 0?null:a;var c=l.memoizedState;return a!==null&&Sf(a,c[1])?c[0]:(l.memoizedState=[r,a],r)}function Vg(r,a){var l=zt();a=a===void 0?null:a;var c=l.memoizedState;if(a!==null&&Sf(a,c[1]))return c[0];if(c=r(),ga){ae(!0);try{r()}finally{ae(!1)}}return l.memoizedState=[c,a],c}function Df(r,a,l){return l===void 0||(Wr&1073741824)!==0&&(ot&261930)===0?r.memoizedState=a:(r.memoizedState=l,r=Gy(),$e.lanes|=r,ki|=r,l)}function Gg(r,a,l,c){return xn(l,a)?l:ms.current!==null?(r=Df(r,l,c),xn(r,a)||(Qt=!0),r):(Wr&42)===0||(Wr&1073741824)!==0&&(ot&261930)===0?(Qt=!0,r.memoizedState=l):(r=Gy(),$e.lanes|=r,ki|=r,a)}function zg(r,a,l,c,v){var p=oe.p;oe.p=p!==0&&8>p?p:8;var R=J.T,L={};J.T=L,Pf(r,!1,a,l);try{var K=v(),ne=J.S;if(ne!==null&&ne(L,K),K!==null&&typeof K=="object"&&typeof K.then=="function"){var he=DR(K,c);Uo(r,a,he,Hn(r))}else Uo(r,a,c,Hn(r))}catch(ge){Uo(r,a,{then:function(){},status:"rejected",reason:ge},Hn())}finally{oe.p=p,R!==null&&L.types!==null&&(R.types=L.types),J.T=R}}function xR(){}function kf(r,a,l,c){if(r.tag!==5)throw Error(n(476));var v=Wg(r).queue;zg(r,v,a,pe,l===null?xR:function(){return Yg(r),l(c)})}function Wg(r){var a=r.memoizedState;if(a!==null)return a;a={memoizedState:pe,baseState:pe,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Yr,lastRenderedState:pe},next:null};var l={};return a.next={memoizedState:l,baseState:l,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Yr,lastRenderedState:l},next:null},r.memoizedState=a,r=r.alternate,r!==null&&(r.memoizedState=a),a}function Yg(r){var a=Wg(r);a.next===null&&(a=r.alternate.memoizedState),Uo(r,a.next.queue,{},Hn())}function Uf(){return fn(Xo)}function Jg(){return zt().memoizedState}function Xg(){return zt().memoizedState}function jR(r){for(var a=r.return;a!==null;){switch(a.tag){case 24:case 3:var l=Hn();r=Ci(l);var c=Ii(a,r,l);c!==null&&(Dn(c,a,l),Oo(c,a,l)),a={cache:lf()},r.payload=a;return}a=a.return}}function BR(r,a,l){var c=Hn();l={lane:c,revertLane:0,gesture:null,action:l,hasEagerState:!1,eagerState:null,next:null},Bu(r)?Zg(a,l):(l=Xd(r,a,l,c),l!==null&&(Dn(l,r,c),$g(l,a,c)))}function Qg(r,a,l){var c=Hn();Uo(r,a,l,c)}function Uo(r,a,l,c){var v={lane:c,revertLane:0,gesture:null,action:l,hasEagerState:!1,eagerState:null,next:null};if(Bu(r))Zg(a,v);else{var p=r.alternate;if(r.lanes===0&&(p===null||p.lanes===0)&&(p=a.lastRenderedReducer,p!==null))try{var R=a.lastRenderedState,L=p(R,l);if(v.hasEagerState=!0,v.eagerState=L,xn(L,R))return Su(r,a,v,0),Ct===null&&yu(),!1}catch{}if(l=Xd(r,a,v,c),l!==null)return Dn(l,r,c),$g(l,a,c),!0}return!1}function Pf(r,a,l,c){if(c={lane:2,revertLane:fh(),gesture:null,action:c,hasEagerState:!1,eagerState:null,next:null},Bu(r)){if(a)throw Error(n(479))}else a=Xd(r,l,c,2),a!==null&&Dn(a,r,2)}function Bu(r){var a=r.alternate;return r===$e||a!==null&&a===$e}function Zg(r,a){ps=ku=!0;var l=r.pending;l===null?a.next=a:(a.next=l.next,l.next=a),r.pending=a}function $g(r,a,l){if((l&4194048)!==0){var c=a.lanes;c&=r.pendingLanes,l|=c,a.lanes=l,ip(r,l)}}var Po={readContext:fn,use:Nu,useCallback:qt,useContext:qt,useEffect:qt,useImperativeHandle:qt,useLayoutEffect:qt,useInsertionEffect:qt,useMemo:qt,useReducer:qt,useRef:qt,useState:qt,useDebugValue:qt,useDeferredValue:qt,useTransition:qt,useSyncExternalStore:qt,useId:qt,useHostTransitionStatus:qt,useFormState:qt,useActionState:qt,useOptimistic:qt,useMemoCache:qt,useCacheRefresh:qt};Po.useEffectEvent=qt;var ey={readContext:fn,use:Nu,useCallback:function(r,a){return _n().memoizedState=[r,a===void 0?null:a],r},useContext:fn,useEffect:xg,useImperativeHandle:function(r,a,l){l=l!=null?l.concat([r]):null,xu(4194308,4,qg.bind(null,a,r),l)},useLayoutEffect:function(r,a){return xu(4194308,4,r,a)},useInsertionEffect:function(r,a){xu(4,2,r,a)},useMemo:function(r,a){var l=_n();a=a===void 0?null:a;var c=r();if(ga){ae(!0);try{r()}finally{ae(!1)}}return l.memoizedState=[c,a],c},useReducer:function(r,a,l){var c=_n();if(l!==void 0){var v=l(a);if(ga){ae(!0);try{l(a)}finally{ae(!1)}}}else v=a;return c.memoizedState=c.baseState=v,r={pending:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:v},c.queue=r,r=r.dispatch=BR.bind(null,$e,r),[c.memoizedState,r]},useRef:function(r){var a=_n();return r={current:r},a.memoizedState=r},useState:function(r){r=If(r);var a=r.queue,l=Qg.bind(null,$e,a);return a.dispatch=l,[r.memoizedState,l]},useDebugValue:Af,useDeferredValue:function(r,a){var l=_n();return Df(l,r,a)},useTransition:function(){var r=If(!1);return r=zg.bind(null,$e,r.queue,!0,!1),_n().memoizedState=r,[!1,r]},useSyncExternalStore:function(r,a,l){var c=$e,v=_n();if(ut){if(l===void 0)throw Error(n(407));l=l()}else{if(l=a(),Ct===null)throw Error(n(349));(ot&127)!==0||Eg(c,a,l)}v.memoizedState=l;var p={value:l,getSnapshot:a};return v.queue=p,xg(Tg.bind(null,c,p,r),[r]),c.flags|=2048,ys(9,{destroy:void 0},_g.bind(null,c,p,l,a),null),l},useId:function(){var r=_n(),a=Ct.identifierPrefix;if(ut){var l=Or,c=Ir;l=(c&~(1<<32-de(c)-1)).toString(32)+l,a="_"+a+"R_"+l,l=Uu++,0<l&&(a+="H"+l.toString(32)),a+="_"}else l=kR++,a="_"+a+"r_"+l.toString(32)+"_";return r.memoizedState=a},useHostTransitionStatus:Uf,useFormState:kg,useActionState:kg,useOptimistic:function(r){var a=_n();a.memoizedState=a.baseState=r;var l={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return a.queue=l,a=Pf.bind(null,$e,!0,l),l.dispatch=a,[r,a]},useMemoCache:Rf,useCacheRefresh:function(){return _n().memoizedState=jR.bind(null,$e)},useEffectEvent:function(r){var a=_n(),l={impl:r};return a.memoizedState=l,function(){if((vt&2)!==0)throw Error(n(440));return l.impl.apply(void 0,arguments)}}},Nf={readContext:fn,use:Nu,useCallback:Hg,useContext:fn,useEffect:Mf,useImperativeHandle:Kg,useInsertionEffect:Bg,useLayoutEffect:Fg,useMemo:Vg,useReducer:Lu,useRef:Lg,useState:function(){return Lu(Yr)},useDebugValue:Af,useDeferredValue:function(r,a){var l=zt();return Gg(l,_t.memoizedState,r,a)},useTransition:function(){var r=Lu(Yr)[0],a=zt().memoizedState;return[typeof r=="boolean"?r:ko(r),a]},useSyncExternalStore:bg,useId:Jg,useHostTransitionStatus:Uf,useFormState:Ug,useActionState:Ug,useOptimistic:function(r,a){var l=zt();return Cg(l,_t,r,a)},useMemoCache:Rf,useCacheRefresh:Xg};Nf.useEffectEvent=jg;var ty={readContext:fn,use:Nu,useCallback:Hg,useContext:fn,useEffect:Mf,useImperativeHandle:Kg,useInsertionEffect:Bg,useLayoutEffect:Fg,useMemo:Vg,useReducer:Cf,useRef:Lg,useState:function(){return Cf(Yr)},useDebugValue:Af,useDeferredValue:function(r,a){var l=zt();return _t===null?Df(l,r,a):Gg(l,_t.memoizedState,r,a)},useTransition:function(){var r=Cf(Yr)[0],a=zt().memoizedState;return[typeof r=="boolean"?r:ko(r),a]},useSyncExternalStore:bg,useId:Jg,useHostTransitionStatus:Uf,useFormState:Ng,useActionState:Ng,useOptimistic:function(r,a){var l=zt();return _t!==null?Cg(l,_t,r,a):(l.baseState=r,[r,l.queue.dispatch])},useMemoCache:Rf,useCacheRefresh:Xg};ty.useEffectEvent=jg;function Lf(r,a,l,c){a=r.memoizedState,l=l(c,a),l=l==null?a:g({},a,l),r.memoizedState=l,r.lanes===0&&(r.updateQueue.baseState=l)}var xf={enqueueSetState:function(r,a,l){r=r._reactInternals;var c=Hn(),v=Ci(c);v.payload=a,l!=null&&(v.callback=l),a=Ii(r,v,c),a!==null&&(Dn(a,r,c),Oo(a,r,c))},enqueueReplaceState:function(r,a,l){r=r._reactInternals;var c=Hn(),v=Ci(c);v.tag=1,v.payload=a,l!=null&&(v.callback=l),a=Ii(r,v,c),a!==null&&(Dn(a,r,c),Oo(a,r,c))},enqueueForceUpdate:function(r,a){r=r._reactInternals;var l=Hn(),c=Ci(l);c.tag=2,a!=null&&(c.callback=a),a=Ii(r,c,l),a!==null&&(Dn(a,r,l),Oo(a,r,l))}};function ny(r,a,l,c,v,p,R){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(c,p,R):a.prototype&&a.prototype.isPureReactComponent?!bo(l,c)||!bo(v,p):!0}function ry(r,a,l,c){r=a.state,typeof a.componentWillReceiveProps=="function"&&a.componentWillReceiveProps(l,c),typeof a.UNSAFE_componentWillReceiveProps=="function"&&a.UNSAFE_componentWillReceiveProps(l,c),a.state!==r&&xf.enqueueReplaceState(a,a.state,null)}function ya(r,a){var l=a;if("ref"in a){l={};for(var c in a)c!=="ref"&&(l[c]=a[c])}if(r=r.defaultProps){l===a&&(l=g({},l));for(var v in r)l[v]===void 0&&(l[v]=r[v])}return l}function iy(r){gu(r)}function ay(r){console.error(r)}function sy(r){gu(r)}function Fu(r,a){try{var l=r.onUncaughtError;l(a.value,{componentStack:a.stack})}catch(c){setTimeout(function(){throw c})}}function oy(r,a,l){try{var c=r.onCaughtError;c(l.value,{componentStack:l.stack,errorBoundary:a.tag===1?a.stateNode:null})}catch(v){setTimeout(function(){throw v})}}function jf(r,a,l){return l=Ci(l),l.tag=3,l.payload={element:null},l.callback=function(){Fu(r,a)},l}function ly(r){return r=Ci(r),r.tag=3,r}function uy(r,a,l,c){var v=l.type.getDerivedStateFromError;if(typeof v=="function"){var p=c.value;r.payload=function(){return v(p)},r.callback=function(){oy(a,l,c)}}var R=l.stateNode;R!==null&&typeof R.componentDidCatch=="function"&&(r.callback=function(){oy(a,l,c),typeof v!="function"&&(Ui===null?Ui=new Set([this]):Ui.add(this));var L=c.stack;this.componentDidCatch(c.value,{componentStack:L!==null?L:""})})}function FR(r,a,l,c,v){if(l.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){if(a=l.alternate,a!==null&&cs(a,l,v,!0),l=Bn.current,l!==null){switch(l.tag){case 31:case 13:return sr===null?Zu():l.alternate===null&&Kt===0&&(Kt=3),l.flags&=-257,l.flags|=65536,l.lanes=v,c===Iu?l.flags|=16384:(a=l.updateQueue,a===null?l.updateQueue=new Set([c]):a.add(c),uh(r,c,v)),!1;case 22:return l.flags|=65536,c===Iu?l.flags|=16384:(a=l.updateQueue,a===null?(a={transitions:null,markerInstances:null,retryQueue:new Set([c])},l.updateQueue=a):(l=a.retryQueue,l===null?a.retryQueue=new Set([c]):l.add(c)),uh(r,c,v)),!1}throw Error(n(435,l.tag))}return uh(r,c,v),Zu(),!1}if(ut)return a=Bn.current,a!==null?((a.flags&65536)===0&&(a.flags|=256),a.flags|=65536,a.lanes=v,c!==nf&&(r=Error(n(422),{cause:c}),To(nr(r,l)))):(c!==nf&&(a=Error(n(423),{cause:c}),To(nr(a,l))),r=r.current.alternate,r.flags|=65536,v&=-v,r.lanes|=v,c=nr(c,l),v=jf(r.stateNode,c,v),vf(r,v),Kt!==4&&(Kt=2)),!1;var p=Error(n(520),{cause:c});if(p=nr(p,l),Ko===null?Ko=[p]:Ko.push(p),Kt!==4&&(Kt=2),a===null)return!0;c=nr(c,l),l=a;do{switch(l.tag){case 3:return l.flags|=65536,r=v&-v,l.lanes|=r,r=jf(l.stateNode,c,r),vf(l,r),!1;case 1:if(a=l.type,p=l.stateNode,(l.flags&128)===0&&(typeof a.getDerivedStateFromError=="function"||p!==null&&typeof p.componentDidCatch=="function"&&(Ui===null||!Ui.has(p))))return l.flags|=65536,v&=-v,l.lanes|=v,v=ly(v),uy(v,r,l,c),vf(l,v),!1}l=l.return}while(l!==null);return!1}var Bf=Error(n(461)),Qt=!1;function hn(r,a,l,c){a.child=r===null?hg(a,null,l,c):pa(a,r.child,l,c)}function cy(r,a,l,c,v){l=l.render;var p=a.ref;if("ref"in c){var R={};for(var L in c)L!=="ref"&&(R[L]=c[L])}else R=c;return fa(a),c=bf(r,a,l,R,p,v),L=Ef(),r!==null&&!Qt?(_f(r,a,v),Jr(r,a,v)):(ut&&L&&ef(a),a.flags|=1,hn(r,a,c,v),a.child)}function dy(r,a,l,c,v){if(r===null){var p=l.type;return typeof p=="function"&&!Qd(p)&&p.defaultProps===void 0&&l.compare===null?(a.tag=15,a.type=p,fy(r,a,p,c,v)):(r=Eu(l.type,null,c,a,a.mode,v),r.ref=a.ref,r.return=a,a.child=r)}if(p=r.child,!Wf(r,v)){var R=p.memoizedProps;if(l=l.compare,l=l!==null?l:bo,l(R,c)&&r.ref===a.ref)return Jr(r,a,v)}return a.flags|=1,r=Hr(p,c),r.ref=a.ref,r.return=a,a.child=r}function fy(r,a,l,c,v){if(r!==null){var p=r.memoizedProps;if(bo(p,c)&&r.ref===a.ref)if(Qt=!1,a.pendingProps=c=p,Wf(r,v))(r.flags&131072)!==0&&(Qt=!0);else return a.lanes=r.lanes,Jr(r,a,v)}return Ff(r,a,l,c,v)}function hy(r,a,l,c){var v=c.children,p=r!==null?r.memoizedState:null;if(r===null&&a.stateNode===null&&(a.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),c.mode==="hidden"){if((a.flags&128)!==0){if(p=p!==null?p.baseLanes|l:l,r!==null){for(c=a.child=r.child,v=0;c!==null;)v=v|c.lanes|c.childLanes,c=c.sibling;c=v&~p}else c=0,a.child=null;return vy(r,a,p,l,c)}if((l&536870912)!==0)a.memoizedState={baseLanes:0,cachePool:null},r!==null&&wu(a,p!==null?p.cachePool:null),p!==null?pg(a,p):pf(),gg(a);else return c=a.lanes=536870912,vy(r,a,p!==null?p.baseLanes|l:l,l,c)}else p!==null?(wu(a,p.cachePool),pg(a,p),Mi(),a.memoizedState=null):(r!==null&&wu(a,null),pf(),Mi());return hn(r,a,v,l),a.child}function No(r,a){return r!==null&&r.tag===22||a.stateNode!==null||(a.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),a.sibling}function vy(r,a,l,c,v){var p=cf();return p=p===null?null:{parent:Jt._currentValue,pool:p},a.memoizedState={baseLanes:l,cachePool:p},r!==null&&wu(a,null),pf(),gg(a),r!==null&&cs(r,a,c,!0),a.childLanes=v,null}function qu(r,a){return a=Hu({mode:a.mode,children:a.children},r.mode),a.ref=r.ref,r.child=a,a.return=r,a}function my(r,a,l){return pa(a,r.child,null,l),r=qu(a,a.pendingProps),r.flags|=2,Fn(a),a.memoizedState=null,r}function qR(r,a,l){var c=a.pendingProps,v=(a.flags&128)!==0;if(a.flags&=-129,r===null){if(ut){if(c.mode==="hidden")return r=qu(a,c),a.lanes=536870912,No(null,r);if(yf(a),(r=kt)?(r=IS(r,ar),r=r!==null&&r.data==="&"?r:null,r!==null&&(a.memoizedState={dehydrated:r,treeContext:Ei!==null?{id:Ir,overflow:Or}:null,retryLane:536870912,hydrationErrors:null},l=Zp(r),l.return=a,a.child=l,dn=a,kt=null)):r=null,r===null)throw Ti(a);return a.lanes=536870912,null}return qu(a,c)}var p=r.memoizedState;if(p!==null){var R=p.dehydrated;if(yf(a),v)if(a.flags&256)a.flags&=-257,a=my(r,a,l);else if(a.memoizedState!==null)a.child=r.child,a.flags|=128,a=null;else throw Error(n(558));else if(Qt||cs(r,a,l,!1),v=(l&r.childLanes)!==0,Qt||v){if(c=Ct,c!==null&&(R=ap(c,l),R!==0&&R!==p.retryLane))throw p.retryLane=R,la(r,R),Dn(c,r,R),Bf;Zu(),a=my(r,a,l)}else r=p.treeContext,kt=or(R.nextSibling),dn=a,ut=!0,_i=null,ar=!1,r!==null&&tg(a,r),a=qu(a,c),a.flags|=4096;return a}return r=Hr(r.child,{mode:c.mode,children:c.children}),r.ref=a.ref,a.child=r,r.return=a,r}function Ku(r,a){var l=a.ref;if(l===null)r!==null&&r.ref!==null&&(a.flags|=4194816);else{if(typeof l!="function"&&typeof l!="object")throw Error(n(284));(r===null||r.ref!==l)&&(a.flags|=4194816)}}function Ff(r,a,l,c,v){return fa(a),l=bf(r,a,l,c,void 0,v),c=Ef(),r!==null&&!Qt?(_f(r,a,v),Jr(r,a,v)):(ut&&c&&ef(a),a.flags|=1,hn(r,a,l,v),a.child)}function py(r,a,l,c,v,p){return fa(a),a.updateQueue=null,l=Sg(a,c,l,v),yg(r),c=Ef(),r!==null&&!Qt?(_f(r,a,p),Jr(r,a,p)):(ut&&c&&ef(a),a.flags|=1,hn(r,a,l,p),a.child)}function gy(r,a,l,c,v){if(fa(a),a.stateNode===null){var p=ss,R=l.contextType;typeof R=="object"&&R!==null&&(p=fn(R)),p=new l(c,p),a.memoizedState=p.state!==null&&p.state!==void 0?p.state:null,p.updater=xf,a.stateNode=p,p._reactInternals=a,p=a.stateNode,p.props=c,p.state=a.memoizedState,p.refs={},ff(a),R=l.contextType,p.context=typeof R=="object"&&R!==null?fn(R):ss,p.state=a.memoizedState,R=l.getDerivedStateFromProps,typeof R=="function"&&(Lf(a,l,R,c),p.state=a.memoizedState),typeof l.getDerivedStateFromProps=="function"||typeof p.getSnapshotBeforeUpdate=="function"||typeof p.UNSAFE_componentWillMount!="function"&&typeof p.componentWillMount!="function"||(R=p.state,typeof p.componentWillMount=="function"&&p.componentWillMount(),typeof p.UNSAFE_componentWillMount=="function"&&p.UNSAFE_componentWillMount(),R!==p.state&&xf.enqueueReplaceState(p,p.state,null),Ao(a,c,p,v),Mo(),p.state=a.memoizedState),typeof p.componentDidMount=="function"&&(a.flags|=4194308),c=!0}else if(r===null){p=a.stateNode;var L=a.memoizedProps,K=ya(l,L);p.props=K;var ne=p.context,he=l.contextType;R=ss,typeof he=="object"&&he!==null&&(R=fn(he));var ge=l.getDerivedStateFromProps;he=typeof ge=="function"||typeof p.getSnapshotBeforeUpdate=="function",L=a.pendingProps!==L,he||typeof p.UNSAFE_componentWillReceiveProps!="function"&&typeof p.componentWillReceiveProps!="function"||(L||ne!==R)&&ry(a,p,c,R),wi=!1;var ie=a.memoizedState;p.state=ie,Ao(a,c,p,v),Mo(),ne=a.memoizedState,L||ie!==ne||wi?(typeof ge=="function"&&(Lf(a,l,ge,c),ne=a.memoizedState),(K=wi||ny(a,l,K,c,ie,ne,R))?(he||typeof p.UNSAFE_componentWillMount!="function"&&typeof p.componentWillMount!="function"||(typeof p.componentWillMount=="function"&&p.componentWillMount(),typeof p.UNSAFE_componentWillMount=="function"&&p.UNSAFE_componentWillMount()),typeof p.componentDidMount=="function"&&(a.flags|=4194308)):(typeof p.componentDidMount=="function"&&(a.flags|=4194308),a.memoizedProps=c,a.memoizedState=ne),p.props=c,p.state=ne,p.context=R,c=K):(typeof p.componentDidMount=="function"&&(a.flags|=4194308),c=!1)}else{p=a.stateNode,hf(r,a),R=a.memoizedProps,he=ya(l,R),p.props=he,ge=a.pendingProps,ie=p.context,ne=l.contextType,K=ss,typeof ne=="object"&&ne!==null&&(K=fn(ne)),L=l.getDerivedStateFromProps,(ne=typeof L=="function"||typeof p.getSnapshotBeforeUpdate=="function")||typeof p.UNSAFE_componentWillReceiveProps!="function"&&typeof p.componentWillReceiveProps!="function"||(R!==ge||ie!==K)&&ry(a,p,c,K),wi=!1,ie=a.memoizedState,p.state=ie,Ao(a,c,p,v),Mo();var ce=a.memoizedState;R!==ge||ie!==ce||wi||r!==null&&r.dependencies!==null&&Tu(r.dependencies)?(typeof L=="function"&&(Lf(a,l,L,c),ce=a.memoizedState),(he=wi||ny(a,l,he,c,ie,ce,K)||r!==null&&r.dependencies!==null&&Tu(r.dependencies))?(ne||typeof p.UNSAFE_componentWillUpdate!="function"&&typeof p.componentWillUpdate!="function"||(typeof p.componentWillUpdate=="function"&&p.componentWillUpdate(c,ce,K),typeof p.UNSAFE_componentWillUpdate=="function"&&p.UNSAFE_componentWillUpdate(c,ce,K)),typeof p.componentDidUpdate=="function"&&(a.flags|=4),typeof p.getSnapshotBeforeUpdate=="function"&&(a.flags|=1024)):(typeof p.componentDidUpdate!="function"||R===r.memoizedProps&&ie===r.memoizedState||(a.flags|=4),typeof p.getSnapshotBeforeUpdate!="function"||R===r.memoizedProps&&ie===r.memoizedState||(a.flags|=1024),a.memoizedProps=c,a.memoizedState=ce),p.props=c,p.state=ce,p.context=K,c=he):(typeof p.componentDidUpdate!="function"||R===r.memoizedProps&&ie===r.memoizedState||(a.flags|=4),typeof p.getSnapshotBeforeUpdate!="function"||R===r.memoizedProps&&ie===r.memoizedState||(a.flags|=1024),c=!1)}return p=c,Ku(r,a),c=(a.flags&128)!==0,p||c?(p=a.stateNode,l=c&&typeof l.getDerivedStateFromError!="function"?null:p.render(),a.flags|=1,r!==null&&c?(a.child=pa(a,r.child,null,v),a.child=pa(a,null,l,v)):hn(r,a,l,v),a.memoizedState=p.state,r=a.child):r=Jr(r,a,v),r}function yy(r,a,l,c){return ca(),a.flags|=256,hn(r,a,l,c),a.child}var qf={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function Kf(r){return{baseLanes:r,cachePool:og()}}function Hf(r,a,l){return r=r!==null?r.childLanes&~l:0,a&&(r|=Kn),r}function Sy(r,a,l){var c=a.pendingProps,v=!1,p=(a.flags&128)!==0,R;if((R=p)||(R=r!==null&&r.memoizedState===null?!1:(Gt.current&2)!==0),R&&(v=!0,a.flags&=-129),R=(a.flags&32)!==0,a.flags&=-33,r===null){if(ut){if(v?Oi(a):Mi(),(r=kt)?(r=IS(r,ar),r=r!==null&&r.data!=="&"?r:null,r!==null&&(a.memoizedState={dehydrated:r,treeContext:Ei!==null?{id:Ir,overflow:Or}:null,retryLane:536870912,hydrationErrors:null},l=Zp(r),l.return=a,a.child=l,dn=a,kt=null)):r=null,r===null)throw Ti(a);return wh(r)?a.lanes=32:a.lanes=536870912,null}var L=c.children;return c=c.fallback,v?(Mi(),v=a.mode,L=Hu({mode:"hidden",children:L},v),c=ua(c,v,l,null),L.return=a,c.return=a,L.sibling=c,a.child=L,c=a.child,c.memoizedState=Kf(l),c.childLanes=Hf(r,R,l),a.memoizedState=qf,No(null,c)):(Oi(a),Vf(a,L))}var K=r.memoizedState;if(K!==null&&(L=K.dehydrated,L!==null)){if(p)a.flags&256?(Oi(a),a.flags&=-257,a=Gf(r,a,l)):a.memoizedState!==null?(Mi(),a.child=r.child,a.flags|=128,a=null):(Mi(),L=c.fallback,v=a.mode,c=Hu({mode:"visible",children:c.children},v),L=ua(L,v,l,null),L.flags|=2,c.return=a,L.return=a,c.sibling=L,a.child=c,pa(a,r.child,null,l),c=a.child,c.memoizedState=Kf(l),c.childLanes=Hf(r,R,l),a.memoizedState=qf,a=No(null,c));else if(Oi(a),wh(L)){if(R=L.nextSibling&&L.nextSibling.dataset,R)var ne=R.dgst;R=ne,c=Error(n(419)),c.stack="",c.digest=R,To({value:c,source:null,stack:null}),a=Gf(r,a,l)}else if(Qt||cs(r,a,l,!1),R=(l&r.childLanes)!==0,Qt||R){if(R=Ct,R!==null&&(c=ap(R,l),c!==0&&c!==K.retryLane))throw K.retryLane=c,la(r,c),Dn(R,r,c),Bf;Rh(L)||Zu(),a=Gf(r,a,l)}else Rh(L)?(a.flags|=192,a.child=r.child,a=null):(r=K.treeContext,kt=or(L.nextSibling),dn=a,ut=!0,_i=null,ar=!1,r!==null&&tg(a,r),a=Vf(a,c.children),a.flags|=4096);return a}return v?(Mi(),L=c.fallback,v=a.mode,K=r.child,ne=K.sibling,c=Hr(K,{mode:"hidden",children:c.children}),c.subtreeFlags=K.subtreeFlags&65011712,ne!==null?L=Hr(ne,L):(L=ua(L,v,l,null),L.flags|=2),L.return=a,c.return=a,c.sibling=L,a.child=c,No(null,c),c=a.child,L=r.child.memoizedState,L===null?L=Kf(l):(v=L.cachePool,v!==null?(K=Jt._currentValue,v=v.parent!==K?{parent:K,pool:K}:v):v=og(),L={baseLanes:L.baseLanes|l,cachePool:v}),c.memoizedState=L,c.childLanes=Hf(r,R,l),a.memoizedState=qf,No(r.child,c)):(Oi(a),l=r.child,r=l.sibling,l=Hr(l,{mode:"visible",children:c.children}),l.return=a,l.sibling=null,r!==null&&(R=a.deletions,R===null?(a.deletions=[r],a.flags|=16):R.push(r)),a.child=l,a.memoizedState=null,l)}function Vf(r,a){return a=Hu({mode:"visible",children:a},r.mode),a.return=r,r.child=a}function Hu(r,a){return r=jn(22,r,null,a),r.lanes=0,r}function Gf(r,a,l){return pa(a,r.child,null,l),r=Vf(a,a.pendingProps.children),r.flags|=2,a.memoizedState=null,r}function by(r,a,l){r.lanes|=a;var c=r.alternate;c!==null&&(c.lanes|=a),sf(r.return,a,l)}function zf(r,a,l,c,v,p){var R=r.memoizedState;R===null?r.memoizedState={isBackwards:a,rendering:null,renderingStartTime:0,last:c,tail:l,tailMode:v,treeForkCount:p}:(R.isBackwards=a,R.rendering=null,R.renderingStartTime=0,R.last=c,R.tail=l,R.tailMode=v,R.treeForkCount=p)}function Ey(r,a,l){var c=a.pendingProps,v=c.revealOrder,p=c.tail;c=c.children;var R=Gt.current,L=(R&2)!==0;if(L?(R=R&1|2,a.flags|=128):R&=1,Re(Gt,R),hn(r,a,c,l),c=ut?_o:0,!L&&r!==null&&(r.flags&128)!==0)e:for(r=a.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&by(r,l,a);else if(r.tag===19)by(r,l,a);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===a)break e;for(;r.sibling===null;){if(r.return===null||r.return===a)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}switch(v){case"forwards":for(l=a.child,v=null;l!==null;)r=l.alternate,r!==null&&Du(r)===null&&(v=l),l=l.sibling;l=v,l===null?(v=a.child,a.child=null):(v=l.sibling,l.sibling=null),zf(a,!1,v,l,p,c);break;case"backwards":case"unstable_legacy-backwards":for(l=null,v=a.child,a.child=null;v!==null;){if(r=v.alternate,r!==null&&Du(r)===null){a.child=v;break}r=v.sibling,v.sibling=l,l=v,v=r}zf(a,!0,l,null,p,c);break;case"together":zf(a,!1,null,null,void 0,c);break;default:a.memoizedState=null}return a.child}function Jr(r,a,l){if(r!==null&&(a.dependencies=r.dependencies),ki|=a.lanes,(l&a.childLanes)===0)if(r!==null){if(cs(r,a,l,!1),(l&a.childLanes)===0)return null}else return null;if(r!==null&&a.child!==r.child)throw Error(n(153));if(a.child!==null){for(r=a.child,l=Hr(r,r.pendingProps),a.child=l,l.return=a;r.sibling!==null;)r=r.sibling,l=l.sibling=Hr(r,r.pendingProps),l.return=a;l.sibling=null}return a.child}function Wf(r,a){return(r.lanes&a)!==0?!0:(r=r.dependencies,!!(r!==null&&Tu(r)))}function KR(r,a,l){switch(a.tag){case 3:x(a,a.stateNode.containerInfo),Ri(a,Jt,r.memoizedState.cache),ca();break;case 27:case 5:P(a);break;case 4:x(a,a.stateNode.containerInfo);break;case 10:Ri(a,a.type,a.memoizedProps.value);break;case 31:if(a.memoizedState!==null)return a.flags|=128,yf(a),null;break;case 13:var c=a.memoizedState;if(c!==null)return c.dehydrated!==null?(Oi(a),a.flags|=128,null):(l&a.child.childLanes)!==0?Sy(r,a,l):(Oi(a),r=Jr(r,a,l),r!==null?r.sibling:null);Oi(a);break;case 19:var v=(r.flags&128)!==0;if(c=(l&a.childLanes)!==0,c||(cs(r,a,l,!1),c=(l&a.childLanes)!==0),v){if(c)return Ey(r,a,l);a.flags|=128}if(v=a.memoizedState,v!==null&&(v.rendering=null,v.tail=null,v.lastEffect=null),Re(Gt,Gt.current),c)break;return null;case 22:return a.lanes=0,hy(r,a,l,a.pendingProps);case 24:Ri(a,Jt,r.memoizedState.cache)}return Jr(r,a,l)}function _y(r,a,l){if(r!==null)if(r.memoizedProps!==a.pendingProps)Qt=!0;else{if(!Wf(r,l)&&(a.flags&128)===0)return Qt=!1,KR(r,a,l);Qt=(r.flags&131072)!==0}else Qt=!1,ut&&(a.flags&1048576)!==0&&eg(a,_o,a.index);switch(a.lanes=0,a.tag){case 16:e:{var c=a.pendingProps;if(r=va(a.elementType),a.type=r,typeof r=="function")Qd(r)?(c=ya(r,c),a.tag=1,a=gy(null,a,r,c,l)):(a.tag=0,a=Ff(null,a,r,c,l));else{if(r!=null){var v=r.$$typeof;if(v===O){a.tag=11,a=cy(null,a,r,c,l);break e}else if(v===I){a.tag=14,a=dy(null,a,r,c,l);break e}}throw a=Ze(r)||r,Error(n(306,a,""))}}return a;case 0:return Ff(r,a,a.type,a.pendingProps,l);case 1:return c=a.type,v=ya(c,a.pendingProps),gy(r,a,c,v,l);case 3:e:{if(x(a,a.stateNode.containerInfo),r===null)throw Error(n(387));c=a.pendingProps;var p=a.memoizedState;v=p.element,hf(r,a),Ao(a,c,null,l);var R=a.memoizedState;if(c=R.cache,Ri(a,Jt,c),c!==p.cache&&of(a,[Jt],l,!0),Mo(),c=R.element,p.isDehydrated)if(p={element:c,isDehydrated:!1,cache:R.cache},a.updateQueue.baseState=p,a.memoizedState=p,a.flags&256){a=yy(r,a,c,l);break e}else if(c!==v){v=nr(Error(n(424)),a),To(v),a=yy(r,a,c,l);break e}else for(r=a.stateNode.containerInfo,r.nodeType===9?r=r.body:r=r.nodeName==="HTML"?r.ownerDocument.body:r,kt=or(r.firstChild),dn=a,ut=!0,_i=null,ar=!0,l=hg(a,null,c,l),a.child=l;l;)l.flags=l.flags&-3|4096,l=l.sibling;else{if(ca(),c===v){a=Jr(r,a,l);break e}hn(r,a,c,l)}a=a.child}return a;case 26:return Ku(r,a),r===null?(l=US(a.type,null,a.pendingProps,null))?a.memoizedState=l:ut||(l=a.type,r=a.pendingProps,c=ac(B.current).createElement(l),c[cn]=a,c[wn]=r,vn(c,l,r),an(c),a.stateNode=c):a.memoizedState=US(a.type,r.memoizedProps,a.pendingProps,r.memoizedState),null;case 27:return P(a),r===null&&ut&&(c=a.stateNode=AS(a.type,a.pendingProps,B.current),dn=a,ar=!0,v=kt,xi(a.type)?(Ch=v,kt=or(c.firstChild)):kt=v),hn(r,a,a.pendingProps.children,l),Ku(r,a),r===null&&(a.flags|=4194304),a.child;case 5:return r===null&&ut&&((v=c=kt)&&(c=yw(c,a.type,a.pendingProps,ar),c!==null?(a.stateNode=c,dn=a,kt=or(c.firstChild),ar=!1,v=!0):v=!1),v||Ti(a)),P(a),v=a.type,p=a.pendingProps,R=r!==null?r.memoizedProps:null,c=p.children,Eh(v,p)?c=null:R!==null&&Eh(v,R)&&(a.flags|=32),a.memoizedState!==null&&(v=bf(r,a,UR,null,null,l),Xo._currentValue=v),Ku(r,a),hn(r,a,c,l),a.child;case 6:return r===null&&ut&&((r=l=kt)&&(l=Sw(l,a.pendingProps,ar),l!==null?(a.stateNode=l,dn=a,kt=null,r=!0):r=!1),r||Ti(a)),null;case 13:return Sy(r,a,l);case 4:return x(a,a.stateNode.containerInfo),c=a.pendingProps,r===null?a.child=pa(a,null,c,l):hn(r,a,c,l),a.child;case 11:return cy(r,a,a.type,a.pendingProps,l);case 7:return hn(r,a,a.pendingProps,l),a.child;case 8:return hn(r,a,a.pendingProps.children,l),a.child;case 12:return hn(r,a,a.pendingProps.children,l),a.child;case 10:return c=a.pendingProps,Ri(a,a.type,c.value),hn(r,a,c.children,l),a.child;case 9:return v=a.type._context,c=a.pendingProps.children,fa(a),v=fn(v),c=c(v),a.flags|=1,hn(r,a,c,l),a.child;case 14:return dy(r,a,a.type,a.pendingProps,l);case 15:return fy(r,a,a.type,a.pendingProps,l);case 19:return Ey(r,a,l);case 31:return qR(r,a,l);case 22:return hy(r,a,l,a.pendingProps);case 24:return fa(a),c=fn(Jt),r===null?(v=cf(),v===null&&(v=Ct,p=lf(),v.pooledCache=p,p.refCount++,p!==null&&(v.pooledCacheLanes|=l),v=p),a.memoizedState={parent:c,cache:v},ff(a),Ri(a,Jt,v)):((r.lanes&l)!==0&&(hf(r,a),Ao(a,null,null,l),Mo()),v=r.memoizedState,p=a.memoizedState,v.parent!==c?(v={parent:c,cache:c},a.memoizedState=v,a.lanes===0&&(a.memoizedState=a.updateQueue.baseState=v),Ri(a,Jt,c)):(c=p.cache,Ri(a,Jt,c),c!==v.cache&&of(a,[Jt],l,!0))),hn(r,a,a.pendingProps.children,l),a.child;case 29:throw a.pendingProps}throw Error(n(156,a.tag))}function Xr(r){r.flags|=4}function Yf(r,a,l,c,v){if((a=(r.mode&32)!==0)&&(a=!1),a){if(r.flags|=16777216,(v&335544128)===v)if(r.stateNode.complete)r.flags|=8192;else if(Jy())r.flags|=8192;else throw ma=Iu,df}else r.flags&=-16777217}function Ty(r,a){if(a.type!=="stylesheet"||(a.state.loading&4)!==0)r.flags&=-16777217;else if(r.flags|=16777216,!jS(a))if(Jy())r.flags|=8192;else throw ma=Iu,df}function Vu(r,a){a!==null&&(r.flags|=4),r.flags&16384&&(a=r.tag!==22?np():536870912,r.lanes|=a,_s|=a)}function Lo(r,a){if(!ut)switch(r.tailMode){case"hidden":a=r.tail;for(var l=null;a!==null;)a.alternate!==null&&(l=a),a=a.sibling;l===null?r.tail=null:l.sibling=null;break;case"collapsed":l=r.tail;for(var c=null;l!==null;)l.alternate!==null&&(c=l),l=l.sibling;c===null?a||r.tail===null?r.tail=null:r.tail.sibling=null:c.sibling=null}}function Ut(r){var a=r.alternate!==null&&r.alternate.child===r.child,l=0,c=0;if(a)for(var v=r.child;v!==null;)l|=v.lanes|v.childLanes,c|=v.subtreeFlags&65011712,c|=v.flags&65011712,v.return=r,v=v.sibling;else for(v=r.child;v!==null;)l|=v.lanes|v.childLanes,c|=v.subtreeFlags,c|=v.flags,v.return=r,v=v.sibling;return r.subtreeFlags|=c,r.childLanes=l,a}function HR(r,a,l){var c=a.pendingProps;switch(tf(a),a.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Ut(a),null;case 1:return Ut(a),null;case 3:return l=a.stateNode,c=null,r!==null&&(c=r.memoizedState.cache),a.memoizedState.cache!==c&&(a.flags|=2048),zr(Jt),j(),l.pendingContext&&(l.context=l.pendingContext,l.pendingContext=null),(r===null||r.child===null)&&(us(a)?Xr(a):r===null||r.memoizedState.isDehydrated&&(a.flags&256)===0||(a.flags|=1024,rf())),Ut(a),null;case 26:var v=a.type,p=a.memoizedState;return r===null?(Xr(a),p!==null?(Ut(a),Ty(a,p)):(Ut(a),Yf(a,v,null,c,l))):p?p!==r.memoizedState?(Xr(a),Ut(a),Ty(a,p)):(Ut(a),a.flags&=-16777217):(r=r.memoizedProps,r!==c&&Xr(a),Ut(a),Yf(a,v,r,c,l)),null;case 27:if(G(a),l=B.current,v=a.type,r!==null&&a.stateNode!=null)r.memoizedProps!==c&&Xr(a);else{if(!c){if(a.stateNode===null)throw Error(n(166));return Ut(a),null}r=X.current,us(a)?ng(a):(r=AS(v,c,l),a.stateNode=r,Xr(a))}return Ut(a),null;case 5:if(G(a),v=a.type,r!==null&&a.stateNode!=null)r.memoizedProps!==c&&Xr(a);else{if(!c){if(a.stateNode===null)throw Error(n(166));return Ut(a),null}if(p=X.current,us(a))ng(a);else{var R=ac(B.current);switch(p){case 1:p=R.createElementNS("http://www.w3.org/2000/svg",v);break;case 2:p=R.createElementNS("http://www.w3.org/1998/Math/MathML",v);break;default:switch(v){case"svg":p=R.createElementNS("http://www.w3.org/2000/svg",v);break;case"math":p=R.createElementNS("http://www.w3.org/1998/Math/MathML",v);break;case"script":p=R.createElement("div"),p.innerHTML="<script><\/script>",p=p.removeChild(p.firstChild);break;case"select":p=typeof c.is=="string"?R.createElement("select",{is:c.is}):R.createElement("select"),c.multiple?p.multiple=!0:c.size&&(p.size=c.size);break;default:p=typeof c.is=="string"?R.createElement(v,{is:c.is}):R.createElement(v)}}p[cn]=a,p[wn]=c;e:for(R=a.child;R!==null;){if(R.tag===5||R.tag===6)p.appendChild(R.stateNode);else if(R.tag!==4&&R.tag!==27&&R.child!==null){R.child.return=R,R=R.child;continue}if(R===a)break e;for(;R.sibling===null;){if(R.return===null||R.return===a)break e;R=R.return}R.sibling.return=R.return,R=R.sibling}a.stateNode=p;e:switch(vn(p,v,c),v){case"button":case"input":case"select":case"textarea":c=!!c.autoFocus;break e;case"img":c=!0;break e;default:c=!1}c&&Xr(a)}}return Ut(a),Yf(a,a.type,r===null?null:r.memoizedProps,a.pendingProps,l),null;case 6:if(r&&a.stateNode!=null)r.memoizedProps!==c&&Xr(a);else{if(typeof c!="string"&&a.stateNode===null)throw Error(n(166));if(r=B.current,us(a)){if(r=a.stateNode,l=a.memoizedProps,c=null,v=dn,v!==null)switch(v.tag){case 27:case 5:c=v.memoizedProps}r[cn]=a,r=!!(r.nodeValue===l||c!==null&&c.suppressHydrationWarning===!0||SS(r.nodeValue,l)),r||Ti(a,!0)}else r=ac(r).createTextNode(c),r[cn]=a,a.stateNode=r}return Ut(a),null;case 31:if(l=a.memoizedState,r===null||r.memoizedState!==null){if(c=us(a),l!==null){if(r===null){if(!c)throw Error(n(318));if(r=a.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(n(557));r[cn]=a}else ca(),(a.flags&128)===0&&(a.memoizedState=null),a.flags|=4;Ut(a),r=!1}else l=rf(),r!==null&&r.memoizedState!==null&&(r.memoizedState.hydrationErrors=l),r=!0;if(!r)return a.flags&256?(Fn(a),a):(Fn(a),null);if((a.flags&128)!==0)throw Error(n(558))}return Ut(a),null;case 13:if(c=a.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(v=us(a),c!==null&&c.dehydrated!==null){if(r===null){if(!v)throw Error(n(318));if(v=a.memoizedState,v=v!==null?v.dehydrated:null,!v)throw Error(n(317));v[cn]=a}else ca(),(a.flags&128)===0&&(a.memoizedState=null),a.flags|=4;Ut(a),v=!1}else v=rf(),r!==null&&r.memoizedState!==null&&(r.memoizedState.hydrationErrors=v),v=!0;if(!v)return a.flags&256?(Fn(a),a):(Fn(a),null)}return Fn(a),(a.flags&128)!==0?(a.lanes=l,a):(l=c!==null,r=r!==null&&r.memoizedState!==null,l&&(c=a.child,v=null,c.alternate!==null&&c.alternate.memoizedState!==null&&c.alternate.memoizedState.cachePool!==null&&(v=c.alternate.memoizedState.cachePool.pool),p=null,c.memoizedState!==null&&c.memoizedState.cachePool!==null&&(p=c.memoizedState.cachePool.pool),p!==v&&(c.flags|=2048)),l!==r&&l&&(a.child.flags|=8192),Vu(a,a.updateQueue),Ut(a),null);case 4:return j(),r===null&&ph(a.stateNode.containerInfo),Ut(a),null;case 10:return zr(a.type),Ut(a),null;case 19:if(le(Gt),c=a.memoizedState,c===null)return Ut(a),null;if(v=(a.flags&128)!==0,p=c.rendering,p===null)if(v)Lo(c,!1);else{if(Kt!==0||r!==null&&(r.flags&128)!==0)for(r=a.child;r!==null;){if(p=Du(r),p!==null){for(a.flags|=128,Lo(c,!1),r=p.updateQueue,a.updateQueue=r,Vu(a,r),a.subtreeFlags=0,r=l,l=a.child;l!==null;)Qp(l,r),l=l.sibling;return Re(Gt,Gt.current&1|2),ut&&Vr(a,c.treeForkCount),a.child}r=r.sibling}c.tail!==null&&ze()>Ju&&(a.flags|=128,v=!0,Lo(c,!1),a.lanes=4194304)}else{if(!v)if(r=Du(p),r!==null){if(a.flags|=128,v=!0,r=r.updateQueue,a.updateQueue=r,Vu(a,r),Lo(c,!0),c.tail===null&&c.tailMode==="hidden"&&!p.alternate&&!ut)return Ut(a),null}else 2*ze()-c.renderingStartTime>Ju&&l!==536870912&&(a.flags|=128,v=!0,Lo(c,!1),a.lanes=4194304);c.isBackwards?(p.sibling=a.child,a.child=p):(r=c.last,r!==null?r.sibling=p:a.child=p,c.last=p)}return c.tail!==null?(r=c.tail,c.rendering=r,c.tail=r.sibling,c.renderingStartTime=ze(),r.sibling=null,l=Gt.current,Re(Gt,v?l&1|2:l&1),ut&&Vr(a,c.treeForkCount),r):(Ut(a),null);case 22:case 23:return Fn(a),gf(),c=a.memoizedState!==null,r!==null?r.memoizedState!==null!==c&&(a.flags|=8192):c&&(a.flags|=8192),c?(l&536870912)!==0&&(a.flags&128)===0&&(Ut(a),a.subtreeFlags&6&&(a.flags|=8192)):Ut(a),l=a.updateQueue,l!==null&&Vu(a,l.retryQueue),l=null,r!==null&&r.memoizedState!==null&&r.memoizedState.cachePool!==null&&(l=r.memoizedState.cachePool.pool),c=null,a.memoizedState!==null&&a.memoizedState.cachePool!==null&&(c=a.memoizedState.cachePool.pool),c!==l&&(a.flags|=2048),r!==null&&le(ha),null;case 24:return l=null,r!==null&&(l=r.memoizedState.cache),a.memoizedState.cache!==l&&(a.flags|=2048),zr(Jt),Ut(a),null;case 25:return null;case 30:return null}throw Error(n(156,a.tag))}function VR(r,a){switch(tf(a),a.tag){case 1:return r=a.flags,r&65536?(a.flags=r&-65537|128,a):null;case 3:return zr(Jt),j(),r=a.flags,(r&65536)!==0&&(r&128)===0?(a.flags=r&-65537|128,a):null;case 26:case 27:case 5:return G(a),null;case 31:if(a.memoizedState!==null){if(Fn(a),a.alternate===null)throw Error(n(340));ca()}return r=a.flags,r&65536?(a.flags=r&-65537|128,a):null;case 13:if(Fn(a),r=a.memoizedState,r!==null&&r.dehydrated!==null){if(a.alternate===null)throw Error(n(340));ca()}return r=a.flags,r&65536?(a.flags=r&-65537|128,a):null;case 19:return le(Gt),null;case 4:return j(),null;case 10:return zr(a.type),null;case 22:case 23:return Fn(a),gf(),r!==null&&le(ha),r=a.flags,r&65536?(a.flags=r&-65537|128,a):null;case 24:return zr(Jt),null;case 25:return null;default:return null}}function Ry(r,a){switch(tf(a),a.tag){case 3:zr(Jt),j();break;case 26:case 27:case 5:G(a);break;case 4:j();break;case 31:a.memoizedState!==null&&Fn(a);break;case 13:Fn(a);break;case 19:le(Gt);break;case 10:zr(a.type);break;case 22:case 23:Fn(a),gf(),r!==null&&le(ha);break;case 24:zr(Jt)}}function xo(r,a){try{var l=a.updateQueue,c=l!==null?l.lastEffect:null;if(c!==null){var v=c.next;l=v;do{if((l.tag&r)===r){c=void 0;var p=l.create,R=l.inst;c=p(),R.destroy=c}l=l.next}while(l!==v)}}catch(L){St(a,a.return,L)}}function Ai(r,a,l){try{var c=a.updateQueue,v=c!==null?c.lastEffect:null;if(v!==null){var p=v.next;c=p;do{if((c.tag&r)===r){var R=c.inst,L=R.destroy;if(L!==void 0){R.destroy=void 0,v=a;var K=l,ne=L;try{ne()}catch(he){St(v,K,he)}}}c=c.next}while(c!==p)}}catch(he){St(a,a.return,he)}}function wy(r){var a=r.updateQueue;if(a!==null){var l=r.stateNode;try{mg(a,l)}catch(c){St(r,r.return,c)}}}function Cy(r,a,l){l.props=ya(r.type,r.memoizedProps),l.state=r.memoizedState;try{l.componentWillUnmount()}catch(c){St(r,a,c)}}function jo(r,a){try{var l=r.ref;if(l!==null){switch(r.tag){case 26:case 27:case 5:var c=r.stateNode;break;case 30:c=r.stateNode;break;default:c=r.stateNode}typeof l=="function"?r.refCleanup=l(c):l.current=c}}catch(v){St(r,a,v)}}function Mr(r,a){var l=r.ref,c=r.refCleanup;if(l!==null)if(typeof c=="function")try{c()}catch(v){St(r,a,v)}finally{r.refCleanup=null,r=r.alternate,r!=null&&(r.refCleanup=null)}else if(typeof l=="function")try{l(null)}catch(v){St(r,a,v)}else l.current=null}function Iy(r){var a=r.type,l=r.memoizedProps,c=r.stateNode;try{e:switch(a){case"button":case"input":case"select":case"textarea":l.autoFocus&&c.focus();break e;case"img":l.src?c.src=l.src:l.srcSet&&(c.srcset=l.srcSet)}}catch(v){St(r,r.return,v)}}function Jf(r,a,l){try{var c=r.stateNode;fw(c,r.type,l,a),c[wn]=a}catch(v){St(r,r.return,v)}}function Oy(r){return r.tag===5||r.tag===3||r.tag===26||r.tag===27&&xi(r.type)||r.tag===4}function Xf(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||Oy(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.tag===27&&xi(r.type)||r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}function Qf(r,a,l){var c=r.tag;if(c===5||c===6)r=r.stateNode,a?(l.nodeType===9?l.body:l.nodeName==="HTML"?l.ownerDocument.body:l).insertBefore(r,a):(a=l.nodeType===9?l.body:l.nodeName==="HTML"?l.ownerDocument.body:l,a.appendChild(r),l=l._reactRootContainer,l!=null||a.onclick!==null||(a.onclick=qr));else if(c!==4&&(c===27&&xi(r.type)&&(l=r.stateNode,a=null),r=r.child,r!==null))for(Qf(r,a,l),r=r.sibling;r!==null;)Qf(r,a,l),r=r.sibling}function Gu(r,a,l){var c=r.tag;if(c===5||c===6)r=r.stateNode,a?l.insertBefore(r,a):l.appendChild(r);else if(c!==4&&(c===27&&xi(r.type)&&(l=r.stateNode),r=r.child,r!==null))for(Gu(r,a,l),r=r.sibling;r!==null;)Gu(r,a,l),r=r.sibling}function My(r){var a=r.stateNode,l=r.memoizedProps;try{for(var c=r.type,v=a.attributes;v.length;)a.removeAttributeNode(v[0]);vn(a,c,l),a[cn]=r,a[wn]=l}catch(p){St(r,r.return,p)}}var Qr=!1,Zt=!1,Zf=!1,Ay=typeof WeakSet=="function"?WeakSet:Set,sn=null;function GR(r,a){if(r=r.containerInfo,Sh=fc,r=Kp(r),Vd(r)){if("selectionStart"in r)var l={start:r.selectionStart,end:r.selectionEnd};else e:{l=(l=r.ownerDocument)&&l.defaultView||window;var c=l.getSelection&&l.getSelection();if(c&&c.rangeCount!==0){l=c.anchorNode;var v=c.anchorOffset,p=c.focusNode;c=c.focusOffset;try{l.nodeType,p.nodeType}catch{l=null;break e}var R=0,L=-1,K=-1,ne=0,he=0,ge=r,ie=null;t:for(;;){for(var ce;ge!==l||v!==0&&ge.nodeType!==3||(L=R+v),ge!==p||c!==0&&ge.nodeType!==3||(K=R+c),ge.nodeType===3&&(R+=ge.nodeValue.length),(ce=ge.firstChild)!==null;)ie=ge,ge=ce;for(;;){if(ge===r)break t;if(ie===l&&++ne===v&&(L=R),ie===p&&++he===c&&(K=R),(ce=ge.nextSibling)!==null)break;ge=ie,ie=ge.parentNode}ge=ce}l=L===-1||K===-1?null:{start:L,end:K}}else l=null}l=l||{start:0,end:0}}else l=null;for(bh={focusedElem:r,selectionRange:l},fc=!1,sn=a;sn!==null;)if(a=sn,r=a.child,(a.subtreeFlags&1028)!==0&&r!==null)r.return=a,sn=r;else for(;sn!==null;){switch(a=sn,p=a.alternate,r=a.flags,a.tag){case 0:if((r&4)!==0&&(r=a.updateQueue,r=r!==null?r.events:null,r!==null))for(l=0;l<r.length;l++)v=r[l],v.ref.impl=v.nextImpl;break;case 11:case 15:break;case 1:if((r&1024)!==0&&p!==null){r=void 0,l=a,v=p.memoizedProps,p=p.memoizedState,c=l.stateNode;try{var Le=ya(l.type,v);r=c.getSnapshotBeforeUpdate(Le,p),c.__reactInternalSnapshotBeforeUpdate=r}catch(Ke){St(l,l.return,Ke)}}break;case 3:if((r&1024)!==0){if(r=a.stateNode.containerInfo,l=r.nodeType,l===9)Th(r);else if(l===1)switch(r.nodeName){case"HEAD":case"HTML":case"BODY":Th(r);break;default:r.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((r&1024)!==0)throw Error(n(163))}if(r=a.sibling,r!==null){r.return=a.return,sn=r;break}sn=a.return}}function Dy(r,a,l){var c=l.flags;switch(l.tag){case 0:case 11:case 15:$r(r,l),c&4&&xo(5,l);break;case 1:if($r(r,l),c&4)if(r=l.stateNode,a===null)try{r.componentDidMount()}catch(R){St(l,l.return,R)}else{var v=ya(l.type,a.memoizedProps);a=a.memoizedState;try{r.componentDidUpdate(v,a,r.__reactInternalSnapshotBeforeUpdate)}catch(R){St(l,l.return,R)}}c&64&&wy(l),c&512&&jo(l,l.return);break;case 3:if($r(r,l),c&64&&(r=l.updateQueue,r!==null)){if(a=null,l.child!==null)switch(l.child.tag){case 27:case 5:a=l.child.stateNode;break;case 1:a=l.child.stateNode}try{mg(r,a)}catch(R){St(l,l.return,R)}}break;case 27:a===null&&c&4&&My(l);case 26:case 5:$r(r,l),a===null&&c&4&&Iy(l),c&512&&jo(l,l.return);break;case 12:$r(r,l);break;case 31:$r(r,l),c&4&&Py(r,l);break;case 13:$r(r,l),c&4&&Ny(r,l),c&64&&(r=l.memoizedState,r!==null&&(r=r.dehydrated,r!==null&&(l=ew.bind(null,l),bw(r,l))));break;case 22:if(c=l.memoizedState!==null||Qr,!c){a=a!==null&&a.memoizedState!==null||Zt,v=Qr;var p=Zt;Qr=c,(Zt=a)&&!p?ei(r,l,(l.subtreeFlags&8772)!==0):$r(r,l),Qr=v,Zt=p}break;case 30:break;default:$r(r,l)}}function ky(r){var a=r.alternate;a!==null&&(r.alternate=null,ky(a)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(a=r.stateNode,a!==null&&Id(a)),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}var jt=null,In=!1;function Zr(r,a,l){for(l=l.child;l!==null;)Uy(r,a,l),l=l.sibling}function Uy(r,a,l){if(ee&&typeof ee.onCommitFiberUnmount=="function")try{ee.onCommitFiberUnmount(be,l)}catch{}switch(l.tag){case 26:Zt||Mr(l,a),Zr(r,a,l),l.memoizedState?l.memoizedState.count--:l.stateNode&&(l=l.stateNode,l.parentNode.removeChild(l));break;case 27:Zt||Mr(l,a);var c=jt,v=In;xi(l.type)&&(jt=l.stateNode,In=!1),Zr(r,a,l),Wo(l.stateNode),jt=c,In=v;break;case 5:Zt||Mr(l,a);case 6:if(c=jt,v=In,jt=null,Zr(r,a,l),jt=c,In=v,jt!==null)if(In)try{(jt.nodeType===9?jt.body:jt.nodeName==="HTML"?jt.ownerDocument.body:jt).removeChild(l.stateNode)}catch(p){St(l,a,p)}else try{jt.removeChild(l.stateNode)}catch(p){St(l,a,p)}break;case 18:jt!==null&&(In?(r=jt,wS(r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r,l.stateNode),As(r)):wS(jt,l.stateNode));break;case 4:c=jt,v=In,jt=l.stateNode.containerInfo,In=!0,Zr(r,a,l),jt=c,In=v;break;case 0:case 11:case 14:case 15:Ai(2,l,a),Zt||Ai(4,l,a),Zr(r,a,l);break;case 1:Zt||(Mr(l,a),c=l.stateNode,typeof c.componentWillUnmount=="function"&&Cy(l,a,c)),Zr(r,a,l);break;case 21:Zr(r,a,l);break;case 22:Zt=(c=Zt)||l.memoizedState!==null,Zr(r,a,l),Zt=c;break;default:Zr(r,a,l)}}function Py(r,a){if(a.memoizedState===null&&(r=a.alternate,r!==null&&(r=r.memoizedState,r!==null))){r=r.dehydrated;try{As(r)}catch(l){St(a,a.return,l)}}}function Ny(r,a){if(a.memoizedState===null&&(r=a.alternate,r!==null&&(r=r.memoizedState,r!==null&&(r=r.dehydrated,r!==null))))try{As(r)}catch(l){St(a,a.return,l)}}function zR(r){switch(r.tag){case 31:case 13:case 19:var a=r.stateNode;return a===null&&(a=r.stateNode=new Ay),a;case 22:return r=r.stateNode,a=r._retryCache,a===null&&(a=r._retryCache=new Ay),a;default:throw Error(n(435,r.tag))}}function zu(r,a){var l=zR(r);a.forEach(function(c){if(!l.has(c)){l.add(c);var v=tw.bind(null,r,c);c.then(v,v)}})}function On(r,a){var l=a.deletions;if(l!==null)for(var c=0;c<l.length;c++){var v=l[c],p=r,R=a,L=R;e:for(;L!==null;){switch(L.tag){case 27:if(xi(L.type)){jt=L.stateNode,In=!1;break e}break;case 5:jt=L.stateNode,In=!1;break e;case 3:case 4:jt=L.stateNode.containerInfo,In=!0;break e}L=L.return}if(jt===null)throw Error(n(160));Uy(p,R,v),jt=null,In=!1,p=v.alternate,p!==null&&(p.return=null),v.return=null}if(a.subtreeFlags&13886)for(a=a.child;a!==null;)Ly(a,r),a=a.sibling}var pr=null;function Ly(r,a){var l=r.alternate,c=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:On(a,r),Mn(r),c&4&&(Ai(3,r,r.return),xo(3,r),Ai(5,r,r.return));break;case 1:On(a,r),Mn(r),c&512&&(Zt||l===null||Mr(l,l.return)),c&64&&Qr&&(r=r.updateQueue,r!==null&&(c=r.callbacks,c!==null&&(l=r.shared.hiddenCallbacks,r.shared.hiddenCallbacks=l===null?c:l.concat(c))));break;case 26:var v=pr;if(On(a,r),Mn(r),c&512&&(Zt||l===null||Mr(l,l.return)),c&4){var p=l!==null?l.memoizedState:null;if(c=r.memoizedState,l===null)if(c===null)if(r.stateNode===null){e:{c=r.type,l=r.memoizedProps,v=v.ownerDocument||v;t:switch(c){case"title":p=v.getElementsByTagName("title")[0],(!p||p[co]||p[cn]||p.namespaceURI==="http://www.w3.org/2000/svg"||p.hasAttribute("itemprop"))&&(p=v.createElement(c),v.head.insertBefore(p,v.querySelector("head > title"))),vn(p,c,l),p[cn]=r,an(p),c=p;break e;case"link":var R=LS("link","href",v).get(c+(l.href||""));if(R){for(var L=0;L<R.length;L++)if(p=R[L],p.getAttribute("href")===(l.href==null||l.href===""?null:l.href)&&p.getAttribute("rel")===(l.rel==null?null:l.rel)&&p.getAttribute("title")===(l.title==null?null:l.title)&&p.getAttribute("crossorigin")===(l.crossOrigin==null?null:l.crossOrigin)){R.splice(L,1);break t}}p=v.createElement(c),vn(p,c,l),v.head.appendChild(p);break;case"meta":if(R=LS("meta","content",v).get(c+(l.content||""))){for(L=0;L<R.length;L++)if(p=R[L],p.getAttribute("content")===(l.content==null?null:""+l.content)&&p.getAttribute("name")===(l.name==null?null:l.name)&&p.getAttribute("property")===(l.property==null?null:l.property)&&p.getAttribute("http-equiv")===(l.httpEquiv==null?null:l.httpEquiv)&&p.getAttribute("charset")===(l.charSet==null?null:l.charSet)){R.splice(L,1);break t}}p=v.createElement(c),vn(p,c,l),v.head.appendChild(p);break;default:throw Error(n(468,c))}p[cn]=r,an(p),c=p}r.stateNode=c}else xS(v,r.type,r.stateNode);else r.stateNode=NS(v,c,r.memoizedProps);else p!==c?(p===null?l.stateNode!==null&&(l=l.stateNode,l.parentNode.removeChild(l)):p.count--,c===null?xS(v,r.type,r.stateNode):NS(v,c,r.memoizedProps)):c===null&&r.stateNode!==null&&Jf(r,r.memoizedProps,l.memoizedProps)}break;case 27:On(a,r),Mn(r),c&512&&(Zt||l===null||Mr(l,l.return)),l!==null&&c&4&&Jf(r,r.memoizedProps,l.memoizedProps);break;case 5:if(On(a,r),Mn(r),c&512&&(Zt||l===null||Mr(l,l.return)),r.flags&32){v=r.stateNode;try{$a(v,"")}catch(Le){St(r,r.return,Le)}}c&4&&r.stateNode!=null&&(v=r.memoizedProps,Jf(r,v,l!==null?l.memoizedProps:v)),c&1024&&(Zf=!0);break;case 6:if(On(a,r),Mn(r),c&4){if(r.stateNode===null)throw Error(n(162));c=r.memoizedProps,l=r.stateNode;try{l.nodeValue=c}catch(Le){St(r,r.return,Le)}}break;case 3:if(lc=null,v=pr,pr=sc(a.containerInfo),On(a,r),pr=v,Mn(r),c&4&&l!==null&&l.memoizedState.isDehydrated)try{As(a.containerInfo)}catch(Le){St(r,r.return,Le)}Zf&&(Zf=!1,xy(r));break;case 4:c=pr,pr=sc(r.stateNode.containerInfo),On(a,r),Mn(r),pr=c;break;case 12:On(a,r),Mn(r);break;case 31:On(a,r),Mn(r),c&4&&(c=r.updateQueue,c!==null&&(r.updateQueue=null,zu(r,c)));break;case 13:On(a,r),Mn(r),r.child.flags&8192&&r.memoizedState!==null!=(l!==null&&l.memoizedState!==null)&&(Yu=ze()),c&4&&(c=r.updateQueue,c!==null&&(r.updateQueue=null,zu(r,c)));break;case 22:v=r.memoizedState!==null;var K=l!==null&&l.memoizedState!==null,ne=Qr,he=Zt;if(Qr=ne||v,Zt=he||K,On(a,r),Zt=he,Qr=ne,Mn(r),c&8192)e:for(a=r.stateNode,a._visibility=v?a._visibility&-2:a._visibility|1,v&&(l===null||K||Qr||Zt||Sa(r)),l=null,a=r;;){if(a.tag===5||a.tag===26){if(l===null){K=l=a;try{if(p=K.stateNode,v)R=p.style,typeof R.setProperty=="function"?R.setProperty("display","none","important"):R.display="none";else{L=K.stateNode;var ge=K.memoizedProps.style,ie=ge!=null&&ge.hasOwnProperty("display")?ge.display:null;L.style.display=ie==null||typeof ie=="boolean"?"":(""+ie).trim()}}catch(Le){St(K,K.return,Le)}}}else if(a.tag===6){if(l===null){K=a;try{K.stateNode.nodeValue=v?"":K.memoizedProps}catch(Le){St(K,K.return,Le)}}}else if(a.tag===18){if(l===null){K=a;try{var ce=K.stateNode;v?CS(ce,!0):CS(K.stateNode,!1)}catch(Le){St(K,K.return,Le)}}}else if((a.tag!==22&&a.tag!==23||a.memoizedState===null||a===r)&&a.child!==null){a.child.return=a,a=a.child;continue}if(a===r)break e;for(;a.sibling===null;){if(a.return===null||a.return===r)break e;l===a&&(l=null),a=a.return}l===a&&(l=null),a.sibling.return=a.return,a=a.sibling}c&4&&(c=r.updateQueue,c!==null&&(l=c.retryQueue,l!==null&&(c.retryQueue=null,zu(r,l))));break;case 19:On(a,r),Mn(r),c&4&&(c=r.updateQueue,c!==null&&(r.updateQueue=null,zu(r,c)));break;case 30:break;case 21:break;default:On(a,r),Mn(r)}}function Mn(r){var a=r.flags;if(a&2){try{for(var l,c=r.return;c!==null;){if(Oy(c)){l=c;break}c=c.return}if(l==null)throw Error(n(160));switch(l.tag){case 27:var v=l.stateNode,p=Xf(r);Gu(r,p,v);break;case 5:var R=l.stateNode;l.flags&32&&($a(R,""),l.flags&=-33);var L=Xf(r);Gu(r,L,R);break;case 3:case 4:var K=l.stateNode.containerInfo,ne=Xf(r);Qf(r,ne,K);break;default:throw Error(n(161))}}catch(he){St(r,r.return,he)}r.flags&=-3}a&4096&&(r.flags&=-4097)}function xy(r){if(r.subtreeFlags&1024)for(r=r.child;r!==null;){var a=r;xy(a),a.tag===5&&a.flags&1024&&a.stateNode.reset(),r=r.sibling}}function $r(r,a){if(a.subtreeFlags&8772)for(a=a.child;a!==null;)Dy(r,a.alternate,a),a=a.sibling}function Sa(r){for(r=r.child;r!==null;){var a=r;switch(a.tag){case 0:case 11:case 14:case 15:Ai(4,a,a.return),Sa(a);break;case 1:Mr(a,a.return);var l=a.stateNode;typeof l.componentWillUnmount=="function"&&Cy(a,a.return,l),Sa(a);break;case 27:Wo(a.stateNode);case 26:case 5:Mr(a,a.return),Sa(a);break;case 22:a.memoizedState===null&&Sa(a);break;case 30:Sa(a);break;default:Sa(a)}r=r.sibling}}function ei(r,a,l){for(l=l&&(a.subtreeFlags&8772)!==0,a=a.child;a!==null;){var c=a.alternate,v=r,p=a,R=p.flags;switch(p.tag){case 0:case 11:case 15:ei(v,p,l),xo(4,p);break;case 1:if(ei(v,p,l),c=p,v=c.stateNode,typeof v.componentDidMount=="function")try{v.componentDidMount()}catch(ne){St(c,c.return,ne)}if(c=p,v=c.updateQueue,v!==null){var L=c.stateNode;try{var K=v.shared.hiddenCallbacks;if(K!==null)for(v.shared.hiddenCallbacks=null,v=0;v<K.length;v++)vg(K[v],L)}catch(ne){St(c,c.return,ne)}}l&&R&64&&wy(p),jo(p,p.return);break;case 27:My(p);case 26:case 5:ei(v,p,l),l&&c===null&&R&4&&Iy(p),jo(p,p.return);break;case 12:ei(v,p,l);break;case 31:ei(v,p,l),l&&R&4&&Py(v,p);break;case 13:ei(v,p,l),l&&R&4&&Ny(v,p);break;case 22:p.memoizedState===null&&ei(v,p,l),jo(p,p.return);break;case 30:break;default:ei(v,p,l)}a=a.sibling}}function $f(r,a){var l=null;r!==null&&r.memoizedState!==null&&r.memoizedState.cachePool!==null&&(l=r.memoizedState.cachePool.pool),r=null,a.memoizedState!==null&&a.memoizedState.cachePool!==null&&(r=a.memoizedState.cachePool.pool),r!==l&&(r!=null&&r.refCount++,l!=null&&Ro(l))}function eh(r,a){r=null,a.alternate!==null&&(r=a.alternate.memoizedState.cache),a=a.memoizedState.cache,a!==r&&(a.refCount++,r!=null&&Ro(r))}function gr(r,a,l,c){if(a.subtreeFlags&10256)for(a=a.child;a!==null;)jy(r,a,l,c),a=a.sibling}function jy(r,a,l,c){var v=a.flags;switch(a.tag){case 0:case 11:case 15:gr(r,a,l,c),v&2048&&xo(9,a);break;case 1:gr(r,a,l,c);break;case 3:gr(r,a,l,c),v&2048&&(r=null,a.alternate!==null&&(r=a.alternate.memoizedState.cache),a=a.memoizedState.cache,a!==r&&(a.refCount++,r!=null&&Ro(r)));break;case 12:if(v&2048){gr(r,a,l,c),r=a.stateNode;try{var p=a.memoizedProps,R=p.id,L=p.onPostCommit;typeof L=="function"&&L(R,a.alternate===null?"mount":"update",r.passiveEffectDuration,-0)}catch(K){St(a,a.return,K)}}else gr(r,a,l,c);break;case 31:gr(r,a,l,c);break;case 13:gr(r,a,l,c);break;case 23:break;case 22:p=a.stateNode,R=a.alternate,a.memoizedState!==null?p._visibility&2?gr(r,a,l,c):Bo(r,a):p._visibility&2?gr(r,a,l,c):(p._visibility|=2,Ss(r,a,l,c,(a.subtreeFlags&10256)!==0||!1)),v&2048&&$f(R,a);break;case 24:gr(r,a,l,c),v&2048&&eh(a.alternate,a);break;default:gr(r,a,l,c)}}function Ss(r,a,l,c,v){for(v=v&&((a.subtreeFlags&10256)!==0||!1),a=a.child;a!==null;){var p=r,R=a,L=l,K=c,ne=R.flags;switch(R.tag){case 0:case 11:case 15:Ss(p,R,L,K,v),xo(8,R);break;case 23:break;case 22:var he=R.stateNode;R.memoizedState!==null?he._visibility&2?Ss(p,R,L,K,v):Bo(p,R):(he._visibility|=2,Ss(p,R,L,K,v)),v&&ne&2048&&$f(R.alternate,R);break;case 24:Ss(p,R,L,K,v),v&&ne&2048&&eh(R.alternate,R);break;default:Ss(p,R,L,K,v)}a=a.sibling}}function Bo(r,a){if(a.subtreeFlags&10256)for(a=a.child;a!==null;){var l=r,c=a,v=c.flags;switch(c.tag){case 22:Bo(l,c),v&2048&&$f(c.alternate,c);break;case 24:Bo(l,c),v&2048&&eh(c.alternate,c);break;default:Bo(l,c)}a=a.sibling}}var Fo=8192;function bs(r,a,l){if(r.subtreeFlags&Fo)for(r=r.child;r!==null;)By(r,a,l),r=r.sibling}function By(r,a,l){switch(r.tag){case 26:bs(r,a,l),r.flags&Fo&&r.memoizedState!==null&&kw(l,pr,r.memoizedState,r.memoizedProps);break;case 5:bs(r,a,l);break;case 3:case 4:var c=pr;pr=sc(r.stateNode.containerInfo),bs(r,a,l),pr=c;break;case 22:r.memoizedState===null&&(c=r.alternate,c!==null&&c.memoizedState!==null?(c=Fo,Fo=16777216,bs(r,a,l),Fo=c):bs(r,a,l));break;default:bs(r,a,l)}}function Fy(r){var a=r.alternate;if(a!==null&&(r=a.child,r!==null)){a.child=null;do a=r.sibling,r.sibling=null,r=a;while(r!==null)}}function qo(r){var a=r.deletions;if((r.flags&16)!==0){if(a!==null)for(var l=0;l<a.length;l++){var c=a[l];sn=c,Ky(c,r)}Fy(r)}if(r.subtreeFlags&10256)for(r=r.child;r!==null;)qy(r),r=r.sibling}function qy(r){switch(r.tag){case 0:case 11:case 15:qo(r),r.flags&2048&&Ai(9,r,r.return);break;case 3:qo(r);break;case 12:qo(r);break;case 22:var a=r.stateNode;r.memoizedState!==null&&a._visibility&2&&(r.return===null||r.return.tag!==13)?(a._visibility&=-3,Wu(r)):qo(r);break;default:qo(r)}}function Wu(r){var a=r.deletions;if((r.flags&16)!==0){if(a!==null)for(var l=0;l<a.length;l++){var c=a[l];sn=c,Ky(c,r)}Fy(r)}for(r=r.child;r!==null;){switch(a=r,a.tag){case 0:case 11:case 15:Ai(8,a,a.return),Wu(a);break;case 22:l=a.stateNode,l._visibility&2&&(l._visibility&=-3,Wu(a));break;default:Wu(a)}r=r.sibling}}function Ky(r,a){for(;sn!==null;){var l=sn;switch(l.tag){case 0:case 11:case 15:Ai(8,l,a);break;case 23:case 22:if(l.memoizedState!==null&&l.memoizedState.cachePool!==null){var c=l.memoizedState.cachePool.pool;c!=null&&c.refCount++}break;case 24:Ro(l.memoizedState.cache)}if(c=l.child,c!==null)c.return=l,sn=c;else e:for(l=r;sn!==null;){c=sn;var v=c.sibling,p=c.return;if(ky(c),c===l){sn=null;break e}if(v!==null){v.return=p,sn=v;break e}sn=p}}}var WR={getCacheForType:function(r){var a=fn(Jt),l=a.data.get(r);return l===void 0&&(l=r(),a.data.set(r,l)),l},cacheSignal:function(){return fn(Jt).controller.signal}},YR=typeof WeakMap=="function"?WeakMap:Map,vt=0,Ct=null,it=null,ot=0,yt=0,qn=null,Di=!1,Es=!1,th=!1,ti=0,Kt=0,ki=0,ba=0,nh=0,Kn=0,_s=0,Ko=null,An=null,rh=!1,Yu=0,Hy=0,Ju=1/0,Xu=null,Ui=null,tn=0,Pi=null,Ts=null,ni=0,ih=0,ah=null,Vy=null,Ho=0,sh=null;function Hn(){return(vt&2)!==0&&ot!==0?ot&-ot:J.T!==null?fh():sp()}function Gy(){if(Kn===0)if((ot&536870912)===0||ut){var r=bt;bt<<=1,(bt&3932160)===0&&(bt=262144),Kn=r}else Kn=536870912;return r=Bn.current,r!==null&&(r.flags|=32),Kn}function Dn(r,a,l){(r===Ct&&(yt===2||yt===9)||r.cancelPendingCommit!==null)&&(Rs(r,0),Ni(r,ot,Kn,!1)),uo(r,l),((vt&2)===0||r!==Ct)&&(r===Ct&&((vt&2)===0&&(ba|=l),Kt===4&&Ni(r,ot,Kn,!1)),Ar(r))}function zy(r,a,l){if((vt&6)!==0)throw Error(n(327));var c=!l&&(a&127)===0&&(a&r.expiredLanes)===0||Ln(r,a),v=c?QR(r,a):lh(r,a,!0),p=c;do{if(v===0){Es&&!c&&Ni(r,a,0,!1);break}else{if(l=r.current.alternate,p&&!JR(l)){v=lh(r,a,!1),p=!1;continue}if(v===2){if(p=a,r.errorRecoveryDisabledLanes&p)var R=0;else R=r.pendingLanes&-536870913,R=R!==0?R:R&536870912?536870912:0;if(R!==0){a=R;e:{var L=r;v=Ko;var K=L.current.memoizedState.isDehydrated;if(K&&(Rs(L,R).flags|=256),R=lh(L,R,!1),R!==2){if(th&&!K){L.errorRecoveryDisabledLanes|=p,ba|=p,v=4;break e}p=An,An=v,p!==null&&(An===null?An=p:An.push.apply(An,p))}v=R}if(p=!1,v!==2)continue}}if(v===1){Rs(r,0),Ni(r,a,0,!0);break}e:{switch(c=r,p=v,p){case 0:case 1:throw Error(n(345));case 4:if((a&4194048)!==a)break;case 6:Ni(c,a,Kn,!Di);break e;case 2:An=null;break;case 3:case 5:break;default:throw Error(n(329))}if((a&62914560)===a&&(v=Yu+300-ze(),10<v)){if(Ni(c,a,Kn,!Di),Nn(c,0,!0)!==0)break e;ni=a,c.timeoutHandle=TS(Wy.bind(null,c,l,An,Xu,rh,a,Kn,ba,_s,Di,p,"Throttled",-0,0),v);break e}Wy(c,l,An,Xu,rh,a,Kn,ba,_s,Di,p,null,-0,0)}}break}while(!0);Ar(r)}function Wy(r,a,l,c,v,p,R,L,K,ne,he,ge,ie,ce){if(r.timeoutHandle=-1,ge=a.subtreeFlags,ge&8192||(ge&16785408)===16785408){ge={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:qr},By(a,p,ge);var Le=(p&62914560)===p?Yu-ze():(p&4194048)===p?Hy-ze():0;if(Le=Uw(ge,Le),Le!==null){ni=p,r.cancelPendingCommit=Le(tS.bind(null,r,a,p,l,c,v,R,L,K,he,ge,null,ie,ce)),Ni(r,p,R,!ne);return}}tS(r,a,p,l,c,v,R,L,K)}function JR(r){for(var a=r;;){var l=a.tag;if((l===0||l===11||l===15)&&a.flags&16384&&(l=a.updateQueue,l!==null&&(l=l.stores,l!==null)))for(var c=0;c<l.length;c++){var v=l[c],p=v.getSnapshot;v=v.value;try{if(!xn(p(),v))return!1}catch{return!1}}if(l=a.child,a.subtreeFlags&16384&&l!==null)l.return=a,a=l;else{if(a===r)break;for(;a.sibling===null;){if(a.return===null||a.return===r)return!0;a=a.return}a.sibling.return=a.return,a=a.sibling}}return!0}function Ni(r,a,l,c){a&=~nh,a&=~ba,r.suspendedLanes|=a,r.pingedLanes&=~a,c&&(r.warmLanes|=a),c=r.expirationTimes;for(var v=a;0<v;){var p=31-de(v),R=1<<p;c[p]=-1,v&=~R}l!==0&&rp(r,l,a)}function Qu(){return(vt&6)===0?(Vo(0),!1):!0}function oh(){if(it!==null){if(yt===0)var r=it.return;else r=it,Gr=da=null,Tf(r),vs=null,Co=0,r=it;for(;r!==null;)Ry(r.alternate,r),r=r.return;it=null}}function Rs(r,a){var l=r.timeoutHandle;l!==-1&&(r.timeoutHandle=-1,mw(l)),l=r.cancelPendingCommit,l!==null&&(r.cancelPendingCommit=null,l()),ni=0,oh(),Ct=r,it=l=Hr(r.current,null),ot=a,yt=0,qn=null,Di=!1,Es=Ln(r,a),th=!1,_s=Kn=nh=ba=ki=Kt=0,An=Ko=null,rh=!1,(a&8)!==0&&(a|=a&32);var c=r.entangledLanes;if(c!==0)for(r=r.entanglements,c&=a;0<c;){var v=31-de(c),p=1<<v;a|=r[v],c&=~p}return ti=a,yu(),l}function Yy(r,a){$e=null,J.H=Po,a===hs||a===Cu?(a=cg(),yt=3):a===df?(a=cg(),yt=4):yt=a===Bf?8:a!==null&&typeof a=="object"&&typeof a.then=="function"?6:1,qn=a,it===null&&(Kt=1,Fu(r,nr(a,r.current)))}function Jy(){var r=Bn.current;return r===null?!0:(ot&4194048)===ot?sr===null:(ot&62914560)===ot||(ot&536870912)!==0?r===sr:!1}function Xy(){var r=J.H;return J.H=Po,r===null?Po:r}function Qy(){var r=J.A;return J.A=WR,r}function Zu(){Kt=4,Di||(ot&4194048)!==ot&&Bn.current!==null||(Es=!0),(ki&134217727)===0&&(ba&134217727)===0||Ct===null||Ni(Ct,ot,Kn,!1)}function lh(r,a,l){var c=vt;vt|=2;var v=Xy(),p=Qy();(Ct!==r||ot!==a)&&(Xu=null,Rs(r,a)),a=!1;var R=Kt;e:do try{if(yt!==0&&it!==null){var L=it,K=qn;switch(yt){case 8:oh(),R=6;break e;case 3:case 2:case 9:case 6:Bn.current===null&&(a=!0);var ne=yt;if(yt=0,qn=null,ws(r,L,K,ne),l&&Es){R=0;break e}break;default:ne=yt,yt=0,qn=null,ws(r,L,K,ne)}}XR(),R=Kt;break}catch(he){Yy(r,he)}while(!0);return a&&r.shellSuspendCounter++,Gr=da=null,vt=c,J.H=v,J.A=p,it===null&&(Ct=null,ot=0,yu()),R}function XR(){for(;it!==null;)Zy(it)}function QR(r,a){var l=vt;vt|=2;var c=Xy(),v=Qy();Ct!==r||ot!==a?(Xu=null,Ju=ze()+500,Rs(r,a)):Es=Ln(r,a);e:do try{if(yt!==0&&it!==null){a=it;var p=qn;t:switch(yt){case 1:yt=0,qn=null,ws(r,a,p,1);break;case 2:case 9:if(lg(p)){yt=0,qn=null,$y(a);break}a=function(){yt!==2&&yt!==9||Ct!==r||(yt=7),Ar(r)},p.then(a,a);break e;case 3:yt=7;break e;case 4:yt=5;break e;case 7:lg(p)?(yt=0,qn=null,$y(a)):(yt=0,qn=null,ws(r,a,p,7));break;case 5:var R=null;switch(it.tag){case 26:R=it.memoizedState;case 5:case 27:var L=it;if(R?jS(R):L.stateNode.complete){yt=0,qn=null;var K=L.sibling;if(K!==null)it=K;else{var ne=L.return;ne!==null?(it=ne,$u(ne)):it=null}break t}}yt=0,qn=null,ws(r,a,p,5);break;case 6:yt=0,qn=null,ws(r,a,p,6);break;case 8:oh(),Kt=6;break e;default:throw Error(n(462))}}ZR();break}catch(he){Yy(r,he)}while(!0);return Gr=da=null,J.H=c,J.A=v,vt=l,it!==null?0:(Ct=null,ot=0,yu(),Kt)}function ZR(){for(;it!==null&&!xt();)Zy(it)}function Zy(r){var a=_y(r.alternate,r,ti);r.memoizedProps=r.pendingProps,a===null?$u(r):it=a}function $y(r){var a=r,l=a.alternate;switch(a.tag){case 15:case 0:a=py(l,a,a.pendingProps,a.type,void 0,ot);break;case 11:a=py(l,a,a.pendingProps,a.type.render,a.ref,ot);break;case 5:Tf(a);default:Ry(l,a),a=it=Qp(a,ti),a=_y(l,a,ti)}r.memoizedProps=r.pendingProps,a===null?$u(r):it=a}function ws(r,a,l,c){Gr=da=null,Tf(a),vs=null,Co=0;var v=a.return;try{if(FR(r,v,a,l,ot)){Kt=1,Fu(r,nr(l,r.current)),it=null;return}}catch(p){if(v!==null)throw it=v,p;Kt=1,Fu(r,nr(l,r.current)),it=null;return}a.flags&32768?(ut||c===1?r=!0:Es||(ot&536870912)!==0?r=!1:(Di=r=!0,(c===2||c===9||c===3||c===6)&&(c=Bn.current,c!==null&&c.tag===13&&(c.flags|=16384))),eS(a,r)):$u(a)}function $u(r){var a=r;do{if((a.flags&32768)!==0){eS(a,Di);return}r=a.return;var l=HR(a.alternate,a,ti);if(l!==null){it=l;return}if(a=a.sibling,a!==null){it=a;return}it=a=r}while(a!==null);Kt===0&&(Kt=5)}function eS(r,a){do{var l=VR(r.alternate,r);if(l!==null){l.flags&=32767,it=l;return}if(l=r.return,l!==null&&(l.flags|=32768,l.subtreeFlags=0,l.deletions=null),!a&&(r=r.sibling,r!==null)){it=r;return}it=r=l}while(r!==null);Kt=6,it=null}function tS(r,a,l,c,v,p,R,L,K){r.cancelPendingCommit=null;do ec();while(tn!==0);if((vt&6)!==0)throw Error(n(327));if(a!==null){if(a===r.current)throw Error(n(177));if(p=a.lanes|a.childLanes,p|=Jd,DT(r,l,p,R,L,K),r===Ct&&(it=Ct=null,ot=0),Ts=a,Pi=r,ni=l,ih=p,ah=v,Vy=c,(a.subtreeFlags&10256)!==0||(a.flags&10256)!==0?(r.callbackNode=null,r.callbackPriority=0,nw(vr,function(){return sS(),null})):(r.callbackNode=null,r.callbackPriority=0),c=(a.flags&13878)!==0,(a.subtreeFlags&13878)!==0||c){c=J.T,J.T=null,v=oe.p,oe.p=2,R=vt,vt|=4;try{GR(r,a,l)}finally{vt=R,oe.p=v,J.T=c}}tn=1,nS(),rS(),iS()}}function nS(){if(tn===1){tn=0;var r=Pi,a=Ts,l=(a.flags&13878)!==0;if((a.subtreeFlags&13878)!==0||l){l=J.T,J.T=null;var c=oe.p;oe.p=2;var v=vt;vt|=4;try{Ly(a,r);var p=bh,R=Kp(r.containerInfo),L=p.focusedElem,K=p.selectionRange;if(R!==L&&L&&L.ownerDocument&&qp(L.ownerDocument.documentElement,L)){if(K!==null&&Vd(L)){var ne=K.start,he=K.end;if(he===void 0&&(he=ne),"selectionStart"in L)L.selectionStart=ne,L.selectionEnd=Math.min(he,L.value.length);else{var ge=L.ownerDocument||document,ie=ge&&ge.defaultView||window;if(ie.getSelection){var ce=ie.getSelection(),Le=L.textContent.length,Ke=Math.min(K.start,Le),Rt=K.end===void 0?Ke:Math.min(K.end,Le);!ce.extend&&Ke>Rt&&(R=Rt,Rt=Ke,Ke=R);var Q=Fp(L,Ke),W=Fp(L,Rt);if(Q&&W&&(ce.rangeCount!==1||ce.anchorNode!==Q.node||ce.anchorOffset!==Q.offset||ce.focusNode!==W.node||ce.focusOffset!==W.offset)){var te=ge.createRange();te.setStart(Q.node,Q.offset),ce.removeAllRanges(),Ke>Rt?(ce.addRange(te),ce.extend(W.node,W.offset)):(te.setEnd(W.node,W.offset),ce.addRange(te))}}}}for(ge=[],ce=L;ce=ce.parentNode;)ce.nodeType===1&&ge.push({element:ce,left:ce.scrollLeft,top:ce.scrollTop});for(typeof L.focus=="function"&&L.focus(),L=0;L<ge.length;L++){var ve=ge[L];ve.element.scrollLeft=ve.left,ve.element.scrollTop=ve.top}}fc=!!Sh,bh=Sh=null}finally{vt=v,oe.p=c,J.T=l}}r.current=a,tn=2}}function rS(){if(tn===2){tn=0;var r=Pi,a=Ts,l=(a.flags&8772)!==0;if((a.subtreeFlags&8772)!==0||l){l=J.T,J.T=null;var c=oe.p;oe.p=2;var v=vt;vt|=4;try{Dy(r,a.alternate,a)}finally{vt=v,oe.p=c,J.T=l}}tn=3}}function iS(){if(tn===4||tn===3){tn=0,we();var r=Pi,a=Ts,l=ni,c=Vy;(a.subtreeFlags&10256)!==0||(a.flags&10256)!==0?tn=5:(tn=0,Ts=Pi=null,aS(r,r.pendingLanes));var v=r.pendingLanes;if(v===0&&(Ui=null),wd(l),a=a.stateNode,ee&&typeof ee.onCommitFiberRoot=="function")try{ee.onCommitFiberRoot(be,a,void 0,(a.current.flags&128)===128)}catch{}if(c!==null){a=J.T,v=oe.p,oe.p=2,J.T=null;try{for(var p=r.onRecoverableError,R=0;R<c.length;R++){var L=c[R];p(L.value,{componentStack:L.stack})}}finally{J.T=a,oe.p=v}}(ni&3)!==0&&ec(),Ar(r),v=r.pendingLanes,(l&261930)!==0&&(v&42)!==0?r===sh?Ho++:(Ho=0,sh=r):Ho=0,Vo(0)}}function aS(r,a){(r.pooledCacheLanes&=a)===0&&(a=r.pooledCache,a!=null&&(r.pooledCache=null,Ro(a)))}function ec(){return nS(),rS(),iS(),sS()}function sS(){if(tn!==5)return!1;var r=Pi,a=ih;ih=0;var l=wd(ni),c=J.T,v=oe.p;try{oe.p=32>l?32:l,J.T=null,l=ah,ah=null;var p=Pi,R=ni;if(tn=0,Ts=Pi=null,ni=0,(vt&6)!==0)throw Error(n(331));var L=vt;if(vt|=4,qy(p.current),jy(p,p.current,R,l),vt=L,Vo(0,!1),ee&&typeof ee.onPostCommitFiberRoot=="function")try{ee.onPostCommitFiberRoot(be,p)}catch{}return!0}finally{oe.p=v,J.T=c,aS(r,a)}}function oS(r,a,l){a=nr(l,a),a=jf(r.stateNode,a,2),r=Ii(r,a,2),r!==null&&(uo(r,2),Ar(r))}function St(r,a,l){if(r.tag===3)oS(r,r,l);else for(;a!==null;){if(a.tag===3){oS(a,r,l);break}else if(a.tag===1){var c=a.stateNode;if(typeof a.type.getDerivedStateFromError=="function"||typeof c.componentDidCatch=="function"&&(Ui===null||!Ui.has(c))){r=nr(l,r),l=ly(2),c=Ii(a,l,2),c!==null&&(uy(l,c,a,r),uo(c,2),Ar(c));break}}a=a.return}}function uh(r,a,l){var c=r.pingCache;if(c===null){c=r.pingCache=new YR;var v=new Set;c.set(a,v)}else v=c.get(a),v===void 0&&(v=new Set,c.set(a,v));v.has(l)||(th=!0,v.add(l),r=$R.bind(null,r,a,l),a.then(r,r))}function $R(r,a,l){var c=r.pingCache;c!==null&&c.delete(a),r.pingedLanes|=r.suspendedLanes&l,r.warmLanes&=~l,Ct===r&&(ot&l)===l&&(Kt===4||Kt===3&&(ot&62914560)===ot&&300>ze()-Yu?(vt&2)===0&&Rs(r,0):nh|=l,_s===ot&&(_s=0)),Ar(r)}function lS(r,a){a===0&&(a=np()),r=la(r,a),r!==null&&(uo(r,a),Ar(r))}function ew(r){var a=r.memoizedState,l=0;a!==null&&(l=a.retryLane),lS(r,l)}function tw(r,a){var l=0;switch(r.tag){case 31:case 13:var c=r.stateNode,v=r.memoizedState;v!==null&&(l=v.retryLane);break;case 19:c=r.stateNode;break;case 22:c=r.stateNode._retryCache;break;default:throw Error(n(314))}c!==null&&c.delete(a),lS(r,l)}function nw(r,a){return qe(r,a)}var tc=null,Cs=null,ch=!1,nc=!1,dh=!1,Li=0;function Ar(r){r!==Cs&&r.next===null&&(Cs===null?tc=Cs=r:Cs=Cs.next=r),nc=!0,ch||(ch=!0,iw())}function Vo(r,a){if(!dh&&nc){dh=!0;do for(var l=!1,c=tc;c!==null;){if(r!==0){var v=c.pendingLanes;if(v===0)var p=0;else{var R=c.suspendedLanes,L=c.pingedLanes;p=(1<<31-de(42|r)+1)-1,p&=v&~(R&~L),p=p&201326741?p&201326741|1:p?p|2:0}p!==0&&(l=!0,fS(c,p))}else p=ot,p=Nn(c,c===Ct?p:0,c.cancelPendingCommit!==null||c.timeoutHandle!==-1),(p&3)===0||Ln(c,p)||(l=!0,fS(c,p));c=c.next}while(l);dh=!1}}function rw(){uS()}function uS(){nc=ch=!1;var r=0;Li!==0&&vw()&&(r=Li);for(var a=ze(),l=null,c=tc;c!==null;){var v=c.next,p=cS(c,a);p===0?(c.next=null,l===null?tc=v:l.next=v,v===null&&(Cs=l)):(l=c,(r!==0||(p&3)!==0)&&(nc=!0)),c=v}tn!==0&&tn!==5||Vo(r),Li!==0&&(Li=0)}function cS(r,a){for(var l=r.suspendedLanes,c=r.pingedLanes,v=r.expirationTimes,p=r.pendingLanes&-62914561;0<p;){var R=31-de(p),L=1<<R,K=v[R];K===-1?((L&l)===0||(L&c)!==0)&&(v[R]=AT(L,a)):K<=a&&(r.expiredLanes|=L),p&=~L}if(a=Ct,l=ot,l=Nn(r,r===a?l:0,r.cancelPendingCommit!==null||r.timeoutHandle!==-1),c=r.callbackNode,l===0||r===a&&(yt===2||yt===9)||r.cancelPendingCommit!==null)return c!==null&&c!==null&&pt(c),r.callbackNode=null,r.callbackPriority=0;if((l&3)===0||Ln(r,l)){if(a=l&-l,a===r.callbackPriority)return a;switch(c!==null&&pt(c),wd(l)){case 2:case 8:l=za;break;case 32:l=vr;break;case 268435456:l=Cr;break;default:l=vr}return c=dS.bind(null,r),l=qe(l,c),r.callbackPriority=a,r.callbackNode=l,a}return c!==null&&c!==null&&pt(c),r.callbackPriority=2,r.callbackNode=null,2}function dS(r,a){if(tn!==0&&tn!==5)return r.callbackNode=null,r.callbackPriority=0,null;var l=r.callbackNode;if(ec()&&r.callbackNode!==l)return null;var c=ot;return c=Nn(r,r===Ct?c:0,r.cancelPendingCommit!==null||r.timeoutHandle!==-1),c===0?null:(zy(r,c,a),cS(r,ze()),r.callbackNode!=null&&r.callbackNode===l?dS.bind(null,r):null)}function fS(r,a){if(ec())return null;zy(r,a,!0)}function iw(){pw(function(){(vt&6)!==0?qe(wr,rw):uS()})}function fh(){if(Li===0){var r=ds;r===0&&(r=tt,tt<<=1,(tt&261888)===0&&(tt=256)),Li=r}return Li}function hS(r){return r==null||typeof r=="symbol"||typeof r=="boolean"?null:typeof r=="function"?r:cu(""+r)}function vS(r,a){var l=a.ownerDocument.createElement("input");return l.name=a.name,l.value=a.value,r.id&&l.setAttribute("form",r.id),a.parentNode.insertBefore(l,a),r=new FormData(r),l.parentNode.removeChild(l),r}function aw(r,a,l,c,v){if(a==="submit"&&l&&l.stateNode===v){var p=hS((v[wn]||null).action),R=c.submitter;R&&(a=(a=R[wn]||null)?hS(a.formAction):R.getAttribute("formAction"),a!==null&&(p=a,R=null));var L=new vu("action","action",null,c,v);r.push({event:L,listeners:[{instance:null,listener:function(){if(c.defaultPrevented){if(Li!==0){var K=R?vS(v,R):new FormData(v);kf(l,{pending:!0,data:K,method:v.method,action:p},null,K)}}else typeof p=="function"&&(L.preventDefault(),K=R?vS(v,R):new FormData(v),kf(l,{pending:!0,data:K,method:v.method,action:p},p,K))},currentTarget:v}]})}}for(var hh=0;hh<Yd.length;hh++){var vh=Yd[hh],sw=vh.toLowerCase(),ow=vh[0].toUpperCase()+vh.slice(1);mr(sw,"on"+ow)}mr(Gp,"onAnimationEnd"),mr(zp,"onAnimationIteration"),mr(Wp,"onAnimationStart"),mr("dblclick","onDoubleClick"),mr("focusin","onFocus"),mr("focusout","onBlur"),mr(TR,"onTransitionRun"),mr(RR,"onTransitionStart"),mr(wR,"onTransitionCancel"),mr(Yp,"onTransitionEnd"),Qa("onMouseEnter",["mouseout","mouseover"]),Qa("onMouseLeave",["mouseout","mouseover"]),Qa("onPointerEnter",["pointerout","pointerover"]),Qa("onPointerLeave",["pointerout","pointerover"]),ia("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),ia("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),ia("onBeforeInput",["compositionend","keypress","textInput","paste"]),ia("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),ia("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),ia("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Go="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),lw=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(Go));function mS(r,a){a=(a&4)!==0;for(var l=0;l<r.length;l++){var c=r[l],v=c.event;c=c.listeners;e:{var p=void 0;if(a)for(var R=c.length-1;0<=R;R--){var L=c[R],K=L.instance,ne=L.currentTarget;if(L=L.listener,K!==p&&v.isPropagationStopped())break e;p=L,v.currentTarget=ne;try{p(v)}catch(he){gu(he)}v.currentTarget=null,p=K}else for(R=0;R<c.length;R++){if(L=c[R],K=L.instance,ne=L.currentTarget,L=L.listener,K!==p&&v.isPropagationStopped())break e;p=L,v.currentTarget=ne;try{p(v)}catch(he){gu(he)}v.currentTarget=null,p=K}}}}function at(r,a){var l=a[Cd];l===void 0&&(l=a[Cd]=new Set);var c=r+"__bubble";l.has(c)||(pS(a,r,2,!1),l.add(c))}function mh(r,a,l){var c=0;a&&(c|=4),pS(l,r,c,a)}var rc="_reactListening"+Math.random().toString(36).slice(2);function ph(r){if(!r[rc]){r[rc]=!0,up.forEach(function(l){l!=="selectionchange"&&(lw.has(l)||mh(l,!1,r),mh(l,!0,r))});var a=r.nodeType===9?r:r.ownerDocument;a===null||a[rc]||(a[rc]=!0,mh("selectionchange",!1,a))}}function pS(r,a,l,c){switch(GS(a)){case 2:var v=Lw;break;case 8:v=xw;break;default:v=Dh}l=v.bind(null,a,l,r),v=void 0,!Nd||a!=="touchstart"&&a!=="touchmove"&&a!=="wheel"||(v=!0),c?v!==void 0?r.addEventListener(a,l,{capture:!0,passive:v}):r.addEventListener(a,l,!0):v!==void 0?r.addEventListener(a,l,{passive:v}):r.addEventListener(a,l,!1)}function gh(r,a,l,c,v){var p=c;if((a&1)===0&&(a&2)===0&&c!==null)e:for(;;){if(c===null)return;var R=c.tag;if(R===3||R===4){var L=c.stateNode.containerInfo;if(L===v)break;if(R===4)for(R=c.return;R!==null;){var K=R.tag;if((K===3||K===4)&&R.stateNode.containerInfo===v)return;R=R.return}for(;L!==null;){if(R=Ya(L),R===null)return;if(K=R.tag,K===5||K===6||K===26||K===27){c=p=R;continue e}L=L.parentNode}}c=c.return}Ep(function(){var ne=p,he=Ud(l),ge=[];e:{var ie=Jp.get(r);if(ie!==void 0){var ce=vu,Le=r;switch(r){case"keypress":if(fu(l)===0)break e;case"keydown":case"keyup":ce=tR;break;case"focusin":Le="focus",ce=Bd;break;case"focusout":Le="blur",ce=Bd;break;case"beforeblur":case"afterblur":ce=Bd;break;case"click":if(l.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ce=Rp;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ce=HT;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ce=iR;break;case Gp:case zp:case Wp:ce=zT;break;case Yp:ce=sR;break;case"scroll":case"scrollend":ce=qT;break;case"wheel":ce=lR;break;case"copy":case"cut":case"paste":ce=YT;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ce=Cp;break;case"toggle":case"beforetoggle":ce=cR}var Ke=(a&4)!==0,Rt=!Ke&&(r==="scroll"||r==="scrollend"),Q=Ke?ie!==null?ie+"Capture":null:ie;Ke=[];for(var W=ne,te;W!==null;){var ve=W;if(te=ve.stateNode,ve=ve.tag,ve!==5&&ve!==26&&ve!==27||te===null||Q===null||(ve=ho(W,Q),ve!=null&&Ke.push(zo(W,ve,te))),Rt)break;W=W.return}0<Ke.length&&(ie=new ce(ie,Le,null,l,he),ge.push({event:ie,listeners:Ke}))}}if((a&7)===0){e:{if(ie=r==="mouseover"||r==="pointerover",ce=r==="mouseout"||r==="pointerout",ie&&l!==kd&&(Le=l.relatedTarget||l.fromElement)&&(Ya(Le)||Le[Wa]))break e;if((ce||ie)&&(ie=he.window===he?he:(ie=he.ownerDocument)?ie.defaultView||ie.parentWindow:window,ce?(Le=l.relatedTarget||l.toElement,ce=ne,Le=Le?Ya(Le):null,Le!==null&&(Rt=o(Le),Ke=Le.tag,Le!==Rt||Ke!==5&&Ke!==27&&Ke!==6)&&(Le=null)):(ce=null,Le=ne),ce!==Le)){if(Ke=Rp,ve="onMouseLeave",Q="onMouseEnter",W="mouse",(r==="pointerout"||r==="pointerover")&&(Ke=Cp,ve="onPointerLeave",Q="onPointerEnter",W="pointer"),Rt=ce==null?ie:fo(ce),te=Le==null?ie:fo(Le),ie=new Ke(ve,W+"leave",ce,l,he),ie.target=Rt,ie.relatedTarget=te,ve=null,Ya(he)===ne&&(Ke=new Ke(Q,W+"enter",Le,l,he),Ke.target=te,Ke.relatedTarget=Rt,ve=Ke),Rt=ve,ce&&Le)t:{for(Ke=uw,Q=ce,W=Le,te=0,ve=Q;ve;ve=Ke(ve))te++;ve=0;for(var Fe=W;Fe;Fe=Ke(Fe))ve++;for(;0<te-ve;)Q=Ke(Q),te--;for(;0<ve-te;)W=Ke(W),ve--;for(;te--;){if(Q===W||W!==null&&Q===W.alternate){Ke=Q;break t}Q=Ke(Q),W=Ke(W)}Ke=null}else Ke=null;ce!==null&&gS(ge,ie,ce,Ke,!1),Le!==null&&Rt!==null&&gS(ge,Rt,Le,Ke,!0)}}e:{if(ie=ne?fo(ne):window,ce=ie.nodeName&&ie.nodeName.toLowerCase(),ce==="select"||ce==="input"&&ie.type==="file")var dt=Pp;else if(kp(ie))if(Np)dt=bR;else{dt=yR;var je=gR}else ce=ie.nodeName,!ce||ce.toLowerCase()!=="input"||ie.type!=="checkbox"&&ie.type!=="radio"?ne&&Dd(ne.elementType)&&(dt=Pp):dt=SR;if(dt&&(dt=dt(r,ne))){Up(ge,dt,l,he);break e}je&&je(r,ie,ne),r==="focusout"&&ne&&ie.type==="number"&&ne.memoizedProps.value!=null&&Ad(ie,"number",ie.value)}switch(je=ne?fo(ne):window,r){case"focusin":(kp(je)||je.contentEditable==="true")&&(rs=je,Gd=ne,Eo=null);break;case"focusout":Eo=Gd=rs=null;break;case"mousedown":zd=!0;break;case"contextmenu":case"mouseup":case"dragend":zd=!1,Hp(ge,l,he);break;case"selectionchange":if(_R)break;case"keydown":case"keyup":Hp(ge,l,he)}var nt;if(qd)e:{switch(r){case"compositionstart":var lt="onCompositionStart";break e;case"compositionend":lt="onCompositionEnd";break e;case"compositionupdate":lt="onCompositionUpdate";break e}lt=void 0}else ns?Ap(r,l)&&(lt="onCompositionEnd"):r==="keydown"&&l.keyCode===229&&(lt="onCompositionStart");lt&&(Ip&&l.locale!=="ko"&&(ns||lt!=="onCompositionStart"?lt==="onCompositionEnd"&&ns&&(nt=_p()):(bi=he,Ld="value"in bi?bi.value:bi.textContent,ns=!0)),je=ic(ne,lt),0<je.length&&(lt=new wp(lt,r,null,l,he),ge.push({event:lt,listeners:je}),nt?lt.data=nt:(nt=Dp(l),nt!==null&&(lt.data=nt)))),(nt=fR?hR(r,l):vR(r,l))&&(lt=ic(ne,"onBeforeInput"),0<lt.length&&(je=new wp("onBeforeInput","beforeinput",null,l,he),ge.push({event:je,listeners:lt}),je.data=nt)),aw(ge,r,ne,l,he)}mS(ge,a)})}function zo(r,a,l){return{instance:r,listener:a,currentTarget:l}}function ic(r,a){for(var l=a+"Capture",c=[];r!==null;){var v=r,p=v.stateNode;if(v=v.tag,v!==5&&v!==26&&v!==27||p===null||(v=ho(r,l),v!=null&&c.unshift(zo(r,v,p)),v=ho(r,a),v!=null&&c.push(zo(r,v,p))),r.tag===3)return c;r=r.return}return[]}function uw(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5&&r.tag!==27);return r||null}function gS(r,a,l,c,v){for(var p=a._reactName,R=[];l!==null&&l!==c;){var L=l,K=L.alternate,ne=L.stateNode;if(L=L.tag,K!==null&&K===c)break;L!==5&&L!==26&&L!==27||ne===null||(K=ne,v?(ne=ho(l,p),ne!=null&&R.unshift(zo(l,ne,K))):v||(ne=ho(l,p),ne!=null&&R.push(zo(l,ne,K)))),l=l.return}R.length!==0&&r.push({event:a,listeners:R})}var cw=/\r\n?/g,dw=/\u0000|\uFFFD/g;function yS(r){return(typeof r=="string"?r:""+r).replace(cw,`
`).replace(dw,"")}function SS(r,a){return a=yS(a),yS(r)===a}function Tt(r,a,l,c,v,p){switch(l){case"children":typeof c=="string"?a==="body"||a==="textarea"&&c===""||$a(r,c):(typeof c=="number"||typeof c=="bigint")&&a!=="body"&&$a(r,""+c);break;case"className":lu(r,"class",c);break;case"tabIndex":lu(r,"tabindex",c);break;case"dir":case"role":case"viewBox":case"width":case"height":lu(r,l,c);break;case"style":Sp(r,c,p);break;case"data":if(a!=="object"){lu(r,"data",c);break}case"src":case"href":if(c===""&&(a!=="a"||l!=="href")){r.removeAttribute(l);break}if(c==null||typeof c=="function"||typeof c=="symbol"||typeof c=="boolean"){r.removeAttribute(l);break}c=cu(""+c),r.setAttribute(l,c);break;case"action":case"formAction":if(typeof c=="function"){r.setAttribute(l,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof p=="function"&&(l==="formAction"?(a!=="input"&&Tt(r,a,"name",v.name,v,null),Tt(r,a,"formEncType",v.formEncType,v,null),Tt(r,a,"formMethod",v.formMethod,v,null),Tt(r,a,"formTarget",v.formTarget,v,null)):(Tt(r,a,"encType",v.encType,v,null),Tt(r,a,"method",v.method,v,null),Tt(r,a,"target",v.target,v,null)));if(c==null||typeof c=="symbol"||typeof c=="boolean"){r.removeAttribute(l);break}c=cu(""+c),r.setAttribute(l,c);break;case"onClick":c!=null&&(r.onclick=qr);break;case"onScroll":c!=null&&at("scroll",r);break;case"onScrollEnd":c!=null&&at("scrollend",r);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(n(61));if(l=c.__html,l!=null){if(v.children!=null)throw Error(n(60));r.innerHTML=l}}break;case"multiple":r.multiple=c&&typeof c!="function"&&typeof c!="symbol";break;case"muted":r.muted=c&&typeof c!="function"&&typeof c!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(c==null||typeof c=="function"||typeof c=="boolean"||typeof c=="symbol"){r.removeAttribute("xlink:href");break}l=cu(""+c),r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",l);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":c!=null&&typeof c!="function"&&typeof c!="symbol"?r.setAttribute(l,""+c):r.removeAttribute(l);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":c&&typeof c!="function"&&typeof c!="symbol"?r.setAttribute(l,""):r.removeAttribute(l);break;case"capture":case"download":c===!0?r.setAttribute(l,""):c!==!1&&c!=null&&typeof c!="function"&&typeof c!="symbol"?r.setAttribute(l,c):r.removeAttribute(l);break;case"cols":case"rows":case"size":case"span":c!=null&&typeof c!="function"&&typeof c!="symbol"&&!isNaN(c)&&1<=c?r.setAttribute(l,c):r.removeAttribute(l);break;case"rowSpan":case"start":c==null||typeof c=="function"||typeof c=="symbol"||isNaN(c)?r.removeAttribute(l):r.setAttribute(l,c);break;case"popover":at("beforetoggle",r),at("toggle",r),ou(r,"popover",c);break;case"xlinkActuate":Fr(r,"http://www.w3.org/1999/xlink","xlink:actuate",c);break;case"xlinkArcrole":Fr(r,"http://www.w3.org/1999/xlink","xlink:arcrole",c);break;case"xlinkRole":Fr(r,"http://www.w3.org/1999/xlink","xlink:role",c);break;case"xlinkShow":Fr(r,"http://www.w3.org/1999/xlink","xlink:show",c);break;case"xlinkTitle":Fr(r,"http://www.w3.org/1999/xlink","xlink:title",c);break;case"xlinkType":Fr(r,"http://www.w3.org/1999/xlink","xlink:type",c);break;case"xmlBase":Fr(r,"http://www.w3.org/XML/1998/namespace","xml:base",c);break;case"xmlLang":Fr(r,"http://www.w3.org/XML/1998/namespace","xml:lang",c);break;case"xmlSpace":Fr(r,"http://www.w3.org/XML/1998/namespace","xml:space",c);break;case"is":ou(r,"is",c);break;case"innerText":case"textContent":break;default:(!(2<l.length)||l[0]!=="o"&&l[0]!=="O"||l[1]!=="n"&&l[1]!=="N")&&(l=BT.get(l)||l,ou(r,l,c))}}function yh(r,a,l,c,v,p){switch(l){case"style":Sp(r,c,p);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(n(61));if(l=c.__html,l!=null){if(v.children!=null)throw Error(n(60));r.innerHTML=l}}break;case"children":typeof c=="string"?$a(r,c):(typeof c=="number"||typeof c=="bigint")&&$a(r,""+c);break;case"onScroll":c!=null&&at("scroll",r);break;case"onScrollEnd":c!=null&&at("scrollend",r);break;case"onClick":c!=null&&(r.onclick=qr);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!cp.hasOwnProperty(l))e:{if(l[0]==="o"&&l[1]==="n"&&(v=l.endsWith("Capture"),a=l.slice(2,v?l.length-7:void 0),p=r[wn]||null,p=p!=null?p[l]:null,typeof p=="function"&&r.removeEventListener(a,p,v),typeof c=="function")){typeof p!="function"&&p!==null&&(l in r?r[l]=null:r.hasAttribute(l)&&r.removeAttribute(l)),r.addEventListener(a,c,v);break e}l in r?r[l]=c:c===!0?r.setAttribute(l,""):ou(r,l,c)}}}function vn(r,a,l){switch(a){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":at("error",r),at("load",r);var c=!1,v=!1,p;for(p in l)if(l.hasOwnProperty(p)){var R=l[p];if(R!=null)switch(p){case"src":c=!0;break;case"srcSet":v=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(n(137,a));default:Tt(r,a,p,R,l,null)}}v&&Tt(r,a,"srcSet",l.srcSet,l,null),c&&Tt(r,a,"src",l.src,l,null);return;case"input":at("invalid",r);var L=p=R=v=null,K=null,ne=null;for(c in l)if(l.hasOwnProperty(c)){var he=l[c];if(he!=null)switch(c){case"name":v=he;break;case"type":R=he;break;case"checked":K=he;break;case"defaultChecked":ne=he;break;case"value":p=he;break;case"defaultValue":L=he;break;case"children":case"dangerouslySetInnerHTML":if(he!=null)throw Error(n(137,a));break;default:Tt(r,a,c,he,l,null)}}mp(r,p,L,K,ne,R,v,!1);return;case"select":at("invalid",r),c=R=p=null;for(v in l)if(l.hasOwnProperty(v)&&(L=l[v],L!=null))switch(v){case"value":p=L;break;case"defaultValue":R=L;break;case"multiple":c=L;default:Tt(r,a,v,L,l,null)}a=p,l=R,r.multiple=!!c,a!=null?Za(r,!!c,a,!1):l!=null&&Za(r,!!c,l,!0);return;case"textarea":at("invalid",r),p=v=c=null;for(R in l)if(l.hasOwnProperty(R)&&(L=l[R],L!=null))switch(R){case"value":c=L;break;case"defaultValue":v=L;break;case"children":p=L;break;case"dangerouslySetInnerHTML":if(L!=null)throw Error(n(91));break;default:Tt(r,a,R,L,l,null)}gp(r,c,v,p);return;case"option":for(K in l)l.hasOwnProperty(K)&&(c=l[K],c!=null)&&(K==="selected"?r.selected=c&&typeof c!="function"&&typeof c!="symbol":Tt(r,a,K,c,l,null));return;case"dialog":at("beforetoggle",r),at("toggle",r),at("cancel",r),at("close",r);break;case"iframe":case"object":at("load",r);break;case"video":case"audio":for(c=0;c<Go.length;c++)at(Go[c],r);break;case"image":at("error",r),at("load",r);break;case"details":at("toggle",r);break;case"embed":case"source":case"link":at("error",r),at("load",r);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(ne in l)if(l.hasOwnProperty(ne)&&(c=l[ne],c!=null))switch(ne){case"children":case"dangerouslySetInnerHTML":throw Error(n(137,a));default:Tt(r,a,ne,c,l,null)}return;default:if(Dd(a)){for(he in l)l.hasOwnProperty(he)&&(c=l[he],c!==void 0&&yh(r,a,he,c,l,void 0));return}}for(L in l)l.hasOwnProperty(L)&&(c=l[L],c!=null&&Tt(r,a,L,c,l,null))}function fw(r,a,l,c){switch(a){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var v=null,p=null,R=null,L=null,K=null,ne=null,he=null;for(ce in l){var ge=l[ce];if(l.hasOwnProperty(ce)&&ge!=null)switch(ce){case"checked":break;case"value":break;case"defaultValue":K=ge;default:c.hasOwnProperty(ce)||Tt(r,a,ce,null,c,ge)}}for(var ie in c){var ce=c[ie];if(ge=l[ie],c.hasOwnProperty(ie)&&(ce!=null||ge!=null))switch(ie){case"type":p=ce;break;case"name":v=ce;break;case"checked":ne=ce;break;case"defaultChecked":he=ce;break;case"value":R=ce;break;case"defaultValue":L=ce;break;case"children":case"dangerouslySetInnerHTML":if(ce!=null)throw Error(n(137,a));break;default:ce!==ge&&Tt(r,a,ie,ce,c,ge)}}Md(r,R,L,K,ne,he,p,v);return;case"select":ce=R=L=ie=null;for(p in l)if(K=l[p],l.hasOwnProperty(p)&&K!=null)switch(p){case"value":break;case"multiple":ce=K;default:c.hasOwnProperty(p)||Tt(r,a,p,null,c,K)}for(v in c)if(p=c[v],K=l[v],c.hasOwnProperty(v)&&(p!=null||K!=null))switch(v){case"value":ie=p;break;case"defaultValue":L=p;break;case"multiple":R=p;default:p!==K&&Tt(r,a,v,p,c,K)}a=L,l=R,c=ce,ie!=null?Za(r,!!l,ie,!1):!!c!=!!l&&(a!=null?Za(r,!!l,a,!0):Za(r,!!l,l?[]:"",!1));return;case"textarea":ce=ie=null;for(L in l)if(v=l[L],l.hasOwnProperty(L)&&v!=null&&!c.hasOwnProperty(L))switch(L){case"value":break;case"children":break;default:Tt(r,a,L,null,c,v)}for(R in c)if(v=c[R],p=l[R],c.hasOwnProperty(R)&&(v!=null||p!=null))switch(R){case"value":ie=v;break;case"defaultValue":ce=v;break;case"children":break;case"dangerouslySetInnerHTML":if(v!=null)throw Error(n(91));break;default:v!==p&&Tt(r,a,R,v,c,p)}pp(r,ie,ce);return;case"option":for(var Le in l)ie=l[Le],l.hasOwnProperty(Le)&&ie!=null&&!c.hasOwnProperty(Le)&&(Le==="selected"?r.selected=!1:Tt(r,a,Le,null,c,ie));for(K in c)ie=c[K],ce=l[K],c.hasOwnProperty(K)&&ie!==ce&&(ie!=null||ce!=null)&&(K==="selected"?r.selected=ie&&typeof ie!="function"&&typeof ie!="symbol":Tt(r,a,K,ie,c,ce));return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var Ke in l)ie=l[Ke],l.hasOwnProperty(Ke)&&ie!=null&&!c.hasOwnProperty(Ke)&&Tt(r,a,Ke,null,c,ie);for(ne in c)if(ie=c[ne],ce=l[ne],c.hasOwnProperty(ne)&&ie!==ce&&(ie!=null||ce!=null))switch(ne){case"children":case"dangerouslySetInnerHTML":if(ie!=null)throw Error(n(137,a));break;default:Tt(r,a,ne,ie,c,ce)}return;default:if(Dd(a)){for(var Rt in l)ie=l[Rt],l.hasOwnProperty(Rt)&&ie!==void 0&&!c.hasOwnProperty(Rt)&&yh(r,a,Rt,void 0,c,ie);for(he in c)ie=c[he],ce=l[he],!c.hasOwnProperty(he)||ie===ce||ie===void 0&&ce===void 0||yh(r,a,he,ie,c,ce);return}}for(var Q in l)ie=l[Q],l.hasOwnProperty(Q)&&ie!=null&&!c.hasOwnProperty(Q)&&Tt(r,a,Q,null,c,ie);for(ge in c)ie=c[ge],ce=l[ge],!c.hasOwnProperty(ge)||ie===ce||ie==null&&ce==null||Tt(r,a,ge,ie,c,ce)}function bS(r){switch(r){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function hw(){if(typeof performance.getEntriesByType=="function"){for(var r=0,a=0,l=performance.getEntriesByType("resource"),c=0;c<l.length;c++){var v=l[c],p=v.transferSize,R=v.initiatorType,L=v.duration;if(p&&L&&bS(R)){for(R=0,L=v.responseEnd,c+=1;c<l.length;c++){var K=l[c],ne=K.startTime;if(ne>L)break;var he=K.transferSize,ge=K.initiatorType;he&&bS(ge)&&(K=K.responseEnd,R+=he*(K<L?1:(L-ne)/(K-ne)))}if(--c,a+=8*(p+R)/(v.duration/1e3),r++,10<r)break}}if(0<r)return a/r/1e6}return navigator.connection&&(r=navigator.connection.downlink,typeof r=="number")?r:5}var Sh=null,bh=null;function ac(r){return r.nodeType===9?r:r.ownerDocument}function ES(r){switch(r){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function _S(r,a){if(r===0)switch(a){case"svg":return 1;case"math":return 2;default:return 0}return r===1&&a==="foreignObject"?0:r}function Eh(r,a){return r==="textarea"||r==="noscript"||typeof a.children=="string"||typeof a.children=="number"||typeof a.children=="bigint"||typeof a.dangerouslySetInnerHTML=="object"&&a.dangerouslySetInnerHTML!==null&&a.dangerouslySetInnerHTML.__html!=null}var _h=null;function vw(){var r=window.event;return r&&r.type==="popstate"?r===_h?!1:(_h=r,!0):(_h=null,!1)}var TS=typeof setTimeout=="function"?setTimeout:void 0,mw=typeof clearTimeout=="function"?clearTimeout:void 0,RS=typeof Promise=="function"?Promise:void 0,pw=typeof queueMicrotask=="function"?queueMicrotask:typeof RS<"u"?function(r){return RS.resolve(null).then(r).catch(gw)}:TS;function gw(r){setTimeout(function(){throw r})}function xi(r){return r==="head"}function wS(r,a){var l=a,c=0;do{var v=l.nextSibling;if(r.removeChild(l),v&&v.nodeType===8)if(l=v.data,l==="/$"||l==="/&"){if(c===0){r.removeChild(v),As(a);return}c--}else if(l==="$"||l==="$?"||l==="$~"||l==="$!"||l==="&")c++;else if(l==="html")Wo(r.ownerDocument.documentElement);else if(l==="head"){l=r.ownerDocument.head,Wo(l);for(var p=l.firstChild;p;){var R=p.nextSibling,L=p.nodeName;p[co]||L==="SCRIPT"||L==="STYLE"||L==="LINK"&&p.rel.toLowerCase()==="stylesheet"||l.removeChild(p),p=R}}else l==="body"&&Wo(r.ownerDocument.body);l=v}while(l);As(a)}function CS(r,a){var l=r;r=0;do{var c=l.nextSibling;if(l.nodeType===1?a?(l._stashedDisplay=l.style.display,l.style.display="none"):(l.style.display=l._stashedDisplay||"",l.getAttribute("style")===""&&l.removeAttribute("style")):l.nodeType===3&&(a?(l._stashedText=l.nodeValue,l.nodeValue=""):l.nodeValue=l._stashedText||""),c&&c.nodeType===8)if(l=c.data,l==="/$"){if(r===0)break;r--}else l!=="$"&&l!=="$?"&&l!=="$~"&&l!=="$!"||r++;l=c}while(l)}function Th(r){var a=r.firstChild;for(a&&a.nodeType===10&&(a=a.nextSibling);a;){var l=a;switch(a=a.nextSibling,l.nodeName){case"HTML":case"HEAD":case"BODY":Th(l),Id(l);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(l.rel.toLowerCase()==="stylesheet")continue}r.removeChild(l)}}function yw(r,a,l,c){for(;r.nodeType===1;){var v=l;if(r.nodeName.toLowerCase()!==a.toLowerCase()){if(!c&&(r.nodeName!=="INPUT"||r.type!=="hidden"))break}else if(c){if(!r[co])switch(a){case"meta":if(!r.hasAttribute("itemprop"))break;return r;case"link":if(p=r.getAttribute("rel"),p==="stylesheet"&&r.hasAttribute("data-precedence"))break;if(p!==v.rel||r.getAttribute("href")!==(v.href==null||v.href===""?null:v.href)||r.getAttribute("crossorigin")!==(v.crossOrigin==null?null:v.crossOrigin)||r.getAttribute("title")!==(v.title==null?null:v.title))break;return r;case"style":if(r.hasAttribute("data-precedence"))break;return r;case"script":if(p=r.getAttribute("src"),(p!==(v.src==null?null:v.src)||r.getAttribute("type")!==(v.type==null?null:v.type)||r.getAttribute("crossorigin")!==(v.crossOrigin==null?null:v.crossOrigin))&&p&&r.hasAttribute("async")&&!r.hasAttribute("itemprop"))break;return r;default:return r}}else if(a==="input"&&r.type==="hidden"){var p=v.name==null?null:""+v.name;if(v.type==="hidden"&&r.getAttribute("name")===p)return r}else return r;if(r=or(r.nextSibling),r===null)break}return null}function Sw(r,a,l){if(a==="")return null;for(;r.nodeType!==3;)if((r.nodeType!==1||r.nodeName!=="INPUT"||r.type!=="hidden")&&!l||(r=or(r.nextSibling),r===null))return null;return r}function IS(r,a){for(;r.nodeType!==8;)if((r.nodeType!==1||r.nodeName!=="INPUT"||r.type!=="hidden")&&!a||(r=or(r.nextSibling),r===null))return null;return r}function Rh(r){return r.data==="$?"||r.data==="$~"}function wh(r){return r.data==="$!"||r.data==="$?"&&r.ownerDocument.readyState!=="loading"}function bw(r,a){var l=r.ownerDocument;if(r.data==="$~")r._reactRetry=a;else if(r.data!=="$?"||l.readyState!=="loading")a();else{var c=function(){a(),l.removeEventListener("DOMContentLoaded",c)};l.addEventListener("DOMContentLoaded",c),r._reactRetry=c}}function or(r){for(;r!=null;r=r.nextSibling){var a=r.nodeType;if(a===1||a===3)break;if(a===8){if(a=r.data,a==="$"||a==="$!"||a==="$?"||a==="$~"||a==="&"||a==="F!"||a==="F")break;if(a==="/$"||a==="/&")return null}}return r}var Ch=null;function OS(r){r=r.nextSibling;for(var a=0;r;){if(r.nodeType===8){var l=r.data;if(l==="/$"||l==="/&"){if(a===0)return or(r.nextSibling);a--}else l!=="$"&&l!=="$!"&&l!=="$?"&&l!=="$~"&&l!=="&"||a++}r=r.nextSibling}return null}function MS(r){r=r.previousSibling;for(var a=0;r;){if(r.nodeType===8){var l=r.data;if(l==="$"||l==="$!"||l==="$?"||l==="$~"||l==="&"){if(a===0)return r;a--}else l!=="/$"&&l!=="/&"||a++}r=r.previousSibling}return null}function AS(r,a,l){switch(a=ac(l),r){case"html":if(r=a.documentElement,!r)throw Error(n(452));return r;case"head":if(r=a.head,!r)throw Error(n(453));return r;case"body":if(r=a.body,!r)throw Error(n(454));return r;default:throw Error(n(451))}}function Wo(r){for(var a=r.attributes;a.length;)r.removeAttributeNode(a[0]);Id(r)}var lr=new Map,DS=new Set;function sc(r){return typeof r.getRootNode=="function"?r.getRootNode():r.nodeType===9?r:r.ownerDocument}var ri=oe.d;oe.d={f:Ew,r:_w,D:Tw,C:Rw,L:ww,m:Cw,X:Ow,S:Iw,M:Mw};function Ew(){var r=ri.f(),a=Qu();return r||a}function _w(r){var a=Ja(r);a!==null&&a.tag===5&&a.type==="form"?Yg(a):ri.r(r)}var Is=typeof document>"u"?null:document;function kS(r,a,l){var c=Is;if(c&&typeof a=="string"&&a){var v=er(a);v='link[rel="'+r+'"][href="'+v+'"]',typeof l=="string"&&(v+='[crossorigin="'+l+'"]'),DS.has(v)||(DS.add(v),r={rel:r,crossOrigin:l,href:a},c.querySelector(v)===null&&(a=c.createElement("link"),vn(a,"link",r),an(a),c.head.appendChild(a)))}}function Tw(r){ri.D(r),kS("dns-prefetch",r,null)}function Rw(r,a){ri.C(r,a),kS("preconnect",r,a)}function ww(r,a,l){ri.L(r,a,l);var c=Is;if(c&&r&&a){var v='link[rel="preload"][as="'+er(a)+'"]';a==="image"&&l&&l.imageSrcSet?(v+='[imagesrcset="'+er(l.imageSrcSet)+'"]',typeof l.imageSizes=="string"&&(v+='[imagesizes="'+er(l.imageSizes)+'"]')):v+='[href="'+er(r)+'"]';var p=v;switch(a){case"style":p=Os(r);break;case"script":p=Ms(r)}lr.has(p)||(r=g({rel:"preload",href:a==="image"&&l&&l.imageSrcSet?void 0:r,as:a},l),lr.set(p,r),c.querySelector(v)!==null||a==="style"&&c.querySelector(Yo(p))||a==="script"&&c.querySelector(Jo(p))||(a=c.createElement("link"),vn(a,"link",r),an(a),c.head.appendChild(a)))}}function Cw(r,a){ri.m(r,a);var l=Is;if(l&&r){var c=a&&typeof a.as=="string"?a.as:"script",v='link[rel="modulepreload"][as="'+er(c)+'"][href="'+er(r)+'"]',p=v;switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":p=Ms(r)}if(!lr.has(p)&&(r=g({rel:"modulepreload",href:r},a),lr.set(p,r),l.querySelector(v)===null)){switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(l.querySelector(Jo(p)))return}c=l.createElement("link"),vn(c,"link",r),an(c),l.head.appendChild(c)}}}function Iw(r,a,l){ri.S(r,a,l);var c=Is;if(c&&r){var v=Xa(c).hoistableStyles,p=Os(r);a=a||"default";var R=v.get(p);if(!R){var L={loading:0,preload:null};if(R=c.querySelector(Yo(p)))L.loading=5;else{r=g({rel:"stylesheet",href:r,"data-precedence":a},l),(l=lr.get(p))&&Ih(r,l);var K=R=c.createElement("link");an(K),vn(K,"link",r),K._p=new Promise(function(ne,he){K.onload=ne,K.onerror=he}),K.addEventListener("load",function(){L.loading|=1}),K.addEventListener("error",function(){L.loading|=2}),L.loading|=4,oc(R,a,c)}R={type:"stylesheet",instance:R,count:1,state:L},v.set(p,R)}}}function Ow(r,a){ri.X(r,a);var l=Is;if(l&&r){var c=Xa(l).hoistableScripts,v=Ms(r),p=c.get(v);p||(p=l.querySelector(Jo(v)),p||(r=g({src:r,async:!0},a),(a=lr.get(v))&&Oh(r,a),p=l.createElement("script"),an(p),vn(p,"link",r),l.head.appendChild(p)),p={type:"script",instance:p,count:1,state:null},c.set(v,p))}}function Mw(r,a){ri.M(r,a);var l=Is;if(l&&r){var c=Xa(l).hoistableScripts,v=Ms(r),p=c.get(v);p||(p=l.querySelector(Jo(v)),p||(r=g({src:r,async:!0,type:"module"},a),(a=lr.get(v))&&Oh(r,a),p=l.createElement("script"),an(p),vn(p,"link",r),l.head.appendChild(p)),p={type:"script",instance:p,count:1,state:null},c.set(v,p))}}function US(r,a,l,c){var v=(v=B.current)?sc(v):null;if(!v)throw Error(n(446));switch(r){case"meta":case"title":return null;case"style":return typeof l.precedence=="string"&&typeof l.href=="string"?(a=Os(l.href),l=Xa(v).hoistableStyles,c=l.get(a),c||(c={type:"style",instance:null,count:0,state:null},l.set(a,c)),c):{type:"void",instance:null,count:0,state:null};case"link":if(l.rel==="stylesheet"&&typeof l.href=="string"&&typeof l.precedence=="string"){r=Os(l.href);var p=Xa(v).hoistableStyles,R=p.get(r);if(R||(v=v.ownerDocument||v,R={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},p.set(r,R),(p=v.querySelector(Yo(r)))&&!p._p&&(R.instance=p,R.state.loading=5),lr.has(r)||(l={rel:"preload",as:"style",href:l.href,crossOrigin:l.crossOrigin,integrity:l.integrity,media:l.media,hrefLang:l.hrefLang,referrerPolicy:l.referrerPolicy},lr.set(r,l),p||Aw(v,r,l,R.state))),a&&c===null)throw Error(n(528,""));return R}if(a&&c!==null)throw Error(n(529,""));return null;case"script":return a=l.async,l=l.src,typeof l=="string"&&a&&typeof a!="function"&&typeof a!="symbol"?(a=Ms(l),l=Xa(v).hoistableScripts,c=l.get(a),c||(c={type:"script",instance:null,count:0,state:null},l.set(a,c)),c):{type:"void",instance:null,count:0,state:null};default:throw Error(n(444,r))}}function Os(r){return'href="'+er(r)+'"'}function Yo(r){return'link[rel="stylesheet"]['+r+"]"}function PS(r){return g({},r,{"data-precedence":r.precedence,precedence:null})}function Aw(r,a,l,c){r.querySelector('link[rel="preload"][as="style"]['+a+"]")?c.loading=1:(a=r.createElement("link"),c.preload=a,a.addEventListener("load",function(){return c.loading|=1}),a.addEventListener("error",function(){return c.loading|=2}),vn(a,"link",l),an(a),r.head.appendChild(a))}function Ms(r){return'[src="'+er(r)+'"]'}function Jo(r){return"script[async]"+r}function NS(r,a,l){if(a.count++,a.instance===null)switch(a.type){case"style":var c=r.querySelector('style[data-href~="'+er(l.href)+'"]');if(c)return a.instance=c,an(c),c;var v=g({},l,{"data-href":l.href,"data-precedence":l.precedence,href:null,precedence:null});return c=(r.ownerDocument||r).createElement("style"),an(c),vn(c,"style",v),oc(c,l.precedence,r),a.instance=c;case"stylesheet":v=Os(l.href);var p=r.querySelector(Yo(v));if(p)return a.state.loading|=4,a.instance=p,an(p),p;c=PS(l),(v=lr.get(v))&&Ih(c,v),p=(r.ownerDocument||r).createElement("link"),an(p);var R=p;return R._p=new Promise(function(L,K){R.onload=L,R.onerror=K}),vn(p,"link",c),a.state.loading|=4,oc(p,l.precedence,r),a.instance=p;case"script":return p=Ms(l.src),(v=r.querySelector(Jo(p)))?(a.instance=v,an(v),v):(c=l,(v=lr.get(p))&&(c=g({},l),Oh(c,v)),r=r.ownerDocument||r,v=r.createElement("script"),an(v),vn(v,"link",c),r.head.appendChild(v),a.instance=v);case"void":return null;default:throw Error(n(443,a.type))}else a.type==="stylesheet"&&(a.state.loading&4)===0&&(c=a.instance,a.state.loading|=4,oc(c,l.precedence,r));return a.instance}function oc(r,a,l){for(var c=l.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),v=c.length?c[c.length-1]:null,p=v,R=0;R<c.length;R++){var L=c[R];if(L.dataset.precedence===a)p=L;else if(p!==v)break}p?p.parentNode.insertBefore(r,p.nextSibling):(a=l.nodeType===9?l.head:l,a.insertBefore(r,a.firstChild))}function Ih(r,a){r.crossOrigin==null&&(r.crossOrigin=a.crossOrigin),r.referrerPolicy==null&&(r.referrerPolicy=a.referrerPolicy),r.title==null&&(r.title=a.title)}function Oh(r,a){r.crossOrigin==null&&(r.crossOrigin=a.crossOrigin),r.referrerPolicy==null&&(r.referrerPolicy=a.referrerPolicy),r.integrity==null&&(r.integrity=a.integrity)}var lc=null;function LS(r,a,l){if(lc===null){var c=new Map,v=lc=new Map;v.set(l,c)}else v=lc,c=v.get(l),c||(c=new Map,v.set(l,c));if(c.has(r))return c;for(c.set(r,null),l=l.getElementsByTagName(r),v=0;v<l.length;v++){var p=l[v];if(!(p[co]||p[cn]||r==="link"&&p.getAttribute("rel")==="stylesheet")&&p.namespaceURI!=="http://www.w3.org/2000/svg"){var R=p.getAttribute(a)||"";R=r+R;var L=c.get(R);L?L.push(p):c.set(R,[p])}}return c}function xS(r,a,l){r=r.ownerDocument||r,r.head.insertBefore(l,a==="title"?r.querySelector("head > title"):null)}function Dw(r,a,l){if(l===1||a.itemProp!=null)return!1;switch(r){case"meta":case"title":return!0;case"style":if(typeof a.precedence!="string"||typeof a.href!="string"||a.href==="")break;return!0;case"link":if(typeof a.rel!="string"||typeof a.href!="string"||a.href===""||a.onLoad||a.onError)break;return a.rel==="stylesheet"?(r=a.disabled,typeof a.precedence=="string"&&r==null):!0;case"script":if(a.async&&typeof a.async!="function"&&typeof a.async!="symbol"&&!a.onLoad&&!a.onError&&a.src&&typeof a.src=="string")return!0}return!1}function jS(r){return!(r.type==="stylesheet"&&(r.state.loading&3)===0)}function kw(r,a,l,c){if(l.type==="stylesheet"&&(typeof c.media!="string"||matchMedia(c.media).matches!==!1)&&(l.state.loading&4)===0){if(l.instance===null){var v=Os(c.href),p=a.querySelector(Yo(v));if(p){a=p._p,a!==null&&typeof a=="object"&&typeof a.then=="function"&&(r.count++,r=uc.bind(r),a.then(r,r)),l.state.loading|=4,l.instance=p,an(p);return}p=a.ownerDocument||a,c=PS(c),(v=lr.get(v))&&Ih(c,v),p=p.createElement("link"),an(p);var R=p;R._p=new Promise(function(L,K){R.onload=L,R.onerror=K}),vn(p,"link",c),l.instance=p}r.stylesheets===null&&(r.stylesheets=new Map),r.stylesheets.set(l,a),(a=l.state.preload)&&(l.state.loading&3)===0&&(r.count++,l=uc.bind(r),a.addEventListener("load",l),a.addEventListener("error",l))}}var Mh=0;function Uw(r,a){return r.stylesheets&&r.count===0&&dc(r,r.stylesheets),0<r.count||0<r.imgCount?function(l){var c=setTimeout(function(){if(r.stylesheets&&dc(r,r.stylesheets),r.unsuspend){var p=r.unsuspend;r.unsuspend=null,p()}},6e4+a);0<r.imgBytes&&Mh===0&&(Mh=62500*hw());var v=setTimeout(function(){if(r.waitingForImages=!1,r.count===0&&(r.stylesheets&&dc(r,r.stylesheets),r.unsuspend)){var p=r.unsuspend;r.unsuspend=null,p()}},(r.imgBytes>Mh?50:800)+a);return r.unsuspend=l,function(){r.unsuspend=null,clearTimeout(c),clearTimeout(v)}}:null}function uc(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)dc(this,this.stylesheets);else if(this.unsuspend){var r=this.unsuspend;this.unsuspend=null,r()}}}var cc=null;function dc(r,a){r.stylesheets=null,r.unsuspend!==null&&(r.count++,cc=new Map,a.forEach(Pw,r),cc=null,uc.call(r))}function Pw(r,a){if(!(a.state.loading&4)){var l=cc.get(r);if(l)var c=l.get(null);else{l=new Map,cc.set(r,l);for(var v=r.querySelectorAll("link[data-precedence],style[data-precedence]"),p=0;p<v.length;p++){var R=v[p];(R.nodeName==="LINK"||R.getAttribute("media")!=="not all")&&(l.set(R.dataset.precedence,R),c=R)}c&&l.set(null,c)}v=a.instance,R=v.getAttribute("data-precedence"),p=l.get(R)||c,p===c&&l.set(null,v),l.set(R,v),this.count++,c=uc.bind(this),v.addEventListener("load",c),v.addEventListener("error",c),p?p.parentNode.insertBefore(v,p.nextSibling):(r=r.nodeType===9?r.head:r,r.insertBefore(v,r.firstChild)),a.state.loading|=4}}var Xo={$$typeof:U,Provider:null,Consumer:null,_currentValue:pe,_currentValue2:pe,_threadCount:0};function Nw(r,a,l,c,v,p,R,L,K){this.tag=1,this.containerInfo=r,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Td(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Td(0),this.hiddenUpdates=Td(null),this.identifierPrefix=c,this.onUncaughtError=v,this.onCaughtError=p,this.onRecoverableError=R,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=K,this.incompleteTransitions=new Map}function BS(r,a,l,c,v,p,R,L,K,ne,he,ge){return r=new Nw(r,a,l,R,K,ne,he,ge,L),a=1,p===!0&&(a|=24),p=jn(3,null,null,a),r.current=p,p.stateNode=r,a=lf(),a.refCount++,r.pooledCache=a,a.refCount++,p.memoizedState={element:c,isDehydrated:l,cache:a},ff(p),r}function FS(r){return r?(r=ss,r):ss}function qS(r,a,l,c,v,p){v=FS(v),c.context===null?c.context=v:c.pendingContext=v,c=Ci(a),c.payload={element:l},p=p===void 0?null:p,p!==null&&(c.callback=p),l=Ii(r,c,a),l!==null&&(Dn(l,r,a),Oo(l,r,a))}function KS(r,a){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var l=r.retryLane;r.retryLane=l!==0&&l<a?l:a}}function Ah(r,a){KS(r,a),(r=r.alternate)&&KS(r,a)}function HS(r){if(r.tag===13||r.tag===31){var a=la(r,67108864);a!==null&&Dn(a,r,67108864),Ah(r,67108864)}}function VS(r){if(r.tag===13||r.tag===31){var a=Hn();a=Rd(a);var l=la(r,a);l!==null&&Dn(l,r,a),Ah(r,a)}}var fc=!0;function Lw(r,a,l,c){var v=J.T;J.T=null;var p=oe.p;try{oe.p=2,Dh(r,a,l,c)}finally{oe.p=p,J.T=v}}function xw(r,a,l,c){var v=J.T;J.T=null;var p=oe.p;try{oe.p=8,Dh(r,a,l,c)}finally{oe.p=p,J.T=v}}function Dh(r,a,l,c){if(fc){var v=kh(c);if(v===null)gh(r,a,c,hc,l),zS(r,c);else if(Bw(v,r,a,l,c))c.stopPropagation();else if(zS(r,c),a&4&&-1<jw.indexOf(r)){for(;v!==null;){var p=Ja(v);if(p!==null)switch(p.tag){case 3:if(p=p.stateNode,p.current.memoizedState.isDehydrated){var R=Bt(p.pendingLanes);if(R!==0){var L=p;for(L.pendingLanes|=2,L.entangledLanes|=2;R;){var K=1<<31-de(R);L.entanglements[1]|=K,R&=~K}Ar(p),(vt&6)===0&&(Ju=ze()+500,Vo(0))}}break;case 31:case 13:L=la(p,2),L!==null&&Dn(L,p,2),Qu(),Ah(p,2)}if(p=kh(c),p===null&&gh(r,a,c,hc,l),p===v)break;v=p}v!==null&&c.stopPropagation()}else gh(r,a,c,null,l)}}function kh(r){return r=Ud(r),Uh(r)}var hc=null;function Uh(r){if(hc=null,r=Ya(r),r!==null){var a=o(r);if(a===null)r=null;else{var l=a.tag;if(l===13){if(r=u(a),r!==null)return r;r=null}else if(l===31){if(r=d(a),r!==null)return r;r=null}else if(l===3){if(a.stateNode.current.memoizedState.isDehydrated)return a.tag===3?a.stateNode.containerInfo:null;r=null}else a!==r&&(r=null)}}return hc=r,null}function GS(r){switch(r){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(gi()){case wr:return 2;case za:return 8;case vr:case ra:return 32;case Cr:return 268435456;default:return 32}default:return 32}}var Ph=!1,ji=null,Bi=null,Fi=null,Qo=new Map,Zo=new Map,qi=[],jw="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function zS(r,a){switch(r){case"focusin":case"focusout":ji=null;break;case"dragenter":case"dragleave":Bi=null;break;case"mouseover":case"mouseout":Fi=null;break;case"pointerover":case"pointerout":Qo.delete(a.pointerId);break;case"gotpointercapture":case"lostpointercapture":Zo.delete(a.pointerId)}}function $o(r,a,l,c,v,p){return r===null||r.nativeEvent!==p?(r={blockedOn:a,domEventName:l,eventSystemFlags:c,nativeEvent:p,targetContainers:[v]},a!==null&&(a=Ja(a),a!==null&&HS(a)),r):(r.eventSystemFlags|=c,a=r.targetContainers,v!==null&&a.indexOf(v)===-1&&a.push(v),r)}function Bw(r,a,l,c,v){switch(a){case"focusin":return ji=$o(ji,r,a,l,c,v),!0;case"dragenter":return Bi=$o(Bi,r,a,l,c,v),!0;case"mouseover":return Fi=$o(Fi,r,a,l,c,v),!0;case"pointerover":var p=v.pointerId;return Qo.set(p,$o(Qo.get(p)||null,r,a,l,c,v)),!0;case"gotpointercapture":return p=v.pointerId,Zo.set(p,$o(Zo.get(p)||null,r,a,l,c,v)),!0}return!1}function WS(r){var a=Ya(r.target);if(a!==null){var l=o(a);if(l!==null){if(a=l.tag,a===13){if(a=u(l),a!==null){r.blockedOn=a,op(r.priority,function(){VS(l)});return}}else if(a===31){if(a=d(l),a!==null){r.blockedOn=a,op(r.priority,function(){VS(l)});return}}else if(a===3&&l.stateNode.current.memoizedState.isDehydrated){r.blockedOn=l.tag===3?l.stateNode.containerInfo:null;return}}}r.blockedOn=null}function vc(r){if(r.blockedOn!==null)return!1;for(var a=r.targetContainers;0<a.length;){var l=kh(r.nativeEvent);if(l===null){l=r.nativeEvent;var c=new l.constructor(l.type,l);kd=c,l.target.dispatchEvent(c),kd=null}else return a=Ja(l),a!==null&&HS(a),r.blockedOn=l,!1;a.shift()}return!0}function YS(r,a,l){vc(r)&&l.delete(a)}function Fw(){Ph=!1,ji!==null&&vc(ji)&&(ji=null),Bi!==null&&vc(Bi)&&(Bi=null),Fi!==null&&vc(Fi)&&(Fi=null),Qo.forEach(YS),Zo.forEach(YS)}function mc(r,a){r.blockedOn===a&&(r.blockedOn=null,Ph||(Ph=!0,s.unstable_scheduleCallback(s.unstable_NormalPriority,Fw)))}var pc=null;function JS(r){pc!==r&&(pc=r,s.unstable_scheduleCallback(s.unstable_NormalPriority,function(){pc===r&&(pc=null);for(var a=0;a<r.length;a+=3){var l=r[a],c=r[a+1],v=r[a+2];if(typeof c!="function"){if(Uh(c||l)===null)continue;break}var p=Ja(l);p!==null&&(r.splice(a,3),a-=3,kf(p,{pending:!0,data:v,method:l.method,action:c},c,v))}}))}function As(r){function a(K){return mc(K,r)}ji!==null&&mc(ji,r),Bi!==null&&mc(Bi,r),Fi!==null&&mc(Fi,r),Qo.forEach(a),Zo.forEach(a);for(var l=0;l<qi.length;l++){var c=qi[l];c.blockedOn===r&&(c.blockedOn=null)}for(;0<qi.length&&(l=qi[0],l.blockedOn===null);)WS(l),l.blockedOn===null&&qi.shift();if(l=(r.ownerDocument||r).$$reactFormReplay,l!=null)for(c=0;c<l.length;c+=3){var v=l[c],p=l[c+1],R=v[wn]||null;if(typeof p=="function")R||JS(l);else if(R){var L=null;if(p&&p.hasAttribute("formAction")){if(v=p,R=p[wn]||null)L=R.formAction;else if(Uh(v)!==null)continue}else L=R.action;typeof L=="function"?l[c+1]=L:(l.splice(c,3),c-=3),JS(l)}}}function XS(){function r(p){p.canIntercept&&p.info==="react-transition"&&p.intercept({handler:function(){return new Promise(function(R){return v=R})},focusReset:"manual",scroll:"manual"})}function a(){v!==null&&(v(),v=null),c||setTimeout(l,20)}function l(){if(!c&&!navigation.transition){var p=navigation.currentEntry;p&&p.url!=null&&navigation.navigate(p.url,{state:p.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var c=!1,v=null;return navigation.addEventListener("navigate",r),navigation.addEventListener("navigatesuccess",a),navigation.addEventListener("navigateerror",a),setTimeout(l,100),function(){c=!0,navigation.removeEventListener("navigate",r),navigation.removeEventListener("navigatesuccess",a),navigation.removeEventListener("navigateerror",a),v!==null&&(v(),v=null)}}}function Nh(r){this._internalRoot=r}gc.prototype.render=Nh.prototype.render=function(r){var a=this._internalRoot;if(a===null)throw Error(n(409));var l=a.current,c=Hn();qS(l,c,r,a,null,null)},gc.prototype.unmount=Nh.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var a=r.containerInfo;qS(r.current,2,null,r,null,null),Qu(),a[Wa]=null}};function gc(r){this._internalRoot=r}gc.prototype.unstable_scheduleHydration=function(r){if(r){var a=sp();r={blockedOn:null,target:r,priority:a};for(var l=0;l<qi.length&&a!==0&&a<qi[l].priority;l++);qi.splice(l,0,r),l===0&&WS(r)}};var QS=e.version;if(QS!=="19.2.3")throw Error(n(527,QS,"19.2.3"));oe.findDOMNode=function(r){var a=r._reactInternals;if(a===void 0)throw typeof r.render=="function"?Error(n(188)):(r=Object.keys(r).join(","),Error(n(268,r)));return r=f(a),r=r!==null?m(r):null,r=r===null?null:r.stateNode,r};var qw={bundleType:0,version:"19.2.3",rendererPackageName:"react-dom",currentDispatcherRef:J,reconcilerVersion:"19.2.3"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var yc=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!yc.isDisabled&&yc.supportsFiber)try{be=yc.inject(qw),ee=yc}catch{}}return tl.createRoot=function(r,a){if(!i(r))throw Error(n(299));var l=!1,c="",v=iy,p=ay,R=sy;return a!=null&&(a.unstable_strictMode===!0&&(l=!0),a.identifierPrefix!==void 0&&(c=a.identifierPrefix),a.onUncaughtError!==void 0&&(v=a.onUncaughtError),a.onCaughtError!==void 0&&(p=a.onCaughtError),a.onRecoverableError!==void 0&&(R=a.onRecoverableError)),a=BS(r,1,!1,null,null,l,c,null,v,p,R,XS),r[Wa]=a.current,ph(r),new Nh(a)},tl.hydrateRoot=function(r,a,l){if(!i(r))throw Error(n(299));var c=!1,v="",p=iy,R=ay,L=sy,K=null;return l!=null&&(l.unstable_strictMode===!0&&(c=!0),l.identifierPrefix!==void 0&&(v=l.identifierPrefix),l.onUncaughtError!==void 0&&(p=l.onUncaughtError),l.onCaughtError!==void 0&&(R=l.onCaughtError),l.onRecoverableError!==void 0&&(L=l.onRecoverableError),l.formState!==void 0&&(K=l.formState)),a=BS(r,1,!0,a,l??null,c,v,K,p,R,L,XS),a.context=FS(null),l=a.current,c=Hn(),c=Rd(c),v=Ci(c),v.callback=null,Ii(l,v,c),l=c,a.current.lanes=l,uo(a,l),Ar(a),r[Wa]=a.current,ph(r),new gc(a)},tl.version="19.2.3",tl}var ob;function Qw(){if(ob)return jh.exports;ob=1;function s(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(s)}catch(e){console.error(e)}}return s(),jh.exports=Xw(),jh.exports}var Zw=Qw();function lb(s,e,t,n,i,o,u){try{var d=s[o](u),h=d.value}catch(f){return void t(f)}d.done?e(h):Promise.resolve(h).then(n,i)}function D(s){return function(){var e=this,t=arguments;return new Promise(function(n,i){var o=s.apply(e,t);function u(h){lb(o,n,i,u,d,"next",h)}function d(h){lb(o,n,i,u,d,"throw",h)}u(void 0)})}}function ql(s){"@babel/helpers - typeof";return ql=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ql(s)}function $w(s,e){if(ql(s)!="object"||!s)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var n=t.call(s,e);if(ql(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(s)}function eC(s){var e=$w(s,"string");return ql(e)=="symbol"?e:e+""}function y(s,e,t){return(e=eC(e))in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}const tC="l",nC="rn",rC={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:tC,:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:nC,"":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""};var Kh,ub;function iC(){if(ub)return Kh;ub=1;var s=rC;function e(o){return o.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var t=RegExp(Object.keys(s).map(e).join("|"),"g");function n(o){return s[o]}function i(o){return o.replace(t,n)}return Kh=i,Kh}var aC=iC();const sC=k_(aC),oC=Object.prototype.toString,lC=s=>oC.call(s)==="[object Error]",uC=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function cC(s){if(!(s&&lC(s)&&s.name==="TypeError"&&typeof s.message=="string"))return!1;const{message:t,stack:n}=s;return t==="Load failed"?n===void 0||"__sentry_captured__"in s:t.startsWith("error sending request for url")?!0:uC.has(t)}function dC(s){if(typeof s=="number"){if(s<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(s))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(s!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Sc(s,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${s}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${s}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${s}\` to be  ${t}.`)}}class U_ extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function fC(s,e){const t=Math.max(1,s+1),n=e.randomize?Math.random()+1:1;let i=Math.round(n*e.minTimeout*e.factor**(t-1));return i=Math.min(i,e.maxTimeout),i}function cb(s,e){return Number.isFinite(e)?e-(performance.now()-s):e}async function hC({error:s,attemptNumber:e,retriesConsumed:t,startTime:n,options:i}){const o=s instanceof Error?s:new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`);if(o instanceof U_)throw o.originalError;const u=Number.isFinite(i.retries)?Math.max(0,i.retries-t):i.retries,d=i.maxRetryTime??Number.POSITIVE_INFINITY,h=Object.freeze({error:o,attemptNumber:e,retriesLeft:u,retriesConsumed:t});if(await i.onFailedAttempt(h),cb(n,d)<=0)throw o;const f=await i.shouldConsumeRetry(h),m=cb(n,d);if(m<=0||u<=0)throw o;if(o instanceof TypeError&&!cC(o)){if(f)throw o;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(h))throw o;if(!f)return i.signal?.throwIfAborted(),!1;const g=fC(t,i),S=Math.min(g,m);return i.signal?.throwIfAborted(),S>0&&await new Promise((_,b)=>{const T=()=>{clearTimeout(k),i.signal?.removeEventListener("abort",T),b(i.signal.reason)},k=setTimeout(()=>{i.signal?.removeEventListener("abort",T),_()},S);i.unref&&k.unref?.(),i.signal?.addEventListener("abort",T,{once:!0})}),i.signal?.throwIfAborted(),!0}async function vC(s,e={}){if(e={...e},dC(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,Sc("factor",e.factor,{min:0,allowInfinity:!1}),Sc("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Sc("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Sc("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0;const i=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();const o=await s(t);return e.signal?.throwIfAborted(),o}catch(o){await hC({error:o,attemptNumber:t,retriesConsumed:n,startTime:i,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}let io=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e?.[this.name]),!t&&this.altName&&(t=e?.[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class od extends io{constructor(){super(...arguments),y(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class Yt extends io{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var Js=(function(s){return s.Self="m.self",s.Pin="m.pin",s})({}),eu=new Yt("m.asset","org.matrix.msc3488.asset"),na=new Yt("m.ts","org.matrix.msc3488.ts"),tu=new Yt("m.location","org.matrix.msc3488.location"),Tn=(function(s){return s.Read="m.read",s.FullyRead="m.fully_read",s.ReadPrivate="m.read.private",s})({}),nu="main";function db(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function fb(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?db(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):db(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var Hh=new Map;function Vh(s){return s instanceof String&&(s=s.toString()),Hh.has(s)||Hh.set(s,s),Hh.get(s)}function mv(s,e){var t=e??new URLSearchParams,n=function(d){o!=null&&(Array.isArray(o)?o.forEach(h=>{t.append(d,String(h))}):t.append(d,String(o)))};for(var[i,o]of Object.entries(s))n(i);return t}function hb(s,e,t){var n=fb(fb({},t),{},{[e]:t[s]});return delete n[s],n}function Ce(s,e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n!=null&&(s=s.replace(t,encodeURIComponent(n)))}return s}function Yc(s,e,t){var n;if(t){for(n=s.length-1;n>=0;n--)if(e(s[n],n,s))return s.splice(n,1),!0}else for(n=0;n<s.length;n++)if(e(s[n],n,s))return s.splice(n,1),!0;return!1}function P_(s,e){for(var t of e)if(!s.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function ru(s){return JSON.parse(JSON.stringify(s))}function qa(s,e){if(s===e)return!0;if(typeof s!=typeof e)return!1;if(typeof s=="number"&&isNaN(s)&&isNaN(e))return!0;if(s===null||e===null)return s===e;if(s.constructor.name!=="Object"&&s.constructor.name!=="RegExp"&&s.constructor.name!=="Date"&&s.constructor.name!=="Array"||s.prototype!==e.prototype)return!1;if(s instanceof RegExp||s instanceof Date)return s.toString()===e.toString();if(Array.isArray(s)){if(s.length!==e.length)return!1;for(var t=0;t<s.length;t++)if(!qa(s[t],e[t]))return!1}else{for(var n in e)if(e.hasOwnProperty(n)!==s.hasOwnProperty(n))return!1;for(var i in s)if(e.hasOwnProperty(i)!==s.hasOwnProperty(i)||!qa(s[i],e[i]))return!1}return!0}function pv(s){if(typeof s!="object"||s==null||Array.isArray(s))return s;var e=[];for(var[t,n]of Object.entries(s))e.push([t,pv(n)]);return e.sort((i,o)=>jc(i[0],o[0])),e}function vb(s){return typeof s=="number"&&isFinite(s)}function ja(s){return typeof s=="string"?sC(s.normalize("NFD").replace(pC,"")):""}function gv(s){return typeof s=="string"?s.replace(/[\u202d-\u202e]/g,""):""}function mC(s){return ja(s.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var pC=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function N_(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function L_(s){return N_(s).replace(/\\\*/g,".*").replace(/\?/g,".")}function Gh(s){return s!=null&&s.endsWith("/")?s.slice(0,-1):s}function iu(s,e){return new Promise(t=>{setTimeout(t,s,e)})}function sD(s,e,t){return yv.apply(this,arguments)}function yv(){return yv=D(function*(s,e,t){var n=Date.now();try{return yield t()}finally{var i=Date.now();s.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}),yv.apply(this,arguments)}function gC(s,e,t){var n=Date.now();try{return t()}finally{var i=Date.now();s.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}function x_(s){return s==null}function Fs(s,e){return Sv.apply(this,arguments)}function Sv(){return Sv=D(function*(s,e){for(var t of s)yield e(yield t)}),Sv.apply(this,arguments)}function Ds(s){return Promise.resolve(s())}function yC(s,e){return vC(t=>s(t),{retries:1/0,shouldRetry:e?t=>{var{error:n}=t;return e(n)}:void 0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var ta=(()=>{for(var s="",e=32;e<=126;e++)s+=String.fromCharCode(e);return s})();function mb(s,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ta;return s.padEnd(e,t[0])}function Kl(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ta,t=BigInt(e.length);if(s<=t){var n;return(n=e[Number(s)-1])!==null&&n!==void 0?n:""}var i=s/t,o=Number(s%t)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(t)-1),Kl(i,e)+e[o]}function Jc(s){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ta,t=BigInt(e.length),n=BigInt(0),i=s.length-1,o=BigInt(0);i>=0;i--,o++){var u=s.charCodeAt(i)-e.charCodeAt(0);n+=BigInt(1+u)*t**o}return n}function SC(s,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ta,n=Math.max(s.length,e.length),i=Jc(mb(s,n,t),t),o=Jc(mb(e,n,t),t),u=(i+o)/BigInt(2);return u===i||u==o?Kl(u,t)+t[0]:Kl(u,t)}function nl(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ta;return Kl(Jc(s,e)+BigInt(1),e)}function pb(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ta;return Kl(Jc(s,e)-BigInt(1),e)}function jc(s,e){return s<e?-1:s>e?1:0}function j_(s,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[n,i]of Object.entries(e)){if(s[n]instanceof Object&&i){j_(s[n],i);continue}if(i!=null||!t){Xc(s,n,i);continue}}return s}function gb(s){var e;return(e=na.findIn(s.getContent()))!==null&&e!==void 0?e:-1}function bC(s,e){return gb(e)-gb(s)}function hm(s){return[Tn.Read,Tn.ReadPrivate].includes(s)}function yb(s,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(u,d)=>u===d;if(s.size!==e.size)return!1;for(var[n,i]of s){var o=e.get(n);if(o===void 0||!t(i,o))return!1}return!0}function B_(s){return s instanceof Map?Na(s):Array.isArray(s)?s.map(e=>B_(e)):s}function Na(s){var e=new Map;for(var[t,n]of s)e.set(t,B_(n));return Object.fromEntries(e.entries())}function Ul(s){return s==="__proto__"||s==="prototype"||s==="constructor"}function Xc(s,e,t){if(Ul(e))throw new Error("Trying to modify prototype or constructor");s[e]=t}function Tr(s){return!(Ul(s.room_id)||Ul(s.sender)||Ul(s.event_id))}class mi extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var bv="migrationState",Xs=(function(s){return s[s.NOT_STARTED=0]="NOT_STARTED",s[s.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",s[s.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",s[s.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",s[s.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",s[s.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",s})({}),Qs=50;function Sb(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function bb(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Sb(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Sb(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function bc(s,e){return encodeURIComponent(s)+"/"+encodeURIComponent(e)}function EC(s){var e=s.split("/"),t=decodeURIComponent(e[0]),n=decodeURIComponent(e[1]);return{senderKey:t,sessionId:n}}class ld{constructor(){y(this,"migrationState",Xs.NOT_STARTED),y(this,"account",null),y(this,"crossSigningKeys",null),y(this,"privateKeys",{}),y(this,"sessions",{}),y(this,"inboundGroupSessions",{}),y(this,"inboundGroupSessionsWithheld",{}),y(this,"rooms",{}),y(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return D(function*(){return e.account!==null})()}startup(){var e=this;return D(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return D(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return D(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){var i=this.privateKeys[n];t(i||null)}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){var n=0;for(var i of Object.values(this.sessions))n+=Object.keys(i).length;t(n)}getEndToEndSession(e,t,n,i){var o=this.sessions[e]||{};i(o[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}storeEndToEndSession(e,t,n,i){var o=this.sessions[e];o===void 0&&(o={},this.sessions[e]=o),Xc(o,t,n)}getEndToEndSessionsBatch(){var e=this;return D(function*(){var t=[];for(var n of Object.values(e.sessions))for(var i of Object.values(n))if(t.push(i),t.length>=Qs)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return D(function*(){for(var{deviceKey:n,sessionId:i}of e){var o=t.sessions[n]||{};delete o[i],Object.keys(o).length===0&&delete t.sessions[n]}})()}getEndToEndInboundGroupSession(e,t,n,i){var o=bc(e,t);i(this.inboundGroupSessions[o]||null,this.inboundGroupSessionsWithheld[o]||null)}storeEndToEndInboundGroupSession(e,t,n,i){var o=bc(e,t);this.inboundGroupSessions[o]=n}countEndToEndInboundGroupSessions(){var e=this;return D(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return D(function*(){var t=[];for(var[n,i]of Object.entries(e.inboundGroupSessions))if(t.push(bb(bb({},EC(n)),{},{sessionData:i,needsBackup:n in e.sessionsNeedingBackup})),t.length>=Qs)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return D(function*(){for(var{senderKey:n,sessionId:i}of e){var o=bc(n,i);delete t.inboundGroupSessions[o]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var n=bc(t.senderKey,t.sessionId);this.sessionsNeedingBackup[n]=!0}return Promise.resolve()}doTxn(e,t,n){return Promise.resolve(n(null))}}var _C=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function TC(s){var e=_C.exec(s);return e?.[0]===s}var RC=/^[\w-]+$/;function wC(s){var e=RC.exec(s);return e?.[0]===s}function ud(s,e,t,n,i){var o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,u=arguments.length>6?arguments[6]:void 0,d=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return o?e:"";var[h,f,...m]=e.slice(6).split("/");if(m.length>0||!TC(h)||!wC(f))return"";d&&(u=!0);var g,S=!!t||!!n||!!i,_=S?"thumbnail":"download";d?g="/_matrix/client/v1/media/".concat(_):g="/_matrix/media/v3/".concat(_);var b=new URL("".concat(g,"/").concat(h,"/").concat(f),s);return t&&b.searchParams.set("width",Math.round(t).toString()),n&&b.searchParams.set("height",Math.round(n).toString()),i&&b.searchParams.set("method",i),typeof u=="boolean"&&b.searchParams.set("allow_redirect",JSON.stringify(u)),b.href}var Bc={exports:{}},CC=Bc.exports,Eb;function IC(){return Eb||(Eb=1,(function(s){(function(e,t){s.exports?s.exports=t():e.log=t()})(CC,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],o={},u=null;function d(T,k){var A=T[k];if(typeof A.bind=="function")return A.bind(T);try{return Function.prototype.bind.call(A,T)}catch{return function(){return Function.prototype.apply.apply(A,[T,arguments])}}}function h(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function f(T){return T==="debug"&&(T="log"),typeof console===t?!1:T==="trace"&&n?h:console[T]!==void 0?d(console,T):console.log!==void 0?d(console,"log"):e}function m(){for(var T=this.getLevel(),k=0;k<i.length;k++){var A=i[k];this[A]=k<T?e:this.methodFactory(A,T,this.name)}if(this.log=this.debug,typeof console===t&&T<this.levels.SILENT)return"No console available for logging"}function g(T){return function(){typeof console!==t&&(m.call(this),this[T].apply(this,arguments))}}function S(T,k,A){return f(T)||g.apply(this,arguments)}function _(T,k){var A=this,C,U,O,M="loglevel";typeof T=="string"?M+=":"+T:typeof T=="symbol"&&(M=void 0);function E(ue){var Se=(i[ue]||"silent").toUpperCase();if(!(typeof window===t||!M)){try{window.localStorage[M]=Se;return}catch{}try{window.document.cookie=encodeURIComponent(M)+"="+Se+";"}catch{}}}function I(){var ue;if(!(typeof window===t||!M)){try{ue=window.localStorage[M]}catch{}if(typeof ue===t)try{var Se=window.document.cookie,Ie=encodeURIComponent(M),Ze=Se.indexOf(Ie+"=");Ze!==-1&&(ue=/^([^;]+)/.exec(Se.slice(Ze+Ie.length+1))[1])}catch{}return A.levels[ue]===void 0&&(ue=void 0),ue}}function w(){if(!(typeof window===t||!M)){try{window.localStorage.removeItem(M)}catch{}try{window.document.cookie=encodeURIComponent(M)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function q(ue){var Se=ue;if(typeof Se=="string"&&A.levels[Se.toUpperCase()]!==void 0&&(Se=A.levels[Se.toUpperCase()]),typeof Se=="number"&&Se>=0&&Se<=A.levels.SILENT)return Se;throw new TypeError("log.setLevel() called with invalid level: "+ue)}A.name=T,A.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},A.methodFactory=k||S,A.getLevel=function(){return O??U??C},A.setLevel=function(ue,Se){return O=q(ue),Se!==!1&&E(O),m.call(A)},A.setDefaultLevel=function(ue){U=q(ue),I()||A.setLevel(ue,!1)},A.resetLevel=function(){O=null,w(),m.call(A)},A.enableAll=function(ue){A.setLevel(A.levels.TRACE,ue)},A.disableAll=function(ue){A.setLevel(A.levels.SILENT,ue)},A.rebuild=function(){if(u!==A&&(C=q(u.getLevel())),m.call(A),u===A)for(var ue in o)o[ue].rebuild()},C=q(u?u.getLevel():"WARN");var z=I();z!=null&&(O=q(z)),m.call(A)}u=new _,u.getLogger=function(k){if(typeof k!="symbol"&&typeof k!="string"||k==="")throw new TypeError("You must supply a name when creating a logger.");var A=o[k];return A||(A=o[k]=new _(k,u.methodFactory)),A};var b=typeof window!==t?window.log:void 0;return u.noConflict=function(){return typeof window!==t&&window.log===u&&(window.log=b),u},u.getLoggers=function(){return o},u.default=u,u})})(Bc)),Bc.exports}var OC=IC();const Ev=k_(OC);var MC="matrix";Ev.methodFactory=function(s,e,t){return function(){for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];this.prefix&&i.unshift(this.prefix);var u=s==="error"||s==="warn"||s==="trace"||s==="info"||s==="debug";return u?console[s](...i):console.log(...i)}};function F_(s){var e=MC+(s===void 0?"":"-".concat(s)),t=Ev.getLogger(e);return t.getChild===void 0&&(t.prefix=s,t.getChild=n=>{var i=F_((s??"")+n);return i.methodFactory=t.methodFactory,i.rebuild(),i},t.setLevel(Ev.levels.DEBUG,!1)),t}var N=F_();class oD{constructor(e,t){this.parent=e,y(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.error(this.name,...t)}}class vm{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new vm(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];if(i.length===0)t="";else if(i[0]instanceof Error){var u=i.shift();t=u.stack||u.message}else typeof i[0]=="string"?t=i.shift():t="%O";this.debugInstance(e+" "+t,...i)}}var Ec={exports:{}},_b;function cd(){if(_b)return Ec.exports;_b=1;var s=typeof Reflect=="object"?Reflect:null,e=s&&typeof s.apply=="function"?s.apply:function(M,E,I){return Function.prototype.apply.call(M,E,I)},t;s&&typeof s.ownKeys=="function"?t=s.ownKeys:Object.getOwnPropertySymbols?t=function(M){return Object.getOwnPropertyNames(M).concat(Object.getOwnPropertySymbols(M))}:t=function(M){return Object.getOwnPropertyNames(M)};function n(O){console&&console.warn&&console.warn(O)}var i=Number.isNaN||function(M){return M!==M};function o(){o.init.call(this)}Ec.exports=o,Ec.exports.once=A,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var u=10;function d(O){if(typeof O!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof O)}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(O){if(typeof O!="number"||O<0||i(O))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+O+".");u=O}}),o.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(M){if(typeof M!="number"||M<0||i(M))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+M+".");return this._maxListeners=M,this};function h(O){return O._maxListeners===void 0?o.defaultMaxListeners:O._maxListeners}o.prototype.getMaxListeners=function(){return h(this)},o.prototype.emit=function(M){for(var E=[],I=1;I<arguments.length;I++)E.push(arguments[I]);var w=M==="error",q=this._events;if(q!==void 0)w=w&&q.error===void 0;else if(!w)return!1;if(w){var z;if(E.length>0&&(z=E[0]),z instanceof Error)throw z;var ue=new Error("Unhandled error."+(z?" ("+z.message+")":""));throw ue.context=z,ue}var Se=q[M];if(Se===void 0)return!1;if(typeof Se=="function")e(Se,this,E);else for(var Ie=Se.length,Ze=b(Se,Ie),I=0;I<Ie;++I)e(Ze[I],this,E);return!0};function f(O,M,E,I){var w,q,z;if(d(E),q=O._events,q===void 0?(q=O._events=Object.create(null),O._eventsCount=0):(q.newListener!==void 0&&(O.emit("newListener",M,E.listener?E.listener:E),q=O._events),z=q[M]),z===void 0)z=q[M]=E,++O._eventsCount;else if(typeof z=="function"?z=q[M]=I?[E,z]:[z,E]:I?z.unshift(E):z.push(E),w=h(O),w>0&&z.length>w&&!z.warned){z.warned=!0;var ue=new Error("Possible EventEmitter memory leak detected. "+z.length+" "+String(M)+" listeners added. Use emitter.setMaxListeners() to increase limit");ue.name="MaxListenersExceededWarning",ue.emitter=O,ue.type=M,ue.count=z.length,n(ue)}return O}o.prototype.addListener=function(M,E){return f(this,M,E,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(M,E){return f(this,M,E,!0)};function m(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function g(O,M,E){var I={fired:!1,wrapFn:void 0,target:O,type:M,listener:E},w=m.bind(I);return w.listener=E,I.wrapFn=w,w}o.prototype.once=function(M,E){return d(E),this.on(M,g(this,M,E)),this},o.prototype.prependOnceListener=function(M,E){return d(E),this.prependListener(M,g(this,M,E)),this},o.prototype.removeListener=function(M,E){var I,w,q,z,ue;if(d(E),w=this._events,w===void 0)return this;if(I=w[M],I===void 0)return this;if(I===E||I.listener===E)--this._eventsCount===0?this._events=Object.create(null):(delete w[M],w.removeListener&&this.emit("removeListener",M,I.listener||E));else if(typeof I!="function"){for(q=-1,z=I.length-1;z>=0;z--)if(I[z]===E||I[z].listener===E){ue=I[z].listener,q=z;break}if(q<0)return this;q===0?I.shift():T(I,q),I.length===1&&(w[M]=I[0]),w.removeListener!==void 0&&this.emit("removeListener",M,ue||E)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(M){var E,I,w;if(I=this._events,I===void 0)return this;if(I.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):I[M]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete I[M]),this;if(arguments.length===0){var q=Object.keys(I),z;for(w=0;w<q.length;++w)z=q[w],z!=="removeListener"&&this.removeAllListeners(z);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(E=I[M],typeof E=="function")this.removeListener(M,E);else if(E!==void 0)for(w=E.length-1;w>=0;w--)this.removeListener(M,E[w]);return this};function S(O,M,E){var I=O._events;if(I===void 0)return[];var w=I[M];return w===void 0?[]:typeof w=="function"?E?[w.listener||w]:[w]:E?k(w):b(w,w.length)}o.prototype.listeners=function(M){return S(this,M,!0)},o.prototype.rawListeners=function(M){return S(this,M,!1)},o.listenerCount=function(O,M){return typeof O.listenerCount=="function"?O.listenerCount(M):_.call(O,M)},o.prototype.listenerCount=_;function _(O){var M=this._events;if(M!==void 0){var E=M[O];if(typeof E=="function")return 1;if(E!==void 0)return E.length}return 0}o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(O,M){for(var E=new Array(M),I=0;I<M;++I)E[I]=O[I];return E}function T(O,M){for(;M+1<O.length;M++)O[M]=O[M+1];O.pop()}function k(O){for(var M=new Array(O.length),E=0;E<M.length;++E)M[E]=O[E].listener||O[E];return M}function A(O,M){return new Promise(function(E,I){function w(z){O.removeListener(M,q),I(z)}function q(){typeof O.removeListener=="function"&&O.removeListener("error",w),E([].slice.call(arguments))}U(O,M,q,{once:!0}),M!=="error"&&C(O,w,{once:!0})})}function C(O,M,E){typeof O.on=="function"&&U(O,"error",M,E)}function U(O,M,E,I){if(typeof O.on=="function")I.once?O.once(M,E):O.on(M,E);else if(typeof O.addEventListener=="function")O.addEventListener(M,function w(q){I.once&&O.removeEventListener(M,w),E(q)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof O)}return Ec.exports}var AC=cd(),q_=(function(s){return s.NewListener="newListener",s.RemoveListener="removeListener",s.Error="error",s})({});class Lt extends AC.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}emitPromised(e){var t=arguments,n=this;return D(function*(){for(var i=t.length,o=new Array(i>1?i-1:0),u=1;u<i;u++)o[u-1]=t[u];var d=n.listeners(e);return Promise.allSettled(d.map(h=>h(...o))).then(()=>d.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var Z=(function(s){return s.RoomCanonicalAlias="m.room.canonical_alias",s.RoomCreate="m.room.create",s.RoomJoinRules="m.room.join_rules",s.RoomMember="m.room.member",s.RoomThirdPartyInvite="m.room.third_party_invite",s.RoomPowerLevels="m.room.power_levels",s.RoomName="m.room.name",s.RoomTopic="m.room.topic",s.RoomAvatar="m.room.avatar",s.RoomPinnedEvents="m.room.pinned_events",s.RoomEncryption="m.room.encryption",s.RoomHistoryVisibility="m.room.history_visibility",s.RoomGuestAccess="m.room.guest_access",s.RoomServerAcl="m.room.server_acl",s.RoomTombstone="m.room.tombstone",s.RoomPredecessor="org.matrix.msc3946.room_predecessor",s.PolicyRuleUser="m.policy.rule.user",s.PolicyRuleRoom="m.policy.rule.room",s.PolicyRuleServer="m.policy.rule.server",s.SpaceChild="m.space.child",s.SpaceParent="m.space.parent",s.RoomRedaction="m.room.redaction",s.RoomMessage="m.room.message",s.RoomMessageEncrypted="m.room.encrypted",s.Sticker="m.sticker",s.CallInvite="m.call.invite",s.CallCandidates="m.call.candidates",s.CallAnswer="m.call.answer",s.CallHangup="m.call.hangup",s.CallReject="m.call.reject",s.CallSelectAnswer="m.call.select_answer",s.CallNegotiate="m.call.negotiate",s.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",s.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",s.CallReplaces="m.call.replaces",s.CallAssertedIdentity="m.call.asserted_identity",s.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",s.CallEncryptionKeysPrefix="io.element.call.encryption_keys",s.KeyVerificationRequest="m.key.verification.request",s.KeyVerificationStart="m.key.verification.start",s.KeyVerificationCancel="m.key.verification.cancel",s.KeyVerificationMac="m.key.verification.mac",s.KeyVerificationDone="m.key.verification.done",s.KeyVerificationKey="m.key.verification.key",s.KeyVerificationAccept="m.key.verification.accept",s.KeyVerificationReady="m.key.verification.ready",s.RoomMessageFeedback="m.room.message.feedback",s.Reaction="m.reaction",s.PollStart="org.matrix.msc3381.poll.start",s.Typing="m.typing",s.Receipt="m.receipt",s.Presence="m.presence",s.FullyRead="m.fully_read",s.Tag="m.tag",s.SpaceOrder="org.matrix.msc3230.space_order",s.PushRules="m.push_rules",s.Direct="m.direct",s.IgnoredUserList="m.ignored_user_list",s.RoomKey="m.room_key",s.RoomKeyRequest="m.room_key_request",s.ForwardedRoomKey="m.forwarded_room_key",s.Dummy="m.dummy",s.SecretRequest="m.secret.request",s.SecretSend="m.secret.send",s.GroupCallPrefix="org.matrix.msc3401.call",s.GroupCallMemberPrefix="org.matrix.msc3401.call.member",s.RTCMembership="org.matrix.msc4143.rtc.member",s.CallNotify="org.matrix.msc4075.call.notify",s.RTCNotification="org.matrix.msc4075.rtc.notification",s.RTCDecline="org.matrix.msc4310.rtc.decline",s.RoomPolicy="org.matrix.msc4284.policy",s})({}),Mt=(function(s){return s.Annotation="m.annotation",s.Replace="m.replace",s.Reference="m.reference",s.Thread="m.thread",s})({}),jr=(function(s){return s.Text="m.text",s.Emote="m.emote",s.Notice="m.notice",s.Image="m.image",s.File="m.file",s.Audio="m.audio",s.Location="m.location",s.Video="m.video",s.KeyVerificationRequest="m.key.verification.request",s})({}),Qc="type",Hs=(function(s){return s.Space="m.space",s.UnstableCall="org.matrix.msc3417.call",s.ElementVideo="io.element.video",s})({}),dd="org.matrix.msgid",_v=new Yt("m.room.purpose","org.matrix.msc3088.purpose"),Tv=new Yt("m.enabled","org.matrix.msc3088.enabled"),Rv=new Yt("m.data_tree","org.matrix.msc3089.data_tree"),K_=new Yt("m.leaf","org.matrix.msc3089.leaf"),ci=new Yt("m.branch","org.matrix.msc3089.branch"),H_=new Yt("m.room.marker","org.matrix.msc2716.marker"),wv=new Yt("with_rel_types","org.matrix.msc3912.with_relations"),V_=new Yt("io.element.functional_members","io.element.functional_members"),La=new Yt("m.visibility","org.matrix.msc3531.visibility"),Cv=new Yt("enabled","org.matrix.msc3881.enabled"),DC=new Yt("device_id","org.matrix.msc3881.device_id"),G_=new Yt("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),Zc=new Yt("thread_id","org.matrix.msc4023.thread_id"),z_=new io("membership","io.element.msc4115.membership"),Ye=(function(s){return s.Ban="ban",s.Invite="invite",s.Join="join",s.Knock="knock",s.Leave="leave",s})({}),Un=(function(s){return s.Membership="RoomMember.membership",s.Name="RoomMember.name",s.PowerLevel="RoomMember.powerLevel",s.Typing="RoomMember.typing",s})({});class Hl extends Lt{constructor(e,t){super(),this.roomId=e,this.userId=t,y(this,"_isOutOfBand",!1),y(this,"modified",-1),y(this,"requestedProfileInfo",!1),y(this,"typing",!1),y(this,"name",void 0),y(this,"rawDisplayName",void 0),y(this,"powerLevel",0),y(this,"user",void 0),y(this,"membership",void 0),y(this,"disambiguate",!1),y(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var n,i,o=(n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:"";if(e.getType()===Z.RoomMember){this._isOutOfBand=!1,this.events.member=e;var u=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&N.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=UC(this.userId,o,t);var d=this.name;this.name=PC(this.userId,o,this.disambiguate),this.rawDisplayName=gv((i=e.getDirectionalContent().displayname)!==null&&i!==void 0?i:""),(!this.rawDisplayName||!ja(this.rawDisplayName))&&(this.rawDisplayName=this.userId),u!==this.membership&&(this.updateModifiedTime(),this.emit(Un.Membership,e,this,u)),d!==this.name&&(this.updateModifiedTime(),this.emit(Un.Name,e,this,d))}}setPowerLevel(e,t){var n=this.powerLevel;this.powerLevel=e,n!==this.powerLevel&&(this.updateModifiedTime(),this.emit(Un.PowerLevel,t,this))}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var n=e.getContent().user_ids;Array.isArray(n)&&(n.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(Un.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Ye.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),n=e.getSender();if(t.membership===Ye.Join&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),t.membership===Ye.Invite&&t.is_direct)return n}}getAvatarUrl(e,t,n,i){var o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,u=arguments.length>5?arguments[5]:void 0,d=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,h=this.getMxcAvatarUrl();if(!h&&!o)return null;var f=ud(e,h,t,n,i,u,void 0,d);return f||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var mm=/@.+:.+/,kC=/[\u200E\u200F\u202A-\u202F]/;function UC(s,e,t){if(!e||e===s||!t)return!1;var n=ja(e);if(!n)return!1;if(mm.test(n)||kC.test(e))return!0;var i=t.getUserIdsWithDisplayName(e);return!!i.some(o=>o!==s)}function PC(s,e,t){return!e||e===s?s:t?gv(e)+" ("+s+")":ja(e)?gv(e):s}var zh={},rl={},il={},Tb;function W_(){if(Tb)return il;Tb=1,Object.defineProperty(il,"__esModule",{value:!0}),il.NamespacedMap=void 0;function s(h,f){var m=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!m){if(Array.isArray(h)||(m=e(h))||f){m&&(h=m);var g=0,S=function(){};return{s:S,n:function(){return g>=h.length?{done:!0}:{done:!1,value:h[g++]}},e:function(A){throw A},f:S}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var _=!0,b=!1,T;return{s:function(){m=m.call(h)},n:function(){var A=m.next();return _=A.done,A},e:function(A){b=!0,T=A},f:function(){try{!_&&m.return!=null&&m.return()}finally{if(b)throw T}}}}function e(h,f){if(h){if(typeof h=="string")return t(h,f);var m=Object.prototype.toString.call(h).slice(8,-1);if(m==="Object"&&h.constructor&&(m=h.constructor.name),m==="Map"||m==="Set")return Array.from(h);if(m==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(m))return t(h,f)}}function t(h,f){(f==null||f>h.length)&&(f=h.length);for(var m=0,g=new Array(f);m<f;m++)g[m]=h[m];return g}function n(h,f){if(!(h instanceof f))throw new TypeError("Cannot call a class as a function")}function i(h,f){for(var m=0;m<f.length;m++){var g=f[m];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(h,g.key,g)}}function o(h,f,m){return f&&i(h.prototype,f),Object.defineProperty(h,"prototype",{writable:!1}),h}function u(h,f,m){return f in h?Object.defineProperty(h,f,{value:m,enumerable:!0,configurable:!0,writable:!0}):h[f]=m,h}var d=(function(){function h(f){if(n(this,h),u(this,"internalMap",new Map),f){var m=s(f),g;try{for(m.s();!(g=m.n()).done;){var S=g.value;this.set(S[0],S[1])}}catch(_){m.e(_)}finally{m.f()}}}return o(h,[{key:"get",value:function(m){return m.name&&this.internalMap.has(m.name)?this.internalMap.get(m.name):m.altName&&this.internalMap.has(m.altName)?this.internalMap.get(m.altName):null}},{key:"set",value:function(m,g){m.name&&this.internalMap.set(m.name,g),m.altName&&this.internalMap.set(m.altName,g)}},{key:"has",value:function(m){return!!this.get(m)}},{key:"delete",value:function(m){m.name&&this.internalMap.delete(m.name),m.altName&&this.internalMap.delete(m.altName)}},{key:"hasNamespaced",value:function(m){return this.internalMap.has(m)}},{key:"getNamespaced",value:function(m){return this.internalMap.get(m)}}]),h})();return il.NamespacedMap=d,il}var al={},Rb;function ao(){if(Rb)return al;Rb=1;function s(b){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},s(b)}Object.defineProperty(al,"__esModule",{value:!0}),al.InvalidEventError=void 0;function e(b,T,k){return Object.defineProperty(b,"prototype",{writable:!1}),b}function t(b,T){if(!(b instanceof T))throw new TypeError("Cannot call a class as a function")}function n(b,T){if(typeof T!="function"&&T!==null)throw new TypeError("Super expression must either be null or a function");b.prototype=Object.create(T&&T.prototype,{constructor:{value:b,writable:!0,configurable:!0}}),Object.defineProperty(b,"prototype",{writable:!1}),T&&g(b,T)}function i(b){var T=f();return function(){var A=S(b),C;if(T){var U=S(this).constructor;C=Reflect.construct(A,arguments,U)}else C=A.apply(this,arguments);return o(this,C)}}function o(b,T){if(T&&(s(T)==="object"||typeof T=="function"))return T;if(T!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return u(b)}function u(b){if(b===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b}function d(b){var T=typeof Map=="function"?new Map:void 0;return d=function(A){if(A===null||!m(A))return A;if(typeof A!="function")throw new TypeError("Super expression must either be null or a function");if(typeof T<"u"){if(T.has(A))return T.get(A);T.set(A,C)}function C(){return h(A,arguments,S(this).constructor)}return C.prototype=Object.create(A.prototype,{constructor:{value:C,enumerable:!1,writable:!0,configurable:!0}}),g(C,A)},d(b)}function h(b,T,k){return f()?h=Reflect.construct:h=function(C,U,O){var M=[null];M.push.apply(M,U);var E=Function.bind.apply(C,M),I=new E;return O&&g(I,O.prototype),I},h.apply(null,arguments)}function f(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function m(b){return Function.toString.call(b).indexOf("[native code]")!==-1}function g(b,T){return g=Object.setPrototypeOf||function(A,C){return A.__proto__=C,A},g(b,T)}function S(b){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(k){return k.__proto__||Object.getPrototypeOf(k)},S(b)}var _=(function(b){n(k,b);var T=i(k);function k(A){return t(this,k),T.call(this,A)}return e(k)})(d(Error));return al.InvalidEventError=_,al}var ks={},sl={},ol={},wb;function au(){if(wb)return ol;wb=1,Object.defineProperty(ol,"__esModule",{value:!0}),ol.ExtensibleEvent=void 0;function s(i,o){if(!(i instanceof o))throw new TypeError("Cannot call a class as a function")}function e(i,o){for(var u=0;u<o.length;u++){var d=o[u];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(i,d.key,d)}}function t(i,o,u){return o&&e(i.prototype,o),Object.defineProperty(i,"prototype",{writable:!1}),i}var n=(function(){function i(o){s(this,i),this.wireFormat=o}return t(i,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),i})();return ol.ExtensibleEvent=n,ol}var ll={},Cb;function Y_(){if(Cb)return ll;Cb=1,Object.defineProperty(ll,"__esModule",{value:!0}),ll.isOptionalAString=s,ll.isProvided=e;function s(t){return e(t)&&typeof t=="string"}function e(t){return t!=null}return ll}var Vn={},Ea={},Ib;function so(){if(Ib)return Ea;Ib=1;function s(_){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},s(_)}Object.defineProperty(Ea,"__esModule",{value:!0}),Ea.UnstableValue=Ea.NamespacedValue=void 0;function e(_,b){if(typeof b!="function"&&b!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(b&&b.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),b&&t(_,b)}function t(_,b){return t=Object.setPrototypeOf||function(k,A){return k.__proto__=A,k},t(_,b)}function n(_){var b=u();return function(){var k=d(_),A;if(b){var C=d(this).constructor;A=Reflect.construct(k,arguments,C)}else A=k.apply(this,arguments);return i(this,A)}}function i(_,b){if(b&&(s(b)==="object"||typeof b=="function"))return b;if(b!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return o(_)}function o(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function u(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function d(_){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},d(_)}function h(_,b){if(!(_ instanceof b))throw new TypeError("Cannot call a class as a function")}function f(_,b){for(var T=0;T<b.length;T++){var k=b[T];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(_,k.key,k)}}function m(_,b,T){return b&&f(_.prototype,b),Object.defineProperty(_,"prototype",{writable:!1}),_}var g=(function(){function _(b,T){if(h(this,_),this.stable=b,this.unstable=T,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return m(_,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(T){return!!this.name&&this.name===T||!!this.altName&&this.altName===T}},{key:"findIn",value:function(T){var k;return this.name&&(k=T?.[this.name]),!k&&this.altName&&(k=T?.[this.altName]),k}},{key:"includedIn",value:function(T){var k=!1;return this.name&&(k=T.includes(this.name)),!k&&this.altName&&(k=T.includes(this.altName)),k}}]),_})();Ea.NamespacedValue=g;var S=(function(_){e(T,_);var b=n(T);function T(k,A){var C;if(h(this,T),C=b.call(this,k,A),!C.unstable)throw new Error("Unstable value must be supplied");return C}return m(T,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),T})(g);return Ea.UnstableValue=S,Ea}var Ob;function Br(){if(Ob)return Vn;Ob=1,Object.defineProperty(Vn,"__esModule",{value:!0}),Vn.M_TEXT=Vn.M_NOTICE=Vn.M_MESSAGE=Vn.M_HTML=Vn.M_EMOTE=void 0;var s=so(),e=new s.UnstableValue("m.message","org.matrix.msc1767.message");Vn.M_MESSAGE=e;var t=new s.UnstableValue("m.text","org.matrix.msc1767.text");Vn.M_TEXT=t;var n=new s.UnstableValue("m.html","org.matrix.msc1767.html");Vn.M_HTML=n;var i=new s.UnstableValue("m.emote","org.matrix.msc1767.emote");Vn.M_EMOTE=i;var o=new s.UnstableValue("m.notice","org.matrix.msc1767.notice");return Vn.M_NOTICE=o,Vn}var _c={},Mb;function Ha(){if(Mb)return _c;Mb=1,Object.defineProperty(_c,"__esModule",{value:!0}),_c.isEventTypeSame=s;function s(e,t){if(typeof e=="string")return typeof t=="string"?t===e:t.matches(e);if(typeof t=="string")return e.matches(t);var n=t,i=e;return n.matches(i.name)||n.matches(i.altName)}return _c}var Ab;function Va(){if(Ab)return sl;Ab=1;function s(O){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(M){return typeof M}:function(M){return M&&typeof Symbol=="function"&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M},s(O)}Object.defineProperty(sl,"__esModule",{value:!0}),sl.MessageEvent=void 0;var e=au(),t=Y_(),n=ao(),i=Br(),o=Ha();function u(O,M){var E=Object.keys(O);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(O);M&&(I=I.filter(function(w){return Object.getOwnPropertyDescriptor(O,w).enumerable})),E.push.apply(E,I)}return E}function d(O){for(var M=1;M<arguments.length;M++){var E=arguments[M]!=null?arguments[M]:{};M%2?u(Object(E),!0).forEach(function(I){C(O,I,E[I])}):Object.getOwnPropertyDescriptors?Object.defineProperties(O,Object.getOwnPropertyDescriptors(E)):u(Object(E)).forEach(function(I){Object.defineProperty(O,I,Object.getOwnPropertyDescriptor(E,I))})}return O}function h(O,M){if(!(O instanceof M))throw new TypeError("Cannot call a class as a function")}function f(O,M){for(var E=0;E<M.length;E++){var I=M[E];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(O,I.key,I)}}function m(O,M,E){return M&&f(O.prototype,M),E&&f(O,E),Object.defineProperty(O,"prototype",{writable:!1}),O}function g(O,M){if(typeof M!="function"&&M!==null)throw new TypeError("Super expression must either be null or a function");O.prototype=Object.create(M&&M.prototype,{constructor:{value:O,writable:!0,configurable:!0}}),Object.defineProperty(O,"prototype",{writable:!1}),M&&S(O,M)}function S(O,M){return S=Object.setPrototypeOf||function(I,w){return I.__proto__=w,I},S(O,M)}function _(O){var M=k();return function(){var I=A(O),w;if(M){var q=A(this).constructor;w=Reflect.construct(I,arguments,q)}else w=I.apply(this,arguments);return b(this,w)}}function b(O,M){if(M&&(s(M)==="object"||typeof M=="function"))return M;if(M!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return T(O)}function T(O){if(O===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return O}function k(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function A(O){return A=Object.setPrototypeOf?Object.getPrototypeOf:function(E){return E.__proto__||Object.getPrototypeOf(E)},A(O)}function C(O,M,E){return M in O?Object.defineProperty(O,M,{value:E,enumerable:!0,configurable:!0,writable:!0}):O[M]=E,O}var U=(function(O){g(E,O);var M=_(E);function E(I){var w;h(this,E),w=M.call(this,I),C(T(w),"text",void 0),C(T(w),"html",void 0),C(T(w),"renderings",void 0);var q=i.M_MESSAGE.findIn(w.wireContent),z=i.M_TEXT.findIn(w.wireContent),ue=i.M_HTML.findIn(w.wireContent);if((0,t.isProvided)(q)){if(!Array.isArray(q))throw new n.InvalidEventError("m.message contents must be an array");var Se=q.find(function(Ze){return!(0,t.isProvided)(Ze.mimetype)||Ze.mimetype==="text/plain"}),Ie=q.find(function(Ze){return Ze.mimetype==="text/html"});if(!Se)throw new n.InvalidEventError("m.message is missing a plain text representation");w.text=Se.body,w.html=Ie?.body,w.renderings=q}else if((0,t.isOptionalAString)(z))w.text=z,w.html=ue,w.renderings=[{body:z,mimetype:"text/plain"}],w.html&&w.renderings.push({body:w.html,mimetype:"text/html"});else throw new n.InvalidEventError("Missing textual representation for event");return w}return m(E,[{key:"isEmote",get:function(){return i.M_EMOTE.matches(this.wireFormat.type)||(0,t.isProvided)(i.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return i.M_NOTICE.matches(this.wireFormat.type)||(0,t.isProvided)(i.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(w){return(0,o.isEventTypeSame)(w,i.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var w=C({},i.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var q=this.renderings[0].mimetype;(q===void 0||q==="text/plain")&&(w=C({},i.M_TEXT.name,this.renderings[0].body))}return w}},{key:"serialize",value:function(){var w;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(w=this.html)!==null&&w!==void 0?w:void 0})}}}],[{key:"from",value:function(w,q){var z;return new E({type:i.M_MESSAGE.name,content:(z={},C(z,i.M_TEXT.name,w),C(z,i.M_HTML.name,q),z)})}}]),E})(e.ExtensibleEvent);return sl.MessageEvent=U,sl}var ul={},Db;function pm(){if(Db)return ul;Db=1;function s(C){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(U){return typeof U}:function(U){return U&&typeof Symbol=="function"&&U.constructor===Symbol&&U!==Symbol.prototype?"symbol":typeof U},s(C)}Object.defineProperty(ul,"__esModule",{value:!0}),ul.NoticeEvent=void 0;var e=Va(),t=Br(),n=Ha();function i(C,U,O){return U in C?Object.defineProperty(C,U,{value:O,enumerable:!0,configurable:!0,writable:!0}):C[U]=O,C}function o(C,U){if(!(C instanceof U))throw new TypeError("Cannot call a class as a function")}function u(C,U){for(var O=0;O<U.length;O++){var M=U[O];M.enumerable=M.enumerable||!1,M.configurable=!0,"value"in M&&(M.writable=!0),Object.defineProperty(C,M.key,M)}}function d(C,U,O){return U&&u(C.prototype,U),O&&u(C,O),Object.defineProperty(C,"prototype",{writable:!1}),C}function h(){return typeof Reflect<"u"&&Reflect.get?h=Reflect.get:h=function(U,O,M){var E=f(U,O);if(E){var I=Object.getOwnPropertyDescriptor(E,O);return I.get?I.get.call(arguments.length<3?U:M):I.value}},h.apply(this,arguments)}function f(C,U){for(;!Object.prototype.hasOwnProperty.call(C,U)&&(C=k(C),C!==null););return C}function m(C,U){if(typeof U!="function"&&U!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(U&&U.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),U&&g(C,U)}function g(C,U){return g=Object.setPrototypeOf||function(M,E){return M.__proto__=E,M},g(C,U)}function S(C){var U=T();return function(){var M=k(C),E;if(U){var I=k(this).constructor;E=Reflect.construct(M,arguments,I)}else E=M.apply(this,arguments);return _(this,E)}}function _(C,U){if(U&&(s(U)==="object"||typeof U=="function"))return U;if(U!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return b(C)}function b(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function T(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function k(C){return k=Object.setPrototypeOf?Object.getPrototypeOf:function(O){return O.__proto__||Object.getPrototypeOf(O)},k(C)}var A=(function(C){m(O,C);var U=S(O);function O(M){return o(this,O),U.call(this,M)}return d(O,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(E){return(0,n.isEventTypeSame)(E,t.M_NOTICE)||h(k(O.prototype),"isEquivalentTo",this).call(this,E)}},{key:"serialize",value:function(){var E=h(k(O.prototype),"serialize",this).call(this);return E.content.msgtype="m.notice",E}}],[{key:"from",value:function(E,I){var w;return new O({type:t.M_NOTICE.name,content:(w={},i(w,t.M_TEXT.name,E),i(w,t.M_HTML.name,I),w)})}}]),O})(e.MessageEvent);return ul.NoticeEvent=A,ul}var cl={},kb;function gm(){if(kb)return cl;kb=1;function s(C){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(U){return typeof U}:function(U){return U&&typeof Symbol=="function"&&U.constructor===Symbol&&U!==Symbol.prototype?"symbol":typeof U},s(C)}Object.defineProperty(cl,"__esModule",{value:!0}),cl.EmoteEvent=void 0;var e=Va(),t=Br(),n=Ha();function i(C,U,O){return U in C?Object.defineProperty(C,U,{value:O,enumerable:!0,configurable:!0,writable:!0}):C[U]=O,C}function o(C,U){if(!(C instanceof U))throw new TypeError("Cannot call a class as a function")}function u(C,U){for(var O=0;O<U.length;O++){var M=U[O];M.enumerable=M.enumerable||!1,M.configurable=!0,"value"in M&&(M.writable=!0),Object.defineProperty(C,M.key,M)}}function d(C,U,O){return U&&u(C.prototype,U),O&&u(C,O),Object.defineProperty(C,"prototype",{writable:!1}),C}function h(){return typeof Reflect<"u"&&Reflect.get?h=Reflect.get:h=function(U,O,M){var E=f(U,O);if(E){var I=Object.getOwnPropertyDescriptor(E,O);return I.get?I.get.call(arguments.length<3?U:M):I.value}},h.apply(this,arguments)}function f(C,U){for(;!Object.prototype.hasOwnProperty.call(C,U)&&(C=k(C),C!==null););return C}function m(C,U){if(typeof U!="function"&&U!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(U&&U.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),U&&g(C,U)}function g(C,U){return g=Object.setPrototypeOf||function(M,E){return M.__proto__=E,M},g(C,U)}function S(C){var U=T();return function(){var M=k(C),E;if(U){var I=k(this).constructor;E=Reflect.construct(M,arguments,I)}else E=M.apply(this,arguments);return _(this,E)}}function _(C,U){if(U&&(s(U)==="object"||typeof U=="function"))return U;if(U!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return b(C)}function b(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function T(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function k(C){return k=Object.setPrototypeOf?Object.getPrototypeOf:function(O){return O.__proto__||Object.getPrototypeOf(O)},k(C)}var A=(function(C){m(O,C);var U=S(O);function O(M){return o(this,O),U.call(this,M)}return d(O,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(E){return(0,n.isEventTypeSame)(E,t.M_EMOTE)||h(k(O.prototype),"isEquivalentTo",this).call(this,E)}},{key:"serialize",value:function(){var E=h(k(O.prototype),"serialize",this).call(this);return E.content.msgtype="m.emote",E}}],[{key:"from",value:function(E,I){var w;return new O({type:t.M_EMOTE.name,content:(w={},i(w,t.M_TEXT.name,E),i(w,t.M_HTML.name,I),w)})}}]),O})(e.MessageEvent);return cl.EmoteEvent=A,cl}var Ub;function J_(){if(Ub)return ks;Ub=1,Object.defineProperty(ks,"__esModule",{value:!0}),ks.LEGACY_M_ROOM_MESSAGE=void 0,ks.parseMRoomMessage=f;var s=Va(),e=pm(),t=gm(),n=so(),i=Br();function o(m,g){var S=Object.keys(m);if(Object.getOwnPropertySymbols){var _=Object.getOwnPropertySymbols(m);g&&(_=_.filter(function(b){return Object.getOwnPropertyDescriptor(m,b).enumerable})),S.push.apply(S,_)}return S}function u(m){for(var g=1;g<arguments.length;g++){var S=arguments[g]!=null?arguments[g]:{};g%2?o(Object(S),!0).forEach(function(_){d(m,_,S[_])}):Object.getOwnPropertyDescriptors?Object.defineProperties(m,Object.getOwnPropertyDescriptors(S)):o(Object(S)).forEach(function(_){Object.defineProperty(m,_,Object.getOwnPropertyDescriptor(S,_))})}return m}function d(m,g,S){return g in m?Object.defineProperty(m,g,{value:S,enumerable:!0,configurable:!0,writable:!0}):m[g]=S,m}var h=new n.NamespacedValue("m.room.message");ks.LEGACY_M_ROOM_MESSAGE=h;function f(m){var g,S,_;if(i.M_MESSAGE.findIn(m.content)||i.M_TEXT.findIn(m.content))return new s.MessageEvent(m);var b=(g=m.content)===null||g===void 0?void 0:g.msgtype,T=(S=m.content)===null||S===void 0?void 0:S.body,k=((_=m.content)===null||_===void 0?void 0:_.format)==="org.matrix.custom.html"?m.content.formatted_body:null;if(b==="m.text"){var A;return new s.MessageEvent(u(u({},m),{},{content:u(u({},m.content),{},(A={},d(A,i.M_TEXT.name,T),d(A,i.M_HTML.name,k),A))}))}else if(b==="m.notice"){var C;return new e.NoticeEvent(u(u({},m),{},{content:u(u({},m.content),{},(C={},d(C,i.M_TEXT.name,T),d(C,i.M_HTML.name,k),C))}))}else if(b==="m.emote"){var U;return new t.EmoteEvent(u(u({},m),{},{content:u(u({},m.content),{},(U={},d(U,i.M_TEXT.name,T),d(U,i.M_HTML.name,k),U))}))}else return null}return ks}var Tc={},Pb;function X_(){if(Pb)return Tc;Pb=1,Object.defineProperty(Tc,"__esModule",{value:!0}),Tc.parseMMessage=i;var s=Va(),e=Br(),t=gm(),n=pm();function i(o){return e.M_EMOTE.matches(o.type)?new t.EmoteEvent(o):e.M_NOTICE.matches(o.type)?new n.NoticeEvent(o):new s.MessageEvent(o)}return Tc}var Gn={},Nb;function oo(){if(Nb)return Gn;Nb=1,Object.defineProperty(Gn,"__esModule",{value:!0}),Gn.M_POLL_START=Gn.M_POLL_RESPONSE=Gn.M_POLL_KIND_UNDISCLOSED=Gn.M_POLL_KIND_DISCLOSED=Gn.M_POLL_END=void 0;var s=so(),e=new s.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");Gn.M_POLL_KIND_DISCLOSED=e;var t=new s.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");Gn.M_POLL_KIND_UNDISCLOSED=t;var n=new s.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");Gn.M_POLL_START=n;var i=new s.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");Gn.M_POLL_RESPONSE=i;var o=new s.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return Gn.M_POLL_END=o,Gn}var Rc={},_a={},Lb;function Q_(){if(Lb)return _a;Lb=1;function s(me){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(J){return typeof J}:function(J){return J&&typeof Symbol=="function"&&J.constructor===Symbol&&J!==Symbol.prototype?"symbol":typeof J},s(me)}Object.defineProperty(_a,"__esModule",{value:!0}),_a.PollStartEvent=_a.PollAnswerSubevent=void 0;var e=oo(),t=Va(),n=Br(),i=ao(),o=so(),u=Ha(),d=au();function h(me){return S(me)||g(me)||m(me)||f()}function f(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function m(me,J){if(me){if(typeof me=="string")return _(me,J);var oe=Object.prototype.toString.call(me).slice(8,-1);if(oe==="Object"&&me.constructor&&(oe=me.constructor.name),oe==="Map"||oe==="Set")return Array.from(me);if(oe==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(oe))return _(me,J)}}function g(me){if(typeof Symbol<"u"&&me[Symbol.iterator]!=null||me["@@iterator"]!=null)return Array.from(me)}function S(me){if(Array.isArray(me))return _(me)}function _(me,J){(J==null||J>me.length)&&(J=me.length);for(var oe=0,pe=new Array(J);oe<J;oe++)pe[oe]=me[oe];return pe}function b(me,J){var oe=Object.keys(me);if(Object.getOwnPropertySymbols){var pe=Object.getOwnPropertySymbols(me);J&&(pe=pe.filter(function(Te){return Object.getOwnPropertyDescriptor(me,Te).enumerable})),oe.push.apply(oe,pe)}return oe}function T(me){for(var J=1;J<arguments.length;J++){var oe=arguments[J]!=null?arguments[J]:{};J%2?b(Object(oe),!0).forEach(function(pe){z(me,pe,oe[pe])}):Object.getOwnPropertyDescriptors?Object.defineProperties(me,Object.getOwnPropertyDescriptors(oe)):b(Object(oe)).forEach(function(pe){Object.defineProperty(me,pe,Object.getOwnPropertyDescriptor(oe,pe))})}return me}function k(me,J){if(!(me instanceof J))throw new TypeError("Cannot call a class as a function")}function A(me,J){for(var oe=0;oe<J.length;oe++){var pe=J[oe];pe.enumerable=pe.enumerable||!1,pe.configurable=!0,"value"in pe&&(pe.writable=!0),Object.defineProperty(me,pe.key,pe)}}function C(me,J,oe){return J&&A(me.prototype,J),oe&&A(me,oe),Object.defineProperty(me,"prototype",{writable:!1}),me}function U(me,J){if(typeof J!="function"&&J!==null)throw new TypeError("Super expression must either be null or a function");me.prototype=Object.create(J&&J.prototype,{constructor:{value:me,writable:!0,configurable:!0}}),Object.defineProperty(me,"prototype",{writable:!1}),J&&O(me,J)}function O(me,J){return O=Object.setPrototypeOf||function(pe,Te){return pe.__proto__=Te,pe},O(me,J)}function M(me){var J=w();return function(){var pe=q(me),Te;if(J){var De=q(this).constructor;Te=Reflect.construct(pe,arguments,De)}else Te=pe.apply(this,arguments);return E(this,Te)}}function E(me,J){if(J&&(s(J)==="object"||typeof J=="function"))return J;if(J!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return I(me)}function I(me){if(me===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return me}function w(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function q(me){return q=Object.setPrototypeOf?Object.getPrototypeOf:function(oe){return oe.__proto__||Object.getPrototypeOf(oe)},q(me)}function z(me,J,oe){return J in me?Object.defineProperty(me,J,{value:oe,enumerable:!0,configurable:!0,writable:!0}):me[J]=oe,me}var ue=(function(me){U(oe,me);var J=M(oe);function oe(pe){var Te;k(this,oe),Te=J.call(this,pe),z(I(Te),"id",void 0);var De=pe.content.id;if(!De||typeof De!="string")throw new i.InvalidEventError("Answer ID must be a non-empty string");return Te.id=De,Te}return C(oe,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:T({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(Te,De){return new oe({type:"org.matrix.sdk.poll.answer",content:z({id:Te},n.M_TEXT.name,De)})}}]),oe})(t.MessageEvent);_a.PollAnswerSubevent=ue;var Se=(function(me){U(oe,me);var J=M(oe);function oe(pe){var Te;k(this,oe),Te=J.call(this,pe),z(I(Te),"question",void 0),z(I(Te),"kind",void 0),z(I(Te),"rawKind",void 0),z(I(Te),"maxSelections",void 0),z(I(Te),"answers",void 0);var De=e.M_POLL_START.findIn(Te.wireContent);if(!De.question)throw new i.InvalidEventError("A question is required");if(Te.question=new t.MessageEvent({type:"org.matrix.sdk.poll.question",content:De.question}),Te.rawKind=De.kind,e.M_POLL_KIND_DISCLOSED.matches(Te.rawKind)?Te.kind=e.M_POLL_KIND_DISCLOSED:Te.kind=e.M_POLL_KIND_UNDISCLOSED,Te.maxSelections=Number.isFinite(De.max_selections)&&De.max_selections>0?De.max_selections:1,!Array.isArray(De.answers))throw new i.InvalidEventError("Poll answers must be an array");var H=De.answers.slice(0,20).map(function(le){return new ue({type:"org.matrix.sdk.poll.answer",content:le})});if(H.length<=0)throw new i.InvalidEventError("No answers available");return Te.answers=H,Te}return C(oe,[{key:"isEquivalentTo",value:function(Te){return(0,u.isEventTypeSame)(Te,e.M_POLL_START)}},{key:"serialize",value:function(){var Te;return{type:e.M_POLL_START.name,content:(Te={},z(Te,e.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(De){return De.serialize().content})}),z(Te,n.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(De,H){return"".concat(H+1,". ").concat(De.text)}).join(`
`))),Te)}}}],[{key:"from",value:function(Te,De,H){var le,Re=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new oe({type:e.M_POLL_START.name,content:(le={},z(le,n.M_TEXT.name,Te),z(le,e.M_POLL_START.name,{question:z({},n.M_TEXT.name,Te),kind:H instanceof o.NamespacedValue?H.name:H,max_selections:Re,answers:De.map(function(X){return z({id:Ze()},n.M_TEXT.name,X)})}),le)})}}]),oe})(d.ExtensibleEvent);_a.PollStartEvent=Se;var Ie="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Ze(){return h(Array(16)).map(function(){return Ie.charAt(Math.floor(Math.random()*Ie.length))}).join("")}return _a}var dl={},fl={},xb;function ym(){if(xb)return fl;xb=1,Object.defineProperty(fl,"__esModule",{value:!0}),fl.REFERENCE_RELATION=void 0;var s=so(),e=new s.NamespacedValue("m.reference");return fl.REFERENCE_RELATION=e,fl}var jb;function Z_(){if(jb)return dl;jb=1;function s(C){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(U){return typeof U}:function(U){return U&&typeof Symbol=="function"&&U.constructor===Symbol&&U!==Symbol.prototype?"symbol":typeof U},s(C)}Object.defineProperty(dl,"__esModule",{value:!0}),dl.PollResponseEvent=void 0;var e=au(),t=oo(),n=ao(),i=ym(),o=Ha();function u(C,U){if(!(C instanceof U))throw new TypeError("Cannot call a class as a function")}function d(C,U){for(var O=0;O<U.length;O++){var M=U[O];M.enumerable=M.enumerable||!1,M.configurable=!0,"value"in M&&(M.writable=!0),Object.defineProperty(C,M.key,M)}}function h(C,U,O){return U&&d(C.prototype,U),O&&d(C,O),Object.defineProperty(C,"prototype",{writable:!1}),C}function f(C,U){if(typeof U!="function"&&U!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(U&&U.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),U&&m(C,U)}function m(C,U){return m=Object.setPrototypeOf||function(M,E){return M.__proto__=E,M},m(C,U)}function g(C){var U=b();return function(){var M=T(C),E;if(U){var I=T(this).constructor;E=Reflect.construct(M,arguments,I)}else E=M.apply(this,arguments);return S(this,E)}}function S(C,U){if(U&&(s(U)==="object"||typeof U=="function"))return U;if(U!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return _(C)}function _(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function b(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function T(C){return T=Object.setPrototypeOf?Object.getPrototypeOf:function(O){return O.__proto__||Object.getPrototypeOf(O)},T(C)}function k(C,U,O){return U in C?Object.defineProperty(C,U,{value:O,enumerable:!0,configurable:!0,writable:!0}):C[U]=O,C}var A=(function(C){f(O,C);var U=g(O);function O(M){var E;u(this,O),E=U.call(this,M),k(_(E),"internalAnswerIds",void 0),k(_(E),"internalSpoiled",void 0),k(_(E),"pollEventId",void 0);var I=E.wireContent["m.relates_to"];if(!i.REFERENCE_RELATION.matches(I?.rel_type)||typeof I?.event_id!="string")throw new n.InvalidEventError("Relationship must be a reference to an event");return E.pollEventId=I.event_id,E.validateAgainst(null),E}return h(O,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(E){var I=t.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(I?.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var w=I.answers;if(w.some(function(q){return typeof q!="string"})||w.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(E){if(w.some(function(q){return!E.answers.some(function(z){return z.id===q})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}w=w.slice(0,E.maxSelections)}this.internalAnswerIds=w,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(E){return(0,o.isEventTypeSame)(E,t.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:t.M_POLL_RESPONSE.name,content:k({"m.relates_to":{rel_type:i.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(E,I){return new O({type:t.M_POLL_RESPONSE.name,content:k({"m.relates_to":{rel_type:i.REFERENCE_RELATION.name,event_id:I}},t.M_POLL_RESPONSE.name,{answers:E})})}}]),O})(e.ExtensibleEvent);return dl.PollResponseEvent=A,dl}var hl={},Bb;function $_(){if(Bb)return hl;Bb=1;function s(E){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},s(E)}Object.defineProperty(hl,"__esModule",{value:!0}),hl.PollEndEvent=void 0;var e=oo(),t=ao(),n=ym(),i=Va(),o=Br(),u=Ha(),d=au();function h(E,I){var w=Object.keys(E);if(Object.getOwnPropertySymbols){var q=Object.getOwnPropertySymbols(E);I&&(q=q.filter(function(z){return Object.getOwnPropertyDescriptor(E,z).enumerable})),w.push.apply(w,q)}return w}function f(E){for(var I=1;I<arguments.length;I++){var w=arguments[I]!=null?arguments[I]:{};I%2?h(Object(w),!0).forEach(function(q){O(E,q,w[q])}):Object.getOwnPropertyDescriptors?Object.defineProperties(E,Object.getOwnPropertyDescriptors(w)):h(Object(w)).forEach(function(q){Object.defineProperty(E,q,Object.getOwnPropertyDescriptor(w,q))})}return E}function m(E,I){if(!(E instanceof I))throw new TypeError("Cannot call a class as a function")}function g(E,I){for(var w=0;w<I.length;w++){var q=I[w];q.enumerable=q.enumerable||!1,q.configurable=!0,"value"in q&&(q.writable=!0),Object.defineProperty(E,q.key,q)}}function S(E,I,w){return I&&g(E.prototype,I),w&&g(E,w),Object.defineProperty(E,"prototype",{writable:!1}),E}function _(E,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");E.prototype=Object.create(I&&I.prototype,{constructor:{value:E,writable:!0,configurable:!0}}),Object.defineProperty(E,"prototype",{writable:!1}),I&&b(E,I)}function b(E,I){return b=Object.setPrototypeOf||function(q,z){return q.__proto__=z,q},b(E,I)}function T(E){var I=C();return function(){var q=U(E),z;if(I){var ue=U(this).constructor;z=Reflect.construct(q,arguments,ue)}else z=q.apply(this,arguments);return k(this,z)}}function k(E,I){if(I&&(s(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return A(E)}function A(E){if(E===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return E}function C(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function U(E){return U=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},U(E)}function O(E,I,w){return I in E?Object.defineProperty(E,I,{value:w,enumerable:!0,configurable:!0,writable:!0}):E[I]=w,E}var M=(function(E){_(w,E);var I=T(w);function w(q){var z;m(this,w),z=I.call(this,q),O(A(z),"pollEventId",void 0),O(A(z),"closingMessage",void 0);var ue=z.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(ue?.rel_type)||typeof ue?.event_id!="string")throw new t.InvalidEventError("Relationship must be a reference to an event");return z.pollEventId=ue.event_id,z.closingMessage=new i.MessageEvent(z.wireFormat),z}return S(w,[{key:"isEquivalentTo",value:function(z){return(0,u.isEventTypeSame)(z,e.M_POLL_END)}},{key:"serialize",value:function(){return{type:e.M_POLL_END.name,content:f(O({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},e.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(z,ue){var Se;return new w({type:e.M_POLL_END.name,content:(Se={"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:z}},O(Se,e.M_POLL_END.name,{}),O(Se,o.M_TEXT.name,ue),Se)})}}]),w})(d.ExtensibleEvent);return hl.PollEndEvent=M,hl}var Fb;function e0(){if(Fb)return Rc;Fb=1,Object.defineProperty(Rc,"__esModule",{value:!0}),Rc.parseMPoll=i;var s=oo(),e=Q_(),t=Z_(),n=$_();function i(o){return s.M_POLL_START.matches(o.type)?new e.PollStartEvent(o):s.M_POLL_RESPONSE.matches(o.type)?new t.PollResponseEvent(o):s.M_POLL_END.matches(o.type)?new n.PollEndEvent(o):null}return Rc}var qb;function NC(){if(qb)return rl;qb=1,Object.defineProperty(rl,"__esModule",{value:!0}),rl.ExtensibleEvents=void 0;var s=W_(),e=ao(),t=J_(),n=X_(),i=Br(),o=oo(),u=e0();function d(T,k){var A=typeof Symbol<"u"&&T[Symbol.iterator]||T["@@iterator"];if(!A){if(Array.isArray(T)||(A=h(T))||k){A&&(T=A);var C=0,U=function(){};return{s:U,n:function(){return C>=T.length?{done:!0}:{done:!1,value:T[C++]}},e:function(w){throw w},f:U}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var O=!0,M=!1,E;return{s:function(){A=A.call(T)},n:function(){var w=A.next();return O=w.done,w},e:function(w){M=!0,E=w},f:function(){try{!O&&A.return!=null&&A.return()}finally{if(M)throw E}}}}function h(T,k){if(T){if(typeof T=="string")return f(T,k);var A=Object.prototype.toString.call(T).slice(8,-1);if(A==="Object"&&T.constructor&&(A=T.constructor.name),A==="Map"||A==="Set")return Array.from(T);if(A==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(A))return f(T,k)}}function f(T,k){(k==null||k>T.length)&&(k=T.length);for(var A=0,C=new Array(k);A<k;A++)C[A]=T[A];return C}function m(T,k){if(!(T instanceof k))throw new TypeError("Cannot call a class as a function")}function g(T,k){for(var A=0;A<k.length;A++){var C=k[A];C.enumerable=C.enumerable||!1,C.configurable=!0,"value"in C&&(C.writable=!0),Object.defineProperty(T,C.key,C)}}function S(T,k,A){return k&&g(T.prototype,k),A&&g(T,A),Object.defineProperty(T,"prototype",{writable:!1}),T}function _(T,k,A){return k in T?Object.defineProperty(T,k,{value:A,enumerable:!0,configurable:!0,writable:!0}):T[k]=A,T}var b=(function(){function T(){m(this,T),_(this,"interpreters",new s.NamespacedMap([[t.LEGACY_M_ROOM_MESSAGE,t.parseMRoomMessage],[i.M_MESSAGE,n.parseMMessage],[i.M_EMOTE,n.parseMMessage],[i.M_NOTICE,n.parseMMessage],[o.M_POLL_START,u.parseMPoll],[o.M_POLL_RESPONSE,u.parseMPoll],[o.M_POLL_END,u.parseMPoll]])),_(this,"_unknownInterpretOrder",[i.M_MESSAGE])}return S(T,[{key:"unknownInterpretOrder",get:function(){var A;return(A=this._unknownInterpretOrder)!==null&&A!==void 0?A:[]},set:function(A){this._unknownInterpretOrder=A}},{key:"registerInterpreter",value:function(A,C){this.interpreters.set(A,C)}},{key:"parse",value:function(A){try{if(this.interpreters.hasNamespaced(A.type))return this.interpreters.getNamespaced(A.type)(A);var C=d(this.unknownInterpretOrder),U;try{for(C.s();!(U=C.n()).done;){var O=U.value;if(this.interpreters.has(O)){var M=this.interpreters.get(O)(A);if(M)return M}}}catch(E){C.e(E)}finally{C.f()}return null}catch(E){if(E instanceof e.InvalidEventError)return null;throw E}}}],[{key:"defaultInstance",get:function(){return T._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return T.defaultInstance.unknownInterpretOrder},set:function(A){T.defaultInstance.unknownInterpretOrder=A}},{key:"registerInterpreter",value:function(A,C){T.defaultInstance.registerInterpreter(A,C)}},{key:"parse",value:function(A){return T.defaultInstance.parse(A)}}]),T})();return rl.ExtensibleEvents=b,_(b,"_defaultInstance",new b),rl}var Wh={},Kb;function LC(){return Kb||(Kb=1,Object.defineProperty(Wh,"__esModule",{value:!0})),Wh}var Ta={},Hb;function xC(){if(Hb)return Ta;Hb=1,Object.defineProperty(Ta,"__esModule",{value:!0}),Ta.LegacyMsgType=void 0,Ta.isEventLike=t;var s=Br(),e;Ta.LegacyMsgType=e,(function(n){n.Text="m.text",n.Notice="m.notice",n.Emote="m.emote"})(e||(Ta.LegacyMsgType=e={}));function t(n,i){var o=n.content;return i===e.Text?s.M_MESSAGE.matches(n.type)||n.type==="m.room.message"&&o?.msgtype==="m.text":i===e.Emote?s.M_EMOTE.matches(n.type)||n.type==="m.room.message"&&o?.msgtype==="m.emote":i===e.Notice?s.M_NOTICE.matches(n.type)||n.type==="m.room.message"&&o?.msgtype==="m.notice":!1}return Ta}var Vb;function jC(){return Vb||(Vb=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0});var e=NC();Object.keys(e).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===e[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return e[E]}})});var t=LC();Object.keys(t).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===t[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return t[E]}})});var n=ao();Object.keys(n).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===n[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return n[E]}})});var i=so();Object.keys(i).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===i[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return i[E]}})});var o=W_();Object.keys(o).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===o[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return o[E]}})});var u=Y_();Object.keys(u).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===u[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return u[E]}})});var d=xC();Object.keys(d).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===d[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return d[E]}})});var h=Ha();Object.keys(h).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===h[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return h[E]}})});var f=J_();Object.keys(f).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===f[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return f[E]}})});var m=X_();Object.keys(m).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===m[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return m[E]}})});var g=e0();Object.keys(g).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===g[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return g[E]}})});var S=ym();Object.keys(S).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===S[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return S[E]}})});var _=au();Object.keys(_).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===_[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return _[E]}})});var b=Br();Object.keys(b).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===b[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return b[E]}})});var T=Va();Object.keys(T).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===T[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return T[E]}})});var k=gm();Object.keys(k).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===k[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return k[E]}})});var A=pm();Object.keys(A).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===A[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return A[E]}})});var C=oo();Object.keys(C).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===C[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return C[E]}})});var U=Q_();Object.keys(U).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===U[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return U[E]}})});var O=Z_();Object.keys(O).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===O[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return O[E]}})});var M=$_();Object.keys(M).forEach(function(E){E==="default"||E==="__esModule"||E in s&&s[E]===M[E]||Object.defineProperty(s,E,{enumerable:!0,get:function(){return M[E]}})})})(zh)),zh}var Pn=jC();const BC="modulepreload",FC=function(s){return"/happychating/"+s},Gb={},qC=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){let h=function(f){return Promise.all(f.map(m=>Promise.resolve(m).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=u?.nonce||u?.getAttribute("nonce");i=h(t.map(f=>{if(f=FC(f),f in Gb)return;Gb[f]=!0;const m=f.endsWith(".css"),g=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${g}`))return;const S=document.createElement("link");if(S.rel=m?"stylesheet":BC,m||(S.as="script"),S.crossOrigin="",S.href=f,d&&S.setAttribute("nonce",d),document.head.appendChild(S),m)return new Promise((_,b)=>{S.addEventListener("load",_),S.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(u){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=u,window.dispatchEvent(d),!d.defaultPrevented)throw u}return i.then(u=>{for(const d of u||[])d.status==="rejected"&&o(d.reason);return e().catch(o)})};function KC(s,e){if(s==null)return{};var t={};for(var n in s)if({}.hasOwnProperty.call(s,n)){if(e.indexOf(n)!==-1)continue;t[n]=s[n]}return t}function HC(s,e){if(s==null)return{};var t,n,i=KC(s,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(s);for(n=0;n<o.length;n++)t=o[n],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(s,t)&&(i[t]=s[t])}return i}var Jn=(function(s){return s.DisplayName="User.displayName",s.AvatarUrl="User.avatarUrl",s.Presence="User.presence",s.CurrentlyActive="User.currentlyActive",s.LastPresenceTs="User.lastPresenceTs",s})({});class pi extends Lt{constructor(e){super(),this.userId=e,y(this,"modified",-1),y(this,"displayName",void 0),y(this,"rawDisplayName",void 0),y(this,"avatarUrl",void 0),y(this,"presenceStatusMsg",void 0),y(this,"presence","offline"),y(this,"lastActiveAgo",0),y(this,"lastPresenceTs",0),y(this,"currentlyActive",!1),y(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var n=new pi(e);return t.reEmitter.reEmit(n,[Jn.AvatarUrl,Jn.DisplayName,Jn.Presence,Jn.CurrentlyActive,Jn.LastPresenceTs]),n}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var n=[];(e.getContent().presence!==this.presence||t)&&n.push(Jn.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(Jn.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(Jn.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&n.push(Jn.CurrentlyActive),this.presence=e.getContent().presence,n.push(Jn.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var i of n)this.emit(i,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var Qe=(function(s){return s.Backward="b",s.Forward="f",s})({});class Oe{static setEventMetadata(e,t,n){e.setMetadata(t,n)}constructor(e){var t,n;this.eventTimelineSet=e,y(this,"roomId",void 0),y(this,"name",void 0),y(this,"events",[]),y(this,"baseIndex",0),y(this,"startState",void 0),y(this,"endState",void 0),y(this,"startToken",null),y(this,"endToken",null),y(this,"prevTimeline",null),y(this,"nextTimeline",null),y(this,"paginationRequests",{[Qe.Backward]:null,[Qe.Forward]:null}),this.roomId=(t=(n=e.room)===null||n===void 0?void 0:n.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new $l(this.roomId),this.endState=new $l(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,n,{timelineWasEmpty:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:i}),(n=this.endState)===null||n===void 0||n.setStateEvents(e,{timelineWasEmpty:i})}forkLive(e){var t=this.getState(e),n=new Oe(this.eventTimelineSet);return n.startState=t?.clone(),n.endState=t,this.endState=t?.clone(),n}fork(e){var t=this.getState(e),n=new Oe(this.eventTimelineSet);return n.startState=t?.clone(),n.endState=t?.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==Oe.BACKWARDS)return this.startState;if(e==Oe.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===Qe.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===Qe.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==Oe.BACKWARDS)return this.prevTimeline;if(e==Oe.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==Oe.BACKWARDS)this.prevTimeline=e;else if(t==Oe.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:n,roomState:i,timelineWasEmpty:o,addToState:u}=t;i||(i=n?this.startState:this.endState);var d=this.getTimelineSet();if(d.room&&(Oe.setEventMetadata(e,i,n),u&&e.isState()&&d.room.getUnfilteredTimelineSet()===d)){var h;(h=i)===null||h===void 0||h.setStateEvents([e],{timelineWasEmpty:o}),(!e.sender||e.getType()===Z.RoomMember&&!n)&&Oe.setEventMetadata(e,i,n)}var f;n?f=0:f=this.events.length,this.events.splice(f,0,e),n&&this.baseIndex++}insertEvent(e,t,n,i){var o=this.getTimelineSet();o.room&&(Oe.setEventMetadata(e,n,!1),i&&e.isState()&&o.room.getUnfilteredTimelineSet()===o&&(n.setStateEvents([e],{}),(!e.sender||e.getType()===Z.RoomMember)&&Oe.setEventMetadata(e,n,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}y(Oe,"BACKWARDS",Qe.Backward);y(Oe,"FORWARDS",Qe.Forward);var Fc=(function(s){return s.Add="Relations.add",s.Remove="Relations.remove",s.Redaction="Relations.redaction",s})({}),VC=function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...n].includes(e)};class Sm extends Lt{constructor(e,t,n,i){var o;super(),o=this,this.relationType=e,this.eventType=t,this.altEventTypes=i,y(this,"relationEventIds",new Set),y(this,"relations",new Set),y(this,"annotationsByKey",{}),y(this,"annotationsBySender",{}),y(this,"sortedAnnotationsByKey",[]),y(this,"targetEvent",null),y(this,"creationEmitted",!1),y(this,"client",void 0),y(this,"onEventStatus",(u,d)=>{if(!u.isSending()){u.removeListener(mt.Status,this.onEventStatus);return}d===He.CANCELLED&&(u.removeListener(mt.Status,this.onEventStatus),this.removeEvent(u))}),y(this,"onBeforeRedaction",(function(){var u=D(function*(d){if(o.relations.has(d)){if(o.relations.delete(d),o.relationType===Mt.Annotation)o.removeAnnotationFromAggregation(d);else if(o.relationType===Mt.Replace&&o.targetEvent&&!o.targetEvent.isState()){var h=yield o.getLastReplacement();o.targetEvent.makeReplaced(h)}d.removeListener(mt.BeforeRedaction,o.onBeforeRedaction),o.emit(Fc.Redaction,d)}});return function(d){return u.apply(this,arguments)}})()),this.client=n instanceof hd?n.client:n}addEvent(e){var t=this;return D(function*(){if(!t.relationEventIds.has(e.getId())){var n=e.getRelation();if(!n){N.error("Event must have relation info");return}var i=n.rel_type,o=e.getType();if(t.relationType!==i||!VC(o,t.eventType,t.altEventTypes)){N.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(mt.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===Mt.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===Mt.Replace&&t.targetEvent&&!t.targetEvent.isState()){var u=yield t.getLastReplacement();t.targetEvent.makeReplaced(u)}e.on(mt.BeforeRedaction,t.onBeforeRedaction),t.emit(Fc.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return D(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===Mt.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===Mt.Replace&&t.targetEvent&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();t.targetEvent.makeReplaced(n)}t.emit(Fc.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i||(i=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,i])),i.add(e),this.sortedAnnotationsByKey.sort((d,h)=>{var f=d[1],m=h[1];return m.size-f.size});var o=e.getSender(),u=this.annotationsBySender[o];u||(u=this.annotationsBySender[o]=new Set),u.add(e)}}removeAnnotationFromAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i&&(i.delete(e),this.sortedAnnotationsByKey.sort((d,h)=>{var f=d[1],m=h[1];return m.size-f.size}));var o=e.getSender(),u=this.annotationsBySender[o];u&&u.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==Mt.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Mt.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return D(function*(){if(e.relationType!==Mt.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(Mt.Replace),n=t?.origin_server_ts,i=e.getRelations().reduce((o,u)=>u.getSender()!==e.targetEvent.getSender()||n&&n>u.getTs()||o&&o.getTs()>u.getTs()?o:u,null);return i!=null&&i.shouldAttemptDecryption()&&e.client.getCrypto()?yield i.attemptDecryption(e.client.getCrypto()):i!=null&&i.isBeingDecrypted()&&(yield i.getDecryptionPromise()),i})()}setTargetEvent(e){var t=this;return D(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===Mt.Replace&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();n&&t.targetEvent.makeReplaced(n)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(mt.RelationsCreated,this.relationType,this.eventType))}}class t0{constructor(e,t){this.client=e,this.room=t,y(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var i;return(i=this.relations.get(e))===null||i===void 0||(i=i.get(t))===null||i===void 0?void 0:i.get(n)}getAllChildEventsForEvent(e){var t,n=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,i=[];for(var o of n.values())for(var u of o.values())i.push(...u.getRelations());return i}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var n of t.values())for(var i of n.values())i.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===He.CANCELLED)){var n=e.getRelation();if(n){var i=()=>{if(e.isDecryptionFailure()){e.once(mt.Decrypted,i);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(mt.Decrypted,i);return}var{event_id:o,rel_type:u}=n,d=e.getType(),h=this.relations.get(o);h||(h=new Map,this.relations.set(o,h));var f=h.get(u);f||(f=new Map,h.set(u,f));var m=f.get(d);if(!m){var g,S,_;m=new Sm(u,d,this.client),f.set(d,m);var b=(g=this.room)!==null&&g!==void 0?g:t?.room,T=(S=(_=t?.findEventById(o))!==null&&_!==void 0?_:b?.findEventById(o))!==null&&S!==void 0?S:b?.getPendingEvent(o);T&&m.setTargetEvent(T)}m.addEvent(e)}}}}var Bs;Bs=N.log.bind(N);var Pl=(function(s){return s.Ignore="ignore",s.Replace="replace",s})({});class qs extends Lt{constructor(e){var t,n,i,o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=arguments.length>2?arguments[2]:void 0,d=arguments.length>3?arguments[3]:void 0,h=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=d,this.threadListType=h,y(this,"relations",void 0),y(this,"timelineSupport",void 0),y(this,"displayPendingEvents",void 0),y(this,"liveTimeline",void 0),y(this,"timelines",void 0),y(this,"_eventIdToTimeline",new Map),y(this,"filter",void 0),this.timelineSupport=!!o.timelineSupport,this.liveTimeline=new Oe(this),this.displayPendingEvents=o.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=o.filter,this.relations=(t=(n=this.room)===null||n===void 0?void 0:n.relations)!==null&&t!==void 0?t:new t0((i=e?.client)!==null&&i!==void 0?i:u)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){var n=!this.timelineSupport||!t,i=this.liveTimeline,o=n?i.forkLive(Oe.FORWARDS):i.fork(Oe.FORWARDS);n?(this.timelines=[o],this._eventIdToTimeline=new Map):this.timelines.push(o),t&&i.setPaginationToken(t,Oe.FORWARDS),o.setPaginationToken(e??null,Oe.BACKWARDS),this.liveTimeline=o,this.emit(ke.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(n){return n.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new Oe(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,i,o){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var u=t?Oe.BACKWARDS:Oe.FORWARDS,d=t?Oe.FORWARDS:Oe.BACKWARDS,h=!1,f=!1;for(var m of e){var g=m.getId(),S=this._eventIdToTimeline.get(g);if(!S){this.addEventToTimeline(m,i,{toStartOfTimeline:t,addToState:n}),f=!0,h=!0;continue}if(f=!1,S==i){Bs("Event "+g+" already in timeline "+i);continue}var _=i.getNeighbouringTimeline(u);if(_){S==_?Bs("Event "+g+" in neighbouring timeline - switching to "+S):Bs("Event "+g+" already in a different timeline "+S),i=S;continue}N.info("Already have timeline for "+g+" - joining timeline "+i+" to "+S);var b=S===this.liveTimeline,T=i===this.liveTimeline,k=u===Oe.BACKWARDS&&b,A=u===Oe.FORWARDS&&T;if(k||A){k&&N.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+S+")"),A&&N.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(S,u),S.setNeighbouringTimeline(i,d),i=S,h=!0}if(f||!h){if(u===Oe.FORWARDS&&i===this.liveTimeline){N.warn({lastEventWasNew:f,didUpdate:h}),N.warn("Refusing to set forwards pagination token of live timeline "+"".concat(i," to ").concat(o));return}i.setPaginationToken(o??null,u)}}}addLiveEvent(e,t){var{duplicateStrategy:n,fromCache:i,roomState:o,timelineWasEmpty:u,addToState:d}=t;if(this.filter){var h=this.filter.filterRoomTimeline([e]);if(!h.length)return}var f=this._eventIdToTimeline.get(e.getId());if(f){if(n===Pl.Replace){Bs("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var m=f.getEvents(),g=0;g<m.length;g++)if(m[g].getId()===e.getId()){o||(o=f.getState(Oe.FORWARDS)),Oe.setEventMetadata(e,o,!1),m[g]=e;break}}else Bs("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:o,timelineWasEmpty:u,addToState:d})}addEventToTimeline(e,t,n){var{toStartOfTimeline:i,fromCache:o=!1,roomState:u,timelineWasEmpty:d,addToState:h}=n;if(t.getTimelineSet()!==this){var f;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((f=this.thread)===null||f===void 0?void 0:f.id,")"))}var m=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var g,S="event=".concat(m);e.threadRootId&&(S+="(belongs to thread=".concat(e.threadRootId,")")),N.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(S," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((g=this.thread)===null||g===void 0?void 0:g.id,")"));return}t.addEvent(e,{toStartOfTimeline:i,roomState:u,timelineWasEmpty:d,addToState:h}),this._eventIdToTimeline.set(m,t);var _={timeline:t,liveEvent:!i&&t==this.liveTimeline&&!o};this.emit(ke.Timeline,e,this.room,!!i,!1,_)}insertEventIntoTimeline(e,t,n,i){if(t.getTimelineSet()!==this){var o;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((o=this.thread)===null||o===void 0?void 0:o.id,")"))}var u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var d,h="event=".concat(u);e.threadRootId&&(h+="(belongs to thread=".concat(e.threadRootId,")")),N.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(h," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((d=this.thread)===null||d===void 0?void 0:d.id,")"));return}var f=e.relationEventId;if(!f){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:n,addToState:i});return}for(var m=this.findEventById(f),g=t.getEvents(),S=m!==void 0?g.indexOf(m):0,_=S;_<g.length;_++){var b=g[_];if(b.getTs()>e.getTs())break}t.insertEvent(e,_,n,i),this._eventIdToTimeline.set(u,t);var T={timeline:t,liveEvent:!1};this.emit(ke.Timeline,e,this.room,!1,!1,T)}handleRemoteEcho(e,t,n){var i=this._eventIdToTimeline.get(t);i?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,i)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);var i={timeline:t};this.emit(ke.Timeline,n,this.room,void 0,!0,i)}return n}compareEventOrdering(e,t){if(e==t)return 0;var n=this._eventIdToTimeline.get(e),i=this._eventIdToTimeline.get(t);if(n===void 0||i===void 0)return null;if(n===i){for(var o=void 0,u=void 0,d=n.getEvents(),h=0;h<d.length&&(o===void 0||u===void 0);h++){var f=d[h].getId();f==e&&(o=h),f==t&&(u=h)}var m=o-u;return m<0?-1:m>0?1:0}for(var g=n;g;){if(g===i)return-1;g=g.getNeighbouringTimeline(Oe.FORWARDS)}for(g=n;g;){if(g===i)return 1;g=g.getNeighbouringTimeline(Oe.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!n&&!i){var o;N.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((o=this.room)===null||o===void 0?void 0:o.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return n}}var He=(function(s){return s.NOT_SENT="not_sent",s.ENCRYPTING="encrypting",s.SENDING="sending",s.QUEUED="queued",s.SENT="sent",s.CANCELLED="cancelled",s})({});class n0{constructor(e,t){this.roomId=e}}class r0{constructor(e){this.target=e,y(this,"reEmitters",new WeakMap)}reEmit(e,t){var n=this,i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));var o=function(h){if(i.has(h))return 1;var f=function(){if(!(h==="error"&&n.target.listenerCount("error")===0)){for(var g=arguments.length,S=new Array(g),_=0;_<g;_++)S[_]=arguments[_];n.target.emit(h,...S,e)}};e.on(h,f),i.set(h,f)};for(var u of t)o(u)}stopReEmitting(e,t){var n=this.reEmitters.get(e);if(n){for(var i of t)e.off(i,n.get(i)),n.delete(i);n.size===0&&this.reEmitters.delete(e)}}}class lo extends r0{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var Vl=new od("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function GC(s,e){if(e.endsWith("*")){var t=e.slice(0,-1);return s.slice(0,t.length)===t}else return s===e}class zb{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n,i=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},o=Object.keys(i),u=[];return this.userId&&i!==null&&i!==void 0&&(n=i[wt.name])!==null&&n!==void 0&&n.current_user_participated&&u.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,o,u)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[Ws.name]:this.filterJson[Ws.name],[Ys.name]:this.filterJson[Ys.name]}).filter(e=>{var[t,n]=e;return n}))}checkFields(e,t,n,i,o,u){var d={rooms:function(A){return e===A},senders:function(A){return t===A},types:function(A){return GC(n,A)}};for(var h in d){var f=d[h],m="not_"+h,g=this.filterJson[m];if(g!=null&&g.some(f))return!1;var S=this.filterJson[h];if(S&&!S.some(f))return!1}var _=this.filterJson.contains_url;if(_!==void 0&&_!==i)return!1;var b=this.filterJson[Ys.name];if(b!==void 0&&!this.arrayMatchesFilter(b,o))return!1;var T=this.filterJson[Ws.name];return!(T!==void 0&&!this.arrayMatchesFilter(T,u))}arrayMatchesFilter(e,t){return t.length>0&&e.every(n=>t.includes(n))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function Wb(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Us(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Wb(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Wb(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function Yh(s,e,t){for(var n=e.split("."),i=s,o=0;o<n.length-1;o++)i[n[o]]||(i[n[o]]={}),i=i[n[o]];i[n[n.length-1]]=t}class Qn{static fromJson(e,t,n){var i=new Qn(e,t);return i.setDefinition(n),i}constructor(e,t){this.userId=e,this.filterId=t,y(this,"definition",{}),y(this,"roomFilter",void 0),y(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new zb(n,this.userId),this.roomTimelineFilter=new zb(t?.timeline||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){Yh(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,n;this.definition=Us(Us({},this.definition),{},{room:Us(Us({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:Us(Us({},(n=this.definition)===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.timeline),{},{[Vl.name]:e})})})}setLazyLoadMembers(e){Yh(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){Yh(this.definition,"room.include_leave",e)}}y(Qn,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function $c(s){return s!=null}var zC=new Pn.UnstableValue("m.message","org.matrix.msc1767.message"),bm=new Pn.UnstableValue("m.text","org.matrix.msc1767.text"),WC=new Pn.UnstableValue("m.html","org.matrix.msc1767.html"),i0=new Pn.NamespacedValue("m.reference");function YC(s,e){if(typeof s=="string")return typeof e=="string"?e===s:e.matches(s);if(typeof e=="string")return s.matches(e);var t=e,n=s;return t.matches(n.name)||$c(n.altName)&&t.matches(n.altName)}var Em=new io("m.topic");function Yb(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function JC(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Yb(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Yb(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function a0(s,e){return{msgtype:jr.Text,format:"org.matrix.custom.html",body:s,formatted_body:e}}function s0(s,e){return{msgtype:jr.Notice,format:"org.matrix.custom.html",body:s,formatted_body:e}}function o0(s,e){return{msgtype:jr.Emote,format:"org.matrix.custom.html",body:s,formatted_body:e}}function l0(s){return{msgtype:jr.Text,body:s}}function u0(s){return{msgtype:jr.Notice,body:s}}function c0(s){return{msgtype:jr.Emote,body:s}}var d0=(s,e,t,n)=>{var i="at ".concat(new Date(t).toISOString()),o=e===Js.Self?"User":void 0,u=n?'"'.concat(n,'"'):void 0;return[o,"Location",u,s,i].filter(Boolean).join(" ")},f0=(s,e,t,n,i)=>{var o=s??d0(e,i||Js.Self,t,n),u=t?{[na.name]:t}:{};return JC({msgtype:jr.Location,body:o,geo_uri:e,[tu.name]:{description:n,uri:e},[eu.name]:{type:i||Js.Self},[bm.name]:o},u)},XC=s=>{var e,t,n=tu.findIn(s),i=eu.findIn(s),o=na.findIn(s),u=bm.findIn(s),d=(e=n?.uri)!==null&&e!==void 0?e:s?.geo_uri,h=n?.description,f=(t=i?.type)!==null&&t!==void 0?t:Js.Self,m=u??s.body;return f0(m,d,o??void 0,h,f)},h0=(s,e)=>{var t=[];return $c(e)&&t.push({body:e,mimetype:"text/html"}),$c(s)&&t.push({body:s,mimetype:"text/plain"}),{topic:s,[Em.name]:{"m.text":t}}},QC=s=>{var e,t,n,i,o=Em.findIn(s),u=Array.isArray(o)?o:o?.["m.text"];if(!Array.isArray(u)){var d;return{text:(d=s.topic)!==null&&d!==void 0?d:void 0}}var h=(e=(t=u==null||(n=u.find(m=>!$c(m.mimetype)||m.mimetype==="text/plain"))===null||n===void 0?void 0:n.body)!==null&&t!==void 0?t:s.topic)!==null&&e!==void 0?e:void 0,f=u==null||(i=u.find(m=>m.mimetype==="text/html"))===null||i===void 0?void 0:i.body;return{text:h,html:f}},ZC=(s,e,t,n,i)=>({description:t,timeout:s,live:e,[na.name]:i||Date.now(),[eu.name]:{type:n??Js.Self}}),v0=s=>{var e,{description:t,timeout:n,live:i}=s,o=(e=na.findIn(s))!==null&&e!==void 0?e:void 0,u=eu.findIn(s);return{description:t,timeout:n,live:i,assetType:u?.type,timestamp:o}},$C=(s,e,t,n)=>({[tu.name]:{description:n,uri:s},[na.name]:e,"m.relates_to":{rel_type:i0.name,event_id:t}}),Iv=s=>{var e,t=tu.findIn(s),n=(e=na.findIn(s))!==null&&e!==void 0?e:void 0;return{description:t?.description,uri:t?.uri,timestamp:n}};const eI=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:d0,makeBeaconContent:$C,makeBeaconInfoContent:ZC,makeEmoteMessage:c0,makeHtmlEmote:o0,makeHtmlMessage:a0,makeHtmlNotice:s0,makeLocationContent:f0,makeNotice:u0,makeTextMessage:l0,makeTopicContent:h0,parseBeaconContent:Iv,parseBeaconInfoContent:v0,parseLocationEvent:XC,parseTopicContent:QC},Symbol.toStringTag,{value:"Module"}));var Nt=(function(s){return s.New="Beacon.new",s.Update="Beacon.update",s.LivenessChange="Beacon.LivenessChange",s.Destroy="Beacon.Destroy",s.LocationUpdate="Beacon.LocationUpdate",s})({}),Ov=(s,e,t)=>t>=s&&s+e>=t,ed=s=>"".concat(s.getRoomId(),"_").concat(s.getStateKey());class m0 extends Lt{constructor(e){super(),this.rootEvent=e,y(this,"roomId",void 0),y(this,"_beaconInfo",void 0),y(this,"_isLive",void 0),y(this,"livenessWatchTimeout",void 0),y(this,"_latestLocationEvent",void 0),y(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(Nt.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return ed(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&Iv(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(ed(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(Nt.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(Nt.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var n=e.filter(o=>{var u=o.getContent(),d=Iv(u);if(!d.uri||!d.timestamp)return!1;var{timestamp:h}=d;return this._beaconInfo.timestamp&&Ov(this._beaconInfo.timestamp,this._beaconInfo.timeout,h)&&(!this.latestLocationState||h>this.latestLocationState.timestamp)}),i=(t=n.sort(bC))===null||t===void 0?void 0:t[0];i&&(this._latestLocationEvent=i,this.emit(Nt.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=v0(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&Ov(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(Nt.LivenessChange,this.isLive,this)}}}function Jb(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function tI(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Jb(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Jb(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function p0(s,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new yn({content:{[e.getId()]:{[t]:{[s]:tI({ts:e.getTs()},!n&&{thread_id:ro(e)})}}},type:Z.Receipt,room_id:e.getRoomId()})}var Ps=0,Ns=1;class g0 extends Lt{constructor(){super(...arguments),y(this,"receipts",new mi(()=>new Map)),y(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Tn.Read,[u,d]=(t=(n=this.receipts.get(o))===null||n===void 0?void 0:n.get(e))!==null&&t!==void 0?t:[null,null];return i?u:d??u}compareReceipts(e,t){var n;return(n=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&n!==void 0?n:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=this.getLatestReceipt(e,t);return n&&this.receiptPointsAtConsistentEvent(n)?n.eventId:null}receiptPointsAtConsistentEvent(e){var t,n=this.findEventById(e.eventId);if(!n)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===nu){var i=Zl(n);if(i)return!0}else if(n.threadRootId===e.data.thread_id)return!0;return N.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(n.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var n,i,o=this.getReadReceiptForUserId(e,t,Tn.Read),u=this.getReadReceiptForUserId(e,t,Tn.ReadPrivate),d;return o!=null&&o.eventId&&u!==null&&u!==void 0&&u.eventId&&(d=this.compareReceipts(o,u)),d?(i=d<0?u:o)!==null&&i!==void 0?i:null:(n=u??o)!==null&&n!==void 0?n:null}addReceiptToStructure(e,t,n,i,o){var u,d,h=this.receipts.getOrCreate(t),f=h.get(n);f||(f=[null,null],h.set(n,f));var m=f[Ps];if(o){var g;m=(g=f[Ns])!==null&&g!==void 0?g:f[Ps]}var S={eventId:e,data:i};if(m){var _=this.compareReceipts(m,S);if(_>=0)return}var b=o?f[Ps]:S,T=o?S:f[Ns],k=null;b&&T&&(k=this.getUnfilteredTimelineSet().compareEventOrdering(b.eventId,T.eventId));var A=k===null||k<0,C=(u=f[Ns])!==null&&u!==void 0?u:f[Ps];o&&A?f[Ns]=S:o||(f[Ps]=S,A||(f[Ns]=null));var U=(d=f[Ns])!==null&&d!==void 0?d:f[Ps];if(C!==U){if(C&&this.receiptCacheByEventId.get(C.eventId)){var O=C.eventId;this.receiptCacheByEventId.set(O,this.receiptCacheByEventId.get(O).filter(M=>M.type!==t||M.userId!==n)),this.receiptCacheByEventId.get(O).length<1&&this.receiptCacheByEventId.delete(O)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:i})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&t?.eventId===n.getId()&&e===n.getSender()&&(this.setUnread(ht.Total,0),this.setUnread(ht.Highlight,0))}addLocalEchoReceipt(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(p0(e,t,n,i),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return hm(t.type)}).map(function(t){return t.userId})}}var nI=new Pn.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),rI=new Pn.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),iI=new Pn.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),Gl=new Pn.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),td=new Pn.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),zi=(function(s){return s.New="Poll.new",s.End="Poll.end",s.Update="Poll.update",s.Responses="Poll.Responses",s.Destroy="Poll.Destroy",s.UndecryptableRelations="Poll.UndecryptableRelations",s})({}),Xb=(s,e)=>{var t=s.filter(n=>{if(!n.isDecryptionFailure())return Gl.matches(n.getType())&&n.getTs()<=e});return{responseEvents:t}};class y0 extends Lt{constructor(e,t,n){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=n,y(this,"roomId",void 0),y(this,"pollEvent",void 0),y(this,"_isFetchingResponses",!1),y(this,"relationsNextBatch",void 0),y(this,"responses",null),y(this,"endEvent",void 0),y(this,"undecryptableRelationEventIds",new Set),y(this,"countUndecryptableEvents",i=>{var o=i.filter(d=>d.isDecryptionFailure()).map(d=>d.getId()),u=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...o]),this.undecryptableRelationsCount!==u&&this.emit(zi.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return D(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(td.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(zi.End)),!!this.responses){var n=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=Xb([e],n);this.countUndecryptableEvents([e]),i.length&&(i.forEach(o=>{this.responses.addEvent(o)}),this.emit(zi.Responses,this.responses))}}fetchResponses(){var e=this;return D(function*(){var t,n;e._isFetchingResponses=!0;var i=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(i.events.map(f=>e.matrixClient.decryptEventIfNeeded(f)));var o=e.responses||new Sm("m.reference",Gl.name,e.matrixClient,[Gl.altName]),u=i.events.find(f=>td.matches(f.getType()));e.validateEndEvent(u)&&(e.endEvent=u,e.refilterResponsesOnEnd(),e.emit(zi.End));var d=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:h}=Xb(i.events,d);h.forEach(f=>{o.addEvent(f)}),e.relationsNextBatch=(n=i.nextBatch)!==null&&n!==void 0?n:void 0,e.responses=o,e.countUndecryptableEvents(i.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(zi.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(n=>{if(n.getTs()>t){var i;(i=this.responses)===null||i===void 0||i.removeEvent(n)}}),this.emit(zi.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,n=e.getSender();return!!n&&(n===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,n))}}var S0=s=>{var e=s.getType();return Pn.M_POLL_START.matches(e)||Gl.matches(e)||td.matches(e)};class aI{constructor(e){y(this,"room",void 0),y(this,"threadedReceipts",void 0),y(this,"unthreadedReceipts",void 0),y(this,"danglingReceipts",void 0),y(this,"onTimelineEvent",t=>{var n=t.getId();if(n){var i=this.danglingReceipts.remove(n);i?.forEach(o=>{o.receipt.thread_id?this.threadedReceipts.set(o.receipt.thread_id,o.eventId,o.receiptType,o.userId,o.receipt.ts,o.synthetic):this.unthreadedReceipts.set(n,o.receiptType,o.userId,o.receipt.ts,o.synthetic)})}}),this.room=e,this.threadedReceipts=new uI(e),this.unthreadedReceipts=new b0(e),this.danglingReceipts=new cI,e.on(ke.Timeline,this.onTimelineEvent)}add(e,t){for(var[n,i]of Object.entries(e))for(var[o,u]of Object.entries(i))for(var[d,h]of Object.entries(u)){var f=this.room.findEventById(n);f?h.thread_id?this.threadedReceipts.set(h.thread_id,n,o,d,h.ts,t):this.unthreadedReceipts.set(n,o,d,h.ts,t):this.danglingReceipts.add(new oI(n,o,d,h,t))}}hasUserReadEvent(e,t){var n=this.unthreadedReceipts.get(e);if(n&&Mv(n.eventId,t,this.room))return!0;var i=this.room.findEventById(t);if(!i)return N.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var o=ro(i),u=this.threadedReceipts.get(o,e);return!!(u&&Mv(u.eventId,t,this.room)||this.userSentLatestEventInThread(o,e))}userSentLatestEventInThread(e,t){var n,i=e===nu?this.room.getLiveTimeline().getEvents():(n=this.room.getThread(e))===null||n===void 0?void 0:n.timeline;return!!(i&&i.length>0&&i[i.length-1].getSender()===t)}}class sI{constructor(e,t,n){this.eventId=e,this.receiptType=t,this.ts=n}}class oI{constructor(e,t,n,i,o){this.eventId=e,this.receiptType=t,this.userId=n,this.receipt=i,this.synthetic=o}}class lI{constructor(e){y(this,"room",void 0),y(this,"real",void 0),y(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&Mv(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class b0{constructor(e){y(this,"room",void 0),y(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,o){var u=_m(this.data,n,()=>new lI(this.room)),d=u.getByType(o);d&&dI(d.eventId,e,this.room)||u.set(o,new sI(e,t,i))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class uI{constructor(e){y(this,"room",void 0),y(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,o,u){var d=_m(this.data,e,()=>new b0(this.room));d.set(t,n,i,o,u)}get(e,t){var n;return(n=this.data.get(e))===null||n===void 0?void 0:n.get(t)}}class cI{constructor(){y(this,"data",new Map)}add(e){var t=_m(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function _m(s,e,t){var n=s.get(e);if(n)return n;var i=t();return s.set(e,i),i}function Mv(s,e,t){var n=t.compareEventOrdering(s,e);return n!==null&&n>=0}function dI(s,e,t){var n=t.compareEventOrdering(s,e);return n!==null&&n>0}function fI(s,e,t){var n=s.findEventById(e),i=s.findEventById(t);if(!n||!i)return null;var o=Zl(n),u=Zl(i);return o&&u?hI(s,e,t,n,i):vI(e,t,n,i)}function hI(s,e,t,n,i){var o=s.getUnfilteredTimelineSet(),u=o.compareEventOrdering(e,t);if(u!==null)return u;var d=o.getTimelineForEvent(e);if(d===o.getLiveTimeline())return 1;var h=o.getTimelineForEvent(t);return h===o.getLiveTimeline()?-1:E0(n,i)}function vI(s,e,t,n){var i=ro(t),o=ro(n),u=t.getThread();return u&&i===o?u.timelineSet.compareEventOrdering(s,e):E0(t,n)}function E0(s,e){var t=s.getTs(),n=e.getTs();return t<n?-1:t>n?1:0}var se=(function(s){return s.Get="GET",s.Put="PUT",s.Post="POST",s.Delete="DELETE",s.Options="OPTIONS",s.Head="HEAD",s.Patch="PATCH",s})({});function Qb(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function mI(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Qb(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Qb(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}class Ka extends Error{constructor(e,t,n){super(e),this.httpStatus=t,this.httpHeaders=n}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var n=Number.parseInt(t)*1e3;if(!Number.isFinite(n))throw new Error("Retry-After header integer value is too large");return n}var i=new Date(t);if(i.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return i.getTime()-Date.now()}return null}}class Dt extends Ka{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,u=e.error||"Unknown message";t&&(u="[".concat(t,"] ").concat(u)),n&&(u="".concat(u," (").concat(n,")")),super("MatrixError: ".concat(u),t,o),this.url=n,this.event=i,y(this,"errcode",void 0),y(this,"error",void 0),y(this,"data",void 0),this.errcode=e.errcode,this.error=e.error,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,n,i,o={};if(this.httpHeaders)for(var[u,d]of this.httpHeaders)o[u]=d;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:o,url:(t=this.url)!==null&&t!==void 0?t:"",response:mI({errcode:(n=this.errcode)!==null&&n!==void 0?n:"M_UNKNOWN",error:(i=this.data.error)!==null&&i!==void 0?i:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new Dt(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function Tm(s,e){if(!(s instanceof Ka)||!s.isRateLimitError())return e;try{var t;return(t=s.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}class Ga extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}class _0 extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}}class Rm extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}}var T0=new io(null,"ORG.MATRIX.MSC4387_SAFETY");class R0 extends Dt{constructor(){super(...arguments),y(this,"harms",void 0),y(this,"expiry",void 0);var e=arguments.length<=0?void 0:arguments[0];this.harms=new Set(e&&"harms"in e&&Array.isArray(e.harms)?e.harms:[]),this.message="".concat(super.message," (").concat([...this.harms].join(", "),")"),e&&"expiry"in e&&typeof e.expiry=="number"&&(this.expiry=new Date(e.expiry))}}var Av=(function(s){return s.SessionLoggedOut="Session.logged_out",s.NoConsent="no_consent",s})({}),wc={};var Zb;function pI(){if(Zb)return wc;Zb=1;var s=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,e=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,t=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,n=/\\([\u000b\u0020-\u00ff])/g,i=/([\\"])/g,o=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;wc.format=u,wc.parse=d;function u(g){if(!g||typeof g!="object")throw new TypeError("argument obj is required");var S=g.parameters,_=g.type;if(!_||!o.test(_))throw new TypeError("invalid type");var b=_;if(S&&typeof S=="object")for(var T,k=Object.keys(S).sort(),A=0;A<k.length;A++){if(T=k[A],!t.test(T))throw new TypeError("invalid parameter name");b+="; "+T+"="+f(S[T])}return b}function d(g){if(!g)throw new TypeError("argument string is required");var S=typeof g=="object"?h(g):g;if(typeof S!="string")throw new TypeError("argument string is required to be a string");var _=S.indexOf(";"),b=_!==-1?S.slice(0,_).trim():S.trim();if(!o.test(b))throw new TypeError("invalid media type");var T=new m(b.toLowerCase());if(_!==-1){var k,A,C;for(s.lastIndex=_;A=s.exec(S);){if(A.index!==_)throw new TypeError("invalid parameter format");_+=A[0].length,k=A[1].toLowerCase(),C=A[2],C.charCodeAt(0)===34&&(C=C.slice(1,-1),C.indexOf("\\")!==-1&&(C=C.replace(n,"$1"))),T.parameters[k]=C}if(_!==S.length)throw new TypeError("invalid parameter format")}return T}function h(g){var S;if(typeof g.getHeader=="function"?S=g.getHeader("content-type"):typeof g.headers=="object"&&(S=g.headers&&g.headers["content-type"]),typeof S!="string")throw new TypeError("content-type header is missing from object");return S}function f(g){var S=String(g);if(t.test(S))return S;if(S.length>0&&!e.test(S))throw new TypeError("invalid parameter value");return'"'+S.replace(i,"\\$1")+'"'}function m(g){this.parameters=Object.create(null),this.type=g}return wc}var gI=pI();function fd(s){var e=new AbortController;return setTimeout(()=>{e.abort()},s),e.signal}function w0(s){var e=new AbortController;function t(){for(var o of s)o.removeEventListener("abort",n)}function n(){e.abort(),t()}for(var i of s){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:e.signal,cleanup:t}}function wm(s,e){var t,n,i=Jh(s)?new Headers(s.getAllResponseHeaders().trim().split(/[\r\n]+/).map(d=>{var h=d.indexOf(":");return[d.substring(0,h),d.substring(h+1)]})):s.headers,o;try{o=yI(i)}catch(d){return d}if(((t=o)===null||t===void 0?void 0:t.type)==="application/json"&&e){var u=JSON.parse(e);return u.errcode&&T0.matches(u.errcode)?new R0(u,s.status,Jh(s)?s.responseURL:s.url,void 0,i):new Dt(u,s.status,Jh(s)?s.responseURL:s.url,void 0,i)}return((n=o)===null||n===void 0?void 0:n.type)==="text/plain"?new Ka("Server returned ".concat(s.status," error: ").concat(e),s.status,i):new Ka("Server returned ".concat(s.status," error"),s.status,i)}function Jh(s){return"getResponseHeader"in s}function yI(s){var e=s.get("Content-Type");if(e===null)return null;try{return gI.parse(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function Dv(s,e){return kv.apply(this,arguments)}function kv(){return kv=D(function*(s,e){for(var t=0,n=null;t<s;)try{if(t>0){var i=1e3*Math.pow(2,t);N.log("network operation failed ".concat(t," times, retrying in ").concat(i,"ms...")),yield iu(i)}return yield e()}catch(o){if(o instanceof Ga)t+=1,n=o;else throw o}throw n}),kv.apply(this,arguments)}function C0(s,e,t){return e>4||s instanceof Ga&&!t||s.httpStatus&&Math.floor(s.httpStatus/100)===4&&s.httpStatus!==429||s.name==="AbortError"||s.name==="M_TOO_LARGE"?-1:Tm(s,1e3*Math.pow(2,e))}var Wi=(function(s){return s.Success="success",s.Failure="failure",s.Logout="logout",s})({}),SI=500,bI=60*1e3;class EI{constructor(e){this.opts=e,y(this,"tokenRefreshPromise",void 0),y(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return D(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return D(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=SI&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var n=this;return D(function*(){return n._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var n=this;return D(function*(){if(e!=null&&e.expiry){var i=e.expiry.getTime()-Date.now();if(i>=bI)return Wi.Logout}if(!e||e?.accessToken===n.opts.accessToken){var o;(o=n.tokenRefreshPromise)!==null&&o!==void 0||(n.tokenRefreshPromise=n.doTokenRefresh(t));try{return yield n.tokenRefreshPromise}finally{n.tokenRefreshPromise=void 0}}return Wi.Success})()}doTokenRefresh(e){var t=this;return D(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var n;return(n=t.opts.logger)===null||n===void 0||n.error("Unable to refresh token - no refresh token or refresh function"),Wi.Logout}e&&e>1&&(yield iu(1e3*Math.min(32,2**e)));try{var i,o;(i=t.opts.logger)===null||i===void 0||i.debug("Attempting to refresh token");var{accessToken:u,refreshToken:d,expiry:h}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=u,t.opts.refreshToken=d,t.latestTokenRefreshExpiry=h,(o=t.opts.logger)===null||o===void 0||o.debug("... token refresh complete, new token expiry:",h),Wi.Success}catch(g){var f;if(g instanceof Rm||g instanceof Dt){var m;return(m=t.opts.logger)===null||m===void 0||m.error("Failed to refresh token",g),Wi.Logout}return(f=t.opts.logger)===null||f===void 0||f.warn("Failed to refresh token",g),Wi.Failure}})()}}function $b(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function eE(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$b(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):$b(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}class _I{constructor(e,t){var n;if(this.eventEmitter=e,this.opts=t,y(this,"abortController",new AbortController),y(this,"tokenRefresher",void 0),P_(t,["baseUrl","prefix"]),!t.onlyData)throw new Error("Constructing FetchHttpApi without `onlyData=true` is no longer supported.");t.useAuthorizationHeader=(n=t.useAuthorizationHeader)!==null&&n!==void 0?n:!0,this.tokenRefresher=new EI(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,n,i,o){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var u=void 0,d=void 0;e===se.Get?u=n:d=n;var h=this.getUrl(t,u,i,this.opts.idBaseUrl),f={json:!0,headers:{}};return o&&(f.headers.Authorization="Bearer ".concat(o)),this.requestOtherUrl(e,h,d,f)}authedRequest(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,n,i,o)}doAuthedRequest(e,t,n,i,o){var u=arguments,d=this;return D(function*(){var h=u.length>5&&u[5]!==void 0?u[5]:{},f=ru(h);f.abortSignal=h.abortSignal;var m=yield d.tokenRefresher.prepareForRequest();m.accessToken&&(d.opts.useAuthorizationHeader?(f.headers||(f.headers={}),f.headers.Authorization||(f.headers.Authorization="Bearer ".concat(m.accessToken)),i.access_token&&delete i.access_token):i.access_token||(i.access_token=m.accessToken));try{var g=yield d.request(t,n,i,o,f);return g}catch(_){if(!(_ instanceof Dt))throw _;if(_.errcode==="M_UNKNOWN_TOKEN"){var S=yield d.tokenRefresher.handleUnknownToken(m,e);if(S===Wi.Success)return d.doAuthedRequest(e+1,t,n,i,o,h);if(S===Wi.Failure)throw new _0(_);f!=null&&f.inhibitLogoutEmit||d.eventEmitter.emit(Av.SessionLoggedOut,_)}else _.errcode=="M_CONSENT_NOT_GIVEN"&&d.eventEmitter.emit(Av.NoConsent,_.message,_.data.consent_uri);throw _}})()}request(e,t,n,i,o){var u=this.getUrl(t,n,o?.prefix,o?.baseUrl);return this.requestOtherUrl(e,u,i,o)}requestOtherUrl(e,t,n){var i=arguments,o=this;return D(function*(){var u,d,h,f,m=i.length>3&&i[3]!==void 0?i[3]:{};if(m.json!==void 0&&m.rawResponseBody!==void 0)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var g=o.sanitizeUrlForLogs(t);(u=o.opts.logger)===null||u===void 0||u.debug("FetchHttpApi: --> ".concat(e," ").concat(g));var S=Object.assign({},m.headers||{}),_=!m.rawResponseBody&&m.json!==!1;_&&(S.Accept||(S.Accept="application/json"));var b=(d=m.localTimeoutMs)!==null&&d!==void 0?d:o.opts.localTimeoutMs,T=(h=m.keepAlive)!==null&&h!==void 0?h:!1,k=[o.abortController.signal];b!==void 0&&k.push(fd(b)),m.abortSignal&&k.push(m.abortSignal);var A;m.json!==!1&&(n==null||(f=n.constructor)===null||f===void 0?void 0:f.name)===Object.name?(A=JSON.stringify(n),S["Content-Type"]||(S["Content-Type"]="application/json")):A=n;var{signal:C,cleanup:U}=w0(k),O="Authorization"in S?void 0:"no-cache",M,E=Date.now();try{var I;M=yield o.fetch(t,{signal:C,method:e,body:A,headers:S,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:O,credentials:"omit",keepalive:T,priority:m.priority}),(I=o.opts.logger)===null||I===void 0||I.debug("FetchHttpApi: <-- ".concat(e," ").concat(g," [").concat(Date.now()-E,"ms ").concat(M.status,"]"))}catch(q){var w;throw(w=o.opts.logger)===null||w===void 0||w.debug("FetchHttpApi: <-- ".concat(e," ").concat(g," [").concat(Date.now()-E,"ms ").concat(q,"]")),q.name==="AbortError"?q:new Ga("fetch failed",q)}finally{U()}if(!M.ok)throw wm(M,yield M.text());return m.rawResponseBody?yield M.blob():_?yield M.json():yield M.text()})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var n=new URLSearchParams;for(var i of t.searchParams.keys())n.append(i,"xxx");var o=n.toString(),u=o?"?".concat(o):"";return t.origin+t.pathname+u}catch{return"??"}}getUrl(e,t,n,i){var o=i??this.opts.baseUrl,u=o.endsWith("/")?o.slice(0,-1):o,d=new URL(u+(n??this.opts.prefix)+e);if(this.opts.extraParams||t){var h=eE(eE({},this.opts.extraParams),t);mv(h,d.searchParams)}return d}}var Vt=(function(s){return s.V1="/_matrix/client/v1",s.V3="/_matrix/client/v3",s.Unstable="/_matrix/client/unstable",s})({}),oi=(function(s){return s.V2="/_matrix/identity/v2",s})({}),Vs=(function(s){return s.V1="/_matrix/media/v1",s.V3="/_matrix/media/v3",s})({}),TI=1e3,RI=0,Xh,fi=[],wI=function(){};function tE(s,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),i=2;i<t;i++)n[i-2]=arguments[i];e=e||0,e<0&&(e=0);var o=Date.now()+e,u=RI++,d={runAt:o,func:s,params:n,key:u},h=II(fi,function(f){return f.runAt-o});return fi.splice(h,0,d),Cm(),u}function nE(s){if(fi.length!==0){var e;for(e=0;e<fi.length;e++){var t=fi[e];if(t.key==s){fi.splice(e,1);break}}e===0&&Cm()}}function Cm(){Xh&&globalThis.clearTimeout(Xh);var s=fi[0];if(s){var e=Date.now(),t=Math.min(s.runAt-e,TI);Xh=globalThis.setTimeout(CI,t)}}function CI(){for(var s=Date.now(),e=[];;){var t=fi[0];if(!t||t.runAt>s)break;var n=fi.shift();wI("runCallbacks: popping",n.key),e.push(n)}Cm();for(var i of e)try{i.func.apply(globalThis,i.params)}catch(o){N.error("Uncaught exception in callback function",o)}}function II(s,e){for(var t=0,n=s.length;t<n;){var i=t+n>>1,o=e(s[i]);o>0?n=i:t=i+1}return t}class I0 extends _I{constructor(){super(...arguments),y(this,"uploads",[])}uploadContent(e){var t,n,i,o,u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=(t=u.includeFilename)!==null&&t!==void 0?t:!0,h=(n=u.abortController)!==null&&n!==void 0?n:new AbortController,f=((i=u.type)!==null&&i!==void 0?i:e.type)||"application/octet-stream",m=(o=u.name)!==null&&o!==void 0?o:e.name,g={loaded:0,total:0,abortController:h},S=Promise.withResolvers();if(globalThis.XMLHttpRequest){var _=new globalThis.XMLHttpRequest,b=function(){_.abort(),S.reject(new Error("Timeout"))},T=tE(b,3e4);_.onreadystatechange=function(){switch(_.readyState){case globalThis.XMLHttpRequest.DONE:nE(T);try{if(_.status===0)throw new DOMException(_.statusText,"AbortError");if(!_.responseText)throw new Error("No response body.");_.status>=400?S.reject(wm(_,_.responseText)):S.resolve(JSON.parse(_.responseText))}catch(U){if(U.name==="AbortError"){S.reject(U);return}S.reject(new Ga("request failed",U))}break}},_.upload.onprogress=U=>{var O;nE(T),g.loaded=U.loaded,g.total=U.total,T=tE(b,3e4),(O=u.progressHandler)===null||O===void 0||O.call(u,{loaded:U.loaded,total:U.total})};var k=this.getUrl("/upload",void 0,Vs.V3);d&&m&&k.searchParams.set("filename",encodeURIComponent(m)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&k.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),_.open(se.Post,k.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&_.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),_.setRequestHeader("Content-Type",f),_.send(e),h.signal.addEventListener("abort",()=>{_.abort()})}else{var A={};d&&m&&(A.filename=m);var C={"Content-Type":f};this.authedRequest(se.Post,"/upload",A,e,{prefix:Vs.V3,headers:C,abortSignal:h.signal}).then(S.resolve,S.reject)}return g.promise=S.promise.finally(()=>{Yc(this.uploads,U=>U===g)}),h.signal.addEventListener("abort",()=>{Yc(this.uploads,U=>U===g),S.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(g),g.promise}cancelUpload(e){var t=this.uploads.find(n=>n.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:Vs.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var OI=360*60*1e3,MI=30*1e3,O0=(function(s){return s.Stable="stable",s.Unstable="unstable",s})({});class M0{constructor(e,t){var n=this;this.logger=e,this.http=t,y(this,"capabilities",void 0),y(this,"retryTimeout",void 0),y(this,"refreshTimeout",void 0),y(this,"fetchCapabilities",D(function*(){var i=yield n.http.authedRequest(se.Get,"/capabilities");return n.capabilities=i.capabilities,n.capabilities})),y(this,"poll",D(function*(){try{yield n.fetchCapabilities(),n.clearTimeouts(),n.refreshTimeout=setTimeout(n.poll,OI),n.logger.debug("Fetched new server capabilities")}catch(o){n.clearTimeouts();var i=Math.floor(MI+Math.random()*5e3);n.retryTimeout=setTimeout(n.poll,i),n.logger.warn("Failed to refresh capabilities: retrying in ".concat(i,"ms"),o)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}var vl=N.getChild("RoomStickyEvents"),Ji=(function(s){return s.Update="RoomStickyEvents.Update",s})({});function Qh(s){if(typeof s!="string")throw new Error("Not a string");if(!s.startsWith("@"))throw new Error("Not a userId")}class Pa extends Lt{constructor(){super(...arguments),y(this,"stickyEventsMap",new Map),y(this,"unkeyedStickyEvents",new Set),y(this,"stickyEventTimer",void 0),y(this,"nextStickyEventExpiryTs",Number.MAX_SAFE_INTEGER),y(this,"cleanExpiredStickyEvents",()=>{var e=Date.now(),t=[];this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER;for(var[n,i]of this.stickyEventsMap.entries()){var o;for(var[u,[d,...h]]of i)e>=d.unstableStickyExpiresAt?(vl.debug("Expiring sticky event",d.getId()),t.push(d),this.stickyEventsMap.get(n).delete(u)):(this.stickyEventsMap.get(n).set(u,[d,...h.filter(m=>m.unstableStickyExpiresAt<=e)]),this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,d.unstableStickyExpiresAt));((o=this.stickyEventsMap.get(n))===null||o===void 0?void 0:o.size)===0&&this.stickyEventsMap.delete(n)}for(var f of this.unkeyedStickyEvents)e>=f.unstableStickyExpiresAt?(vl.debug("Expiring sticky event",f.getId()),this.unkeyedStickyEvents.delete(f),t.push(f)):this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,f.unstableStickyExpiresAt);t.length&&this.emit(Ji.Update,[],[],t),this.scheduleStickyTimer()})}static sortStickyEvent(e,t){var n,i;if(t.getTs()!==e.getTs())return t.getTs()-e.getTs();if(((n=t.getId())!==null&&n!==void 0?n:"")>((i=e.getId())!==null&&i!==void 0?i:""))return 1;throw Error("Comparing two sticky events with the same event ID is not allowed.")}static stickyMapKey(e,t){return"".concat(e).concat(t)}*getStickyEvents(){yield*this.unkeyedStickyEvents;for(var e of this.stickyEventsMap.values())for(var t of e.values())yield t[0]}getKeyedStickyEvent(e,t,n){var i;return Qh(e),(i=this.stickyEventsMap.get(t))===null||i===void 0||(i=i.get(Pa.stickyMapKey(n,e)))===null||i===void 0?void 0:i[0]}getUnkeyedStickyEvent(e,t){return[...this.unkeyedStickyEvents].filter(n=>n.getType()===t&&n.getSender()===e)}addStickyEvent(e){var t,n,i,o=e.getContent().msc4354_sticky_key;if(typeof o!="string"&&o!==void 0)throw new Error("".concat(e.getId()," is missing msc4354_sticky_key"));if(e.unstableStickyExpiresAt===void 0)throw new Error("".concat(e.getId()," is missing msc4354_sticky.duration_ms"));var u=e.getSender(),d=e.getType();if(Qh(u),e.unstableStickyExpiresAt<=Date.now())return vl.info("ignored sticky event with older expiration time than current time",o),{added:!1};if(!u.startsWith("@"))throw new Error("Expected sender to start with @");var h=e;if(o===void 0)return this.unkeyedStickyEvents.add(h),this.nextStickyEventExpiryTs=Math.min(e.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:!0};var f=Pa.stickyMapKey(o,u),m=[h,...(t=(n=this.stickyEventsMap.get(d))===null||n===void 0?void 0:n.get(f))!==null&&t!==void 0?t:[]].sort(Pa.sortStickyEvent);return this.stickyEventsMap.has(d)||this.stickyEventsMap.set(d,new Map),(i=this.stickyEventsMap.get(d))===null||i===void 0||i.set(f,m),this.nextStickyEventExpiryTs=Math.min(h.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:m[0]===h,prevEvent:m?.[1]}}addStickyEvents(e){var t=[],n=[];for(var i of e)try{var o=this.addStickyEvent(i);o.added&&(o.prevEvent?n.push({current:i,previous:o.prevEvent}):t.push(i))}catch(u){vl.warn("ignored invalid sticky event",u)}(t.length||n.length)&&this.emit(Ji.Update,t,n,[]),this.scheduleStickyTimer()}scheduleStickyTimer(){this.stickyEventTimer&&(clearTimeout(this.stickyEventTimer),this.stickyEventTimer=void 0),this.nextStickyEventExpiryTs!==Number.MAX_SAFE_INTEGER&&(this.stickyEventTimer=setTimeout(this.cleanExpiredStickyEvents,this.nextStickyEventExpiryTs-Date.now()))}handleRedaction(e){var t=typeof e=="string"?e:e.getId();for(var n of this.unkeyedStickyEvents)if(n.getId()===t){this.unkeyedStickyEvents.delete(n),this.emit(Ji.Update,[],[],[n]);return}if(typeof e!="string"&&!e.isRedacted()){var i,o,u=e.getContent().msc4354_sticky_key;if(typeof u!="string"&&u!==void 0)return;var d=e.getType(),h=e.getSender();Qh(h);var f=this.stickyEventsMap.get(d);if(!f)return;var m=Pa.stickyMapKey(u,h),[g,...S]=(i=f.get(m))!==null&&i!==void 0?i:[];if(!g)return;vl.debug("Redaction for ".concat(t," under sticky key ").concat(u));var _=S.filter(k=>!k.isRedacted()).sort(Pa.sortStickyEvent);(o=this.stickyEventsMap.get(d))===null||o===void 0||o.set(m,_),_.length?this.emit(Ji.Update,[],[{previous:g,current:_[0]}],[]):(f.delete(m),f.size===0&&this.stickyEventsMap.delete(d),this.emit(Ji.Update,[],[],[g]));return}for(var b of this.stickyEventsMap.values())for(var[T]of b.values())if(T.getId()===t)return this.handleRedaction(T)}clear(){this.stickyEventsMap.clear(),this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER,this.scheduleStickyTimer()}}function rE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function ml(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?rE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):rE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var A0="10",AI=["1","2","3","4","5","6","7","8","9","10"],DI=30,ht=(function(s){return s.Highlight="highlight",s.Total="total",s})({}),ke=(function(s){return s.MyMembership="Room.myMembership",s.Tags="Room.tags",s.AccountData="Room.accountData",s.Receipt="Room.receipt",s.Name="Room.name",s.Redaction="Room.redaction",s.RedactionCancelled="Room.redactionCancelled",s.LocalEchoUpdated="Room.localEchoUpdated",s.Timeline="Room.timeline",s.TimelineReset="Room.timelineReset",s.TimelineRefresh="Room.TimelineRefresh",s.OldStateUpdated="Room.OldStateUpdated",s.CurrentStateUpdated="Room.CurrentStateUpdated",s.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",s.UnreadNotifications="Room.UnreadNotifications",s.Summary="Room.Summary",s})({});class hd extends g0{constructor(e,t,n){var i,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),i=this,this.roomId=e,this.client=t,this.myUserId=n,this.opts=o,y(this,"reEmitter",void 0),y(this,"txnToEvent",new Map),y(this,"notificationCounts",{}),y(this,"bumpStamp",void 0),y(this,"threadNotifications",new Map),y(this,"cachedThreadReadReceipts",new Map),y(this,"oldestThreadedReceiptTs",1/0),y(this,"unthreadedReceipts",new Map),y(this,"timelineSets",void 0),y(this,"polls",new Map),y(this,"threadsTimelineSets",[]),y(this,"filteredTimelineSets",{}),y(this,"timelineNeedsRefresh",!1),y(this,"pendingEventList",void 0),y(this,"blacklistUnverifiedDevices",void 0),y(this,"selfMembership",void 0),y(this,"heroes",null),y(this,"getTypeWarning",!1),y(this,"membersPromise",void 0),y(this,"name",void 0),y(this,"normalizedName",void 0),y(this,"tags",{}),y(this,"accountData",new Map),y(this,"summary",null),y(this,"oldState",void 0),y(this,"currentState",void 0),y(this,"relations",void 0),y(this,"threads",new Map),y(this,"visibilityEvents",new Map),y(this,"roomReceipts",new aI(this)),y(this,"stickyEvents",new Pa),y(this,"threadTimelineSetsPromise",null),y(this,"threadsReady",!1),y(this,"updateThreadRootEvents",(u,d,h)=>{if(u.length){var f;if(this.updateThreadRootEvent((f=this.threadsTimelineSets)===null||f===void 0?void 0:f[0],u,d,h),u.hasCurrentUserParticipated){var m;this.updateThreadRootEvent((m=this.threadsTimelineSets)===null||m===void 0?void 0:m[1],u,d,h)}}}),y(this,"updateThreadRootEvent",(u,d,h,f)=>{u&&d.rootEvent&&(f&&u.removeEvent(d.id),At.hasServerSideSupport?u.addLiveEvent(d.rootEvent,{duplicateStrategy:Pl.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):u.addEventToTimeline(d.rootEvent,u.getLiveTimeline(),{toStartOfTimeline:h,addToState:!1}))}),y(this,"tryApplyRedaction",u=>{if(u.isRedaction()){var d=u.event.redacts,h=d?this.findEventById(d):void 0;if(d)try{this.stickyEvents.handleRedaction(h||d)}catch(b){N.error("Failed to handle redaction for sticky event",b)}h&&this.applyEventAsRedaction(u,h)}else if(u.getType()===Z.RoomMember){var f=u.getContent().membership;if(f!==Ye.Ban&&!(f===Ye.Leave&&u.getStateKey()!==u.getSender()))return;var m=u.getContent()["org.matrix.msc4293.redact_events"];if(m!==!0)return;var g=this.getLiveTimeline().getState(Qe.Forward);if(!g.maySendRedactionForEvent(u,u.getSender()))return;var S=this.getTimelineSets().map(b=>b.getTimelines()).reduce((b,T)=>(b.push(...T),b),[]).map(b=>b.getEvents().filter(T=>T.getSender()===u.getStateKey())).reduce((b,T)=>(b.push(...T),T),[]);for(var _ of S)this.applyEventAsRedaction(u,_)}}),this.setMaxListeners(100),this.reEmitter=new lo(this),o.pendingEventOrdering=o.pendingEventOrdering||no.Chronological,this.name=e,this.normalizedName=e,this.relations=new t0(this.client,this),this.on(ke.Receipt,this.onReceipt),this.reEmitter.reEmit(this.stickyEvents,[Ji.Update]),this.timelineSets=[new qs(this,o)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[ke.Timeline,ke.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===no.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(u=>{var d=this.client.getEventMapper({decrypt:!1});u.forEach((function(){var h=D(function*(f){var m=d(f);yield t.decryptEventIfNeeded(m),m.setStatus(He.NOT_SENT),i.addPendingEvent(m,m.getTxnId())});return function(f){return h.apply(this,arguments)}})())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return D(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Er.My)]);var n=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=n[0],e.threadsTimelineSets[1]=n[1],n}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return D(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),n=e.getLiveTimeline().getEvents(),i=n.findIndex(u=>u.event.event_id===t),o=n.slice(i).reverse().map(u=>e.client.decryptEventIfNeeded(u));yield Promise.allSettled(o)}})()}decryptAllEvents(){var e=this;return D(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(n=>e.client.decryptEventIfNeeded(n));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(Z.RoomCreate,"");return(e=t?.getSender())!==null&&e!==void 0?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return D(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var n=t["m.room_versions"];if(!n){n={default:A0,available:{}};for(var i of AI)n.available[i]=O0.Stable}var o=e.checkVersionAgainstCapability(n);if(o.urgent&&o.needsUpgrade){N.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(u){N.warn("Failed to refresh room version capabilities",u)}if(n=t["m.room_versions"],n)o=e.checkVersionAgainstCapability(n);else return N.warn("No room version capability - assuming upgrade required."),o}return o})()}checkVersionAgainstCapability(e){var t=this.getVersion();N.log("[".concat(this.roomId,"] Current version: ").concat(t)),N.log("[".concat(this.roomId,"] Version capability: "),e);var n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;var i=Object.keys(e.available).filter(o=>e.available[o]==="stable");return i.includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?N.warn("URGENT upgrade required on ".concat(this.roomId)):N.warn("Non-urgent upgrade required on ".concat(this.roomId))),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(Z.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=Yc(this.pendingEventList,function(n){return n.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.some(i=>i.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.find(i=>i.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var n=t[t.length-1];return n.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,n=this.getLiveTimeline().getEvents(),i=n[n.length-1],o=this.getLastThread();if(!o)return i;var u=o.events[o.events.length-1];return((e=i?.getTs())!==null&&e!==void 0?e:0)>((t=u?.getTs())!==null&&t!==void 0?t:0)?i:u}getLastThread(){return this.getThreads().reduce((e,t)=>{var n,i;if(!e)return t;var o=t.events[t.events.length-1],u=e.events[e.events.length-1];return((n=o?.getTs())!==null&&n!==void 0?n:0)>=((i=u?.getTs())!==null&&i!==void 0?i:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Ye.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Ye.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var n;return(n=this.heroes)===null||n===void 0||(n=n[0])===null||n===void 0?void 0:n.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var n=this.currentState.getMembers(),i=n.find(o=>o.userId!==this.myUserId);return i?i.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(V_.name,"");return Array.isArray(e?.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),n=0;if(this.getMembers().forEach(T=>{T.membership!=="join"&&T.membership!=="invite"||t.includes(T.userId)||n++}),!(n>2)){var i=(e=this.heroes)===null||e===void 0?void 0:e.filter(T=>!t.includes(T.userId)),o=Array.isArray(i)&&i.length;if(o){for(var u of i)if(u.fromMSC4186){var h=new Hl(this.roomId,u.userId);return h.setMembershipEvent(new yn({event_id:"$"+this.roomId+u.userId+new Date().getTime(),type:Z.RoomMember,state_key:u.userId,content:{displayname:u.displayName,avatar_url:u.avatarUrl}})),h}else{var d=this.getMember(u.userId);if(d)return d}var f=i.map(T=>this.getMember(T.userId)).find(T=>!!T);if(f)return f}var m=this.getMembers(),g=m?.filter(T=>!t.includes(T.userId));if(g.length<=2){var S=g.find(T=>T.userId!==this.myUserId);if(S)return S}if(o){var _=i.map(T=>this.client.getUser(T.userId)).find(T=>!!T);if(_){var b=new Hl(this.roomId,_.userId);return b.user=_,b}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Ye.Leave&&this.cleanupAfterLeaving(),this.emit(ke.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return D(function*(){var t=e.client.store.getSyncToken(),n=yield e.client.members(e.roomId,void 0,Ye.Leave,t??void 0);return n.chunk})()}loadMembers(){var e=this;return D(function*(){var t=!1,n=yield e.client.store.getOutOfBandMembers(e.roomId);(n===null||e.hasEncryptionStateEvent())&&(t=!0,n=yield e.loadMembersFromServer(),N.log("LL: got ".concat(n.length," ")+"members from server for room ".concat(e.roomId)));var i=n.filter(Tr).map(e.client.getEventMapper());return{memberEvents:i,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var n=this.currentState.getMembers().filter(o=>o.isOutOfBand()).map(o=>{var u;return(u=o.events.member)===null||u===void 0?void 0:u.event});N.log("LL: telling store to write ".concat(n.length)+" members for room ".concat(this.roomId));var i=this.client.store;return i.setOutOfBandMembers(this.roomId,n).catch(o=>{N.log("LL: storing OOB room members failed, oh well",o)})}}).catch(t=>{N.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return D(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{N.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),N.log(e)})}refreshLiveTimeline(){var e=this;return D(function*(){var t=e.getLiveTimeline(),n=t.getPaginationToken(Oe.FORWARDS),i=t.getPaginationToken(Oe.BACKWARDS),o=t.getEvents(),u=o[o.length-1];N.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(u&&u.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(n," ")+"backwardPaginationToken=".concat(i));var d=e.getUnfilteredTimelineSet(),h=null;u?(e.resetLiveTimeline(null,null),e.emit(ke.TimelineRefresh,e,d),h=yield e.client.getEventTimeline(d,u.getId())):h=yield e.client.getLatestTimeline(d);var f=d.getLiveTimeline();!f||f.getPaginationToken(Qe.Forward)===null&&f.getPaginationToken(Qe.Backward)===null&&f.getEvents().length===0?(N.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),h.setPaginationToken(n,Oe.FORWARDS),d.setLiveTimeline(h),e.fixUpLegacyTimelineFields()):N.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(ke.TimelineRefresh,e,d)})()}resetLiveTimeline(e,t){for(var n of this.timelineSets)n.resetLiveTimeline(e??void 0,t??void 0);for(var i of this.threads.values())i.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(Oe.BACKWARDS),this.currentState=this.getLiveTimeline().getState(Oe.FORWARDS),e!==this.oldState&&this.emit(ke.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(ke.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[rt.Events,rt.Members,rt.NewMember,rt.Update,rt.Marker,Nt.New,Nt.Update,Nt.Destroy,Nt.LivenessChange]),this.reEmitter.reEmit(this.currentState,[rt.Events,rt.Members,rt.NewMember,rt.Update,rt.Marker,Nt.New,Nt.Update,Nt.Destroy,Nt.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],n=!1,i=e.getContent();for(var o of Object.values(i))for(var[u,d]of Object.entries(o))if(hm(u)&&d){for(var[h,f]of Object.entries(d))if(!(!f||typeof f!="object")){var m=f;h===this.client.getUserId()&&(m.thread_id===void 0?n=!0:typeof m.thread_id=="string"&&t.push(m.thread_id))}}n&&(t=this.getThreads().filter(M=>this.getThreadUnreadNotificationCount(M.id,ht.Total)>0||this.getThreadUnreadNotificationCount(M.id,ht.Highlight)>0).map(M=>M.id),t.push("main"));for(var g of t){var S,_=20,b=g==="main"?this.getLiveTimeline():(S=this.getThread(g))===null||S===void 0?void 0:S.liveTimeline;if(!b){N.warn("Couldn't find timeline for thread ID ".concat(g," in room ").concat(this.roomId));continue}for(var T=b.getEvents(),k=0,A=T.length-1;A>=0;A--){var C;if(A===T.length-_)return;var U=T[A];if(this.hasUserReadEvent(this.client.getUserId(),U.getId()))break;var O=this.client.getPushActionsForEvent(U);k+=O!=null&&(C=O.tweaks)!==null&&C!==void 0&&C.highlight?1:0}g==="main"?this.setUnreadNotificationCount(ht.Highlight,k):this.setThreadUnreadNotificationCount(g,ht.Highlight,k)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var n=this.getThreads(),i=0;i<n.length;i++){var o=n[i];if(t=o.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ht.Total,t=this.getRoomUnreadNotificationCount(e);for(var n of this.threadNotifications.values()){var i;t+=(i=n[e])!==null&&i!==void 0?i:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ht.Total,n=arguments.length>1?arguments[1]:void 0,i=!!n.threadRootId&&!n.isThreadRoot;return(e=i?this.getThreadUnreadNotificationCount(n.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ht.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ht.Total;return(t=(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n[i])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,n;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((n=e.total)!==null&&n!==void 0?n:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,n){var i,o,u=ml({highlight:(i=this.threadNotifications.get(e))===null||i===void 0?void 0:i.highlight,total:(o=this.threadNotifications.get(e))===null||o===void 0?void 0:o.total},{[t]:n});this.threadNotifications.set(e,u),this.emit(ke.UnreadNotifications,u,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var n,i;if(((n=t.highlight)!==null&&n!==void 0?n:0)>0)return ht.Highlight;((i=t.total)!==null&&i!==void 0?i:0)>0&&!e&&(e=ht.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[n,i]of this.threadNotifications)e.includes(n)||(i.total=0,t||(i.highlight=0));this.emit(ke.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(ke.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,n=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(u=>({userId:u,fromMSC4186:!1})),i=e["m.joined_member_count"],o=e["m.invited_member_count"];Number.isInteger(i)&&this.currentState.setJoinedMemberCount(i),Number.isInteger(o)&&this.currentState.setInvitedMemberCount(o),Array.isArray(n)&&(this.heroes=n.filter(u=>u.userId!=this.myUserId)),this.emit(ke.Summary,e)}setMSC4186SummaryData(e,t,n){e&&(this.heroes=e.filter(i=>i.user_id!==this.myUserId).map(i=>({userId:i.user_id,displayName:i.displayname,avatarUrl:i.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),n!==void 0&&Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),this.emit(ke.Summary,{"m.heroes":this.heroes?this.heroes.map(i=>i.userId):[],"m.joined_member_count":t,"m.invited_member_count":n})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,i){var o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,u=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,d=this.getMxcAvatarUrl();return!d&&!o?null:d?ud(e,d,t,n,i,void 0,void 0,u):null}getMxcAvatarUrl(){var e,t=(e=this.currentState.getStateEvents(Z.RoomAvatar,""))===null||e===void 0?void 0:e.getContent().url;return t&&typeof t=="string"?t:null}getCanonicalAlias(){var e,t=(e=this.currentState.getStateEvents(Z.RoomCanonicalAlias,""))===null||e===void 0?void 0:e.getContent().alias;return t&&typeof t=="string"?t:null}getAltAliases(){var e,t=(e=this.currentState.getStateEvents(Z.RoomCanonicalAlias,""))===null||e===void 0?void 0:e.getContent().alt_aliases;return Array.isArray(t)?t.filter(n=>typeof n=="string"):[]}addEventsToTimeline(e,t,n,i,o){i.getTimelineSet().addEventsToTimeline(e,t,n,i,o)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Ye.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return D(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Ye.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Ye.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(Z.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var n=this.getMember(e);return n?n.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var o=Object.assign({filter:e,pendingEvents:i},this.opts),u=new qs(this,o);this.reEmitter.reEmit(u,[ke.Timeline,ke.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=u,this.timelineSets.push(u));var d=this.getLiveTimeline();if(t){d.getEvents().forEach(function(m){u.addLiveEvent(m,{addToState:!1})});for(var h=d;h.getNeighbouringTimeline(Oe.BACKWARDS);)h=h.getNeighbouringTimeline(Oe.BACKWARDS);u.getLiveTimeline().setPaginationToken(h.getPaginationToken(Oe.BACKWARDS),Oe.BACKWARDS)}else if(n){var f=d.getPaginationToken(Qe.Forward);u.getLiveTimeline().setPaginationToken(f,Qe.Backward)}return u}getThreadListFilter(){var e=arguments,t=this;return D(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:Er.All,i=t.client.getUserId(),o=new Qn(i),u={room:{timeline:{[Ys.name]:[wt.name]}}};n===Er.My&&(u.room.timeline[Ws.name]=[i]),o.setDefinition(u);var d=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(n),o);return o.filterId=d,o})()}createThreadTimelineSet(e){var t=this;return D(function*(){var n;if(At.hasServerSideListSupport)n=new qs(t,ml(ml({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Er.All),t.reEmitter.reEmit(n,[ke.Timeline,ke.TimelineReset]);else if(At.hasServerSideSupport){var i=yield t.getThreadListFilter(e);n=t.getOrCreateFilteredTimelineSet(i,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else n=new qs(t,{pendingEvents:!1}),Array.from(t.threads).forEach(o=>{var[,u]=o;if(u.length!==0){var d=u.timeline.some(h=>h.getSender()===t.client.getUserId());(e!==Er.My||d)&&n.getLiveTimeline().addEvent(u.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return n})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var n of e)Oe.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}fetchRoomThreads(){var e=this;return D(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(At.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Er.All),e.fetchRoomThreadList(Er.My)]);else{var t=yield e.getThreadListFilter(),{chunk:n}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,Qe.Backward,t);if(!n.length)return;var i=n.map(e.client.getEventMapper()).sort((S,_)=>{var b=S.getServerAggregatedRelation(wt.name),T=_.getServerAggregatedRelation(wt.name);return b.latest_event.origin_server_ts-T.latest_event.origin_server_ts}),o,u=e.getLiveTimeline().getState(Oe.FORWARDS);for(var d of i){var h,f={duplicateStrategy:Pl.Ignore,fromCache:!1,addToState:!1,roomState:u};(h=e.threadsTimelineSets[0])===null||h===void 0||h.addLiveEvent(d,f);var m=d.getServerAggregatedRelation(wt.name);if(m!=null&&m.current_user_participated){var g;(g=e.threadsTimelineSets[1])===null||g===void 0||g.addLiveEvent(d,f),o=d}}e.processThreadRoots(i,!0),e.client.decryptEventIfNeeded(i[i.length-1]),o&&e.client.decryptEventIfNeeded(o)}e.on(Rn.NewReply,e.onThreadReply),e.on(Rn.Update,e.onThreadUpdate),e.on(Rn.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return D(function*(){for(var n of e)try{if(!n.isEncrypted()&&!S0(n))continue;yield t.client.decryptEventIfNeeded(n),t.processPollEvent(n)}catch(i){N.warn("Error processing poll event",n.getId(),i)}})()}processPollEvent(e){var t=this;return D(function*(){if(e.isDecryptionFailure()){e.once(mt.Decrypted,u=>{t.processPollEvent(u)});return}if(Pn.M_POLL_START.matches(e.getType())){try{var n=new y0(e,t.client,t);t.polls.set(e.getId(),n),t.emit(zi.New,n),e.once(mt.BeforeRedaction,u=>{t.polls.delete(u.getId())})}catch{}return}var i=e.relationEventId;if(i&&t.polls.has(i)){var o=t.polls.get(i);o?.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return D(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var n=e===Er.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:i,end:o}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,Qe.Backward,n.threadListType,n.getFilter());if(n.getLiveTimeline().setPaginationToken(o??null,Qe.Backward),!!i.length){var u=i.map(t.client.getEventMapper());t.processThreadRoots(u,!0);var d=t.getLiveTimeline().getState(Oe.FORWARDS);for(var h of u)n.addLiveEvent(h,{duplicateStrategy:Pl.Replace,fromCache:!1,roomState:d,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var n=this.getTimelineForEvent(e.id),i=n==null||(t=n.getEvents())===null||t===void 0?void 0:t.find(u=>u.getId()===e.id);i?e.clearEventMetadata(i):N.debug("onThreadDelete: Could not find root event in room timeline");for(var o of this.threadsTimelineSets)o.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var i;if(!((i=this.client)!==null&&i!==void 0&&i.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||n!=null&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var o=e.isRelation(wt.name),u=e.getAssociatedId(),d=e.threadRootId;if(u&&!o&&(d===u||n!=null&&n.has(u)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var h;if(u){var f;h=(f=this.findEventById(u))!==null&&f!==void 0?f:t?.find(m=>m.getId()===u)}return h&&!o?this.eventShouldLiveIn(h,t,n):d!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:d}:!u||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getThread(e);if(i)i.addEvents(t,n);else{var o,u=(o=this.findEventById(e))!==null&&o!==void 0?o:t.find(d=>d.getId()===e);this.createThread(e,u,t,n)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var n={};for(var i of e){var o,{threadId:u,shouldLiveInThread:d}=this.eventShouldLiveIn(i);d&&!n[u]&&(n[u]=[]),(o=n[u])===null||o===void 0||o.push(i)}Object.entries(n).map(h=>{var[f,m]=h;return this.addThreadedEvents(f,m,t)})}createThread(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],o=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var u=this.relations.getAllChildEventsForEvent(t.getId());u!=null&&u.length&&(i=i.concat(u.filter(h=>!h.isRelation(Mt.Replace))))}var d=new At(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(n=this.cachedThreadReadReceipts.get(e))!==null&&n!==void 0?n:[]});return this.reEmitter.reEmit(d,[Rn.Delete,Rn.Update,Rn.NewReply,ke.Timeline,ke.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(d.id,d),d.addEvents(i,!1),this.threadsReady&&d.initialEventsFetched&&this.updateThreadRootEvents(d,o,!1),this.emit(Rn.New,d,o),d}applyEventAsRedaction(e,t){var n=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var i=this.currentState.getStateEvents(t.getType(),t.getStateKey());i?.getId()===t.getId()&&this.currentState.setStateEvents([t])}this.emit(ke.Redaction,e,this,n),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[n,i]of this.txnToEvent)if(i.getId()===e.getId()){N.debug("processLiveEvent: found sent event without txn ID: ",n,e.getId());var o=e.getUnsigned();o.transaction_id=n,e.setUnsigned(o);break}}}addLiveEvent(e,t){var{duplicateStrategy:n,timelineWasEmpty:i,fromCache:o,addToState:u}=t;for(var d of this.timelineSets)d.addLiveEvent(e,{duplicateStrategy:n,fromCache:o,timelineWasEmpty:i,addToState:u});e.sender&&e.getType()!==Z.RoomRedaction&&this.addReceipt(p0(e.sender.userId,e,Tn.Read),!0)}addPendingEvent(e,t){if(e.status!==He.SENDING&&e.status!==He.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(Oe.setEventMetadata(e,this.getLiveTimeline().getState(Oe.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(u=>u.status===He.NOT_SENT)&&(N.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(He.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n=e.event.redacts,i=this.pendingEventList.find(u=>u.getId()===n);!i&&n&&(i=this.findEventById(n)),i&&(i.markLocallyRedacted(e),this.emit(ke.Redaction,e,this,i.threadRootId))}}else for(var o of this.timelineSets)o.getFilter()?o.getFilter().filterRoomTimeline([e]).length&&o.addEventToTimeline(e,o.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):o.addEventToTimeline(e,o.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(ke.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>ml(ml({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var n=t.type===Z.RoomMessageEncrypted,i=this.hasEncryptionStateEvent();return n||!i});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var n=t.getId(),i=e.getId(),o=t.status;N.debug("Got remote echo for event ".concat(n," -> ").concat(i," old status ").concat(o)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:u,threadId:d}=this.eventShouldLiveIn(e),h=d?this.getThread(d):null;if(h?.setEventMetadata(t),h?.timelineSet.handleRemoteEcho(t,n,i),u)for(var f of this.timelineSets)f.handleRemoteEcho(t,n,i);this.emit(ke.LocalEchoUpdated,t,this,n,o)}updatePendingEvent(e,t,n){if(N.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(n)),t==He.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==He.SENT){var i=this.getTimelineForEvent(n);if(i){var o=this.findEventById(n),u=o?.getUnsigned().transaction_id;if(!u&&o){var d=o.getUnsigned();d.transaction_id=e.getTxnId(),o.setUnsigned(d),this.removeEvent(o.getId()),this.handleRemoteEcho(o,e)}return}}var h=e.status,f=e.getId();if(!h)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var m=kI[h];if(!(m!=null&&m.includes(t)))throw new Error("Invalid EventStatus transition ".concat(h,"->").concat(t));if(e.setStatus(t),t==He.SENT){e.replaceLocalEventId(n);var{shouldLiveInRoom:g,threadId:S}=this.eventShouldLiveIn(e),_=S?this.getThread(S):void 0;if(_?.setEventMetadata(e),_?.timelineSet.replaceEventId(f,n),g)for(var b of this.timelineSets)b.replaceEventId(f,n)}else if(t==He.CANCELLED){if(this.pendingEventList){var T=this.getPendingEvent(f);this.removePendingEvent(f),T!=null&&T.isRedaction()&&this.revertRedactionLocalEcho(T)}this.removeEvent(f)}this.savePendingEvents(),this.emit(ke.LocalEchoUpdated,e,this,f,h)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(ke.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(Oe.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(Oe.FORWARDS)+")");if(t.getNeighbouringTimeline(Oe.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var n=this;return D(function*(){var{duplicateStrategy:i,fromCache:o,timelineWasEmpty:u=!1,addToState:d}=t;if(i&&["replace","ignore"].indexOf(i)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");n.assertTimelineSetsAreLive();var h=n.findThreadRoots(e),f={},m={duplicateStrategy:i,fromCache:o,timelineWasEmpty:u,addToState:d},g=[...e];for(var S of e){var _;if(n.processLiveEvent(S),S.getUnsigned().transaction_id){var b=n.txnToEvent.get(S.getUnsigned().transaction_id);if(b){n.handleRemoteEcho(S,b);continue}}var{shouldLiveInRoom:T,shouldLiveInThread:k,threadId:A=""}=n.eventShouldLiveIn(S,g,h);if(!k&&!T&&S.isRelation())try{var C=new yn(yield n.client.fetchRoomEvent(n.roomId,S.relationEventId));if(g.push(C),C.threadRootId){h.add(C.threadRootId);var U=S.getUnsigned();U[Zc.name]=C.threadRootId,S.setUnsigned(U)}({shouldLiveInRoom:T,shouldLiveInThread:k,threadId:A=""}=n.eventShouldLiveIn(S,g,h))}catch(O){N.error("Failed to load parent event of unhandled relation",O)}k&&!f[A]&&(f[A]=[]),(_=f[A])===null||_===void 0||_.push(S),T?n.addLiveEvent(S,m):!k&&S.isRelation()&&n.relations.aggregateChildEvent(S)}Object.entries(f).forEach(O=>{var[M,E]=O;n.addThreadedEvents(M,E,!1)})})()}partitionThreadedEvents(e){var t=0,n=1,i=2;if(this.client.supportsThreads()){var o=this.findThreadRoots(e);return e.reduce((u,d)=>{var{shouldLiveInRoom:h,shouldLiveInThread:f,threadId:m}=this.eventShouldLiveIn(d,e,o);return h&&u[t].push(d),f&&(d.setThreadId(m??""),u[n].push(d)),!f&&!h&&u[i].push(d),u},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var n of e){var i=n.threadRootId;i!=null&&t.add(i)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=e.getContent();this.roomReceipts.add(n,t),Object.keys(n).forEach(i=>{Object.keys(n[i]).forEach(o=>{Object.keys(n[i][o]).forEach(u=>{var d,h,f,m=n[i][o][u],g=!m.thread_id||m.thread_id===nu,S=g?this:this.threads.get((d=m.thread_id)!==null&&d!==void 0?d:"");if(S){if(S.addReceiptToStructure(i,o,u,m,t),!t&&this.client.isInitialSyncComplete()&&u===this.client.getUserId()){var _=S.timeline[S.timeline.length-1];_&&i===_.getId()&&u===_.getSender()&&(S.setUnread(ht.Total,0),S.setUnread(ht.Highlight,0))}}else{var b;this.cachedThreadReadReceipts.set(m.thread_id,[...(b=this.cachedThreadReadReceipts.get(m.thread_id))!==null&&b!==void 0?b:[],{eventId:i,receiptType:o,userId:u,receipt:m,synthetic:t}])}var T=this.client.getUserId();u===T&&!g&&m.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=m.ts),!m.thread_id&&m.ts>((h=(f=this.unthreadedReceipts.get(u))===null||f===void 0?void 0:f.ts)!==null&&h!==void 0?h:0)&&this.unthreadedReceipts.set(u,m)})})}),this.emit(ke.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===Z.Typing?this.currentState.setTypingEvent(t):t.getType()===Z.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var n of this.timelineSets){var i=n.removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(Z.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Ye.Invite){var n=e.getUnsigned().invite_room_state||[];n.forEach(o=>{var u=this.currentState.getStateEvents(o.type,o.state_key);u||this.currentState.setStateEvents([new yn({type:o.type,state_key:o.state_key,content:o.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var i=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=mC(this.name),this.summary=new n0(this.roomId,{title:this.name}),i!==this.name&&this.emit(ke.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(ke.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var n=t.getType(),i=this.accountData.get(n);this.accountData.set(n,t),this.emit(ke.AccountData,t,this,i)}}getAccountData(e){return this.accountData.get(e)}_unstable_getStickyEvents(){return this.stickyEvents.getStickyEvents()}_unstable_getKeyedStickyEvent(e,t,n){return this.stickyEvents.getKeyedStickyEvent(e,t,n)}_unstable_getUnkeyedStickyEvent(e,t){return this.stickyEvents.getUnkeyedStickyEvent(e,t)}_unstable_addStickyEvents(e){return this.stickyEvents.addStickyEvents(e)}maySendMessage(){return this.getMyMembership()===Ye.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(Z.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(Z.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Ye.Join,n=this.currentState.getStateEvents(Z.RoomPowerLevels,""),i=n&&n.getContent(),o=this.getMember(e);return i&&o&&i.invite>o.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(Z.RoomCreate,"");if(!e){this.getTypeWarning||(N.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[Qc]}isSpaceRoom(){return this.getType()===Hs.Space}isCallRoom(){return this.getType()===Hs.UnstableCall}isElementVideoRoom(){return this.getType()===Hs.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(Oe.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case kr.Actual:return e.name;case kr.Generated:return e.subtype==="Inviting"?"Inviting ".concat(iE(e.names,e.count)):iE(e.names,e.count);case kr.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var n,i=(n=this.currentState.getStateEvents(Z.RoomName,""))===null||n===void 0?void 0:n.getContent().name;if(i&&typeof i=="string")return this.roomNameGenerator({type:kr.Actual,name:i})}var o=this.getCanonicalAlias();if(o)return this.roomNameGenerator({type:kr.Actual,name:o});var u=this.currentState.getJoinedMemberCount(),d=this.currentState.getInvitedMemberCount(),h=u+d-1,f=this.getFunctionalMembers(),m=[];if(this.heroes)this.heroes.forEach(C=>{if(f.includes(C.userId)){h--;return}if(C.displayName)m.push(C.displayName);else{var U=this.getMember(C.userId);m.push(U?U.name:C.userId)}});else{var g=this.currentState.getMembers().filter(C=>C.userId!==e&&(C.membership===Ye.Invite||C.membership===Ye.Join));g=g.filter(C=>{var{userId:U}=C;return f.includes(U)?(h--,!1):!0});var S=new Intl.Collator;g.sort((C,U)=>S.compare(C.userId,U.userId)),g=g.slice(0,5),m=g.map(C=>C.name)}if(h)return this.roomNameGenerator({type:kr.Generated,names:m,count:h});var _=this.getMyMembership();if(_==Ye.Join){var b=this.currentState.getStateEvents(Z.RoomThirdPartyInvite);if(b!=null&&b.length){var T=b.map(C=>C.getContent().display_name);return this.roomNameGenerator({type:kr.Generated,subtype:"Inviting",names:T,count:T.length+1})}}var k=m;k.length||(k=this.currentState.getMembers().filter(C=>C.userId!==e&&C.membership!==Ye.Invite&&C.membership!==Ye.Join).map(C=>C.name));var A;return k.length&&(A=this.roomNameGenerator({type:kr.Generated,names:k,count:k.length+1})),this.roomNameGenerator({type:kr.EmptyRoom,oldName:A})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var n=e.getSender();if(n){var i=La.name&&this.currentState.maySendStateEvent(La.name,n)||La.altName&&this.currentState.maySendStateEvent(La.altName,n);if(i){var o=this.visibilityEvents.get(t.eventId);if(o){for(var u=o.length-1,d=Math.max(0,o.length-DI);u>=d;--u){var h=o[u];if(h.getTs()<e.getTs())break}u===-1?o.unshift(e):o.splice(u+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var f=this.findEventById(t.eventId);f&&f.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),n=t?.event_id,i=this.visibilityEvents.get(n);if(i){var o=i.findIndex(f=>f.getId()===e.getId());if(o!==-1&&(i.splice(o,1),o===i.length)){var u=this.findEventById(n);if(!u)return;if(o===0)this.visibilityEvents.delete(n),u.applyVisibilityEvent();else{var d=i[i.length-1],h=d.asVisibilityChange();if(!h)throw new Error("at this stage, visibility changes should be well-formed");u.applyVisibilityEvent(h)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var n=t[t.length-1],i=n.asVisibilityChange();i&&(i.visible,!(n.getTs()<e.getTs())&&e.applyVisibilityEvent(i))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(i=>this.getThreadUnreadNotificationCount(i.id,ht.Total)>0);for(var n of t)n.fixupNotifications(e)}compareEventOrdering(e,t){return fI(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(Oe.FORWARDS))===null||e===void 0)&&e.getStateEvents(Z.RoomEncryption,""))}}var kI={[He.ENCRYPTING]:[He.SENDING,He.NOT_SENT,He.CANCELLED],[He.SENDING]:[He.ENCRYPTING,He.QUEUED,He.NOT_SENT,He.SENT],[He.QUEUED]:[He.SENDING,He.NOT_SENT,He.CANCELLED],[He.SENT]:[],[He.NOT_SENT]:[He.SENDING,He.QUEUED,He.CANCELLED],[He.CANCELLED]:[]},kr=(function(s){return s[s.EmptyRoom=0]="EmptyRoom",s[s.Generated=1]="Generated",s[s.Actual=2]="Actual",s})({});function iE(s,e){var t=e-1;if(s.length){if(s.length===1&&t<=1)return s[0];if(s.length===2&&t<=2)return"".concat(s[0]," and ").concat(s[1]);var n=t>1;return n?"".concat(s[0]," and ").concat(t," others"):"".concat(s[0]," and 1 other")}else return"Empty room"}var nn=(function(s){return s[s.Stable=0]="Stable",s[s.Unstable=1]="Unstable",s[s.Unsupported=2]="Unsupported",s})({}),rn=(function(s){return s.Thread="Thread",s.ThreadUnreadNotifications="ThreadUnreadNotifications",s.LoginTokenRequest="LoginTokenRequest",s.RelationBasedRedactions="RelationBasedRedactions",s.AccountDataDeletion="AccountDataDeletion",s.RelationsRecursion="RelationsRecursion",s.IntentionalMentions="IntentionalMentions",s})({}),UI={[rn.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[rn.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[rn.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[rn.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[rn.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[rn.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[rn.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function PI(s){return Uv.apply(this,arguments)}function Uv(){return Uv=D(function*(s){var e=new Map;for(var[t,n]of Object.entries(UI)){var i,o,u,d,h=(i=(o=s.versions)===null||o===void 0?void 0:o.includes(n.matrixVersion||""))!==null&&i!==void 0?i:!1,f=(u=(d=n.unstablePrefixes)===null||d===void 0?void 0:d.every(m=>{var g;return((g=s.unstable_features)===null||g===void 0?void 0:g[m])===!0}))!==null&&u!==void 0?u:!1;h?e.set(t,nn.Stable):f?e.set(t,nn.Unstable):e.set(t,nn.Unsupported)}return e}),Uv.apply(this,arguments)}function aE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function nd(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?aE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):aE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var sE=80*1e3,NI=3,gt=(function(s){return s.Error="ERROR",s.Prepared="PREPARED",s.Stopped="STOPPED",s.Syncing="SYNCING",s.Catchup="CATCHUP",s.Reconnecting="RECONNECTING",s})({}),LI=["org.matrix.msc2716v3"];function oE(s,e){return"FILTER_SYNC_".concat(s)+(e?"_"+e:"")}var D0=(function(s){return s.Offline="offline",s.Online="online",s.Unavailable="unavailable",s})({});function k0(s){return nd({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:no.Chronological,threadSupport:!1},s)}function U0(s){return nd({canResetEntireTimeline:e=>!1},s)}class Xi{constructor(e,t,n){var i=this;this.client=e,y(this,"opts",void 0),y(this,"syncOpts",void 0),y(this,"_peekRoom",null),y(this,"currentSyncRequest",void 0),y(this,"abortController",void 0),y(this,"syncState",null),y(this,"syncStateData",void 0),y(this,"catchingUp",!1),y(this,"running",!1),y(this,"keepAliveTimer",void 0),y(this,"connectionReturnedResolvers",void 0),y(this,"notifEvents",[]),y(this,"failedSyncCount",0),y(this,"storeIsInvalid",!1),y(this,"presence",void 0),y(this,"getPushRules",D(function*(){try{i.syncOpts.logger.debug("Getting push rules...");var o=yield i.client.getPushRules();i.syncOpts.logger.debug("Got push rules"),i.client.pushRules=o}catch(u){return i.syncOpts.logger.error("Getting push rules failed",u),i.shouldAbortSync(u)?void 0:(i.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,u),i.getPushRules())}})),y(this,"buildDefaultFilter",()=>{var o=new Qn(this.client.credentials.userId);return this.client.canSupport.get(rn.ThreadUnreadNotifications)!==nn.Unsupported&&o.setUnreadThreadNotifications(!0),o}),y(this,"prepareLazyLoadingForSync",D(function*(){i.syncOpts.logger.debug("Prepare lazy loading for sync..."),i.client.isGuest()&&(i.opts.lazyLoadMembers=!1),i.opts.lazyLoadMembers&&(i.syncOpts.logger.debug("Enabling lazy load on sync filter..."),i.opts.filter||(i.opts.filter=i.buildDefaultFilter()),i.opts.filter.setLazyLoadMembers(!0))})),y(this,"storeClientOptions",D(function*(){try{i.syncOpts.logger.debug("Storing client options..."),yield i.client.storeClientOptions(),i.syncOpts.logger.debug("Stored client options")}catch(o){throw i.syncOpts.logger.error("Storing client options failed",o),o}})),y(this,"getFilter",D(function*(){i.syncOpts.logger.debug("Getting filter...");var o;i.opts.filter?o=i.opts.filter:o=i.buildDefaultFilter();var u;try{u=yield i.client.getOrCreateFilter(oE(i.client.credentials.userId),o)}catch(d){return i.syncOpts.logger.error("Getting filter failed",d),i.shouldAbortSync(d)?{}:(i.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,d),i.getFilter())}return{filter:o,filterId:u}})),y(this,"savedSyncPromise",void 0),y(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=k0(t),this.syncOpts=U0(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[ke.Timeline,ke.TimelineReset])}createRoom(e){var t=P0(this.client,e,this.opts);return t.on(rt.Marker,(n,i)=>{this.onMarkerStateEvent(t,n,i)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:n}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(n){this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var i=LI.includes(e.getVersion())||t.getSender()===e.getCreator();i?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(ke.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return D(function*(){var t,n=e.client,i=new Qn(e.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);var o=e.opts.pollTimeout+sE,u=yield n.getOrCreateFilter(oE(n.credentials.userId,"LEFT_ROOMS"),i),d={timeout:0,filter:u,"org.matrix.msc4222.use_state_after":!0},h=yield n.http.authedRequest(se.Get,"/sync",d,void 0,{localTimeoutMs:o}),f=[];(t=h.rooms)!==null&&t!==void 0&&t.leave&&(f=e.mapSyncResponseToRoomArray(h.rooms.leave));var m=yield Promise.all(f.map((function(){var g=D(function*(S){var _=S.room;if(S.isBrandNewRoom){S.timeline=S.timeline||{prev_batch:null,events:[]},_.getLiveTimeline().setPaginationToken(S.timeline.prev_batch,Oe.BACKWARDS);var{timelineEvents:b}=yield e.mapAndInjectRoomEvents(S);return _.recalculate(),n.store.storeRoom(_),n.emit(Ue.Room,_),e.processEventsForNotifs(_,b),_}});return function(S){return g.apply(this,arguments)}})()));return m.filter(Boolean)})()}peek(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var i=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,n).then(o=>{var u;if(((u=this._peekRoom)===null||u===void 0?void 0:u.roomId)!==e)throw new Error("Peeking aborted");o.messages=o.messages||{chunk:[]},o.messages.chunk=o.messages.chunk||[],o.state=o.state||[];var d=ru(o.state).map(i.getEventMapper()),h=o.state.map(i.getEventMapper()),f=o.messages.chunk.map(i.getEventMapper());return Array.isArray(o.presence)&&o.presence.map(i.getEventMapper()).forEach(function(m){var g=i.store.getUser(m.getContent().user_id);g?g.setPresenceEvent(m):(g=pi.createUser(m.getContent().user_id,i),g.setPresenceEvent(m),i.store.storeUser(g)),i.emit(Ue.Event,m)}),o.messages.start&&(this._peekRoom.oldState.paginationToken=o.messages.start),this._peekRoom.oldState.setStateEvents(d),this._peekRoom.currentState.setStateEvents(h),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(f.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),o.messages.start),i.store.storeRoom(this._peekRoom),i.emit(Ue.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n,i=this;if(this._peekRoom!==e){this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(se.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal}).then((function(){var o=D(function*(u){if(i._peekRoom!==e){i.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}u.chunk.filter(function(h){return h.type==="m.presence"}).map(i.client.getEventMapper()).forEach(h=>{var f=i.client.store.getUser(h.getContent().user_id);f?f.setPresenceEvent(h):(f=pi.createUser(h.getContent().user_id,i.client),f.setPresenceEvent(h),i.client.store.storeUser(f)),i.client.emit(Ue.Event,h)});var d=u.chunk.filter(function(h){return h.room_id===e.roomId&&h.event_id}).map(i.client.getEventMapper());yield e.addLiveEvents(d,{addToState:!0}),i.peekPoll(e,u.end)});return function(u){return o.apply(this,arguments)}})(),o=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,o),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var n=this;return D(function*(){yield e;var i=n.startKeepAlives();n.updateSyncState(gt.Error,{error:t}),yield i})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(gt.Error,{error:e}),!0):!1}sync(){var e=this;return D(function*(){var t,n;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(n=t.addEventListener)===null||n===void 0||n.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var i=e.client.store.getSavedSyncToken().then(m=>(e.syncOpts.logger.debug("Got saved sync token"),m));e.savedSyncPromise=e.client.store.getSavedSync().then(m=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!m)),m)return e.syncFromCache(m)}).catch(m=>{e.syncOpts.logger.error("Getting saved sync failed",m)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:o,filter:u}=yield e.getFilter();if(u){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var d=o,h=yield i;if(h)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var f=e.buildDefaultFilter();f.setDefinition(u.getDefinition()),f.setTimelineLimit(e.opts.initialSyncLimit),d=JSON.stringify(f.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:d},h)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:o})}})()}stop(){var e,t,n;this.syncOpts.logger.debug("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(n=this.abortController)===null||n===void 0||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return D(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var n=e.nextBatch;t.client.store.setSyncToken(n);var i={nextSyncToken:n,catchingUp:!1,fromCache:!0},o={next_batch:n,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(i,o)}catch(u){t.syncOpts.logger.error("Error processing cached sync",u)}t.storeIsInvalid||t.updateSyncState(gt.Prepared,i)})()}doSync(e){var t=this;return D(function*(){for(;t.running;){var n=t.client.store.getSyncToken(),i=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,n)),i=yield t.currentSyncRequest}catch(d){var o=yield t.onSyncError(d);if(o)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(i.next_batch),t.failedSyncCount=0;var u={oldSyncToken:n??void 0,nextSyncToken:i.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(u,i)}catch(d){t.syncOpts.logger.error("Caught /sync error",d),t.client.emit(Ue.SyncUnexpectedError,d)}yield t.client.store.setSyncData(i),u.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(gt.Prepared,u),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(u)),t.updateSyncState(gt.Syncing,u),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(gt.Stopped))})()}doSyncRequest(e,t){var n,i=this.getSyncParams(e,t);return this.client.http.authedRequest(se.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+sE,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal})}getSyncParams(e,t){var n=this.opts.pollTimeout;(this.getSyncState()!==gt.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);var i=e.filter;this.client.isGuest()&&!i&&(i=this.getGuestFilter());var o={filter:i,timeout:n,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?o.set_presence=D0.Offline:this.presence!==void 0&&(o.set_presence=this.presence),t?o.since=t:o._cacheBuster=Date.now(),[gt.Reconnecting,gt.Error].includes(this.getSyncState())&&(o.timeout=0),o}setPresence(e){this.presence=e}onSyncError(e){var t=this;return D(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(gt.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var n=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=NI?gt.Error:gt.Reconnecting,{error:e});var i=yield n;return i&&t.getSyncState()===gt.Error&&t.updateSyncState(gt.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var n=this;return D(function*(){var i,o,u,d,h=n.client;if(Array.isArray((i=t.presence)===null||i===void 0?void 0:i.events)&&t.presence.events.filter(Tr).map(h.getEventMapper()).forEach(function(A){var C=h.store.getUser(A.getSender());C?C.setPresenceEvent(A):(C=pi.createUser(A.getSender(),h),C.setPresenceEvent(A),h.store.storeUser(C)),h.emit(Ue.Event,A)}),Array.isArray((o=t.account_data)===null||o===void 0?void 0:o.events)){var f=t.account_data.events.filter(Tr).map(h.getEventMapper()),m=f.reduce((A,C)=>(A[C.getType()]=h.store.getAccountData(C.getType()),A),{});h.store.storeAccountDataEvents(f),f.forEach(function(A){if(A.getType()===Z.PushRules){var C=A.getContent();h.setPushRules(C)}var U=m[A.getType()];return h.emit(Ue.AccountData,A,U),A})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var g=t.to_device.events.filter(Tr),S;n.syncOpts.cryptoCallbacks?S=yield n.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(g):S=g.map(A=>({message:A,encryptionInfo:null})),N0(S,h)}else n.catchingUp=!1;var _=[],b=[],T=[],k=[];t.rooms&&(t.rooms.invite&&(_=n.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(b=n.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(T=n.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(k=n.mapSyncResponseToRoomArray(t.rooms.knock))),n.notifEvents=[],yield Fs(_,(function(){var A=D(function*(C){var U=C.room,O=n.mapSyncEventsFormat(C.invite_state,U);yield n.injectRoomEvents(U,O,void 0),C.isBrandNewRoom?(U.recalculate(),h.store.storeRoom(U),h.emit(Ue.Room,U)):U.recalculate(),O.forEach(function(M){h.emit(Ue.Event,M)})});return function(C){return A.apply(this,arguments)}})()),yield Fs(b,(function(){var A=D(function*(C){var U,O=C.room,M=n.mapSyncEventsFormat(C.state,O),E=n.mapSyncEventsFormat(C["org.matrix.msc4222.state_after"],O),I=n.mapSyncEventsFormat(C.timeline,O,!1),w=n.mapSyncEventsFormat(C.ephemeral),q=n.mapSyncEventsFormat(C.account_data),z=n.mapSyncEventsFormat(C.msc4354_sticky),ue=C["org.matrix.msc4222.state_after"]?E:M.concat(I),Se=n.isRoomEncrypted(O,ue);if(C.unread_notifications){if(!Se||C.unread_notifications.notification_count===0){var Ie;O.setUnreadNotificationCount(ht.Total,(Ie=C.unread_notifications.notification_count)!==null&&Ie!==void 0?Ie:0)}if(!Se||O.getUnreadNotificationCount(ht.Highlight)<=0){var Ze;O.setUnreadNotificationCount(ht.Highlight,(Ze=C.unread_notifications.highlight_count)!==null&&Ze!==void 0?Ze:0)}}var me=(U=C[Vl.name])!==null&&U!==void 0?U:C[Vl.altName];if(me){O.resetThreadUnreadNotificationCountFromSync(Object.keys(me));for(var[J,oe]of Object.entries(me)){if(!Se||oe.notification_count===0){var pe;O.setThreadUnreadNotificationCount(J,ht.Total,(pe=oe.notification_count)!==null&&pe!==void 0?pe:0)}var Te=O.getThreadUnreadNotificationCount(J,ht.Highlight)<=0;if(!Se||Se&&Te){var De;O.setThreadUnreadNotificationCount(J,ht.Highlight,(De=oe.highlight_count)!==null&&De!==void 0?De:0)}}}else O.resetThreadUnreadNotificationCountFromSync();if(C.timeline=C.timeline||{},C.isBrandNewRoom)C.timeline.prev_batch!==null&&O.getLiveTimeline().setPaginationToken(C.timeline.prev_batch,Oe.BACKWARDS);else if(C.timeline.limited){for(var H=!0,le=I.length-1;le>=0;le--){var Re=I[le].getId();if(O.getTimelineForEvent(Re)){n.syncOpts.logger.debug("Already have event ".concat(Re," in limited sync - not resetting")),H=!1,I.splice(0,le);break}}if(H){var X;O.resetLiveTimeline(C.timeline.prev_batch,n.syncOpts.canResetEntireTimeline(O.roomId)?null:(X=e.oldSyncToken)!==null&&X!==void 0?X:null),h.resetNotifTimelineSet()}}if(n.syncOpts.cryptoCallbacks)for(var fe of ue)fe.isState()&&fe.getType()===Z.RoomEncryption&&fe.getStateKey()===""&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(O,fe));for(var B of I.filter(j=>j.isState()))yield n.client.decryptEventIfNeeded(B);try{"org.matrix.msc4222.state_after"in C?yield n.injectRoomEvents(O,void 0,E,I,e.fromCache):yield n.injectRoomEvents(O,M,void 0,I,e.fromCache)}catch(j){n.syncOpts.logger.error("Failed to process events on room ".concat(O.roomId,":"),j)}C.summary&&O.setSummary(C.summary),O.addEphemeralEvents(w),O.addAccountData(q);var F=z.concat(I.filter(j=>j.unstableStickyInfo!==void 0));O._unstable_addStickyEvents(F),O.recalculate(),C.isBrandNewRoom&&(h.store.storeRoom(O),h.emit(Ue.Room,O)),n.processEventsForNotifs(O,I);var x=j=>h.emit(Ue.Event,j);M.forEach(x),I.forEach(x),w.forEach(x),q.forEach(x),z.filter(j=>!I.some(P=>P.getId()===j.getId())).forEach(x),O.decryptCriticalEvents()});return function(C){return A.apply(this,arguments)}})()),yield Fs(T,(function(){var A=D(function*(C){var U=C.room,{timelineEvents:O,stateEvents:M,stateAfterEvents:E}=yield n.mapAndInjectRoomEvents(C),I=n.mapSyncEventsFormat(C.account_data);U.addAccountData(I),U.recalculate(),C.isBrandNewRoom&&(h.store.storeRoom(U),h.emit(Ue.Room,U)),n.processEventsForNotifs(U,O),M?.forEach(function(w){h.emit(Ue.Event,w)}),E?.forEach(function(w){h.emit(Ue.Event,w)}),O.forEach(function(w){h.emit(Ue.Event,w)}),I.forEach(function(w){h.emit(Ue.Event,w)})});return function(C){return A.apply(this,arguments)}})()),yield Fs(k,(function(){var A=D(function*(C){var U=C.room,O=n.mapSyncEventsFormat(C.knock_state,U);yield n.injectRoomEvents(U,O,void 0),C.isBrandNewRoom?(U.recalculate(),h.store.storeRoom(U),h.emit(Ue.Room,U)):U.recalculate(),O.forEach(function(M){h.emit(Ue.Event,M)})});return function(C){return A.apply(this,arguments)}})()),e.oldSyncToken&&n.notifEvents.length&&(n.notifEvents.sort(function(A,C){return A.getTs()-C.getTs()}),n.notifEvents.forEach(function(A){var C;(C=h.getNotifTimelineSet())===null||C===void 0||C.addLiveEvent(A,{addToState:!0})})),t.device_lists&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(u=n.syncOpts.cryptoCallbacks)===null||u===void 0?void 0:u.processKeyCounts(t.device_one_time_keys_count,(d=t.device_unused_fallback_key_types)!==null&&d!==void 0?d:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var n=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request(se.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{n()},i=>{i.httpStatus==400||i.httpStatus==404?this.keepAliveTimer=setTimeout(n,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(gt.Error,{error:i}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(n=>!Ul(n)).map(n=>{var i=t.store.getRoom(n),o=!1;return i||(i=this.createRoom(n),o=!0),nd(nd({},e[n]),{},{room:i,isBrandNewRoom:o})})}mapSyncEventsFormat(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var i=this.client.getEventMapper({decrypt:n});return e.events.filter(Tr).map(function(o){return t&&(o.room_id=t.roomId),i(o)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ye.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),o;i?o=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):o=t.getProfileInfo(n.userId),o.then(function(u){var d=n.events.member;d?.getContent().membership===Ye.Invite&&(d.getContent().avatar_url=u.avatar_url,d.getContent().displayname=u.displayname,n.setMembershipEvent(d,e.currentState))},function(u){})}})}}findEncryptionEvent(e){return e?.find(t=>t.getType()===Z.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return D(function*(){var n=t.mapSyncEventsFormat(e.state,e.room),i=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),o=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,i,o):yield t.injectRoomEvents(e.room,n,void 0,o),{timelineEvents:o,stateEvents:n,stateAfterEvents:i}})()}injectRoomEvents(e,t,n,i){var o=arguments,u=this;return D(function*(){var d=o.length>4&&o[4]!==void 0?o[4]:!1,h=n??t,f=e.getLiveTimeline(),m=f.getEvents().length==0;if(m){for(var g of h)u.client.getPushActionsForEvent(g);f.initialiseState(h,{timelineWasEmpty:m})}u.resolveInvites(e),e.recalculate(),m||(e.oldState.setStateEvents(h),e.currentState.setStateEvents(h)),yield e.addLiveEvents(i||[],{fromCache:d,timelineWasEmpty:m,addToState:n===void 0}),u.client.processBeaconEvents(e,i)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var n of t){var i,o=this.client.getPushActionsForEvent(n);o!=null&&o.notify&&(i=o.tweaks)!==null&&i!==void 0&&i.highlight&&this.notifEvents.push(n)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(Ue.Sync,this.syncState,n,t)}}function P0(s,e,t){var{timelineSupport:n}=s,i=new hd(e,s,s.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:n});return s.reEmitter.reEmit(i,[ke.Name,ke.Redaction,ke.RedactionCancelled,ke.Receipt,ke.Tags,ke.LocalEchoUpdated,ke.AccountData,ke.MyMembership,ke.Timeline,ke.TimelineReset,rt.Events,rt.Members,rt.NewMember,rt.Update,Nt.New,Nt.Update,Nt.Destroy,Nt.LivenessChange]),i.on(rt.NewMember,(o,u,d)=>{var h;d.user=(h=s.getUser(d.userId))!==null&&h!==void 0?h:void 0,s.reEmitter.reEmit(d,[Un.Name,Un.Typing,Un.PowerLevel,Un.Membership])}),i}function N0(s,e){var t=[];s.map(n=>{if(n.message.type==="m.key.verification.cancel"){var i=n.message.content.transaction_id;i&&t.push(i)}return n}).forEach(function(n){{var i=n.message,o=i.content,u=new yn(Object.assign({},i));if(i.type==="m.key.verification.start"||i.type==="m.key.verification.request"){var d=o.transaction_id;t.includes(d)&&u.flagCancelled()}n.encryptionInfo&&u.makeEncrypted(Z.RoomMessageEncrypted,{ciphertext:""},n.encryptionInfo.senderCurve25519KeyBase64,""),e.emit(Ue.ToDeviceEvent,u)}e.emit(Ue.ReceivedToDeviceMessage,n)})}class xI{constructor(){y(this,"accountData",new Map),y(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,n,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return D(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return D(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return D(function*(){return Promise.resolve()})()}destroy(){return D(function*(){})()}}const mn=[];for(let s=0;s<256;++s)mn.push((s+256).toString(16).slice(1));function jI(s,e=0){return(mn[s[e+0]]+mn[s[e+1]]+mn[s[e+2]]+mn[s[e+3]]+"-"+mn[s[e+4]]+mn[s[e+5]]+"-"+mn[s[e+6]]+mn[s[e+7]]+"-"+mn[s[e+8]]+mn[s[e+9]]+"-"+mn[s[e+10]]+mn[s[e+11]]+mn[s[e+12]]+mn[s[e+13]]+mn[s[e+14]]+mn[s[e+15]]).toLowerCase()}let Zh;const BI=new Uint8Array(16);function FI(){if(!Zh){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Zh=crypto.getRandomValues.bind(crypto)}return Zh(BI)}const qI=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),lE={randomUUID:qI};function KI(s,e,t){s=s||{};const n=s.random??s.rng?.()??FI();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,jI(n)}function HI(s,e,t){return lE.randomUUID&&!s?lE.randomUUID():KI(s)}var yr={},$h={},ev={exports:{}},uE;function Im(){if(uE)return ev.exports;uE=1;var s=ev.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(s).forEach(function(e){var t=s[e];t.forEach(function(n){n.reg||(n.reg=/(.*)/),n.format||(n.format="%s")})}),ev.exports}var cE;function VI(){return cE||(cE=1,(function(s){var e=function(d){return String(Number(d))===d?Number(d):d},t=function(d,h,f,m){if(m&&!f)h[m]=e(d[1]);else for(var g=0;g<f.length;g+=1)d[g+1]!=null&&(h[f[g]]=e(d[g+1]))},n=function(d,h,f){var m=d.name&&d.names;d.push&&!h[d.push]?h[d.push]=[]:m&&!h[d.name]&&(h[d.name]={});var g=d.push?{}:m?h[d.name]:h;t(f.match(d.reg),g,d.names,d.name),d.push&&h[d.push].push(g)},i=Im(),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);s.parse=function(d){var h={},f=[],m=h;return d.split(/(\r\n|\r|\n)/).filter(o).forEach(function(g){var S=g[0],_=g.slice(2);S==="m"&&(f.push({rtp:[],fmtp:[]}),m=f[f.length-1]);for(var b=0;b<(i[S]||[]).length;b+=1){var T=i[S][b];if(T.reg.test(_))return n(T,m,_)}}),h.media=f,h};var u=function(d,h){var f=h.split(/=(.+)/,2);return f.length===2?d[f[0]]=e(f[1]):f.length===1&&h.length>1&&(d[f[0]]=void 0),d};s.parseParams=function(d){return d.split(/;\s?/).reduce(u,{})},s.parseFmtpConfig=s.parseParams,s.parsePayloads=function(d){return d.toString().split(" ").map(Number)},s.parseRemoteCandidates=function(d){for(var h=[],f=d.split(" ").map(e),m=0;m<f.length;m+=3)h.push({component:f[m],ip:f[m+1],port:f[m+2]});return h},s.parseImageAttributes=function(d){return d.split(" ").map(function(h){return h.substring(1,h.length-1).split(",").reduce(u,{})})},s.parseSimulcastStreamList=function(d){return d.split(";").map(function(h){return h.split(",").map(function(f){var m,g=!1;return f[0]!=="~"?m=e(f):(m=e(f.substring(1,f.length)),g=!0),{scid:m,paused:g}})})}})($h)),$h}var tv,dE;function GI(){if(dE)return tv;dE=1;var s=Im(),e=/%[sdv%]/g,t=function(u){var d=1,h=arguments,f=h.length;return u.replace(e,function(m){if(d>=f)return m;var g=h[d];switch(d+=1,m){case"%%":return"%";case"%s":return String(g);case"%d":return Number(g);case"%v":return""}})},n=function(u,d,h){var f=d.format instanceof Function?d.format(d.push?h:h[d.name]):d.format,m=[u+"="+f];if(d.names)for(var g=0;g<d.names.length;g+=1){var S=d.names[g];d.name?m.push(h[d.name][S]):m.push(h[d.names[g]])}else m.push(h[d.name]);return t.apply(null,m)},i=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];return tv=function(u,d){d=d||{},u.version==null&&(u.version=0),u.name==null&&(u.name=" "),u.media.forEach(function(g){g.payloads==null&&(g.payloads="")});var h=d.outerOrder||i,f=d.innerOrder||o,m=[];return h.forEach(function(g){s[g].forEach(function(S){S.name in u&&u[S.name]!=null?m.push(n(g,S,u)):S.push in u&&u[S.push]!=null&&u[S.push].forEach(function(_){m.push(n(g,S,_))})})}),u.media.forEach(function(g){m.push(n("m",s.m[0],g)),f.forEach(function(S){s[S].forEach(function(_){_.name in g&&g[_.name]!=null?m.push(n(S,_,g)):_.push in g&&g[_.push]!=null&&g[_.push].forEach(function(b){m.push(n(S,_,b))})})})}),m.join(`\r
`)+`\r
`},tv}var fE;function zI(){if(fE)return yr;fE=1;var s=VI(),e=GI(),t=Im();return yr.grammar=t,yr.write=e,yr.parse=s.parse,yr.parseParams=s.parseParams,yr.parseFmtpConfig=s.parseFmtpConfig,yr.parsePayloads=s.parsePayloads,yr.parseRemoteCandidates=s.parseRemoteCandidates,yr.parseImageAttributes=s.parseImageAttributes,yr.parseSimulcastStreamList=s.parseSimulcastStreamList,yr}var Pv=zI();function Om(s,e){if(typeof s.toBase64=="function")return s.toBase64(e);var t=btoa(s.reduce((n,i)=>n+String.fromCharCode(i),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}function Nl(s){return Om(s,{alphabet:"base64",omitPadding:!1})}function Mm(s){return Om(s,{alphabet:"base64",omitPadding:!0})}function vd(s){return Om(s,{alphabet:"base64url",omitPadding:!0})}function WI(s,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(s,e):Uint8Array.from(atob(s),t=>t.charCodeAt(0))}function Ba(s){return WI(s.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}var YI="abcdefghijklmnopqrstuvwxyz",JI="ABCDEFGHIJKLMNOPQRSTUVWXYZ",XI="0123456789";function QI(s){var e=new Uint8Array(s);return globalThis.crypto.getRandomValues(e),vd(e)}function Zi(s){return ZI(s,JI+YI+XI)}function ZI(s,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(s<1||s>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,n=new Uint8Array(Math.floor(s*1.3)),i=n.length,o=[];o.length<s;){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var u=n[i++];u<t&&o.push(e[u%e.length])}return o.join("")}var Hi="org.matrix.msc3077.sdp_stream_metadata",Ot=(function(s){return s.Usermedia="m.usermedia",s.Screenshare="m.screenshare",s})({}),Ll=null,Nv=0,$I=()=>(Ll===null&&(Ll=new AudioContext),Nv++,Ll),eO=()=>{if(Nv--,Nv===0){var s;(s=Ll)===null||s===void 0||s.close(),Ll=null}},tO=200,Lv=-60,nO=8,Ur=(function(s){return s.NewStream="new_stream",s.MuteStateChanged="mute_state_changed",s.LocalVolumeChanged="local_volume_changed",s.VolumeChanged="volume_changed",s.ConnectedChanged="connected_changed",s.Speaking="speaking",s.Disposed="disposed",s})({});class di extends Lt{constructor(e){super(),y(this,"stream",void 0),y(this,"sdpMetadataStreamId",void 0),y(this,"userId",void 0),y(this,"deviceId",void 0),y(this,"purpose",void 0),y(this,"speakingVolumeSamples",void 0),y(this,"client",void 0),y(this,"call",void 0),y(this,"roomId",void 0),y(this,"audioMuted",void 0),y(this,"videoMuted",void 0),y(this,"localVolume",1),y(this,"measuringVolumeActivity",!1),y(this,"audioContext",void 0),y(this,"analyser",void 0),y(this,"frequencyBinCount",void 0),y(this,"speakingThreshold",Lv),y(this,"speaking",!1),y(this,"volumeLooperTimeout",void 0),y(this,"_disposed",!1),y(this,"_connected",!1),y(this,"onAddTrack",()=>{this.emit(Ur.NewStream,this.stream)}),y(this,"onCallState",t=>{t===Ge.Connected?this.connected=!0:t===Ge.Connecting&&(this.connected=!1)}),y(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var n of this.frequencyBinCount)n>t&&(t=n);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(Ur.VolumeChanged,t);var i=!1;for(var o of this.speakingVolumeSamples)if(o>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.emit(Ur.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,tO)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(nO).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(et.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(Ur.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var n=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),n&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(Ur.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=$I()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t?.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(Ur.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(Ur.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return N.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Ot.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new di({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(et.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,eO()),this._disposed=!0,this.emit(Ur.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(Ur.LocalVolumeChanged,e)}}var rO=3e3,xv=(function(s){return s.Incoming="Call.incoming",s})({});class iO{constructor(e){y(this,"calls",void 0),y(this,"callEventBuffer",void 0),y(this,"nextSeqByCall",new Map),y(this,"toDeviceEventBuffers",new Map),y(this,"client",void 0),y(this,"candidateEventsByCall",void 0),y(this,"eventBufferPromiseChain",void 0),y(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),y(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),y(this,"onToDeviceEvent",t=>{var n=t.getContent();if(!n.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(n.call_id)||this.nextSeqByCall.set(n.call_id,0),n.seq===void 0){this.callEventBuffer.push(t);return}var i=this.nextSeqByCall.get(n.call_id)||0;if(n.seq!==i){this.toDeviceEventBuffers.has(n.call_id)||this.toDeviceEventBuffers.set(n.call_id,[]);var o=this.toDeviceEventBuffers.get(n.call_id),u=o.findIndex(m=>m.getContent().seq>n.seq);u===-1?o.push(t):o.splice(u,0,t)}else{var d=n.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(d,n.seq+1);for(var h=this.toDeviceEventBuffers.get(d),f=h&&h.shift();f&&f.getContent().seq===this.nextSeqByCall.get(d);)this.callEventBuffer.push(f),this.nextSeqByCall.set(d,f.getContent().seq+1),f=h.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(Ue.Sync,this.onSync),this.client.on(ke.Timeline,this.onRoomTimeline),this.client.on(Ue.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(Ue.Sync,this.onSync),this.client.removeListener(ke.Timeline,this.onRoomTimeline),this.client.removeListener(Ue.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return D(function*(){yield Promise.all(e.map(m=>t.client.decryptEventIfNeeded(m)));var n=e.filter(m=>{var g=m.getType();return g.startsWith("m.call.")||g.startsWith("org.matrix.call.")}),i=new Set;for(var o of n){var u=o.getType();(u===Z.CallAnswer||u===Z.CallHangup)&&i.add(o.getContent().call_id)}for(var d of n){var h=d.getType(),f=d.getContent().call_id;if(!(h===Z.CallInvite&&i.has(f)))try{yield t.handleCallEvent(d)}catch(m){N.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",m)}}})()}handleCallEvent(e){var t=this;return D(function*(){var n;t.client.emit(Ue.ReceivedVoipEvent,e);var i=e.getContent(),o=e.getRoomId()||((n=t.client.groupCallEventHandler.getGroupCallById(i.conf_id))===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.roomId),u=i.conf_id,d=e.getType(),h=e.getSender(),f=i.call_id?t.calls.get(i.call_id):void 0,m,g;if(u){if(g=t.client.groupCallEventHandler.getGroupCallById(u),!g){N.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(u,", type=").concat(d,")"));return}if(m=i.device_id,!m){N.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(h,")")),g.emit(It.Error,new j0(h));return}if(i.dest_session_id!==t.client.getSessionId()){N.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var S=h===t.client.credentials.userId&&(m===void 0||m===t.client.getDeviceId());if(o){if(d===Z.CallInvite){var _,b,T;if(S||e.getLocalAge()>i.lifetime-rO||f&&f.state===Ge.Ended||(f&&N.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(i.call_id,")")),i.invitee&&i.invitee!==t.client.getUserId()))return;var k=((_=t.client.getTurnServersExpiry())!==null&&_!==void 0?_:0)-Date.now();if(N.info("CallEventHandler handleCallEvent() current turn creds expire in "+k+" ms"),f=(b=zl(t.client,o,{forceTURN:t.client.forceTURN,opponentDeviceId:m,groupCallId:u,opponentSessionId:i.sender_session_id}))!==null&&b!==void 0?b:void 0,!f){N.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(i.call_id,")"));return}f.callId=i.call_id;var A=(T=g)===null||T===void 0?void 0:T.getGroupCallStats();A&&f.initStats(A);try{yield f.initWithInvite(e)}catch(q){if(q instanceof ui)if(q.code===jl.UnknownDevice){var C;(C=g)===null||C===void 0||C.emit(It.Error,q)}else N.error(q)}if(t.calls.set(f.callId,f),t.candidateEventsByCall.get(f.callId))for(var U of t.candidateEventsByCall.get(f.callId))f.onRemoteIceCandidatesReceived(U);var O;for(var M of t.calls.values()){var E,I=[Ge.WaitLocalMedia,Ge.CreateOffer,Ge.InviteSent].includes(M.state);if(f.roomId===M.roomId&&M.direction===Gi.Outbound&&((E=f.getOpponentMember())===null||E===void 0?void 0:E.userId)===M.invitee&&I){O=M;break}}O?O.callId>f.callId?(N.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(f.callId,", outgoingId=").concat(O.callId,")")),O.replacedBy(f)):(N.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(f.callId,", outgoingId=").concat(O.callId,")")),f.hangup(Xe.Replaced,!0)):t.client.emit(xv.Incoming,f);return}else if(d===Z.CallCandidates){if(S)return;f?f.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(i.call_id)||t.candidateEventsByCall.set(i.call_id,[]),t.candidateEventsByCall.get(i.call_id).push(e));return}else if([Z.CallHangup,Z.CallReject].includes(d)){if(f)f.state!==Ge.Ended&&(d===Z.CallHangup?f.onHangupReceived(i):f.onRejectReceived(i),f.state===Ge.Ended&&t.calls.delete(i.call_id));else{var w;f=(w=zl(t.client,o,{opponentDeviceId:m,opponentSessionId:i.sender_session_id}))!==null&&w!==void 0?w:void 0,f&&(f.callId=i.call_id,f.initWithHangup(e),t.calls.set(i.call_id,f))}return}if(!f||!f.hasPeerConnection){N.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(d,")"));return}if(e.getContent().party_id!==f.ourPartyId)switch(d){case Z.CallAnswer:S?f.state===Ge.Ringing&&f.onAnsweredElsewhere(i):f.onAnswerReceived(e);break;case Z.CallSelectAnswer:f.onSelectAnswerReceived(e);break;case Z.CallNegotiate:f.onNegotiateReceived(e);break;case Z.CallAssertedIdentity:case Z.CallAssertedIdentityPrefix:f.onAssertedIdentityReceived(e);break;case Z.CallSDPStreamMetadataChanged:case Z.CallSDPStreamMetadataChangedPrefix:f.onSDPStreamMetadataChangedReceived(e);break}}})()}}var jv=(function(s){return s.Incoming="GroupCall.incoming",s.Outgoing="GroupCall.outgoing",s.Ended="GroupCall.ended",s.Participants="GroupCall.participants",s})({});class aO{constructor(e){this.client=e,y(this,"groupCalls",new Map),y(this,"roomDeferreds",new Map),y(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),y(this,"onRoomStateChanged",(t,n)=>{var i=t.getType();if(i===Z.GroupCallPrefix){var o=t.getStateKey(),u=t.getContent(),d=this.groupCalls.get(n.roomId);!d&&!u["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):d&&d.groupCallId===o?u["m.terminated"]||t.isRedacted()?d.terminate(!1):u["m.type"]!==d.type&&N.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(n.roomId,")")):d&&d.groupCallId!==o&&N.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(n.roomId,")"))}})}start(){var e=this;return D(function*(){e.client.getSyncState()!==gt.Syncing&&(N.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(i=>{var o=()=>{if(e.client.getSyncState()===gt.Syncing)return e.client.off(Ue.Sync,o),i()};e.client.on(Ue.Sync,o)}));var t=e.client.getRooms();for(var n of t)e.createGroupCallForRoom(n);e.client.on(Ue.Room,e.onRoomsChanged),e.client.on(rt.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(Ue.Room,this.onRoomsChanged),this.client.removeListener(rt.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var n;t={prom:new Promise(i=>{n=i})},t.resolve=n,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(Z.GroupCallPrefix),n=t.sort((u,d)=>d.getTs()-u.getTs());for(var i of n){var o=i.getContent();if(!(o["m.terminated"]||i.isRedacted())){N.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(i.getStateKey(),", ts=").concat(i.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(i);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(t);if(!i){N.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var o=e.getStateKey(),u=n["m.type"];if(!Object.values(md).includes(u)){N.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(u,", roomId=").concat(t,")"));return}var d=n["m.intent"];if(!Object.values(x0).includes(d)){N.warn("Received invalid group call intent (type=".concat(u,", roomId=").concat(t,")"));return}var h=!!n["io.element.ptt"],f;if(n!=null&&n.dataChannelsEnabled&&n!==null&&n!==void 0&&n.dataChannelOptions){var{ordered:m,maxPacketLifeTime:g,maxRetransmits:S,protocol:_}=n.dataChannelOptions;f={ordered:m,maxPacketLifeTime:g,maxRetransmits:S,protocol:_}}var b=new Am(this.client,i,u,h,d,o,n?.dataChannelsEnabled||this.client.isVoipWithNoMediaAllowed,f,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,b),this.client.emit(jv.Incoming,b),b}}class sO{constructor(){y(this,"bandwidth",{}),y(this,"bitrate",{}),y(this,"packetLoss",{}),y(this,"transport",[])}}class oO{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,n=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:n?Math.round(n/1e3):0}}}class lO{static buildReport(e,t,n,i){var o=e?.get(t.localCandidateId),u=e?.get(t.remoteCandidateId);if(u&&o){var d=u.ip!==void 0?u.ip:u.address,h=u.port,f="".concat(d,":").concat(h),m=o.ip!==void 0?o.ip:o.address,g=o.port,S="".concat(m,":").concat(g),_=u.protocol;n.some(b=>b.ip===f&&b.type===_&&b.localIp===S)||n.push({ip:f,type:_,localIp:S,isFocus:i,localCandidateType:o.candidateType,remoteCandidateType:u.candidateType,networkType:o.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return n}}class uO{constructor(){y(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var n;return this.ssrcToMid[t].forEach((i,o)=>{if(i.find(u=>u==e)){n=o;return}}),n}parse(e,t){var n=Pv.parse(e),i=new Map;n.media.forEach(o=>{if(o.mid&&o.type==="video"||o.type==="audio"){var u,d=[];(u=o.ssrcs)===null||u===void 0||u.forEach(h=>{h.attribute==="cname"&&d.push("".concat(h.id))}),i.set("".concat(o.mid),d)}}),this.ssrcToMid[t]=i}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class cO{constructor(e){this.pc=e}getLocalTracks(e){var t=n=>n!==null&&n.kind===e;return this.pc.getTransceivers().filter(n=>n.currentDirection==="sendonly"||n.currentDirection==="sendrecv").filter(n=>n.sender!==null).map(n=>n.sender).map(n=>n.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if(t?.sender.track!==null&&t.sender.track.id===e)return t.sender.track;if(t?.receiver.track!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class dO{constructor(e,t,n){this.trackId=e,this.type=t,this.kind=n,y(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),y(this,"bitrate",{download:0,upload:0}),y(this,"resolution",{width:-1,height:-1}),y(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),y(this,"framerate",0),y(this,"jitter",0),y(this,"codec",""),y(this,"isAlive",!0),y(this,"isMuted",!1),y(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class fO{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,y(this,"track2stats",new Map)}findTrack2Stats(e,t){var n;if(e.trackIdentifier)n=e.trackIdentifier;else if(e.mid)n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var i=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!i)return;n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(n){var o=this.track2stats.get(n);if(!o){var u=this.mediaTrackHandler.getTackById(n);if(u!==void 0){var d=u.kind==="audio"?u.kind:"video";o=new dO(n,t,d),this.track2stats.set(n,o)}else return}return o}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class Aa{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class Yn{static buildFramerateResolution(e,t){var n={height:t.frameHeight,width:t.frameWidth},i=t.framesPerSecond;n.height&&n.width&&e.setResolution(n),e.setFramerate(Math.round(i||0))}static calculateSimulcastFramerate(e,t,n,i){var o=e.getFramerate();if(!o){if(n){var u=t.timestamp-n.timestamp;if(u>0&&t.framesSent){var d=t.framesSent-n.framesSent;o=d/u*1e3}}if(!o)return}o=i?Math.round(o/i):0,e.setFramerate(o)}static buildCodec(e,t,n){var i=e?.get(n.codecId);if(i){var o=i.mimeType.split("/")[1];o&&t.setCodec(o)}}static buildBitrateReceived(e,t,n){e.setBitrate({download:Yn.calculateBitrate(t.bytesReceived,n.bytesReceived,t.timestamp,n.timestamp),upload:0})}static buildBitrateSend(e,t,n){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,n.bytesSent,t.timestamp,n.timestamp)})}static buildPacketsLost(e,t,n){var i=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",o=t[i];(!o||o<0)&&(o=0);var u=Aa.getNonNegativeValue(n[i]),d=Math.max(0,o-u),h=Aa.getNonNegativeValue(t.packetsLost),f=Aa.getNonNegativeValue(n.packetsLost),m=Math.max(0,h-f);e.setLoss({packetsTotal:d+m,packetsLost:m,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,n,i){var o=Aa.getNonNegativeValue(e),u=Aa.getNonNegativeValue(t),d=Math.max(0,o-u),h=n-i,f=0;return h>0&&(f=Math.round(d*8/h)),f}static setTrackStatsState(e,t){var n;if(t===void 0){e.alive=!1;return}var i=e.getType()==="remote"?t.receiver.track:t==null||(n=t.sender)===null||n===void 0?void 0:n.track;if(i==null){e.alive=!1;return}if(i.readyState==="ended"){e.alive=!1;return}e.muted=i.muted,e.enabled=i.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i=e.filter(u=>u.getType()==="remote"),o=i.filter(u=>u.kind==="audio");return i.forEach(u=>{var d=u.kind==="video"?t:n;if(d.count++,u.alive&&u.muted&&d.muted++,d.maxJitter<u.getJitter()&&(d.maxJitter=u.getJitter()),d.maxPacketLoss<u.getLoss().packetsLost&&(d.maxPacketLoss=u.getLoss().packetsLost),o.length>0){var h,f;d.concealedAudio+=(h=u.getAudioConcealment())===null||h===void 0?void 0:h.concealedAudio,d.totalAudio+=(f=u.getAudioConcealment())===null||f===void 0?void 0:f.totalAudioDuration}}),{audioTrackSummary:n,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var n=t?.jitter;if(n!==void 0){var i=Aa.getNonNegativeValue(n);e.setJitter(Math.round(i*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var n=1e3*t?.totalSamplesDuration/t?.totalSamplesReceived,i=n*t?.concealedSamples,o=1e3*t?.totalSamplesDuration;e.setAudioConcealment(i,o)}}}class xl{static build(e){var t={},n={download:0,upload:0},i={download:0,upload:0},o=0,u=0,d={local:new Map,remote:new Map},h={local:new Map,remote:new Map},f={local:new Map,remote:new Map},m=new Map,g=new Map,S=0,_=0,b=0,T=0,k=0,A=0;for(var[C,U]of e){var O=U.getLoss(),M=O.isDownloadStream?"download":"upload";if(n[M]+=O.packetsTotal,i[M]+=O.packetsLost,o+=U.getBitrate().download,u+=U.getBitrate().upload,U.kind==="audio"){var E=U.getAudioConcealment();k+=E.concealedAudio,A+=E.totalAudioDuration,S+=U.getBitrate().download,_+=U.getBitrate().upload}else b+=U.getBitrate().download,T+=U.getBitrate().upload;d[U.getType()].set(C,U.getResolution()),h[U.getType()].set(C,U.getFramerate()),f[U.getType()].set(C,U.getCodec()),U.getType()==="remote"&&(m.set(C,U.getJitter()),U.kind==="audio"&&g.set(C,U.getAudioConcealment())),U.resetBitrate()}return t.bitrate={upload:u,download:o},t.bitrate.audio={upload:_,download:S},t.bitrate.video={upload:T,download:b},t.packetLoss={total:xl.calculatePacketLoss(i.download+i.upload,n.download+n.upload),download:xl.calculatePacketLoss(i.download,n.download),upload:xl.calculatePacketLoss(i.upload,n.upload)},t.audioConcealment=g,t.totalAudioConcealment={concealedAudio:k,totalAudioDuration:A},t.framerate=h,t.resolution=d,t.codec=f,t.jitter=m,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Qi{static buildCallFeedReport(e,t,n){var i=n.getTransceivers(),o=[],u=[];return i.forEach(d=>{var h,f=(h=d.sender)!==null&&h!==void 0&&h.track?Qi.buildTrackStats(d.sender.track,"sender"):null,m=Qi.buildTrackStats(d.receiver.track,"receiver");o.push({mid:d.mid==null?"null":d.mid,direction:d.direction,currentDirection:d.currentDirection==null?"null":d.currentDirection,sender:f,receiver:m})}),{callId:e,opponentMemberId:t,transceiver:o,callFeeds:u}}static buildTrackStats(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",o=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,u=(n=e.getConstraints())===null||n===void 0?void 0:n.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:o??"unknown",constrainDeviceId:u??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:i}}static expandCallFeedReport(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(i=>{var o=i.stream.getAudioTracks(),u=i.stream.getVideoTracks(),d=o.length>0?Qi.buildTrackStats(i.stream.getAudioTracks()[0],i.purpose):null,h=u.length>0?Qi.buildTrackStats(i.stream.getVideoTracks()[0],i.purpose):null,f={stream:i.stream.id,type:i.isLocal()?"local":"remote",audio:d,video:h,purpose:i.purpose,prefix:n,isVideoMuted:i.isVideoMuted(),isAudioMuted:i.isAudioMuted()};e.callFeeds.push(f)}),e}}function hE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Cc(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):hE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}class hO{constructor(e,t,n,i){var o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=n,this.emitter=i,this.isFocus=o,y(this,"isActive",!0),y(this,"previousStatsReport",void 0),y(this,"currentStatsReport",void 0),y(this,"connectionStats",new sO),y(this,"trackStats",void 0),n.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new fO(new uO,new cO(n))}processStats(e,t){var n=this;return D(function*(){var i={isFirstCollection:n.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(n.isActive){var o=n.pc.getStats();if(typeof o?.then=="function")return o.then(u=>{var d,h;n.currentStatsReport=typeof u?.result=="function"?u.result():u;try{n.processStatsReport(e,t)}catch(m){return n.handleError(m),i}n.previousStatsReport=n.currentStatsReport,i.receivedMedia=n.connectionStats.bitrate.download,i.receivedAudioMedia=((d=n.connectionStats.bitrate.audio)===null||d===void 0?void 0:d.download)||0,i.receivedVideoMedia=((h=n.connectionStats.bitrate.video)===null||h===void 0?void 0:h.download)||0;var f=Yn.buildTrackSummary(Array.from(n.trackStats.getTrack2stats().values()));return Cc(Cc({},i),{},{audioTrackSummary:f.audioTrackSummary,videoTrackSummary:f.videoTrackSummary})}).catch(u=>(n.handleError(u),i));n.isActive=!1}return Promise.resolve(i)})()}processStatsReport(e,t){var n,i=new Map;i.callId=this.callId,i.opponentMemberId=this.opponentMemberId,(n=this.currentStatsReport)===null||n===void 0||n.forEach(o=>{var u=this.previousStatsReport?this.previousStatsReport.get(o.id):null;if(o.type==="candidate-pair"&&o.nominated&&o.state==="succeeded")this.connectionStats.bandwidth=oO.buildBandwidthReport(o),this.connectionStats.transport=lO.buildReport(this.currentStatsReport,o,this.connectionStats.transport,this.isFocus);else if(o.type==="inbound-rtp"||o.type==="outbound-rtp"){var d=this.trackStats.findTrack2Stats(o,o.type==="inbound-rtp"?"remote":"local");if(!d)return;if(u&&Yn.buildPacketsLost(d,o,u),o.type==="inbound-rtp"){Yn.buildFramerateResolution(d,o),u&&Yn.buildBitrateReceived(d,o,u);var h=this.trackStats.findTransceiverByTrackId(d.trackId);Yn.setTrackStatsState(d,h),Yn.buildJitter(d,o),Yn.buildAudioConcealment(d,o)}else u&&(i.set(d.trackId,Aa.getNonNegativeValue(o.bytesSent)),Yn.buildBitrateSend(d,o,u));Yn.buildCodec(this.currentStatsReport,d,o)}else if(o.type==="track"&&o.kind==="video"&&!o.remoteSource){var f=this.trackStats.findLocalVideoTrackStats(o);if(!f)return;Yn.buildFramerateResolution(f,o),Yn.calculateSimulcastFramerate(f,o,u,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(i),this.emitter.emitCallFeedReport(Qi.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,N.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=xl.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(Cc(Cc({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var hi=(function(s){return s.CONNECTION_STATS="StatsReport.connection_stats",s.CALL_FEED_REPORT="StatsReport.call_feed_report",s.BYTE_SENT_STATS="StatsReport.byte_sent_stats",s.SUMMARY_STATS="StatsReport.summary_stats",s})({});class vO extends Lt{emitByteSendReport(e){this.emit(hi.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(hi.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(hi.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(hi.SUMMARY_STATS,e)}}class L0{constructor(e){this.emitter=e}build(e){var t=e.filter(m=>!m.isFirstCollection),n=t.length,i=e.length;if(n!==0){var o={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},u=0,d=0;t.forEach(m=>{this.countTrackListReceivedMedia(o,m),this.countConcealedAudio(o,m),u=this.buildMaxJitter(u,m),d=this.buildMaxPacketLoss(d,m)});var h=5,f={percentageReceivedMedia:Number((o.receivedMedia/n).toFixed(h)),percentageReceivedVideoMedia:Number((o.receivedVideo/n).toFixed(h)),percentageReceivedAudioMedia:Number((o.receivedAudio/n).toFixed(h)),maxJitter:u,maxPacketLoss:d,percentageConcealedAudio:Number(o.totalAudio>0?(o.concealedAudio/o.totalAudio).toFixed(h):0),peerConnections:i};this.emitter.emitSummaryStatsReport(f)}}static extendSummaryReport(e,t){var n=[],i=[];for(var o of t){i.push(o);for(var u of o[1])n.push(u)}e.opponentDevicesInCall=Math.max(0,n.length-1),e.opponentUsersInCall=Math.max(0,i.length-1),e.diffDevicesToPeerConnections=Math.max(0,n.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,n.length-1)==0?0:e.peerConnections/(n.length-1)}countTrackListReceivedMedia(e,t){var n=!1,i=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,n=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,i=!0),i&&n&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class mO{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=n,y(this,"timer",void 0),y(this,"gatherers",new Map),y(this,"reports",new vO),y(this,"summaryStatsReportGatherer",new L0(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,n){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new hO(e,t,n,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var n;(n=this.getStatsReportGatherer(e))===null||n===void 0||n.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{N.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function vE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Ic(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?vE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):vE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var x0=(function(s){return s.Ring="m.ring",s.Prompt="m.prompt",s.Room="m.room",s})({}),md=(function(s){return s.Video="m.video",s.Voice="m.voice",s})({}),pO=(function(s){return s.CallEnded="call_ended",s})({}),It=(function(s){return s.GroupCallStateChanged="group_call_state_changed",s.ActiveSpeakerChanged="active_speaker_changed",s.CallsChanged="calls_changed",s.UserMediaFeedsChanged="user_media_feeds_changed",s.ScreenshareFeedsChanged="screenshare_feeds_changed",s.LocalScreenshareStateChanged="local_screenshare_state_changed",s.LocalMuteStateChanged="local_mute_state_changed",s.ParticipantsChanged="participants_changed",s.Error="group_call_error",s})({}),Dl=(function(s){return s.ConnectionStats="GroupCall.connection_stats",s.ByteSentStats="GroupCall.byte_sent_stats",s.SummaryStats="GroupCall.summary_stats",s.CallFeedStats="GroupCall.call_feed_stats",s})({}),jl=(function(s){return s.NoUserMedia="no_user_media",s.UnknownDevice="unknown_device",s.PlaceCallFailed="place_call_failed",s})({});class Bv extends Error{constructor(e,t,n){n?(super(t+": "+n),y(this,"code",void 0)):(super(t),y(this,"code",void 0)),this.code=e}}class j0 extends Bv{constructor(e){super(jl.UnknownDevice,"No device found for "+e),this.userId=e}}var Ft=(function(s){return s.LocalCallFeedUninitialized="local_call_feed_uninitialized",s.InitializingLocalCallFeed="initializing_local_call_feed",s.LocalCallFeedInitialized="local_call_feed_initialized",s.Entered="entered",s.Ended="ended",s})({}),mE=1e3*60*60;function Oc(s){var e;return((e=s.getOpponentMember())===null||e===void 0?void 0:e.userId)||s.invitee||null}class Am extends Lt{constructor(e,t,n,i,o,u,d,h,f){var m,g,S=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,_=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=n,this.isPtt=i,this.intent=o,this.dataChannelsEnabled=d,this.dataChannelOptions=h,this.useLivekit=S,y(this,"activeSpeakerInterval",1e3),y(this,"retryCallInterval",5e3),y(this,"participantTimeout",1e3*15),y(this,"pttMaxTransmitTime",1e3*20),y(this,"activeSpeaker",void 0),y(this,"localCallFeed",void 0),y(this,"localScreenshareFeed",void 0),y(this,"localDesktopCapturerSourceId",void 0),y(this,"userMediaFeeds",[]),y(this,"screenshareFeeds",[]),y(this,"groupCallId",void 0),y(this,"allowCallWithoutVideoAndAudio",void 0),y(this,"calls",new Map),y(this,"callHandlers",new Map),y(this,"activeSpeakerLoopInterval",void 0),y(this,"retryCallLoopInterval",void 0),y(this,"retryCallCounts",new Map),y(this,"reEmitter",void 0),y(this,"transmitTimer",null),y(this,"participantsExpirationTimer",null),y(this,"resendMemberStateTimer",null),y(this,"initWithAudioMuted",!1),y(this,"initWithVideoMuted",!1),y(this,"initCallFeedPromise",void 0),y(this,"_livekitServiceURL",void 0),y(this,"stats",void 0),y(this,"statsCollectIntervalTime",0),y(this,"onConnectionStats",b=>{this.emit(Dl.ConnectionStats,{report:b})}),y(this,"onByteSentStats",b=>{this.emit(Dl.ByteSentStats,{report:b})}),y(this,"onSummaryStats",b=>{L0.extendSummaryReport(b,this.participants),this.emit(Dl.SummaryStats,{report:b})}),y(this,"onCallFeedReport",b=>{this.localCallFeed&&(b=Qi.expandCallFeedReport(b,[this.localCallFeed],"from-local-feed"));var T=[];this.forEachCall(k=>{k.callId===b.callId&&k.getFeeds().forEach(A=>T.push(A))}),b=Qi.expandCallFeedReport(b,T,"from-call-feed"),this.emit(Dl.CallFeedStats,{report:b})}),y(this,"_state",Ft.LocalCallFeedUninitialized),y(this,"_participants",new Map),y(this,"_creationTs",null),y(this,"_enteredViaAnotherSession",!1),y(this,"onIncomingCall",b=>{var T,k;if(b.roomId===this.room.roomId){if(b.state!==Ge.Ringing){N.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!b.groupCallId||b.groupCallId!==this.groupCallId){N.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),b.reject();return}var A=(T=b.getOpponentMember())===null||T===void 0?void 0:T.userId;if(A===void 0){N.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){N.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var C=(k=this.calls.get(A))!==null&&k!==void 0?k:new Map,U=C.get(b.getOpponentDeviceId());if(U?.callId!==b.callId){N.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(A,", callId=").concat(b.callId,")")),U&&U.hangup(Xe.Replaced,!1),C.set(b.getOpponentDeviceId(),b),this.calls.set(A,C),this.initCall(b);var O=this.getLocalFeeds().map(E=>E.clone());if(!this.callExpected(b))for(var M of O)$t(M.stream.getAudioTracks(),!1),$t(M.stream.getVideoTracks(),!1);b.answerWithCallFeeds(O),this.emit(It.CallsChanged,this.calls)}}}),y(this,"onRetryCallLoop",()=>{var b=!1;for(var[{userId:T},k]of this.participants){var A=this.calls.get(T),C=this.retryCallCounts.get(T);for(var[U,O]of k){var M,E,I=A?.get(U),w=(M=(E=C)===null||E===void 0?void 0:E.get(U))!==null&&M!==void 0?M:0;I?.getOpponentSessionId()!==O.sessionId&&this.wantsOutgoingCall(T,U)&&w<3&&(C===void 0&&(C=new Map,this.retryCallCounts.set(T,C)),C.set(U,w+1),b=!0)}}b&&this.placeOutgoingCalls()}),y(this,"onCallFeedsChanged",b=>{var T=Oc(b),k=b.getOpponentDeviceId();if(!T)throw new Error("Cannot change call feeds without user id");var A=this.getUserMediaFeed(T,k),C=b.remoteUsermediaFeed,U=C!==A,O=this.calls.get(T),M=O?.get(k);if(M?.callId===b.callId){U&&(!A&&C?this.addUserMediaFeed(C):A&&C?this.replaceUserMediaFeed(A,C):A&&!C&&this.removeUserMediaFeed(A));var E=this.getScreenshareFeed(T,k),I=b.remoteScreensharingFeed,w=I!==E;w&&(!E&&I?this.addScreenshareFeed(I):E&&I?this.replaceScreenshareFeed(E,I):E&&!I&&this.removeScreenshareFeed(E))}}),y(this,"onCallStateChanged",(b,T,k)=>{var A;if(T!==Ge.Ended){var C=this.localCallFeed.isAudioMuted();b.localUsermediaStream&&b.isMicrophoneMuted()!==C&&b.setMicrophoneMuted(C);var U=this.localCallFeed.isVideoMuted();b.localUsermediaStream&&b.isLocalVideoMuted()!==U&&b.setLocalVideoMuted(U);var O=(A=b.getOpponentMember())===null||A===void 0?void 0:A.userId;if(T===Ge.Connected&&O){var M=this.retryCallCounts.get(O);M?.delete(b.getOpponentDeviceId()),M?.size===0&&this.retryCallCounts.delete(O)}}}),y(this,"onCallHangup",b=>{var T,k;if(b.hangupReason!==Xe.Replaced){var A=(T=(k=b.getOpponentMember())===null||k===void 0?void 0:k.userId)!==null&&T!==void 0?T:this.room.getMember(b.invitee).userId,C=this.calls.get(A);C?.get(b.getOpponentDeviceId())===b&&(this.disposeCall(b,b.hangupReason),C.delete(b.getOpponentDeviceId()),C.size===0&&this.calls.delete(A),this.emit(It.CallsChanged,this.calls))}}),y(this,"onCallReplaced",(b,T)=>{var k=b.getOpponentMember().userId,A=this.calls.get(k);A===void 0&&(A=new Map,this.calls.set(k,A)),b.hangup(Xe.Replaced,!1),this.initCall(T),A.set(b.getOpponentDeviceId(),T),this.emit(It.CallsChanged,this.calls)}),y(this,"onActiveSpeakerLoop",()=>{var b=void 0,T=void 0;for(var k of this.userMediaFeeds)if(!(k.isLocal()&&this.userMediaFeeds.length>1)){var A=k.speakingVolumeSamples.reduce((U,O)=>U+Math.max(O,Lv)),C=A/k.speakingVolumeSamples.length;(!b||C>b)&&(b=C,T=k)}T&&this.activeSpeaker!==T&&b&&b>Lv&&(this.activeSpeaker=T,this.emit(It.ActiveSpeakerChanged,this.activeSpeaker))}),y(this,"onRoomState",()=>this.updateParticipants()),y(this,"onParticipantsChanged",()=>{this.forEachCall(b=>{var T=this.callExpected(b);for(var k of b.getLocalFeeds())$t(k.stream.getAudioTracks(),!k.isAudioMuted()&&T),$t(k.stream.getVideoTracks(),!k.isVideoMuted()&&T)}),this.state===Ft.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),y(this,"onStateChanged",(b,T)=>{(b===Ft.Entered||T===Ft.Entered||b===Ft.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(k=>N.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),k)))}),y(this,"onLocalFeedsChanged",()=>{this.state===Ft.Entered&&this.updateMemberState().catch(b=>N.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),b))}),this.reEmitter=new r0(this),this.groupCallId=u??Da(),this._livekitServiceURL=_,this.creationTs=(m=(g=t.currentState.getStateEvents(Z.GroupCallPrefix,this.groupCallId))===null||g===void 0?void 0:g.getTs())!==null&&m!==void 0?m:null,this.updateParticipants(),t.on(rt.Update,this.onRoomState),this.on(It.ParticipantsChanged,this.onParticipantsChanged),this.on(It.GroupCallStateChanged,this.onStateChanged),this.on(It.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!f}create(){var e=this;return D(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(jv.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return D(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,Z.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(It.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,n=(o,u)=>o.sessionId===u.sessionId&&o.screensharing===u.screensharing,i=(o,u)=>yb(o,u,n);yb(e,t,i)||(this._participants=e,this.emit(It.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var n of t.values())e(n)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,n=Oc(e),i=n===null?null:this.room.getMember(n),o=e.getOpponentDeviceId();return i!==null&&o!==void 0&&((t=this.participants.get(i))===null||t===void 0?void 0:t.get(o))!==void 0}initLocalCallFeed(){var e=this;return D(function*(){if(e.useLivekit){N.info("Livekit group call: not starting local call feed.");return}if(e.state!==Ft.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=Ft.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return D(function*(){N.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===md.Video)}catch(i){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=Ft.LocalCallFeedUninitialized,i}if(e._state!==Ft.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var n=new di({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Ot.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});$t(t.getAudioTracks(),!n.isAudioMuted()),$t(t.getVideoTracks(),!n.isVideoMuted()),e.localCallFeed=n,e.addUserMediaFeed(n),e.state=Ft.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return D(function*(){if(t.localCallFeed){var n=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var i=t.localCallFeed.isAudioMuted(),o=t.localCallFeed.isVideoMuted();N.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(n.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(i,", vidShouldBeMuted=").concat(o,")")),$t(e.getAudioTracks(),!i),$t(e.getVideoTracks(),!o),t.client.getMediaHandler().stopUserMediaStream(n)}})()}enter(){var e=this;return D(function*(){if(e.state===Ft.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==Ft.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));N.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=Ft.Entered,e.client.on(xv.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Ft.Entered&&(this.forEachCall(t=>t.hangup(Xe.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(xv.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=Ft.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return D(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(rt.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(jv.Ended,t),t.state=Ft.Ended,n){var i=t.room.currentState.getStateEvents(Z.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,Z.GroupCallPrefix,Ic(Ic({},i.getContent()),{},{"m.terminated":pO.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return D(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var n=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(u=>{var d;return(d=u.localUsermediaFeed)===null||d===void 0?void 0:d.setAudioVideoMuted(e,null)});var i=(function(){var u=D(function*(){var d=[];t.forEachCall(h=>d.push(h.sendMetadataUpdate())),yield Promise.all(d).catch(h=>N.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),h))});return function(){return u.apply(this,arguments)}})();if(n&&(yield i()),t.localCallFeed){N.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var o=yield t.checkAudioPermissionIfNecessary(e);if(!o)return!1;t.localCallFeed.setAudioVideoMuted(e,null),$t(t.localCallFeed.stream.getAudioTracks(),!e)}else N.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(u=>$t(u.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(u))),t.emit(It.LocalMuteStateChanged,e,t.isLocalVideoMuted()),n||(yield i()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return D(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if(n?.getTracks().length===0)return N.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return N.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return D(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){N.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(n),t.localCallFeed.setAudioVideoMuted(null,e),$t(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return N.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else N.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var i=[];return t.forEachCall(o=>i.push(o.setLocalVideoMuted(e))),yield Promise.all(i),t.forEachCall(o=>$t(o.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(o))),t.emit(It.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(e===n.isScreensharing())return e;if(e)try{N.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var o=yield n.client.getMediaHandler().getScreensharingStream(i),u=function*(f){var m=()=>{n.setScreensharingEnabled(!1),f.removeEventListener("ended",m)};f.addEventListener("ended",m)};for(var d of o.getTracks())yield*u(d);return N.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),n.localDesktopCapturerSourceId=i.desktopCapturerSourceId,n.localScreenshareFeed=new di({client:n.client,roomId:n.room.roomId,userId:n.client.getUserId(),deviceId:n.client.getDeviceId(),stream:o,purpose:Ot.Screenshare,audioMuted:!1,videoMuted:!1}),n.addScreenshareFeed(n.localScreenshareFeed),n.emit(It.LocalScreenshareStateChanged,!0,n.localScreenshareFeed,n.localDesktopCapturerSourceId),n.forEachCall(h=>h.pushLocalFeed(n.localScreenshareFeed.clone())),!0}catch(h){if(i.throwOnFail)throw h;return N.error("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() enabling screensharing error"),h),n.emit(It.Error,new Bv(jl.NoUserMedia,"Failed to get screen-sharing stream: ",h)),!1}else return n.forEachCall(h=>{h.localScreensharingFeed&&h.removeLocalFeed(h.localScreensharingFeed)}),n.client.getMediaHandler().stopScreensharingStream(n.localScreenshareFeed.stream),n.removeScreenshareFeed(n.localScreenshareFeed),n.localScreenshareFeed=void 0,n.localDesktopCapturerSourceId=void 0,n.emit(It.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var n=this.client.getUserId(),i=this.client.getDeviceId();return e>=n&&(e!==n||t>i)}placeOutgoingCalls(){var e=this,t=!1,n=function(d){var h,f=(h=e.calls.get(d))!==null&&h!==void 0?h:new Map,m=function(b){var T=f.get(b);if(T?.getOpponentSessionId()!==S.sessionId&&e.wantsOutgoingCall(d,b)){t=!0,T!==void 0&&(N.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(d,", deviceId=").concat(b,", callId=").concat(T.callId,")")),T.hangup(Xe.NewSession,!1));var k=zl(e.client,e.room.roomId,{invitee:d,opponentDeviceId:b,opponentSessionId:S.sessionId,groupCallId:e.groupCallId});k===null?(N.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(d,", device=").concat(b,")")),f.delete(b)):(e.initCall(k),f.set(b,k),N.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(d,", deviceId=").concat(b,", sessionId=").concat(S.sessionId,")")),k.placeCallWithCallFeeds(e.getLocalFeeds().map(A=>A.clone()),S.screensharing).then(()=>{e.dataChannelsEnabled&&k.createDataChannel("datachannel",e.dataChannelOptions)}).catch(A=>{N.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(d,")"),A),A instanceof ui&&A.code===jl.UnknownDevice?e.emit(It.Error,A):e.emit(It.Error,new Bv(jl.PlaceCallFailed,"Failed to place call to ".concat(d))),k.hangup(Xe.SignallingFailed,!1),f.get(b)===k&&f.delete(b)}))}};for(var[g,S]of o)m(g);f.size>0?e.calls.set(d,f):e.calls.delete(d)};for(var[{userId:i},o]of this.participants)n(i);t&&this.emit(It.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(Z.GroupCallMemberPrefix):this.room.currentState.getStateEvents(Z.GroupCallMemberPrefix,e)}initCall(e){var t=Oc(e);if(!t)throw new Error("Cannot init call without user id");var n=()=>this.onCallFeedsChanged(e),i=(h,f)=>this.onCallStateChanged(e,h,f),o=this.onCallHangup,u=h=>this.onCallReplaced(e,h),d=this.callHandlers.get(t);d===void 0&&(d=new Map,this.callHandlers.set(t,d)),d.set(e.getOpponentDeviceId(),{onCallFeedsChanged:n,onCallStateChanged:i,onCallHangup:o,onCallReplaced:u}),e.on(et.FeedsChanged,n),e.on(et.State,i),e.on(et.Hangup,o),e.on(et.Replaced,u),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(et)),e.initStats(this.getGroupCallStats()),n()}disposeCall(e,t){var n=Oc(e),i=e.getOpponentDeviceId();if(!n)throw new Error("Cannot dispose call without user id");var o=this.callHandlers.get(n),{onCallFeedsChanged:u,onCallStateChanged:d,onCallHangup:h,onCallReplaced:f}=o.get(i);if(e.removeListener(et.FeedsChanged,u),e.removeListener(et.State,d),e.removeListener(et.Hangup,h),e.removeListener(et.Replaced,f),o.delete(n),o.size===0&&this.callHandlers.delete(n),e.hangupReason!==Xe.Replaced){var m=this.getUserMediaFeed(n,i);m&&this.removeUserMediaFeed(m);var g=this.getScreenshareFeed(n,i);g&&this.removeScreenshareFeed(g)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(n=>n.userId===e&&n.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(It.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var n=this.userMediaFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(n,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(It.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(It.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(It.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(n=>n.userId===e&&n.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(It.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var n=this.screenshareFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(n,1,t),e.dispose(),this.emit(It.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(It.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){N.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Ft.Ended){this.participants=new Map;return}var t=new Map,n=Date.now(),i=this.state===Ft.Entered||this.enteredViaAnotherSession,o=1/0;for(var u of this.getMemberStateEvents()){var d=this.room.getMember(u.getStateKey()),h=u.getContent(),f=Array.isArray(h["m.calls"])?h["m.calls"]:[],m=f.find(k=>k["m.call_id"]===this.groupCallId),g=Array.isArray(m?.["m.devices"])?m["m.devices"]:[],S=g.filter(k=>typeof k.device_id=="string"&&typeof k.session_id=="string"&&typeof k.expires_ts=="number"&&k.expires_ts>n&&Array.isArray(k.feeds));if(!i&&d?.userId===this.client.getUserId()&&(S=S.filter(k=>k.device_id!==this.client.getDeviceId())),S.length>0&&d?.membership===Ye.Join){var _=new Map;t.set(d,_);for(var b of S)_.set(b.device_id,{sessionId:b.session_id,screensharing:b.feeds.some(k=>k.purpose===Ot.Screenshare)}),b.expires_ts<o&&(o=b.expires_ts)}}if(i){var T=t.get(e);T===void 0&&(T=new Map,t.set(e,T)),T.has(this.client.getDeviceId())||T.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(k=>k.purpose===Ot.Screenshare)})}this.participants=t,o<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),o-n))}updateDevices(e){var t=arguments,n=this;return D(function*(){var i,o=t.length>1&&t[1]!==void 0?t[1]:!1,u=Date.now(),d=n.client.getUserId(),h=n.getMemberStateEvents(d),f=(i=h?.getContent())!==null&&i!==void 0?i:{},m=Array.isArray(f["m.calls"])?f["m.calls"]:[],g=null,S=[];for(var _ of m)_["m.call_id"]===n.groupCallId?g=_:S.push(_);g===null&&(g={});var b=Array.isArray(g["m.devices"])?g["m.devices"]:[],T=b.filter(U=>typeof U.device_id=="string"&&typeof U.session_id=="string"&&typeof U.expires_ts=="number"&&U.expires_ts>u&&Array.isArray(U.feeds)),k=e(T);if(k!==null){var A=[...S];k.length>0&&A.push(Ic(Ic({},g),{},{"m.call_id":n.groupCallId,"m.devices":k}));var C={"m.calls":A};yield n.client.sendStateEvent(n.room.roomId,Z.GroupCallMemberPrefix,C,d,{keepAlive:o})}})()}addDeviceToMemberState(){var e=this;return D(function*(){yield e.updateDevices(t=>[...t.filter(n=>n.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+mE,feeds:e.getLocalFeeds().map(n=>({purpose:n.purpose}))}])})()}updateMemberState(){var e=this;return D(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===Ft.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(D(function*(){N.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){N.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),mE*3/4)):yield e.updateDevices(t=>t.filter(n=>n.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return D(function*(){var{devices:t}=yield e.client.getDevices(),n=new Map(t.map(i=>[i.device_id,i]));yield e.updateDevices(i=>{var o=i.filter(u=>{var d=n.get(u.device_id);return d?.last_seen_ts!==void 0&&!(u.device_id===e.client.getDeviceId()&&e.state!==Ft.Entered&&!e.enteredViaAnotherSession)});return o.length===i.length?null:o})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new mO(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(hi.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(hi.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(hi.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(hi.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function pE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Mc(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?pE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):pE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var Ge=(function(s){return s.Fledgling="fledgling",s.InviteSent="invite_sent",s.WaitLocalMedia="wait_local_media",s.CreateOffer="create_offer",s.CreateAnswer="create_answer",s.Connecting="connecting",s.Connected="connected",s.Ringing="ringing",s.Ended="ended",s})({}),gE=(function(s){return s.Voice="voice",s.Video="video",s})({}),Gi=(function(s){return s.Inbound="inbound",s.Outbound="outbound",s})({}),Ht=(function(s){return s.Local="local",s.Remote="remote",s})({}),et=(function(s){return s.Hangup="hangup",s.State="state",s.Error="error",s.Replaced="replaced",s.LocalHoldUnhold="local_hold_unhold",s.RemoteHoldUnhold="remote_hold_unhold",s.HoldUnhold="hold_unhold",s.FeedsChanged="feeds_changed",s.AssertedIdentityChanged="asserted_identity_changed",s.LengthChanged="length_changed",s.DataChannel="datachannel",s.SendVoipEvent="send_voip_event",s.PeerConnectionCreated="peer_connection_created",s})({}),Xe=(function(s){return s.UserHangup="user_hangup",s.LocalOfferFailed="local_offer_failed",s.NoUserMedia="no_user_media",s.UnknownDevices="unknown_devices",s.SendInvite="send_invite",s.CreateAnswer="create_answer",s.CreateOffer="create_offer",s.SendAnswer="send_answer",s.SetRemoteDescription="set_remote_description",s.SetLocalDescription="set_local_description",s.AnsweredElsewhere="answered_elsewhere",s.IceFailed="ice_failed",s.InviteTimeout="invite_timeout",s.Replaced="replaced",s.SignallingFailed="signalling_timeout",s.UserBusy="user_busy",s.Transferred="transferred",s.NewSession="new_session",s})({}),gO="1",yO="stun:turn.matrix.org",nv=60*1e3,SO=1e3,bO=30*1e3,EO=2*1e3;class ui extends Error{constructor(e,t,n){super(t+": "+n),y(this,"code",void 0),this.code=e}}function Da(){return Date.now().toString()+Zi(16)}function yE(s){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:s?12e3:void 0}];return e}function Sr(s,e){return s+":"+e}class _O extends Lt{constructor(e){var t,n;if(super(),t=this,y(this,"roomId",void 0),y(this,"callId",void 0),y(this,"invitee",void 0),y(this,"hangupParty",void 0),y(this,"hangupReason",void 0),y(this,"direction",void 0),y(this,"ourPartyId",void 0),y(this,"peerConn",void 0),y(this,"toDeviceSeq",0),y(this,"isPtt",!1),y(this,"_state",Ge.Fledgling),y(this,"client",void 0),y(this,"forceTURN",void 0),y(this,"turnServers",void 0),y(this,"candidateSendQueue",[]),y(this,"candidateSendTries",0),y(this,"candidatesEnded",!1),y(this,"feeds",[]),y(this,"transceivers",new Map),y(this,"inviteOrAnswerSent",!1),y(this,"waitForLocalAVStream",!1),y(this,"successor",void 0),y(this,"opponentMember",void 0),y(this,"opponentVersion",void 0),y(this,"opponentPartyId",void 0),y(this,"opponentCaps",void 0),y(this,"iceDisconnectedTimeout",void 0),y(this,"iceReconnectionTimeOut",void 0),y(this,"inviteTimeout",void 0),y(this,"removeTrackListeners",new Map),y(this,"remoteOnHold",!1),y(this,"callStatsAtEnd",void 0),y(this,"makingOffer",!1),y(this,"ignoreOffer",!1),y(this,"isSettingRemoteAnswerPending",!1),y(this,"responsePromiseChain",void 0),y(this,"remoteCandidateBuffer",new Map),y(this,"remoteAssertedIdentity",void 0),y(this,"remoteSDPStreamMetadata",void 0),y(this,"callLengthInterval",void 0),y(this,"callStartTime",void 0),y(this,"opponentDeviceId",void 0),y(this,"hasOpponentDeviceInfo",void 0),y(this,"opponentSessionId",void 0),y(this,"groupCallId",void 0),y(this,"stopVideoTrackTimer",void 0),y(this,"isOnlyDataChannelAllowed",void 0),y(this,"stats",void 0),y(this,"gotLocalIceCandidate",o=>{if(o.candidate){if(this.candidatesEnded&&N.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),N.debug("Call ".concat(this.callId," got local ICE ").concat(o.candidate.sdpMid," ").concat(o.candidate.candidate)),this.callHasEnded())return;o.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(o.candidate)}}),y(this,"onIceGatheringStateChange",o=>{var u;N.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((u=this.peerConn)===null||u===void 0?void 0:u.iceGatheringState)==="complete"&&(this.queueCandidate(null),N.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),y(this,"getLocalOfferFailed",o=>{N.error("Call ".concat(this.callId," getLocalOfferFailed() running"),o),this.emit(et.Error,new ui(Xe.LocalOfferFailed,"Failed to get local offer!",o),this),this.terminate(Ht.Local,Xe.LocalOfferFailed,!1)}),y(this,"getUserMediaFailed",o=>{if(this.successor){this.successor.getUserMediaFailed(o);return}N.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),o),this.emit(et.Error,new ui(Xe.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",o),this),this.terminate(Ht.Local,Xe.NoUserMedia,!1)}),y(this,"placeCallFailed",o=>{if(this.successor){this.successor.placeCallFailed(o);return}N.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),o),this.emit(et.Error,new ui(Xe.IceFailed,"Couldn't start call! Invalid ICE server configuration.",o),this),this.terminate(Ht.Local,Xe.IceFailed,!1)}),y(this,"onIceConnectionStateChanged",()=>{var o,u,d,h,f,m;if(!this.callHasEnded()){if(N.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((o=this.peerConn)===null||o===void 0?void 0:o.iceConnectionState,", conn=").concat((u=this.peerConn)===null||u===void 0?void 0:u.connectionState,")")),["connected","completed"].includes((d=(h=this.peerConn)===null||h===void 0?void 0:h.iceConnectionState)!==null&&d!==void 0?d:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=Ge.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(et.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},SO));else if(((f=this.peerConn)===null||f===void 0?void 0:f.iceConnectionState)=="failed"){var g;if(this.candidatesEnded=!1,(g=this.peerConn)!==null&&g!==void 0&&g.restartIce){var S;this.candidatesEnded=!1,N.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((S=this.peerConn)===null||S===void 0?void 0:S.iceConnectionState,")")),this.peerConn.restartIce()}else N.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Xe.IceFailed,!1)}else((m=this.peerConn)===null||m===void 0?void 0:m.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var b,T,k;N.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((b=this.peerConn)===null||b===void 0?void 0:b.iceConnectionState,", conn=").concat((T=this.peerConn)===null||T===void 0?void 0:T.connectionState,")")),(k=this.peerConn)!==null&&k!==void 0&&k.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},EO),this.iceDisconnectedTimeout=setTimeout(()=>{N.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Xe.IceFailed,!1)},bO),this.state=Ge.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var _ of this.getRemoteFeeds())_.setAudioVideoMuted(!0,!0)}}),y(this,"onSignallingStateChanged",()=>{var o;N.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((o=this.peerConn)===null||o===void 0?void 0:o.signalingState,")"))}),y(this,"onTrack",o=>{if(o.streams.length===0){N.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(o.track.kind,")"));return}var u=o.streams[0];if(this.pushRemoteFeed(u),!this.removeTrackListeners.has(u)){var d=()=>{u.getTracks().length===0&&(N.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(u.id,")")),this.deleteFeedByStream(u),u.removeEventListener("removetrack",d),this.removeTrackListeners.delete(u))};u.addEventListener("removetrack",d),this.removeTrackListeners.set(u,d)}}),y(this,"onDataChannel",o=>{this.emit(et.DataChannel,o.channel,this)}),y(this,"onNegotiationNeeded",D(function*(){if(N.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==Ge.CreateOffer&&t.opponentVersion===0){N.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),y(this,"onHangupReceived",o=>{N.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(o)||this.state===Ge.Ringing?this.terminate(Ht.Remote,o.reason||Xe.UserHangup,!0):N.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(o.party_id,": our partner is ").concat(this.opponentPartyId))}),y(this,"onRejectReceived",o=>{N.debug("Call ".concat(this.callId," onRejectReceived() running"));var u=[Ge.InviteSent,Ge.Ringing].includes(this.state)||this.state===Ge.Fledgling&&this.direction===Gi.Inbound;u?this.terminate(Ht.Remote,o.reason||Xe.UserHangup,!0):N.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),y(this,"onAnsweredElsewhere",o=>{N.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(Ht.Remote,Xe.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(n=e.forceTURN)!==null&&n!==void 0?n:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[yO]});for(var i of this.turnServers)P_(i,["urls"]);this.callId=Da(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return D(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return D(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var n=this.peerConn.createDataChannel(e,t);return this.emit(et.DataChannel,n,this),n}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(et.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?gE.Video:gE.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ot.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ot.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(Sr(Ot.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(Sr(Ot.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ot.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ot.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ot.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ot.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return D(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw n?(e.hasOpponentDeviceInfo=!1,new j0(n)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var n of this.getLocalFeeds())e&&(n.sdpMetadataStreamId=n.stream.id),t[n.sdpMetadataStreamId]={purpose:n.purpose,audio_muted:n.isAudioMuted(),video_muted:n.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,o=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n){N.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){N.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new di({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n,audioMuted:i,videoMuted:o})),this.emit(et.FeedsChanged,this.feeds,this),N.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(n,")"))}pushRemoteFeedWithoutMetadata(e){var t,n=this.getOpponentMember().userId,i=Ot.Usermedia,o=(t=this.feeds.find(u=>!u.isLocal()))===null||t===void 0?void 0:t.stream;if(o&&e.id!==o.id){N.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){N.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new di({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit(et.FeedsChanged,this.feeds,this),N.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.client.getUserId();if($t(e.getAudioTracks(),!0),$t(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){N.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new di({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),n)}pushLocalFeed(e){var t=this,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(u=>e.stream.id===u.stream.id)){N.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),n){var i=function(){N.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(o.id,", kind=").concat(o.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(o.enabled,")"));var d=Sr(e.purpose,o.kind);if(t.transceivers.has(d)){var h=t.transceivers.get(d);h.sender.replaceTrack(o),h.direction=h.direction==="inactive"?"sendonly":"sendrecv"}else{var f=t.peerConn.addTrack(o,e.stream),m=t.peerConn.getTransceivers().find(g=>g.sender===f);m?t.transceivers.set(d,m):N.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var o of e.stream.getTracks())i()}N.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(et.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=Sr(e.purpose,"audio"),n=Sr(e.purpose,"video");for(var i of[t,n])if(this.transceivers.has(i)){var o=this.transceivers.get(i);o.sender&&this.peerConn.removeTrack(o.sender)}e.purpose===Ot.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(et.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){N.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(et.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return D(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return D(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),n=[];return t.forEach(i=>{n.push(i)}),n}})()}initWithInvite(e){var t=this;return D(function*(){var n,i=e.getContent();t.direction=Gi.Inbound;var o=yield t.client.checkTurnServers();o||N.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var u=i[Hi];u?t.updateRemoteSDPStreamMetadata(u):N.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(et.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(i.offer),N.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(i.offer.type)),yield t.addBufferedIceCandidates()}catch(m){N.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),m),t.terminate(Ht.Local,Xe.SetRemoteDescription,!1);return}var d=(n=t.feeds.find(m=>!m.isLocal()))===null||n===void 0?void 0:n.stream;if(!t.isOnlyDataChannelAllowed&&(!d||d.getTracks().length===0)){N.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(Ht.Local,Xe.SetRemoteDescription,!1);return}if(t.state=Ge.Ringing,e.getLocalAge()){var h=setTimeout(()=>{if(t.state==Ge.Ringing){var m;N.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=Ht.Remote,t.state=Ge.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(m=t.stats)===null||m===void 0||m.removeStatsReportGatherer(t.callId),t.emit(et.Hangup,t)}},i.lifetime-e.getLocalAge()),f=m=>{m!==Ge.Ringing&&(clearTimeout(h),t.off(et.State,f))};t.on(et.State,f)}})()}initWithHangup(e){this.state=Ge.Ended}shouldAnswerWithMediaType(e,t,n){return e&&!t?(N.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n," because the other side isn't sending it either.")),!1):!x_(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(N.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n,"=").concat(e," because the other side doesn't support it. Answering with ").concat(n,"=").concat(t,".")),t):e??t}answer(e,t){var n=this;return D(function*(){if(!n.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!n.localUsermediaStream&&!n.waitForLocalAVStream){var i=n.state,o=n.shouldAnswerWithMediaType(e,n.hasRemoteUserMediaAudioTrack,"audio"),u=n.shouldAnswerWithMediaType(t,n.hasRemoteUserMediaVideoTrack,"video");n.state=Ge.WaitLocalMedia,n.waitForLocalAVStream=!0;try{var d,h=yield n.client.getMediaHandler().getUserMediaStream(o,u);n.waitForLocalAVStream=!1;var f=new di({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(d=n.client.getDeviceId())!==null&&d!==void 0?d:void 0,stream:h,purpose:Ot.Usermedia,audioMuted:!1,videoMuted:!1}),m=[f];n.localScreensharingFeed&&m.push(n.localScreensharingFeed),n.answerWithCallFeeds(m)}catch(g){if(u)N.warn("Call ".concat(n.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),n.state=i,n.waitForLocalAVStream=!1,yield n.answer(o,!1);else{n.getUserMediaFailed(g);return}}}else n.waitForLocalAVStream&&(n.state=Ge.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){N.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===Ge.WaitLocalMedia?(N.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[Ge.CreateOffer,Ge.InviteSent].includes(this.state)&&(e.direction===Gi.Outbound?e.queueGotCallFeedsForAnswer([]):(N.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(et.Replaced,e,this),this.hangup(Xe.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(N.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(Ht.Local,e,!t),![Ge.Fledgling,Ge.WaitLocalMedia].includes(this.state))){var n={};(this.opponentVersion&&this.opponentVersion!==0||e!==Xe.UserHangup)&&(n.reason=e),this.sendVoipEvent(Z.CallHangup,n)}}reject(){if(this.state!==Ge.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){N.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Xe.UserHangup,!0);return}N.debug("Rejecting call: "+this.callId),this.terminate(Ht.Local,Xe.UserHangup,!0),this.sendVoipEvent(Z.CallReject,{})}upgradeCall(e,t){var n=this;return D(function*(){if(!(!e&&!t)&&n.opponentSupportsSDPStreamMetadata())try{N.debug("Call ".concat(n.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var i=e||n.hasLocalUserMediaAudioTrack,o=t||n.hasLocalUserMediaVideoTrack,u=yield n.client.getMediaHandler().getUserMediaStream(i,o,!1);yield n.updateLocalUsermediaStream(u,e,t)}catch(d){N.error("Call ".concat(n.callId," upgradeCall() failed to upgrade the call"),d),n.emit(et.Error,new ui(Xe.NoUserMedia,"Failed to get camera access: ",d),n)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var n=this;return D(function*(){if(e&&n.isScreensharing())return N.warn("Call ".concat(n.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!n.isScreensharing())return N.warn("Call ".concat(n.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!n.opponentSupportsSDPStreamMetadata())return n.setScreensharingEnabledWithoutMetadataSupport(e,t);if(N.debug("Call ".concat(n.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var i=yield n.client.getMediaHandler().getScreensharingStream(t);return i?(n.pushNewLocalFeed(i,Ot.Screenshare),!0):!1}catch(h){return N.error("Call ".concat(n.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),h),!1}else{var o=n.transceivers.get(Sr(Ot.Screenshare,"audio")),u=n.transceivers.get(Sr(Ot.Screenshare,"video"));for(var d of[o,u])d&&d.sender&&n.peerConn.removeTrack(d.sender);return n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var n=this;return D(function*(){if(N.debug("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var i,o=yield n.client.getMediaHandler().getScreensharingStream(t);if(!o)return!1;var u=o.getTracks().find(S=>S.kind==="video"),d=(i=n.transceivers.get(Sr(Ot.Usermedia,"video")))===null||i===void 0?void 0:i.sender;return d?.replaceTrack(u??null),n.pushNewLocalFeed(o,Ot.Screenshare,!1),!0}catch(S){return N.error("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),S),!1}else{var h,f,m=(h=n.localUsermediaStream)===null||h===void 0?void 0:h.getTracks().find(S=>S.kind==="video"),g=(f=n.transceivers.get(Sr(Ot.Usermedia,"video")))===null||f===void 0?void 0:f.sender;return g?.replaceTrack(m??null),n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1,o=t.length>2&&t[2]!==void 0?t[2]:!1,u=n.localUsermediaFeed,d=i||!u.isAudioMuted()&&!n.remoteOnHold,h=o||!u.isVideoMuted()&&!n.remoteOnHold;N.log("Call ".concat(n.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(d,", video=").concat(h,")")),$t(e.getAudioTracks(),d),$t(e.getVideoTracks(),h);for(var f of n.localUsermediaStream.getTracks())n.localUsermediaStream.removeTrack(f),f.stop();for(var m of e.getTracks())n.localUsermediaStream.addTrack(m);var g=function*(){var b=Sr(Ot.Usermedia,S.kind),T=n.transceivers.get(b),k=T?.sender,A=!1;if(k)try{N.info("Call ".concat(n.callId," updateLocalUsermediaStream() replacing track (id=").concat(S.id,", kind=").concat(S.kind,", streamId=").concat(e.id,", streamPurpose=").concat(u.purpose,")")),yield k.replaceTrack(S),T.direction=T.direction==="inactive"?"sendonly":"sendrecv",A=!0}catch(O){N.warn("Call ".concat(n.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),O)}if(!A){N.info("Call ".concat(n.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(S.id,", kind=").concat(S.kind,", streamId=").concat(e.id,", streamPurpose=").concat(u.purpose,")"));var C=n.peerConn.addTrack(S,n.localUsermediaStream),U=n.peerConn.getTransceivers().find(O=>O.sender===C);U?n.transceivers.set(b,U):N.warn("Call ".concat(n.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var S of e.getTracks())yield*g()})()}setLocalVideoMuted(e){var t=this;return D(function*(){var n;if(N.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var i;return(i=t.localUsermediaFeed)===null||i===void 0||i.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var o=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(o)}return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var u of t.localUsermediaStream.getVideoTracks())u.stop(),t.localUsermediaStream.removeTrack(u)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return D(function*(){var n;return N.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(et.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==Ge.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var n=["inactive","recvonly"].includes(t.currentDirection);n||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var n;if(((n=t.track)===null||n===void 0?void 0:n.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;N.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),$t(this.localUsermediaStream.getAudioTracks(),!e),$t(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return D(function*(){yield e.sendVoipEvent(Z.CallSDPStreamMetadataChangedPrefix,{[Hi]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var n of e)this.pushLocalFeed(n);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=Ge.CreateOffer,N.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return D(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[Hi]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var n=e.discardDuplicateCandidates();N.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(n," candidates that will be sent in answer"));try{yield e.sendVoipEvent(Z.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(u){e.state=Ge.Ringing,u instanceof Dt&&u.event&&e.client.cancelPendingEvent(u.event);var i=Xe.SendAnswer,o="Failed to send answer";throw u.name=="UnknownDeviceError"&&(i=Xe.UnknownDevices,o="Unknown devices present in the room"),e.emit(et.Error,new ui(i,o,u),e),u}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var n=Pv.parse(e.sdp);n.media.forEach(i=>{var o=new Map,u=new Map;for(var d of i.rtp)o.set(d.payload,d.codec),u.set(d.codec,d.payload);for(var h of t)if(h.mediaType===i.type){if(!u.has(h.codec)){N.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(h.codec," as it's not present."));continue}var f=[];h.enableDtx!==void 0&&f.push("usedtx=".concat(h.enableDtx?"1":"0")),h.maxAverageBitrate!==void 0&&f.push("maxaveragebitrate=".concat(h.maxAverageBitrate));var m=!1;for(var g of i.fmtp)o.get(g.payload)===h.codec&&(m=!0,g.config+=";"+f.join(";"));m||i.fmtp.push({payload:u.get(h.codec),config:f.join(";")})}}),e.sdp=Pv.write(n)}createOffer(){var e=this;return D(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,yE(e.isPtt)),t})()}createAnswer(){var e=this;return D(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,yE(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return D(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var n of e)t.pushLocalFeed(n);t.state=Ge.CreateAnswer;var i;try{t.getRidOfRTXCodecs(),i=yield t.createAnswer()}catch(o){N.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),o),t.terminate(Ht.Local,Xe.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(i),t.callHasEnded()||(t.state=Ge.Connecting,yield new Promise(o=>{setTimeout(o,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(o){N.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),o),t.terminate(Ht.Local,Xe.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return D(function*(){if(!t.callHasEnded()){var n=e.getContent(),i=n.candidates;if(!i){N.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var o=n.version===0?null:n.party_id||null;if(t.opponentPartyId===void 0){if(o){N.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(i.length," candidates until we pick an opponent"));var u=t.remoteCandidateBuffer.get(o)||[];u.push(...i),t.remoteCandidateBuffer.set(o,u)}return}if(!t.partyIdMatches(n)){N.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(n.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(i)}})()}onAnswerReceived(e){var t=this;return D(function*(){var n=e.getContent();if(N.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(n.party_id,")")),t.callHasEnded()){N.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){N.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(n.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=Ge.Connecting;var i=n[Hi];i?t.updateRemoteSDPStreamMetadata(i):N.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(n.answer),t.isSettingRemoteAnswerPending=!1,N.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(n.answer.type))}catch(o){t.isSettingRemoteAnswerPending=!1,N.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),o),t.terminate(Ht.Local,Xe.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(Z.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(o){N.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),o)}})()}onSelectAnswerReceived(e){var t=this;return D(function*(){if(t.direction!==Gi.Inbound){N.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var n=e.getContent().selected_party_id;if(n==null){N.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}n!==t.ourPartyId&&(N.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(n,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(Ht.Remote,Xe.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return D(function*(){var n=e.getContent(),i=n.description;if(!i||!i.sdp||!i.type){N.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var o=t.direction===Gi.Inbound,u=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),d=i.type==="offer"&&!u;if(t.ignoreOffer=!o&&d,t.ignoreOffer){N.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var h=t.isLocalOnHold(),f=n[Hi];f?t.updateRemoteSDPStreamMetadata(f):N.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=i.type=="answer",yield t.peerConn.setRemoteDescription(i),t.isSettingRemoteAnswerPending=!1,N.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(i.type)),i.type==="offer"){var m,g;try{t.getRidOfRTXCodecs(),g=yield t.createAnswer()}catch(_){N.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),_),t.terminate(Ht.Local,Xe.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(g),N.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(Z.CallNegotiate,{lifetime:nv,description:(m=t.peerConn.localDescription)===null||m===void 0?void 0:m.toJSON(),[Hi]:t.getLocalSDPStreamMetadata(!0)})}}catch(_){t.isSettingRemoteAnswerPending=!1,N.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),_)}var S=t.isLocalOnHold();h!==S&&(t.emit(et.LocalHoldUnhold,S,t),t.emit(et.HoldUnhold,S))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=j_(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var n,i=t.stream.id,o=this.remoteSDPStreamMetadata[i];t.setAudioVideoMuted(o?.audio_muted,o?.video_muted),t.purpose=(n=this.remoteSDPStreamMetadata[i])===null||n===void 0?void 0:n.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),n=t[Hi];this.updateRemoteSDPStreamMetadata(n)}onAssertedIdentityReceived(e){var t=this;return D(function*(){var n=e.getContent();n.asserted_identity&&(t.remoteAssertedIdentity={id:n.asserted_identity.id,displayName:n.asserted_identity.display_name},t.emit(et.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===Ge.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return D(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return D(function*(){if(N.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){N.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(m){N.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),m),e.terminate(Ht.Local,Xe.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(m){N.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),m),e.terminate(Ht.Local,Xe.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(m=>{setTimeout(m,200)})),!e.callHasEnded()){var n=e.state===Ge.CreateOffer?Z.CallInvite:Z.CallNegotiate,i={lifetime:nv};if(n===Z.CallInvite&&e.invitee&&(i.invitee=e.invitee),e.state===Ge.CreateOffer){var o;i.offer=(o=e.peerConn.localDescription)===null||o===void 0?void 0:o.toJSON()}else{var u;i.description=(u=e.peerConn.localDescription)===null||u===void 0?void 0:u.toJSON()}i.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},i[Hi]=e.getLocalSDPStreamMetadata(!0);var d=e.discardDuplicateCandidates();N.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(d," candidates that will be sent in offer"));try{yield e.sendVoipEvent(n,i)}catch(m){N.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),m),m instanceof Dt&&m.event&&e.client.cancelPendingEvent(m.event);var h=Xe.SignallingFailed,f="Signalling failed";e.state===Ge.CreateOffer&&(h=Xe.SendInvite,f="Failed to send invite"),m.name=="UnknownDeviceError"&&(h=Xe.UnknownDevices,f="Unknown devices present in the room"),e.emit(et.Error,new ui(h,f,m),e),e.terminate(Ht.Local,h,!1);return}e.sendCandidateQueue(),e.state===Ge.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=Ge.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===Ge.InviteSent&&e.hangup(Xe.InviteTimeout,!1)},nv))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(Sr(Ot.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,n=RTCRtpSender.getCapabilities("video").codecs,i=[];for(var o of[...t,...n])if(o.mimeType!=="video/rtx"){i.push(o);try{e.setCodecPreferences(i)}catch(u){N.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",o,u),i.pop()}}}}}sendVoipEvent(e,t){var n=this;return D(function*(){var i=Mc(Mc({},t),{},{version:gO,call_id:n.callId,party_id:n.ourPartyId,conf_id:n.groupCallId});if(n.opponentDeviceId){var o,u=n.toDeviceSeq++,d=Mc(Mc({},i),{},{device_id:n.client.deviceId,sender_session_id:n.client.getSessionId(),dest_session_id:n.opponentSessionId,seq:u,[dd]:HI()});n.emit(et.SendVoipEvent,{type:"toDevice",eventType:e,userId:n.invitee||((o=n.getOpponentMember())===null||o===void 0?void 0:o.userId),opponentDeviceId:n.opponentDeviceId,content:d},n);var h=n.invitee||n.getOpponentMember().userId;if(n.client.getUseE2eForGroupCall()){if(!n.hasOpponentDeviceInfo){N.warn("Call ".concat(n.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield n.client.sendToDevice(e,new Map([[h,new Map([[n.opponentDeviceId,d]])]]))}else{var f;n.emit(et.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:n.roomId,content:i,userId:n.invitee||((f=n.getOpponentMember())===null||f===void 0?void 0:f.userId)},n),yield n.client.sendEvent(n.roomId,e,i)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===Ge.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===Gi.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],n=0;n<this.candidateSendQueue.length;n++){var i=this.candidateSendQueue[n];i.candidate===""?t.push(i):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return D(function*(){var n=yield t.client.getProfileInfo(e),i=Da(),o={replacement_id:Da(),target_user:{id:e,display_name:n.displayname,avatar_url:n.avatar_url},create_call:i};yield t.sendVoipEvent(Z.CallReplaces,o),yield t.terminate(Ht.Local,Xe.Transferred,!0)})()}transferToCall(e){var t=this;return D(function*(){var n,i,o=(n=e.getOpponentMember())===null||n===void 0?void 0:n.userId,u=o?yield t.client.getProfileInfo(o):void 0,d=(i=t.getOpponentMember())===null||i===void 0?void 0:i.userId,h=d?yield t.client.getProfileInfo(d):void 0,f=Da(),m={replacement_id:Da(),target_user:{id:d,display_name:h?.displayname,avatar_url:h?.avatar_url},await_call:f};yield e.sendVoipEvent(Z.CallReplaces,m);var g={replacement_id:Da(),target_user:{id:o,display_name:u?.displayname,avatar_url:u?.avatar_url},create_call:f};yield t.sendVoipEvent(Z.CallReplaces,g),yield t.terminate(Ht.Local,Xe.Transferred,!0),yield e.terminate(Ht.Local,Xe.Transferred,!0)})()}terminate(e,t,n){var i=this;return D(function*(){var o;if(!i.callHasEnded()){i.hangupParty=e,i.hangupReason=t,i.state=Ge.Ended,i.inviteTimeout&&(clearTimeout(i.inviteTimeout),i.inviteTimeout=void 0),i.iceDisconnectedTimeout!==void 0&&(clearTimeout(i.iceDisconnectedTimeout),i.iceDisconnectedTimeout=void 0),i.callLengthInterval&&(clearInterval(i.callLengthInterval),i.callLengthInterval=void 0),i.stopVideoTrackTimer!==void 0&&(clearTimeout(i.stopVideoTrackTimer),i.stopVideoTrackTimer=void 0);for(var[u,d]of i.removeTrackListeners)u.removeEventListener("removetrack",d);i.removeTrackListeners.clear(),i.callStatsAtEnd=yield i.collectCallStats(),i.stopAllMedia(),i.deleteAllFeeds(),i.peerConn&&i.peerConn.signalingState!=="closed"&&i.peerConn.close(),(o=i.stats)===null||o===void 0||o.removeStatsReportGatherer(i.callId),n&&i.emit(et.Hangup,i),i.client.callEventHandler.calls.delete(i.callId)}})()}stopAllMedia(){N.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Ot.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Ot.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){N.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(q_.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return D(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var n={candidates:t.map(d=>d.toJSON())};e.candidatesEnded&&n.candidates.push({candidate:""}),N.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(Z.CallCandidates,n),e.candidateSendTries=0,e.sendCandidateQueue()}catch(d){if(d instanceof Dt&&d.event&&e.client.cancelPendingEvent(d.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){N.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),d);var i=Xe.SignallingFailed,o="Signalling failed";e.emit(et.Error,new ui(i,o,d),e),e.hangup(i,!1);return}var u=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,N.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(u,"ms"),d),setTimeout(()=>{e.sendCandidateQueue()},u)}}})()}placeCall(e,t){var n=this;return D(function*(){if(!e)throw new Error("You CANNOT start a call without audio");n.state=Ge.WaitLocalMedia;var i;try{var o,u=yield n.client.getMediaHandler().getUserMediaStream(e,t);$t(u.getAudioTracks(),!0),$t(u.getVideoTracks(),!0),i=new di({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(o=n.client.getDeviceId())!==null&&o!==void 0?o:void 0,stream:u,purpose:Ot.Usermedia,audioMuted:!1,videoMuted:!1})}catch(d){n.getUserMediaFailed(d);return}try{yield n.placeCallWithCallFeeds([i])}catch(d){n.placeCallFailed(d);return}})()}placeCallWithCallFeeds(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;n.checkForErrorListener(),n.direction=Gi.Outbound,yield n.initOpponentCrypto(),n.client.callEventHandler.calls.set(n.callId,n);var o=yield n.client.checkTurnServers();o||N.warn("Call ".concat(n.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),n.peerConn=n.createPeerConnection(),n.emit(et.PeerConnectionCreated,n.peerConn,n),n.gotCallFeedsForInvite(e,i)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var n=this.getOpponentMember(),i=n?n.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,i,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,n=e.getContent();if(N.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var i;(i=this.stats)===null||i===void 0||i.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return D(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(N.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return D(function*(){for(var n of e){(n.sdpMid===null||n.sdpMid===void 0)&&(n.sdpMLineIndex===null||n.sdpMLineIndex===void 0)?N.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):N.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(n.sdpMid,", candidate=").concat(n.candidate,")"));try{yield t.peerConn.addIceCandidate(n)}catch(i){t.ignoreOffer?N.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),i):N.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),i)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function $t(s,e){for(var t of s)t.enabled=e}function Fv(){if(typeof window>"u"||typeof document>"u")return!1;try{var s,e,t,n=!!((s=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&s!==void 0?s:navigator.mediaDevices);if(!n)return N.error("WebRTC is not supported in this browser / environment"),!1}catch(i){return N.error("Exception thrown when trying to access WebRTC",i),!1}return!0}function zl(s,e,t){if(!Fv())return null;var n=t?t.forceTURN:!1,i={client:s,roomId:e,invitee:t?.invitee,turnServers:s.getTurnServers(),forceTURN:s.forceTURN||n,opponentDeviceId:t?.opponentDeviceId,opponentSessionId:t?.opponentSessionId,groupCallId:t?.groupCallId},o=new _O(i);return s.reEmitter.reEmit(o,Object.values(et)),o}var $i=(function(s){return s.DontNotify="dont_notify",s.Notify="notify",s.Coalesce="coalesce",s})({}),Dm=(function(s){return s.Highlight="highlight",s.Sound="sound",s})({}),TO=(function(s){return s.ExactEquals="==",s.LessThan="<",s.GreaterThan=">",s.GreaterThanOrEqual=">=",s.LessThanOrEqual="<=",s})({}),RO="2";function wO(s){return s==="==2"||s==="2"}var en=(function(s){return s.EventMatch="event_match",s.EventPropertyIs="event_property_is",s.EventPropertyContains="event_property_contains",s.ContainsDisplayName="contains_display_name",s.RoomMemberCount="room_member_count",s.SenderNotificationPermission="sender_notification_permission",s.CallStarted="call_started",s.CallStartedPrefix="org.matrix.msc3914.call_started",s})({}),un=(function(s){return s.Override="override",s.ContentSpecific="content",s.RoomSpecific="room",s.SenderSpecific="sender",s.Underride="underride",s})({}),ln=(function(s){return s.Master=".m.rule.master",s.IsUserMention=".m.rule.is_user_mention",s.IsRoomMention=".m.rule.is_room_mention",s.ContainsDisplayName=".m.rule.contains_display_name",s.ContainsUserName=".m.rule.contains_user_name",s.AtRoomNotification=".m.rule.roomnotif",s.DM=".m.rule.room_one_to_one",s.EncryptedDM=".m.rule.encrypted_room_one_to_one",s.Message=".m.rule.message",s.EncryptedMessage=".m.rule.encrypted",s.InviteToSelf=".m.rule.invite_for_me",s.MemberEvent=".m.rule.member_event",s.IncomingCall=".m.rule.call",s.SuppressNotices=".m.rule.suppress_notices",s.Tombstone=".m.rule.tombstone",s.PollStart=".m.rule.poll_start",s.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",s.PollEnd=".m.rule.poll_end",s.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",s.PollStartOneToOne=".m.rule.poll_start_one_to_one",s.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",s.PollEndOneToOne=".m.rule.poll_end_one_to_one",s.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",s})({});function SE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function bE(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?SE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):SE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var EE=[un.Override,un.ContentSpecific,un.RoomSpecific,un.SenderSpecific,un.Underride],CO={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:en.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:en.SenderNotificationPermission,key:"room"}],actions:[$i.Notify,{set_tweak:Dm.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:en.EventMatch,key:"type",pattern:"m.reaction"}],actions:[$i.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:en.EventMatch,key:"type",pattern:Z.RoomServerAcl},{kind:en.EventMatch,key:"state_key",pattern:""}],actions:[]}},km=Symbol("UserDefinedRules"),IO=[ln.Master,km,ln.SuppressNotices,ln.InviteToSelf,ln.MemberEvent,ln.IsUserMention,ln.ContainsDisplayName,ln.IsRoomMention,ln.AtRoomNotification,ln.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],OO={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:en.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:en.CallStarted}],actions:[$i.Notify,{set_tweak:Dm.Sound,value:"default"}]}},MO=[km,ln.IncomingCall,".org.matrix.msc3914.rule.room.call",ln.EncryptedDM,ln.DM,ln.Message,ln.EncryptedMessage];function _E(s,e,t,n,i){var o=t.filter(b=>b.default),u=t.filter(b=>!b.default);function d(b){b===km?f.push(...u):b in n?(s.warn("Adding default global ".concat(e," push rule ").concat(b)),f.push(n[b])):s.warn("Missing default global ".concat(e," push rule ").concat(b))}var h=0,f=[];for(var m of o){var g=i.indexOf(m.rule_id);if(g===-1){f.push(m);continue}for(;g>h;){var S=i[h];d(S),h+=1}f.push(m),h+=1}for(var _ of i.slice(h))d(_);return f}class _r{constructor(e){this.client=e,y(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var n of e)n===$i.Notify?t.notify=!0:typeof n=="object"&&(n.value===void 0&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e,t){var n=JSON.parse(JSON.stringify(t));return n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]),n.global.override=_E(e,un.Override,n.global.override,CO,IO),n.global.underride=_E(e,un.Underride,n.global.underride,OO,MO),n}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[i,o]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],u="".concat(t,"-").concat(n,"-").concat(e);return _r.cachedGlobToRegex[u]||(_r.cachedGlobToRegex[u]=new RegExp(i+"("+L_(e)+")"+o,n)),_r.cachedGlobToRegex[u]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var n of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var i of n)if(i.conditions)for(var o of i.conditions)o.kind===en.EventMatch&&(t.delete(o.key),this.parsedKeys.set(o.key,_r.partsForDottedKey(o.key)));t.forEach(u=>this.parsedKeys.delete(u))}matchingRuleFromKindSet(e,t){for(var n of EE){var i=t[n];if(i){for(var o of i)if(o.enabled){var u=this.templateRuleToRaw(n,o);if(u&&this.ruleMatchesEvent(u,e))return bE(bE({},o),{},{kind:n})}}}return null}templateRuleToRaw(e,t){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case un.Underride:case un.Override:n.conditions=t.conditions;break;case un.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:en.EventMatch,key:"room_id",value:t.rule_id});break;case un.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:en.EventMatch,key:"user_id",value:t.rule_id});break;case un.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:en.EventMatch,key:"content.body",pattern:t.pattern});break}return n}eventFulfillsCondition(e,t){switch(e.kind){case en.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case en.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case en.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case en.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case en.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case en.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case en.CallStarted:case en.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var n=e.key;if(!n)return!1;var i=this.client.getRoom(t.getRoomId());return i!=null&&i.currentState?i.currentState.mayTriggerNotifOfType(n,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var i=n.currentState.getJoinedMemberCount(),o=e.is.match(/^([=<>]*)(\d*)$/);if(!o)return!1;var u=o[1],d=parseInt(o[2]);if(isNaN(d))return!1;switch(u){case"":case"==":return i==d;case"<":return i<d;case">":return i>d;case"<=":return i<=d;case">=":return i>=d;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n,i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||typeof i.body!="string")return!1;var o=this.client.getRoom(t.getRoomId()),u=o==null||(n=o.currentState)===null||n===void 0?void 0:n.getMember(this.client.credentials.userId);if(!u)return!1;var d=u.name,h=new RegExp("(^|\\W)"+N_(d)+"(\\W|$)","i");return i.body.search(h)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var n=this.valueForDottedKey(e.key,t);if(typeof n!="string")return!1;if(e.value)return e.value===n;if(typeof e.pattern!="string")return!1;var i=_r.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!n.match(i)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var n=this.valueForDottedKey(e.key,t);return Array.isArray(n)?n.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||qa(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],n="",i=!1;for(var o of e){if(i){o==="\\"||o==="."?n+=o:n+="\\"+o,i=!1;continue}o=="."?(t.push(n),n=""):o=="\\"?i=!0:n+=o}return i&&(n+="\\"),t.push(n),t}valueForDottedKey(e,t){var n=this.parsedKeys.get(e);n===void 0&&(n=_r.partsForDottedKey(e),this.parsedKeys.set(e,n));var i,o=n[0],u=0;for(o==="content"?(i=t.getContent(),++u):o==="type"?(i=t.getType(),++u):i=t.event;u<n.length;++u){if(x_(i))return;var d=n[u];i=i[d]}return i}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};var i=_r.actionListToActionsObject(n.actions);return i.tweaks.highlight===void 0&&(i.tweaks.highlight=n.kind==un.ContentSpecific),{actions:i,rule:n}}ruleMatchesEvent(e,t){var n;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===ln.ContainsUserName||e.rule_id===ln.ContainsDisplayName||e.rule_id===ln.AtRoomNotification)?!1:!((n=e.conditions)!==null&&n!==void 0&&n.some(i=>!this.eventFulfillsCondition(i,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,n=this.getPushRuleAndKindById(e);return(t=n?.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var n;if(((n=this.client.pushRules)===null||n===void 0?void 0:n[t])!==void 0){for(var i of EE)if(this.client.pushRules[t][i]!==void 0){for(var o of this.client.pushRules[t][i])if(o.rule_id===e)return{rule:o,kind:i}}}}return null}}y(_r,"cachedGlobToRegex",{});var Wl=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],AO=Wl[0],DO=Wl[Wl.length-1],Xn=(function(s){return s.SUCCESS="SUCCESS",s.IGNORE="IGNORE",s.PROMPT="PROMPT",s.FAIL_PROMPT="FAIL_PROMPT",s.FAIL_ERROR="FAIL_ERROR",s})({}),hr=(function(s){return s.Invalid="Invalid homeserver discovery response",s.GenericFailure="Failed to get autodiscovery configuration from server",s.InvalidHsBaseUrl="Invalid base_url for m.homeserver",s.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",s.InvalidIsBaseUrl="Invalid base_url for m.identity_server",s.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",s.InvalidIs="Invalid identity server discovery response",s.MissingWellknown="No .well-known JSON file found",s.InvalidJson="Invalid JSON",s.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",s})({});class We{static fromDiscoveryConfig(e){var t=this;return D(function*(){var n,i={"m.homeserver":{state:We.FAIL_ERROR,error:We.ERROR_INVALID,base_url:null},"m.identity_server":{state:We.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return N.error("No m.homeserver key in config"),i["m.homeserver"].state=We.FAIL_PROMPT,i["m.homeserver"].error=We.ERROR_INVALID,Promise.resolve(i);if(!e["m.homeserver"].base_url)return N.error("No m.homeserver base_url in config"),i["m.homeserver"].state=We.FAIL_PROMPT,i["m.homeserver"].error=We.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var o=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!o)return N.error("Invalid base_url for m.homeserver"),i["m.homeserver"].error=We.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var u=yield t.fetchWellKnownObject("".concat(o,"/_matrix/client/versions"));if(!u||!Array.isArray((n=u.raw)===null||n===void 0?void 0:n.versions))return N.error("Invalid /versions response"),i["m.homeserver"].error=We.ERROR_INVALID_HOMESERVER,i["m.homeserver"].base_url=o,Promise.resolve(i);var d=new Set(u.raw.versions),h=!1;for(var f of Wl)if(d.has(f)){h=!0;break}if(!h)return N.error("Homeserver does not meet version requirements"),i["m.homeserver"].error=We.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,i["m.homeserver"].base_url=o,Promise.resolve(i);i["m.homeserver"]={state:We.SUCCESS,error:null,base_url:o};var m="";if(e["m.identity_server"]){var g={"m.homeserver":i["m.homeserver"],"m.identity_server":{state:We.FAIL_PROMPT,error:We.ERROR_INVALID_IS,base_url:null}};if(m=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!m)return N.error("Invalid base_url for m.identity_server"),g["m.identity_server"].error=We.ERROR_INVALID_IS_BASE_URL,Promise.resolve(g);var S=yield t.fetchWellKnownObject("".concat(m,"/_matrix/identity/v2"));if(!(S!=null&&S.raw)||S.action!==Xn.SUCCESS)return N.error("Invalid /v2 response"),g["m.identity_server"].error=We.ERROR_INVALID_IDENTITY_SERVER,g["m.identity_server"].base_url=m,Promise.resolve(g)}return m&&m.toString().length>0&&(i["m.identity_server"]={state:We.SUCCESS,error:null,base_url:m}),Object.keys(e).forEach(_=>{if(_==="m.homeserver"||_==="m.identity_server"){var b=["error","state","base_url"];for(var T of Object.keys(e[_]))b.includes(T)||(i[_][T]=e[_][T])}else i[_]=e[_]}),Promise.resolve(i)})()}static findClientConfig(e){var t=this;return D(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n={"m.homeserver":{state:We.FAIL_ERROR,error:We.ERROR_INVALID,base_url:null},"m.identity_server":{state:We.PROMPT,error:null,base_url:null}},i=e.includes("://")?e:"https://".concat(e),o=yield t.fetchWellKnownObject("".concat(i,"/.well-known/matrix/client"));return!o||o.action!==Xn.SUCCESS?(N.error("No response or error when parsing .well-known"),o.reason&&N.error(o.reason),o.action===Xn.IGNORE?n["m.homeserver"]={state:We.PROMPT,error:null,base_url:null}:(n["m.homeserver"].state=We.FAIL_PROMPT,n["m.homeserver"].error=We.ERROR_INVALID),Promise.resolve(n)):We.fromDiscoveryConfig(o.raw)})()}static getRawClientConfig(e){var t=this;return D(function*(){var n;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var i=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return i?(n=i.raw)!==null&&n!==void 0?n:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,n;try{n=new URL(e)}catch(d){N.error("Could not parse url",d)}if(!((t=n)!==null&&t!==void 0&&t.hostname)||n.protocol!=="http:"&&n.protocol!=="https:")return!1;var i=n.port?":".concat(n.port):"",o=n.pathname?n.pathname:"",u="".concat(n.protocol,"//").concat(n.hostname).concat(i).concat(o);return u.endsWith("/")&&(u=u.substring(0,u.length-1)),u}catch(d){return N.error(d),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){We.fetchFn=e}static fetchWellKnownObject(e){return D(function*(){var t;try{if(t=yield We.fetch(e,{method:se.Get,signal:fd(5e3)}),t.status===404)return{raw:{},action:Xn.IGNORE,reason:We.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:Xn.FAIL_PROMPT,reason:"General failure"}}catch(u){var n=u,i="";return typeof n=="object"&&(i=n?.message),{error:n,raw:{},action:Xn.FAIL_PROMPT,reason:i||"General failure"}}try{return{raw:yield t.json(),action:Xn.SUCCESS}}catch(u){var o=u;return{error:o,raw:{},action:Xn.FAIL_PROMPT,reason:o?.name==="SyntaxError"?We.ERROR_INVALID_JSON:We.ERROR_INVALID}}})()}}y(We,"ERROR_INVALID",hr.Invalid);y(We,"ERROR_GENERIC_FAILURE",hr.GenericFailure);y(We,"ERROR_INVALID_HS_BASE_URL",hr.InvalidHsBaseUrl);y(We,"ERROR_INVALID_HOMESERVER",hr.InvalidHomeserver);y(We,"ERROR_INVALID_IS_BASE_URL",hr.InvalidIsBaseUrl);y(We,"ERROR_INVALID_IDENTITY_SERVER",hr.InvalidIdentityServer);y(We,"ERROR_INVALID_IS",hr.InvalidIs);y(We,"ERROR_MISSING_WELLKNOWN",hr.MissingWellknown);y(We,"ERROR_INVALID_JSON",hr.InvalidJson);y(We,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",hr.UnsupportedHomeserverSpecVersion);y(We,"ALL_ERRORS",Object.keys(hr));y(We,"FAIL_ERROR",Xn.FAIL_ERROR);y(We,"FAIL_PROMPT",Xn.FAIL_PROMPT);y(We,"PROMPT",Xn.PROMPT);y(We,"SUCCESS",Xn.SUCCESS);y(We,"fetchFn",void 0);var qv=(function(s){return s.IS="SERVICE_TYPE_IS",s.IM="SERVICE_TYPE_IM",s})({});class kO{constructor(e){this.ourEvent=e,y(this,"timeline",void 0),y(this,"ourEventIndex",0),y(this,"paginateTokens",{[Qe.Backward]:null,[Qe.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?Qe.Backward:Qe.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?Qe.Backward:Qe.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class pd{static fromJson(e,t){var n=e.context||{},i=(n.events_before||[]).map(t),o=(n.events_after||[]).map(t),u=new kO(t(e.result)),d=u.ourEvent.threadRootId;return i=i.filter(h=>h.threadRootId===d),o=o.filter(h=>h.threadRootId===d),u.setPaginateToken(n.start,!0),u.addEvents(i,!0),u.addEvents(o,!1),u.setPaginateToken(n.end,!1),new pd(e.rank,u)}constructor(e,t){this.rank=e,this.context=t}}function Kv(s){return"parent_delay_id"in s&&typeof s.parent_delay_id!="string"?!1:"delay"in s&&typeof s.delay!="number"?!0:"delay"in s||"parent_delay_id"in s}var Fa=(function(s){return s.Cancel="cancel",s.Restart="restart",s.Send="send",s})({}),UO=(function(s){return s.Public="public",s.Private="private",s})({}),Um=(function(s){return s.PrivateChat="private_chat",s.TrustedPrivateChat="trusted_private_chat",s.PublicChat="public_chat",s})({}),B0=(function(s){return s.Public="public",s.Invite="invite",s.Private="private",s.Knock="knock",s.Restricted="restricted",s})({}),PO=(function(s){return s.RoomMembership="m.room_membership",s})({}),rd=(function(s){return s.CanJoin="can_join",s.Forbidden="forbidden",s})({}),Pm=(function(s){return s.Invited="invited",s.Joined="joined",s.Shared="shared",s.WorldReadable="world_readable",s})({});function TE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function RE(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?TE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):TE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function NO(s,e){var t=!!e.preventReEmit,n=e.decrypt!==!1;function i(o){var u=s.getRoom(o.room_id),d;u&&o.state_key===void 0&&(d=u.findEventById(o.event_id)),!d||d.status?d=new yn(o):(d.setUnsigned(RE(RE({},d.getUnsigned()),o.unsigned)),t=!0);var h=d.getServerAggregatedRelation(Mt.Replace);if(h!=null&&h.content){var f=i(h);d.makeReplaced(f)}var m=u?.findThreadForEvent(d);return m&&d.setThread(m),d.isEncrypted()&&(t||s.reEmitter.reEmit(d,[mt.Decrypted]),n&&s.decryptEventIfNeeded(d)),t||(s.reEmitter.reEmit(d,[mt.Replaced,mt.VisibilityChange]),u?.reEmitter.reEmit(d,[mt.BeforeRedaction])),d}return i}function wE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Vi(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):wE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}class CE{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return D(function*(){yield e.client.sendStateEvent(e.roomId,ci.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return D(function*(){yield t.client.sendStateEvent(t.roomId,ci.name,Vi(Vi({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return D(function*(){yield t.client.sendStateEvent(t.roomId,ci.name,Vi(Vi({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return D(function*(){var t=yield e.getFileEvent(),n=t.getOriginalContent().file,i=e.client.mxcUrlToHttp(n.url);if(!i)throw new Error("No HTTP URL available for ".concat(n.url));return{info:n,httpUrl:i}})()}getFileEvent(){var e=this;return D(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var n=t.getUnfilteredTimelineSet().findEventById(e.id);!n&&t.getLiveTimeline().getState(Oe.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),n=t.getUnfilteredTimelineSet().findEventById(e.id);if(!n)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(n),n})()}createNewVersion(e,t,n,i){var o=this;return D(function*(){var u=yield o.directory.createFile(e,t,n,Vi(Vi({},i??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:Mt.Replace,event_id:o.id}}));return yield o.client.sendStateEvent(o.roomId,ci.name,{active:!0,name:e,version:o.version+1},u.event_id),yield o.client.sendStateEvent(o.roomId,ci.name,Vi(Vi({},o.indexEvent.getContent()),{},{active:!1}),o.id),u})()}getVersionHistory(){var e=this;return D(function*(){var t=[];t.push(e);var n=e.client.getRoom(e.roomId);if(!n)throw new Error("Invalid or unknown room");var i=[...n.getLiveTimeline().getEvents()].reverse(),o,u=yield e.getFileEvent();do if(o=i.find(h=>h.replacingEventId()===u.getId()),o){var d=e.directory.getFile(o.getId());if(d)t.push(d),u=o;else break}while(o);return t})()}}function IE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Ra(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?IE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):IE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var LO={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[Z.RoomPowerLevels]:100,[Z.RoomHistoryVisibility]:100,[Z.RoomTombstone]:100,[Z.RoomEncryption]:100,[Z.RoomName]:50,[Z.RoomMessage]:50,[Z.RoomMessageEncrypted]:50,[Z.Sticker]:50},users:{}},Ls=(function(s){return s.Viewer="viewer",s.Editor="editor",s.Owner="owner",s})({});class OE{constructor(e,t){if(this.client=e,this.roomId=t,y(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(Z.SpaceParent);return e!=null&&e.length?e.every(t=>{var n;return!((n=t.getContent())!==null&&n!==void 0&&n.via)}):!0}setName(e){var t=this;return D(function*(){yield t.client.sendStateEvent(t.roomId,Z.RoomName,{name:e},"")})()}invite(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,o=[n.retryInvite(e)];i&&o.push(...n.getDirectories().map(u=>u.invite(e,i))),yield Promise.all(o)})()}retryInvite(e){var t=this;return D(function*(){yield yC(()=>t.client.invite(t.roomId,e),n=>!(n instanceof Dt&&n.errcode==="M_FORBIDDEN"))})()}setPermissions(e,t){var n=this;return D(function*(){var i,o=n.room.currentState.getStateEvents(Z.RoomPowerLevels,"");if(Array.isArray(o))throw new Error("Unexpected return type for power levels");var u=o?.getContent()||{},d=u.users_default||0,h=u.events_default||50,f=((i=u.events)===null||i===void 0?void 0:i[Z.RoomPowerLevels])||100,m=u.users||{};switch(t){case Ls.Viewer:m[e]=d;break;case Ls.Editor:m[e]=h;break;case Ls.Owner:m[e]=f;break;default:throw new Error("Invalid role: "+t)}u.users=m,yield n.client.sendStateEvent(n.roomId,Z.RoomPowerLevels,u,"")})()}getPermissions(e){var t,n,i=this.room.currentState.getStateEvents(Z.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");var o=i?.getContent()||{},u=o.users_default||0,d=o.events_default||50,h=((t=o.events)===null||t===void 0?void 0:t[Z.RoomPowerLevels])||100,f=((n=o.users)===null||n===void 0?void 0:n[e])||u;return f>=h?Ls.Owner:f>=d?Ls.Editor:Ls.Viewer}createDirectory(e){var t=this;return D(function*(){var n=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,Z.SpaceChild,{via:[t.client.getDomain()]},n.roomId),yield t.client.sendStateEvent(n.roomId,Z.SpaceParent,{via:[t.client.getDomain()]},t.roomId),n})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(Z.SpaceChild);for(var n of t)try{var i=n.getStateKey();if(i){var o=this.client.unstableGetFileTreeSpace(i);o&&e.push(o)}}catch(u){N.warn("Unable to create tree space instance for listing. Are we joined?",u)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return D(function*(){var t=e.getDirectories();for(var n of t)yield n.delete();var i=[Ye.Invite,Ye.Knock,Ye.Join],o=e.room.currentState.getStateEvents(Z.RoomMember);for(var u of o){var d=u.getStateKey()!==e.client.getUserId();if(d&&i.includes(u.getContent().membership)){var h=u.getStateKey();if(!h)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,h,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(n=>({roomId:n.getStateKey(),order:n.getContent().order})).filter(n=>n.roomId);return t.sort((n,i)=>{if(n.order&&!i.order)return-1;if(!n.order&&i.order)return 1;if(!n.order&&!i.order){var o,u,d,h,f=this.client.getRoom(n.roomId),m=this.client.getRoom(i.roomId);if(!f||!m)return jc(n.roomId,i.roomId);var g=(o=(u=f.currentState.getStateEvents(Z.RoomCreate,""))===null||u===void 0?void 0:u.getTs())!==null&&o!==void 0?o:0,S=(d=(h=m.currentState.getStateEvents(Z.RoomCreate,""))===null||h===void 0?void 0:h.getTs())!==null&&d!==void 0?d:0;return g===S?jc(n.roomId,i.roomId):g-S}else return jc(n.order,i.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(Z.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var n=t.getStateKey();if(!n)throw new Error("No state key found for parent");var i=this.client.getRoom(n);if(!i)throw new Error("Unable to locate room for parent");return i}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(Z.SpaceChild),n=this.getOrderedChildren(t);return n.findIndex(i=>i.roomId===this.roomId)}setOrder(e){var t=this;return D(function*(){var n;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var i=t.getParentRoom(),o=i.currentState.getStateEvents(Z.SpaceChild),u=t.getOrderedChildren(o);e=Math.max(Math.min(e,u.length-1),0);var d=t.getOrder(),h=d<e;h&&e===u.length-1?e--:!h&&e===0&&e++;var f=u[h?e:e-1],m=u[h?e+1:e],g=ta[0],S=!1;if(!f)m!=null&&m.order&&(g=pb(m.order));else if(e===u.length-1)m!=null&&m.order&&(g=nl(m.order));else{var _=f?.order,b=m?.order;_&&b?_===b?g=nl(_):g=SC(_,b):_?g=nl(_):b?g=pb(b):S=!0}if(S){for(var T,k=0;k<=e;k++){var A=u[k];if(k===0&&(T=A.order),A.order)T=A.order;else{var C;T=T?nl(T):ta[0];var U=i.currentState.getStateEvents(Z.SpaceChild,A.roomId),O=(C=U?.getContent())!==null&&C!==void 0?C:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,Z.SpaceChild,Ra(Ra({},O),{},{order:T}),A.roomId)}}T&&(g=nl(T))}var M=i.currentState.getStateEvents(Z.SpaceChild,t.roomId),E=(n=M?.getContent())!==null&&n!==void 0?n:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,Z.SpaceChild,Ra(Ra({},E),{},{order:g}),t.roomId)})()}createFile(e,t,n,i){var o=this;return D(function*(){var{content_uri:u}=yield o.client.uploadContent(t,{includeFilename:!1});n.url=u;var d={msgtype:jr.File,body:e,url:u,file:n};i=i??{},i["m.new_content"]&&(i["m.new_content"]=d);var h=yield o.client.sendMessage(o.roomId,Ra(Ra(Ra({},i),d),{},{[K_.name]:{}}));return yield o.client.sendStateEvent(o.roomId,ci.name,{active:!0,name:e},h.event_id),h})()}getFile(e){var t=this.room.currentState.getStateEvents(ci.name,e);return t?new CE(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(ci.name))!==null&&e!==void 0?e:[];return t.map(n=>new CE(this.client,n,this))}}var F0=(function(s){return s.Recent="recent",s.Rank="rank",s})({}),ka=(function(s){return s.LocalStreamsChanged="local_streams_changed",s})({});class xO extends Lt{constructor(e){super(),this.client=e,y(this,"audioInput",void 0),y(this,"audioSettings",void 0),y(this,"videoInput",void 0),y(this,"localUserMediaStream",void 0),y(this,"userMediaStreams",[]),y(this,"screensharingStreams",[]),y(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return D(function*(){N.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return D(function*(){N.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return D(function*(){N.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var n=this;return D(function*(){N.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),n.audioInput=e,n.videoInput=t,yield n.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return D(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var n of e.client.callEventHandler.calls.values())t.set(n.callId,{audio:n.hasLocalUserMediaAudioTrack,video:n.hasLocalUserMediaVideoTrack});for(var i of e.userMediaStreams){N.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(i.id,")"));for(var o of i.getTracks())o.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var u of e.client.callEventHandler.calls.values())if(!(u.callHasEnded()||!t.has(u.callId))){var{audio:d,video:h}=t.get(u.callId);N.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(u.callId,")"));var f=yield e.getUserMediaStream(d,h);u.callHasEnded()||(yield u.updateLocalUsermediaStream(f))}for(var m of e.client.groupCallEventHandler.groupCalls.values())if(m.localCallFeed){N.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(m.groupCallId,")"));var g=yield e.getUserMediaStream(!0,m.type===md.Video);m.state!==Ft.Ended&&(yield m.updateLocalUsermediaStream(g))}e.emit(ka.LocalStreamsChanged)}})()}hasAudioDevice(){return D(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return N.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return D(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return N.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:!0;return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then(()=>i.getUserMediaStreamInternal(e,t,o)):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,o),i.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,n){var i=this;return D(function*(){var o=e&&(yield i.hasAudioDevice()),u=t&&(yield i.hasVideoDevice()),d,h=!0;if(i.localUserMediaStream){var f,m;o!==i.localUserMediaStream.getAudioTracks().length>0&&(h=!1),u!==i.localUserMediaStream.getVideoTracks().length>0&&(h=!1),o&&((f=i.localUserMediaStream.getAudioTracks()[0])===null||f===void 0||(f=f.getSettings())===null||f===void 0?void 0:f.deviceId)!==i.audioInput&&(h=!1),u&&((m=i.localUserMediaStream.getVideoTracks()[0])===null||m===void 0||(m=m.getSettings())===null||m===void 0?void 0:m.deviceId)!==i.videoInput&&(h=!1)}else h=!1;if(h){var b;if(d=i.localUserMediaStream.clone(),N.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((b=i.localUserMediaStream)===null||b===void 0?void 0:b.id," newStreamId=").concat(d.id," shouldRequestAudio=").concat(o," shouldRequestVideo=").concat(u,")")),!o)for(var T of d.getAudioTracks())d.removeTrack(T);if(!u)for(var k of d.getVideoTracks())d.removeTrack(k)}else{var g;try{g=i.getUserMediaContraints(o,u,!0),d=yield navigator.mediaDevices.getUserMedia(g)}catch(A){N.warn("MediaHandler getUserMediaStreamInternal() error (e=".concat(A,"), retrying without exact deviceId")),g=i.getUserMediaContraints(o,u,!1),d=yield navigator.mediaDevices.getUserMedia(g)}N.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(d.id,", shouldRequestAudio=").concat(o,", shouldRequestVideo=").concat(u,", constraints=").concat(JSON.stringify(g),")"));for(var S of d.getTracks()){var _=S.getSettings();S.kind==="audio"?i.audioInput=_.deviceId:S.kind==="video"&&(i.videoInput=_.deviceId)}n&&(i.localUserMediaStream=d)}return n&&i.userMediaStreams.push(d),i.emit(ka.LocalStreamsChanged),d})()}stopUserMediaStream(e){N.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.userMediaStreams.indexOf(e);if(n!==-1&&(N.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(n,1)),this.emit(ka.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var i of e.getTracks()){var o;if((o=this.localUserMediaStream)!==null&&o!==void 0&&o.getTrackById(i.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return D(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{},i=e.length>1&&e[1]!==void 0?e[1]:!0,o;if(t.screensharingStreams.length===0){var u=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(N.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),o=yield navigator.mediaDevices.getUserMedia(u)):(N.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),o=yield navigator.mediaDevices.getDisplayMedia(u))}else{var d=t.screensharingStreams[t.screensharingStreams.length-1];N.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(d.id,")")),o=d.clone()}return i&&t.screensharingStreams.push(o),t.emit(ka.LocalStreamsChanged),o})()}stopScreensharingStream(e){N.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.screensharingStreams.indexOf(e);n!==-1&&(N.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(n,1)),this.emit(ka.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){N.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var n of this.screensharingStreams)for(var i of n.getTracks())i.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(ka.LocalStreamsChanged)}getUserMediaContraints(e,t,n){var i=!!navigator.webkitGetUserMedia,o=n?"exact":"ideal",u={};this.audioInput&&(u.deviceId={[o]:this.audioInput}),this.audioSettings&&(u.autoGainControl={ideal:this.audioSettings.autoGainControl},u.echoCancellation={ideal:this.audioSettings.echoCancellation},u.noiseSuppression={ideal:this.audioSettings.noiseSuppression});var d={width:i?{exact:640}:{ideal:640},height:i?{exact:360}:{ideal:360}};return this.videoInput&&(d.deviceId={[o]:this.videoInput}),{audio:e?u:!1,video:t?d:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:n}=e;return t?{audio:n??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:n??!1,video:!0}}}var ME=(function(s){return s.RequestFinished="FINISHED",s.Complete="COMPLETE",s})({}),su=(function(s){return s.PreProcess="ExtState.PreProcess",s.PostProcess="ExtState.PostProcess",s})({}),Hv=(function(s){return s.RoomData="SlidingSync.RoomData",s.Lifecycle="SlidingSync.Lifecycle",s})({}),jO=3;class BO{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return su.PreProcess}onRequest(e){var t=this;return D(function*(){return e&&(N.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return D(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class FO{constructor(e,t){this.client=e,this.cryptoCallbacks=t,y(this,"nextBatch",null)}name(){return"to_device"}when(){return su.PreProcess}onRequest(e){var t=this;return D(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return D(function*(){var n=e.events||[],i;t.cryptoCallbacks?i=yield t.cryptoCallbacks.preprocessToDeviceMessages(n):i=n.map(o=>({message:o,encryptionInfo:null})),N0(i,t.client),t.nextBatch=e.next_batch})()}}class qO{constructor(e){this.client=e}name(){return"account_data"}when(){return su.PostProcess}onRequest(e){return D(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return D(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var n in e.rooms){var i=Gs(t.client,n,e.rooms[n]),o=t.client.getRoom(n);if(!o){N.warn("got account data for room but room doesn't exist on client:",n);continue}o.addAccountData(i),i.forEach(u=>{t.client.emit(Ue.Event,u)})}})()}processGlobalAccountData(e){var t=Gs(this.client,void 0,e),n=t.reduce((i,o)=>(i[o.getType()]=this.client.store.getAccountData(o.getType()),i),{});this.client.store.storeAccountDataEvents(t),t.forEach(i=>{if(i.getType()===Z.PushRules){var o=i.getContent();this.client.setPushRules(o)}var u=n[i.getType()];return this.client.emit(Ue.AccountData,i,u),i})}}class KO{constructor(e){this.client=e}name(){return"typing"}when(){return su.PostProcess}onRequest(e){return D(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return D(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)K0(t.client,n,[e.rooms[n]])})()}}class HO{constructor(e){this.client=e}name(){return"receipts"}when(){return su.PostProcess}onRequest(e){return D(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return D(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)K0(t.client,n,[e.rooms[n]])})()}}class q0{constructor(e,t,n,i){this.slidingSync=e,this.client=t,y(this,"opts",void 0),y(this,"syncOpts",void 0),y(this,"syncState",null),y(this,"syncStateData",void 0),y(this,"lastPos",null),y(this,"failCount",0),y(this,"notifEvents",[]),this.opts=k0(n),this.syncOpts=U0(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[ke.Timeline,ke.TimelineReset]),this.slidingSync.on(Hv.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(Hv.RoomData,this.onRoomData.bind(this));var o=[new FO(this.client,this.syncOpts.cryptoCallbacks),new qO(this.client),new KO(this.client),new HO(this.client)];this.syncOpts.cryptoCallbacks&&o.push(new BO(this.syncOpts.cryptoCallbacks)),o.forEach(u=>{this.slidingSync.registerExtension(u)})}onRoomData(e,t){var n=this;return D(function*(){var i=n.client.store.getRoom(e);if(!i){if(!t.initial){n.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}i=P0(n.client,e,n.opts)}yield n.processRoomData(n.client,i,t)})()}onLifecycle(e,t,n){switch(n&&this.syncOpts.logger.debug("onLifecycle",e,n),e){case ME.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(gt.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(gt.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case ME.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>jO?gt.Error:gt.Reconnecting,{error:new Dt(n)}),this.shouldAbortSync(new Dt(n)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys(t?.rooms||[]).length," rooms"));break}}syncLeftRooms(){return D(function*(){return[]})()}peek(e){return D(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,n=new hd(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(n,[ke.Name,ke.Redaction,ke.RedactionCancelled,ke.Receipt,ke.Tags,ke.LocalEchoUpdated,ke.AccountData,ke.MyMembership,ke.Timeline,ke.TimelineReset]),this.registerStateListeners(n),n}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[rt.Events,rt.Members,rt.NewMember,rt.Update]),e.currentState.on(rt.NewMember,(t,n,i)=>{var o;i.user=(o=this.client.getUser(i.userId))!==null&&o!==void 0?o:void 0,this.client.reEmitter.reEmit(i,[Un.Name,Un.Typing,Un.PowerLevel,Un.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(gt.Error,{error:e}),!0):!1}processRoomData(e,t,n){var i=this;return D(function*(){n=VO(e,t.roomId,n);var o=Gs(i.client,t.roomId,n.required_state),u=Gs(i.client,t.roomId,n.timeline,!1),d=[];if(n.limited||n.initial){var h=new Set;t.getLiveTimeline().getEvents().forEach(C=>{h.add(C.getId())});for(var f=[],m=[],g=!1,S=u.length-1;S>=0;S--){var _=u[S];if(h.has(_.getId())){g=!0;continue}g?f.push(_):m.unshift(_)}u=m,f.length>0&&t.addEventsToTimeline(f,!0,!1,t.getLiveTimeline(),n.prev_batch)}var b=t.hasEncryptionStateEvent();if(n.notification_count!=null&&t.setUnreadNotificationCount(ht.Total,n.notification_count),n.highlight_count!=null&&(!b||b&&t.getUnreadNotificationCount(ht.Highlight)<=0)&&t.setUnreadNotificationCount(ht.Highlight,n.highlight_count),n.bump_stamp&&t.setBumpStamp(n.bump_stamp),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){var T=Gs(i.client,t.roomId,n.invite_state);yield i.injectRoomEvents(t,T),n.initial&&(t.recalculate(),i.client.store.storeRoom(t),i.client.emit(Ue.Room,t)),T.forEach(C=>{i.client.emit(Ue.Event,C)});return}if(n.limited){var k;t.getLiveTimeline().setPaginationToken((k=n.prev_batch)!==null&&k!==void 0?k:null,Oe.BACKWARDS)}yield i.injectRoomEvents(t,o,u,n.num_live),t.addEphemeralEvents(d),t.updateMyMembership(Ye.Join),t.setMSC4186SummaryData(n.heroes,n.joined_count,n.invited_count),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(Ue.Room,t)),i.addNotifications(u);var A=(function(){var C=D(function*(U){e.emit(Ue.Event,U),U.isState()&&U.getType()==Z.RoomEncryption&&i.syncOpts.cryptoCallbacks&&(yield i.syncOpts.cryptoCallbacks.onCryptoEvent(t,U))});return function(O){return C.apply(this,arguments)}})();yield Fs(o,A),yield Fs(u,A),d.forEach(function(C){e.emit(Ue.Event,C)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:[],u=n.length>3&&n[3]!==void 0?n[3]:0,d=e.getLiveTimeline(),h=d.getEvents().length==0;if(h){for(var f of t)i.client.getPushActionsForEvent(f);d.initialiseState(t)}h||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var m=[];u>0&&(m=o.slice(-1*u),o=o.slice(0,-1*m.length)),yield e.addLiveEvents(o,{fromCache:!0,addToState:!1}),m.length>0&&(yield e.addLiveEvents(m,{fromCache:!1,addToState:!1})),e.recalculate(),i.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ye.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),o;i?o=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):o=t.getProfileInfo(n.userId),o.then(function(u){var d=n.events.member;d.getContent().membership===Ye.Invite&&(d.getContent().avatar_url=u.avatar_url,d.getContent().displayname=u.displayname,n.setMembershipEvent(d,e.currentState))},function(u){})}})}}retryImmediately(){return!0}sync(){var e=this;return D(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(n){if(e.syncOpts.logger.error("Getting push rules failed",n),e.shouldAbortSync(n))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(Ue.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var n=this.client.getPushActionsForEvent(t);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function VO(s,e,t){if(!t.name)return t;for(var n of t.required_state)if(n.type===Z.RoomName&&n.state_key==="")return n.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:Z.RoomName,content:{name:t.name},sender:s.getUserId(),origin_server_ts:new Date().getTime()}),t}function Gs(s,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,i=s.getEventMapper({decrypt:n});return t.map(function(o){return o.room_id=e,i(o)})}function K0(s,e,t){var n=Gs(s,e,t),i=s.getRoom(e);if(!i){N.warn("got ephemeral events for room but room doesn't exist on client:",e);return}i.addEphemeralEvents(n),n.forEach(o=>{s.emit(Ue.Event,o)})}var Nm=new Yt("m.beacon_info","org.matrix.msc3672.beacon_info"),Vv=new Yt("m.beacon","org.matrix.msc3672.beacon");class Zs{static RETRY_BACKOFF_RATELIMIT(e,t,n){return C0(n,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===Z.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Zs.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Zs.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,y(this,"queues",{}),y(this,"activeQueues",[]),y(this,"procFn",null),y(this,"processQueue",n=>{var i=this.peekNextEvent(n);if(!i){this.disableQueue(n);return}this.queues[n].length,Promise.resolve().then(()=>this.procFn(i.event)).then(o=>{this.removeNextEvent(n),i.event.getId(),i.resolvers.resolve(o),this.processQueue(n)},o=>{i.attempts+=1;var u=this.retryAlgorithm(i.event,i.attempts,o);i.attempts,i.event.getId(),u===-1?(N.info("Queue '%s' giving up on event %s",n,i.event.getId()),this.clearQueue(n,o)):setTimeout(this.processQueue,u,n)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(n){return n.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var n=!1;return Yc(this.queues[t],i=>i.event.getId()===e.getId()?(n=!0,!0):!1),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var n=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:n,attempts:0}),e.getId(),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),N.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){N.info("clearing queue '%s'",e);for(var n;n=this.removeNextEvent(e);)n.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var AE=20;class GO{constructor(e,t){var n=this;this.client=e,this.logger=t,y(this,"sending",!1),y(this,"running",!0),y(this,"retryTimeout",null),y(this,"retryAttempts",0),y(this,"sendQueue",D(function*(){if(n.retryTimeout!==null&&clearTimeout(n.retryTimeout),n.retryTimeout=null,!(n.sending||!n.running)){n.logger.debug("Attempting to send queued to-device messages"),n.sending=!0;var i;try{for(;n.running&&(i=yield n.client.store.getOldestToDeviceBatch(),i!==null);)yield n.sendBatch(i),yield n.client.store.removeToDeviceBatch(i.id),n.retryAttempts=0;if(!n.running)return;n.logger.debug("All queued to-device messages sent")}catch(u){++n.retryAttempts;var o=Zs.RETRY_BACKOFF_RATELIMIT(null,n.retryAttempts,u);if(o===-1){Math.floor(u.httpStatus/100)===4?(n.logger.error("Fatal error when sending to-device message - dropping to-device batch!",u),yield n.client.store.removeToDeviceBatch(i.id)):n.logger.info("Automatic retry limit reached for to-device messages.");return}n.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(o,"ms"),u),n.retryTimeout=setTimeout(n.sendQueue,o)}finally{n.sending=!1}}})),y(this,"onResumedSync",(i,o)=>{i===gt.Syncing&&o!==gt.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(Ue.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(Ue.Sync,this.onResumedSync)}queueBatch(e){var t=this;return D(function*(){for(var n=[],i=0;i<e.batch.length;i+=AE){var o={eventType:e.eventType,batch:e.batch.slice(i,i+AE),txnId:t.client.makeTxnId()};n.push(o);var u=o.batch.map(d=>"".concat(d.userId,"/").concat(d.deviceId," (msgid ").concat(d.payload[dd],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(o.txnId),u)}yield t.client.store.saveToDeviceBatches(n),t.sendQueue()})()}sendBatch(e){var t=this;return D(function*(){var n=new mi(()=>new Map);for(var i of e.batch)n.getOrCreate(i.userId).set(i.deviceId,i.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,n,e.txnId)})()}}var rv=new Pn.UnstableValue("m.policies","org.matrix.msc3847.policies"),Ac=new Pn.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),DE=(function(s){return s.Ban="m.ban",s})({}),zs=(function(s){return s.User="m.policy.user",s.Room="m.policy.room",s.Server="m.policy.server",s})({}),kE={[zs.User]:Z.PolicyRuleUser,[zs.Room]:Z.PolicyRuleRoom,[zs.Server]:Z.PolicyRuleServer};class zO{constructor(e){this.client=e}addRule(e,t,n){var i=this;return D(function*(){var o=yield i.getOrCreateTargetRoom(),u=yield i.client.sendStateEvent(o.roomId,kE[e],{entity:t,reason:n,recommendation:DE.Ban});return u.event_id})()}removeRule(e){var t=this;return D(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return D(function*(){yield t.client.joinRoom(e);var n=(yield t.getOrCreateSourceRooms()).map(i=>i.roomId);return n.includes(e)?!1:(n.push(e),yield t.withIgnoreInvitesPolicies(i=>{i.sources=n}),!0)})()}getRuleForInvite(e){var t=this;return D(function*(){var{sender:n,roomId:i}=e,o=yield t.getOrCreateSourceRooms(),u=n.split(":")[1],d=i.split(":")[1];for(var h of o){var f=h.getUnfilteredTimelineSet().getLiveTimeline().getState(Oe.FORWARDS);for(var{scope:m,entities:g}of[{scope:zs.Room,entities:[i]},{scope:zs.User,entities:[n]},{scope:zs.Server,entities:[u,d]}]){var S=f.getStateEvents(kE[m]);for(var _ of S){var b=_.getContent();if(b?.recommendation==DE.Ban){var T=b?.entity;if(T){var k=void 0;try{k=new RegExp(L_(T))}catch{continue}for(var A of g)if(A&&k.test(A))return _}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return D(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.target;if(typeof n!="string"&&(n=null),n){var i=e.client.getRoom(n);if(i)return i;n=null}return n=(yield e.client.createRoom({name:"Individual Policy Room",preset:Um.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(o=>{o.target=n}),e.client.getRoom(n)})()}getOrCreateSourceRooms(){var e=this;return D(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.sources,i=!1;Array.isArray(n)||(i=!0,n=[]);var o=n.filter(d=>typeof d=="string").map(d=>e.client.getRoom(d)).filter(d=>!!d);if(o.length!=n.length&&(i=!0),o.length==0){var u=yield e.getOrCreateTargetRoom();i=!0,o=[u]}return i&&(yield e.withIgnoreInvitesPolicies(d=>{d.sources=n})),o})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return D(function*(){var{policies:n,ignoreInvitesPolicies:i}=t.getPoliciesAndIgnoreInvitesPolicies();e(i),n[Ac.name]=i,yield t.client.setAccountData(rv.name,n)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[rv.name,rv.altName]){var n;if(t){var i=(n=this.client.getAccountData(t))===null||n===void 0?void 0:n.getContent();if(i){e=i;break}}}var o={},u=!1;for(var d of[Ac.name,Ac.altName])if(d){var h=e[d];if(h&&typeof h=="object"){o=h,u=!0;break}}return u||(e[Ac.name]=o),{policies:e,ignoreInvitesPolicies:o}}}var iv="matrix-js-sdk";function WO(s){if(s.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let f=0;f<e.length;f++)e[f]=255;for(let f=0;f<s.length;f++){const m=s.charAt(f),g=m.charCodeAt(0);if(e[g]!==255)throw new TypeError(m+" is ambiguous");e[g]=f}const t=s.length,n=s.charAt(0),i=Math.log(t)/Math.log(256),o=Math.log(256)/Math.log(t);function u(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";let m=0,g=0,S=0;const _=f.length;for(;S!==_&&f[S]===0;)S++,m++;const b=(_-S)*o+1>>>0,T=new Uint8Array(b);for(;S!==_;){let C=f[S],U=0;for(let O=b-1;(C!==0||U<g)&&O!==-1;O--,U++)C+=256*T[O]>>>0,T[O]=C%t>>>0,C=C/t>>>0;if(C!==0)throw new Error("Non-zero carry");g=U,S++}let k=b-g;for(;k!==b&&T[k]===0;)k++;let A=n.repeat(m);for(;k<b;++k)A+=s.charAt(T[k]);return A}function d(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;let m=0,g=0,S=0;for(;f[m]===n;)g++,m++;const _=(f.length-m)*i+1>>>0,b=new Uint8Array(_);for(;m<f.length;){const C=f.charCodeAt(m);if(C>255)return;let U=e[C];if(U===255)return;let O=0;for(let M=_-1;(U!==0||O<S)&&M!==-1;M--,O++)U+=t*b[M]>>>0,b[M]=U%256>>>0,U=U/256>>>0;if(U!==0)throw new Error("Non-zero carry");S=O,m++}let T=_-S;for(;T!==_&&b[T]===0;)T++;const k=new Uint8Array(g+(_-T));let A=g;for(;T!==_;)k[A++]=b[T++];return k}function h(f){const m=d(f);if(m)return m;throw new Error("Non-base"+t+" character")}return{encode:u,decodeUnsafe:d,decode:h}}var YO="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const lD=WO(YO);var on=(function(s){return s.UserTrustStatusChanged="userTrustStatusChanged",s.KeyBackupStatus="crypto.keyBackupStatus",s.KeyBackupFailed="crypto.keyBackupFailed",s.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",s.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",s.VerificationRequestReceived="crypto.verificationRequestReceived",s.WillUpdateDevices="crypto.willUpdateDevices",s.DevicesUpdated="crypto.devicesUpdated",s.KeysChanged="crossSigning.keysChanged",s.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",s.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",s.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",s.RehydrationStarted="dehydration.RehydrationStarted",s.RehydrationProgress="dehydration.RehydrationProgress",s.RehydrationCompleted="dehydration.RehydrationCompleted",s.RehydrationError="dehydration.RehydrationError",s.DehydrationKeyCached="dehydration.DehydrationKeyCached",s.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",s})({}),JO=(function(s){return s.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",s.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",s.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",s.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",s.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",s.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",s.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",s.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",s.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",s.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",s.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",s.UNKNOWN_ERROR="UNKNOWN_ERROR",s})({}),XO=(function(s){return s[s.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",s[s.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",s})({});class uD{constructor(e){this.errorOnVerifiedUserProblems=e,y(this,"kind",XO.AllDevicesIsolationMode)}}class cD{constructor(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n,y(this,"needsUserApproval",void 0),this.needsUserApproval=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class dD{constructor(e){var t,n,i,o,u;y(this,"signedByOwner",void 0),y(this,"crossSigningVerified",void 0),y(this,"tofu",void 0),y(this,"localVerified",void 0),y(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(n=e.crossSigningVerified)!==null&&n!==void 0?n:!1,this.tofu=(i=e.tofu)!==null&&i!==void 0?i:!1,this.localVerified=(o=e.localVerified)!==null&&o!==void 0?o:!1,this.trustCrossSignedDevices=(u=e.trustCrossSignedDevices)!==null&&u!==void 0?u:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var fD=(function(s){return s.Fetch="fetch",s.LoadKeys="load_keys",s})({}),hD=(function(s){return s.Master="master",s.SelfSigning="self_signing",s.UserSigning="user_signing",s})({}),vD=(function(s){return s[s.NONE=0]="NONE",s[s.GREY=1]="GREY",s[s.RED=2]="RED",s})({}),mD=(function(s){return s[s.UNKNOWN=0]="UNKNOWN",s[s.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",s[s.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",s[s.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",s[s.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",s[s.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",s[s.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",s[s.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",s[s.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",s})({}),QO=new Uint8Array(8);function H0(s,e){return Gv.apply(this,arguments)}function Gv(){return Gv=D(function*(s,e){var t=yield globalThis.crypto.subtle.importKey("raw",s,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:QO,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),i=n.slice(0,32),o=n.slice(32),u=globalThis.crypto.subtle.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),d=globalThis.crypto.subtle.importKey("raw",o,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([u,d])}),Gv.apply(this,arguments)}function V0(s,e,t,n){return zv.apply(this,arguments)}function zv(){return zv=D(function*(s,e,t,n){var i;n?i=Ba(n):(i=new Uint8Array(16),globalThis.crypto.getRandomValues(i),i[8]&=127);var[o,u]=yield H0(e,t),d=new TextEncoder().encode(s),h=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:i,length:64},o,d),f=yield globalThis.crypto.subtle.sign({name:"HMAC"},u,h);return{iv:Nl(i),ciphertext:Nl(new Uint8Array(h)),mac:Nl(new Uint8Array(f))}}),zv.apply(this,arguments)}function ZO(s,e,t){return Wv.apply(this,arguments)}function Wv(){return Wv=D(function*(s,e,t){var[n,i]=yield H0(e,t),o=Ba(s.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},i,Ba(s.mac),o)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var u=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:Ba(s.iv),length:64},n,o);return new TextDecoder().decode(new Uint8Array(u))}),Wv.apply(this,arguments)}var Ua="m.secret_storage.v1.aes-hmac-sha2";class G0{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return D(function*(){var t,n=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return n&&(t=n.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,n)=>{var i=u=>{if(u.getType()==="m.secret_storage.default_key"){var d=u.getContent(),h=e===null?Object.keys(d).length===0:d.key===e;h&&(this.accountDataAdapter.removeListener(Ue.AccountData,i),t())}};this.accountDataAdapter.on(Ue.AccountData,i);var o=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",o).catch(u=>{this.accountDataAdapter.removeListener(Ue.AccountData,i),n(u)})})}addKey(e,t,n){var i=this;return D(function*(){if(e!==Ua)throw new Error("Unknown key algorithm ".concat(e));var o={algorithm:e};t.name&&(o.name=t.name),t.passphrase&&(o.passphrase=t.passphrase);var{iv:u,mac:d}=yield Jv(t.key);if(o.iv=u,o.mac=d,!n)do n=Zi(32);while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(n)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(n),o),{keyId:n,keyInfo:o}})()}getKey(e){var t=this;return D(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var n=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return n?[e,n]:null})()}hasKey(e){var t=this;return D(function*(){var n=yield t.getKey(e);return!!n})()}checkKey(e,t){return D(function*(){if(t.algorithm===Ua)if(t.mac){var{mac:n}=yield Jv(e,t.iv);return Yv(t.mac)===Yv(n)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,n){var i=this;return D(function*(){if(t===null){yield i.accountDataAdapter.setAccountData(e,{});return}var o={};if(!n){var u=yield i.getDefaultKeyId();if(!u)throw new Error("No keys specified and no default key present");n=[u]}if(n.length===0)throw new Error("Zero keys given to encrypt with!");for(var d of n){var h=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(d));if(!h)throw new Error("Unknown key: "+d);if(h.algorithm===Ua){var f={[d]:h},[,m]=yield i.getSecretStorageKey(f,e);o[d]=yield m.encrypt(t)}else N.warn("unknown algorithm for secret storage key "+d+": "+h.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:o})})()}get(e){var t=this;return D(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(n){if(!n.encrypted)throw new Error("Content is not encrypted!");var i={};for(var o of Object.keys(n.encrypted)){var u=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(o)),d=n.encrypted[o];u?.algorithm===Ua&&d.iv&&d.ciphertext&&d.mac&&(i[o]=u)}if(Object.keys(i).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[h,f]=yield t.getSecretStorageKey(i,e),m=n.encrypted[h];return f.decrypt(m)}})()}isStored(e){var t=this;return D(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(n!=null&&n.encrypted))return null;var i={};for(var o of Object.keys(n.encrypted)){var u=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(o));if(u){var d=n.encrypted[o];u.algorithm===Ua&&d.iv&&d.ciphertext&&d.mac&&(i[o]=u)}}return Object.keys(i).length?i:null})()}getSecretStorageKey(e,t){var n=this;return D(function*(){if(!n.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var i=yield n.callbacks.getSecretStorageKey({keys:e},t);if(!i)throw new Error("getSecretStorageKey callback returned falsey");if(i.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[o,u]=i;if(!e[o])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[o].algorithm===Ua){var d={encrypt:function(f){return V0(f,u,t)},decrypt:function(f){return ZO(f,u,t)}};return[o,d]}else throw new Error("Unknown key type: "+e[o].algorithm)})()}}function Yv(s){for(var e=s.length;e>=1&&s.charCodeAt(e-1)==61;)e--;return e<s.length?s.substring(0,e):s}var $O="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function Jv(s,e){return V0($O,s,"",e)}const eM=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:Ua,ServerSideSecretStorageImpl:G0,calculateKeyCheck:Jv,trimTrailingEquals:Yv},Symbol.toStringTag,{value:"Module"}));function Lm(s){return Xv.apply(this,arguments)}function Xv(){return Xv=D(function*(s){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(s),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),Xv.apply(this,arguments)}var z0=1e3*60*60*4,tM=(s,e,t)=>{var n,i=" - ";if(typeof s.slot_id!="string"?e.push(i+"slot_id must be string"):s.slot_id.split("#").length!==2&&e.push(i+'slot_id must include exactly one "#"'),typeof s.member!="object"||s.member===null?e.push(i+"member must be an object"):(typeof s.member.user_id!="string"?e.push(i+"member.user_id must be string"):mm.test(s.member.user_id)?s.member.user_id!==t&&e.push(i+"member.user_id must match the sender"):e.push(i+"member.user_id must be a valid mxid"),typeof s.member.device_id!="string"&&e.push(i+"member.device_id must be string"),typeof s.member.id!="string"&&e.push(i+"member.id must be string")),typeof s.application!="object"||s.application===null?e.push(i+"application must be an object"):typeof s.application.type!="string"?e.push(i+"application.type must be a string"):s.application.type.includes("#")&&e.push(i+'application.type must not include "#"'),s.rtc_transports===void 0||!Array.isArray(s.rtc_transports))e.push(i+"rtc_transports must be an array");else for(var o of s.rtc_transports)if(typeof o!="object"||o===null||typeof o.type!="string"){e.push(i+"rtc_transports entries must be objects with a string type");break}if(s.versions===void 0||!Array.isArray(s.versions)?e.push(i+"versions must be an array"):s.versions.every(d=>typeof d=="string")||e.push(i+"versions must be an array of strings"),((n=s.sticky_key)!==null&&n!==void 0?n:s.msc4354_sticky_key)===void 0&&e.push(i+"sticky_key or msc4354_sticky_key must be a defined"),s.sticky_key!==void 0&&typeof s.sticky_key!="string"&&e.push(i+"sticky_key must be a string"),s.msc4354_sticky_key!==void 0&&typeof s.msc4354_sticky_key!="string"&&e.push(i+"msc4354_sticky_key must be a string"),s.sticky_key!==void 0&&s.msc4354_sticky_key!==void 0&&s.sticky_key!==s.msc4354_sticky_key&&e.push(i+"sticky_key and msc4354_sticky_key must be equal if both are defined"),s["m.relates_to"]!==void 0){var u=s["m.relates_to"];typeof u!="object"||u===null?e.push(i+"m.relates_to must be an object if provided"):(typeof u.event_id!="string"&&e.push(i+"m.relates_to.event_id must be a string"),u.rel_type!=="m.reference"&&e.push(i+"m.relates_to.rel_type must be m.reference"))}return e.length===0},nM=(s,e)=>{var t,n=" - ";return typeof s.device_id!="string"&&e.push(n+"device_id must be string"),typeof s.call_id!="string"&&e.push(n+"call_id must be string"),typeof s.application!="string"&&e.push(n+"application must be a string"),typeof((t=s.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(n+"focus_active.type must be a string"),s.focus_active===void 0&&e.push(n+"focus_active has an invalid type"),s.foci_preferred!==void 0&&!(Array.isArray(s.foci_preferred)&&s.foci_preferred.every(i=>typeof i=="object"&&i!==null&&typeof i.type=="string"))&&e.push(n+"foci_preferred must be an array of transport objects"),s.created_ts!==void 0&&typeof s.created_ts!="number"&&e.push(n+"created_ts must be number"),s.scope!==void 0&&typeof s.scope!="string"&&e.push(n+"scope must be string"),s["m.call.intent"]!==void 0&&typeof s["m.call.intent"]!="string"&&e.push(n+"m.call.intent must be a string"),e.length===0};class ea{static equal(e,t){return qa(e?.membershipData,t?.membershipData)}constructor(e,t,n,i){this.membershipData=t,this.rtcBackendIdentity=n,y(this,"logger",void 0),y(this,"matrixEventData",void 0);var[o,u,d]=[e.getId(),e.getSender(),e.getTs()];if(o===void 0)throw new Error("parentEvent is missing eventId field");if(u===void 0)throw new Error("parentEvent is missing sender field");this.matrixEventData={eventId:o,sender:u,ts:d},this.logger=i?.getChild("[CallMembership ".concat(u,":").concat(this.deviceId,"]"))}static computeRtcBackendIdentity(e,t){return D(function*(){var{kind:n,data:i}=t;switch(n){case"rtc":return ea.computeRtcIdentityRaw(i.member.user_id,i.member.device_id,i.member.id);case"session":return"".concat(e.getSender(),":").concat(i.device_id)}})()}static computeRtcIdentityRaw(e,t,n){return D(function*(){return Mm(yield Lm("".concat(e,"|").concat(t,"|").concat(n)))})()}static membershipDataFromMatrixEvent(e){var[t,n,i]=[e.getId(),e.getSender(),e.getContent()];if(t===void 0)throw new Error("parentEvent is missing eventId field");if(n===void 0)throw new Error("parentEvent is missing sender field");var o=[],u=[];if(nM(i,o))return{kind:"session",data:i};if(tM(i,u,n))return{kind:"rtc",data:i};var d=o.length<u.length?`Does not match MSC4143 m.call.member:
`.concat(o.join(`
`),`

`):`Does not match MSC4143 m.rtc.member:
`.concat(u.join(`
`),`

`),h=`
event:
`+JSON.stringify(i).replaceAll('"',"'");throw Error(`unknown CallMembership data.
`+d+h)}get sender(){return this.userId}get userId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.member.user_id:this.matrixEventData.sender}get eventId(){return this.matrixEventData.eventId}get slotId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.slot_id:Bm({application:this.application,id:t.call_id})}get deviceId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.member.device_id:t.device_id}get callIntent(){var{kind:e,data:t}=this.membershipData;switch(e){case"rtc":{var n,i=t.application["m.call.intent"];if(typeof i=="string")return i;(n=this.logger)===null||n===void 0||n.warn("RTC membership has invalid m.call.intent");return}default:return t["m.call.intent"]}}get slotDescription(){return hM(this.slotId)}get application(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.application.type:t.application}get applicationData(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.application:{type:t.application,"m.call.intent":t["m.call.intent"]}}get scope(){var{kind:e,data:t}=this.membershipData;if(e!=="rtc")return t.scope}get membershipID(){return this.memberId}get memberId(){var e,{kind:t,data:n}=this.membershipData;return t==="rtc"?n.member.id:(e=n.membershipID)!==null&&e!==void 0?e:"".concat(this.matrixEventData.sender,":").concat(n.device_id)}createdTs(){var e,{kind:t,data:n}=this.membershipData;return t==="rtc"?this.matrixEventData.ts:(e=n.created_ts)!==null&&e!==void 0?e:this.matrixEventData.ts}getAbsoluteExpiry(){var e,{kind:t,data:n}=this.membershipData;if(t!=="rtc")return this.createdTs()+((e=n.expires)!==null&&e!==void 0?e:z0)}getMsUntilExpiry(){var{kind:e}=this.membershipData;if(e!=="rtc")return this.getAbsoluteExpiry()-Date.now()}isExpired(){var{kind:e}=this.membershipData;return e==="rtc"?!1:this.getMsUntilExpiry()<=0}getTransport(e){var{kind:t,data:n}=this.membershipData;switch(t){case"rtc":return n.rtc_transports[0];case"session":switch(n.focus_active.focus_selection){case"multi_sfu":return n.foci_preferred[0];case"oldest_membership":if(ea.equal(this,e))return n.foci_preferred[0];if(e!==void 0)return e.getTransport(e);break}}}getFocusActive(){var{kind:e,data:t}=this.membershipData;if(e==="session")return t.focus_active}get transports(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.rtc_transports:t.foci_preferred}get kind(){return this.membershipData.kind}}var wa=(function(s){return s.Disconnected="Disconnected",s.Connecting="Connecting",s.Connected="Connected",s.Disconnecting="Disconnecting",s.Unknown="Unknown",s})({}),qc=(s,e,t)=>s.sender===e&&s.deviceId===t;class rM{constructor(e,t){this.membershipLoopHandler=e,y(this,"logger",void 0),y(this,"running",!1),y(this,"wakeup",n=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),y(this,"_actions",[]),this.logger=(t??N).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return D(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:Ve.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((f,m)=>f.ts-m.ts);var i=e._actions[0],o=void 0,u=new Promise(f=>{e.wakeup=m=>{o=m,f()}});i.ts>Date.now()&&(yield Promise.race([u,iu(i.ts-Date.now())]));var d={};if(!o){e.logger.debug("Current MembershipManager processing: ".concat(i.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{d=yield e.membershipLoopHandler(i.type)}catch(f){throw Error("The MembershipManager shut down because of the end condition: ".concat(f))}}e._actions.splice(0,1);var h=o??d;"replace"in h?e._actions=h.replace:"insert"in h&&e._actions.push(...h.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Ve.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Ve.SendScheduledDelayedLeaveEvent}]})}}var xm=(function(s){return s.TooNew="TOO_NEW",s})({});class jm extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}y(jm,"TOO_NEW",xm.TooNew);class iM extends Error{constructor(e,t){super(e),this.value=t}}class aM extends Error{constructor(){super("MatrixClient has been stopped")}}class Zn extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}class Qv extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedStickyEventsEndpointError"}}var xa=(function(s){return s.StatusChanged="StatusChanged",s.ProbablyLeft="ProbablyLeft",s.DelayIdChanged="DelayIdChanged",s})({});function UE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Ks(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?UE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):UE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var Zv=3600*1e3,Ve=(function(s){return s.SendDelayedEvent="SendDelayedEvent",s.SendJoinEvent="SendJoinEvent",s.RestartDelayedEvent="RestartDelayedEvent",s.UpdateExpiry="UpdateExpiry",s.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",s.SendLeaveEvent="SendLeaveEvent",s})({});function ur(s,e){return{insert:[{ts:Date.now()+(e??0),type:s}]}}function av(s,e){return{replace:[{ts:Date.now()+0,type:s}]}}class Yl extends Lt{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,n){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.rtcTransport=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=Yl.defaultState,this.scheduler.startWithJoin().catch(i=>{this.logger.error("MembershipManager stopped because: ",i),n?.(i)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(xa.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var i;(i=this.leavePromiseResolvers)===null||i===void 0||i.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){if(!this.isActivated())return Promise.resolve();if(this._ownMembership=e.find(n=>qc(n,this.userId,this.deviceId)),!this._ownMembership){var t=[Ve.SendDelayedEvent,Ve.SendJoinEvent];this.logger.warn("Missing own membership: force re-join"),this.state.hasMemberStateEvent=!1,this.scheduler.actions.some(n=>t.includes(n.type))?this.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",this.scheduler.actions):this.scheduler.initiateJoin()}return Promise.resolve()}updateCallIntent(e){var t=this;return D(function*(){if(!t.activated||!t.ownMembership)throw Error("You cannot update your intent before joining the call");t.ownMembership.callIntent!==e&&(t.callIntent=e,yield t.sendJoinEvent())})()}constructor(e,t,n,i,o){super(),this.joinConfig=e,this.room=t,this.client=n,this.slotDescription=i,y(this,"activated",!1),y(this,"logger",void 0),y(this,"callIntent",void 0),y(this,"leavePromiseResolvers",void 0),y(this,"_ownMembership",void 0),y(this,"oldStatus",void 0),y(this,"scheduler",void 0),y(this,"state",void 0),y(this,"deviceId",void 0),y(this,"userId",void 0),y(this,"stateKey",void 0),y(this,"rtcTransport",void 0),y(this,"fociPreferred",void 0),y(this,"delayedLeaveEventDelayMsOverride",void 0),y(this,"clientSendDelayedDisconnectMembership",()=>this.client._unstable_sendDelayedStateEvent(this.room.roomId,{delay:this.delayedLeaveEventDelayMs},Z.GroupCallMemberPrefix,{},this.stateKey)),y(this,"clientSendMembership",h=>this.client.sendStateEvent(this.room.roomId,Z.GroupCallMemberPrefix,h,this.stateKey)),this.logger=(o??N).getChild("[MembershipManager]");var[u,d]=[this.client.getUserId(),this.client.getDeviceId()];if(u===null)throw Error("Missing userId in client");if(d===null)throw Error("Missing deviceId in client");this.deviceId=d,this.userId=u,this.stateKey=this.makeMembershipStateKey(u,d),this.state=Yl.defaultState,this.callIntent=e?.callIntent,this.scheduler=new rM(h=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(xa.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(h)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1,probablyLeft:!1}}get networkErrorRetryMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.networkErrorRetryMs)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipEventExpiryMs)!==null&&e!==void 0?e:z0}get membershipEventExpiryHeadroomMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipEventExpiryHeadroomMs)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+Math.min(this.membershipEventExpiryMs,Zv)*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,n;return(e=(t=this.delayedLeaveEventDelayMsOverride)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventDelayMs)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartMs)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)!==null&&e!==void 0?e:2e3}membershipLoopHandler(e){var t=this;return D(function*(){switch(e){case Ve.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case Ve.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):ur(Ve.SendDelayedEvent);case Ve.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):ur(Ve.SendLeaveEvent):{replace:[]};case Ve.SendJoinEvent:return t.sendJoinEvent();case Ve.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case Ve.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return D(function*(){return yield e.clientSendDelayedDisconnectMembership().then(t=>(e.state.expectedServerDelayLeaveTs=Date.now()+e.delayedLeaveEventDelayMs,e.setAndEmitProbablyLeft(!1),e.resetRateLimitCounter(Ve.SendDelayedEvent),e.setAndEmitDelayId(t.delay_id),e.state.hasMemberStateEvent?ur(Ve.RestartDelayedEvent,e.delayedLeaveEventRestartMs):ur(Ve.SendJoinEvent))).catch(t=>{var n=Ve.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return ur(n);var i=e.actionUpdateFromErrors(t,n,"_unstable_sendDelayedStateEvent");if(i)return i;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),ur(Ve.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return D(function*(){return yield t.client._unstable_cancelScheduledDelayedEvent(e).then(()=>(t.setAndEmitDelayId(void 0),t.resetRateLimitCounter(Ve.SendDelayedEvent),av(Ve.SendDelayedEvent))).catch(n=>{var i=Ve.SendDelayedEvent,o=t.actionUpdateFromErrors(n,i,"cancelScheduledDelayedEvent");if(o)return o;if(t.isNotFoundError(n))return t.setAndEmitDelayId(void 0),av(i);if(t.isUnsupportedDelayedEndpoint(n))return av(Ve.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}setAndEmitProbablyLeft(e){this.state.probablyLeft!==e&&(this.state.probablyLeft=e,this.emit(xa.ProbablyLeft,this.state.probablyLeft))}setAndEmitDelayId(e){this.state.delayId!==e&&(this.state.delayId=e,this.emit(xa.DelayIdChanged,this.state.delayId))}restartDelayedEvent(e){var t=this;return D(function*(){var n=t.state.expectedServerDelayLeaveTs?t.state.expectedServerDelayLeaveTs-Date.now():void 0,i=new Promise((o,u)=>{setTimeout(()=>{u(new U_("Restart delayed event timed out before the HS responded"))},n!==void 0&&!t.state.probablyLeft?Math.min(t.delayedLeaveEventRestartLocalTimeoutMs,n):t.delayedLeaveEventRestartLocalTimeoutMs)});return yield Promise.race([t.client._unstable_restartScheduledDelayedEvent(e),i]).then(()=>(t.state.expectedServerDelayLeaveTs=Date.now()+t.delayedLeaveEventDelayMs,t.resetRateLimitCounter(Ve.RestartDelayedEvent),t.setAndEmitProbablyLeft(!1),ur(Ve.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(o=>{t.state.expectedServerDelayLeaveTs&&t.state.expectedServerDelayLeaveTs<=Date.now()&&t.setAndEmitProbablyLeft(!0);var u=Ve.RestartDelayedEvent;if(t.isNotFoundError(o))return t.setAndEmitDelayId(void 0),ur(Ve.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(o))return{};var d=t.actionUpdateFromErrors(o,u,"restartScheduledDelayedEvent");if(d)return d;throw Error("Could not restart delayed event, even though delayed events are supported. "+o)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return D(function*(){return yield t.client._unstable_sendScheduledDelayedEvent(e).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(Ve.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(n=>{var i=Ve.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(n))return{};if(t.isNotFoundError(n))return t.setAndEmitDelayId(void 0),ur(i);var o=t.actionUpdateFromErrors(n,i,"sendScheduledDelayedEvent");return o||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",n),ur(i))})})()}sendJoinEvent(){var e=this;return D(function*(){return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs)).then(()=>{e.setAndEmitProbablyLeft(!1),e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(Ve.SendJoinEvent);var t=e.scheduler.actions.filter(n=>n.type!==Ve.UpdateExpiry&&n.type!==Ve.SendJoinEvent);return{replace:[...t,{ts:Date.now(),type:Ve.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:Ve.UpdateExpiry}]}}).catch(t=>{var n=e.actionUpdateFromErrors(t,Ve.SendJoinEvent,"sendStateEvent");if(n)return n;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return D(function*(){var t=e.state.expireUpdateIterations+1;return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs*t)).then(()=>(e.resetRateLimitCounter(Ve.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:Ve.UpdateExpiry}]})).catch(n=>{var i=e.actionUpdateFromErrors(n,Ve.UpdateExpiry,"sendStateEvent");if(i)return i;throw n})})()}sendFallbackLeaveEvent(){var e=this;return D(function*(){return yield e.clientSendMembership({}).then(()=>(e.resetRateLimitCounter(Ve.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var n=e.actionUpdateFromErrors(t,Ve.SendLeaveEvent,"sendStateEvent");if(n)return n;throw t})})()}makeMembershipStateKey(e,t){var n="".concat(e,"_").concat(t,"_").concat(this.slotDescription.application).concat(this.slotDescription.id);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?n:"_".concat(n)}makeMyMembership(e){var t,n,i=this.ownMembership,o=this.rtcTransport===void 0?{focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}:{focus_active:{type:"livekit",focus_selection:"multi_sfu"},foci_preferred:[this.rtcTransport,...(n=this.fociPreferred)!==null&&n!==void 0?n:[]]};return Ks(Ks({application:this.slotDescription.application,call_id:this.slotDescription.id,scope:"m.room",device_id:this.deviceId,membershipID:"".concat(this.userId,":").concat(this.deviceId),expires:e,"m.call.intent":this.callIntent},o),i!==void 0?{created_ts:i.createdTs()}:void 0)}isNotFoundError(e){return e instanceof Dt&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof Dt&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,n){var i=this.actionUpdateFromRateLimitError(e,n,t);if(i)return i;var o=this.actionUpdateFromNetworkErrorRetry(e,t);if(o)return o}actionUpdateFromRateLimitError(e,t,n){var i;if((e instanceof Ka||e instanceof Dt)&&e.isRateLimitError()){var o=(i=this.state.rateLimitRetries.get(n))!==null&&i!==void 0?i:0;if(o<this.maximumRateLimitRetryCount){var u,d=5e3;try{var h;u=(h=e.getRetryAfterMs())!==null&&h!==void 0?h:d,this.logger.info("Rate limited by server, retrying in ".concat(u,"ms"))}catch(f){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(d),f),u=d}return this.state.rateLimitRetries.set(n,o+1),ur(n,u)}throw Error("Exceeded maximum retries for "+n+" attempts (client."+t+")",{cause:e})}}actionUpdateFromNetworkErrorRetry(e,t){var n,i=(n=this.state.networkErrorRetries.get(t))!==null&&n!==void 0?n:0,o=this.networkErrorRetryMs/1e3+"s",u="("+i+"/"+this.maximumNetworkErrorRetryCount+")",d=this.networkErrorRetryMs;if(e instanceof Error&&e.name==="AbortError")d=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+u+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+o+" "+u,e);else if(e instanceof Ga)this.logger.warn("Network connection error while sending event, retrying in "+o+" "+u,e);else if((e instanceof Ka||e instanceof Dt)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+o+" "+u,e);else return;if(i<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,i+1),ur(t,d);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof Zn}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case Ve.SendDelayedEvent:case Ve.SendJoinEvent:return wa.Connecting;case Ve.UpdateExpiry:return wa.Connected;case Ve.SendScheduledDelayedLeaveEvent:case Ve.SendLeaveEvent:return wa.Disconnecting}}else if(e.length===2){var n=e.map(o=>o.type);if((n.includes(Ve.RestartDelayedEvent)||n.includes(Ve.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&n.includes(Ve.UpdateExpiry))return wa.Connected}else if(e.length===3){var i=e.map(o=>o.type);if(i.filter(o=>o===Ve.RestartDelayedEvent).length===2&&i.includes(Ve.UpdateExpiry))return wa.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),wa.Unknown):wa.Disconnected}get probablyLeft(){return this.state.probablyLeft}get delayId(){return this.state.delayId}}class gd extends Yl{constructor(e,t,n,i,o,u){super(e,t,n,i,u),this.clientWithSticky=n,this.memberId=o,y(this,"clientSendDelayedDisconnectMembership",()=>this.clientWithSticky._unstable_sendStickyDelayedEvent(this.room.roomId,Zv,{delay:this.delayedLeaveEventDelayMs},null,Z.RTCMembership,{msc4354_sticky_key:this.memberId})),y(this,"clientSendMembership",d=>this.clientWithSticky._unstable_sendStickyEvent(this.room.roomId,Zv,null,Z.RTCMembership,Ks(Ks({},d),{},{msc4354_sticky_key:this.memberId})))}actionUpdateFromErrors(e,t,n){var i;return super.actionUpdateFromErrors(e,t,(i=gd.nameMap.get(n))!==null&&i!==void 0?i:"unknown")}makeMyMembership(e){var t=this.ownMembership,n=t!=null&&t.eventId?{"m.relation":{rel_type:Mt.Reference,event_id:t?.eventId}}:{};return Ks({application:Ks({type:this.slotDescription.application},this.callIntent?{"m.call.intent":this.callIntent}:{}),slot_id:Bm(this.slotDescription),rtc_transports:this.rtcTransport?[this.rtcTransport]:[],member:{device_id:this.deviceId,user_id:this.userId,id:this.memberId},versions:[]},n)}}y(gd,"nameMap",new Map([["sendStateEvent","_unstable_sendStickyEvent"],["sendDelayedStateEvent","_unstable_sendStickyDelayedEvent"]]));var $s=(function(s){return s.ReceivedKeys="received_keys",s.NotSupportedError="not_supported_error",s})({});function Yi(s){return"".concat(s.userId,":").concat(s.deviceId,"(").concat(s.memberId,")")}class sM{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,n,i,o,u){var d=this;this.membership=e,this.getMemberships=t,this.transport=n,this.statistics=i,this.onEncryptionKeysChanged=o,y(this,"manageMediaKeys",!1),y(this,"keysEventUpdateTimeout",void 0),y(this,"makeNewKeyTimeout",void 0),y(this,"setNewKeyTimeouts",new Set),y(this,"encryptionKeys",new Map),y(this,"lastEncryptionKeyUpdateRequest",void 0),y(this,"lastMembershipFingerprints",void 0),y(this,"latestGeneratedKeyIndex",-1),y(this,"joinConfig",void 0),y(this,"logger",void 0),y(this,"joined",!1),y(this,"sendEncryptionKeysEvent",(function(){var h=D(function*(f){if(d.keysEventUpdateTimeout!==void 0&&(clearTimeout(d.keysEventUpdateTimeout),d.keysEventUpdateTimeout=void 0),d.lastEncryptionKeyUpdateRequest=Date.now(),!!d.joined){var m=d.getKeysForParticipant(d.membership);if(!m){d.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof f!="number"&&d.latestGeneratedKeyIndex===-1){d.logger.warn("Tried to send encryption keys event but no current key index found!");return}var g=f??d.latestGeneratedKeyIndex;d.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(g," (method parameter: ").concat(f,")"));var S=m[g];try{d.statistics.counters.roomEventEncryptionKeysSent+=1;var _=d.getMemberships().filter(T=>T.sender!=null).map(T=>({userId:T.sender,deviceId:T.deviceId,membershipTs:T.createdTs()}));yield d.transport.sendKey(Mm(S),g,_),d.logger.debug("sendEncryptionKeysEvent participantId=".concat(d.membership.userId,":").concat(d.membership.deviceId," numKeys=").concat(m.length," currentKeyIndex=").concat(d.latestGeneratedKeyIndex," keyIndexToSend=").concat(g))}catch(T){if(d.keysEventUpdateTimeout===void 0){var b=Tm(T,5e3);d.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(b),T),d.keysEventUpdateTimeout=setTimeout(()=>{d.sendEncryptionKeysEvent()},b)}else d.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(f){return h.apply(this,arguments)}})()),y(this,"onNewKeyReceived",(h,f,m,g)=>{this.logger.debug("Received key over key transport ".concat(h.userId,":").concat(h.deviceId," at index ").concat(m)),this.setEncryptionKey(h,m,f,g)}),y(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var h=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(h)}}),this.logger=(u??N).getChild("[EncryptionManager]")}rtcBackendIdentityFromMembershipParts(e){return"".concat(e.userId,":").concat(e.deviceId)}getEncryptionKeys(){var e=new Map;for(var[t,n]of this.encryptionKeys){var i=n.map((o,u)=>({key:o.key,membership:o.membership,keyIndex:u,rtcBackendIdentity:this.rtcBackendIdentityFromMembershipParts(o.membership)}));e.set(t,i)}return e}join(e){var t,n,i;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on($s.ReceivedKeys,this.onNewKeyReceived),this.transport.start(),(i=this.joinConfig)!==null&&i!==void 0&&i.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(Yi(this.membership),[]),this.transport.off($s.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(f=>!qc(f,this.membership.userId,this.membership.deviceId)).map(Yi)),n=new Set(this.getMemberships().filter(f=>!qc(f,this.membership.userId,this.membership.deviceId)).map(Yi)),i=Array.from(t).some(f=>!n.has(f)),o=Array.from(n).some(f=>!t.has(f)),u=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),i)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(o)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(u){var d=this.lastMembershipFingerprints,h=Array.from(u).some(f=>!d.has(f))||Array.from(d).some(f=>!u.has(f));h&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=QI(16),n=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+n),this.setEncryptionKey(this.membership,n,t,Date.now(),e),n}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>{this.sendEncryptionKeysEvent()},this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e){var t;return(t=this.encryptionKeys.get(Yi(e)))===null||t===void 0?void 0:t.map(n=>n.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!qc(e,this.membership.userId,this.membership.deviceId)).map(e=>"".concat(Yi(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,n,i){var o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;this.logger.debug("Setting encryption key for ".concat(e.userId,":").concat(e.deviceId," at index ").concat(t));var u=Ba(n),d=Yi(e);this.encryptionKeys.has(d)||this.encryptionKeys.set(d,[]);var h=this.encryptionKeys.get(d),f=h[t];if(f){if(f.timestamp>i){this.logger.info("Ignoring new key at index ".concat(t," for ").concat(d," as it is older than existing known key"));return}if(oM(f.key,u)){f.timestamp=i;return}}if(e.userId===this.membership.userId&&e.deviceId===this.membership.deviceId&&(this.latestGeneratedKeyIndex=t),h[t]={key:u,timestamp:i,membership:e},o){var m=setTimeout(()=>{this.setNewKeyTimeouts.delete(m),this.logger.info("Delayed-emitting key changed event for ".concat(d," index ").concat(t)),this.onEncryptionKeysChanged(u,t,e,this.rtcBackendIdentityFromMembershipParts(e))},this.useKeyDelay);this.setNewKeyTimeouts.add(m)}else this.onEncryptionKeysChanged(u,t,e,this.rtcBackendIdentityFromMembershipParts(e))}}function oM(s,e){return s===e?!0:!!s&&!!e&&s.length===e.length&&s.every((t,n)=>t===e[n])}class lM{constructor(){y(this,"tsBuffer",new Map)}isOutdated(e,t){var n,i=Yi(e);this.tsBuffer.has(i)||this.tsBuffer.set(i,new Map);var o=(n=this.tsBuffer.get(i))===null||n===void 0?void 0:n.get(t.keyIndex);return o&&o>t.creationTS?!0:(this.tsBuffer.get(i).set(t.keyIndex,t.creationTS),!1)}}class uM{constructor(e,t,n,i,o,u,d){this.ownMembership=e,this.getMemberships=t,this.transport=n,this.statistics=i,this.onEncryptionKeysChanged=o,y(this,"manageMediaKeys",!1),y(this,"useHashedRtcBackendIdentity",!1),y(this,"ownRtcBackendIdentityCache",void 0),y(this,"participantKeyRings",new Map),y(this,"outboundSession",null),y(this,"currentKeyDistributionPromise",null),y(this,"useKeyDelay",5e3),y(this,"keyRotationGracePeriodMs",1e4),y(this,"needToEnsureKeyAgain",!1),y(this,"keyBuffer",new lM),y(this,"logger",void 0),y(this,"rtcIdentityProvider",void 0),y(this,"keysWithoutMatchingRTCMembership",[]),y(this,"onNewKeyReceived",(h,f,m,g)=>{var S;if(!this.manageMediaKeys){var _;(_=this.logger)===null||_===void 0||_.warn("Received key over transport ".concat(h.userId,":").concat(h.deviceId," at index ").concat(m," but media keys are disabled"));return}(S=this.logger)===null||S===void 0||S.debug("Received key over transport ".concat(h.userId,":").concat(h.deviceId," at index ").concat(m));var b=Ba(f),T={key:b,membership:h,keyIndex:m,creationTS:g},k=this.keyBuffer.isOutdated(h,T);if(!k)this.addKeyToParticipant(T.key,T.keyIndex,T.membership),this.statistics.counters.roomEventEncryptionKeysReceived+=1;else{var A;(A=this.logger)===null||A===void 0||A.info("Received an out of order key for ".concat(h.userId,":").concat(h.deviceId,", dropping it"))}}),this.logger=u?.getChild("[EncryptionManager]"),this.rtcIdentityProvider=d??ea.computeRtcIdentityRaw}getOwnRtcBackendIdentity(){var e=this;return D(function*(){if(e.ownRtcBackendIdentityCache)return e.ownRtcBackendIdentityCache;if(e.useHashedRtcBackendIdentity){var t,{userId:n,deviceId:i,memberId:o}=e.ownMembership;(t=e.logger)===null||t===void 0||t.info("Computing RTC backend identity for ".concat(n,":").concat(i,":").concat(o," (SHOULD ONLY BE CALLED ONCE)")),e.ownRtcBackendIdentityCache=yield e.rtcIdentityProvider(n,i,o)}else e.ownRtcBackendIdentityCache="".concat(e.ownMembership.userId,":").concat(e.ownMembership.deviceId);return e.ownRtcBackendIdentityCache})()}getEncryptionKeys(){return new Map(this.participantKeyRings)}checkKeysWithoutMatchingRTCMembership(){var e=this.keysWithoutMatchingRTCMembership;this.keysWithoutMatchingRTCMembership=[],e.forEach(t=>{this.addKeyToParticipant(t.key,t.keyIndex,t.membership)})}addKeyToParticipant(e,t,n){var i=this.getMemberships(),o=i.find(d=>d.userId===n.userId&&d.deviceId===n.deviceId);if(!o){var u;(u=this.logger)===null||u===void 0||u.info("No matching RTC membership for key from ".concat(n.userId,":").concat(n.deviceId,", delaying key addition")),this.keysWithoutMatchingRTCMembership.push({key:e,keyIndex:t,membership:n});return}this.addKeyToParticipantWithBackendIdentity(e,t,n,o.rtcBackendIdentity)}addKeyToParticipantWithBackendIdentity(e,t,n,i){var o=Yi(n);this.participantKeyRings.has(o)||this.participantKeyRings.set(o,[]),this.participantKeyRings.get(o).push({key:e,keyIndex:t,membership:n,rtcBackendIdentity:i}),this.onEncryptionKeysChanged(e,t,n,i)}join(e){var t,n,i,o,u;this.manageMediaKeys=(t=e?.manageMediaKeys)!==null&&t!==void 0?t:!0,this.useHashedRtcBackendIdentity=(n=e?.unstableSendStickyEvents)!==null&&n!==void 0?n:!1,this.useKeyDelay=(i=e?.useKeyDelay)!==null&&i!==void 0?i:1e3,this.keyRotationGracePeriodMs=(o=e?.keyRotationGracePeriodMs)!==null&&o!==void 0?o:1e4,this.transport.on($s.ReceivedKeys,this.onNewKeyReceived),this.getOwnRtcBackendIdentity(),(u=this.logger)===null||u===void 0||u.info("Joining room"),this.transport.start()}leave(){this.transport.off($s.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){if(this.manageMediaKeys)if(this.currentKeyDistributionPromise==null){var e;(e=this.logger)===null||e===void 0||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var n;if((n=this.logger)===null||n===void 0||n.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain){var i;(i=this.logger)===null||i===void 0||i.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution()}})}else{var t;(t=this.logger)===null||t===void 0||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0}}onMembershipsUpdate(){var e;(e=this.logger)===null||e===void 0||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution(),this.checkKeysWithoutMatchingRTCMembership()}rolloutOutboundKey(){var e=this;return D(function*(){var t,n,i=e.outboundSession==null;if(i){var o={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0};e.outboundSession=o,e.addKeyToParticipantWithBackendIdentity(o.key,o.keyId,e.ownMembership,yield e.getOwnRtcBackendIdentity())}var u=e.getMemberships().filter(w=>w.sender!=null).map(w=>({userId:w.sender,deviceId:w.deviceId,membershipTs:w.createdTs()})),d=(t=(n=e.outboundSession)===null||n===void 0?void 0:n.sharedWith)!==null&&t!==void 0?t:[];d=d.filter(w=>!u.some(q=>w.userId==q.userId&&w.deviceId==q.deviceId&&w.membershipTs!=q.membershipTs));var h=d.filter(w=>!u.some(q=>w.userId==q.userId&&w.deviceId==q.deviceId&&w.membershipTs==q.membershipTs)),f=u.filter(w=>!d.some(q=>w.userId==q.userId&&w.deviceId==q.deviceId&&w.membershipTs==q.membershipTs)),m=[],g,S=!1;if(h.length>0){var _=e.createNewOutboundSession();S=!0,m=u,g=_}else if(f.length>0){var b=Date.now(),T=b-e.outboundSession.creationTS;if(T<e.keyRotationGracePeriodMs){var k;(k=e.logger)===null||k===void 0||k.debug("New joiners detected, but the key is recent enough (age:".concat(T,"), keeping it")),m=f,g=e.outboundSession}else{var A;(A=e.logger)===null||A===void 0||A.debug("New joiners detected, rotating the key");var C=e.createNewOutboundSession();S=!0,m=u,g=C}}else return;try{var U,O;if((U=e.logger)===null||U===void 0||U.trace("Sending key..."),yield e.transport.sendKey(Nl(g.key),g.keyId,m),e.statistics.counters.roomEventEncryptionKeysSent+=1,g.sharedWith.push(...m),(O=e.logger)===null||O===void 0||O.trace("key index:".concat(g.keyId," sent to ").concat(g.sharedWith.map(w=>"".concat(w.userId,":").concat(w.deviceId)).join(","))),S){var M,E;(M=e.logger)===null||M===void 0||M.trace("Delay Rollout for key:".concat(g.keyId,"...")),yield iu(e.useKeyDelay),(E=e.logger)===null||E===void 0||E.trace("...Delayed rollout of index:".concat(g.keyId," ")),e.addKeyToParticipantWithBackendIdentity(g.key,g.keyId,e.ownMembership,yield e.getOwnRtcBackendIdentity())}}catch(w){var I;(I=e.logger)===null||I===void 0||I.error("Failed to rollout key",w)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return(e=this.logger)===null||e===void 0||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}}class cM extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class dM extends Lt{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,n,i,o){super(),this.membership=e,this.roomId=t,this.client=n,this.statistics=i,y(this,"logger",N),y(this,"onToDeviceEvent",u=>{if(u.getType()===Z.CallEncryptionKeysPrefix){var d=this.getValidEventContent(u);d&&u.getSender()&&this.receiveCallKeyEvent(u.getSender(),d)}}),this.setParentLogger(o??N)}start(){this.client.on(Ue.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(Ue.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,n){var i=this;return D(function*(){var o={keys:{index:t,key:e},room_id:i.roomId,member:{claimed_device_id:i.membership.deviceId,id:i.membership.memberId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},u=n.map(d=>({userId:d.userId,deviceId:d.deviceId})).filter(d=>!(d.userId==i.membership.userId&&d.deviceId==i.membership.deviceId));u.length>0?(yield i.client.encryptAndSendToDevice(Z.CallEncryptionKeysPrefix,u,o).catch(d=>{var h=d.message;if(h.includes("unknown variant")&&h.includes("send_to_device")||h.includes("not supported"))throw new cM("The widget driver does not support to-device encryption")}),i.statistics.counters.roomEventEncryptionKeysSent+=1):i.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){var n;this.statistics.counters.roomEventEncryptionKeysReceived+=1;var i=Date.now(),o=i-(typeof t.sent_ts=="number"?t.sent_ts:i);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=o;var u="".concat(e,":").concat(t.member.claimed_device_id);this.emit($s.ReceivedKeys,{userId:e,deviceId:t.member.claimed_device_id,memberId:(n=t.member.id)!==null&&n!==void 0?n:u},t.keys.key,t.keys.index,i)}getValidEventContent(e){var t=e.getContent(),n=t.room_id;if(!n){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(n!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}}class fM extends Lt{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,n,i){super(),this.room=e,this.client=t,this.statistics=n,y(this,"logger",N),this.setParentLogger(i??N)}start(){this.room.on(ke.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}stop(){this.room.off(ke.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}consumeCallEncryptionEvent(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield n.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){i?n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>{n.consumeCallEncryptionEvent(e,!0)},1e3));return}else i&&n.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==Z.CallEncryptionKeysPrefix)return Promise.resolve();if(!n.room)return n.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();n.onEncryptionEvent(e)})()}sendKey(e,t,n){var i=this;return D(function*(){var o={keys:[{index:t,key:e}],device_id:i.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield i.client.sendEvent(i.room.roomId,Z.CallEncryptionKeysPrefix,o)}catch(d){i.logger.error("Failed to send call encryption keys",d);var u=d;throw u.event&&i.client.cancelPendingEvent(u.event),d}})()}onEncryptionEvent(e){var t=e.getSender(),n=e.getContent(),i=n.device_id,o=n.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(o));return}if(o!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(i,", callId=").concat(o));return}if(!Array.isArray(n.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(o));return}if(t===this.client.getUserId()&&i===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var u=Date.now()-(typeof n.sent_ts=="number"?n.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=u;for(var d of n.keys){if(!d){this.logger.info("Ignoring false-y key in keys event");continue}var h=d.key,f=d.index;!h||f===void 0||f===null||o===void 0||o===null||typeof i!="string"||typeof o!="string"||typeof h!="string"||typeof f!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(i,", encryptionKeyIndex=").concat(f," callId=").concat(o)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(i," encryptionKeyIndex=").concat(f," age=").concat(u,"ms")),this.emit($s.ReceivedKeys,{userId:t,deviceId:i,memberId:"".concat(t,":").concat(i)},h,f,e.getTs()))}}}function PE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Dc(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?PE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):PE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var ii=(function(s){return s.MembershipsChanged="memberships_changed",s.JoinStateChanged="join_state_changed",s.EncryptionKeyChanged="encryption_key_changed",s.MembershipManagerError="membership_manager_error",s.DidSendCallNotification="did_send_call_notification",s})({});function hM(s){var[e,t]=s.split("#");return{application:e,id:t}}function Bm(s){return"".concat(s.application,"#").concat(s.id)}var vM={listenForStickyEvents:!0,listenForMemberStateEvents:!0};class Jl extends Lt{get membershipStatus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.status}get probablyLeft(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.probablyLeft}get delayId(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.delayId}get callId(){var e;return(e=this.slotDescription)===null||e===void 0?void 0:e.id}get slotId(){return Bm(this.slotDescription)}static sessionMembershipsForSlot(e,t){var n=arguments;return D(function*(){var i=n.length>2&&n[2]!==void 0?n[2]:vM,o=N.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),u=yM(e,i,o),d=yield mM(e,u,t,o);return d.sort((h,f)=>h.createdTs()-f.createdTs()),d.length>1&&o.debug("Call memberships in room ".concat(e.roomId,", in order: "),d.map(h=>[h.createdTs(),h.userId])),d})()}static sessionForSlot(e,t,n,i){return new Jl(e,t,n,i)}get room(){return this.roomSubset}constructor(e,t,n,i){var o;super(),o=this,this.client=e,this.roomSubset=t,this.slotDescription=n,this.calculateMembershipsOpts=i,y(this,"membershipManager",void 0),y(this,"encryptionManager",void 0),y(this,"joinConfig",void 0),y(this,"logger",void 0),y(this,"pendingNotificationToSend",void 0),y(this,"expiryTimeout",void 0),y(this,"memberships",[]),y(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),y(this,"reEmitter",new lo(this)),y(this,"onRoomMemberUpdate",()=>{this.ensureRecalculateSessionMembers()}),y(this,"onStickyEventUpdate",(u,d,h)=>{[...u,...h,...d.flatMap(f=>[f.current,f.previous])].some(f=>f.getType()===Z.RTCMembership)&&this.ensureRecalculateSessionMembers()}),y(this,"_onRTCSessionMemberUpdate",D(function*(){yield o.recalculateSessionMembers()})),y(this,"recalculateSessionMembersDirty",!1),y(this,"recalculateSessionMembersPromise",void 0),y(this,"recalculateSessionMembers",D(function*(){var u,d=o.memberships;o.memberships=yield Jl.sessionMembershipsForSlot(o.room,o.slotDescription,o.calculateMembershipsOpts);var h=d.length!=o.memberships.length||d.some((_,b)=>!ea.equal(_,o.memberships[b]));if(h){var f,m;o.logger.info("Memberships for call in room ".concat(o.roomSubset.roomId," have changed: emitting (").concat(o.memberships.length," members)")),gC(o.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{o.emit(ii.MembershipsChanged,d,o.memberships)}),(f=o.membershipManager)===null||f===void 0||f.onRTCSessionMemberUpdate(o.memberships);var g=(m=o.membershipManager)===null||m===void 0?void 0:m.ownMembership;if(o.pendingNotificationToSend&&g&&d.length===0){var S;g.eventId&&(S=o.joinConfig)!==null&&S!==void 0&&S.notificationType?o.sendCallNotify(g.eventId,o.joinConfig.notificationType,g.callIntent):o.logger.warn("Own membership eventId is undefined, cannot send call notification")}o.memberships.length>0&&(o.pendingNotificationToSend=void 0)}else o.logger.debug("No membership changes detected for room ".concat(o.roomSubset.roomId));(u=o.encryptionManager)===null||u===void 0||u.onMembershipsUpdate(d),o.setExpiryTimer()})),this.logger=N.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this.roomSubset.on(rt.Members,this.onRoomMemberUpdate),this.roomSubset.on(Ji.Update,this.onStickyEventUpdate),this.ensureRecalculateSessionMembers(),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return D(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0),e.roomSubset.off(rt.Members,e.onRoomMemberUpdate),e.roomSubset.off(Ji.Update,e.onStickyEventUpdate)})()}joinRTCSession(e,t,n,i){var o;if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{this.membershipManager=i!=null&&i.unstableSendStickyEvents?new gd(i,this.roomSubset,this.client,this.slotDescription,e.memberId,this.logger):new Yl(i,this.roomSubset,this.client,this.slotDescription,this.logger),this.reEmitter.reEmit(this.membershipManager,[xa.ProbablyLeft,xa.StatusChanged,xa.DelayIdChanged]);var u;if(i!=null&&i.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[d,h,f]=[this.roomSubset,this.client,this.statistics],m=new dM(e,d.roomId,h,f);this.encryptionManager=new uM(e,()=>this.memberships,m,this.statistics,(g,S,_,b)=>{this.emit(ii.EncryptionKeyChanged,g,S,_,b)},this.logger)}else u=new fM(this.roomSubset,this.client,this.statistics),this.encryptionManager=new sM(e,()=>this.memberships,u,this.statistics,(g,S,_,b)=>{this.emit(ii.EncryptionKeyChanged,g,S,_,b)})}this.joinConfig=i,this.pendingNotificationToSend=(o=this.joinConfig)===null||o===void 0?void 0:o.notificationType,this.membershipManager.join(t,n,g=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",g),this.emit(ii.MembershipManagerError,g),this.emit(ii.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(i),this.emit(ii.JoinStateChanged,!0)}joinRoomSession(e,t,n){var[i,o]=[this.client.getUserId(),this.client.getDeviceId()],u="".concat(i,":").concat(o);this.joinRTCSession({userId:i,deviceId:o,memberId:u},e,t,n)}leaveRoomSession(){var e=arguments,t=this;return D(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var i=t.membershipManager.leave(n);return t.emit(ii.JoinStateChanged,!1),yield i})()}getFocusInUse(){var e=this.getOldestMembership();return e?.getTransport(e)}getActiveFocus(){var e;return(e=this.getOldestMembership())===null||e===void 0?void 0:e.getFocusActive()}getOldestMembership(){return this.memberships[0]}getConsensusCallIntent(){var e,t=(e=this.memberships.find(n=>!!n.callIntent))===null||e===void 0?void 0:e.callIntent;if(t&&this.memberships.every(n=>!n.callIntent||n.callIntent===t))return t}updateCallIntent(e){var t=this;return D(function*(){var n,i,o=(n=t.membershipManager)===null||n===void 0?void 0:n.ownMembership;if(!o)throw Error("Not connected yet");yield(i=t.membershipManager)===null||i===void 0?void 0:i.updateCallIntent(e)})()}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,n)=>{t.forEach(i=>{this.emit(ii.EncryptionKeyChanged,i.key,i.keyIndex,i.membership,i.rtcBackendIdentity)})})}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var n=t.getMsUntilExpiry();n!==void 0&&(e===void 0||n<e)&&(e=n)}e!=null&&(this.expiryTimeout=setTimeout(this.ensureRecalculateSessionMembers.bind(this),e))}sendCallNotify(e,t,n){var i=this,o=(function(){var d=D(function*(){var h={application:"m.call","m.mentions":{user_ids:[],room:!0},notify_type:t==="notification"?"notify":t,call_id:i.callId},f=yield i.client.sendEvent(i.roomSubset.roomId,Z.CallNotify,h);return{response:f,content:h}});return function(){return d.apply(this,arguments)}})(),u=(function(){var d=D(function*(){var h={"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:Mt.Reference},sender_ts:Date.now(),lifetime:3e4};n&&(h["m.call.intent"]=n);var f=yield i.client.sendEvent(i.roomSubset.roomId,Z.RTCNotification,h);return{response:f,content:h}});return function(){return d.apply(this,arguments)}})();Promise.all([o(),u()]).then(d=>{var[h,f]=d,m=Dc(Dc({},h.response),h.content),g=Dc(Dc({},f.response),f.content);this.emit(ii.DidSendCallNotification,g,m)}).catch(d=>{var[h,f]=d;return this.logger.error("Failed to send call notification",h,f)})}ensureRecalculateSessionMembers(){this.recalculateSessionMembersPromise===void 0?this.recalculateSessionMembersPromise=this.recalculateSessionMembers().then(()=>{this.recalculateSessionMembersPromise=void 0,this.recalculateSessionMembersDirty&&(this.ensureRecalculateSessionMembers(),this.recalculateSessionMembersDirty=!1)}):this.recalculateSessionMembersDirty=!0}}function mM(s,e,t,n){return $v.apply(this,arguments)}function $v(){return $v=D(function*(s,e,t,n){var i=[];for(var o of e){var u=o.getContent();if(pM(u,n))try{var d=ea.membershipDataFromMatrixEvent(o),h=new ea(o,d,yield ea.computeRtcBackendIdentity(o,d),n);gM(h,s,t,n)&&i.push(h)}catch(f){n.warn("Couldn't construct call membership: ",f)}}return i}),$v.apply(this,arguments)}function pM(s,e){var t=Object.keys(s).filter(n=>n!=="msc4354_sticky_key").length;return t===0?!1:t>1&&"application"in s?!0:(t===1&&"memberships"in s&&e.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),!1)}function gM(s,e,t,n){var i;return qa(s.slotDescription,t)?s.isExpired()?(n.info("Ignoring expired device membership ".concat(s.userId,"/").concat(s.deviceId)),!1):e.hasMembershipState((i=s.userId)!==null&&i!==void 0?i:"",Ye.Join)?!0:(n.info("Ignoring membership of user ".concat(s.userId," who is not in the room.")),!1):(n.info("Ignoring membership of user ".concat(s.userId," for a different slot:  ").concat(JSON.stringify(s.slotDescription))),!1)}function yM(s,e,t){var{listenForStickyEvents:n,listenForMemberStateEvents:i}=e,o=[];if(n&&(o=[...s._unstable_getStickyEvents()].filter(h=>h.getType()===Z.RTCMembership)),i){var u=s.getLiveTimeline().getState(Oe.FORWARDS);if(!u)return t.warn("Couldn't get state for room "+s.roomId+"using empty membership array"),[];var d=u.getStateEvents(Z.GroupCallMemberPrefix);o=o.concat(d.filter(h=>!o.some(f=>f.getContent().msc4354_sticky_key===h.getStateKey())))}return o}var NE=(function(s){return s.SessionStarted="session_started",s.SessionEnded="session_ended",s})({});class SM extends Lt{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{application:"m.call",id:""};super(),this.client=t,this.slotDescription=n,y(this,"roomSessions",new Map),y(this,"logger",void 0),y(this,"onRoom",i=>{this.refreshRoom(i)}),y(this,"onEvent",i=>{if(i.unstableStickyExpiresAt&&i.getType()===Z.RTCMembership){var o=this.client.getRoom(i.getRoomId());o&&this.refreshRoom(o)}}),y(this,"onRoomState",i=>{if(i.getType()===Z.GroupCallMemberPrefix){var o=this.client.getRoom(i.getRoomId());if(!o){this.logger.error("Got room state event for unknown room ".concat(i.getRoomId(),"!"));return}this.refreshRoom(o)}}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,n=Jl.sessionForSlot(this.client,e,this.slotDescription);n.memberships.length>0&&this.roomSessions.set(e.roomId,n)}this.client.on(Ue.Room,this.onRoom),this.client.on(Ue.Event,this.onEvent),this.client.on(rt.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(Ue.Room,this.onRoom),this.client.off(Ue.Event,this.onEvent),this.client.off(rt.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,Jl.sessionForSlot(this.client,e,this.slotDescription)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=this;return D(function*(){var n=!t.roomSessions.has(e.roomId),i=t.getRoomSession(e),o=i.memberships.length>0&&!n;yield i._onRTCSessionMemberUpdate().catch(d=>{t.logger.error("Error updating RTC session members for ".concat(e.roomId,": ").concat(d))});var u=i.memberships.length>0;o&&!u?(t.logger.trace("Session ended for ".concat(e.roomId," (").concat(i.memberships.length," members)")),t.emit(NE.SessionEnded,e.roomId,t.roomSessions.get(e.roomId))):!o&&u&&(t.logger.trace("Session started for ".concat(e.roomId," (").concat(i.memberships.length," members)")),t.emit(NE.SessionStarted,e.roomId,t.roomSessions.get(e.roomId)))})()}}function sv(s){return e=>{var t,n;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==s||((n=e.content)===null||n===void 0||(n=n["m.relates_to"])===null||n===void 0?void 0:n.rel_type)===wt.name}}class kl extends Error{}kl.prototype.name="InvalidTokenError";function bM(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function EM(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return bM(e)}catch{return atob(e)}}function W0(s,e){if(typeof s!="string")throw new kl("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=s.split(".")[t];if(typeof n!="string")throw new kl(`Invalid token specified: missing part #${t+1}`);let i;try{i=EM(n)}catch(o){throw new kl(`Invalid token specified: invalid base64 for part #${t+1} (${o.message})`)}try{return JSON.parse(i)}catch(o){throw new kl(`Invalid token specified: invalid json for part #${t+1} (${o.message})`)}}var _M={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},Nr,Lr,Xl=(s=>(s[s.NONE=0]="NONE",s[s.ERROR=1]="ERROR",s[s.WARN=2]="WARN",s[s.INFO=3]="INFO",s[s.DEBUG=4]="DEBUG",s))(Xl||{});(s=>{function e(){Nr=3,Lr=_M}s.reset=e;function t(i){if(!(0<=i&&i<=4))throw new Error("Invalid log level");Nr=i}s.setLevel=t;function n(i){Lr=i}s.setLogger=n})(Xl||(Xl={}));var Wt=class Pr{constructor(e){this._name=e}debug(...e){Nr>=4&&Lr.debug(Pr._format(this._name,this._method),...e)}info(...e){Nr>=3&&Lr.info(Pr._format(this._name,this._method),...e)}warn(...e){Nr>=2&&Lr.warn(Pr._format(this._name,this._method),...e)}error(...e){Nr>=1&&Lr.error(Pr._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const n=new Pr(`${e}.${t}`);return n.debug("begin"),n}static _format(e,t){const n=`[${e}]`;return t?`${n} ${t}:`:n}static debug(e,...t){Nr>=4&&Lr.debug(Pr._format(e),...t)}static info(e,...t){Nr>=3&&Lr.info(Pr._format(e),...t)}static warn(e,...t){Nr>=2&&Lr.warn(Pr._format(e),...t)}static error(e,...t){Nr>=1&&Lr.error(Pr._format(e),...t)}};Xl.reset();var Ql=class{static decode(s){try{return W0(s)}catch(e){throw Wt.error("JwtUtils.decode",e),e}}static async generateSignedJwt(s,e,t){const n=gn.encodeBase64Url(new TextEncoder().encode(JSON.stringify(s))),i=gn.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),o=`${n}.${i}`,u=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(o)),d=gn.encodeBase64Url(new Uint8Array(u));return`${o}.${d}`}static async generateSignedJwtWithHmac(s,e,t){const n=gn.encodeBase64Url(new TextEncoder().encode(JSON.stringify(s))),i=gn.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),o=`${n}.${i}`,u=await window.crypto.subtle.sign("HMAC",t,new TextEncoder().encode(o)),d=gn.encodeBase64Url(new Uint8Array(u));return`${o}.${d}`}},TM="10000000-1000-4000-8000-100000000000",em=s=>btoa([...new Uint8Array(s)].map(e=>String.fromCharCode(e)).join("")),Y0=class br{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return TM.replace(/[018]/g,t=>(+t^br._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return br.generateUUIDv4()+br.generateUUIDv4()+br.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const n=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",n);return em(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw Wt.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const i=new TextEncoder().encode([e,t].join(":"));return em(i)}static async hash(e,t){const n=new TextEncoder().encode(t),i=await crypto.subtle.digest(e,n);return new Uint8Array(i)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const n=await br.hash("SHA-256",JSON.stringify(t));return br.encodeBase64Url(n)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:n,keyPair:i,nonce:o}){let u,d;const h={jti:window.crypto.randomUUID(),htm:n??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(u=await br.hash("SHA-256",t),d=br.encodeBase64Url(u),h.ath=d),o&&(h.nonce=o);try{const f=await crypto.subtle.exportKey("jwk",i.publicKey),m={alg:"ES256",typ:"dpop+jwt",jwk:{crv:f.crv,kty:f.kty,x:f.x,y:f.y}};return await Ql.generateSignedJwt(m,h,i.privateKey)}catch(f){throw f instanceof TypeError?new Error(`Error exporting dpop public key: ${f.message}`):f}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await br.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}static async generateClientAssertionJwt(e,t,n,i="HS256"){const o=Math.floor(Date.now()/1e3),u={alg:i,typ:"JWT"},d={iss:e,sub:e,aud:n,jti:br.generateUUIDv4(),exp:o+300,iat:o},f={HS256:"SHA-256",HS384:"SHA-384",HS512:"SHA-512"}[i];if(!f)throw new Error(`Unsupported algorithm: ${i}. Supported algorithms are: HS256, HS384, HS512`);const m=new TextEncoder,g=await crypto.subtle.importKey("raw",m.encode(t),{name:"HMAC",hash:f},!1,["sign"]);return await Ql.generateSignedJwtWithHmac(u,d,g)}};Y0.encodeBase64Url=s=>em(s).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var gn=Y0,RM=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new Wt(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},id=class Kc extends RM{constructor(){super(...arguments),this._logger=new Wt(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-Kc.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=Kc.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const n=Kc.getEpochTime()+e;if(this.expiration===n&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=n;const i=Math.min(e,5);this._timerHandle=setInterval(this._callback,i*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},LE=class{static readParams(s,e="query"){if(!s)throw new TypeError("Invalid URL");const n=new URL(s,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(n.slice(1))}},eo=";",to=class extends Error{constructor(s,e){var t,n,i;if(super(s.error_description||s.error||""),this.form=e,this.name="ErrorResponse",!s.error)throw Wt.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=s.error,this.error_description=(t=s.error_description)!=null?t:null,this.error_uri=(n=s.error_uri)!=null?n:null,this.state=s.userState,this.session_state=(i=s.session_state)!=null?i:null,this.url_state=s.url_state}},wM=class extends Error{constructor(s){super(s),this.name="ErrorTimeout"}},CM=class{constructor(){this._logger=new Wt("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(s){return this._logger.create(`getItem('${s}')`),this._data[s]}setItem(s,e){this._logger.create(`setItem('${s}')`),this._data[s]=e}removeItem(s){this._logger.create(`removeItem('${s}')`),delete this._data[s]}get length(){return Object.getOwnPropertyNames(this._data).length}key(s){return Object.getOwnPropertyNames(this._data)[s]}},tm=class extends Error{constructor(s,e){super(e),this.name="ErrorDPoPNonce",this.nonce=s}},Fm=class{constructor(s=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new Wt("JsonService"),this._contentTypes=[],this._contentTypes.push(...s,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(s,e={}){const{timeoutInSeconds:t,...n}=e;if(!t)return await fetch(s,n);const i=new AbortController,o=setTimeout(()=>i.abort(),t*1e3);try{return await fetch(s,{...e,signal:i.signal})}catch(u){throw u instanceof DOMException&&u.name==="AbortError"?new wM("Network timed out"):u}finally{clearTimeout(o)}}async getJson(s,{token:e,credentials:t,timeoutInSeconds:n}={}){const i=this._logger.create("getJson"),o={Accept:this._contentTypes.join(", ")};e&&(i.debug("token passed, setting Authorization header"),o.Authorization="Bearer "+e),this._appendExtraHeaders(o);let u;try{i.debug("url:",s),u=await this.fetchWithTimeout(s,{method:"GET",headers:o,timeoutInSeconds:n,credentials:t})}catch(f){throw i.error("Network Error"),f}i.debug("HTTP response received, status",u.status);const d=u.headers.get("Content-Type");if(d&&!this._contentTypes.find(f=>d.startsWith(f))&&i.throw(new Error(`Invalid response Content-Type: ${d??"undefined"}, from URL: ${s}`)),u.ok&&this._jwtHandler&&d?.startsWith("application/jwt"))return await this._jwtHandler(await u.text());let h;try{h=await u.json()}catch(f){throw i.error("Error parsing JSON response",f),u.ok?f:new Error(`${u.statusText} (${u.status})`)}if(!u.ok)throw i.error("Error from server:",h),h.error?new to(h):new Error(`${u.statusText} (${u.status}): ${JSON.stringify(h)}`);return h}async postForm(s,{body:e,basicAuth:t,timeoutInSeconds:n,initCredentials:i,extraHeaders:o}){const u=this._logger.create("postForm"),d={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...o};t!==void 0&&(d.Authorization="Basic "+t),this._appendExtraHeaders(d);let h;try{u.debug("url:",s),h=await this.fetchWithTimeout(s,{method:"POST",headers:d,body:e,timeoutInSeconds:n,credentials:i})}catch(S){throw u.error("Network error"),S}u.debug("HTTP response received, status",h.status);const f=h.headers.get("Content-Type");if(f&&!this._contentTypes.find(S=>f.startsWith(S)))throw new Error(`Invalid response Content-Type: ${f??"undefined"}, from URL: ${s}`);const m=await h.text();let g={};if(m)try{g=JSON.parse(m)}catch(S){throw u.error("Error parsing JSON response",S),h.ok?S:new Error(`${h.statusText} (${h.status})`)}if(!h.ok){if(u.error("Error from server:",g),h.headers.has("dpop-nonce")){const S=h.headers.get("dpop-nonce");throw new tm(S,`${JSON.stringify(g)}`)}throw g.error?new to(g,e):new Error(`${h.statusText} (${h.status}): ${JSON.stringify(g)}`)}return g}_appendExtraHeaders(s){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),n=["accept","content-type"],i=["authorization"];t.length!==0&&t.forEach(o=>{if(n.includes(o.toLocaleLowerCase())){e.warn("Protected header could not be set",o,n);return}if(i.includes(o.toLocaleLowerCase())&&Object.keys(s).includes(o)){e.warn("Header could not be overridden",o,i);return}const u=typeof this._extraHeaders[o]=="function"?this._extraHeaders[o]():this._extraHeaders[o];u&&u!==""&&(s[o]=u)})}},J0=class{constructor(s){this._settings=s,this._logger=new Wt("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new Fm(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const s=this._logger.create("getMetadata");if(this._metadata)return s.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw s.throw(new Error("No authority or metadataUrl configured on settings")),null;s.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return s.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},e,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(s=!0){return this._getMetadataProperty("token_endpoint",s)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(s=!0){return this._getMetadataProperty("revocation_endpoint",s)}getKeysEndpoint(s=!0){return this._getMetadataProperty("jwks_uri",s)}async _getMetadataProperty(s,e=!1){const t=this._logger.create(`_getMetadataProperty('${s}')`),n=await this.getMetadata();if(t.debug("resolved"),n[s]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+s))}return n[s]}async getSigningKeys(){const s=this._logger.create("getSigningKeys");if(this._signingKeys)return s.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);s.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(s.debug("got key set",t),!Array.isArray(t.keys))throw s.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},yd=class{constructor({prefix:s="oidc.",store:e=localStorage}={}){this._logger=new Wt("WebStorageStateStore"),this._store=e,this._prefix=s}async set(s,e){this._logger.create(`set('${s}')`),s=this._prefix+s,await this._store.setItem(s,e)}async get(s){return this._logger.create(`get('${s}')`),s=this._prefix+s,await this._store.getItem(s)}async remove(s){this._logger.create(`remove('${s}')`),s=this._prefix+s;const e=await this._store.getItem(s);return await this._store.removeItem(s),e}async getAllKeys(){this._logger.create("getAllKeys");const s=await this._store.length,e=[];for(let t=0;t<s;t++){const n=await this._store.key(t);n&&n.indexOf(this._prefix)===0&&e.push(n.substr(this._prefix.length))}return e}},IM="code",OM="openid",MM="client_secret_post",AM=900,nm=class{constructor({authority:s,metadataUrl:e,metadata:t,signingKeys:n,metadataSeed:i,client_id:o,client_secret:u,response_type:d=IM,scope:h=OM,redirect_uri:f,post_logout_redirect_uri:m,client_authentication:g=MM,token_endpoint_auth_signing_alg:S="HS256",prompt:_,display:b,max_age:T,ui_locales:k,acr_values:A,resource:C,response_mode:U,filterProtocolClaims:O=!0,loadUserInfo:M=!1,requestTimeoutInSeconds:E,staleStateAgeInSeconds:I=AM,mergeClaimsStrategy:w={array:"replace"},disablePKCE:q=!1,stateStore:z,revokeTokenAdditionalContentTypes:ue,fetchRequestCredentials:Se,refreshTokenAllowedScope:Ie,extraQueryParams:Ze={},extraTokenParams:me={},extraHeaders:J={},dpop:oe,omitScopeWhenRequesting:pe=!1}){var Te;if(this.authority=s,e?this.metadataUrl=e:(this.metadataUrl=s,s&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=i,this.signingKeys=n,this.client_id=o,this.client_secret=u,this.response_type=d,this.scope=h,this.redirect_uri=f,this.post_logout_redirect_uri=m,this.client_authentication=g,this.token_endpoint_auth_signing_alg=S,this.prompt=_,this.display=b,this.max_age=T,this.ui_locales=k,this.acr_values=A,this.resource=C,this.response_mode=U,this.filterProtocolClaims=O??!0,this.loadUserInfo=!!M,this.staleStateAgeInSeconds=I,this.mergeClaimsStrategy=w,this.omitScopeWhenRequesting=pe,this.disablePKCE=!!q,this.revokeTokenAdditionalContentTypes=ue,this.fetchRequestCredentials=Se||"same-origin",this.requestTimeoutInSeconds=E,z)this.stateStore=z;else{const De=typeof window<"u"?window.localStorage:new CM;this.stateStore=new yd({store:De})}if(this.refreshTokenAllowedScope=Ie,this.extraQueryParams=Ze,this.extraTokenParams=me,this.extraHeaders=J,this.dpop=oe,this.dpop&&!((Te=this.dpop)!=null&&Te.store))throw new Error("A DPoPStore is required when dpop is enabled")}},DM=class{constructor(s,e){this._settings=s,this._metadataService=e,this._logger=new Wt("UserInfoService"),this._getClaimsFromJwt=async t=>{const n=this._logger.create("_getClaimsFromJwt");try{const i=Ql.decode(t);return n.debug("JWT decoding successful"),i}catch(i){throw n.error("Error parsing JWT response"),i}},this._jsonService=new Fm(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(s){const e=this._logger.create("getClaims");s||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const n=await this._jsonService.getJson(t,{token:s,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",n),n}},X0=class{constructor(s,e){this._settings=s,this._metadataService=e,this._logger=new Wt("TokenClient"),this._jsonService=new Fm(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:s="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,extraHeaders:i,...o}){const u=this._logger.create("exchangeCode");t||u.throw(new Error("A client_id is required")),e||u.throw(new Error("A redirect_uri is required")),o.code||u.throw(new Error("A code is required"));const d=new URLSearchParams({grant_type:s,redirect_uri:e});for(const[g,S]of Object.entries(o))S!=null&&d.set(g,S);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&n==null)throw u.throw(new Error("A client_secret is required")),null;let h;const f=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":h=gn.generateBasicAuth(t,n);break;case"client_secret_post":d.append("client_id",t),n&&d.append("client_secret",n);break;case"client_secret_jwt":{const g=await gn.generateClientAssertionJwt(t,n,f,this._settings.token_endpoint_auth_signing_alg);d.append("client_id",t),d.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),d.append("client_assertion",g);break}}u.debug("got token endpoint");const m=await this._jsonService.postForm(f,{body:d,basicAuth:h,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return u.debug("got response"),m}async exchangeCredentials({grant_type:s="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:n=this._settings.scope,...i}){const o=this._logger.create("exchangeCredentials");e||o.throw(new Error("A client_id is required"));const u=new URLSearchParams({grant_type:s});this._settings.omitScopeWhenRequesting||u.set("scope",n);for(const[m,g]of Object.entries(i))g!=null&&u.set(m,g);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&t==null)throw o.throw(new Error("A client_secret is required")),null;let d;const h=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":d=gn.generateBasicAuth(e,t);break;case"client_secret_post":u.append("client_id",e),t&&u.append("client_secret",t);break;case"client_secret_jwt":{const m=await gn.generateClientAssertionJwt(e,t,h,this._settings.token_endpoint_auth_signing_alg);u.append("client_id",e),u.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),u.append("client_assertion",m);break}}o.debug("got token endpoint");const f=await this._jsonService.postForm(h,{body:u,basicAuth:d,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return o.debug("got response"),f}async exchangeRefreshToken({grant_type:s="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:n,extraHeaders:i,...o}){const u=this._logger.create("exchangeRefreshToken");e||u.throw(new Error("A client_id is required")),o.refresh_token||u.throw(new Error("A refresh_token is required"));const d=new URLSearchParams({grant_type:s});for(const[g,S]of Object.entries(o))Array.isArray(S)?S.forEach(_=>d.append(g,_)):S!=null&&d.set(g,S);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&t==null)throw u.throw(new Error("A client_secret is required")),null;let h;const f=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":h=gn.generateBasicAuth(e,t);break;case"client_secret_post":d.append("client_id",e),t&&d.append("client_secret",t);break;case"client_secret_jwt":{const g=await gn.generateClientAssertionJwt(e,t,f,this._settings.token_endpoint_auth_signing_alg);d.append("client_id",e),d.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),d.append("client_assertion",g);break}}u.debug("got token endpoint");const m=await this._jsonService.postForm(f,{body:d,basicAuth:h,timeoutInSeconds:n,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return u.debug("got response"),m}async revoke(s){var e;const t=this._logger.create("revoke");s.token||t.throw(new Error("A token is required"));const n=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=s.token_type_hint)!=null?e:"default token type"}`);const i=new URLSearchParams;for(const[o,u]of Object.entries(s))u!=null&&i.set(o,u);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:i,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},kM=class{constructor(s,e,t){this._settings=s,this._metadataService=e,this._claimsService=t,this._logger=new Wt("ResponseValidator"),this._userInfoService=new DM(this._settings,this._metadataService),this._tokenClient=new X0(this._settings,this._metadataService)}async validateSigninResponse(s,e,t){const n=this._logger.create("validateSigninResponse");this._processSigninState(s,e),n.debug("state processed"),await this._processCode(s,e,t),n.debug("code processed"),s.isOpenId&&this._validateIdTokenAttributes(s),n.debug("tokens validated"),await this._processClaims(s,e?.skipUserInfo,s.isOpenId),n.debug("claims processed")}async validateCredentialsResponse(s,e){const t=this._logger.create("validateCredentialsResponse"),n=s.isOpenId&&!!s.id_token;n&&this._validateIdTokenAttributes(s),t.debug("tokens validated"),await this._processClaims(s,e,n),t.debug("claims processed")}async validateRefreshResponse(s,e){var t,n;const i=this._logger.create("validateRefreshResponse");s.userState=e.data,(t=s.session_state)!=null||(s.session_state=e.session_state),(n=s.scope)!=null||(s.scope=e.scope),s.isOpenId&&s.id_token&&(this._validateIdTokenAttributes(s,e.id_token),i.debug("ID Token validated")),s.id_token||(s.id_token=e.id_token,s.profile=e.profile);const o=s.isOpenId&&!!s.id_token;await this._processClaims(s,!1,o),i.debug("claims processed")}validateSignoutResponse(s,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==s.state&&t.throw(new Error("State does not match")),t.debug("state validated"),s.userState=e.data,s.error)throw t.warn("Response was error",s.error),new to(s)}_processSigninState(s,e){var t;const n=this._logger.create("_processSigninState");if(e.id!==s.state&&n.throw(new Error("State does not match")),e.client_id||n.throw(new Error("No client_id on state")),e.authority||n.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&n.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&n.throw(new Error("client_id mismatch on settings vs. signin state")),n.debug("state validated"),s.userState=e.data,s.url_state=e.url_state,(t=s.scope)!=null||(s.scope=e.scope),s.error)throw n.warn("Response was error",s.error),new to(s);e.code_verifier&&!s.code&&n.throw(new Error("Expected code in response"))}async _processClaims(s,e=!1,t=!0){const n=this._logger.create("_processClaims");if(s.profile=this._claimsService.filterProtocolClaims(s.profile),e||!this._settings.loadUserInfo||!s.access_token){n.debug("not loading user info");return}n.debug("loading user info");const i=await this._userInfoService.getClaims(s.access_token);n.debug("user info claims received from user info endpoint"),t&&i.sub!==s.profile.sub&&n.throw(new Error("subject from UserInfo response does not match subject in ID Token")),s.profile=this._claimsService.mergeClaims(s.profile,this._claimsService.filterProtocolClaims(i)),n.debug("user info claims received, updated profile:",s.profile)}async _processCode(s,e,t){const n=this._logger.create("_processCode");if(s.code){n.debug("Validating code");const i=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:s.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(s,i)}else n.debug("No code to process")}_validateIdTokenAttributes(s,e){var t;const n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");const i=Ql.decode((t=s.id_token)!=null?t:"");if(i.sub||n.throw(new Error("ID Token is missing a subject claim")),e){const o=Ql.decode(e);i.sub!==o.sub&&n.throw(new Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==o.auth_time&&n.throw(new Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==o.azp&&n.throw(new Error("azp in id_token does not match original azp")),!i.azp&&o.azp&&n.throw(new Error("azp not in id_token, but present in original id_token"))}s.profile=i}},ad=class rm{constructor(e){this.id=e.id||gn.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=id.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new Wt("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return Wt.createStatic("State","fromStorageString"),Promise.resolve(new rm(JSON.parse(e)))}static async clearStaleState(e,t){const n=Wt.createStatic("State","clearStaleState"),i=id.getEpochTime()-t,o=await e.getAllKeys();n.debug("got keys",o);for(let u=0;u<o.length;u++){const d=o[u],h=await e.get(d);let f=!1;if(h)try{const m=await rm.fromStorageString(h);n.debug("got item from key:",d,m.created),m.created<=i&&(f=!0)}catch(m){n.error("Error parsing state for key:",d,m),f=!0}else n.debug("no item in storage for key:",d),f=!0;f&&(n.debug("removed item for key:",d),e.remove(d))}}},qm=class im extends ad{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?gn.generateCodeVerifier():e.code_verifier||void 0,n=t?await gn.generateCodeChallenge(t):void 0;return new im({...e,code_verifier:t,code_challenge:n})}toStorageString(){return new Wt("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){Wt.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return im.create(t)}},Q0=class Z0{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:n,redirect_uri:i,response_type:o,scope:u,state_data:d,response_mode:h,request_type:f,client_secret:m,nonce:g,url_state:S,resource:_,skipUserInfo:b,extraQueryParams:T,extraTokenParams:k,disablePKCE:A,dpopJkt:C,omitScopeWhenRequesting:U,...O}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!o)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!u)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const M=await qm.create({data:d,request_type:f,url_state:S,code_verifier:!A,client_id:n,authority:t,redirect_uri:i,response_mode:h,client_secret:m,scope:u,extraTokenParams:k,skipUserInfo:b}),E=new URL(e);E.searchParams.append("client_id",n),E.searchParams.append("redirect_uri",i),E.searchParams.append("response_type",o),U||E.searchParams.append("scope",u),g&&E.searchParams.append("nonce",g),C&&E.searchParams.append("dpop_jkt",C);let I=M.id;S&&(I=`${I}${eo}${S}`),E.searchParams.append("state",I),M.code_challenge&&(E.searchParams.append("code_challenge",M.code_challenge),E.searchParams.append("code_challenge_method","S256")),_&&(Array.isArray(_)?_:[_]).forEach(q=>E.searchParams.append("resource",q));for(const[w,q]of Object.entries({response_mode:h,...O,...T}))q!=null&&E.searchParams.append(w,q.toString());return new Z0({url:E.href,state:M})}};Q0._logger=new Wt("SigninRequest");var UM=Q0,PM="openid",Hc=class{constructor(s){if(this.access_token="",this.token_type="",this.profile={},this.state=s.get("state"),this.session_state=s.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(eo);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(eo))}this.error=s.get("error"),this.error_description=s.get("error_description"),this.error_uri=s.get("error_uri"),this.code=s.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-id.getEpochTime()}set expires_in(s){typeof s=="string"&&(s=Number(s)),s!==void 0&&s>=0&&(this.expires_at=Math.floor(s)+id.getEpochTime())}get isOpenId(){var s;return((s=this.scope)==null?void 0:s.split(" ").includes(PM))||!!this.id_token}},NM=class{constructor({url:s,state_data:e,id_token_hint:t,post_logout_redirect_uri:n,extraQueryParams:i,request_type:o,client_id:u,url_state:d}){if(this._logger=new Wt("SignoutRequest"),!s)throw this._logger.error("ctor: No url passed"),new Error("url");const h=new URL(s);if(t&&h.searchParams.append("id_token_hint",t),u&&h.searchParams.append("client_id",u),n&&(h.searchParams.append("post_logout_redirect_uri",n),e||d)){this.state=new ad({data:e,request_type:o,url_state:d});let f=this.state.id;d&&(f=`${f}${eo}${d}`),h.searchParams.append("state",f)}for(const[f,m]of Object.entries({...i}))m!=null&&h.searchParams.append(f,m.toString());this.url=h.href}},LM=class{constructor(s){if(this.state=s.get("state"),this.state){const e=decodeURIComponent(this.state).split(eo);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(eo))}this.error=s.get("error"),this.error_description=s.get("error_description"),this.error_uri=s.get("error_uri")}},xM=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],jM=["sub","iss","aud","exp","iat"],BM=class{constructor(s){this._settings=s,this._logger=new Wt("ClaimsService")}filterProtocolClaims(s){const e={...s};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=xM;for(const n of t)jM.includes(n)||delete e[n]}return e}mergeClaims(s,e){const t={...s};for(const[n,i]of Object.entries(e))if(t[n]!==i)if(Array.isArray(t[n])||Array.isArray(i))if(this._settings.mergeClaimsStrategy.array=="replace")t[n]=i;else{const o=Array.isArray(t[n])?t[n]:[t[n]];for(const u of Array.isArray(i)?i:[i])o.includes(u)||o.push(u);t[n]=o}else typeof t[n]=="object"&&typeof i=="object"?t[n]=this.mergeClaims(t[n],i):t[n]=i;return t}},FM=class{constructor(s,e){this.keys=s,this.nonce=e}},Km=class{constructor(s,e){this._logger=new Wt("OidcClient"),this.settings=s instanceof nm?s:new nm(s),this.metadataService=e??new J0(this.settings),this._claimsService=new BM(this.settings),this._validator=new kM(this.settings,this.metadataService,this._claimsService),this._tokenClient=new X0(this.settings,this.metadataService)}async createSigninRequest({state:s,request:e,request_uri:t,request_type:n,id_token_hint:i,login_hint:o,skipUserInfo:u,nonce:d,url_state:h,response_type:f=this.settings.response_type,scope:m=this.settings.scope,redirect_uri:g=this.settings.redirect_uri,prompt:S=this.settings.prompt,display:_=this.settings.display,max_age:b=this.settings.max_age,ui_locales:T=this.settings.ui_locales,acr_values:k=this.settings.acr_values,resource:A=this.settings.resource,response_mode:C=this.settings.response_mode,extraQueryParams:U=this.settings.extraQueryParams,extraTokenParams:O=this.settings.extraTokenParams,dpopJkt:M,omitScopeWhenRequesting:E=this.settings.omitScopeWhenRequesting}){const I=this._logger.create("createSigninRequest");if(f!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const w=await this.metadataService.getAuthorizationEndpoint();I.debug("Received authorization endpoint",w);const q=await UM.create({url:w,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:g,response_type:f,scope:m,state_data:s,url_state:h,prompt:S,display:_,max_age:b,ui_locales:T,id_token_hint:i,login_hint:o,acr_values:k,dpopJkt:M,resource:A,request:e,request_uri:t,extraQueryParams:U,extraTokenParams:O,request_type:n,response_mode:C,client_secret:this.settings.client_secret,skipUserInfo:u,nonce:d,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:E});await this.clearStaleState();const z=q.state;return await this.settings.stateStore.set(z.id,z.toStorageString()),q}async readSigninResponseState(s,e=!1){const t=this._logger.create("readSigninResponseState"),n=new Hc(LE.readParams(s,this.settings.response_mode));if(!n.state)throw t.throw(new Error("No state in response")),null;const i=await this.settings.stateStore[e?"remove":"get"](n.state);if(!i)throw t.throw(new Error("No matching state found in storage")),null;return{state:await qm.fromStorageString(i),response:n}}async processSigninResponse(s,e,t=!0){const n=this._logger.create("processSigninResponse"),{state:i,response:o}=await this.readSigninResponseState(s,t);if(n.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const u=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:u}}try{await this._validator.validateSigninResponse(o,i,e)}catch(u){if(u instanceof tm&&this.settings.dpop){const d=await this.getDpopProof(this.settings.dpop.store,u.nonce);e.DPoP=d,await this._validator.validateSigninResponse(o,i,e)}else throw u}return o}async getDpopProof(s,e){let t,n;return(await s.getAllKeys()).includes(this.settings.client_id)?(n=await s.get(this.settings.client_id),n.nonce!==e&&e&&(n.nonce=e,await s.set(this.settings.client_id,n))):(t=await gn.generateDPoPKeys(),n=new FM(t,e),await s.set(this.settings.client_id,n)),await gn.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:n.keys,nonce:n.nonce})}async processResourceOwnerPasswordCredentials({username:s,password:e,skipUserInfo:t=!1,extraTokenParams:n={}}){const i=await this._tokenClient.exchangeCredentials({username:s,password:e,...n}),o=new Hc(new URLSearchParams);return Object.assign(o,i),await this._validator.validateCredentialsResponse(o,t),o}async useRefreshToken({state:s,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:i,extraTokenParams:o}){var u;const d=this._logger.create("useRefreshToken");let h;if(this.settings.refreshTokenAllowedScope===void 0)h=s.scope;else{const g=this.settings.refreshTokenAllowedScope.split(" ");h=(((u=s.scope)==null?void 0:u.split(" "))||[]).filter(_=>g.includes(_)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const g=await this.getDpopProof(this.settings.dpop.store);i={...i,DPoP:g}}let f;try{f=await this._tokenClient.exchangeRefreshToken({refresh_token:s.refresh_token,scope:h,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:i,...o})}catch(g){if(g instanceof tm&&this.settings.dpop)i.DPoP=await this.getDpopProof(this.settings.dpop.store,g.nonce),f=await this._tokenClient.exchangeRefreshToken({refresh_token:s.refresh_token,scope:h,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:i,...o});else throw g}const m=new Hc(new URLSearchParams);return Object.assign(m,f),d.debug("validating response",m),await this._validator.validateRefreshResponse(m,{...s,scope:h}),m}async createSignoutRequest({state:s,id_token_hint:e,client_id:t,request_type:n,url_state:i,post_logout_redirect_uri:o=this.settings.post_logout_redirect_uri,extraQueryParams:u=this.settings.extraQueryParams}={}){const d=this._logger.create("createSignoutRequest"),h=await this.metadataService.getEndSessionEndpoint();if(!h)throw d.throw(new Error("No end session endpoint")),null;d.debug("Received end session endpoint",h),!t&&o&&!e&&(t=this.settings.client_id);const f=new NM({url:h,id_token_hint:e,client_id:t,post_logout_redirect_uri:o,state_data:s,extraQueryParams:u,request_type:n,url_state:i});await this.clearStaleState();const m=f.state;return m&&(d.debug("Signout request has state to persist"),await this.settings.stateStore.set(m.id,m.toStorageString())),f}async readSignoutResponseState(s,e=!1){const t=this._logger.create("readSignoutResponseState"),n=new LM(LE.readParams(s,this.settings.response_mode));if(!n.state){if(t.debug("No state in response"),n.error)throw t.warn("Response was error:",n.error),new to(n);return{state:void 0,response:n}}const i=await this.settings.stateStore[e?"remove":"get"](n.state);if(!i)throw t.throw(new Error("No matching state found in storage")),null;return{state:await ad.fromStorageString(i),response:n}}async processSignoutResponse(s){const e=this._logger.create("processSignoutResponse"),{state:t,response:n}=await this.readSignoutResponseState(s,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,t)):e.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),ad.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(s,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:s,token_type_hint:e})}},En=(function(s){return s.NotSupported="OIDC authentication not supported",s.Misconfigured="OIDC is misconfigured",s.General="Something went wrong with OIDC discovery",s.OpSupport="Configured OIDC OP does not support required functions",s.DynamicRegistrationNotSupported="Dynamic registration not supported",s.DynamicRegistrationFailed="Dynamic registration failed",s.DynamicRegistrationInvalid="Dynamic registration invalid response",s.CodeExchangeFailed="Failed to exchange code for token",s.InvalidBearerTokenResponse="Invalid bearer token response",s.InvalidIdToken="Invalid ID token",s.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",s})({}),Hm=s=>!!s&&typeof s=="object"&&!Array.isArray(s),vi=(s,e)=>!s[e]||!Bl(s,e)?(N.error("Missing or invalid property: ".concat(e)),!1):!0,Bl=(s,e)=>s[e]&&typeof s[e]!="string"?(N.error("Invalid property: ".concat(e)),!1):!0,xE=(s,e)=>s[e]&&(!Array.isArray(s[e])||!s[e].every(t=>typeof t=="string"))?(N.error("Invalid property: ".concat(e)),!1):!0,ov=(s,e,t)=>{var n=s[e];return!n||!Array.isArray(n)||!n.includes(t)?(N.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},$0=s=>{if(!Hm(s))throw N.error("Issuer configuration not found or malformed"),new Error(En.OpSupport);var e=[vi(s,"issuer"),vi(s,"authorization_endpoint"),vi(s,"token_endpoint"),vi(s,"revocation_endpoint"),Bl(s,"registration_endpoint"),Bl(s,"account_management_uri"),Bl(s,"device_authorization_endpoint"),xE(s,"account_management_actions_supported"),ov(s,"response_types_supported","code"),ov(s,"grant_types_supported","authorization_code"),ov(s,"code_challenge_methods_supported","S256"),xE(s,"prompt_values_supported")].some(t=>!t);if(!e)return s;throw N.error("Issuer configuration not valid"),new Error(En.OpSupport)},eT=s=>{try{return W0(s)}catch(e){throw N.error("Could not decode id_token",e),e}},tT=(s,e,t,n)=>{try{if(!s)throw new Error("No ID token");var i=eT(s);if(i.iss!==e)throw new Error("Invalid issuer");var o=typeof i.aud=="string"?[i.aud]:i.aud;if(!o.includes(t))throw new Error("Invalid audience");if(n!==void 0&&i.nonce!==n)throw new Error("Invalid nonce");if(!i.exp||Date.now()>i.exp*1e3)throw new Error("Invalid expiry")}catch(u){throw N.error("Invalid ID token",u),new Error(En.InvalidIdToken)}};function nT(s){if(!Hm(s))throw N.error("Stored user state not found"),new Error(En.MissingOrInvalidStoredState);var e=[vi(s,"homeserverUrl"),vi(s,"nonce"),Bl(s,"identityServerUrl")].some(t=>!t);if(e)throw new Error(En.MissingOrInvalidStoredState)}var qM=s=>Hm(s)&&vi(s,"token_type")&&s.token_type.toLowerCase()==="bearer"&&vi(s,"access_token")&&vi(s,"refresh_token")&&(!("expires_in"in s)||typeof s.expires_in=="number");function rT(s){if(!qM(s))throw new Error(En.InvalidBearerTokenResponse)}function jE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function sd(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):jE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var Sd=s=>{var e=s??Zi(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},KM=(function(){var s=D(function*(e){if(!globalThis.crypto.subtle)return N.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield Lm(e);return vd(t)});return function(t){return s.apply(this,arguments)}})(),HM=s=>{var{redirectUri:e}=s;return{scope:Sd(),redirectUri:e,state:Zi(8),nonce:Zi(8),codeVerifier:Zi(64)}},VM=(function(){var s=D(function*(e,t,n){var{scope:i,redirectUri:o,state:u,nonce:d,codeVerifier:h}=n,f=new URL(e);return f.searchParams.append("response_mode","query"),f.searchParams.append("response_type","code"),f.searchParams.append("redirect_uri",o),f.searchParams.append("client_id",t),f.searchParams.append("state",u),f.searchParams.append("scope",i),f.searchParams.append("nonce",d),f.searchParams.append("code_challenge_method","S256"),f.searchParams.append("code_challenge",yield KM(h)),f.toString()});return function(t,n,i){return s.apply(this,arguments)}})(),GM=(function(){var s=D(function*(e){var{metadata:t,redirectUri:n,clientId:i,homeserverUrl:o,identityServerUrl:u,nonce:d,prompt:h,urlState:f,loginHint:m}=e,g=Sd(),S=new Km(sd(sd({},t),{},{client_id:i,redirect_uri:n,authority:t.issuer,response_mode:"query",response_type:"code",scope:g,stateStore:new yd({prefix:"mx_oidc_",store:window.sessionStorage})})),_={homeserverUrl:o,nonce:d,identityServerUrl:u},b=yield S.createSigninRequest({state:_,nonce:d,prompt:h,url_state:f,login_hint:m});return b.url});return function(t){return s.apply(this,arguments)}})(),zM=s=>({id_token:s.id_token,scope:s.scope,expires_at:s.expires_at,refresh_token:s.refresh_token,access_token:s.access_token,token_type:"Bearer"}),WM=(function(){var s=D(function*(e,t){var n=new URL(window.location.origin);n.searchParams.append("code",e),n.searchParams.append("state",t),Xl.setLogger(N);try{var i=new Hc(n.searchParams),o=new yd({prefix:"mx_oidc_",store:window.sessionStorage}),u=yield o.get(i.state);if(!u)throw new Error(En.MissingOrInvalidStoredState);var d=yield qm.fromStorageString(u),h=new Km(sd(sd({},d),{},{stateStore:o})),f=yield h.processSigninResponse(n.href),m=f.userState;nT(m),rT(f),tT(f.id_token,h.settings.authority,h.settings.client_id,m.nonce);var g=zM(f);return{oidcClientSettings:{clientId:h.settings.client_id,issuer:h.settings.authority},tokenResponse:g,homeserverUrl:m.homeserverUrl,identityServerUrl:m.identityServerUrl,idTokenClaims:f.profile}}catch(_){N.error("Oidc login failed",_);var S=_.message;throw Object.values(En).includes(S)?_:new Error(En.CodeExchangeFailed)}});return function(t,n){return s.apply(this,arguments)}})();function BE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function FE(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?BE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):BE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var Vm=(function(){var s=D(function*(e){var t=new URL(".well-known/openid-configuration",e),n=yield fetch(t,{method:se.Get,signal:fd(5e3)}),i=yield n.json();return Gm(i)});return function(t){return s.apply(this,arguments)}})(),Gm=(function(){var s=D(function*(e){var t=$0(e),n=new nm({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),i=new J0(n);return FE(FE({},t),{},{signingKeys:yield i.getSigningKeys()})});return function(t){return s.apply(this,arguments)}})(),YM="urn:ietf:params:oauth:grant-type:device_code",lv=(s,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==s.protocol||t.hostname!==s.hostname&&!t.hostname.endsWith(".".concat(s.hostname)))},JM=(function(){var s=D(function*(e,t){if(!e.registration_endpoint)throw new Error(En.DynamicRegistrationNotSupported);var n=["authorization_code","refresh_token"];if(n.some(m=>!e.grant_types_supported.includes(m)))throw new Error(En.DynamicRegistrationNotSupported);var i=new URL(t.clientUri),o={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:n,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:lv(i,t.logoUri)?t.logoUri:void 0,policy_uri:lv(i,t.policyUri)?t.policyUri:void 0,tos_uri:lv(i,t.tosUri)?t.tosUri:void 0},u={Accept:"application/json","Content-Type":"application/json"};try{var d=yield fetch(e.registration_endpoint,{method:se.Post,headers:u,body:JSON.stringify(o)});if(d.status>=400)throw new Error(En.DynamicRegistrationFailed);var h=yield d.json(),f=h.client_id;if(!f||typeof f!="string")throw new Error(En.DynamicRegistrationInvalid);return f}catch(m){throw Object.values(En).includes(m.message)?m:(N.error("Dynamic registration request failed",m),new Error(En.DynamicRegistrationFailed))}});return function(t,n){return s.apply(this,arguments)}})();class XM{constructor(e,t,n,i,o){this.issuer=e,this.clientId=t,this.redirectUri=n,this.deviceId=i,this.idTokenClaims=o,y(this,"oidcClientReady",void 0),y(this,"initPromise",void 0),y(this,"oidcClient",void 0),y(this,"inflightRefreshRequest",void 0),this.oidcClientReady=Promise.resolve()}ensureInit(){var e=this;return D(function*(){if(!e.oidcClient){if(e.initPromise)return e.initPromise;e.initPromise=e.initialiseOidcClient(e.issuer,e.clientId,e.deviceId,e.redirectUri);try{yield e.initPromise}finally{e.initPromise=void 0}}})()}initialiseOidcClient(e,t,n,i){var o=this;return D(function*(){try{var u,d=yield Vm(e),h=Sd(n);o.oidcClient=new Km({metadata:d,signingKeys:(u=d.signingKeys)!==null&&u!==void 0?u:void 0,client_id:t,scope:h,redirect_uri:i,authority:d.issuer,stateStore:new yd({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(f){throw N.error("Failed to initialise OIDC client.",f),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return D(function*(){yield t.ensureInit(),t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var n=yield t.inflightRefreshRequest;return n}catch(i){throw i instanceof to?new Rm(i):i}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return D(function*(){})()}getNewTokens(e){var t=this;return D(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var n={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},i=Date.now(),o=yield t.oidcClient.useRefreshToken({state:n,timeoutInSeconds:300}),u={accessToken:o.access_token,refreshToken:o.refresh_token,expiry:o.expires_in?new Date(i+o.expires_in*1e3):void 0};return yield t.persistTokens(u),u})()}}var QM=["server","limit","since"];function qE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Pt(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?qE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):qE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var ZM=3e3,KE=600*1e3,$M=new Yt("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),no=(function(s){return s.Chronological="chronological",s.Detached="detached",s})({}),eA=new io("m.get_login_token","org.matrix.msc3882.get_login_token"),iT="uk.half-shot.msc2666",aT="uk.half-shot.msc2666.mutual_rooms",sT="uk.half-shot.msc2666.query_mutual_rooms",pn="org.matrix.msc4140",am="org.matrix.msc4354",oT="uk.tcpip.msc4133",lT="uk.tcpip.msc4133.stable",Dr="$",Ue=(function(s){return s.Sync="sync",s.Event="event",s.ToDeviceEvent="toDeviceEvent",s.ReceivedToDeviceMessage="receivedToDeviceMessage",s.AccountData="accountData",s.Room="Room",s.DeleteRoom="deleteRoom",s.SyncUnexpectedError="sync.unexpectedError",s.ClientWellKnown="WellKnown.client",s.ReceivedVoipEvent="received_voip_event",s.TurnServers="turnServers",s.TurnServersError="turnServers.error",s})({}),tA=new Yt("action","org.matrix.msc3824.action");class bd extends Lt{constructor(e){var t,n,i,o,u,d;super(),i=this,y(this,"logger",void 0),y(this,"reEmitter",new lo(this)),y(this,"olmVersion",null),y(this,"usingExternalCrypto",!1),y(this,"_store",void 0),y(this,"deviceId",void 0),y(this,"credentials",void 0),y(this,"legacyPickleKey",void 0),y(this,"scheduler",void 0),y(this,"clientRunning",!1),y(this,"timelineSupport",!1),y(this,"urlPreviewCache",{}),y(this,"identityServer",void 0),y(this,"http",void 0),y(this,"cryptoBackend",void 0),y(this,"enableEncryptedStateEvents",void 0),y(this,"cryptoCallbacks",void 0),y(this,"callEventHandler",void 0),y(this,"groupCallEventHandler",void 0),y(this,"supportsCallTransfer",!1),y(this,"forceTURN",!1),y(this,"iceCandidatePoolSize",0),y(this,"idBaseUrl",void 0),y(this,"baseUrl",void 0),y(this,"isVoipWithNoMediaAllowed",void 0),y(this,"disableVoip",void 0),y(this,"useLivekitForGroupCalls",void 0),y(this,"canSupportVoip",!1),y(this,"peekSync",null),y(this,"isGuestAccount",!1),y(this,"ongoingScrollbacks",{}),y(this,"notifTimelineSet",null),y(this,"legacyCryptoStore",void 0),y(this,"verificationMethods",void 0),y(this,"fallbackICEServerAllowed",!1),y(this,"syncApi",void 0),y(this,"roomNameGenerator",void 0),y(this,"pushRules",void 0),y(this,"syncLeftRoomsPromise",void 0),y(this,"syncedLeftRooms",!1),y(this,"clientOpts",void 0),y(this,"clientWellKnownIntervalID",void 0),y(this,"canResetTimelineCallback",void 0),y(this,"canSupport",new Map),y(this,"pushProcessor",new _r(this)),y(this,"serverVersionsPromise",void 0),y(this,"clientWellKnown",void 0),y(this,"clientWellKnownPromise",void 0),y(this,"turnServers",[]),y(this,"turnServersExpiry",0),y(this,"checkTurnServersIntervalID",void 0),y(this,"txnCtr",0),y(this,"mediaHandler",new xO(this)),y(this,"sessionId",void 0),y(this,"eventsBeingEncrypted",new Set),y(this,"useE2eForGroupCall",!0),y(this,"toDeviceMessageQueue",void 0),y(this,"livekitServiceURL",void 0),y(this,"_secretStorage",void 0),y(this,"ignoredInvites",void 0),y(this,"matrixRTC",void 0),y(this,"serverCapabilitiesService",void 0),y(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(Fv()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(Ue.Sync,this.startCallEventHandler))}),y(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(Ue.Sync,this.startMatrixRTC))}),y(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var f,m=((f=this.getRooms())!==null&&f!==void 0?f:[]).filter(_=>_.getUnreadNotificationCount(ht.Total)>0);for(var g of m){var S=this.getSafeUserId();g.fixupNotifications(S)}this.off(Ue.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:N,e.baseUrl=Gh(e.baseUrl),e.idBaseUrl=Gh(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(n=e.usingExternalCrypto)!==null&&n!==void 0?n:!1,this.store=e.store||new xI,this.deviceId=e.deviceId||null,this.sessionId=Zi(10);var h=e.userId||null;this.credentials={userId:h},this.http=new I0(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:Vt.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((function(){var f=D(function*(m){var g=i.getRoom(m.getRoomId());m.status!==He.SENDING&&i.updatePendingEventStatus(g,m,He.SENDING);var S=yield i.sendEventHttpRequest(m);return g&&g.updatePendingEvent(m,He.SENT,S.event_id),S});return function(m){return f.apply(this,arguments)}})()),this.disableVoip=(o=e.disableVoip)!==null&&o!==void 0?o:!1,!this.disableVoip&&Fv()&&(this.callEventHandler=new iO(this),this.groupCallEventHandler=new aO(this),this.canSupportVoip=!0,this.on(Ue.Sync,this.startCallEventHandler)),this.matrixRTC=new SM(this.logger,this),this.serverCapabilitiesService=new M0(this.logger,this.http),this.on(Ue.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.enableEncryptedStateEvents=(u=e.enableEncryptedStateEvents)!==null&&u!==void 0?u:!1,this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new GO(this,this.logger),this.on(mt.Decrypted,f=>{uT(this,f)}),this.ignoredInvites=new zO(this),this._secretStorage=new G0(this,(d=e.cryptoCallbacks)!==null&&d!==void 0?d:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>pi.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return D(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(Ue.Sync,t.startMatrixRTC);var n=t.getUserId();n&&t.store.storeUser(new pi(n)),t.supportsVoip()&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},KE),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:i,list:o,fwdPagination:u}=yield t.doesServerSupportThread();At.setServerSideSupport(i),At.setServerSideListSupport(o),At.setServerSideFwdPaginationSupport(u)}catch(d){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",d)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new q0(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new Xi(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(d=>t.logger.info("Sync startup aborted with an error:",d)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1,logger:this.logger.getChild("sync")}}stopClient(){var e,t,n,i,o;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(Ue.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(n=this.peekSync)===null||n===void 0||n.stopPeeking(),(i=this.callEventHandler)===null||i===void 0||i.stop(),(o=this.groupCallEventHandler)===null||o===void 0||o.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var n=[];n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData());var i=(function(){var o=D(function*(){var u;try{if(u=globalThis.indexedDB,!u)return}catch{return}var d=function*(S){var _=new Promise((b,T)=>{e.logger.info("Removing IndexedDB instance ".concat(S));var k=u.deleteDatabase(S);k.onsuccess=A=>{e.logger.info("Removed IndexedDB instance ".concat(S)),b(0)},k.onerror=A=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(S,":"),A),b(0)},k.onblocked=A=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(S))}});yield _};for(var h of["".concat((f=t.cryptoDatabasePrefix)!==null&&f!==void 0?f:iv,"::matrix-sdk-crypto"),"".concat((m=t.cryptoDatabasePrefix)!==null&&m!==void 0?m:iv,"::matrix-sdk-crypto-meta")]){var f,m;yield*d(h)}});return function(){return o.apply(this,arguments)}})();return n.push(i()),Promise.all(n).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return!this.disableVoip&&this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return zl(this,e)}createGroupCall(e,t,n,i,o,u){var d=this;return D(function*(){if(d.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var h=d.getRoom(e);if(!h)throw new Error("Cannot find room ".concat(e));return new Am(d,h,t,n,i,void 0,o||d.isVoipWithNoMediaAllowed,u,d.isVoipWithNoMediaAllowed,d.useLivekitForGroupCalls,d.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===gt.Prepared||e===gt.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return D(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return D(function*(){var n,i,o=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var u=t.getUserId();if(u===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var d=t.getDeviceId();if(d===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var h=yield qC(()=>import("./index-DY1Z60m6.js"),[]),f=yield h.initRustCrypto({logger:t.logger,http:t.http,userId:u,deviceId:d,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:o.useIndexedDB===!1?null:(n=o.cryptoDatabasePrefix)!==null&&n!==void 0?n:iv,storeKey:o.storageKey,storePassphrase:o.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(i=t.legacyPickleKey)!==null&&i!==void 0?i:"DEFAULT_KEY",legacyMigrationProgressListener:(m,g)=>{t.emit(on.LegacyCryptoStoreMigrationProgress,m,g)},enableEncryptedStateEvents:t.enableEncryptedStateEvents});f.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=f,t.on(Un.Membership,f.onRoomMembership.bind(f)),t.on(Ue.Event,m=>{f.onLiveEventFromSync(m)}),t.reEmitter.reEmit(f,[on.VerificationRequestReceived,on.UserTrustStatusChanged,on.KeyBackupStatus,on.KeyBackupSessionsRemaining,on.KeyBackupFailed,on.KeyBackupDecryptionKeyCached,on.KeysChanged,on.DevicesUpdated,on.WillUpdateDevices,on.DehydratedDeviceCreated,on.DehydratedDeviceUploaded,on.RehydrationStarted,on.RehydrationProgress,on.RehydrationCompleted,on.RehydrationError,on.DehydrationKeyCached,on.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,n){var i;t!==void 0?i=Ce("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?i=Ce("/room_keys/keys/$roomId",{$roomId:e}):i="/room_keys/keys";var o=n===void 0?void 0:{version:n};return{path:i,queryData:o}}deleteKeysFromBackup(e,t,n){var i=this;return D(function*(){var o=i.makeKeyBackupPath(e,t,n);yield i.http.authedRequest(se.Delete,o.path,o.queryData,void 0,{prefix:Vt.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest(se.Get,t,void 0,void 0,{prefix:e?Vt.V1:Vs.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),n=new Set(t);for(var i of n){var o=this.findPredecessorRooms(i,!0,e);for(var u of o)n.delete(u)}return Array.from(n)}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var n=this;return D(function*(){if(!n.clientRunning)return n.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield Dv(5,()=>n.setAccountDataRaw(e,t));var i=n.store.getAccountData(e);if(i&&qa(i.event.content,t))return{};var o=Promise.withResolvers();function u(h){h.getType()===e&&o.resolve()}n.addListener(Ue.AccountData,u);try{var d=yield Dv(5,()=>n.setAccountDataRaw(e,t));return yield o.promise,d}finally{n.removeListener(Ue.AccountData,u)}})()}setAccountDataRaw(e,t){var n=Ce("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(se.Put,n,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return D(function*(){if(t.isInitialSyncComplete()){var n=t.store.getAccountData(e);return n?n.getContent():null}var i=Ce("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(se.Get,i)}catch(u){var o;if(((o=u.data)===null||o===void 0?void 0:o.errcode)==="M_NOT_FOUND")return null;throw u}})()}deleteAccountData(e){var t=this;return D(function*(){var n=t.canSupport.get(rn.AccountDataDeletion);if(n===nn.Unsupported){yield t.setAccountData(e,{});return}var i=Ce("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),o=n===nn.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(se.Delete,i,void 0,void 0,o)})()}getIgnoredUsers(){var e=this.getAccountData(Z.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(n=>{t.ignored_users[n]={}}),this.setAccountData(Z.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,n=this;return D(function*(){var i,o,u=t.length>1&&t[1]!==void 0?t[1]:{},d=n.getRoom(e),h=d?.getMember(n.getSafeUserId()),f=h?.membership,m=f==Ye.Invite&&(i=h==null||(o=h.events.member)===null||o===void 0?void 0:o.getSender())!==null&&i!==void 0?i:null;if(n.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(f,", inviter=").concat(m,", opts=").concat(JSON.stringify(u))),f==Ye.Join)return d;var g=Promise.resolve();if(u.inviteSignUrl){var S=new URL(u.inviteSignUrl);S.searchParams.set("mxid",n.credentials.userId),g=n.http.requestOtherUrl(se.Post,S)}var _={};u.viaServers&&(_.via=_.server_name=u.viaServers.slice(0,3));var b={},T=yield g;T&&(b.third_party_signed=T);var k=Ce("/join/$roomid",{$roomid:e}),A=yield n.http.authedRequest(se.Post,k,_,b),C=A.room_id;if(u.acceptSharedHistory&&m&&n.cryptoBackend){var U=yield n.cryptoBackend.maybeAcceptKeyBundle(C,m);U||n.cryptoBackend.markRoomAsPendingKeyBundle(C,m)}var O=n.getRoom(C);if(O!=null&&O.hasMembershipState(n.credentials.userId,Ye.Join))return O;var M=new Xi(n,n.clientOpts,n.buildSyncApiOptions());return M.createRoom(C)})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=this.getRoom(e);if(n!=null&&n.hasMembershipState(this.credentials.userId,Ye.Knock))return Promise.resolve({room_id:n.roomId});var i=Ce("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),o={};if(t.viaServers){var u=Array.isArray(t.viaServers)?t.viaServers.slice(0,3):[t.viaServers];o.server_name=u,o.via=u}var d={};return t.reason&&(d.reason=t.reason),this.http.authedRequest(se.Post,i,o,d)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,He.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![He.QUEUED,He.NOT_SENT,He.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===He.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===He.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,He.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,Z.RoomName,{name:t})}setRoomTopic(e,t,n){var i=h0(t,n);return this.sendStateEvent(e,Z.RoomTopic,i)}getRoomTags(e){var t=Ce("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(se.Get,t)}setRoomTag(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=Ce("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(se.Put,i,void 0,n)}deleteRoomTag(e,t){var n=Ce("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(se.Delete,n)}setRoomAccountData(e,t,n){var i=Ce("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(se.Put,i,void 0,n)}setPowerLevel(e,t,n){var i=this;return D(function*(){var o,u;if(i.clientRunning&&i.isInitialSyncComplete()){var d;u=(d=i.getRoom(e))===null||d===void 0||(d=d.currentState)===null||d===void 0||(d=d.getStateEvents(Z.RoomPowerLevels,""))===null||d===void 0?void 0:d.getContent()}if(!u)try{u=yield i.getStateEvent(e,Z.RoomPowerLevels,"")}catch(m){if(m instanceof Dt&&m.errcode==="M_NOT_FOUND")u={};else throw m}u=ru(u),(o=u)!==null&&o!==void 0&&o.users||(u.users={});var h=Array.isArray(t)?t:[t];for(var f of h)n==null?delete u.users[f]:u.users[f]=n;return i.sendStateEvent(e,Z.RoomPowerLevels,u,"")})()}unstable_createLiveBeacon(e,t){var n=this;return D(function*(){return n.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var n=this;return D(function*(){return n.sendStateEvent(e,Nm.name,t,n.getUserId())})()}sendEvent(e,t,n,i,o){var u,d,h,f;return!(t!=null&&t.startsWith(Dr))&&t!==null?(f=i,h=n,d=t,u=null):(f=o,h=i,d=n,u=t),this.addThreadRelationIfNeeded(h,u,e),this.sendCompleteEvent({roomId:e,threadId:u,eventObject:{type:d,content:h},txnId:f})}addThreadRelationIfNeeded(e,t,n){var i;if(t&&!((i=e["m.relates_to"])!==null&&i!==void 0&&i.rel_type)){var o,u,d=!!((o=e["m.relates_to"])!==null&&o!==void 0&&o["m.in_reply_to"]);e["m.relates_to"]=Pt(Pt({},e["m.relates_to"]),{},{rel_type:wt.name,event_id:t,is_falling_back:!d});var h=(u=this.getRoom(n))===null||u===void 0?void 0:u.getThread(t);if(h&&!d){var f,m;e["m.relates_to"]["m.in_reply_to"]={event_id:(f=(m=h.lastReply(g=>g.isRelation(wt.name)&&!g.status))===null||m===void 0?void 0:m.getId())!==null&&f!==void 0?f:t}}}}sendCompleteEvent(e){var{roomId:t,threadId:n,eventObject:i,delayOpts:o,queryDict:u,txnId:d}=e;d||(d=this.makeTxnId());var h=new yn(Object.assign(i,{event_id:"~"+t+":"+d,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:t,origin_server_ts:new Date().getTime()})),f=this.getRoom(t),m=n?f?.getThread(n):void 0;m&&h.setThread(m),o||(this.reEmitter.reEmit(h,[mt.Replaced,mt.VisibilityChange]),f?.reEmitter.reEmit(h,[mt.BeforeRedaction]));var g=h.getAssociatedId();if(g!=null&&g.startsWith("~")){var S=f?.getPendingEvents().find(b=>b.getId()===g);S?.once(mt.LocalEventIdReplaced,()=>{h.updateAssociatedId(S.getId())})}var _=h.getType();return this.logger.debug("sendEvent of type ".concat(_," in ").concat(t," with txnId ").concat(d).concat(o?" (delayed event)":"").concat(u?" query params: "+JSON.stringify(u):"")),h.setTxnId(d),h.setStatus(He.SENDING),o?this.encryptAndSendEvent(f,h,o,u):(f?.addPendingEvent(h,d),h.status===He.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(f,h,u))}encryptAndSendEvent(e,t,n,i){var o=this;return D(function*(){var u=i;if(n&&Kv(n))return o.sendEventHttpRequest(t,n,u);u||(u=n);try{var d;o.eventsBeingEncrypted.add(t.getId());try{yield o.encryptEventIfNeeded(t,e??void 0)}finally{d=!o.eventsBeingEncrypted.delete(t.getId())}if(d)return{};t.status===He.ENCRYPTING&&o.updatePendingEventStatus(e,t,He.SENDING);var h=null;return o.scheduler&&(h=o.scheduler.queueEvent(t),h&&o.scheduler.getQueueForEvent(t).length>1&&o.updatePendingEventStatus(e,t,He.QUEUED)),h||(h=o.sendEventHttpRequest(t,u),e&&(h=h.then(f=>(e.updatePendingEvent(t,He.SENT,f.event_id),f)))),yield h}catch(f){o.logger.error("Error sending event",f);try{t.error=f,o.updatePendingEventStatus(e,t,He.NOT_SENT)}catch(m){o.logger.error("Exception in error handler!",m)}throw f instanceof Dt&&(f.event=t),f}})()}encryptEventIfNeeded(e,t){var n=this;return D(function*(){if(t&&(yield n.shouldEncryptEventForRoom(e,t))&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");n.updatePendingEventStatus(t,e,He.ENCRYPTING),yield n.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var n=this;return D(function*(){var i;return e.isEncrypted()||e.getType()===Z.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(i=n.cryptoBackend)===null||i===void 0?void 0:i.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var n;return t===Z.Reaction?t:(n=this.getRoom(e))!==null&&n!==void 0&&n.hasEncryptionStateEvent()?Z.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e,t,n){var i=e.getTxnId();i||(i=this.makeTxnId(),e.setTxnId(i));var o={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:i},u;if(e.isState()){var d="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(d="/rooms/$roomId/state/$eventType/$stateKey"),u=Ce(d,o)}else if(e.isRedaction()&&e.event.redacts){var h="/rooms/$roomId/redact/$redactsEventId/$txnId";u=Ce(h,Pt({$redactsEventId:e.event.redacts},o))}else u=Ce("/rooms/$roomId/send/$eventType/$txnId",o);var f=t&&Kv(t)?t:void 0,m=f?n:t,g=e.getWireContent();return f?this.http.authedRequest(se.Put,u,Pt(Pt({},HE(f)),m),g):this.http.authedRequest(se.Put,u,m,g).then(S=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(S.event_id)),S))}redactEvent(e,t,n,i,o){var u,d,h;(u=n)!==null&&u!==void 0&&u.startsWith(Dr)||(o=i,i=n,n=t,t=null);var f=(d=o)===null||d===void 0?void 0:d.reason,m={reason:f};if(((h=o)===null||h===void 0?void 0:h.with_rel_types)!==void 0){if(this.canSupport.get(rn.RelationBasedRedactions)===nn.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(n," txnId: ").concat(i," threadId ").concat(t));var g=this.canSupport.get(rn.RelationBasedRedactions)===nn.Stable?wv.stable:wv.unstable;m[g]=o.with_rel_types}return this.sendCompleteEvent({roomId:e,threadId:t,eventObject:{type:Z.RoomRedaction,content:m,redacts:n},txnId:i})}sendMessage(e,t,n,i){typeof t!="string"&&t!==null&&(i=n,n=t,t=null);var o=Z.RoomMessage,u=n;return this.sendEvent(e,t,o,u,i)}sendTextMessage(e,t,n,i){var o;!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(i=n,n=t,t=null);var u=l0(n);return this.sendMessage(e,t,u,i)}sendNotice(e,t,n,i){var o;!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(i=n,n=t,t=null);var u=u0(n);return this.sendMessage(e,t,u,i)}sendEmoteMessage(e,t,n,i){var o;!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(i=n,n=t,t=null);var u=c0(n);return this.sendMessage(e,t,u,i)}sendImageMessage(e,t,n,i){var o,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(u=i||"Image",i=n,n=t,t=null);var d={msgtype:jr.Image,url:n,info:i,body:u};return this.sendMessage(e,t,d)}sendStickerMessage(e,t,n,i){var o,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(u=i||"Sticker",i=n,n=t,t=null);var d={url:n,info:i,body:u};return this.sendEvent(e,t,Z.Sticker,d)}sendHtmlMessage(e,t,n,i){var o;!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(i=n,n=t,t=null);var u=a0(n,i);return this.sendMessage(e,t,u)}sendHtmlNotice(e,t,n,i){var o;!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(i=n,n=t,t=null);var u=s0(n,i);return this.sendMessage(e,t,u)}sendHtmlEmote(e,t,n,i){var o;!((o=t)!==null&&o!==void 0&&o.startsWith(Dr))&&t!==null&&(i=n,n=t,t=null);var u=o0(n,i);return this.sendMessage(e,t,u)}_unstable_sendDelayedEvent(e,t,n,i,o,u){var d=this;return D(function*(){if(!(yield d.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","sendDelayedEvent");return d.addThreadRelationIfNeeded(o,n,e),d.sendCompleteEvent({roomId:e,threadId:n,eventObject:{type:i,content:o},delayOpts:t,txnId:u})})()}_unstable_sendStickyDelayedEvent(e,t,n,i,o,u,d){var h=this;return D(function*(){if(!(yield h.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","getDelayedEvents");if(!(yield h.doesServerSupportUnstableFeature(am)))throw new Qv("Server does not support the sticky events","sendStickyEvent");return h.addThreadRelationIfNeeded(u,i,e),h.sendCompleteEvent({roomId:e,threadId:i,eventObject:{type:o,content:u},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},delayOpts:n,txnId:d})})()}_unstable_sendDelayedStateEvent(e,t,n,i){var o=arguments,u=this;return D(function*(){var d=o.length>4&&o[4]!==void 0?o[4]:"",h=o.length>5&&o[5]!==void 0?o[5]:{};if(!(yield u.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","sendDelayedStateEvent");var f={$roomId:e,$eventType:n,$stateKey:d},m=Ce("/rooms/$roomId/state/$eventType",f);return d!==void 0&&(m=Ce(m+"/$stateKey",f)),u.http.authedRequest(se.Put,m,HE(t),i,h)})()}_unstable_sendStickyEvent(e,t,n,i,o,u){var d=this;return D(function*(){if(!(yield d.doesServerSupportUnstableFeature(am)))throw new Qv("Server does not support the sticky events","sendStickyEvent");return d.addThreadRelationIfNeeded(o,n,e),d.sendCompleteEvent({roomId:e,threadId:n,eventObject:{type:i,content:o},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},txnId:u})})()}_unstable_getDelayedEvents(e,t,n){var i=this;return D(function*(){if(!(yield i.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","getDelayedEvents");var o={from:n,status:e,delay_id:t};return yield i.http.authedRequest(se.Get,"/delayed_events",o,void 0,{prefix:"".concat(Vt.Unstable,"/").concat(pn)})})()}_unstable_updateDelayedEvent(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield i.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","updateDelayedEvent");return yield i.updateScheduledDelayedEventWithActionInBody(e,t,o)})()}_unstable_cancelScheduledDelayedEvent(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};return yield n.updateScheduledDelayedEvent(e,Fa.Cancel,i)})()}_unstable_restartScheduledDelayedEvent(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};return yield n.updateScheduledDelayedEvent(e,Fa.Restart,i)})()}_unstable_sendScheduledDelayedEvent(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};return yield n.updateScheduledDelayedEvent(e,Fa.Send,i)})()}updateScheduledDelayedEvent(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield i.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","".concat(t,"ScheduledDelayedEvent"));try{var u=Ce("/delayed_events/$delayId/$action",{$delayId:e,$action:t});return yield i.http.request(se.Post,u,void 0,void 0,Pt(Pt({},o),{},{prefix:"".concat(Vt.Unstable,"/").concat(pn)}))}catch(d){if(d instanceof Dt&&d.errcode==="M_UNRECOGNIZED")return yield i.updateScheduledDelayedEventWithActionInBody(e,t,o);throw d}})()}updateScheduledDelayedEventWithActionInBody(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:{},u=Ce("/delayed_events/$delayId",{$delayId:e}),d={action:t};try{return yield i.http.request(se.Post,u,void 0,d,Pt(Pt({},o),{},{prefix:"".concat(Vt.Unstable,"/").concat(pn)}))}catch(h){if(h instanceof Dt&&h.errcode==="M_MISSING_TOKEN")return yield i.http.authedRequest(se.Post,u,void 0,d,Pt(Pt({},o),{},{prefix:"".concat(Vt.Unstable,"/").concat(pn)}));throw h}})()}sendReceipt(e,t,n){var i=arguments,o=this;return D(function*(){var u=i.length>3&&i[3]!==void 0?i[3]:!1;if(o.isGuest())return Promise.resolve({});var d=Ce("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),h=!u&&o.supportsThreads(),f=h?Pt(Pt({},n),{},{thread_id:ro(e)}):n,m=o.http.authedRequest(se.Post,d,void 0,f||{}),g=o.getRoom(e.getRoomId());return g&&o.credentials.userId&&g.addLocalEchoReceipt(o.credentials.userId,e,t,u),m})()}sendReadReceipt(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:Tn.Read,o=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var u=e.getId(),d=n.getRoom(e.getRoomId());if(d!=null&&d.hasPendingEvent(u))throw new Error("Cannot set read receipt to a pending event (".concat(u,")"));return n.sendReceipt(e,i,{},o)}})()}setRoomReadMarkers(e,t,n,i){var o=this;return D(function*(){var u=o.getRoom(e);if(u!=null&&u.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var d;if(n){if(d=n.getId(),u!=null&&u.hasPendingEvent(d))throw new Error("Cannot set read receipt to a pending event (".concat(d,")"));u?.addLocalEchoReceipt(o.credentials.userId,n,Tn.Read)}var h;if(i){if(h=i.getId(),u!=null&&u.hasPendingEvent(h))throw new Error("Cannot set read receipt to a pending event (".concat(h,")"));u?.addLocalEchoReceipt(o.credentials.userId,i,Tn.ReadPrivate)}return yield o.setRoomReadMarkersHttpRequest(e,t,d,h)})()}sendRtcDecline(e,t){return this.sendEvent(e,Z.RTCDecline,{"m.relates_to":{event_id:t,rel_type:Mt.Reference}})}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var n=new URL(e);n.hash="",e=n.toString();var i=t+"_"+e;if(i in this.urlPreviewCache)return this.urlPreviewCache[i];var o=this.http.authedRequest(se.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:Vs.V3,priority:"low"});return this.urlPreviewCache[i]=o,o}sendTyping(e,t,n){if(this.isGuest())return Promise.resolve({});var i=Ce("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),o={typing:t};return t&&(o.timeout=n||2e4),this.http.authedRequest(se.Put,i,void 0,o)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getRoom(e);if(!i)return[];var o=this.findPredecessorRooms(i,t,n),u=this.findSuccessorRooms(i,t,n);return[...o,i,...u]}findPredecessorRooms(e,t,n){for(var i,o=[],u=new Set([e.roomId]),d=(i=e.findPredecessor(n))===null||i===void 0?void 0:i.roomId;d!==null;){var h;if(d){if(u.has(d))break;u.add(d)}var f=this.getRoom(d);if(f===null)break;if(t){var m=f.currentState.getStateEvents(Z.RoomTombstone,"");if(!m||m.getContent().replacement_room!==e.roomId)break}o.splice(0,0,f),e=f,d=(h=e.findPredecessor(n))===null||h===void 0?void 0:h.roomId}return o}findSuccessorRooms(e,t,n){for(var i=[],o=e.currentState.getStateEvents(Z.RoomTombstone,"");o;){var u=this.getRoom(o.getContent().replacement_room);if(!u||u.roomId===e.roomId)break;if(t){var d,h=(d=u.findPredecessor(n))===null||d===void 0?void 0:d.roomId;if(!h||h!==e.roomId)break}i.push(u);var f=new Set(i.map(m=>m.roomId));if(f.size<i.length)return i.slice(0,i.length-1);e=u,o=e.currentState.getStateEvents(Z.RoomTombstone,"")}return i}invite(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:{};if(typeof o!="object"&&(o={reason:o}),o.shareEncryptedHistory){var u;yield(u=i.cryptoBackend)===null||u===void 0?void 0:u.shareRoomHistoryWithUser(e,t)}return yield i.membershipChange(e,t,Ye.Invite,o.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,n){var i=this;return D(function*(){var o,u=Ce("/rooms/$roomId/invite",{$roomId:e}),d=i.getIdentityServerUrl(!0);if(!d)return Promise.reject(new Dt({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var h={id_server:d,medium:t,address:n};if((o=i.identityServer)!==null&&o!==void 0&&o.getAccessToken){var f=yield i.identityServer.getAccessToken();f&&(h.id_access_token=f)}return i.http.authedRequest(se.Post,u,void 0,h)})()}leave(e){return this.membershipChange(e,void 0,Ye.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=this.getRoomUpgradeHistory(e,!0),i=n;if(!t){i=[];for(var o of n)if(i.push(o),o.roomId===e)break}var u={},d=[],h=m=>this.leave(m).then(()=>{delete u[m]}).catch(g=>{u[m]=g});for(var f of i)d.push(h(f.roomId));return Promise.all(d).then(()=>u)}ban(e,t,n){return this.membershipChange(e,t,Ye.Ban,n)}forget(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,o=Ce("/rooms/$room_id/forget",{$room_id:e}),u=yield n.http.authedRequest(se.Post,o);return i&&(n.store.removeRoom(e),n.emit(Ue.DeleteRoom,e)),u})()}unban(e,t){var n=Ce("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(se.Post,n,void 0,i)}kick(e,t,n){var i=Ce("/rooms/$roomId/kick",{$roomId:e}),o={user_id:t,reason:n};return this.http.authedRequest(se.Post,i,void 0,o)}membershipChange(e,t,n,i){var o=Ce("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(se.Post,o,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushDetails()}setProfileInfo(e,t){var n=Ce("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(se.Put,n,void 0,t)}setDisplayName(e){var t=this;return D(function*(){var n=yield t.setProfileInfo("displayname",{displayname:e}),i=t.getUser(t.getUserId());return i&&(i.displayName=e,i.emit(Jn.DisplayName,i.events.presence,i)),n})()}setAvatarUrl(e){var t=this;return D(function*(){var n=yield t.setProfileInfo("avatar_url",{avatar_url:e}),i=t.getUser(t.getUserId());return i&&(i.avatarUrl=e,i.emit(Jn.AvatarUrl,i.events.presence,i)),n})()}mxcUrlToHttp(e,t,n,i,o,u,d){return ud(this.baseUrl,e,t,n,i,o,u,d)}setSyncPresence(e){var t=this;return D(function*(){var n;(n=t.syncApi)===null||n===void 0||n.setPresence(e)})()}setPresence(e){var t=this;return D(function*(){var n=Ce("/presence/$userId/status",{$userId:t.credentials.userId}),i=["offline","online","unavailable"];if(i.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(se.Put,n,void 0,e)})()}getPresence(e){var t=Ce("/presence/$userId/status",{$userId:e});return this.http.authedRequest(se.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){var o=Date.now()-i.errorTs;n=Math.max(ZM-o,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var u=this.store.scrollback(e,t).length;if(u===t)return Promise.resolve(e);t=t-u;var d=new Promise((h,f)=>{iu(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,Qe.Backward)).then(m=>{var g,S,_=m.chunk.map(this.getEventMapper());if(m.state){var b=m.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(b)}var[T,k,A]=e.partitionThreadedEvents(_);this.processAggregatedTimelineEvents(e,T),e.addEventsToTimeline(T,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,k,!0),A.forEach(C=>e.relations.aggregateChildEvent(C)),e.oldState.paginationToken=(g=m.end)!==null&&g!==void 0?g:null,m.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,_,(S=m.end)!==null&&S!==void 0?S:null,!0),delete this.ongoingScrollbacks[e.roomId],h(e)}).catch(m=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},f(m)})});return i={promise:d},this.ongoingScrollbacks[e.roomId]=i,d}getEventMapper(e){return NO(this,e||{})}getEventContext(e,t){var n=this;return D(function*(){var i,o=Ce("/rooms/$roomId/context/$eventId",{$roomId:e,$eventId:t}),u={limit:"0"};(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(u.filter=JSON.stringify(Qn.LAZY_LOADING_MESSAGES_FILTER));var d=yield n.http.authedRequest(se.Get,o,u);if(d.event){var h,f,m;return{start:d.start,end:d.end,event:d.event,events_after:(h=d.events_after)!==null&&h!==void 0?h:[],events_before:(f=d.events_before)!==null&&f!==void 0?f:[],state:(m=d.state)!==null&&m!==void 0?m:[]}}throw new Error("'event' not in '/context' result - homeserver too old?")})()}getEventTimeline(e,t){var n=this;return D(function*(){var i,o,u;if(!n.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&n.supportsThreads()){var d;return(d=yield n.getThreadTimeline(e,t))!==null&&d!==void 0?d:null}var h=yield n.getEventContext(e.room.roomId,t);if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var f=n.getEventMapper(),m=f(h.event);if(m.isRelation(wt.name))return n.logger.warn("Tried loading a regular timeline at the position of a thread event"),null;var g=[...h.events_after.reverse().map(f),m,...h.events_before.map(f)],S=e.getTimelineForEvent(g[0].getId());if(S)S.getState(Oe.BACKWARDS).setUnknownStateEvents(h.state.map(f));else{var _;S=e.addTimeline(),S.initialiseState(h.state.map(f)),S.getState(Oe.FORWARDS).paginationToken=(_=h.end)!==null&&_!==void 0?_:null}var[b,T,k]=e.room.partitionThreadedEvents(g);return e.addEventsToTimeline(b,!0,!1,S,h.start),n.processThreadEvents(e.room,T,!0),n.processAggregatedTimelineEvents(e.room,b),k.forEach(A=>e.relations.aggregateChildEvent(A)),(i=(o=e.getTimelineForEvent(t))!==null&&o!==void 0?o:(u=e.room.findThreadForEvent(m))===null||u===void 0?void 0:u.liveTimeline)!==null&&i!==void 0?i:S})()}getThreadTimeline(e,t){var n=this;return D(function*(){if(!n.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var i=yield n.getEventContext(e.room.roomId,t),o=n.getEventMapper(),u=o(i.event);if(e.canContain(u)){var d=n.canSupport.get(rn.RelationsRecursion)!==nn.Unsupported;if(At.hasServerSideSupport)if(At.hasServerSideFwdPaginationSupport){var h,f,m;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var g=e.thread,S=yield n.fetchRelations(e.room.roomId,g.id,null,null,{dir:Qe.Backward,from:i.start,recurse:d||void 0}),_=yield n.fetchRelations(e.room.roomId,g.id,null,null,{dir:Qe.Forward,from:i.end,recurse:d||void 0}),b=[..._.chunk.reverse().filter(sv(g.id)).map(o),u,...S.chunk.filter(sv(g.id)).map(o)];for(var T of b){var k;yield(k=e.thread)===null||k===void 0?void 0:k.processEvent(T)}var A=e.getTimelineForEvent(u.getId());if(A?A.getState(Oe.BACKWARDS).setUnknownStateEvents(i.state.map(o)):(A=e.addTimeline(),A.initialiseState(i.state.map(o))),e.addEventsToTimeline(b,!0,!1,A,_.next_batch),!S.next_batch){var C=yield n.fetchRoomEvent(e.room.roomId,g.id);e.addEventsToTimeline([o(C)],!0,!1,A,null)}return A.setPaginationToken((h=S.next_batch)!==null&&h!==void 0?h:null,Qe.Backward),A.setPaginationToken((f=_.next_batch)!==null&&f!==void 0?f:null,Qe.Forward),n.processAggregatedTimelineEvents(e.room,b),(m=e.getTimelineForEvent(t))!==null&&m!==void 0?m:A}else{for(var U,O=e.thread,M=yield n.fetchRelations(e.room.roomId,O.id,wt.name,null,{dir:Qe.Backward,from:i.start,recurse:d||void 0}),E=[],I=i.end;I;){var w=yield n.fetchRelations(e.room.roomId,O.id,wt.name,null,{dir:Qe.Forward,from:I,recurse:d||void 0});I=w.next_batch,E.push(...w.chunk)}var q=[...E.reverse().map(o),u,...M.chunk.map(o)];for(var z of q){var ue;yield(ue=e.thread)===null||ue===void 0?void 0:ue.processEvent(z)}var Se=e.getLiveTimeline();if(Se.getState(Oe.BACKWARDS).setUnknownStateEvents(i.state.map(o)),e.addEventsToTimeline(q,!0,!1,Se,null),!M.next_batch){var Ie=yield n.fetchRoomEvent(e.room.roomId,O.id);e.addEventsToTimeline([o(Ie)],!0,!1,Se,null)}return Se.setPaginationToken((U=M.next_batch)!==null&&U!==void 0?U:null,Qe.Backward),Se.setPaginationToken(null,Qe.Forward),n.processAggregatedTimelineEvents(e.room,q),Se}}})()}getLatestTimeline(e){var t=this;return D(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var n;if(e.threadListType!==null){var i,o=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,Qe.Backward,e.threadListType,e.getFilter());n=(i=o.chunk)===null||i===void 0?void 0:i[0]}else if(e.thread&&At.hasServerSideSupport){var u,d=t.canSupport.get(rn.RelationsRecursion)!==nn.Unsupported,h=yield t.fetchRelations(e.room.roomId,e.thread.id,wt.name,null,{dir:Qe.Backward,limit:1,recurse:d||void 0});n=(u=h.chunk)===null||u===void 0?void 0:u[0]}else{var f,m,g=Ce("/rooms/$roomId/messages",{$roomId:e.room.roomId}),S={dir:"b"};(f=t.clientOpts)!==null&&f!==void 0&&f.lazyLoadMembers&&(S.filter=JSON.stringify(Qn.LAZY_LOADING_MESSAGES_FILTER));var _=yield t.http.authedRequest(se.Get,g,S);n=(m=_.chunk)===null||m===void 0?void 0:m[0]}if(!n)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,n.event_id)})()}createMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,o=arguments.length>3?arguments[3]:void 0,u=arguments.length>4?arguments[4]:void 0,d=Ce("/rooms/$roomId/messages",{$roomId:e}),h={limit:i.toString(),dir:o};t&&(h.from=t);var f=null;if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(f=Object.assign({},Qn.LAZY_LOADING_MESSAGES_FILTER)),u){var m;f=f||{},Object.assign(f,(m=u.getRoomTimelineFilterComponent())===null||m===void 0?void 0:m.toJSON())}return f&&(h.filter=JSON.stringify(f)),this.http.authedRequest(se.Get,d,h)}createThreadListMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:Qe.Backward,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Er.All,d=arguments.length>5?arguments[5]:void 0,h=Ce("/rooms/$roomId/threads",{$roomId:e}),f={limit:i.toString(),dir:o,include:cT(u)};t&&(f.from=t);var m={};if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(m=Pt({},Qn.LAZY_LOADING_MESSAGES_FILTER)),d){var g;m=Pt(Pt({},m),(g=d.getRoomTimelineFilterComponent())===null||g===void 0?void 0:g.toJSON())}Object.keys(m).length&&(f.filter=JSON.stringify(m));var S={prefix:At.hasServerSideListSupport===bn.Stable?Vt.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(se.Get,h,f,void 0,S).then(_=>{var b;return Pt(Pt({},_),{},{chunk:(b=_.chunk)===null||b===void 0?void 0:b.reverse(),start:_.prev_batch,end:_.next_batch})})}paginateEventTimeline(e,t){var n=this,i=e.getTimelineSet()===this.notifTimelineSet,o=this.getRoom(e.getRoomId()),u=e.getTimelineSet().threadListType,d=e.getTimelineSet().thread;t=t||{};var h=t.backwards||!1;if(i&&!h)throw new Error("paginateNotifTimeline can only paginate backwards");var f=h?Oe.BACKWARDS:Oe.FORWARDS,m=e.getPaginationToken(f),g=e.paginationRequests[f];if(g)return g;var S,_,b;if(i){var T;S="/notifications",_={limit:((T=t.limit)!==null&&T!==void 0?T:30).toString(),only:"highlight"},m&&m!=="end"&&(_.from=m),b=this.http.authedRequest(se.Get,S,_).then((function(){var O=D(function*(M){var E=M.next_token,I=[];M.notifications=M.notifications.filter(Tr);for(var w=0;w<M.notifications.length;w++){var q=M.notifications[w],z=n.getEventMapper()(q.event);n.getPushDetailsForEvent(z,!0),z.event.room_id=q.room_id,I[w]=z}var ue=e.getTimelineSet();return ue.addEventsToTimeline(I,h,!1,e,E),n.processAggregatedTimelineEvents(ue.room,I),h&&!M.next_token&&e.setPaginationToken(null,f),!!M.next_token});return function(M){return O.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[f]=null}),e.paginationRequests[f]=b}else if(u!==null){if(!o)throw new Error("Unknown room "+e.getRoomId());if(!At.hasServerSideFwdPaginationSupport&&f===Qe.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");b=this.createThreadListMessagesRequest(e.getRoomId(),m,t.limit,f,u,e.getFilter()).then(O=>{if(O.state){var M=e.getState(f),E=O.state.filter(Tr).map(this.getEventMapper());M.setUnknownStateEvents(E)}var I=O.end,w=O.chunk.filter(Tr).map(this.getEventMapper()),q=e.getTimelineSet();return q.addEventsToTimeline(w,h,!1,e,I),this.processAggregatedTimelineEvents(o,w),this.processThreadRoots(o,w,h),h&&O.end==O.start&&e.setPaginationToken(null,f),O.end!==O.start}).finally(()=>{e.paginationRequests[f]=null}),e.paginationRequests[f]=b}else if(d){var k,A,C=this.getRoom((k=e.getRoomId())!==null&&k!==void 0?k:void 0);if(!C)throw new Error("Unknown room "+e.getRoomId());var U=this.canSupport.get(rn.RelationsRecursion)!==nn.Unsupported;b=this.fetchRelations((A=e.getRoomId())!==null&&A!==void 0?A:"",d.id,null,null,{dir:f,limit:t.limit,from:m??void 0,recurse:U||void 0}).then((function(){var O=D(function*(M){var E=n.getEventMapper(),I=M.chunk.filter(Tr).filter(sv(d.id)).map(E);for(var w of I.slice().reverse()){yield d?.processEvent(w);var q=w.getSender();(!h||d?.getEventReadUpTo(q)===null)&&C.addLocalEchoReceipt(q,w,Tn.Read)}var z=M.next_batch,ue=e.getTimelineSet();if(ue.addEventsToTimeline(I,h,!1,e,z??null),!z&&h){var Se,Ie,Ze=(Se=d.rootEvent)!==null&&Se!==void 0?Se:E(yield n.fetchRoomEvent((Ie=e.getRoomId())!==null&&Ie!==void 0?Ie:"",d.id));ue.addEventsToTimeline([Ze],!0,!1,e,null)}return n.processAggregatedTimelineEvents(ue.room,I),h&&!z&&e.setPaginationToken(null,f),!!z});return function(M){return O.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[f]=null}),e.paginationRequests[f]=b}else{if(!o)throw new Error("Unknown room "+e.getRoomId());b=this.createMessagesRequest(e.getRoomId(),m,t.limit,f,e.getFilter()).then(O=>{if(O.state){var M=e.getState(f),E=O.state.filter(Tr).map(this.getEventMapper());M.setUnknownStateEvents(E)}var I=O.end,w=O.chunk.filter(Tr).map(this.getEventMapper()),q=e.getTimelineSet(),[z,,ue]=o.partitionThreadedEvents(w);q.addEventsToTimeline(z,h,!1,e,I),this.processAggregatedTimelineEvents(o,z),this.processThreadRoots(o,z.filter(Ie=>Ie.getServerAggregatedRelation(wt.name)),!1),ue.forEach(Ie=>o.relations.aggregateChildEvent(Ie));var Se=O.end===void 0||O.end===O.start;return h&&Se&&e.setPaginationToken(null,f),!Se}).finally(()=>{e.paginationRequests[f]=null}),e.paginationRequests[f]=b}return b}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new Xi(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,n)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var n=this.sendStateEvent(e,Z.RoomGuestAccess,{guest_access:t.allowJoin?rd.CanJoin:rd.Forbidden},""),i=Promise.resolve();return t.allowRead&&(i=this.sendStateEvent(e,Z.RoomHistoryVisibility,{history_visibility:Pm.WorldReadable},"")),Promise.all([i,n]).then()}requestRegisterEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestRegisterMsisdnToken(e,t,n,i,o){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:o})}requestAdd3pidEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestAdd3pidMsisdnToken(e,t,n,i,o){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:o})}requestPasswordEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestPasswordMsisdnToken(e,t,n,i,o){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:o})}requestTokenFromEndpoint(e,t){var n=this;return D(function*(){var i=Object.assign({},t);return n.http.request(se.Post,e,void 0,i)})()}getRoomPushRule(e,t){if(this.pushRules){var n;return(n=this.pushRules[e])===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.find(i=>i.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,n){var i,o=!1,u=this.getRoomPushRule(e,t);if(u!=null&&u.actions.includes($i.DontNotify)&&(o=!0),!n)o&&(i=this.deletePushRule(e,un.RoomSpecific,u.rule_id));else if(!u)i=this.addPushRule(e,un.RoomSpecific,t,{actions:[$i.DontNotify]});else if(!o){var d=Promise.withResolvers();this.deletePushRule(e,un.RoomSpecific,u.rule_id).then(()=>{this.addPushRule(e,un.RoomSpecific,t,{actions:[$i.DontNotify]}).then(()=>{d.resolve()}).catch(h=>{d.reject(h)})}).catch(h=>{d.reject(h)}),i=d.promise}if(i)return new Promise((h,f)=>{i.then(()=>{this.getPushRules().then(m=>{this.pushRules=m,h()}).catch(m=>{f(m)})}).catch(m=>{this.getPushRules().then(g=>{this.pushRules=g,f(m)}).catch(g=>{f(m)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:F0.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(i=>this.processRoomEventsSearch(n,i))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},n=this.search(t,e.abortSignal).then(i=>this.processRoomEventsSearch(e,i)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,i,o=t.search_categories.room_events;e.count=o.count,e.next_batch=o.next_batch;var u=new Set(o.highlights);e.highlights.forEach(_=>{u.add(_)}),e.highlights=Array.from(u);for(var d=this.getEventMapper(),h=(n=(i=o.results)===null||i===void 0?void 0:i.length)!==null&&n!==void 0?n:0,f=0;f<h;f++){var m=pd.fromJson(o.results[f],d),g=this.getRoom(m.context.getEvent().getRoomId());if(g)for(var S of m.context.getTimeline())S.setMetadata(g.currentState,!1);e.results.push(m)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new Xi(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=Ce("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(se.Post,t,void 0,e).then(n=>{var i=Qn.fromJson(this.credentials.userId,n.filter_id,e);return this.store.storeFilter(i),i})}getFilter(e,t,n){if(n){var i=this.store.getFilter(e,t);if(i)return Promise.resolve(i)}var o=Ce("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(se.Get,o).then(u=>{var d=Qn.fromJson(e,t,u);return this.store.storeFilter(d),d})}getOrCreateFilter(e,t){var n=this;return D(function*(){var i=n.store.getFilterIdByName(e),o;if(i){try{var u=yield n.getFilter(n.credentials.userId,i,!0);if(u){var d=u.getDefinition(),h=t.getDefinition();qa(d,h)&&(o=i)}}catch(m){if(m.errcode!=="M_UNKNOWN"&&m.errcode!=="M_NOT_FOUND")throw m}o||n.store.setFilterIdByName(e,void 0)}if(o)return o;var f=yield n.createFilter(t.getDefinition());return n.store.setFilterIdByName(e,f.filterId),f.filterId})()}getOpenIdToken(){var e=Ce("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(se.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(se.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return D(function*(){if(e.supportsVoip()){var t=!1,n=e.turnServersExpiry-Date.now();if(n>KE)e.logger.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var i=yield e.turnServer();if(i.uris){e.logger.debug("Got TURN URIs: "+i.uris+" refresh in "+i.ttl+" secs");var o={urls:i.uris,username:i.username,credential:i.password};e.turnServers=[o],e.turnServersExpiry=Date.now()+i.ttl*1e3,t=!0,e.emit(Ue.TurnServers,e.turnServers)}}catch(u){e.logger.error("Failed to get TURN URIs",u),u.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(Ue.TurnServersError,u,!0)):e.emit(Ue.TurnServersError,u,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=Ce("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(se.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=Ce("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(se.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=Ce("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(se.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return D(function*(){var t;e.clientWellKnownPromise=We.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(Ue.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(n=>{var[i,o]=n;return e.includes(typeof o)}).reduce((n,i)=>{var[o,u]=i;return n[o]=u,n},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return D(function*(){var n=yield t.doesServerSupportUnstableFeature(iT),i=yield t.doesServerSupportUnstableFeature(aT),o=yield t.doesServerSupportUnstableFeature(sT);if(!n&&!i&&!o)throw Error("Server does not support the Mutual Rooms API");var u,d;o?(u="/uk.half-shot.msc2666/user/mutual_rooms",d={user_id:e}):(u=Ce("/uk.half-shot.msc2666/user/".concat(i?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),d={});var h=[],f=null;do{var m={};f!=null&&o&&(m.batch_token=f);var g=yield t.http.authedRequest(se.Get,u,Pt(Pt({},d),m),void 0,{prefix:Vt.Unstable});h.push(...g.joined),g.next_batch_token!==void 0?f=g.next_batch_token:f=null}while(f!=null);return h})()}_unstable_getRTCTransports(){var e=this;return D(function*(){return(yield e.http.authedRequest(se.Get,"/rtc/transports",void 0,void 0,{prefix:"".concat(Vt.Unstable,"/org.matrix.msc4143")})).rtc_transports})()}getVersions(){var e=this;return D(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(se.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(n=>{throw e.serverVersionsPromise=void 0,n});var t=yield e.serverVersionsPromise;return e.canSupport=yield PI(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return D(function*(){var{versions:n}=yield t.getVersions();return n&&n.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return D(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features;return i&&!!i[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return D(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features,o=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return i&&!!i["io.element.e2ee_forced.".concat(o)]})()}doesServerSupportThread(){var e=this;return D(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:bn.Stable,list:bn.Stable,fwdPagination:bn.Stable};try{var[t,n,i,o,u,d]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Vc(n,t),list:Vc(o,i),fwdPagination:Vc(d,u)}}catch{return{threads:bn.None,list:bn.None,fwdPagination:bn.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,n,i){var o=arguments,u=this;return D(function*(){var d,h,f=o.length>4&&o[4]!==void 0?o[4]:{dir:Qe.Backward},m=i?u.getEncryptedIfNeededEventType(e,i):null,[g,S]=yield Promise.all([u.fetchRoomEvent(e,t),u.fetchRelations(e,t,n,m,f)]),_=u.getEventMapper(),b=g?_(g):void 0,T=S.chunk.map(_);if(m===Z.RoomMessageEncrypted){var k=b?T.concat(b):T;yield Promise.all(k.map(A=>u.decryptEventIfNeeded(A))),i!==null&&(T=T.filter(A=>A.getType()===i))}return b&&n===Mt.Replace&&(T=T.filter(A=>A.getSender()===b.getSender())),{originalEvent:b??null,events:T,nextBatch:(d=S.next_batch)!==null&&d!==void 0?d:null,prevBatch:(h=S.prev_batch)!==null&&h!==void 0?h:null}})()}generateClientSecret(){return Zi(32)}decryptEventIfNeeded(e,t){return e.isState()&&!this.enableEncryptedStateEvents?Promise.resolve():(e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve())}termsUrlForService(e,t){switch(e){case qv.IS:return this.http.getUrl("/terms",void 0,oi.V2,t);case qv.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return n&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=Gh(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(se.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,n,i,o,u,d){n&&(i.session=n);var h={auth:i,refresh_token:!0};return e!=null&&(h.username=e),t!=null&&(h.password=t),u!=null&&(h.guest_access_token=u),d!=null&&(h.inhibit_login=d),this.registerRequest(h)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var n={};return t&&(n.kind=t),this.http.request(se.Post,"/register",n,e)}refreshToken(e){var t=n=>this.http.authedRequest(se.Post,"/refresh",void 0,{refresh_token:e},{prefix:n,inhibitLogoutEmit:!0});return t(Vt.V3).catch(n=>{if(n.errcode==="M_UNRECOGNIZED")return t(Vt.V1);throw n})}loginFlows(){return this.http.request(se.Get,"/login")}login(e,t){return this.loginRequest(Pt(Pt({},t),{},{type:e})).then(n=>(n.access_token&&n.user_id&&(this.http.opts.accessToken=n.access_token,this.credentials={userId:n.user_id}),n))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o="/login/"+t+"/redirect";n&&(o+="/"+n);var u={redirectUrl:e,[tA.unstable]:i};return this.http.getUrl(o,u).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return D(function*(){return yield t.http.authedRequest(se.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return D(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!1;return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(se.Post,"/logout")})()}deactivateAccount(e,t){var n={};return e&&(n.auth=e),t!==void 0&&(n.erase=t),this.http.authedRequest(se.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){var t=this;return D(function*(){var n={auth:e};return t.http.authedRequest(se.Post,"/login/get_token",void 0,n,{prefix:Vt.V1})})()}getFallbackAuthUrl(e,t){var n=Ce("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t}).href}createRoom(e){var t=this;return D(function*(){var n,i=(e.invite_3pid||[]).filter(d=>!d.id_access_token);if(i.length>0&&(n=t.identityServer)!==null&&n!==void 0&&n.getAccessToken){var o=yield t.identityServer.getAccessToken();if(o)for(var u of i)u.id_access_token=o}return t.http.authedRequest(se.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,n,i){var o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:Qe.Backward},u=o;At.hasServerSideFwdPaginationSupport===bn.Experimental&&(u=hb("dir","org.matrix.msc3715.dir",u)),this.canSupport.get(rn.RelationsRecursion)===nn.Unstable&&(u=hb("recurse","org.matrix.msc3981.recurse",u));var d=mv(u),h="/rooms/$roomId/relations/$eventId";n!==null?(h+="/$relationType",i!==null&&(h+="/$eventType")):i!==null&&(this.logger.warn("eventType: ".concat(i,` ignored when fetching
            relations as relationType is null`)),i=null);var f=Ce(h+"?"+d,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return this.http.authedRequest(se.Get,f,void 0,void 0,{prefix:Vt.V1})}roomState(e){var t=Ce("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(se.Get,t)}fetchRoomEvent(e,t){var n=Ce("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(se.Get,n)}members(e,t,n,i){var o={};t&&(o.membership=t),n&&(o.not_membership=n),i&&(o.at=i);var u=mv(o),d=Ce("/rooms/$roomId/members?"+u,{$roomId:e});return this.http.authedRequest(se.Get,d)}upgradeRoom(e,t){var n=Ce("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(se.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n){var i={$roomId:e,$eventType:t,$stateKey:n},o=Ce("/rooms/$roomId/state/$eventType",i);return n!==void 0&&(o=Ce(o+"/$stateKey",i)),this.http.authedRequest(se.Get,o)}sendStateEvent(e,t,n){var i=arguments,o=this;return D(function*(){var u=i.length>3&&i[3]!==void 0?i[3]:"",d=i.length>4&&i[4]!==void 0?i[4]:{},h=o.getRoom(e),f=new yn({room_id:e,type:t,state_key:u,content:n});yield o.encryptStateEventIfNeeded(f,h??void 0);var m={$roomId:e,$eventType:f.getWireType(),$stateKey:f.getWireStateKey()},g=Ce("/rooms/$roomId/state/$eventType",m);return u!==void 0&&(g=Ce(g+"/$stateKey",m)),o.http.authedRequest(se.Put,g,void 0,f.getWireContent(),d)})()}encryptStateEventIfNeeded(e,t){var n=this;return D(function*(){if(n.enableEncryptedStateEvents&&t&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");(yield n.shouldEncryptEventForRoom(e,t))&&(yield n.cryptoBackend.isStateEncryptionEnabledInRoom(t.roomId))&&(["m.room.create","m.room.member","m.room.join_rules","m.room.power_levels","m.room.third_party_invite","m.room.history_visibility","m.room.guest_access","m.room.encryption"].includes(e.getType())||(yield n.cryptoBackend.encryptEvent(e,t)))}})()}roomInitialSync(e,t){var n,i=Ce("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(se.Get,i,{limit:(n=t?.toString())!==null&&n!==void 0?n:"30"})}setRoomReadMarkersHttpRequest(e,t,n,i){var o=this;return D(function*(){var u=Ce("/rooms/$roomId/read_markers",{$roomId:e}),d={[Tn.FullyRead]:t,[Tn.Read]:n};return((yield o.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield o.isVersionSupported("v1.4")))&&(d[Tn.ReadPrivate]=i),o.http.authedRequest(se.Post,u,void 0,d)})()}getJoinedRooms(){var e=Ce("/joined_rooms",{});return this.http.authedRequest(se.Get,e)}getJoinedRoomMembers(e){var t=Ce("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(se.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:n,since:i}=e,o=HC(e,QM);if(Object.keys(o).length===0){var u={server:t,limit:n,since:i};return this.http.authedRequest(se.Get,"/publicRooms",u)}else{var d={server:t},h=Pt({limit:n,since:i},o);return this.http.authedRequest(se.Post,"/publicRooms",d,h)}}createAlias(e,t){var n=Ce("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(se.Put,n,void 0,i)}deleteAlias(e){var t=Ce("/directory/room/$alias",{$alias:e});return this.http.authedRequest(se.Delete,t)}getLocalAliases(e){var t=Ce("/rooms/$roomId/aliases",{$roomId:e}),n=Vt.V3;return this.http.authedRequest(se.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e){var t=Ce("/directory/room/$alias",{$alias:e});return this.http.authedRequest(se.Get,t)}getRoomDirectoryVisibility(e){var t=Ce("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(se.Get,t)}setRoomDirectoryVisibility(e,t){var n=Ce("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(se.Put,n,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:n}=e,i={search_term:t};return n!==void 0&&(i.limit=n),this.http.authedRequest(se.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var n=t?Ce("/profile/$userId/$info",{$userId:e,$info:t}):Ce("/profile/$userId",{$userId:e});return this.http.authedRequest(se.Get,n)}doesServerSupportExtendedProfiles(){var e=this;return D(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature(oT))||(yield e.doesServerSupportUnstableFeature(lT))})()}getExtendedProfileRequestPrefix(){var e=this;return D(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?Vt.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(se.Get,Ce("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var n=this;return D(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=yield n.http.authedRequest(se.Get,Ce("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield n.getExtendedProfileRequestPrefix()});return i[t]})()}setExtendedProfileProperty(e,t){var n=this;return D(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=n.getUserId();yield n.http.authedRequest(se.Put,Ce("/profile/$userId/$key",{$userId:i,$key:e}),void 0,{[e]:t},{prefix:yield n.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(se.Delete,Ce("/profile/$userId/$key",{$userId:n,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();return t.http.authedRequest(se.Patch,Ce("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(se.Put,Ce("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(se.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return D(function*(){var n="/account/3pid/add";return t.http.authedRequest(se.Post,n,void 0,e)})()}bindThreePid(e){var t=this;return D(function*(){var n="/account/3pid/bind";return t.http.authedRequest(se.Post,n,void 0,e)})()}unbindThreePid(e,t){var n=this;return D(function*(){var i="/account/3pid/unbind",o={medium:e,address:t,id_server:n.getIdentityServerUrl(!0)};return n.http.authedRequest(se.Post,i,void 0,o)})()}deleteThreePid(e,t){var n="/account/3pid/delete";return this.http.authedRequest(se.Post,n,void 0,{medium:e,address:t})}setPassword(e,t,n){var i="/account/password",o={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(se.Post,i,void 0,o)}getDevices(){return this.http.authedRequest(se.Get,"/devices")}getDevice(e){var t=Ce("/devices/$device_id",{$device_id:e});return this.http.authedRequest(se.Get,t)}setDeviceDetails(e,t){var n=Ce("/devices/$device_id",{$device_id:e});return this.http.authedRequest(se.Put,n,void 0,t)}deleteDevice(e,t){var n=Ce("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(se.Delete,n,void 0,i)}deleteMultipleDevices(e,t){var n={devices:e};t&&(n.auth=t);var i="/delete_devices";return this.http.authedRequest(se.Post,i,void 0,n)}getPushers(){var e=this;return D(function*(){var t=yield e.http.authedRequest(se.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(n=>(n.hasOwnProperty(Cv.name)||(n[Cv.name]=!0),n))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(se.Post,t,void 0,e)}removePusher(e,t){var n="/pushers/set",i={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(se.Post,n,void 0,i)}setLocalNotificationSettings(e,t){var n="".concat(G_.name,".").concat(e);return this.setAccountData(n,t)}getPushRules(){return this.http.authedRequest(se.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=_r.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,n,i){var o=Ce("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(se.Put,o,void 0,i)}deletePushRule(e,t,n){var i=Ce("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(se.Delete,i)}setPushRuleEnabled(e,t,n,i){var o=Ce("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(se.Put,o,void 0,{enabled:i})}setPushRuleActions(e,t,n,i){var o=Ce("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(se.Put,o,void 0,{actions:i})}search(e,t){var{body:n,next_batch:i}=e,o={};return i&&(o.next_batch=i),this.http.authedRequest(se.Post,"/search",o,n,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(se.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(se.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={device_keys:{}};return t!==void 0&&(n.token=t),e.forEach(i=>{n.device_keys[i]=[]}),this.http.authedRequest(se.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0,i={};t===void 0&&(t="signed_curve25519");for(var[o,u]of e){var d=i[o]||{};Xc(i,o,d),Xc(d,u,t)}var h={one_time_keys:i};n&&(h.timeout=n);var f="/keys/claim";return this.http.authedRequest(se.Post,f,void 0,h)}getKeyChanges(e,t){var n={from:e,to:t};return this.http.authedRequest(se.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){var n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(se.Post,"/keys/device_signing/upload",void 0,n,{prefix:Vt.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,oi.V2,this.idBaseUrl);return this.http.requestOtherUrl(se.Post,t,e)}requestEmailToken(e,t,n,i,o){var u={client_secret:t,email:e,send_attempt:n?.toString()};return i&&(u.next_link=i),this.http.idServerRequest(se.Post,"/validate/email/requestToken",u,oi.V2,o)}requestMsisdnToken(e,t,n,i,o,u){var d={client_secret:n,country:e,phone_number:t,send_attempt:i?.toString()};return o&&(d.next_link=o),this.http.idServerRequest(se.Post,"/validate/msisdn/requestToken",d,oi.V2,u)}submitMsisdnToken(e,t,n,i){var o={sid:e,client_secret:t,token:n};return this.http.idServerRequest(se.Post,"/validate/msisdn/submitToken",o,oi.V2,i??void 0)}submitMsisdnTokenOtherUrl(e,t,n,i){var o={sid:t,client_secret:n,token:i};return this.http.requestOtherUrl(se.Post,e,o)}getIdentityHashDetails(e){return this.http.idServerRequest(se.Get,"/hash_details",void 0,oi.V2,e)}identityHashedLookup(e,t){var n=this;return D(function*(){var i={},o=yield n.getIdentityHashDetails(t);if(!o||!o.lookup_pepper||!o.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=o.lookup_pepper;var u={};if(o.algorithms.includes("sha256"))i.addresses=yield Promise.all(e.map((function(){var S=D(function*(_){var b=_[0].toLowerCase(),T=_[1].toLowerCase(),k=yield Lm("".concat(b," ").concat(T," ").concat(i.pepper)),A=vd(k);return u[A]=_[0],A});return function(_){return S.apply(this,arguments)}})())),i.algorithm="sha256";else if(o.algorithms.includes("none"))i.addresses=e.map(S=>{var _=S[0].toLowerCase(),b=S[1].toLowerCase(),T="".concat(_," ").concat(b);return u[T]=S[0],T}),i.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var d=yield n.http.idServerRequest(se.Post,"/lookup",i,oi.V2,t);if(!(d!=null&&d.mappings))return[];var h=[];for(var f of Object.keys(d.mappings)){var m=d.mappings[f],g=u[f];if(!g)throw new Error("Identity server returned more results than expected");h.push({address:g,mxid:m})}return h})()}lookupThreePid(e,t,n){var i=this;return D(function*(){var o=yield i.identityHashedLookup([[t,e]],n),u=o.find(h=>h.address===t);if(!u)return{};var d={address:t,medium:e,mxid:u.mxid};return d})()}bulkLookupThreePids(e,t){var n=this;return D(function*(){var i=yield n.identityHashedLookup(e.map(h=>[h[1],h[0]]),t),o=[],u=function*(f){var m=e.find(g=>g[1]===f.address);if(!m)throw new Error("Identity sever returned unexpected results");o.push([m[0],f.address,f.mxid])};for(var d of i)yield*u(d);return{threepids:o}})()}getIdentityAccount(e){return this.http.idServerRequest(se.Get,"/account",void 0,oi.V2,e)}sendToDevice(e,t,n){var i=Ce("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),o={messages:Na(t)},u=new Map;for(var[d,h]of t)u.set(d,Array.from(h.keys()));return this.logger.debug("PUT ".concat(i),u),this.http.authedRequest(se.Put,i,void 0,o)}encryptAndSendToDevice(e,t,n){var i=this;return D(function*(){if(!i.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var o=yield i.cryptoBackend.encryptToDeviceMessages(e,t,n);yield i.queueToDevice(o)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(se.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var n=Ce("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(se.Get,n,t)}getThirdpartyUser(e,t){var n=Ce("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(se.Get,n,t)}getTerms(e,t){var n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(se.Get,n)}agreeToTerms(e,t,n,i){var o=this.termsUrlForService(e,t),u={Authorization:"Bearer "+n};return this.http.requestOtherUrl(se.Post,o,{user_accepts:i},{headers:u})}reportEvent(e,t,n,i){var o=Ce("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(se.Post,o,void 0,{score:n,reason:i})}reportRoom(e,t){var n=Ce("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(se.Post,n,void 0,{reason:t})}getRoomHierarchy(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,o=arguments.length>4?arguments[4]:void 0,u=Ce("/rooms/$roomId/hierarchy",{$roomId:e}),d={suggested_only:String(i),max_depth:n?.toString(),from:o,limit:t?.toString()};return this.http.authedRequest(se.Get,u,d,void 0,{prefix:Vt.V1}).catch(h=>{if(h.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(se.Get,u,d,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw h})}unstableCreateFileTree(e){var t=this;return D(function*(){var{room_id:n}=yield t.createRoom({name:e,preset:Um.PrivateChat,power_level_content_override:Pt(Pt({},LO),{},{users:{[t.getUserId()]:100}}),creation_content:{[Qc]:Hs.Space},initial_state:[{type:_v.name,state_key:Rv.name,content:{[Tv.name]:!0}},{type:Z.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new OE(t,n)})()}unstableGetFileTreeSpace(e){var t,n,i=this.getRoom(e);if(i?.getMyMembership()!==Ye.Join)return null;var o=i.currentState.getStateEvents(Z.RoomCreate,""),u=i.currentState.getStateEvents(_v.name,Rv.name);if(!o)throw new Error("Expected single room create event");return!(u!=null&&(t=u.getContent())!==null&&t!==void 0&&t[Tv.name])||((n=o.getContent())===null||n===void 0?void 0:n[Qc])!==Hs.Space?null:new OE(this,e)}slidingSync(e,t,n){var i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);var o=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(se.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:o,abortSignal:n})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(rn.IntentionalMentions)!==nn.Unsupported}getRoomSummary(e,t){var n=this;return D(function*(){var i={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var o=Ce("/summary/$roomid",{$roomid:e});return yield n.http.authedRequest(se.Get,o,{via:t},void 0,i)}catch(d){if(d instanceof Dt&&d.errcode==="M_UNRECOGNIZED"){var u=Ce("/rooms/$roomid/summary",{$roomid:e});return yield n.http.authedRequest(se.Get,u,{via:t},void 0,i)}else throw d}})()}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processThreadRoots(e,t,n){this.supportsThreads()&&e.processThreadRoots(t,n)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return D(function*(){return e.http.authedRequest(se.Get,"/account/whoami")})()}timestampToEvent(e,t,n){var i=this;return D(function*(){var o=Ce("/rooms/$roomId/timestamp_to_event",{$roomId:e}),u={ts:t.toString(),dir:n};try{return yield i.http.authedRequest(se.Get,o,u,void 0,{prefix:Vt.V1})}catch(d){if(d.errcode==="M_UNRECOGNIZED"&&(d.httpStatus===400||d.httpStatus===404||d.httpStatus===405))return yield i.http.authedRequest(se.Get,o,u,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw d}})()}getAuthMetadata(){var e=this;return D(function*(){var t;try{t=yield e.http.request(se.Get,"/auth_metadata",void 0,void 0,{prefix:Vt.Unstable+"/org.matrix.msc2965"})}catch(i){if(i instanceof Dt&&i.errcode==="M_UNRECOGNIZED"){var{issuer:n}=yield e.http.request(se.Get,"/auth_issuer",void 0,void 0,{prefix:Vt.Unstable+"/org.matrix.msc2965"});return Vm(n)}throw i}return Gm(t)})()}}y(bd,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function HE(s){return Object.fromEntries(Object.entries(s).map(e=>{var[t,n]=e;return["".concat(pn,".").concat(t),n]}))}function uT(s,e){var t,n=s.getUserId(),i=e.getId(),o=s.getRoom(e.getRoomId());if(!(!o||!n||!i)){if(!o.findEventById(i)){N.info("Decrypted event ".concat(e.getId()," is not in room ").concat(o.roomId,": ignoring"));return}var u=!!e.threadRootId&&!e.isThreadRoot,d;if(u){var h=o.getThread(e.threadRootId);d=h?h.hasUserReadEvent(n,i):!0}else d=o.hasUserReadEvent(n,i);if(!d){var f=s.getPushActionsForEvent(e,!0),m=!!(f!=null&&(t=f.tweaks)!==null&&t!==void 0&&t.highlight);if(m){var g=o.getUnreadCountForEventContext(ht.Highlight,e)+1;u?o.setThreadUnreadNotificationCount(e.threadRootId,ht.Highlight,g):o.setUnreadNotificationCount(ht.Highlight,g)}var S=!!(f!=null&&f.notify);if(S){var _=o.getUnreadCountForEventContext(ht.Total,e)+1;u?o.setThreadUnreadNotificationCount(e.threadRootId,ht.Total,_):o.setUnreadNotificationCount(ht.Total,_)}}}}function ro(s){return Zl(s)?nu:s.threadRootId}function Zl(s){if(!s.threadRootId||s.isThreadRoot)return!0;if(!s.isRelation())return N.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(s.getId())),!0;if(s.isRelation(wt.name))return!1;var e=s.relationEventId===s.threadRootId;return e}function VE(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function GE(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?VE(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):VE(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}var Rn=(function(s){return s.New="Thread.new",s.Update="Thread.update",s.NewReply="Thread.newReply",s.ViewThread="Thread.viewThread",s.Delete="Thread.delete",s})({}),bn=(function(s){return s[s.None=0]="None",s[s.Experimental=1]="Experimental",s[s.Stable=2]="Stable",s})({});function Vc(s,e){return s?bn.Stable:e?bn.Experimental:bn.None}class At extends g0{constructor(e,t,n){var i,o;if(super(),i=this,this.id=e,this.rootEvent=t,y(this,"timelineSet",void 0),y(this,"_currentUserParticipated",!1),y(this,"reEmitter",void 0),y(this,"lastEvent",void 0),y(this,"replyCount",0),y(this,"lastPendingEvent",void 0),y(this,"pendingReplyCount",0),y(this,"room",void 0),y(this,"client",void 0),y(this,"pendingEventOrdering",void 0),y(this,"processRootEventPromise",void 0),y(this,"initialEventsFetched",!At.hasServerSideSupport),y(this,"initalEventFetchProm",void 0),y(this,"replayEvents",[]),y(this,"onTimelineReset",D(function*(){yield i.processRootEventPromise,i.processRootEventPromise=void 0})),y(this,"onBeforeRedaction",(u,d)=>{u!=null&&u.isRelation(wt.name)&&this.room.eventShouldLiveIn(u).threadId===this.id&&u.getId()!==this.id&&!d.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Rn.Update,this))}),y(this,"onRedaction",(function(){var u=D(function*(d,h,f){if(f===i.id)if(i.replyCount<=0){for(var m of i.timeline)i.clearEventMetadata(m);i.lastEvent=i.rootEvent,i._currentUserParticipated=!1,i.emit(Rn.Delete,i)}else{var g;((g=i.lastEvent)===null||g===void 0?void 0:g.getId())===d.getAssociatedId()&&(yield i.processRootEventPromise,i.processRootEventPromise=void 0),yield i.updateThreadMetadata()}});return function(d,h,f){return u.apply(this,arguments)}})()),y(this,"onTimelineEvent",(u,d,h)=>{if(!h){var f=u.getSender();f&&d&&this.shouldSendLocalEchoReceipt(f,u)&&d.addLocalEchoReceipt(f,u,Tn.Read),u.getId()!==this.id&&u.isRelation(wt.name)&&this.replyCount++}this.onEcho(u,h??!1)}),y(this,"onLocalEcho",u=>{this.onEcho(u,!1)}),y(this,"onEcho",(function(){var u=D(function*(d,h){d.threadRootId===i.id&&i.lastEvent!==d&&(yield i.updateThreadMetadata(),d.isRelation(wt.name)&&(h||(i.lastEvent=void 0,i.emit(Rn.NewReply,i,d))))});return function(d,h){return u.apply(this,arguments)}})()),this.setMaxListeners(1e3),!(n!=null&&n.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=(o=n.pendingEventOrdering)!==null&&o!==void 0?o:no.Chronological,this.timelineSet=new qs(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new lo(this),this.reEmitter.reEmit(this.timelineSet,[ke.Timeline,ke.TimelineReset]),this.room.on(mt.BeforeRedaction,this.onBeforeRedaction),this.room.on(ke.Redaction,this.onRedaction),this.room.on(ke.LocalEchoUpdated,this.onLocalEcho),this.room.on(ke.TimelineReset,this.onTimelineReset),this.timelineSet.on(ke.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return D(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),n=e.client.getEventMapper();e.rootEvent=n(t)}catch(i){N.error("Failed to fetch thread root to construct thread with",i)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){At.hasServerSideSupport=e,e!==bn.Stable&&(Ws.setPreferUnstable(!0),Ys.setPreferUnstable(!0),wt.setPreferUnstable(!0))}static setServerSideListSupport(e){At.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){At.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var n,i=(n=this.client.canSupport.get(rn.RelationsRecursion))!==null&&n!==void 0?n:nn.Unsupported;if(i===nn.Unsupported){var o,u=(o=this.getReadReceiptForUserId(e))===null||o===void 0?void 0:o.eventId;if(u){var d=this.findEventById(u);if(d&&d.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(Oe.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(n=>this.addEvent(n,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var i=this.lastReply(),o=!i||e.localTimestamp>=i.localTimestamp;if(!At.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Mt.Annotation)||e.isRelation(Mt.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&o?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(wt.name)&&!t&&o&&(this.lastEvent=void 0),n&&(this.emit(Rn.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){if(this.initialEventsFetched){var o,u=(o=this.client.canSupport.get(rn.RelationsRecursion))!==null&&o!==void 0?o:nn.Unsupported;u===nn.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var n;if((n=this.replayEvents)===null||n===void 0||n.push(e),e.isRelation(Mt.Annotation)){var i;(i=this.timelineSet.relations)===null||i===void 0||i.aggregateChildEvent(e,this.timelineSet)}}}processEvent(e){var t=this;return D(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:n,userId:i,receipt:o,synthetic:u}of e)this.addReceiptToStructure(t,n,i,o,u)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e?.getServerAggregatedRelation(wt.name)}processRootEvent(){var e=this;return D(function*(){var t=e.getRootEventBundledRelationship();if(At.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var n=e.client.getEventMapper();e.lastEvent=n(GE(GE({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===no.Detached?this.room.getPendingEvents():this.events,t=e.filter(n=>{var i;return n.threadRootId===this.id&&n.isRelation(wt.name)&&n.status!==null&&n.getId()!==((i=this.lastEvent)===null||i===void 0?void 0:i.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var n=this;return D(function*(){var i=n.liveTimeline;n.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var o=n.liveTimeline,u,d;if(e){var h=yield n.client.createMessagesRequest(n.roomId,e,1,Qe.Forward);u=h.end}if(t){var f=yield n.client.createMessagesRequest(n.roomId,t,1,Qe.Backward);d=f.start}t&&i.getPaginationToken(Qe.Forward)===t&&i.setPaginationToken(d??null,Qe.Forward),e&&o.getPaginationToken(Qe.Backward)===e&&o.setPaginationToken(u??null,Qe.Backward)})()}updateThreadFromRootEvent(){var e=this;return D(function*(){At.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return D(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,Qe.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(ke.TimelineReset,e.room,e.timelineSet,!0)}catch(n){N.error("Failed to load start of newly created thread: ",n),e.initialEventsFetched=!1}e.emit(Rn.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return D(function*(){var n,i=(n=t.client.canSupport.get(rn.RelationsRecursion))!==null&&n!==void 0?n:nn.Unsupported;if(i===nn.Unsupported){for(var o=e.length,u=new Array(o),d=0;d<o;d++)u[d]=e[d];return Promise.all(u.filter(nA).map((function(){var h=D(function*(f){try{var m=yield t.client.relations(t.roomId,f.getId(),Mt.Replace,f.getType(),{limit:1});if(m.events.length){var g=m.events[0];f.makeReplaced(g),t.insertEventIntoTimeline(g)}}catch(S){N.error("Failed to load edits for encrypted thread event",S)}});return function(f){return h.apply(this,arguments)}})()))}})()}setEventMetadata(e){e&&(Oe.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[wt.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:i=>i.isRelation(wt.name),t=this.timeline.length-1;t>=0;t--){var n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof yn}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var n=e===this.client.getUserId(),i=this.timeline[this.timeline.length-1];if(n&&i){var o=i.getTs()<this.room.getOldestThreadedReceiptTs(),u=i.getId();if(o&&u)return u}var d=super.getEventReadUpTo(e,t);if(i){var h=this.room.getLastUnthreadedReceiptFor(e);if(!h)return d;for(var f=((m=this.timeline)===null||m===void 0?void 0:m.length)-1;f>=0;--f){var m,g,S=this.timeline[f];if(S.getId()===d)return d;if(S.getTs()<h.ts)return(g=S.getId())!==null&&g!==void 0?g:d}}return d}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var n,i,o,u,d,h,f=((n=(i=this.lastReply())===null||i===void 0?void 0:i.getTs())!==null&&n!==void 0?n:0)<this.room.getOldestThreadedReceiptTs(),m=(o=(u=this.room.getLastUnthreadedReceiptFor(e))===null||u===void 0?void 0:u.ts)!==null&&o!==void 0?o:0,g=((d=this===null||this===void 0||(h=this.lastReply())===null||h===void 0?void 0:h.getTs())!==null&&d!==void 0?d:0)<m;if(f||g)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}y(At,"hasServerSideSupport",bn.None);y(At,"hasServerSideListSupport",bn.None);y(At,"hasServerSideFwdPaginationSupport",bn.None);function nA(s){return s.isEncrypted()&&(s.isRelation(wt.name)||s.isThreadRoot)}var Ws=new od("related_by_senders","io.element.relation_senders"),Ys=new od("related_by_rel_types","io.element.relation_types"),wt=new od("m.thread","io.element.thread"),Er=(function(s){return s[s.My=0]="My",s[s.All=1]="All",s})({});function cT(s){return s===Er.My?"participated":"all"}class zE extends Error{constructor(e,t,n){super(t),this.code=e,y(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=rA(this,n)}}function rA(s,e){var t=s.name+"[msg: "+s.message;return e&&(t+=", "+Object.keys(e).map(n=>n+": "+e[n]).join(", ")),t+="]",t}var WE=Object.freeze({visible:!0}),zm=36e5,mt=(function(s){return s.Decrypted="Event.decrypted",s.BeforeRedaction="Event.beforeRedaction",s.VisibilityChange="Event.visibilityChange",s.LocalEventIdReplaced="Event.localEventIdReplaced",s.Status="Event.status",s.Replaced="Event.replaced",s.RelationsCreated="Event.relationsCreated",s.SentinelUpdated="Event.sentinelUpdated",s})({});class yn extends Lt{setMetadata(e,t){var n,i,o=this.isState()&&this.getType()===Z.RoomMember&&this.getSender()===this.getStateKey(),u=!1;if(o||!((n=this.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)){var d=e.getSentinelMember(this.getSender());d!==this.sender&&(u=!0),this.sender=d}if(o||!((i=this.target)!==null&&i!==void 0&&(i=i.events)!==null&&i!==void 0&&i.member)&&this.getType()===Z.RoomMember){var h=e.getSentinelMember(this.getStateKey());h!==this.target&&(u=!0),this.target=h}this.isState()&&t&&(this.forwardLooking=!1),u&&this.emit(mt.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,y(this,"pushDetails",{}),y(this,"_replacingEvent",null),y(this,"_localRedactionEvent",null),y(this,"_isCancelled",!1),y(this,"clearEvent",void 0),y(this,"visibility",WE),y(this,"_hasCachedExtEv",!1),y(this,"_cachedExtEv",void 0),y(this,"_decryptionFailureReason",null),y(this,"senderCurve25519Key",null),y(this,"claimedEd25519Key",null),y(this,"keyForwardedBy",void 0),y(this,"decryptionPromise",null),y(this,"retryDecryption",!1),y(this,"txnId",void 0),y(this,"thread",void 0),y(this,"threadId",void 0),y(this,"localTimestamp",void 0),y(this,"sender",null),y(this,"target",null),y(this,"status",null),y(this,"error",null),y(this,"forwardLooking",!0),y(this,"reEmitter",void 0),y(this,"unstableStickyExpiresAt",void 0),["state_key","type","sender","room_id","membership"].forEach(o=>{typeof t[o]=="string"&&(t[o]=Vh(t[o]))}),["membership","avatar_url","displayname"].forEach(o=>{var u;typeof((u=t.content)===null||u===void 0?void 0:u[o])=="string"&&(t.content[o]=Vh(t.content[o]))}),["rel_type"].forEach(o=>{var u;typeof((u=t.content)===null||u===void 0||(u=u["m.relates_to"])===null||u===void 0?void 0:u[o])=="string"&&(t.content["m.relates_to"][o]=Vh(t.content["m.relates_to"][o]))}),this.txnId=t.txn_id;var n=this.getAge(),i=Date.now();this.localTimestamp=n!==void 0?i-n:(e=this.getTs())!==null&&e!==void 0?e:i,this.reEmitter=new lo(this),this.unstableStickyInfo&&(this.unstableStickyInfo.duration_ttl_ms?this.unstableStickyExpiresAt=i+this.unstableStickyInfo.duration_ttl_ms:this.unstableStickyExpiresAt=Math.min(i,this.getTs())+this.unstableStickyInfo.duration_ms)}get unstableExtensibleEvent(){if(!this._hasCachedExtEv){var e;this._cachedExtEv=(e=Pn.ExtensibleEvents.parse(this.getEffectiveEvent()))!==null&&e!==void 0?e:void 0}return this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===Z.RoomMessageEncrypted)for(var[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var n=this.getContent()[dd];return"msgid=".concat(n," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if(t?.rel_type===wt.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var n=this.getUnsigned();if(typeof n[Zc.name]=="string")return n[Zc.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(wt.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.clearEvent?this.clearEvent.state_key:this.event.state_key}getWireStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return z_.findIn(e)}makeEncrypted(e,t,n,i){this.clearEvent={type:this.event.type,content:this.event.content,state_key:this.event.state_key},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=i,this.isState()&&(this.event.state_key="".concat(this.clearEvent.type,":").concat(this.clearEvent.state_key))}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(!n.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var o=n.clearEvent&&!n.isDecryptionFailure();if(o)throw new Error("Attempt to decrypt event which has already been decrypted");return n.decryptionPromise?(N.log("Event ".concat(n.getId()," already being decrypted; queueing a retry")),n.retryDecryption=!0,n.decryptionPromise):(n.decryptionPromise=n.decryptionLoop(e,i),n.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){n.retryDecryption=!1;var o=void 0;try{var u=yield e.decryptEvent(n);i.isRetry===!0&&N.info("Decrypted event on retry (".concat(n.getDetails(),")")),n.setClearData(u),n._decryptionFailureReason=null}catch(h){var d=h instanceof zE?h.detailedString:String(h);if(o=h,n.retryDecryption){N.log("Error decrypting event (".concat(n.getDetails(),"), but retrying: ").concat(d));continue}N.warn("Error decrypting event (".concat(n.getDetails(),"): ").concat(d)),n.setClearDataForDecryptionFailure(String(h)),n._decryptionFailureReason=h instanceof zE?h.code:JO.UNKNOWN_ERROR}n.decryptionPromise=null,n.retryDecryption=!1,n.setPushDetails(),i.emit!==!1&&n.emit(mt.Decrypted,n,o);return}})()}setClearData(e){var t,n;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(n=e.claimedEd25519Key)!==null&&n!==void 0?n:null,this.keyForwardedBy=e.keyForwardedBy,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:Z.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return this.event.type===Z.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return[]}isKeySourceUntrusted(){return!1}getKeyForwardingUser(){return this.keyForwardedBy}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(mt.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n,i=(t=e?.visible)!==null&&t!==void 0?t:!0,o=(n=e?.reason)!==null&&n!==void 0?n:null,u=!1;(this.visibility.visible!==i||!this.visibility.visible&&this.visibility.reason!==o)&&(u=!0),u&&(i?this.visibility=WE:this.visibility=Object.freeze({visible:!1,reason:o}),this.emit(mt.VisibilityChange,this,i))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(mt.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var n in this.event)this.event.hasOwnProperty(n)&&!iA.has(n)&&delete this.event[n];this.isEncrypted()&&(this.clearEvent=void 0);var i=this.getType()in YE?YE[this.getType()]:{},o=this.getContent();for(var u in o)o.hasOwnProperty(u)&&!i[u]&&delete o[u];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var n of t.events){var i;((i=n.getRelation())===null||i===void 0?void 0:i.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var n=e.getLiveTimeline();n.getTimelineSet().insertEventIntoTimeline(this,n,n.getState(Oe.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===Z.RoomRedaction}asVisibilityChange(){if(!La.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var n=this.getWireContent(),i=!!n.visible,o=n.reason;return o&&typeof o!="string"?null:{visible:i,reason:o,eventId:t}}isVisibilityEvent(){return La.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var n,i;return(n=(i=this.clearEvent)===null||i===void 0?void 0:i.unsigned.redacted_because)!==null&&n!==void 0?n:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,n=this.getUnsigned(),i=this.getId();this.event=e,n.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=n.redacted_because),this.setStatus(null),this.getId()!==i&&this.emit(mt.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(mt.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(mt.LocalEventIdReplaced,this)}isRelation(e){var t,n=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(n!=null&&n.rel_type)&&[Mt.Replace,Mt.Thread].includes(n.rel_type)?!1:!!(n!=null&&n.rel_type&&n.event_id&&(!e||n.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(mt.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(Mt.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(Mt.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var n;return(n=this._replacingEvent.getDate())!==null&&n!==void 0?n:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new yn(JSON.parse(JSON.stringify(this.event)));for(var[t,n]of Object.entries(this))t!=="event"&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=pv(this.event),n=pv(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Rn.Update]),this.thread=e,this.setThreadId(e?.id),e&&this.reEmitter.reEmit(e,[Rn.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}get unstableStickyInfo(){var e,t;if((e=this.event.msc4354_sticky)!==null&&e!==void 0&&e.duration_ms)return{duration_ms:Math.min(zm,this.event.msc4354_sticky.duration_ms),duration_ttl_ms:(t=this.event.unsigned)===null||t===void 0?void 0:t.msc4354_sticky_duration_ttl_ms}}}var iA=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),YE={[Z.RoomMember]:{membership:1},[Z.RoomJoinRules]:{join_rule:1},[Z.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},aA=["1","2","3","4","5","6","7","8","9","10","11"];function sA(s){return!aA.includes(s)}var Wn=(function(s){return s[s.NotStarted=0]="NotStarted",s[s.InProgress=1]="InProgress",s[s.Finished=2]="Finished",s})(Wn||{}),rt=(function(s){return s.Events="RoomState.events",s.Members="RoomState.members",s.NewMember="RoomState.newMember",s.Update="RoomState.update",s.BeaconLiveness="RoomState.BeaconLiveness",s.Marker="RoomState.Marker",s})({});class $l extends Lt{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:Wn.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,y(this,"reEmitter",new lo(this)),y(this,"sentinels",{}),y(this,"displayNameToUserIds",new Map),y(this,"userIdsToDisplayNames",{}),y(this,"tokenToInvite",{}),y(this,"joinedMemberCount",null),y(this,"summaryJoinedMemberCount",null),y(this,"invitedMemberCount",null),y(this,"summaryInvitedMemberCount",null),y(this,"modified",-1),y(this,"members",{}),y(this,"events",new Map),y(this,"paginationToken",null),y(this,"beacons",new Map),y(this,"_liveBeaconIds",[]),y(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(Z.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(N.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ye.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ye.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new Hl(this.roomId,e);var n=this.members[e];n!=null&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new $l(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=Wn.NotStarted,Array.from(this.events.values()).forEach(n=>{e.setStateEvents(Array.from(n.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==Wn.Finished&&this.getMembers().forEach(n=>{if(n.isOutOfBand()){var i;(i=e.getMember(n.userId))===null||i===void 0||i.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(n=>!this.events.has(n.getType())||!this.events.get(n.getType()).has(n.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState())){Nm.matches(n.getType())&&this.setBeacon(n);var i=this.getStateEventMatching(n);if(this.setStateEvent(n),n.getType()===Z.RoomMember){var o;this.updateDisplayNameCache(n.getStateKey(),(o=n.getContent().displayname)!==null&&o!==void 0?o:""),this.updateThirdPartyTokenCache(n)}this.emit(rt.Events,n,this,i)}}),this.onBeaconLivenessChange(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState()))if(n.getType()===Z.RoomMember){var i=n.getStateKey();(n.getContent().membership===Ye.Leave||n.getContent().membership===Ye.Ban)&&(n.getContent().avatar_url=n.getContent().avatar_url||n.getPrevContent().avatar_url,n.getContent().displayname=n.getContent().displayname||n.getPrevContent().displayname);var o=this.getOrCreateMember(i,n);o.setMembershipEvent(n,this),this.updateMember(o),this.emit(rt.Members,n,this,o)}else if(n.getType()===Z.RoomPowerLevels){if(n.getStateKey()!=="")return;var u=Object.values(this.members),d=this.getStateEvents(Z.RoomCreate,""),h=JE(this.getRoomVersion(),d);u.forEach(f=>{var m=f.getLastModifiedTime();if(d){var g=XE(f.userId,n,h);f.setPowerLevel(g,n)}m!==f.getLastModifiedTime()&&this.emit(rt.Members,n,this,f)}),this.sentinels={}}else H_.matches(n.getType())&&this.emit(rt.Marker,n,t)}),this.emit(rt.Update,this)}processBeaconEvents(e,t){var n=this;return D(function*(){if(!(!e.length||!n.beacons.size)){var i=[...n.beacons.values()].reduce((f,m)=>(f[m.beaconInfoId]=m,f),{}),o=(f,m)=>{if(Vv.matches(m.getType())){var g=i[f];g&&g.addLocations([m])}},u=function*(m){var g,S=(g=m.getRelation())===null||g===void 0?void 0:g.event_id;if(!S||!i[S])return{v:void 0};if(!Vv.matches(m.getType())&&!m.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(m),o(S,m)}catch{m.isDecryptionFailure()&&m.once(mt.Decrypted,D(function*(){o(S,m)}))}},d;for(var h of e)if(d=yield*u(h),d)return d.v}})()}getOrCreateMember(e,t){var n=this.members[e];return n||(n=new Hl(this.roomId,e),this.members[e]=n,this.emit(rt.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=ed(e);if(this.beacons.has(t)){var n=this.beacons.get(t);if(e.isRedacted()){var i;n.beaconInfoId===((i=e.getRedactionEvent())===null||i===void 0?void 0:i.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(!e.isRedacted()){var o=new m0(e);this.reEmitter.reEmit(o,[Nt.New,Nt.Update,Nt.Destroy,Nt.LivenessChange]),this.emit(Nt.New,e,o),o.on(Nt.LivenessChange,this.onBeaconLivenessChange.bind(this)),o.on(Nt.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(o.identifier,o)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(rt.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return(t=(n=this.events.get(e.getType()))===null||n===void 0?void 0:n.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(Z.RoomCreate,""),n=this.getStateEvents(Z.RoomPowerLevels,"");if(n&&t){var i=XE(e.userId,n,JE(this.getRoomVersion(),t));e.setPowerLevel(i,n)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===Wn.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===Wn.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===Wn.NotStarted&&(this.oobMemberFlags.status=Wn.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===Wn.InProgress&&(this.oobMemberFlags.status=Wn.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var n=this.members[t];n.isOutOfBand()&&(++e,delete this.members[t])}),N.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=Wn.NotStarted}setOutOfBandMembers(e){N.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===Wn.InProgress&&(N.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=Wn.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(rt.Update,this))}setOutOfBandMember(e){if(e.getType()===Z.RoomMember){var t=e.getStateKey(),n=this.getMember(t);if(!(n&&!n.isOutOfBand())){var i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(rt.Members,e,this,i)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(ja(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var n=this.getMember(t);if(!n||n.membership===Ye.Leave||e.status||e.isRedacted())return!1;var i=this.maySendEvent(Z.RoomRedaction,t);return i?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",n.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var n=this.getStateEvents(Z.RoomPowerLevels,""),i={};n&&(i=n.getContent());var o=50;return vb(i[e])&&(o=i[e]),t>=o}maySendMessage(e){return this.maySendEventOfType(Z.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){var i,o=this.getStateEvents(Z.RoomPowerLevels,""),u,d={},h=0,f=0;o&&(u=o.getContent(),d=u.events||{},Number.isSafeInteger(u.state_default)?h=u.state_default:h=50,Number.isSafeInteger(u.events_default)&&(f=u.events_default));var m=n?h:f;Number.isSafeInteger(d[e])&&(m=d[e]);var g=this.getMember(t),S=(i=g?.powerLevel)!==null&&i!==void 0?i:0;return S>=m}mayTriggerNotifOfType(e,t){var n=this.getMember(t);if(!n)return!1;var i=this.getStateEvents(Z.RoomPowerLevels,""),o=50;return i&&i.getContent()&&i.getContent().notifications&&vb(i.getContent().notifications[e])&&(o=i.getContent().notifications[e]),n.powerLevel>=o}getJoinRule(){var e,t=this.getStateEvents(Z.RoomJoinRules,""),n=(e=t?.getContent())!==null&&e!==void 0?e:{};return n.join_rule||B0.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(Z.RoomHistoryVisibility,""),n=(e=t?.getContent())!==null&&e!==void 0?e:{};return n.history_visibility||Pm.Shared}getGuestAccess(){var e,t=this.getStateEvents(Z.RoomGuestAccess,""),n=(e=t?.getContent())!==null&&e!==void 0?e:{};return n.guest_access||rd.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(Z.RoomPredecessor,"");if(t){var n=t.getContent(),i=n.predecessor_room_id,o=n.last_known_event_id;typeof o!="string"&&(o=void 0);var u=n.via_servers;if(Array.isArray(u)||(u=void 0),typeof i=="string")return{roomId:i,eventId:o,viaServers:u}}}var d=this.getStateEvents(Z.RoomCreate,"");if(d){var h=d.getContent().predecessor;if(h){var f=h.room_id;if(typeof f=="string"){var m=h.event_id;return(typeof m!="string"||m==="")&&(m=void 0),{roomId:f,eventId:m}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var n=this.getStateEvents(Z.RoomThirdPartyInvite,t);n&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){var i=ja(n),o=this.displayNameToUserIds.get(i);if(o){var u=o.filter(m=>m!==e);this.displayNameToUserIds.set(i,u)}}this.userIdsToDisplayNames[e]=t;var d=t&&ja(t);if(d){var h,f=(h=this.displayNameToUserIds.get(d))!==null&&h!==void 0?h:[];f.push(e),this.displayNameToUserIds.set(d,f)}}}function JE(s,e){var t=new Set;if(sA(s)&&e){var n=e.getSender();n&&t.add(n);var i=e.getDirectionalContent().additional_creators;Array.isArray(i)&&i.forEach(o=>t.add(o))}return t}function XE(s,e,t){if(t.has(s))return 1/0;var n=e.getDirectionalContent(),i=n.users||{};return i[s]!==void 0&&Number.isInteger(i[s])?i[s]:n.users_default!==void 0?n.users_default:0}function QE(s){var e=typeof s=="string"&&!!s&&s!=="undefined"&&s!=="null";return e||typeof s=="number"}class Wm{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};y(this,"rooms",{}),y(this,"users",{}),y(this,"syncToken",null),y(this,"filters",new mi(()=>new Map)),y(this,"accountData",new Map),y(this,"localStorage",void 0),y(this,"oobMembers",new Map),y(this,"pendingEvents",{}),y(this,"clientOptions",void 0),y(this,"pendingToDeviceBatches",[]),y(this,"nextToDeviceBatchId",0),y(this,"createUser",void 0),y(this,"onRoomMember",(t,n,i)=>{var o;if(i.membership!==Ye.Invite){var u=this.users[i.userId]||((o=this.createUser)===null||o===void 0?void 0:o.call(this,i.userId));i.name&&(u.setDisplayName(i.name),i.events.member&&u.setRawDisplayName(i.events.member.getDirectionalContent().displayname)),i.events.member&&i.events.member.getContent().avatar_url&&u.setAvatarUrl(i.events.member.getContent().avatar_url),this.users[u.userId]=u}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(rt.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(rt.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var n;return((n=this.filters.get(e))===null||n===void 0?void 0:n.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var n=this.localStorage.getItem(t);if(QE(n))return n}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var n="mxjssdk_memory_filter_"+e;try{QE(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var n=!Object.keys(t.getContent()).length;n?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new mi(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return D(function*(){var n;return(n=t.pendingEvents[e])!==null&&n!==void 0?n:[]})()}setPendingEvents(e,t){var n=this;return D(function*(){n.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return D(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return D(function*(){})()}}var uv={},Ca={},xs={},ZE;function Ym(){if(ZE)return xs;ZE=1,Object.defineProperty(xs,"__esModule",{value:!0}),xs.WidgetApiDirection=void 0,xs.invertedDirection=e;var s=(function(t){return t.ToWidget="toWidget",t.FromWidget="fromWidget",t})({});xs.WidgetApiDirection=s;function e(t){if(t===s.ToWidget)return s.FromWidget;if(t===s.FromWidget)return s.ToWidget;throw new Error("Invalid direction")}return xs}var ai={},$E;function Jm(){if($E)return ai;$E=1,Object.defineProperty(ai,"__esModule",{value:!0}),ai.UnstableApiVersion=ai.MatrixApiVersion=ai.CurrentApiVersions=void 0;var s=(function(n){return n.Prerelease1="0.0.1",n.Prerelease2="0.0.2",n})({});ai.MatrixApiVersion=s;var e=(function(n){return n.MSC2762="org.matrix.msc2762",n.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",n.MSC2871="org.matrix.msc2871",n.MSC2873="org.matrix.msc2873",n.MSC2931="org.matrix.msc2931",n.MSC2974="org.matrix.msc2974",n.MSC2876="org.matrix.msc2876",n.MSC3819="org.matrix.msc3819",n.MSC3846="town.robin.msc3846",n.MSC3869="org.matrix.msc3869",n.MSC3973="org.matrix.msc3973",n.MSC4039="org.matrix.msc4039",n})({});ai.UnstableApiVersion=e;var t=[s.Prerelease1,s.Prerelease2,e.MSC2762,e.MSC2762_UPDATE_STATE,e.MSC2871,e.MSC2873,e.MSC2931,e.MSC2974,e.MSC2876,e.MSC3819,e.MSC3846,e.MSC3869,e.MSC3973,e.MSC4039];return ai.CurrentApiVersions=t,ai}var pl={},e_;function Xm(){if(e_)return pl;e_=1,Object.defineProperty(pl,"__esModule",{value:!0}),pl.PostmessageTransport=void 0;var s=cd(),e=Ed(),t=["message"];function n(E){"@babel/helpers - typeof";return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},n(E)}function i(E,I){if(E==null)return{};var w=o(E,I),q,z;if(Object.getOwnPropertySymbols){var ue=Object.getOwnPropertySymbols(E);for(z=0;z<ue.length;z++)q=ue[z],!(I.indexOf(q)>=0)&&Object.prototype.propertyIsEnumerable.call(E,q)&&(w[q]=E[q])}return w}function o(E,I){if(E==null)return{};var w={},q=Object.keys(E),z,ue;for(ue=0;ue<q.length;ue++)z=q[ue],!(I.indexOf(z)>=0)&&(w[z]=E[z]);return w}function u(E,I){var w=Object.keys(E);if(Object.getOwnPropertySymbols){var q=Object.getOwnPropertySymbols(E);I&&(q=q.filter(function(z){return Object.getOwnPropertyDescriptor(E,z).enumerable})),w.push.apply(w,q)}return w}function d(E){for(var I=1;I<arguments.length;I++){var w=arguments[I]!=null?arguments[I]:{};I%2?u(Object(w),!0).forEach(function(q){C(E,q,w[q])}):Object.getOwnPropertyDescriptors?Object.defineProperties(E,Object.getOwnPropertyDescriptors(w)):u(Object(w)).forEach(function(q){Object.defineProperty(E,q,Object.getOwnPropertyDescriptor(w,q))})}return E}function h(E,I){if(!(E instanceof I))throw new TypeError("Cannot call a class as a function")}function f(E,I){for(var w=0;w<I.length;w++){var q=I[w];q.enumerable=q.enumerable||!1,q.configurable=!0,"value"in q&&(q.writable=!0),Object.defineProperty(E,U(q.key),q)}}function m(E,I,w){return I&&f(E.prototype,I),Object.defineProperty(E,"prototype",{writable:!1}),E}function g(E,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");E.prototype=Object.create(I&&I.prototype,{constructor:{value:E,writable:!0,configurable:!0}}),Object.defineProperty(E,"prototype",{writable:!1}),I&&S(E,I)}function S(E,I){return S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(q,z){return q.__proto__=z,q},S(E,I)}function _(E){var I=k();return function(){var q=A(E),z;if(I){var ue=A(this).constructor;z=Reflect.construct(q,arguments,ue)}else z=q.apply(this,arguments);return b(this,z)}}function b(E,I){if(I&&(n(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return T(E)}function T(E){if(E===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return E}function k(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function A(E){return A=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(w){return w.__proto__||Object.getPrototypeOf(w)},A(E)}function C(E,I,w){return I=U(I),I in E?Object.defineProperty(E,I,{value:w,enumerable:!0,configurable:!0,writable:!0}):E[I]=w,E}function U(E){var I=O(E,"string");return n(I)==="symbol"?I:String(I)}function O(E,I){if(n(E)!=="object"||E===null)return E;var w=E[Symbol.toPrimitive];if(w!==void 0){var q=w.call(E,I);if(n(q)!=="object")return q;throw new TypeError("@@toPrimitive must return a primitive value.")}return(I==="string"?String:Number)(E)}var M=(function(E){g(w,E);var I=_(w);function w(q,z,ue,Se){var Ie;return h(this,w),Ie=I.call(this),Ie.sendDirection=q,Ie.transportWindow=ue,Ie.inboundWindow=Se,C(T(Ie),"strictOriginCheck",!1),C(T(Ie),"targetOrigin","*"),C(T(Ie),"timeoutSeconds",10),C(T(Ie),"_ready",!1),C(T(Ie),"_widgetId",void 0),C(T(Ie),"outboundRequests",new Map),C(T(Ie),"stopController",new AbortController),Ie._widgetId=z,Ie}return m(w,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var z="widgetapi-".concat(Date.now()),ue=0,Se=z;this.outboundRequests.has(Se);)Se="".concat(z,"-").concat(ue++);return this.outboundRequests.set(Se,null),Se}},{key:"sendInternal",value:function(z){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),z),this.transportWindow.postMessage(z,this.targetOrigin)}},{key:"reply",value:function(z,ue){return this.sendInternal(d(d({},z),{},{response:ue}))}},{key:"send",value:function(z,ue){return this.sendComplete(z,ue).then(function(Se){return Se.response})}},{key:"sendComplete",value:function(z,ue){var Se=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var Ie={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:z,data:ue};return z===e.WidgetApiToWidgetAction.UpdateVisibility&&(Ie.visible=ue.visible),new Promise(function(Ze,me){var J=function(le){De(),Ze(le)},oe=function(le){De(),me(le)},pe=setTimeout(function(){return oe(new Error("Request timed out"))},(Se.timeoutSeconds||1)*1e3),Te=function(){return oe(new Error("Transport stopped"))};Se.stopController.signal.addEventListener("abort",Te);var De=function(){Se.outboundRequests.delete(Ie.requestId),clearTimeout(pe),Se.stopController.signal.removeEventListener("abort",Te)};Se.outboundRequests.set(Ie.requestId,{request:Ie,resolve:J,reject:oe}),Se.sendInternal(Ie)})}},{key:"start",value:function(){var z=this;this.inboundWindow.addEventListener("message",function(ue){z.handleMessage(ue)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(z){if(!this.stopController.signal.aborted&&z.data&&!(this.strictOriginCheck&&z.origin!==globalThis.origin)){var ue=z.data;if(!(!ue.action||!ue.requestId||!ue.widgetId))if(ue.response){if(ue.api!==this.sendDirection)return;this.handleResponse(ue)}else{var Se=ue;if(Se.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(Se)}}}},{key:"handleRequest",value:function(z){if(this.widgetId){if(this.widgetId!==z.widgetId)return}else this._widgetId=z.widgetId;this.emit("message",new CustomEvent("message",{detail:z}))}},{key:"handleResponse",value:function(z){if(z.widgetId===this.widgetId){var ue=this.outboundRequests.get(z.requestId);if(ue)if((0,e.isErrorResponse)(z.response)){var Se=z.response.error,Ie=Se.message,Ze=i(Se,t);ue.reject(new e.WidgetApiResponseError(Ie,Ze))}else ue.resolve(z)}}}]),w})(s.EventEmitter);return pl.PostmessageTransport=M,pl}var Ia={},t_;function Qm(){if(t_)return Ia;t_=1,Object.defineProperty(Ia,"__esModule",{value:!0}),Ia.WidgetApiToWidgetAction=Ia.WidgetApiFromWidgetAction=void 0;var s=(function(t){return t.SupportedApiVersions="supported_api_versions",t.Capabilities="capabilities",t.NotifyCapabilities="notify_capabilities",t.ThemeChange="theme_change",t.LanguageChange="language_change",t.TakeScreenshot="screenshot",t.UpdateVisibility="visibility",t.OpenIDCredentials="openid_credentials",t.WidgetConfig="widget_config",t.CloseModalWidget="close_modal",t.ButtonClicked="button_clicked",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.UpdateState="update_state",t.UpdateTurnServers="update_turn_servers",t})({});Ia.WidgetApiToWidgetAction=s;var e=(function(t){return t.SupportedApiVersions="supported_api_versions",t.ContentLoaded="content_loaded",t.SendSticker="m.sticker",t.UpdateAlwaysOnScreen="set_always_on_screen",t.GetOpenIDCredentials="get_openid",t.CloseModalWidget="close_modal",t.OpenModalWidget="open_modal",t.SetModalButtonEnabled="set_button_enabled",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.WatchTurnServers="watch_turn_servers",t.UnwatchTurnServers="unwatch_turn_servers",t.BeeperReadRoomAccountData="com.beeper.read_room_account_data",t.MSC2876ReadEvents="org.matrix.msc2876.read_events",t.MSC2931Navigate="org.matrix.msc2931.navigate",t.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",t.MSC3869ReadRelations="org.matrix.msc3869.read_relations",t.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",t.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",t.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",t.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",t.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",t})({});return Ia.WidgetApiFromWidgetAction=e,Ia}var gl={},n_;function Zm(){if(n_)return gl;n_=1,Object.defineProperty(gl,"__esModule",{value:!0}),gl.OpenIDRequestState=void 0;var s=(function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e})({});return gl.OpenIDRequestState=s,gl}var yl={},r_;function dT(){if(r_)return yl;r_=1,Object.defineProperty(yl,"__esModule",{value:!0}),yl.MatrixWidgetType=void 0;var s=(function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e})({});return yl.MatrixWidgetType=s,yl}var Sl={},i_;function fT(){if(i_)return Sl;i_=1,Object.defineProperty(Sl,"__esModule",{value:!0}),Sl.BuiltInModalButtonID=void 0;var s=(function(e){return e.Close="m.close",e})({});return Sl.BuiltInModalButtonID=s,Sl}var si={},a_;function $m(){if(a_)return si;a_=1,Object.defineProperty(si,"__esModule",{value:!0}),si.WidgetEventCapability=si.EventKind=si.EventDirection=void 0;function s(S){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},s(S)}function e(S,_){var b=typeof Symbol<"u"&&S[Symbol.iterator]||S["@@iterator"];if(!b){if(Array.isArray(S)||(b=t(S))||_){b&&(S=b);var T=0,k=function(){};return{s:k,n:function(){return T>=S.length?{done:!0}:{done:!1,value:S[T++]}},e:function(M){throw M},f:k}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var A=!0,C=!1,U;return{s:function(){b=b.call(S)},n:function(){var M=b.next();return A=M.done,M},e:function(M){C=!0,U=M},f:function(){try{!A&&b.return!=null&&b.return()}finally{if(C)throw U}}}}function t(S,_){if(S){if(typeof S=="string")return n(S,_);var b=Object.prototype.toString.call(S).slice(8,-1);if(b==="Object"&&S.constructor&&(b=S.constructor.name),b==="Map"||b==="Set")return Array.from(S);if(b==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b))return n(S,_)}}function n(S,_){(_==null||_>S.length)&&(_=S.length);for(var b=0,T=new Array(_);b<_;b++)T[b]=S[b];return T}function i(S,_){if(!(S instanceof _))throw new TypeError("Cannot call a class as a function")}function o(S,_){for(var b=0;b<_.length;b++){var T=_[b];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(S,d(T.key),T)}}function u(S,_,b){return _&&o(S.prototype,_),b&&o(S,b),Object.defineProperty(S,"prototype",{writable:!1}),S}function d(S){var _=h(S,"string");return s(_)==="symbol"?_:String(_)}function h(S,_){if(s(S)!=="object"||S===null)return S;var b=S[Symbol.toPrimitive];if(b!==void 0){var T=b.call(S,_);if(s(T)!=="object")return T;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(S)}var f=(function(S){return S.Event="event",S.State="state_event",S.ToDevice="to_device",S.RoomAccount="room_account",S})({});si.EventKind=f;var m=(function(S){return S.Send="send",S.Receive="receive",S})({});si.EventDirection=m;var g=(function(){function S(_,b,T,k,A){i(this,S),this.direction=_,this.eventType=b,this.kind=T,this.keyStr=k,this.raw=A}return u(S,[{key:"matchesAsStateEvent",value:function(b,T,k){return this.kind!==f.State||this.direction!==b||this.eventType!==T?!1:this.keyStr===null||this.keyStr===k}},{key:"matchesAsToDeviceEvent",value:function(b,T){return!(this.kind!==f.ToDevice||this.direction!==b||this.eventType!==T)}},{key:"matchesAsRoomEvent",value:function(b,T){var k=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==f.Event||this.direction!==b||this.eventType!==T)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===k)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(b,T){return!(this.kind!==f.RoomAccount||this.direction!==b||this.eventType!==T)}}],[{key:"forStateEvent",value:function(b,T,k){T=T.replace(/#/g,"\\#"),k=k!=null?"#".concat(k):"";var A="org.matrix.msc2762.".concat(b,".state_event:").concat(T).concat(k);return S.findEventCapabilities([A])[0]}},{key:"forToDeviceEvent",value:function(b,T){var k="org.matrix.msc3819.".concat(b,".to_device:").concat(T);return S.findEventCapabilities([k])[0]}},{key:"forRoomEvent",value:function(b,T){var k="org.matrix.msc2762.".concat(b,".event:").concat(T);return S.findEventCapabilities([k])[0]}},{key:"forRoomMessageEvent",value:function(b,T){T=T??"";var k="org.matrix.msc2762.".concat(b,".event:m.room.message#").concat(T);return S.findEventCapabilities([k])[0]}},{key:"forRoomAccountData",value:function(b,T){var k="com.beeper.capabilities.".concat(b,".room_account_data:").concat(T);return S.findEventCapabilities([k])[0]}},{key:"findEventCapabilities",value:function(b){var T=[],k=e(b),A;try{for(k.s();!(A=k.n()).done;){var C=A.value,U=null,O=void 0,M=null;if(C.startsWith("org.matrix.msc2762.send.event:")?(U=m.Send,M=f.Event,O=C.substring(30)):C.startsWith("org.matrix.msc2762.send.state_event:")?(U=m.Send,M=f.State,O=C.substring(36)):C.startsWith("org.matrix.msc3819.send.to_device:")?(U=m.Send,M=f.ToDevice,O=C.substring(34)):C.startsWith("org.matrix.msc2762.receive.event:")?(U=m.Receive,M=f.Event,O=C.substring(33)):C.startsWith("org.matrix.msc2762.receive.state_event:")?(U=m.Receive,M=f.State,O=C.substring(39)):C.startsWith("org.matrix.msc3819.receive.to_device:")?(U=m.Receive,M=f.ToDevice,O=C.substring(37)):C.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(U=m.Receive,M=f.RoomAccount,O=C.substring(50)),!(U===null||M===null||O===void 0)){var E=O.startsWith("m.room.message#")||M===f.State,I=null;if(O.includes("#")&&E){var w=O.split("#"),q=w.findIndex(function(z){return!z.endsWith("\\")});O=w.slice(0,q+1).map(function(z){return z.endsWith("\\")?z.substring(0,z.length-1):z}).join("#"),I=w.slice(q+1).join("#")}T.push(new S(U,O,M,I,C))}}}catch(z){k.e(z)}finally{k.f()}return T}}]),S})();return si.WidgetEventCapability=g,si}var bl={},s_;function ep(){if(s_)return bl;s_=1,Object.defineProperty(bl,"__esModule",{value:!0}),bl.Symbols=void 0;var s=(function(e){return e.AnyRoom="*",e})({});return bl.Symbols=s,bl}var El={},o_;function tp(){if(o_)return El;o_=1,Object.defineProperty(El,"__esModule",{value:!0}),El.UpdateDelayedEventAction=void 0;var s=(function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e})({});return El.UpdateDelayedEventAction=s,El}var l_;function oA(){if(l_)return Ca;l_=1;function s(B){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(F){return typeof F}:function(F){return F&&typeof Symbol=="function"&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},s(B)}Object.defineProperty(Ca,"__esModule",{value:!0}),Ca.WidgetApiResponseError=Ca.WidgetApi=void 0;var e=cd(),t=Ym(),n=Jm(),i=Xm(),o=Qm(),u=Zm(),d=dT(),h=fT(),f=$m(),m=ep(),g=tp();function S(){S=function(){return B};var B={},F=Object.prototype,x=F.hasOwnProperty,j=Object.defineProperty||function(ee,ae,de){ee[ae]=de.value},P=typeof Symbol=="function"?Symbol:{},G=P.iterator||"@@iterator",V=P.asyncIterator||"@@asyncIterator",Y=P.toStringTag||"@@toStringTag";function $(ee,ae,de){return Object.defineProperty(ee,ae,{value:de,enumerable:!0,configurable:!0,writable:!0}),ee[ae]}try{$({},"")}catch{$=function(de,_e,Ne){return de[_e]=Ne}}function re(ee,ae,de,_e){var Ne=ae&&ae.prototype instanceof Pe?ae:Pe,xe=Object.create(Ne.prototype),tt=new yi(_e||[]);return j(xe,"_invoke",{value:za(ee,de,tt)}),xe}function ye(ee,ae,de){try{return{type:"normal",arg:ee.call(ae,de)}}catch(_e){return{type:"throw",arg:_e}}}B.wrap=re;var Be={};function Pe(){}function Ae(){}function qe(){}var pt={};$(pt,G,function(){return this});var xt=Object.getPrototypeOf,we=xt&&xt(xt(Me([])));we&&we!==F&&x.call(we,G)&&(pt=we);var ze=qe.prototype=Pe.prototype=Object.create(pt);function gi(ee){["next","throw","return"].forEach(function(ae){$(ee,ae,function(de){return this._invoke(ae,de)})})}function wr(ee,ae){function de(Ne,xe,tt,bt){var Et=ye(ee[Ne],ee,xe);if(Et.type!=="throw"){var Bt=Et.arg,Nn=Bt.value;return Nn&&s(Nn)=="object"&&x.call(Nn,"__await")?ae.resolve(Nn.__await).then(function(Ln){de("next",Ln,tt,bt)},function(Ln){de("throw",Ln,tt,bt)}):ae.resolve(Nn).then(function(Ln){Bt.value=Ln,tt(Bt)},function(Ln){return de("throw",Ln,tt,bt)})}bt(Et.arg)}var _e;j(this,"_invoke",{value:function(xe,tt){function bt(){return new ae(function(Et,Bt){de(xe,tt,Et,Bt)})}return _e=_e?_e.then(bt,bt):bt()}})}function za(ee,ae,de){var _e="suspendedStart";return function(Ne,xe){if(_e==="executing")throw new Error("Generator is already running");if(_e==="completed"){if(Ne==="throw")throw xe;return be()}for(de.method=Ne,de.arg=xe;;){var tt=de.delegate;if(tt){var bt=vr(tt,de);if(bt){if(bt===Be)continue;return bt}}if(de.method==="next")de.sent=de._sent=de.arg;else if(de.method==="throw"){if(_e==="suspendedStart")throw _e="completed",de.arg;de.dispatchException(de.arg)}else de.method==="return"&&de.abrupt("return",de.arg);_e="executing";var Et=ye(ee,ae,de);if(Et.type==="normal"){if(_e=de.done?"completed":"suspendedYield",Et.arg===Be)continue;return{value:Et.arg,done:de.done}}Et.type==="throw"&&(_e="completed",de.method="throw",de.arg=Et.arg)}}}function vr(ee,ae){var de=ae.method,_e=ee.iterator[de];if(_e===void 0)return ae.delegate=null,de==="throw"&&ee.iterator.return&&(ae.method="return",ae.arg=void 0,vr(ee,ae),ae.method==="throw")||de!=="return"&&(ae.method="throw",ae.arg=new TypeError("The iterator does not provide a '"+de+"' method")),Be;var Ne=ye(_e,ee.iterator,ae.arg);if(Ne.type==="throw")return ae.method="throw",ae.arg=Ne.arg,ae.delegate=null,Be;var xe=Ne.arg;return xe?xe.done?(ae[ee.resultName]=xe.value,ae.next=ee.nextLoc,ae.method!=="return"&&(ae.method="next",ae.arg=void 0),ae.delegate=null,Be):xe:(ae.method="throw",ae.arg=new TypeError("iterator result is not an object"),ae.delegate=null,Be)}function ra(ee){var ae={tryLoc:ee[0]};1 in ee&&(ae.catchLoc=ee[1]),2 in ee&&(ae.finallyLoc=ee[2],ae.afterLoc=ee[3]),this.tryEntries.push(ae)}function Cr(ee){var ae=ee.completion||{};ae.type="normal",delete ae.arg,ee.completion=ae}function yi(ee){this.tryEntries=[{tryLoc:"root"}],ee.forEach(ra,this),this.reset(!0)}function Me(ee){if(ee){var ae=ee[G];if(ae)return ae.call(ee);if(typeof ee.next=="function")return ee;if(!isNaN(ee.length)){var de=-1,_e=function Ne(){for(;++de<ee.length;)if(x.call(ee,de))return Ne.value=ee[de],Ne.done=!1,Ne;return Ne.value=void 0,Ne.done=!0,Ne};return _e.next=_e}}return{next:be}}function be(){return{value:void 0,done:!0}}return Ae.prototype=qe,j(ze,"constructor",{value:qe,configurable:!0}),j(qe,"constructor",{value:Ae,configurable:!0}),Ae.displayName=$(qe,Y,"GeneratorFunction"),B.isGeneratorFunction=function(ee){var ae=typeof ee=="function"&&ee.constructor;return!!ae&&(ae===Ae||(ae.displayName||ae.name)==="GeneratorFunction")},B.mark=function(ee){return Object.setPrototypeOf?Object.setPrototypeOf(ee,qe):(ee.__proto__=qe,$(ee,Y,"GeneratorFunction")),ee.prototype=Object.create(ze),ee},B.awrap=function(ee){return{__await:ee}},gi(wr.prototype),$(wr.prototype,V,function(){return this}),B.AsyncIterator=wr,B.async=function(ee,ae,de,_e,Ne){Ne===void 0&&(Ne=Promise);var xe=new wr(re(ee,ae,de,_e),Ne);return B.isGeneratorFunction(ae)?xe:xe.next().then(function(tt){return tt.done?tt.value:xe.next()})},gi(ze),$(ze,Y,"Generator"),$(ze,G,function(){return this}),$(ze,"toString",function(){return"[object Generator]"}),B.keys=function(ee){var ae=Object(ee),de=[];for(var _e in ae)de.push(_e);return de.reverse(),function Ne(){for(;de.length;){var xe=de.pop();if(xe in ae)return Ne.value=xe,Ne.done=!1,Ne}return Ne.done=!0,Ne}},B.values=Me,yi.prototype={constructor:yi,reset:function(ae){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Cr),!ae)for(var de in this)de.charAt(0)==="t"&&x.call(this,de)&&!isNaN(+de.slice(1))&&(this[de]=void 0)},stop:function(){this.done=!0;var ae=this.tryEntries[0].completion;if(ae.type==="throw")throw ae.arg;return this.rval},dispatchException:function(ae){if(this.done)throw ae;var de=this;function _e(Bt,Nn){return tt.type="throw",tt.arg=ae,de.next=Bt,Nn&&(de.method="next",de.arg=void 0),!!Nn}for(var Ne=this.tryEntries.length-1;Ne>=0;--Ne){var xe=this.tryEntries[Ne],tt=xe.completion;if(xe.tryLoc==="root")return _e("end");if(xe.tryLoc<=this.prev){var bt=x.call(xe,"catchLoc"),Et=x.call(xe,"finallyLoc");if(bt&&Et){if(this.prev<xe.catchLoc)return _e(xe.catchLoc,!0);if(this.prev<xe.finallyLoc)return _e(xe.finallyLoc)}else if(bt){if(this.prev<xe.catchLoc)return _e(xe.catchLoc,!0)}else{if(!Et)throw new Error("try statement without catch or finally");if(this.prev<xe.finallyLoc)return _e(xe.finallyLoc)}}}},abrupt:function(ae,de){for(var _e=this.tryEntries.length-1;_e>=0;--_e){var Ne=this.tryEntries[_e];if(Ne.tryLoc<=this.prev&&x.call(Ne,"finallyLoc")&&this.prev<Ne.finallyLoc){var xe=Ne;break}}xe&&(ae==="break"||ae==="continue")&&xe.tryLoc<=de&&de<=xe.finallyLoc&&(xe=null);var tt=xe?xe.completion:{};return tt.type=ae,tt.arg=de,xe?(this.method="next",this.next=xe.finallyLoc,Be):this.complete(tt)},complete:function(ae,de){if(ae.type==="throw")throw ae.arg;return ae.type==="break"||ae.type==="continue"?this.next=ae.arg:ae.type==="return"?(this.rval=this.arg=ae.arg,this.method="return",this.next="end"):ae.type==="normal"&&de&&(this.next=de),Be},finish:function(ae){for(var de=this.tryEntries.length-1;de>=0;--de){var _e=this.tryEntries[de];if(_e.finallyLoc===ae)return this.complete(_e.completion,_e.afterLoc),Cr(_e),Be}},catch:function(ae){for(var de=this.tryEntries.length-1;de>=0;--de){var _e=this.tryEntries[de];if(_e.tryLoc===ae){var Ne=_e.completion;if(Ne.type==="throw"){var xe=Ne.arg;Cr(_e)}return xe}}throw new Error("illegal catch attempt")},delegateYield:function(ae,de,_e){return this.delegate={iterator:Me(ae),resultName:de,nextLoc:_e},this.method==="next"&&(this.arg=void 0),Be}},B}function _(B,F,x,j,P,G,V){try{var Y=B[G](V),$=Y.value}catch(re){x(re);return}Y.done?F($):Promise.resolve($).then(j,P)}function b(B){return function(){var F=this,x=arguments;return new Promise(function(j,P){var G=B.apply(F,x);function V($){_(G,j,P,V,Y,"next",$)}function Y($){_(G,j,P,V,Y,"throw",$)}V(void 0)})}}function T(B,F){var x=Object.keys(B);if(Object.getOwnPropertySymbols){var j=Object.getOwnPropertySymbols(B);F&&(j=j.filter(function(P){return Object.getOwnPropertyDescriptor(B,P).enumerable})),x.push.apply(x,j)}return x}function k(B){for(var F=1;F<arguments.length;F++){var x=arguments[F]!=null?arguments[F]:{};F%2?T(Object(x),!0).forEach(function(j){O(B,j,x[j])}):Object.getOwnPropertyDescriptors?Object.defineProperties(B,Object.getOwnPropertyDescriptors(x)):T(Object(x)).forEach(function(j){Object.defineProperty(B,j,Object.getOwnPropertyDescriptor(x,j))})}return B}function A(B,F){var x=typeof Symbol<"u"&&B[Symbol.iterator]||B["@@iterator"];if(!x){if(Array.isArray(B)||(x=C(B))||F){x&&(B=x);var j=0,P=function(){};return{s:P,n:function(){return j>=B.length?{done:!0}:{done:!1,value:B[j++]}},e:function(re){throw re},f:P}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var G=!0,V=!1,Y;return{s:function(){x=x.call(B)},n:function(){var re=x.next();return G=re.done,re},e:function(re){V=!0,Y=re},f:function(){try{!G&&x.return!=null&&x.return()}finally{if(V)throw Y}}}}function C(B,F){if(B){if(typeof B=="string")return U(B,F);var x=Object.prototype.toString.call(B).slice(8,-1);if(x==="Object"&&B.constructor&&(x=B.constructor.name),x==="Map"||x==="Set")return Array.from(B);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return U(B,F)}}function U(B,F){(F==null||F>B.length)&&(F=B.length);for(var x=0,j=new Array(F);x<F;x++)j[x]=B[x];return j}function O(B,F,x){return F=I(F),F in B?Object.defineProperty(B,F,{value:x,enumerable:!0,configurable:!0,writable:!0}):B[F]=x,B}function M(B,F){for(var x=0;x<F.length;x++){var j=F[x];j.enumerable=j.enumerable||!1,j.configurable=!0,"value"in j&&(j.writable=!0),Object.defineProperty(B,I(j.key),j)}}function E(B,F,x){return F&&M(B.prototype,F),Object.defineProperty(B,"prototype",{writable:!1}),B}function I(B){var F=w(B,"string");return s(F)==="symbol"?F:String(F)}function w(B,F){if(s(B)!=="object"||B===null)return B;var x=B[Symbol.toPrimitive];if(x!==void 0){var j=x.call(B,F);if(s(j)!=="object")return j;throw new TypeError("@@toPrimitive must return a primitive value.")}return(F==="string"?String:Number)(B)}function q(B,F){if(!(B instanceof F))throw new TypeError("Cannot call a class as a function")}function z(B,F){if(typeof F!="function"&&F!==null)throw new TypeError("Super expression must either be null or a function");B.prototype=Object.create(F&&F.prototype,{constructor:{value:B,writable:!0,configurable:!0}}),Object.defineProperty(B,"prototype",{writable:!1}),F&&pe(B,F)}function ue(B){var F=J();return function(){var j=Te(B),P;if(F){var G=Te(this).constructor;P=Reflect.construct(j,arguments,G)}else P=j.apply(this,arguments);return Se(this,P)}}function Se(B,F){if(F&&(s(F)==="object"||typeof F=="function"))return F;if(F!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ie(B)}function Ie(B){if(B===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return B}function Ze(B){var F=typeof Map=="function"?new Map:void 0;return Ze=function(j){if(j===null||!oe(j))return j;if(typeof j!="function")throw new TypeError("Super expression must either be null or a function");if(typeof F<"u"){if(F.has(j))return F.get(j);F.set(j,P)}function P(){return me(j,arguments,Te(this).constructor)}return P.prototype=Object.create(j.prototype,{constructor:{value:P,enumerable:!1,writable:!0,configurable:!0}}),pe(P,j)},Ze(B)}function me(B,F,x){return J()?me=Reflect.construct.bind():me=function(P,G,V){var Y=[null];Y.push.apply(Y,G);var $=Function.bind.apply(P,Y),re=new $;return V&&pe(re,V.prototype),re},me.apply(null,arguments)}function J(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function oe(B){return Function.toString.call(B).indexOf("[native code]")!==-1}function pe(B,F){return pe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(j,P){return j.__proto__=P,j},pe(B,F)}function Te(B){return Te=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(x){return x.__proto__||Object.getPrototypeOf(x)},Te(B)}function De(B){return new Re(B,0)}function H(B){return function(){return new le(B.apply(this,arguments))}}function le(B){var F,x;function j(G,V){try{var Y=B[G](V),$=Y.value,re=$ instanceof Re;Promise.resolve(re?$.v:$).then(function(ye){if(re){var Be=G==="return"?"return":"next";if(!$.k||ye.done)return j(Be,ye);ye=B[Be](ye).value}P(Y.done?"return":"normal",ye)},function(ye){j("throw",ye)})}catch(ye){P("throw",ye)}}function P(G,V){switch(G){case"return":F.resolve({value:V,done:!0});break;case"throw":F.reject(V);break;default:F.resolve({value:V,done:!1})}(F=F.next)?j(F.key,F.arg):x=null}this._invoke=function(G,V){return new Promise(function(Y,$){var re={key:G,arg:V,resolve:Y,reject:$,next:null};x?x=x.next=re:(F=x=re,j(G,V))})},typeof B.return!="function"&&(this.return=void 0)}le.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},le.prototype.next=function(B){return this._invoke("next",B)},le.prototype.throw=function(B){return this._invoke("throw",B)},le.prototype.return=function(B){return this._invoke("return",B)};function Re(B,F){this.v=B,this.k=F}var X=(function(B){z(x,B);var F=ue(x);function x(j,P){var G;return q(this,x),G=F.call(this,j),G.data=P,G}return E(x)})(Ze(Error));Ca.WidgetApiResponseError=X,X.prototype.name=X.name;var fe=(function(B){z(x,B);var F=ue(x);function x(){var j,P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,G=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(q(this,x),j=F.call(this),O(Ie(j),"transport",void 0),O(Ie(j),"capabilitiesFinished",!1),O(Ie(j),"supportsMSC2974Renegotiate",!1),O(Ie(j),"requestedCapabilities",[]),O(Ie(j),"approvedCapabilities",void 0),O(Ie(j),"cachedClientVersions",void 0),O(Ie(j),"turnServerWatchers",0),!globalThis.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return j.transport=new i.PostmessageTransport(t.WidgetApiDirection.FromWidget,P,globalThis.parent,globalThis),j.transport.targetOrigin=G,j.transport.on("message",j.handleMessage.bind(Ie(j))),j}return E(x,[{key:"hasCapability",value:function(P){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(P):this.requestedCapabilities.includes(P)}},{key:"requestCapability",value:function(P){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(P)}},{key:"requestCapabilities",value:function(P){var G=A(P),V;try{for(G.s();!(V=G.n()).done;){var Y=V.value;this.requestCapability(Y)}}catch($){G.e($)}finally{G.f()}}},{key:"requestCapabilityForRoomTimeline",value:function(P){this.requestCapability("org.matrix.msc2762.timeline:".concat(P))}},{key:"requestCapabilityToSendState",value:function(P,G){this.requestCapability(f.WidgetEventCapability.forStateEvent(f.EventDirection.Send,P,G).raw)}},{key:"requestCapabilityToReceiveState",value:function(P,G){this.requestCapability(f.WidgetEventCapability.forStateEvent(f.EventDirection.Receive,P,G).raw)}},{key:"requestCapabilityToSendToDevice",value:function(P){this.requestCapability(f.WidgetEventCapability.forToDeviceEvent(f.EventDirection.Send,P).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(P){this.requestCapability(f.WidgetEventCapability.forToDeviceEvent(f.EventDirection.Receive,P).raw)}},{key:"requestCapabilityToSendEvent",value:function(P){this.requestCapability(f.WidgetEventCapability.forRoomEvent(f.EventDirection.Send,P).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(P){this.requestCapability(f.WidgetEventCapability.forRoomEvent(f.EventDirection.Receive,P).raw)}},{key:"requestCapabilityToSendMessage",value:function(P){this.requestCapability(f.WidgetEventCapability.forRoomMessageEvent(f.EventDirection.Send,P).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(P){this.requestCapability(f.WidgetEventCapability.forRoomMessageEvent(f.EventDirection.Receive,P).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(P){this.requestCapability(f.WidgetEventCapability.forRoomAccountData(f.EventDirection.Receive,P).raw)}},{key:"requestOpenIDConnectToken",value:function(){var P=this;return new Promise(function(G,V){P.transport.sendComplete(o.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(Y){var $=Y.response;if($.state===u.OpenIDRequestState.Allowed)G($);else if($.state===u.OpenIDRequestState.Blocked)V(new Error("User declined to verify their identity"));else if($.state===u.OpenIDRequestState.PendingUserConfirmation){var re=function ye(Be){Be.preventDefault();var Pe=Be.detail;Pe.data.original_request_id===Y.requestId&&(Pe.data.state===u.OpenIDRequestState.Allowed?(G(Pe.data),P.transport.reply(Pe,{})):Pe.data.state===u.OpenIDRequestState.Blocked?(V(new Error("User declined to verify their identity")),P.transport.reply(Pe,{})):(V(new Error("Invalid state on reply: "+$.state)),P.transport.reply(Pe,{error:{message:"Invalid state"}})),P.off("action:".concat(o.WidgetApiToWidgetAction.OpenIDCredentials),ye))};P.on("action:".concat(o.WidgetApiToWidgetAction.OpenIDCredentials),re)}else V(new Error("Invalid state: "+$.state))}).catch(V)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(o.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(o.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(P){return this.transport.send(o.WidgetApiFromWidgetAction.SendSticker,P).then()}},{key:"setAlwaysOnScreen",value:function(P){return this.transport.send(o.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:P}).then(function(G){return G.success})}},{key:"openModalWidget",value:function(P,G){var V=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],Y=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},$=arguments.length>4&&arguments[4]!==void 0?arguments[4]:d.MatrixWidgetType.Custom;return this.transport.send(o.WidgetApiFromWidgetAction.OpenModalWidget,{type:$,url:P,name:G,buttons:V,data:Y}).then()}},{key:"closeModalWidget",value:function(){var P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(o.WidgetApiFromWidgetAction.CloseModalWidget,P).then()}},{key:"sendRoomEvent",value:function(P,G,V,Y,$,re){return this.sendEvent(P,void 0,G,V,Y,$,re)}},{key:"sendStateEvent",value:function(P,G,V,Y,$,re){return this.sendEvent(P,G,V,Y,$,re)}},{key:"sendEvent",value:function(P,G,V,Y,$,re,ye){return this.transport.send(o.WidgetApiFromWidgetAction.SendEvent,k(k(k(k(k({type:P,content:V},G!==void 0&&{state_key:G}),Y!==void 0&&{room_id:Y}),$!==void 0&&{delay:$}),re!==void 0&&{parent_delay_id:re}),ye!==void 0&&{sticky_duration_ms:ye}))}},{key:"cancelScheduledDelayedEvent",value:function(P){return this.transport.send(o.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:P,action:g.UpdateDelayedEventAction.Cancel})}},{key:"restartScheduledDelayedEvent",value:function(P){return this.transport.send(o.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:P,action:g.UpdateDelayedEventAction.Restart})}},{key:"sendScheduledDelayedEvent",value:function(P){return this.transport.send(o.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:P,action:g.UpdateDelayedEventAction.Send})}},{key:"sendToDevice",value:function(P,G,V){return this.transport.send(o.WidgetApiFromWidgetAction.SendToDevice,{type:P,encrypted:G,messages:V})}},{key:"readRoomAccountData",value:function(P,G){var V={type:P};return G&&(G.includes(m.Symbols.AnyRoom)?V.room_ids=m.Symbols.AnyRoom:V.room_ids=G),this.transport.send(o.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,V).then(function(Y){return Y.events})}},{key:"readRoomEvents",value:function(P,G,V,Y,$){var re={type:P,msgtype:V};return G!==void 0&&(re.limit=G),Y&&(Y.includes(m.Symbols.AnyRoom)?re.room_ids=m.Symbols.AnyRoom:re.room_ids=Y),$&&(re.since=$),this.transport.send(o.WidgetApiFromWidgetAction.MSC2876ReadEvents,re).then(function(ye){return ye.events})}},{key:"readEventRelations",value:(function(){var j=b(S().mark(function G(V,Y,$,re,ye,Be,Pe,Ae){var qe,pt;return S().wrap(function(we){for(;;)switch(we.prev=we.next){case 0:return we.next=2,this.getClientVersions();case 2:if(qe=we.sent,qe.includes(n.UnstableApiVersion.MSC3869)){we.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return pt={event_id:V,rel_type:$,event_type:re,room_id:Y,to:Pe,from:Be,limit:ye,direction:Ae},we.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC3869ReadRelations,pt));case 7:case"end":return we.stop()}},G,this)}));function P(G,V,Y,$,re,ye,Be,Pe){return j.apply(this,arguments)}return P})()},{key:"readStateEvents",value:function(P,G,V,Y){var $={type:P,state_key:V===void 0?!0:V};return G!==void 0&&($.limit=G),Y&&(Y.includes(m.Symbols.AnyRoom)?$.room_ids=m.Symbols.AnyRoom:$.room_ids=Y),this.transport.send(o.WidgetApiFromWidgetAction.MSC2876ReadEvents,$).then(function(re){return re.events})}},{key:"setModalButtonEnabled",value:function(P,G){if(P===h.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(o.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:P,enabled:G}).then()}},{key:"navigateTo",value:function(P){if(!P||!P.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(o.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:P}).then()}},{key:"getTurnServers",value:function(){var P=this;return H(S().mark(function G(){var V,Y;return S().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:if(Y=(function(){var ye=b(S().mark(function Be(Pe){return S().wrap(function(qe){for(;;)switch(qe.prev=qe.next){case 0:Pe.preventDefault(),V(Pe.detail.data),P.transport.reply(Pe.detail,{});case 3:case"end":return qe.stop()}},Be)}));return function(Pe){return ye.apply(this,arguments)}})(),P.on("action:".concat(o.WidgetApiToWidgetAction.UpdateTurnServers),Y),P.turnServerWatchers!==0){re.next=12;break}return re.prev=3,re.next=6,De(P.transport.send(o.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:re.next=12;break;case 8:throw re.prev=8,re.t0=re.catch(3),P.off("action:".concat(o.WidgetApiToWidgetAction.UpdateTurnServers),Y),re.t0;case 12:P.turnServerWatchers++,re.prev=13;case 14:return re.next=17,De(new Promise(function(ye){return V=ye}));case 17:return re.next=19,re.sent;case 19:re.next=14;break;case 21:if(re.prev=21,P.off("action:".concat(o.WidgetApiToWidgetAction.UpdateTurnServers),Y),P.turnServerWatchers--,P.turnServerWatchers!==0){re.next=27;break}return re.next=27,De(P.transport.send(o.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return re.finish(21);case 28:case"end":return re.stop()}},G,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:(function(){var j=b(S().mark(function G(V,Y){var $,re;return S().wrap(function(Be){for(;;)switch(Be.prev=Be.next){case 0:return Be.next=2,this.getClientVersions();case 2:if($=Be.sent,$.includes(n.UnstableApiVersion.MSC3973)){Be.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return re={search_term:V,limit:Y},Be.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,re));case 7:case"end":return Be.stop()}},G,this)}));function P(G,V){return j.apply(this,arguments)}return P})()},{key:"getMediaConfig",value:(function(){var j=b(S().mark(function G(){var V,Y;return S().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:return re.next=2,this.getClientVersions();case 2:if(V=re.sent,V.includes(n.UnstableApiVersion.MSC4039)){re.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return Y={},re.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,Y));case 7:case"end":return re.stop()}},G,this)}));function P(){return j.apply(this,arguments)}return P})()},{key:"uploadFile",value:(function(){var j=b(S().mark(function G(V){var Y,$;return S().wrap(function(ye){for(;;)switch(ye.prev=ye.next){case 0:return ye.next=2,this.getClientVersions();case 2:if(Y=ye.sent,Y.includes(n.UnstableApiVersion.MSC4039)){ye.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return $={file:V},ye.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC4039UploadFileAction,$));case 7:case"end":return ye.stop()}},G,this)}));function P(G){return j.apply(this,arguments)}return P})()},{key:"downloadFile",value:(function(){var j=b(S().mark(function G(V){var Y,$;return S().wrap(function(ye){for(;;)switch(ye.prev=ye.next){case 0:return ye.next=2,this.getClientVersions();case 2:if(Y=ye.sent,Y.includes(n.UnstableApiVersion.MSC4039)){ye.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return $={content_uri:V},ye.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,$));case 7:case"end":return ye.stop()}},G,this)}));function P(G){return j.apply(this,arguments)}return P})()},{key:"start",value:function(){var P=this;this.transport.start(),this.getClientVersions().then(function(G){G.includes(n.UnstableApiVersion.MSC2974)&&(P.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(P){var G=new CustomEvent("action:".concat(P.detail.action),{detail:P.detail,cancelable:!0});if(this.emit("action:".concat(P.detail.action),G),!G.defaultPrevented)switch(P.detail.action){case o.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(P.detail);case o.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(P.detail);case o.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(P.detail,{});case o.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(P.detail,{});default:return this.transport.reply(P.detail,{error:{message:"Unknown or unsupported action: "+P.detail.action}})}}},{key:"replyVersions",value:function(P){this.transport.reply(P,{supported_versions:n.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var P=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(o.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(G){return P.cachedClientVersions=G.supported_versions,G.supported_versions}).catch(function(G){return console.warn("non-fatal error getting supported client versions: ",G),[]})}},{key:"handleCapabilities",value:function(P){var G=this;return this.capabilitiesFinished?this.transport.reply(P,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(V){return V.includes(n.UnstableApiVersion.MSC2871)?G.once("action:".concat(o.WidgetApiToWidgetAction.NotifyCapabilities),function(Y){G.approvedCapabilities=Y.detail.data.approved,G.emit("ready")}):G.emit("ready"),G.capabilitiesFinished=!0,G.transport.reply(P,{capabilities:G.requestedCapabilities})})}}]),x})(e.EventEmitter);return Ca.WidgetApi=fe,Ca}var _l={},cr={},u_;function hT(){if(u_)return cr;u_=1,Object.defineProperty(cr,"__esModule",{value:!0}),cr.VideoConferenceCapabilities=cr.StickerpickerCapabilities=cr.MatrixCapabilities=void 0,cr.getTimelineRoomIDFromCapability=o,cr.isTimelineCapability=n,cr.isTimelineCapabilityFor=i;var s=(function(u){return u.Screenshots="m.capability.screenshot",u.StickerSending="m.sticker",u.AlwaysOnScreen="m.always_on_screen",u.RequiresClient="io.element.requires_client",u.MSC2931Navigate="org.matrix.msc2931.navigate",u.MSC3846TurnServers="town.robin.msc3846.turn_servers",u.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",u.MSC4039UploadFile="org.matrix.msc4039.upload_file",u.MSC4039DownloadFile="org.matrix.msc4039.download_file",u.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",u.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",u.MSC4407SendStickyEvent="org.matrix.msc4407.send.sticky_event",u.MSC4407ReceiveStickyEvent="org.matrix.msc4407.receive.sticky_event",u})({});cr.MatrixCapabilities=s;var e=[s.StickerSending];cr.StickerpickerCapabilities=e;var t=[s.AlwaysOnScreen];cr.VideoConferenceCapabilities=t;function n(u){return u?.startsWith("org.matrix.msc2762.timeline:")}function i(u,d){return u==="org.matrix.msc2762.timeline:".concat(d)}function o(u){return u.substring(u.indexOf(":")+1)}return cr}var Tl={},c_;function vT(){if(c_)return Tl;c_=1,Object.defineProperty(Tl,"__esModule",{value:!0}),Tl.SimpleObservable=void 0;function s(g){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(S){return typeof S}:function(S){return S&&typeof Symbol=="function"&&S.constructor===Symbol&&S!==Symbol.prototype?"symbol":typeof S},s(g)}function e(g,S){var _=typeof Symbol<"u"&&g[Symbol.iterator]||g["@@iterator"];if(!_){if(Array.isArray(g)||(_=t(g))||S){_&&(g=_);var b=0,T=function(){};return{s:T,n:function(){return b>=g.length?{done:!0}:{done:!1,value:g[b++]}},e:function(O){throw O},f:T}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var k=!0,A=!1,C;return{s:function(){_=_.call(g)},n:function(){var O=_.next();return k=O.done,O},e:function(O){A=!0,C=O},f:function(){try{!k&&_.return!=null&&_.return()}finally{if(A)throw C}}}}function t(g,S){if(g){if(typeof g=="string")return n(g,S);var _=Object.prototype.toString.call(g).slice(8,-1);if(_==="Object"&&g.constructor&&(_=g.constructor.name),_==="Map"||_==="Set")return Array.from(g);if(_==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(_))return n(g,S)}}function n(g,S){(S==null||S>g.length)&&(S=g.length);for(var _=0,b=new Array(S);_<S;_++)b[_]=g[_];return b}function i(g,S){if(!(g instanceof S))throw new TypeError("Cannot call a class as a function")}function o(g,S){for(var _=0;_<S.length;_++){var b=S[_];b.enumerable=b.enumerable||!1,b.configurable=!0,"value"in b&&(b.writable=!0),Object.defineProperty(g,h(b.key),b)}}function u(g,S,_){return S&&o(g.prototype,S),Object.defineProperty(g,"prototype",{writable:!1}),g}function d(g,S,_){return S=h(S),S in g?Object.defineProperty(g,S,{value:_,enumerable:!0,configurable:!0,writable:!0}):g[S]=_,g}function h(g){var S=f(g,"string");return s(S)==="symbol"?S:String(S)}function f(g,S){if(s(g)!=="object"||g===null)return g;var _=g[Symbol.toPrimitive];if(_!==void 0){var b=_.call(g,S);if(s(b)!=="object")return b;throw new TypeError("@@toPrimitive must return a primitive value.")}return(S==="string"?String:Number)(g)}var m=(function(){function g(S){i(this,g),d(this,"listeners",[]),S&&this.listeners.push(S)}return u(g,[{key:"onUpdate",value:function(_){this.listeners.push(_)}},{key:"update",value:function(_){var b=e(this.listeners),T;try{for(b.s();!(T=b.n()).done;){var k=T.value;k(_)}}catch(A){b.e(A)}finally{b.f()}}},{key:"close",value:function(){this.listeners=[]}}]),g})();return Tl.SimpleObservable=m,Tl}var d_;function lA(){if(d_)return _l;d_=1,Object.defineProperty(_l,"__esModule",{value:!0}),_l.ClientWidgetApi=void 0;var s=cd(),e=Xm(),t=Ym(),n=Qm(),i=hT(),o=Jm(),u=$m(),d=Zm(),h=vT(),f=ep(),m=tp();function g(X){"@babel/helpers - typeof";return g=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(fe){return typeof fe}:function(fe){return fe&&typeof Symbol=="function"&&fe.constructor===Symbol&&fe!==Symbol.prototype?"symbol":typeof fe},g(X)}function S(X,fe){var B=Object.keys(X);if(Object.getOwnPropertySymbols){var F=Object.getOwnPropertySymbols(X);fe&&(F=F.filter(function(x){return Object.getOwnPropertyDescriptor(X,x).enumerable})),B.push.apply(B,F)}return B}function _(X){for(var fe=1;fe<arguments.length;fe++){var B=arguments[fe]!=null?arguments[fe]:{};fe%2?S(Object(B),!0).forEach(function(F){pe(X,F,B[F])}):Object.getOwnPropertyDescriptors?Object.defineProperties(X,Object.getOwnPropertyDescriptors(B)):S(Object(B)).forEach(function(F){Object.defineProperty(X,F,Object.getOwnPropertyDescriptor(B,F))})}return X}function b(X,fe){var B=typeof Symbol<"u"&&X[Symbol.iterator]||X["@@iterator"];if(!B){if(Array.isArray(X)||(B=A(X))||fe){B&&(X=B);var F=0,x=function(){};return{s:x,n:function(){return F>=X.length?{done:!0}:{done:!1,value:X[F++]}},e:function(Y){throw Y},f:x}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var j=!0,P=!1,G;return{s:function(){B=B.call(X)},n:function(){var Y=B.next();return j=Y.done,Y},e:function(Y){P=!0,G=Y},f:function(){try{!j&&B.return!=null&&B.return()}finally{if(P)throw G}}}}function T(X){return U(X)||C(X)||A(X)||k()}function k(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function A(X,fe){if(X){if(typeof X=="string")return O(X,fe);var B=Object.prototype.toString.call(X).slice(8,-1);if(B==="Object"&&X.constructor&&(B=X.constructor.name),B==="Map"||B==="Set")return Array.from(X);if(B==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(B))return O(X,fe)}}function C(X){if(typeof Symbol<"u"&&X[Symbol.iterator]!=null||X["@@iterator"]!=null)return Array.from(X)}function U(X){if(Array.isArray(X))return O(X)}function O(X,fe){(fe==null||fe>X.length)&&(fe=X.length);for(var B=0,F=new Array(fe);B<fe;B++)F[B]=X[B];return F}function M(){M=function(){return X};var X={},fe=Object.prototype,B=fe.hasOwnProperty,F=Object.defineProperty||function(Me,be,ee){Me[be]=ee.value},x=typeof Symbol=="function"?Symbol:{},j=x.iterator||"@@iterator",P=x.asyncIterator||"@@asyncIterator",G=x.toStringTag||"@@toStringTag";function V(Me,be,ee){return Object.defineProperty(Me,be,{value:ee,enumerable:!0,configurable:!0,writable:!0}),Me[be]}try{V({},"")}catch{V=function(ee,ae,de){return ee[ae]=de}}function Y(Me,be,ee,ae){var de=be&&be.prototype instanceof ye?be:ye,_e=Object.create(de.prototype),Ne=new ra(ae||[]);return F(_e,"_invoke",{value:gi(Me,ee,Ne)}),_e}function $(Me,be,ee){try{return{type:"normal",arg:Me.call(be,ee)}}catch(ae){return{type:"throw",arg:ae}}}X.wrap=Y;var re={};function ye(){}function Be(){}function Pe(){}var Ae={};V(Ae,j,function(){return this});var qe=Object.getPrototypeOf,pt=qe&&qe(qe(Cr([])));pt&&pt!==fe&&B.call(pt,j)&&(Ae=pt);var xt=Pe.prototype=ye.prototype=Object.create(Ae);function we(Me){["next","throw","return"].forEach(function(be){V(Me,be,function(ee){return this._invoke(be,ee)})})}function ze(Me,be){function ee(de,_e,Ne,xe){var tt=$(Me[de],Me,_e);if(tt.type!=="throw"){var bt=tt.arg,Et=bt.value;return Et&&g(Et)=="object"&&B.call(Et,"__await")?be.resolve(Et.__await).then(function(Bt){ee("next",Bt,Ne,xe)},function(Bt){ee("throw",Bt,Ne,xe)}):be.resolve(Et).then(function(Bt){bt.value=Bt,Ne(bt)},function(Bt){return ee("throw",Bt,Ne,xe)})}xe(tt.arg)}var ae;F(this,"_invoke",{value:function(_e,Ne){function xe(){return new be(function(tt,bt){ee(_e,Ne,tt,bt)})}return ae=ae?ae.then(xe,xe):xe()}})}function gi(Me,be,ee){var ae="suspendedStart";return function(de,_e){if(ae==="executing")throw new Error("Generator is already running");if(ae==="completed"){if(de==="throw")throw _e;return yi()}for(ee.method=de,ee.arg=_e;;){var Ne=ee.delegate;if(Ne){var xe=wr(Ne,ee);if(xe){if(xe===re)continue;return xe}}if(ee.method==="next")ee.sent=ee._sent=ee.arg;else if(ee.method==="throw"){if(ae==="suspendedStart")throw ae="completed",ee.arg;ee.dispatchException(ee.arg)}else ee.method==="return"&&ee.abrupt("return",ee.arg);ae="executing";var tt=$(Me,be,ee);if(tt.type==="normal"){if(ae=ee.done?"completed":"suspendedYield",tt.arg===re)continue;return{value:tt.arg,done:ee.done}}tt.type==="throw"&&(ae="completed",ee.method="throw",ee.arg=tt.arg)}}}function wr(Me,be){var ee=be.method,ae=Me.iterator[ee];if(ae===void 0)return be.delegate=null,ee==="throw"&&Me.iterator.return&&(be.method="return",be.arg=void 0,wr(Me,be),be.method==="throw")||ee!=="return"&&(be.method="throw",be.arg=new TypeError("The iterator does not provide a '"+ee+"' method")),re;var de=$(ae,Me.iterator,be.arg);if(de.type==="throw")return be.method="throw",be.arg=de.arg,be.delegate=null,re;var _e=de.arg;return _e?_e.done?(be[Me.resultName]=_e.value,be.next=Me.nextLoc,be.method!=="return"&&(be.method="next",be.arg=void 0),be.delegate=null,re):_e:(be.method="throw",be.arg=new TypeError("iterator result is not an object"),be.delegate=null,re)}function za(Me){var be={tryLoc:Me[0]};1 in Me&&(be.catchLoc=Me[1]),2 in Me&&(be.finallyLoc=Me[2],be.afterLoc=Me[3]),this.tryEntries.push(be)}function vr(Me){var be=Me.completion||{};be.type="normal",delete be.arg,Me.completion=be}function ra(Me){this.tryEntries=[{tryLoc:"root"}],Me.forEach(za,this),this.reset(!0)}function Cr(Me){if(Me){var be=Me[j];if(be)return be.call(Me);if(typeof Me.next=="function")return Me;if(!isNaN(Me.length)){var ee=-1,ae=function de(){for(;++ee<Me.length;)if(B.call(Me,ee))return de.value=Me[ee],de.done=!1,de;return de.value=void 0,de.done=!0,de};return ae.next=ae}}return{next:yi}}function yi(){return{value:void 0,done:!0}}return Be.prototype=Pe,F(xt,"constructor",{value:Pe,configurable:!0}),F(Pe,"constructor",{value:Be,configurable:!0}),Be.displayName=V(Pe,G,"GeneratorFunction"),X.isGeneratorFunction=function(Me){var be=typeof Me=="function"&&Me.constructor;return!!be&&(be===Be||(be.displayName||be.name)==="GeneratorFunction")},X.mark=function(Me){return Object.setPrototypeOf?Object.setPrototypeOf(Me,Pe):(Me.__proto__=Pe,V(Me,G,"GeneratorFunction")),Me.prototype=Object.create(xt),Me},X.awrap=function(Me){return{__await:Me}},we(ze.prototype),V(ze.prototype,P,function(){return this}),X.AsyncIterator=ze,X.async=function(Me,be,ee,ae,de){de===void 0&&(de=Promise);var _e=new ze(Y(Me,be,ee,ae),de);return X.isGeneratorFunction(be)?_e:_e.next().then(function(Ne){return Ne.done?Ne.value:_e.next()})},we(xt),V(xt,G,"Generator"),V(xt,j,function(){return this}),V(xt,"toString",function(){return"[object Generator]"}),X.keys=function(Me){var be=Object(Me),ee=[];for(var ae in be)ee.push(ae);return ee.reverse(),function de(){for(;ee.length;){var _e=ee.pop();if(_e in be)return de.value=_e,de.done=!1,de}return de.done=!0,de}},X.values=Cr,ra.prototype={constructor:ra,reset:function(be){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(vr),!be)for(var ee in this)ee.charAt(0)==="t"&&B.call(this,ee)&&!isNaN(+ee.slice(1))&&(this[ee]=void 0)},stop:function(){this.done=!0;var be=this.tryEntries[0].completion;if(be.type==="throw")throw be.arg;return this.rval},dispatchException:function(be){if(this.done)throw be;var ee=this;function ae(bt,Et){return Ne.type="throw",Ne.arg=be,ee.next=bt,Et&&(ee.method="next",ee.arg=void 0),!!Et}for(var de=this.tryEntries.length-1;de>=0;--de){var _e=this.tryEntries[de],Ne=_e.completion;if(_e.tryLoc==="root")return ae("end");if(_e.tryLoc<=this.prev){var xe=B.call(_e,"catchLoc"),tt=B.call(_e,"finallyLoc");if(xe&&tt){if(this.prev<_e.catchLoc)return ae(_e.catchLoc,!0);if(this.prev<_e.finallyLoc)return ae(_e.finallyLoc)}else if(xe){if(this.prev<_e.catchLoc)return ae(_e.catchLoc,!0)}else{if(!tt)throw new Error("try statement without catch or finally");if(this.prev<_e.finallyLoc)return ae(_e.finallyLoc)}}}},abrupt:function(be,ee){for(var ae=this.tryEntries.length-1;ae>=0;--ae){var de=this.tryEntries[ae];if(de.tryLoc<=this.prev&&B.call(de,"finallyLoc")&&this.prev<de.finallyLoc){var _e=de;break}}_e&&(be==="break"||be==="continue")&&_e.tryLoc<=ee&&ee<=_e.finallyLoc&&(_e=null);var Ne=_e?_e.completion:{};return Ne.type=be,Ne.arg=ee,_e?(this.method="next",this.next=_e.finallyLoc,re):this.complete(Ne)},complete:function(be,ee){if(be.type==="throw")throw be.arg;return be.type==="break"||be.type==="continue"?this.next=be.arg:be.type==="return"?(this.rval=this.arg=be.arg,this.method="return",this.next="end"):be.type==="normal"&&ee&&(this.next=ee),re},finish:function(be){for(var ee=this.tryEntries.length-1;ee>=0;--ee){var ae=this.tryEntries[ee];if(ae.finallyLoc===be)return this.complete(ae.completion,ae.afterLoc),vr(ae),re}},catch:function(be){for(var ee=this.tryEntries.length-1;ee>=0;--ee){var ae=this.tryEntries[ee];if(ae.tryLoc===be){var de=ae.completion;if(de.type==="throw"){var _e=de.arg;vr(ae)}return _e}}throw new Error("illegal catch attempt")},delegateYield:function(be,ee,ae){return this.delegate={iterator:Cr(be),resultName:ee,nextLoc:ae},this.method==="next"&&(this.arg=void 0),re}},X}function E(X,fe,B,F,x,j,P){try{var G=X[j](P),V=G.value}catch(Y){B(Y);return}G.done?fe(V):Promise.resolve(V).then(F,x)}function I(X){return function(){var fe=this,B=arguments;return new Promise(function(F,x){var j=X.apply(fe,B);function P(V){E(j,F,x,P,G,"next",V)}function G(V){E(j,F,x,P,G,"throw",V)}P(void 0)})}}function w(X,fe){if(!(X instanceof fe))throw new TypeError("Cannot call a class as a function")}function q(X,fe){for(var B=0;B<fe.length;B++){var F=fe[B];F.enumerable=F.enumerable||!1,F.configurable=!0,"value"in F&&(F.writable=!0),Object.defineProperty(X,Te(F.key),F)}}function z(X,fe,B){return fe&&q(X.prototype,fe),Object.defineProperty(X,"prototype",{writable:!1}),X}function ue(X,fe){if(typeof fe!="function"&&fe!==null)throw new TypeError("Super expression must either be null or a function");X.prototype=Object.create(fe&&fe.prototype,{constructor:{value:X,writable:!0,configurable:!0}}),Object.defineProperty(X,"prototype",{writable:!1}),fe&&Se(X,fe)}function Se(X,fe){return Se=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(F,x){return F.__proto__=x,F},Se(X,fe)}function Ie(X){var fe=J();return function(){var F=oe(X),x;if(fe){var j=oe(this).constructor;x=Reflect.construct(F,arguments,j)}else x=F.apply(this,arguments);return Ze(this,x)}}function Ze(X,fe){if(fe&&(g(fe)==="object"||typeof fe=="function"))return fe;if(fe!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return me(X)}function me(X){if(X===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return X}function J(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function oe(X){return oe=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(B){return B.__proto__||Object.getPrototypeOf(B)},oe(X)}function pe(X,fe,B){return fe=Te(fe),fe in X?Object.defineProperty(X,fe,{value:B,enumerable:!0,configurable:!0,writable:!0}):X[fe]=B,X}function Te(X){var fe=De(X,"string");return g(fe)==="symbol"?fe:String(fe)}function De(X,fe){if(g(X)!=="object"||X===null)return X;var B=X[Symbol.toPrimitive];if(B!==void 0){var F=B.call(X,fe);if(g(F)!=="object")return F;throw new TypeError("@@toPrimitive must return a primitive value.")}return(fe==="string"?String:Number)(X)}function H(X){var fe,B,F,x=2;for(typeof Symbol<"u"&&(B=Symbol.asyncIterator,F=Symbol.iterator);x--;){if(B&&(fe=X[B])!=null)return fe.call(X);if(F&&(fe=X[F])!=null)return new le(fe.call(X));B="@@asyncIterator",F="@@iterator"}throw new TypeError("Object is not async iterable")}function le(X){function fe(B){if(Object(B)!==B)return Promise.reject(new TypeError(B+" is not an object."));var F=B.done;return Promise.resolve(B.value).then(function(x){return{value:x,done:F}})}return le=function(F){this.s=F,this.n=F.next},le.prototype={s:null,n:null,next:function(){return fe(this.n.apply(this.s,arguments))},return:function(F){var x=this.s.return;return x===void 0?Promise.resolve({value:F,done:!0}):fe(x.apply(this.s,arguments))},throw:function(F){var x=this.s.return;return x===void 0?Promise.reject(F):fe(x.apply(this.s,arguments))}},new le(X)}var Re=(function(X){ue(B,X);var fe=Ie(B);function B(F,x,j){var P;if(w(this,B),P=fe.call(this),P.widget=F,P.driver=j,pe(me(P),"transport",void 0),pe(me(P),"cachedWidgetVersions",null),pe(me(P),"contentLoadedActionSent",!1),pe(me(P),"allowedCapabilities",new Set),pe(me(P),"allowedEvents",[]),pe(me(P),"isStopped",!1),pe(me(P),"turnServers",null),pe(me(P),"contentLoadedWaitTimer",void 0),pe(me(P),"pushRoomStateTasks",new Set),pe(me(P),"pushRoomStateResult",new Map),pe(me(P),"flushRoomStateTask",null),pe(me(P),"viewedRoomId",null),!(x!=null&&x.contentWindow))throw new Error("No iframe supplied");if(!F)throw new Error("Invalid widget");if(!j)throw new Error("Invalid driver");return P.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,F.id,x.contentWindow,globalThis),P.transport.targetOrigin=F.origin,P.transport.on("message",P.handleMessage.bind(me(P))),x.addEventListener("load",P.onIframeLoad.bind(me(P))),P.transport.start(),P}return z(B,[{key:"hasCapability",value:function(x){return this.allowedCapabilities.has(x)}},{key:"canUseRoomTimeline",value:function(x){return this.hasCapability("org.matrix.msc2762.timeline:".concat(f.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(x))}},{key:"canSendRoomEvent",value:function(x){var j=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(P){return P.matchesAsRoomEvent(u.EventDirection.Send,x,j)})}},{key:"canSendStateEvent",value:function(x,j){return this.allowedEvents.some(function(P){return P.matchesAsStateEvent(u.EventDirection.Send,x,j)})}},{key:"canSendToDeviceEvent",value:function(x){return this.allowedEvents.some(function(j){return j.matchesAsToDeviceEvent(u.EventDirection.Send,x)})}},{key:"canReceiveRoomEvent",value:function(x){var j=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(P){return P.matchesAsRoomEvent(u.EventDirection.Receive,x,j)})}},{key:"canReceiveStateEvent",value:function(x,j){return this.allowedEvents.some(function(P){return P.matchesAsStateEvent(u.EventDirection.Receive,x,j)})}},{key:"canReceiveToDeviceEvent",value:function(x){return this.allowedEvents.some(function(j){return j.matchesAsToDeviceEvent(u.EventDirection.Receive,x)})}},{key:"canReceiveRoomAccountData",value:function(x){return this.allowedEvents.some(function(j){return j.matchesAsRoomAccountData(u.EventDirection.Receive,x)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:(function(){var F=I(M().mark(function j(){var P;return M().wrap(function(V){for(;;)switch(V.prev=V.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){V.next=2;break}return V.abrupt("return",this.cachedWidgetVersions);case 2:return V.prev=2,V.next=5,this.transport.send(n.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return P=V.sent,this.cachedWidgetVersions=P.supported_versions,V.abrupt("return",P.supported_versions);case 10:return V.prev=10,V.t0=V.catch(2),console.warn("non-fatal error getting supported widget versions: ",V.t0),V.abrupt("return",[]);case 14:case"end":return V.stop()}},j,this,[[2,10]])}));function x(){return F.apply(this,arguments)}return x})()},{key:"beginCapabilities",value:function(){var x=this;this.emit("preparing");var j;this.transport.send(n.WidgetApiToWidgetAction.Capabilities,{}).then(function(P){return j=P.capabilities,x.driver.validateCapabilities(new Set(P.capabilities))}).then(function(P){x.allowCapabilities(T(P),j),x.emit("ready")}).catch(function(P){x.emit("error:preparing",P)})}},{key:"allowCapabilities",value:function(x,j){var P,G=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),x);var V=b(x),Y;try{for(V.s();!(Y=V.n()).done;){var $=Y.value;this.allowedCapabilities.add($)}}catch(we){V.e(we)}finally{V.f()}var re=u.WidgetEventCapability.findEventCapabilities(x);(P=this.allowedEvents).push.apply(P,T(re)),this.transport.send(n.WidgetApiToWidgetAction.NotifyCapabilities,{requested:j,approved:Array.from(this.allowedCapabilities)}).catch(function(we){console.warn("non-fatal error notifying widget of approved capabilities:",we)}).then(function(){G.emit("capabilitiesNotified")});var ye=b(x),Be;try{for(ye.s();!(Be=ye.n()).done;){var Pe=Be.value;if((0,i.isTimelineCapability)(Pe)){var Ae=(0,i.getTimelineRoomIDFromCapability)(Pe);if(Ae===f.Symbols.AnyRoom){var qe=b(this.driver.getKnownRooms()),pt;try{for(qe.s();!(pt=qe.n()).done;){var xt=pt.value;this.pushRoomState(xt)}}catch(we){qe.e(we)}finally{qe.f()}}else this.pushRoomState(Ae)}}}catch(we){ye.e(we)}finally{ye.f()}re.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(x){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(x){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(x,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(x,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(x){this.transport.reply(x,{supported_versions:o.CurrentApiVersions})}},{key:"supportsUpdateState",value:(function(){var F=I(M().mark(function j(){return M().wrap(function(G){for(;;)switch(G.prev=G.next){case 0:return G.next=2,this.getWidgetVersions();case 2:return G.abrupt("return",G.sent.includes(o.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return G.stop()}},j,this)}));function x(){return F.apply(this,arguments)}return x})()},{key:"handleCapabilitiesRenegotiate",value:function(x){var j,P=this;this.transport.reply(x,{});var G=((j=x.data)===null||j===void 0?void 0:j.capabilities)||[],V=new Set(G.filter(function(Y){return!P.hasCapability(Y)}));V.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(V).then(function(Y){return P.allowCapabilities(T(Y),T(V))})}},{key:"handleNavigate",value:function(x){var j,P=this;if(!this.hasCapability(i.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(x,{error:{message:"Missing capability"}});if(!((j=x.data)!==null&&j!==void 0&&j.uri.startsWith("https://matrix.to/#")))return this.transport.reply(x,{error:{message:"Invalid matrix.to URI"}});var G=function(Y){console.error("[ClientWidgetApi] Failed to handle navigation: ",Y),P.handleDriverError(Y,x,"Error handling navigation")};try{this.driver.navigate(x.data.uri.toString()).catch(function(V){return G(V)}).then(function(){return P.transport.reply(x,{})})}catch(V){return G(V)}}},{key:"handleOIDC",value:function(x){var j=this,P=1,G=function(re,ye){return ye=ye||{},P>1?j.transport.send(n.WidgetApiToWidgetAction.OpenIDCredentials,_({state:re,original_request_id:x.requestId},ye)):j.transport.reply(x,_({state:re},ye))},V=function(re){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",re),P>1?G(d.OpenIDRequestState.Blocked):j.transport.reply(x,{error:{message:re}})},Y=new h.SimpleObservable(function($){if($.state===d.OpenIDRequestState.PendingUserConfirmation&&P>1)return Y.close(),V("client provided out-of-phase response to OIDC flow");if($.state===d.OpenIDRequestState.PendingUserConfirmation){G($.state),P++;return}return $.state===d.OpenIDRequestState.Allowed&&!$.token?V("client provided invalid OIDC token for an allowed request"):($.state===d.OpenIDRequestState.Blocked&&($.token=void 0),Y.close(),G($.state,$.token))});this.driver.askOpenID(Y)}},{key:"handleReadRoomAccountData",value:function(x){var j=this,P=this.driver.readRoomAccountData(x.data.type);return this.canReceiveRoomAccountData(x.data.type)?P.then(function(G){j.transport.reply(x,{events:G})}):this.transport.reply(x,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:(function(){var F=I(M().mark(function j(P){var G=this,V,Y,$,re,ye,Be,Pe,Ae,qe,pt;return M().wrap(function(we){for(;;)switch(we.prev=we.next){case 0:if(P.data.type){we.next=2;break}return we.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(P.data.limit!==void 0&&(!P.data.limit||P.data.limit<0))){we.next=4;break}return we.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 4:if(P.data.room_ids!==void 0){we.next=8;break}V=this.viewedRoomId===null?[]:[this.viewedRoomId],we.next=30;break;case 8:if(P.data.room_ids!==f.Symbols.AnyRoom){we.next=12;break}V=this.driver.getKnownRooms().filter(function(ze){return G.canUseRoomTimeline(ze)}),we.next=30;break;case 12:V=P.data.room_ids,Y=b(V),we.prev=14,Y.s();case 16:if(($=Y.n()).done){we.next=22;break}if(re=$.value,this.canUseRoomTimeline(re)){we.next=20;break}return we.abrupt("return",this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(re)}}));case 20:we.next=16;break;case 22:we.next=27;break;case 24:we.prev=24,we.t0=we.catch(14),Y.e(we.t0);case 27:return we.prev=27,Y.f(),we.finish(27);case 30:if(ye=P.data.limit||0,Be=P.data.since,Pe=void 0,Ae=void 0,P.data.state_key===void 0){we.next=40;break}if(Pe=P.data.state_key===!0?void 0:P.data.state_key.toString(),this.canReceiveStateEvent(P.data.type,(qe=Pe)!==null&&qe!==void 0?qe:null)){we.next=38;break}return we.abrupt("return",this.transport.reply(P,{error:{message:"Cannot read state events of this type"}}));case 38:we.next=43;break;case 40:if(Ae=P.data.msgtype,this.canReceiveRoomEvent(P.data.type,Ae)){we.next=43;break}return we.abrupt("return",this.transport.reply(P,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(P.data.room_ids===void 0&&V.length===0)){we.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),we.next=47,P.data.state_key===void 0?this.driver.readRoomEvents(P.data.type,Ae,ye,null,Be):this.driver.readStateEvents(P.data.type,Pe,ye,null);case 47:pt=we.sent,we.next=68;break;case 50:return we.next=52,this.supportsUpdateState();case 52:if(!we.sent){we.next=58;break}return we.next=55,Promise.all(V.map(function(ze){return G.driver.readRoomTimeline(ze,P.data.type,Ae,Pe,ye,Be)}));case 55:pt=we.sent.flat(1),we.next=68;break;case 58:if(P.data.state_key!==void 0){we.next=64;break}return we.next=61,Promise.all(V.map(function(ze){return G.driver.readRoomTimeline(ze,P.data.type,Ae,Pe,ye,Be)}));case 61:we.t1=we.sent,we.next=67;break;case 64:return we.next=66,Promise.all(V.map(function(ze){return G.driver.readRoomState(ze,P.data.type,Pe)}));case 66:we.t1=we.sent;case 67:pt=we.t1.flat(1);case 68:this.transport.reply(P,{events:pt});case 69:case"end":return we.stop()}},j,this,[[14,24,27,30]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleSendEvent",value:function(x){var j=this;if(!x.data.type)return this.transport.reply(x,{error:{message:"Invalid request - missing event type"}});if(x.data.room_id&&!this.canUseRoomTimeline(x.data.room_id))return this.transport.reply(x,{error:{message:"Unable to access room timeline: ".concat(x.data.room_id)}});var P=x.data.delay!==void 0||x.data.parent_delay_id!==void 0;if(P&&!this.hasCapability(i.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(x,{error:{message:"Missing capability for ".concat(i.MatrixCapabilities.MSC4157SendDelayedEvent)}});var G=x.data.sticky_duration_ms!==void 0;if(G&&!this.hasCapability(i.MatrixCapabilities.MSC4407SendStickyEvent))return this.transport.reply(x,{error:{message:"Missing capability for ".concat(i.MatrixCapabilities.MSC4407SendStickyEvent)}});var V;if(x.data.state_key!==void 0){if(!this.canSendStateEvent(x.data.type,x.data.state_key))return this.transport.reply(x,{error:{message:"Cannot send state events of this type"}});if(G)return this.transport.reply(x,{error:{message:"Cannot send a state event with a sticky duration"}});if(P){var Y,$;V=this.driver.sendDelayedEvent((Y=x.data.delay)!==null&&Y!==void 0?Y:null,($=x.data.parent_delay_id)!==null&&$!==void 0?$:null,x.data.type,x.data.content||{},x.data.state_key,x.data.room_id)}else V=this.driver.sendEvent(x.data.type,x.data.content||{},x.data.state_key,x.data.room_id)}else{var re=x.data.content||{},ye=re.msgtype;if(!this.canSendRoomEvent(x.data.type,ye))return this.transport.reply(x,{error:{message:"Cannot send room events of this type"}});var Be=[x.data.type,re,null,x.data.room_id];if(P&&x.data.sticky_duration_ms){var Pe,Ae;V=this.driver.sendDelayedStickyEvent((Pe=x.data.delay)!==null&&Pe!==void 0?Pe:null,(Ae=x.data.parent_delay_id)!==null&&Ae!==void 0?Ae:null,x.data.sticky_duration_ms,x.data.type,re,x.data.room_id)}else if(P){var qe,pt,xt;V=(qe=this.driver).sendDelayedEvent.apply(qe,[(pt=x.data.delay)!==null&&pt!==void 0?pt:null,(xt=x.data.parent_delay_id)!==null&&xt!==void 0?xt:null].concat(Be))}else if(x.data.sticky_duration_ms)V=this.driver.sendStickyEvent(x.data.sticky_duration_ms,x.data.type,re,x.data.room_id);else{var we;V=(we=this.driver).sendEvent.apply(we,Be)}}V.then(function(ze){return j.transport.reply(x,_({room_id:ze.roomId},"eventId"in ze?{event_id:ze.eventId}:{delay_id:ze.delayId}))}).catch(function(ze){console.error("error sending event: ",ze),j.handleDriverError(ze,x,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(x){var j=this;if(!x.data.delay_id)return this.transport.reply(x,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(i.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(x,{error:{message:"Missing capability"}});var P;switch(x.data.action){case m.UpdateDelayedEventAction.Cancel:P=this.driver.cancelScheduledDelayedEvent;break;case m.UpdateDelayedEventAction.Restart:P=this.driver.restartScheduledDelayedEvent;break;case m.UpdateDelayedEventAction.Send:P=this.driver.sendScheduledDelayedEvent;break;default:return this.transport.reply(x,{error:{message:"Invalid request - unsupported action"}})}P.call(this.driver,x.data.delay_id).then(function(){return j.transport.reply(x,{})}).catch(function(G){console.error("error updating delayed event: ",G),j.handleDriverError(G,x,"Error updating delayed event")})}},{key:"handleSendToDevice",value:(function(){var F=I(M().mark(function j(P){return M().wrap(function(V){for(;;)switch(V.prev=V.next){case 0:if(P.data.type){V.next=4;break}this.transport.reply(P,{error:{message:"Invalid request - missing event type"}}),V.next=26;break;case 4:if(P.data.messages){V.next=8;break}this.transport.reply(P,{error:{message:"Invalid request - missing event contents"}}),V.next=26;break;case 8:if(typeof P.data.encrypted=="boolean"){V.next=12;break}this.transport.reply(P,{error:{message:"Invalid request - missing encryption flag"}}),V.next=26;break;case 12:if(this.canSendToDeviceEvent(P.data.type)){V.next=16;break}this.transport.reply(P,{error:{message:"Cannot send to-device events of this type"}}),V.next=26;break;case 16:return V.prev=16,V.next=19,this.driver.sendToDevice(P.data.type,P.data.encrypted,P.data.messages);case 19:this.transport.reply(P,{}),V.next=26;break;case 22:V.prev=22,V.t0=V.catch(16),console.error("error sending to-device event",V.t0),this.handleDriverError(V.t0,P,"Error sending event");case 26:case"end":return V.stop()}},j,this,[[16,22]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"pollTurnServers",value:(function(){var F=I(M().mark(function j(P,G){var V,Y,$,re,ye,Be;return M().wrap(function(Ae){for(;;)switch(Ae.prev=Ae.next){case 0:return Ae.prev=0,Ae.next=3,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,G);case 3:V=!1,Y=!1,Ae.prev=5,re=H(P);case 7:return Ae.next=9,re.next();case 9:if(!(V=!(ye=Ae.sent).done)){Ae.next=16;break}return Be=ye.value,Ae.next=13,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,Be);case 13:V=!1,Ae.next=7;break;case 16:Ae.next=22;break;case 18:Ae.prev=18,Ae.t0=Ae.catch(5),Y=!0,$=Ae.t0;case 22:if(Ae.prev=22,Ae.prev=23,!(V&&re.return!=null)){Ae.next=27;break}return Ae.next=27,re.return();case 27:if(Ae.prev=27,!Y){Ae.next=30;break}throw $;case 30:return Ae.finish(27);case 31:return Ae.finish(22);case 32:Ae.next=37;break;case 34:Ae.prev=34,Ae.t1=Ae.catch(0),console.error("error polling for TURN servers",Ae.t1);case 37:case"end":return Ae.stop()}},j,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function x(j,P){return F.apply(this,arguments)}return x})()},{key:"handleWatchTurnServers",value:(function(){var F=I(M().mark(function j(P){var G,V,Y,$;return M().wrap(function(ye){for(;;)switch(ye.prev=ye.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){ye.next=4;break}this.transport.reply(P,{error:{message:"Missing capability"}}),ye.next=26;break;case 4:if(!this.turnServers){ye.next=8;break}this.transport.reply(P,{}),ye.next=26;break;case 8:return ye.prev=8,G=this.driver.getTurnServers(),ye.next=12,G.next();case 12:if(V=ye.sent,Y=V.done,$=V.value,!Y){ye.next=17;break}throw new Error("Client refuses to provide any TURN servers");case 17:this.transport.reply(P,{}),this.pollTurnServers(G,$),this.turnServers=G,ye.next=26;break;case 22:ye.prev=22,ye.t0=ye.catch(8),console.error("error getting first TURN server results",ye.t0),this.transport.reply(P,{error:{message:"TURN servers not available"}});case 26:case"end":return ye.stop()}},j,this,[[8,22]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleUnwatchTurnServers",value:(function(){var F=I(M().mark(function j(P){return M().wrap(function(V){for(;;)switch(V.prev=V.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){V.next=4;break}this.transport.reply(P,{error:{message:"Missing capability"}}),V.next=12;break;case 4:if(this.turnServers){V.next=8;break}this.transport.reply(P,{}),V.next=12;break;case 8:return V.next=10,this.turnServers.return(void 0);case 10:this.turnServers=null,this.transport.reply(P,{});case 12:case"end":return V.stop()}},j,this)}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleReadRelations",value:(function(){var F=I(M().mark(function j(P){var G=this,V,Y;return M().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:if(P.data.event_id){re.next=2;break}return re.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(P.data.limit!==void 0&&P.data.limit<0)){re.next=4;break}return re.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(P.data.room_id!==void 0&&!this.canUseRoomTimeline(P.data.room_id))){re.next=6;break}return re.abrupt("return",this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(P.data.room_id)}}));case 6:return re.prev=6,re.next=9,this.driver.readEventRelations(P.data.event_id,P.data.room_id,P.data.rel_type,P.data.event_type,P.data.from,P.data.to,P.data.limit,P.data.direction);case 9:return V=re.sent,Y=V.chunk.filter(function(ye){return ye.state_key!==void 0?G.canReceiveStateEvent(ye.type,ye.state_key):G.canReceiveRoomEvent(ye.type,ye.content.msgtype)}),re.abrupt("return",this.transport.reply(P,{chunk:Y,prev_batch:V.prevBatch,next_batch:V.nextBatch}));case 14:re.prev=14,re.t0=re.catch(6),console.error("error getting the relations",re.t0),this.handleDriverError(re.t0,P,"Unexpected error while reading relations");case 18:case"end":return re.stop()}},j,this,[[6,14]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleUserDirectorySearch",value:(function(){var F=I(M().mark(function j(P){var G;return M().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3973UserDirectorySearch)){Y.next=2;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:if(typeof P.data.search_term=="string"){Y.next=4;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(P.data.limit!==void 0&&P.data.limit<0)){Y.next=6;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 6:return Y.prev=6,Y.next=9,this.driver.searchUserDirectory(P.data.search_term,P.data.limit);case 9:return G=Y.sent,Y.abrupt("return",this.transport.reply(P,{limited:G.limited,results:G.results.map(function($){return{user_id:$.userId,display_name:$.displayName,avatar_url:$.avatarUrl}})}));case 13:Y.prev=13,Y.t0=Y.catch(6),console.error("error searching in the user directory",Y.t0),this.handleDriverError(Y.t0,P,"Unexpected error while searching in the user directory");case 17:case"end":return Y.stop()}},j,this,[[6,13]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleGetMediaConfig",value:(function(){var F=I(M().mark(function j(P){var G;return M().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){Y.next=2;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return Y.prev=2,Y.next=5,this.driver.getMediaConfig();case 5:return G=Y.sent,Y.abrupt("return",this.transport.reply(P,G));case 9:Y.prev=9,Y.t0=Y.catch(2),console.error("error while getting the media configuration",Y.t0),this.handleDriverError(Y.t0,P,"Unexpected error while getting the media configuration");case 13:case"end":return Y.stop()}},j,this,[[2,9]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleUploadFile",value:(function(){var F=I(M().mark(function j(P){var G;return M().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){Y.next=2;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return Y.prev=2,Y.next=5,this.driver.uploadFile(P.data.file);case 5:return G=Y.sent,Y.abrupt("return",this.transport.reply(P,{content_uri:G.contentUri}));case 9:Y.prev=9,Y.t0=Y.catch(2),console.error("error while uploading a file",Y.t0),this.handleDriverError(Y.t0,P,"Unexpected error while uploading a file");case 13:case"end":return Y.stop()}},j,this,[[2,9]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleDownloadFile",value:(function(){var F=I(M().mark(function j(P){var G;return M().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039DownloadFile)){Y.next=2;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return Y.prev=2,Y.next=5,this.driver.downloadFile(P.data.content_uri);case 5:return G=Y.sent,Y.abrupt("return",this.transport.reply(P,{file:G.file}));case 9:Y.prev=9,Y.t0=Y.catch(2),console.error("error while downloading a file",Y.t0),this.handleDriverError(Y.t0,P,"Unexpected error while downloading a file");case 13:case"end":return Y.stop()}},j,this,[[2,9]])}));function x(j){return F.apply(this,arguments)}return x})()},{key:"handleDriverError",value:function(x,j,P){var G=this.driver.processError(x);this.transport.reply(j,{error:_({message:P},G)})}},{key:"handleMessage",value:function(x){if(!this.isStopped){var j=new CustomEvent("action:".concat(x.detail.action),{detail:x.detail,cancelable:!0});if(this.emit("action:".concat(x.detail.action),j),!j.defaultPrevented)switch(x.detail.action){case n.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(x.detail);case n.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(x.detail);case n.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(x.detail);case n.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(x.detail);case n.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(x.detail);case n.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(x.detail);case n.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(x.detail);case n.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(x.detail);case n.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(x.detail);case n.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(x.detail);case n.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(x.detail);case n.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(x.detail);case n.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(x.detail);case n.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(x.detail);case n.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(x.detail);case n.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(x.detail);case n.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(x.detail);default:return this.transport.reply(x.detail,{error:{message:"Unknown or unsupported action: "+x.detail.action}})}}}},{key:"updateTheme",value:function(x){return this.transport.send(n.WidgetApiToWidgetAction.ThemeChange,x)}},{key:"updateLanguage",value:function(x){return this.transport.send(n.WidgetApiToWidgetAction.LanguageChange,{lang:x})}},{key:"takeScreenshot",value:function(){return this.transport.send(n.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(x){return this.transport.send(n.WidgetApiToWidgetAction.UpdateVisibility,{visible:x})}},{key:"sendWidgetConfig",value:function(x){return this.transport.send(n.WidgetApiToWidgetAction.WidgetConfig,x).then()}},{key:"notifyModalWidgetButtonClicked",value:function(x){return this.transport.send(n.WidgetApiToWidgetAction.ButtonClicked,{id:x}).then()}},{key:"notifyModalWidgetClose",value:function(x){return this.transport.send(n.WidgetApiToWidgetAction.CloseModalWidget,x).then()}},{key:"feedEvent",value:(function(){var F=I(M().mark(function j(P,G){var V;return M().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(G!==void 0&&this.setViewedRoomId(G),!(P.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(P.room_id))){$.next=3;break}return $.abrupt("return");case 3:if(!(P.state_key!==void 0&&P.state_key!==null)){$.next=8;break}if(this.canReceiveStateEvent(P.type,P.state_key)){$.next=6;break}return $.abrupt("return");case 6:$.next=10;break;case 8:if(this.canReceiveRoomEvent(P.type,(V=P.content)===null||V===void 0?void 0:V.msgtype)){$.next=10;break}return $.abrupt("return");case 10:return $.next=12,this.transport.send(n.WidgetApiToWidgetAction.SendEvent,P);case 12:case"end":return $.stop()}},j,this)}));function x(j,P){return F.apply(this,arguments)}return x})()},{key:"feedToDevice",value:(function(){var F=I(M().mark(function j(P,G){return M().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(!this.canReceiveToDeviceEvent(P.type)){Y.next=3;break}return Y.next=3,this.transport.send(n.WidgetApiToWidgetAction.SendToDevice,_(_({},P),{},{encrypted:G}));case 3:case"end":return Y.stop()}},j,this)}));function x(j,P){return F.apply(this,arguments)}return x})()},{key:"setViewedRoomId",value:function(x){this.viewedRoomId=x,x!==null&&!this.canUseRoomTimeline(x)&&this.pushRoomState(x)}},{key:"flushRoomState",value:(function(){var F=I(M().mark(function j(){var P,G,V,Y,$,re,ye;return M().wrap(function(Pe){for(;;)switch(Pe.prev=Pe.next){case 0:Pe.prev=0;case 1:return Pe.next=3,Promise.all(this.pushRoomStateTasks);case 3:if(this.pushRoomStateTasks.size>0){Pe.next=1;break}case 4:P=[],G=b(this.pushRoomStateResult.values());try{for(G.s();!(V=G.n()).done;){Y=V.value,$=b(Y.values());try{for($.s();!(re=$.n()).done;)ye=re.value,P.push.apply(P,T(ye.values()))}catch(Ae){$.e(Ae)}finally{$.f()}}}catch(Ae){G.e(Ae)}finally{G.f()}return Pe.next=9,this.getWidgetVersions();case 9:if(!Pe.sent.includes(o.UnstableApiVersion.MSC2762_UPDATE_STATE)){Pe.next=12;break}return Pe.next=12,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:P});case 12:return Pe.prev=12,this.flushRoomStateTask=null,Pe.finish(12);case 15:case"end":return Pe.stop()}},j,this,[[0,,12,15]])}));function x(){return F.apply(this,arguments)}return x})()},{key:"pushRoomState",value:function(x){var j=this,P=b(this.allowedEvents),G;try{var V=function(){var $=G.value;if($.kind===u.EventKind.State&&$.direction===u.EventDirection.Receive){var re,ye,Be=j.driver.readRoomState(x,$.eventType,(re=$.keyStr)!==null&&re!==void 0?re:void 0),Pe=Be.then(function(Ae){var qe=b(Ae),pt;try{for(qe.s();!(pt=qe.n()).done;){var xt=pt.value,we=j.pushRoomStateResult.get(x);we===void 0&&(we=new Map,j.pushRoomStateResult.set(x,we));var ze=we.get($.eventType);ze===void 0&&(ze=new Map,we.set($.eventType,ze)),ze.has(xt.state_key)||ze.set(xt.state_key,xt)}}catch(gi){qe.e(gi)}finally{qe.f()}},function(Ae){return console.error("Failed to read room state for ".concat(x," (").concat($.eventType,", ").concat($.keyStr,")"),Ae)}).then(function(){j.pushRoomStateTasks.delete(Pe)});j.pushRoomStateTasks.add(Pe),(ye=j.flushRoomStateTask)!==null&&ye!==void 0||(j.flushRoomStateTask=j.flushRoomState()),j.flushRoomStateTask.catch(function(Ae){return console.error("Failed to push room state",Ae)})}};for(P.s();!(G=P.n()).done;)V()}catch(Y){P.e(Y)}finally{P.f()}}},{key:"feedStateUpdate",value:(function(){var F=I(M().mark(function j(P){var G,V;return M().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(P.state_key!==void 0){$.next=2;break}throw new Error("Not a state event");case 2:if(!((P.room_id===this.viewedRoomId||this.canUseRoomTimeline(P.room_id))&&this.canReceiveStateEvent(P.type,P.state_key))){$.next=21;break}if(this.pushRoomStateTasks.size!==0){$.next=11;break}return $.next=6,this.getWidgetVersions();case 6:if(!$.sent.includes(o.UnstableApiVersion.MSC2762_UPDATE_STATE)){$.next=9;break}return $.next=9,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:[P]});case 9:$.next=21;break;case 11:G=this.pushRoomStateResult.get(P.room_id),G===void 0&&(G=new Map,this.pushRoomStateResult.set(P.room_id,G)),V=G.get(P.type),V===void 0&&(V=new Map,G.set(P.type,V)),V.has(P.type)||V.set(P.state_key,P);case 16:return $.next=18,Promise.all(this.pushRoomStateTasks);case 18:if(this.pushRoomStateTasks.size>0){$.next=16;break}case 19:return $.next=21,this.flushRoomStateTask;case 21:case"end":return $.stop()}},j,this)}));function x(j){return F.apply(this,arguments)}return x})()}]),B})(s.EventEmitter);return _l.ClientWidgetApi=Re,_l}var kc={},f_;function uA(){if(f_)return kc;f_=1,Object.defineProperty(kc,"__esModule",{value:!0}),kc.isErrorResponse=e;function s(t){"@babel/helpers - typeof";return s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},s(t)}function e(t){var n=t.error;return s(n)==="object"&&n!==null&&"message"in n&&typeof n.message=="string"}return kc}var Rl={},h_;function cA(){if(h_)return Rl;h_=1,Object.defineProperty(Rl,"__esModule",{value:!0}),Rl.WidgetKind=void 0;var s=(function(e){return e.Room="room",e.Account="account",e.Modal="modal",e})({});return Rl.WidgetKind=s,Rl}var wl={},v_;function dA(){if(v_)return wl;v_=1,Object.defineProperty(wl,"__esModule",{value:!0}),wl.ModalButtonKind=void 0;var s=(function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e})({});return wl.ModalButtonKind=s,wl}var Uc={},m_;function mT(){if(m_)return Uc;m_=1,Object.defineProperty(Uc,"__esModule",{value:!0}),Uc.isValidUrl=s;function s(e){if(!e)return!1;try{var t=new URL(e);return!(t.protocol!=="http"&&t.protocol!=="https")}catch(n){if(n instanceof TypeError)return!1;throw n}}return Uc}var Pc={},p_;function pT(){if(p_)return Pc;p_=1,Object.defineProperty(Pc,"__esModule",{value:!0}),Pc.assertPresent=s;function s(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}return Pc}var Cl={},g_;function gT(){if(g_)return Cl;g_=1,Object.defineProperty(Cl,"__esModule",{value:!0}),Cl.Widget=void 0;var s=Ed(),e=pT();function t(f){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},t(f)}function n(f,m){if(!(f instanceof m))throw new TypeError("Cannot call a class as a function")}function i(f,m){for(var g=0;g<m.length;g++){var S=m[g];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(f,u(S.key),S)}}function o(f,m,g){return m&&i(f.prototype,m),Object.defineProperty(f,"prototype",{writable:!1}),f}function u(f){var m=d(f,"string");return t(m)==="symbol"?m:String(m)}function d(f,m){if(t(f)!=="object"||f===null)return f;var g=f[Symbol.toPrimitive];if(g!==void 0){var S=g.call(f,m);if(t(S)!=="object")return S;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(f)}var h=(function(){function f(m){if(n(this,f),this.definition=m,!this.definition)throw new Error("Definition is required");(0,e.assertPresent)(m,"id"),(0,e.assertPresent)(m,"creatorUserId"),(0,e.assertPresent)(m,"type"),(0,e.assertPresent)(m,"url")}return o(f,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(g){return(0,s.runTemplate)(this.templateUrl,this.definition,g)}}]),f})();return Cl.Widget=h,Cl}var Il={},y_;function fA(){if(y_)return Il;y_=1,Object.defineProperty(Il,"__esModule",{value:!0}),Il.WidgetParser=void 0;var s=gT(),e=mT();function t(S){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},t(S)}function n(S,_){var b=typeof Symbol<"u"&&S[Symbol.iterator]||S["@@iterator"];if(!b){if(Array.isArray(S)||(b=i(S))||_){b&&(S=b);var T=0,k=function(){};return{s:k,n:function(){return T>=S.length?{done:!0}:{done:!1,value:S[T++]}},e:function(M){throw M},f:k}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var A=!0,C=!1,U;return{s:function(){b=b.call(S)},n:function(){var M=b.next();return A=M.done,M},e:function(M){C=!0,U=M},f:function(){try{!A&&b.return!=null&&b.return()}finally{if(C)throw U}}}}function i(S,_){if(S){if(typeof S=="string")return o(S,_);var b=Object.prototype.toString.call(S).slice(8,-1);if(b==="Object"&&S.constructor&&(b=S.constructor.name),b==="Map"||b==="Set")return Array.from(S);if(b==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b))return o(S,_)}}function o(S,_){(_==null||_>S.length)&&(_=S.length);for(var b=0,T=new Array(_);b<_;b++)T[b]=S[b];return T}function u(S,_){if(!(S instanceof _))throw new TypeError("Cannot call a class as a function")}function d(S,_){for(var b=0;b<_.length;b++){var T=_[b];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(S,f(T.key),T)}}function h(S,_,b){return b&&d(S,b),Object.defineProperty(S,"prototype",{writable:!1}),S}function f(S){var _=m(S,"string");return t(_)==="symbol"?_:String(_)}function m(S,_){if(t(S)!=="object"||S===null)return S;var b=S[Symbol.toPrimitive];if(b!==void 0){var T=b.call(S,_);if(t(T)!=="object")return T;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(S)}var g=(function(){function S(){u(this,S)}return h(S,null,[{key:"parseAccountData",value:function(b){if(!b)return[];for(var T=[],k=0,A=Object.keys(b);k<A.length;k++){var C=A[k],U=b[C];if(U&&!(U.type!=="m.widget"&&U.type!=="im.vector.modular.widgets")&&U.sender){var O=U.state_key||U.id;if(O===C){var M={content:U.content,sender:U.sender,type:"m.widget",state_key:C,event_id:"$example",room_id:"!example",origin_server_ts:1},E=S.parseRoomWidget(M);E&&T.push(E)}}}return T}},{key:"parseWidgetsFromRoomState",value:function(b){if(!b)return[];var T=[],k=n(b),A;try{for(k.s();!(A=k.n()).done;){var C=A.value,U=S.parseRoomWidget(C);U&&T.push(U)}}catch(O){k.e(O)}finally{k.f()}return T}},{key:"parseRoomWidget",value:function(b){if(!b||b.type!=="m.widget"&&b.type!=="im.vector.modular.widgets")return null;var T=b.content||{},k={id:b.state_key,creatorUserId:T.creatorUserId||b.sender,name:T.name,type:T.type,url:T.url,waitForIframeLoad:T.waitForIframeLoad,data:T.data};return S.processEstimatedWidget(k)}},{key:"processEstimatedWidget",value:function(b){return!b.id||!b.creatorUserId||!b.type||!(0,e.isValidUrl)(b.url)?null:new s.Widget(b)}}]),S})();return Il.WidgetParser=g,Il}var Ol={},S_;function hA(){if(S_)return Ol;S_=1,Object.defineProperty(Ol,"__esModule",{value:!0}),Ol.runTemplate=s,Ol.toString=e;function s(t,n,i){for(var o=Object.assign({},n.data,{matrix_room_id:i.widgetRoomId||"",matrix_user_id:i.currentUserId,matrix_display_name:i.userDisplayName||i.currentUserId,matrix_avatar_url:i.userHttpAvatarUrl||"",matrix_widget_id:n.id,"org.matrix.msc2873.client_id":i.clientId||"","org.matrix.msc2873.client_theme":i.clientTheme||"","org.matrix.msc2873.client_language":i.clientLanguage||"","org.matrix.msc3819.matrix_device_id":i.deviceId||"","org.matrix.msc4039.matrix_base_url":i.baseUrl||""}),u=t,d=0,h=Object.keys(o);d<h.length;d++){var f=h[d],m="$".concat(f).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),g=new RegExp(m,"g");u=u.replace(g,encodeURIComponent(e(o[f])))}return u}function e(t){return t==null?"".concat(t):String(t)}return Ol}var Ml={},b_;function vA(){if(b_)return Ml;b_=1,Object.defineProperty(Ml,"__esModule",{value:!0}),Ml.WidgetDriver=void 0;var s=Ed();function e(h){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},e(h)}function t(h,f){if(!(h instanceof f))throw new TypeError("Cannot call a class as a function")}function n(h,f){for(var m=0;m<f.length;m++){var g=f[m];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(h,o(g.key),g)}}function i(h,f,m){return f&&n(h.prototype,f),Object.defineProperty(h,"prototype",{writable:!1}),h}function o(h){var f=u(h,"string");return e(f)==="symbol"?f:String(f)}function u(h,f){if(e(h)!=="object"||h===null)return h;var m=h[Symbol.toPrimitive];if(m!==void 0){var g=m.call(h,f);if(e(g)!=="object")return g;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(h)}var d=(function(){function h(){t(this,h)}return i(h,[{key:"validateCapabilities",value:function(m){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(m,g){return Promise.reject(new Error("Failed to override function"))}},{key:"sendStickyEvent",value:function(m,g,S){throw new Error("Method not implemented.")}},{key:"sendDelayedEvent",value:function(m,g,S,_){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedStickyEvent",value:function(m,g,S,_,b){throw new Error("Method not implemented.")}},{key:"cancelScheduledDelayedEvent",value:function(m){return Promise.reject(new Error("Failed to override function"))}},{key:"restartScheduledDelayedEvent",value:function(m){return Promise.reject(new Error("Failed to override function"))}},{key:"sendScheduledDelayedEvent",value:function(m){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(m,g,S){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(m){return Promise.resolve([])}},{key:"readRoomEvents",value:function(m,g,S){return Promise.resolve([])}},{key:"readStateEvents",value:function(m,g,S){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(m,g,S,_,b,T){return _===void 0?this.readRoomEvents(g,S,b,[m],T):this.readStateEvents(g,_,b,[m])}},{key:"readRoomState",value:function(m,g,S){return this.readStateEvents(g,S,Number.MAX_SAFE_INTEGER,[m])}},{key:"readEventRelations",value:function(m,g,S,_,b,T,k,A){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(m){m.update({state:s.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(m){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(m,g){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(m){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(m){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(m){}}]),h})();return Ml.WidgetDriver=d,Ml}var E_;function Ed(){return E_||(E_=1,(function(s){Object.defineProperty(s,"__esModule",{value:!0});var e=oA();Object.keys(e).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===e[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return e[w]}})});var t=lA();Object.keys(t).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===t[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return t[w]}})});var n=ep();Object.keys(n).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===n[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return n[w]}})});var i=Xm();Object.keys(i).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===i[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return i[w]}})});var o=dT();Object.keys(o).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===o[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return o[w]}})});var u=uA();Object.keys(u).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===u[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return u[w]}})});var d=Qm();Object.keys(d).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===d[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return d[w]}})});var h=Ym();Object.keys(h).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===h[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return h[w]}})});var f=Jm();Object.keys(f).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===f[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return f[w]}})});var m=hT();Object.keys(m).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===m[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return m[w]}})});var g=Zm();Object.keys(g).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===g[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return g[w]}})});var S=cA();Object.keys(S).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===S[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return S[w]}})});var _=dA();Object.keys(_).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===_[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return _[w]}})});var b=fT();Object.keys(b).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===b[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return b[w]}})});var T=tp();Object.keys(T).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===T[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return T[w]}})});var k=$m();Object.keys(k).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===k[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return k[w]}})});var A=mT();Object.keys(A).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===A[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return A[w]}})});var C=pT();Object.keys(C).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===C[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return C[w]}})});var U=gT();Object.keys(U).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===U[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return U[w]}})});var O=fA();Object.keys(O).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===O[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return O[w]}})});var M=hA();Object.keys(M).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===M[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return M[w]}})});var E=vT();Object.keys(E).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===E[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return E[w]}})});var I=vA();Object.keys(I).forEach(function(w){w==="default"||w==="__esModule"||w in s&&s[w]===I[w]||Object.defineProperty(s,w,{enumerable:!0,get:function(){return I[w]}})})})(uv)),uv}var fr=Ed();function __(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Nc(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?__(Object(t),!0).forEach(function(n){y(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):__(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function mA(s){var e,t,n,i=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(t&&(e=s[t])!=null)return e.call(s);if(n&&(e=s[n])!=null)return new Gc(e.call(s));t="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Gc(s){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(i){return{value:i,done:n}})}return Gc=function(n){this.s=n,this.n=n.next},Gc.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?Promise.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?Promise.reject(n):e(i.apply(this.s,arguments))}},new Gc(s)}var zc=(function(s){return s.PendingEventsChanged="PendingEvent.pendingEventsChanged",s})({});class yT extends bd{constructor(e,t,n,i,o){var u,d,h,f,m,g,S,_,b,T,k,A,C,U;super(i),u=this,this.widgetApi=e,this.capabilities=t,this.roomId=n,y(this,"room",void 0),y(this,"widgetApiReady",void 0),y(this,"roomStateSynced",void 0),y(this,"lifecycle",void 0),y(this,"syncState",null),y(this,"pendingSendingEventsTxId",[]),y(this,"eventEmitter",new Lt),y(this,"updateTxId",(function(){var E=D(function*(I){if(I.getSender()===u.getUserId()&&u.pendingSendingEventsTxId.some(ue=>I.getType()===ue.type)){for(var w,q=(w=u.pendingSendingEventsTxId.find(ue=>ue.id===I.getId()))===null||w===void 0?void 0:w.txId;!q&&u.pendingSendingEventsTxId.length>0;){var z;yield new Promise(ue=>u.eventEmitter.once(zc.PendingEventsChanged,()=>ue())),q=(z=u.pendingSendingEventsTxId.find(ue=>ue.id===I.getId()))===null||z===void 0?void 0:z.txId}q&&(I.setTxnId(q),I.setUnsigned(Nc(Nc({},I.getUnsigned()),{},{transaction_id:q}))),u.pendingSendingEventsTxId=u.pendingSendingEventsTxId.filter(ue=>ue.id!==I.getId()),u.pendingSendingEventsTxId.length===0&&u.eventEmitter.emit(zc.PendingEventsChanged)}});return function(I){return E.apply(this,arguments)}})()),y(this,"onEvent",(function(){var E=D(function*(I){if(I.preventDefault(),I.detail.data.room_id===u.roomId){var w=new yn(I.detail.data);yield u.updateTxId(w),u.syncApi instanceof Xi?(yield u.supportUpdateState())?yield u.syncApi.injectRoomEvents(u.room,void 0,[],[w]):yield u.syncApi.injectRoomEvents(u.room,[],void 0,[w]):(yield u.supportUpdateState())?yield u.syncApi.injectRoomEvents(u.room,[],[w]):N.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),u.emit(Ue.Event,w),u.setSyncState(gt.Syncing),N.info("Received event ".concat(w.getId()," ").concat(w.getType()))}else{var{event_id:q,room_id:z}=I.detail.data;N.info("Received event ".concat(q," for a different room ").concat(z,"; discarding"))}yield u.ack(I)});return function(I){return E.apply(this,arguments)}})()),y(this,"onToDevice",(function(){var E=D(function*(I){I.preventDefault();var w=new yn({type:I.detail.data.type,sender:I.detail.data.sender,content:I.detail.data.content});I.detail.data.encrypted&&w.makeEncrypted(Z.RoomMessageEncrypted,{},"",""),u.emit(Ue.ToDeviceEvent,w),u.setSyncState(gt.Syncing),yield u.ack(I)});return function(I){return E.apply(this,arguments)}})()),y(this,"onStateUpdate",(function(){var E=D(function*(I){I.preventDefault(),(yield u.supportUpdateState())||N.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'");for(var w of I.detail.data.state)if(w.room_id===u.roomId){var q=new yn(w);u.syncApi instanceof Xi?yield u.syncApi.injectRoomEvents(u.room,void 0,[q]):yield u.syncApi.injectRoomEvents(u.room,[q]),N.info("Updated state entry ".concat(q.getType()," ").concat(q.getStateKey()," to ").concat(q.getId()))}else{var{event_id:z,room_id:ue}=I.detail.data;N.info("Received state entry ".concat(z," for a different room ").concat(ue,"; discarding"))}yield u.ack(I)});return function(I){return E.apply(this,arguments)}})());var O=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=(function(){var E=D(function*(I,w){try{return yield O(I,w)}catch(q){T_(q)}});return function(I,w){return E.apply(this,arguments)}})();var M=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=(function(){var E=D(function*(I,w){try{return yield M(I,w)}catch(q){T_(q)}});return function(I,w){return E.apply(this,arguments)}})(),this.widgetApiReady=new Promise(E=>this.widgetApi.once("ready",E)),this.roomStateSynced=(d=t.receiveState)!==null&&d!==void 0&&d.length?new Promise(E=>this.widgetApi.once("action:".concat(fr.WidgetApiToWidgetAction.UpdateState),E)):Promise.resolve(),((h=t.sendEvent)!==null&&h!==void 0&&h.length||(f=t.receiveEvent)!==null&&f!==void 0&&f.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(m=t.sendState)!==null&&m!==void 0&&m.length||(g=t.receiveState)!==null&&g!==void 0&&g.length)&&e.requestCapabilityForRoomTimeline(n),(S=t.sendEvent)===null||S===void 0||S.forEach(E=>e.requestCapabilityToSendEvent(E)),(_=t.receiveEvent)===null||_===void 0||_.forEach(E=>e.requestCapabilityToReceiveEvent(E)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(E=>e.requestCapabilityToSendMessage(E)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(E=>e.requestCapabilityToReceiveMessage(E)),(b=t.sendState)===null||b===void 0||b.forEach(E=>{var{eventType:I,stateKey:w}=E;return e.requestCapabilityToSendState(I,w)}),(T=t.receiveState)===null||T===void 0||T.forEach(E=>{var{eventType:I,stateKey:w}=E;return e.requestCapabilityToReceiveState(I,w)}),(k=t.sendToDevice)===null||k===void 0||k.forEach(E=>e.requestCapabilityToSendToDevice(E)),(A=t.receiveToDevice)===null||A===void 0||A.forEach(E=>e.requestCapabilityToReceiveToDevice(E)),t.sendDelayedEvents&&((C=t.sendEvent)!==null&&C!==void 0&&C.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(U=t.sendState)!==null&&U!==void 0&&U.length)&&e.requestCapability(fr.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(fr.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(fr.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(fr.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(fr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(fr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),o&&e.sendContentLoaded()}supportUpdateState(){var e=this;return D(function*(){return(yield e.widgetApi.getClientVersions()).includes(fr.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return D(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var i=t.getUserId();if(i&&t.store.storeUser(new pi(i)),n.slidingSync?t.syncApi=new q0(n.slidingSync,t,n,t.buildSyncApiOptions()):t.syncApi=new Xi(t,n,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var o,u;yield Promise.all((o=(u=t.capabilities.receiveState)===null||u===void 0?void 0:u.map((function(){var d=D(function*(h){var{eventType:f,stateKey:m}=h,g=yield t.widgetApi.readStateEvents(f,void 0,m,[t.roomId]),S=g.map(_=>new yn(_));t.syncApi instanceof Xi?yield t.syncApi.injectRoomEvents(t.room,void 0,S):yield t.syncApi.injectRoomEvents(t.room,S),S.forEach(_=>{t.emit(Ue.Event,_),N.info("Backfilled event ".concat(_.getId()," ").concat(_.getType()," ").concat(_.getStateKey()))})});return function(h){return d.apply(this,arguments)}})()))!==null&&o!==void 0?o:[])}n.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*n.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(gt.Syncing),N.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(fr.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(fr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(fr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return D(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,n){var i=this;return D(function*(){var o=t.event.redacts?Nc(Nc({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(n){var u=yield i.widgetApi.sendRoomEvent(t.getType(),o,e.roomId,"delay"in n?n.delay:void 0,"parent_delay_id"in n?n.parent_delay_id:void 0).catch(zn);return i.validateSendDelayedEventResponse(u)}var d=t.getTxnId();d&&i.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:d});var h;try{h=yield i.widgetApi.sendRoomEvent(t.getType(),o,e.roomId).catch(zn)}catch(f){throw i.updatePendingEventStatus(e,t,He.NOT_SENT),f}return e.updatePendingEvent(t,He.SENT,h.event_id),i.pendingSendingEventsTxId.forEach(f=>{f.txId===d&&(f.id=h.event_id)}),i.eventEmitter.emit(zc.PendingEventsChanged),{event_id:h.event_id}})()}sendStateEvent(e,t,n){var i=arguments,o=this;return D(function*(){var u=i.length>3&&i[3]!==void 0?i[3]:"",d=yield o.widgetApi.sendStateEvent(t,u,n,e).catch(zn);if(d.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:d.event_id}})()}_unstable_sendDelayedStateEvent(e,t,n,i){var o=arguments,u=this;return D(function*(){var d=o.length>4&&o[4]!==void 0?o[4]:"";if(!(yield u.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","sendDelayedStateEvent");var h=yield u.widgetApi.sendStateEvent(n,d,i,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(zn);return u.validateSendDelayedEventResponse(h)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var n=this;return D(function*(){if(!(yield n.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","updateDelayedEvent");var i;switch(t){case Fa.Cancel:i=n.widgetApi.cancelScheduledDelayedEvent;break;case Fa.Restart:i=n.widgetApi.cancelScheduledDelayedEvent;break;case Fa.Send:i=n.widgetApi.sendScheduledDelayedEvent;break}return yield i.call(n.widgetApi,e).catch(zn),{}})()}_unstable_cancelScheduledDelayedEvent(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","cancelScheduledDelayedEvent");return yield t.widgetApi.cancelScheduledDelayedEvent(e).catch(zn),{}})()}_unstable_restartScheduledDelayedEvent(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","restartScheduledDelayedEvent");return yield t.widgetApi.restartScheduledDelayedEvent(e).catch(zn),{}})()}_unstable_sendScheduledDelayedEvent(e){var t=this;return D(function*(){if(!(yield t.doesServerSupportUnstableFeature(pn)))throw new Zn("Server does not support the delayed events API","sendScheduledDelayedEvent");return yield t.widgetApi.sendScheduledDelayedEvent(e).catch(zn),{}})()}encryptAndSendToDevice(e,t,n){var i=this;return D(function*(){var o=new mi(()=>new Map);for(var{userId:u,deviceId:d}of t)o.getOrCreate(u).set(d,n);yield i.widgetApi.sendToDevice(e,!0,Na(o)).catch(zn)})()}sendToDevice(e,t){var n=this;return D(function*(){return yield n.widgetApi.sendToDevice(e,!1,Na(t)).catch(zn),{}})()}getOpenIdToken(){var e=this;return D(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(zn);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return D(function*(){var{eventType:n,batch:i}=e,o=new mi(()=>new Map);for(var{userId:u,deviceId:d,payload:h}of i)o.getOrCreate(u).set(d,h);yield t.widgetApi.sendToDevice(n,!1,Na(o)).catch(zn)})()}sendToDeviceViaWidgetApi(e,t,n){var i=this;return D(function*(){yield i.widgetApi.sendToDevice(e,t,Na(n)).catch(zn)})()}checkTurnServers(){var e=this;return D(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(Ue.Sync,e,t)}ack(e){var t=this;return D(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return D(function*(){var t=e.widgetApi.getTurnServers(),n=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",n);try{var i=!1,o=!1,u;try{for(var d=mA(t),h;i=!(h=yield d.next()).done;i=!1){var f=h.value;e.turnServers=[{urls:f.uris,username:f.username,credential:f.password}],e.emit(Ue.TurnServers,e.turnServers),N.log("Received TURN server: ".concat(f.uris))}}catch(m){o=!0,u=m}finally{try{i&&d.return!=null&&(yield d.return())}finally{if(o)throw u}}}catch(m){N.warn("Error watching TURN servers",m)}finally{e.lifecycle.signal.removeEventListener("abort",n)}})()}}function T_(s){throw s instanceof fr.WidgetApiResponseError&&s.data.matrix_api_error?Dt.fromWidgetApiErrorData(s.data.matrix_api_error):s}function zn(s){throw s instanceof Error&&s.message==="Request timed out"?new Ga("widget api timeout"):s}class pA{constructor(){y(this,"unthreadedReadReceipts",new Map),y(this,"threadedReadReceipts",new mi(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e?.forEach(t=>{t.type!==Z.Receipt||!t.content||Object.keys(t.content).forEach(n=>{Object.entries(t.content[n]).forEach(i=>{var[o,u]=i;if(hm(o))for(var d of Object.keys(u)){var h=t.content[n][o][d],f={data:t.content[n][o][d],type:o,eventId:n};h.thread_id?this.setThreaded(h.thread_id,d,f):this.setUnthreaded(d,f)}})})})}buildAccumulatedReceiptEvent(e){var t={type:Z.Receipt,room_id:e,content:{}},n=new mi(()=>new mi(()=>new Map));for(var[i,o]of this.allUnthreaded())n.getOrCreate(o.eventId).getOrCreate(o.type).set(i,o.data);for(var[u,d]of this.allThreaded())n.getOrCreate(d.eventId).getOrCreate(d.type).set(u,d.data);return t.content=Na(n),n.size>0?t:null}}var li=(function(s){return s.Invite="invite",s.Leave="leave",s.Join="join",s.Knock="knock",s})({});function gA(s){return"_localTs"in s&&s._localTs!==void 0}class ST{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,y(this,"accountData",{}),y(this,"inviteRooms",{}),y(this,"knockRooms",{}),y(this,"joinRooms",{}),y(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(n=>{this.accumulateRoom(n,li.Invite,e.rooms.invite[n],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(n=>{this.accumulateRoom(n,li.Join,e.rooms.join[n],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(n=>{this.accumulateRoom(n,li.Leave,e.rooms.leave[n],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(n=>{this.accumulateRoom(n,li.Knock,e.rooms.knock[n],t)}))}accumulateRoom(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case li.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,n);break;case li.Knock:this.accumulateKnockState(e,n);break;case li.Join:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,i);break;case li.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:N.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var n=this.inviteRooms[e];t.invite_state.events.forEach(i=>{for(var o=!1,u=0;u<n.invite_state.events.length;u++){var d=n.invite_state.events[u];d.type===i.type&&d.state_key==i.state_key&&(n.invite_state.events[u]=i,o=!0)}o||n.invite_state.events.push(i)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var n=this.knockRooms[e];t.knock_state.events.forEach(i=>{for(var o=!1,u=0;u<n.knock_state.events.length;u++){var d=n.knock_state.events[u];d.type===i.type&&d.state_key==i.state_key&&(n.knock_state.events[u]=i,o=!0)}o||n.knock_state.events.push(i)})}}accumulateJoinState(e,t){var n,i,o,u,d,h,f,m=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,g=Date.now();this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new pA,_stickyEvents:[]});var S=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(I=>{S._accountData[I.type]=I}),t.unread_notifications&&(S._unreadNotifications=t.unread_notifications),S._unreadThreadNotifications=(n=(i=t[Vl.stable])!==null&&i!==void 0?i:t[Vl.unstable])!==null&&n!==void 0?n:void 0,t.summary){var _,b,T,k="m.heroes",A="m.invited_member_count",C="m.joined_member_count",U=S._summary,O=t.summary;U[k]=(_=O[k])!==null&&_!==void 0?_:U[k],U[C]=(b=O[C])!==null&&b!==void 0?b:U[C],U[A]=(T=O[A])!==null&&T!==void 0?T:U[A]}if(S._receipts.consumeEphemeralEvents((o=t.ephemeral)===null||o===void 0?void 0:o.events),t.timeline&&t.timeline.limited&&(S._timeline=[]),(u=t.state)===null||u===void 0||(u=u.events)===null||u===void 0||u.forEach(I=>{Lc(S._currentState,I)}),(d=t["org.matrix.msc4222.state_after"])===null||d===void 0||(d=d.events)===null||d===void 0||d.forEach(I=>{Lc(S._currentState,I)}),(h=t.timeline)===null||h===void 0||(h=h.events)===null||h===void 0||h.forEach((I,w)=>{var q;t["org.matrix.msc4222.state_after"]||Lc(S._currentState,I);var z;if(m)z=I;else{var ue;z=Object.assign({},I),z.unsigned!==void 0&&(z.unsigned=Object.assign({},z.unsigned));var Se=(ue=I.unsigned)===null||ue===void 0?void 0:ue.age;Se!==void 0&&(z._localTs=Date.now()-Se)}S._timeline.push({event:z,token:w===0&&(q=t.timeline.prev_batch)!==null&&q!==void 0?q:null})}),S._stickyEvents=S._stickyEvents.filter(I=>{var{expiresTs:w}=I;return w>g}),(f=t.msc4354_sticky)!==null&&f!==void 0&&f.events&&(S._stickyEvents=S._stickyEvents.concat(t.msc4354_sticky.events.map(I=>{var w=Math.min(I.msc4354_sticky.duration_ms,zm),q=Math.min(I.origin_server_ts,g);return{event:I,expiresTs:w+q}}))),S._timeline.length>this.opts.maxTimelineEntries){for(var M=S._timeline.length-this.opts.maxTimelineEntries,E=M;E<S._timeline.length;E++)if(S._timeline[E].token){S._timeline=S._timeline.slice(E,S._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(i=>{t.invite[i]=this.inviteRooms[i]}),Object.keys(this.knockRooms).forEach(i=>{t.knock[i]=this.knockRooms[i]}),Object.keys(this.joinRooms).forEach(i=>{var o,u=this.joinRooms[i],d={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:u._unreadNotifications,unread_thread_notifications:u._unreadThreadNotifications,summary:u._summary,msc4354_sticky:(o=u._stickyEvents)!==null&&o!==void 0&&o.length?{events:u._stickyEvents.map(_=>_.event)}:void 0};Object.keys(u._accountData).forEach(_=>{d.account_data.events.push(u._accountData[_])});var h=u._receipts.buildAccumulatedReceiptEvent(i);h&&d.ephemeral.events.push(h),u._timeline.forEach(_=>{if(!d.timeline.prev_batch){if(!_.token)return;d.timeline.prev_batch=_.token}var b;!e&&gA(_.event)?(b=Object.assign({},_.event),b.unsigned!==void 0&&(b.unsigned=Object.assign({},b.unsigned)),delete b._localTs,b.unsigned=b.unsigned||{},b.unsigned.age=Date.now()-_.event._localTs):b=_.event,d.timeline.events.push(b)});for(var f=Object.create(null),m=d.timeline.events.length-1;m>=0;m--){var g=d.timeline.events[m];if(!(g.state_key===null||g.state_key===void 0)){var S=ru(g);S.unsigned&&(S.unsigned.prev_content&&(S.content=S.unsigned.prev_content),S.unsigned.prev_sender&&(S.sender=S.unsigned.prev_sender)),Lc(f,S)}}Object.keys(u._currentState).forEach(_=>{Object.keys(u._currentState[_]).forEach(b=>{var T=u._currentState[_][b];d["org.matrix.msc4222.state_after"].events.push(T),f[_]&&f[_][b]&&(T=f[_][b]),d.state.events.push(T)})}),t.join[i]=d});var n=[];return Object.keys(this.accountData).forEach(i=>{n.push(this.accountData[i])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function Lc(s,e){e.state_key===null||e.state_key===void 0||!e.type||(s[e.type]||(s[e.type]=Object.create(null)),s[e.type][e.state_key]=e)}var bT=(function(s){return s[s.Blocked=-1]="Blocked",s[s.Unverified=0]="Unverified",s[s.Verified=1]="Verified",s})({});class yA{constructor(e){y(this,"deviceId",void 0),y(this,"userId",void 0),y(this,"algorithms",void 0),y(this,"keys",void 0),y(this,"verified",void 0),y(this,"signatures",void 0),y(this,"displayName",void 0),y(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||bT.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}var R_=function(){},SA=10;class bA{constructor(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,y(this,"windowLimit",void 0),y(this,"start",void 0),y(this,"end",void 0),y(this,"eventCount",0),this.windowLimit=i.windowLimit||1e3,(n=t.room)===null||n===void 0||n.on(ke.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,n=i=>{if(!i)throw new Error("No timeline given to initFields");var o,u=i.getEvents();if(!e)o=u.length;else if(o=u.findIndex(f=>f.getId()===e),o<0)throw new Error("getEventTimeline result didn't include requested event");var d=Math.min(u.length,o+Math.ceil(t/2)),h=Math.max(0,d-t);this.start=new sm(i,h-i.getBaseIndex()),this.end=new sm(i,d-i.getBaseIndex()),this.eventCount=d-h};return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==Oe.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==Oe.FORWARDS){var n;return(n=this.end)!==null&&n!==void 0?n:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var n=this.getTimelineIndex(e);if(!n)return!1;var i=e==Oe.BACKWARDS?n.retreat(t):n.advance(t);if(i){this.eventCount+=i,R_("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");var o=this.eventCount-this.windowLimit;return o>0&&this.unpaginate(o,e!=Oe.BACKWARDS),!0}return!1}onTimelineEvent(e,t,n,i){i&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==Oe.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var n=t.timeline.getNeighbouringTimeline(e),i=t.timeline.getPaginationToken(e);return!!n||!!i}paginate(e,t){var n=arguments,i=this;return D(function*(){var o=n.length>2&&n[2]!==void 0?n[2]:!0,u=n.length>3&&n[3]!==void 0?n[3]:SA,d=i.getTimelineIndex(e);if(!d)return!1;if(d.pendingPaginate)return d.pendingPaginate;if(i.extend(e,t))return!0;if(!o||u===0)return!1;var h=d.timeline.getPaginationToken(e);if(!h)return!1;var f=i.client.paginateEventTimeline(d.timeline,{backwards:e==Oe.BACKWARDS,limit:t}).finally(function(){d.pendingPaginate=void 0}).then(m=>m?i.paginate(e,t,!0,u-1):i.paginate(e,t,!1,0));return d.pendingPaginate=f,f})()}unpaginate(e,t){var n=t?this.start:this.end;if(!n)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,R_("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var n,i,o=t.getEvents(),u=0,d=o.length;t===this.start.timeline&&(u=this.start.index+t.getBaseIndex()),t===((n=this.end)===null||n===void 0?void 0:n.timeline)&&(d=this.end.index+t.getBaseIndex());for(var h=u;h<d;h++)e.push(o[h]);if(t===((i=this.end)===null||i===void 0?void 0:i.timeline))break;t=t.getNeighbouringTimeline(Oe.FORWARDS)}return e}}class sm{constructor(e,t){this.timeline=e,this.index=t,y(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var n=this.timeline.getNeighbouringTimeline(e<0?Oe.BACKWARDS:Oe.FORWARDS);return n?(this.timeline=n,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var Al="m.login.email.identity",w_="m.login.msisdn",om=(function(s){return s.Password="m.login.password",s.Recaptcha="m.login.recaptcha",s.Terms="m.login.terms",s.Email="m.login.email.identity",s.Msisdn="m.login.msisdn",s.Sso="m.login.sso",s.SsoUnstable="org.matrix.login.sso",s.Dummy="m.login.dummy",s.RegistrationToken="m.login.registration_token",s.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",s.OAuth="m.oauth",s})({});class ET extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,y(this,"name","NoAuthFlowFoundError")}}class EA{constructor(e){var t=this;y(this,"matrixClient",void 0),y(this,"inputs",void 0),y(this,"clientSecret",void 0),y(this,"requestCallback",void 0),y(this,"busyChangedCallback",void 0),y(this,"stateUpdatedCallback",void 0),y(this,"requestEmailTokenCallback",void 0),y(this,"supportedStages",void 0),y(this,"data",void 0),y(this,"emailSid",void 0),y(this,"requestingEmailToken",!1),y(this,"attemptAuthDeferred",null),y(this,"chosenFlow",null),y(this,"currentStage",null),y(this,"emailAttempt",1),y(this,"submitPromise",null),y(this,"requestEmailToken",D(function*(){if(t.requestingEmailToken)N.warn("Could not request email token: Already requesting");else{N.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var n=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=n.sid,N.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return D(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var n=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var i;(i=e.busyChangedCallback)===null||i===void 0||i.call(e,!0);var o=e.data.session?{session:e.data.session}:null;e.doRequest(o).finally(()=>{var u;(u=e.busyChangedCallback)===null||u===void 0||u.call(e,!1)})}return n})()}poll(){var e=this;return D(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==Al&&e.emailSid){var n={sid:e.emailSid,client_secret:e.clientSecret},i=e.matrixClient.getIdentityServerUrl();i&&(n.id_server=new URL(i).host),t={type:Al,threepid_creds:n}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,n=this;return D(function*(){var i,o=t.length>1&&t[1]!==void 0?t[1]:!1;if(!n.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!o){var u;(u=n.busyChangedCallback)===null||u===void 0||u.call(n,!0)}for(;n.submitPromise;)try{yield n.submitPromise}catch{}var d;(i=n.data)!==null&&i!==void 0&&i.session?d=Object.assign({session:n.data.session},e):d=e;try{n.submitPromise=n.doRequest(d,o),yield n.submitPromise}finally{if(n.submitPromise=null,!o){var h;(h=n.busyChangedCallback)===null||h===void 0||h.call(n,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,n=this;return D(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;try{var o=yield n.requestCallback(e,i);n.attemptAuthDeferred.resolve(o),n.attemptAuthDeferred=null}catch(b){var u,d,h,f,m=b instanceof Dt?b:null,g=(u=m==null||(d=m.data)===null||d===void 0?void 0:d.flows)!==null&&u!==void 0?u:null,S=((h=n.data)===null||h===void 0?void 0:h.flows)||!!g;if(!m||m.httpStatus!==401||!m.data||!S)if(i)N.log("Background poll request failed doing UI auth: ignoring",b);else{var _;(_=n.attemptAuthDeferred)===null||_===void 0||_.reject(b)}m&&!m.data&&(m.data={}),m&&!m.data.flows&&!m.data.completed&&!m.data.session&&(m.data.flows=n.data.flows,m.data.completed=n.data.completed,m.data.session=n.data.session),m&&(n.data=m.data);try{n.startNextAuthStage()}catch(T){n.attemptAuthDeferred.reject(T),n.attemptAuthDeferred=null;return}if(!n.emailSid&&(f=n.chosenFlow)!==null&&f!==void 0&&f.stages.includes(om.Email))try{yield n.requestEmailToken()}catch(T){n.attemptAuthDeferred.reject(T),n.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");if(this.currentStage=n,n===om.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var i,o;this.stateUpdatedCallback(n,{errcode:((i=this.data)===null||i===void 0?void 0:i.errcode)||"",error:((o=this.data)===null||o===void 0?void 0:o.error)||""});return}this.stateUpdatedCallback(n,n===Al?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),N.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return N.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(n=>!this.supportedStages.has(n)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],n=!!this.inputs.emailAddress||!!this.emailSid,i=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((m,g)=>this.scoreFlow(m)-this.scoreFlow(g));for(var o of t){var u=!1,d=!1;for(var h of o.stages)h===Al?u=!0:h==w_&&(d=!0);if(u==n&&d==i)return o}var f=[];throw n&&f.push(Al),i&&f.push(w_),new ET("No appropriate authentication flow found",f,t)}firstUncompletedStage(e){var t,n=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(i=>!n.includes(i))}}function _T(s,e){return new Promise((t,n)=>{var i=!0,o=s.open(e);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{var u=o.result;u.close(),i||s.deleteDatabase(e),t(i)},o.onerror=()=>n(o.error)})}var TT=[s=>{s.createObjectStore("users",{keyPath:["userId"]}),s.createObjectStore("accountData",{keyPath:["type"]}),s.createObjectStore("sync",{keyPath:["clobber"]})},s=>{var e=s.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},s=>{s.createObjectStore("client_options",{keyPath:["clobber"]})},s=>{s.createObjectStore("to_device_queue",{autoIncrement:!0})}],_A=TT.length;function xc(s,e,t){var n=s.openCursor(e);return new Promise((i,o)=>{var u=[];n.onerror=()=>{var d;o(new Error("Query failed: "+((d=n.error)===null||d===void 0?void 0:d.name)))},n.onsuccess=()=>{var d=n.result;if(!d){i(u);return}u.push(t(d)),d.continue()}})}function Oa(s){return new Promise((e,t)=>{s.oncomplete=function(n){e(n)},s.onerror=function(){t(s.error)}})}function RT(s){return new Promise((e,t)=>{s.onsuccess=function(n){e(n)},s.onerror=function(){t(s.error)}})}function TA(s){return new Promise((e,t)=>{s.onsuccess=()=>e(s),s.onerror=n=>t(n)})}function cv(s){return RT(s).then(e=>s.result)}class C_{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),_T(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,y(this,"dbName",void 0),y(this,"syncAccumulator",void 0),y(this,"db",void 0),y(this,"disconnected",!0),y(this,"_isNewlyCreated",!1),y(this,"syncToDatabasePromise",void 0),y(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new ST}connect(e){var t=this;if(!this.disconnected)return N.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,N.log("LocalIndexedDBStoreBackend.connect: connecting...");var n=this.indexedDB.open(this.dbName,_A);return n.onupgradeneeded=i=>{var o=n.result,u=i.oldVersion;N.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(u)),u<1&&(this._isNewlyCreated=!0),TT.forEach((d,h)=>{u<=h&&d(o)})},n.onblocked=()=>{N.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},N.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),RT(n).then(D(function*(){N.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=n.result,t.db.onversionchange=()=>{var i;(i=t.db)===null||i===void 0||i.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e?.()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,n]=e;N.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,n)=>{var i=this.db.transaction(["oob_membership_events"],"readonly"),o=i.objectStore("oob_membership_events"),u=o.index("room"),d=IDBKeyRange.only(e),h=u.openCursor(d),f=[],m=!1;h.onsuccess=()=>{var g=h.result;if(!g)return!f.length&&!m?t(null):t(f);var S=g.value;S.oob_written?m=!0:f.push(S),g.continue()},h.onerror=g=>{n(g)}}).then(t=>(N.log("LL: got ".concat(t?.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var n=this;return D(function*(){N.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var i=n.db.transaction(["oob_membership_events"],"readwrite"),o=i.objectStore("oob_membership_events");t.forEach(d=>{o.put(d)});var u={room_id:e,oob_written:!0,state_key:0};o.put(u),yield Oa(i),N.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return D(function*(){var n=t.db.transaction(["oob_membership_events"],"readonly"),i=n.objectStore("oob_membership_events"),o=i.index("room"),u=IDBKeyRange.only(e),d=cv(o.openKeyCursor(u,"next")).then(b=>(b?.primaryKey)[1]),h=cv(o.openKeyCursor(u,"prev")).then(b=>(b?.primaryKey)[1]),[f,m]=yield Promise.all([d,h]),g=t.db.transaction(["oob_membership_events"],"readwrite"),S=g.objectStore("oob_membership_events"),_=IDBKeyRange.bound([e,f],[e,m]);N.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,f],[e,m]),yield TA(S.delete(_))})()}clearDatabase(){return new Promise(e=>{var t;N.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{N.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},n.onerror=()=>{var i;N.warn("unable to delete js-sdk store indexeddb: ".concat((i=n.error)===null||i===void 0?void 0:i.name)),e()},n.onsuccess=()=>{N.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(ru(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return D(function*(){return t.syncToDatabasePromise?(N.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return D(function*(){try{var n=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(n.accountData),t.persistSyncData(n.nextBatch,n.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return N.log("Persisting sync data up to",e),Ds(()=>{var n=this.db.transaction(["sync"],"readwrite"),i=n.objectStore("sync");return i.put({clobber:"-",nextBatch:e,roomsData:t}),Oa(n).then(()=>{N.log("Persisted sync data up to",e)})})}persistAccountData(e){return Ds(()=>{var t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(var i of e)n.put(i);return Oa(t).then()})}persistUserPresenceEvents(e){return Ds(()=>{var t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(var i of e)n.put({userId:i[0],event:i[1]});return Oa(t).then()})}getUserPresenceEvents(){return Ds(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return xc(t,void 0,n=>[n.value.userId,n.value.event])})}loadAccountData(){return N.log("LocalIndexedDBStoreBackend: loading account data..."),Ds(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return xc(t,void 0,n=>n.value).then(n=>(N.log("LocalIndexedDBStoreBackend: loaded account data"),n))})}loadSyncData(){return N.log("LocalIndexedDBStoreBackend: loading sync data..."),Ds(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return xc(t,void 0,n=>n.value).then(n=>(N.log("LocalIndexedDBStoreBackend: loaded sync data"),n.length>1&&N.warn("loadSyncData: More than 1 sync row found."),n.length>0?n[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return xc(t,void 0,n=>{var i;return(i=n.value)===null||i===void 0?void 0:i.options}).then(n=>n[0])})}storeClientOptions(e){var t=this;return D(function*(){var n=t.db.transaction(["client_options"],"readwrite"),i=n.objectStore("client_options");i.put({clobber:"-",options:e}),yield Oa(n)})()}saveToDeviceBatches(e){var t=this;return D(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");for(var o of e)i.add(o);yield Oa(n)})()}getOldestToDeviceBatch(){var e=this;return D(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),n=t.objectStore("to_device_queue"),i=yield cv(n.openCursor());if(!i)return null;var o=i.value;return{id:i.key,txnId:o.txnId,eventType:o.eventType,batch:o.batch}})()}removeToDeviceBatch(e){var t=this;return D(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");i.delete(e),yield Oa(n)})()}destroy(){var e=this;return D(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class RA{constructor(e,t){this.workerFactory=e,this.dbName=t,y(this,"worker",void 0),y(this,"nextSeq",0),y(this,"inFlight",{}),y(this,"startPromise",void 0),y(this,"onWorkerMessage",n=>{var i=n.data;if(i.command=="closed"){var o;(o=this.onClose)===null||o===void 0||o.call(this)}else if(i.command=="cmd_success"||i.command=="cmd_fail"){if(i.seq===void 0){N.error("Got reply from worker with no seq");return}var u=this.inFlight[i.seq];if(u===void 0){N.error("Got reply for unknown seq "+i.seq);return}if(delete this.inFlight[i.seq],i.command=="cmd_success")u.resolve(i.result);else{var d=new Error(i.error.message);d.name=i.error.name,u.reject(d)}}else N.warn("Unrecognised message from worker: ",i)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return D(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return D(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return D(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{N.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var n,i=this.nextSeq++,o=Promise.withResolvers();return this.inFlight[i]=o,(n=this.worker)===null||n===void 0||n.postMessage({command:e,seq:i,args:t}),o.promise})}destroy(){var e=this;return D(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var wA=1e3*60*5;class CA extends Wm{static exists(e,t){return C_.exists(e,t)}constructor(e){if(super(e),y(this,"backend",void 0),y(this,"startedUp",!1),y(this,"syncTs",0),y(this,"userModifiedMap",{}),y(this,"emitter",new Lt),y(this,"onClose",()=>{this.emitter.emit("closed")}),y(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),y(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),y(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),y(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{N.log("Deleted indexeddb data.")},t=>{throw N.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),y(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var n of this.getUsers())this.userModifiedMap[n.userId]!==n.getLastModifiedTime()&&n.events.presence&&(t.push([n.userId,n.events.presence.event]),this.userModifiedMap[n.userId]=n.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),y(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),y(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),y(this,"setOutOfBandMembers",this.degradable((t,n)=>(super.setOutOfBandMembers(t,n),this.backend.setOutOfBandMembers(t,n)),"setOutOfBandMembers")),y(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),y(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),y(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new RA(e.workerFactory,e.dbName):this.backend=new C_(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(N.log("IndexedDBStore.startup: already started"),Promise.resolve()):(N.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(N.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{N.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[n,i]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var o=this.createUser(n);i&&o.setPresenceEvent(new yn(i)),this.userModifiedMap[o.userId]=o.getLastModifiedTime(),this.storeUser(o)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>wA}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this,i=t?super[t]:null;return D(function*(){for(var o=arguments.length,u=new Array(o),d=0;d<o;d++)u[d]=arguments[d];try{return yield e.call(n,...u)}catch(h){N.error("IndexedDBStore failure, degrading to MemoryStore",h),n.emitter.emit("degraded",h);try{N.log("IndexedDBStore trying to delete degraded data"),yield n.backend.clearDatabase(),N.log("IndexedDBStore delete after degrading succeeded")}catch(f){N.warn("IndexedDBStore delete after degrading failed",f)}if(i)return i.call(n,...u)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,n=this;return D(function*(){if(!n.localStorage)return t().call(n,e);var i=n.localStorage.getItem(dv(e));if(i)try{return JSON.parse(i)}catch(o){N.error("Could not parse persisted pending events",o)}return[]})()}setPendingEvents(e,t){var n=()=>super.setPendingEvents,i=this;return D(function*(){if(!i.localStorage)return n().call(i,e,t);t.length>0?i.localStorage.setItem(dv(e),JSON.stringify(t)):i.localStorage.removeItem(dv(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function dv(s){return"mx_pending_events_".concat(s)}var Rr="crypto.",I_=Rr+"migration",fv=Rr+"account",IA=Rr+"cross_signing_keys",Wc=Rr+"inboundgroupsessions/",OA=Rr+"inboundgroupsessions.withheld/",MA=Rr+"rooms/",hv=Rr+"sessionsneedingbackup";function js(s){return Rr+"sessions/"+s}function vv(s,e){return Wc+s+"/"+e}function AA(s,e){return OA+s+"/"+e}function DA(s){return MA+s}class _d extends ld{static exists(e){for(var t=e.length,n=0;n<t;n++){var i;if((i=e.key(n))!==null&&i!==void 0&&i.startsWith(Rr))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return D(function*(){return _d.exists(e.store)})()}getMigrationState(){var e=this;return D(function*(){var t;return(t=dr(e.store,I_))!==null&&t!==void 0?t:Xs.NOT_STARTED})()}setMigrationState(e){var t=this;return D(function*(){Ma(t.store,I_,e)})()}countEndToEndSessions(e,t){for(var n=0,i=0;i<this.store.length;++i){var o=this.store.key(i);if(o!=null&&o.startsWith(js(""))){var u=dr(this.store,o);n+=Object.keys(u??{}).length}}t(n)}_getEndToEndSessions(e){var t=dr(this.store,js(e)),n={};for(var[i,o]of Object.entries(t||{}))typeof o=="string"?n[i]={session:o}:n[i]=o;return n}getEndToEndSession(e,t,n,i){var o,u=this._getEndToEndSessions(e);i((o=u[t])!==null&&o!==void 0?o:{})}getEndToEndSessions(e,t,n){var i;n((i=this._getEndToEndSessions(e))!==null&&i!==void 0?i:{})}storeEndToEndSession(e,t,n,i){var o=this._getEndToEndSessions(e)||{};o[t]=n,Ma(this.store,js(e),o)}getEndToEndSessionsBatch(){var e=this;return D(function*(){for(var t=[],n=0;n<e.store.length;++n){var i;if((i=e.store.key(n))!==null&&i!==void 0&&i.startsWith(js(""))){var o=e.store.key(n).split("/")[1];for(var u of Object.values(e._getEndToEndSessions(o)))if(t.push(u),t.length>=Qs)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return D(function*(){for(var{deviceKey:n,sessionId:i}of e){var o=t._getEndToEndSessions(n)||{};delete o[i],Object.keys(o).length===0?t.store.removeItem(js(n)):Ma(t.store,js(n),o)}})()}getEndToEndInboundGroupSession(e,t,n,i){i(dr(this.store,vv(e,t)),dr(this.store,AA(e,t)))}storeEndToEndInboundGroupSession(e,t,n,i){Ma(this.store,vv(e,t),n)}countEndToEndInboundGroupSessions(){var e=this;return D(function*(){for(var t=0,n=0;n<e.store.length;++n){var i=e.store.key(n);i!=null&&i.startsWith(Wc)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return D(function*(){for(var t=dr(e.store,hv)||{},n=[],i=0;i<e.store.length;++i){var o=e.store.key(i);if(o!=null&&o.startsWith(Wc)){var u=o.slice(Wc.length);if(n.push({senderKey:u.slice(0,43),sessionId:u.slice(44),sessionData:dr(e.store,o),needsBackup:u in t}),n.length>=Qs)return n}}return n.length===0?null:n})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return D(function*(){for(var{senderKey:n,sessionId:i}of e){var o=vv(n,i);t.store.removeItem(o)}})()}getEndToEndRooms(e,t){for(var n={},i=DA(""),o=0;o<this.store.length;++o){var u=this.store.key(o);if(u!=null&&u.startsWith(i)){var d=u.slice(i.length);n[d]=dr(this.store,u)}}t(n)}markSessionsNeedingBackup(e){var t=dr(this.store,hv)||{};for(var n of e)t[n.senderKey+"/"+n.sessionId]=!0;return Ma(this.store,hv,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(fv),Promise.resolve()}getAccount(e,t){var n=dr(this.store,fv);t(n)}storeAccount(e,t){Ma(this.store,fv,t)}getCrossSigningKeys(e,t){var n=dr(this.store,IA);t(n)}getSecretStorePrivateKey(e,t,n){var i=dr(this.store,Rr+"ssss_cache.".concat(n));t(i)}storeSecretStorePrivateKey(e,t,n){Ma(this.store,Rr+"ssss_cache.".concat(t),n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function dr(s,e){try{return JSON.parse(s.getItem(e))}catch(t){N.log("Error: Failed to get key %s: %s",e,t.message),N.log(t.stack)}return null}function Ma(s,e,t){s.setItem(e,JSON.stringify(t))}class kA{constructor(e){this.db=e,y(this,"nextTxnId",0),e.onversionchange=()=>{N.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return D(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return D(function*(){return e})()}deleteAllData(){return D(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return D(function*(){var t=Xs.NOT_STARTED;return yield e.doTxn("readonly",[ct.STORE_ACCOUNT],n=>{var i=n.objectStore(ct.STORE_ACCOUNT),o=i.get(bv);o.onsuccess=()=>{var u;t=(u=o.result)!==null&&u!==void 0?u:Xs.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return D(function*(){yield t.doTxn("readwrite",[ct.STORE_ACCOUNT],n=>{var i=n.objectStore(ct.STORE_ACCOUNT);i.put(e,bv)})})()}getAccount(e,t){var n=e.objectStore("account"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(o){kn(e,o)}}}storeAccount(e,t){var n=e.objectStore("account");n.put(t,"-")}getCrossSigningKeys(e,t){var n=e.objectStore("account"),i=n.get("crossSigningKeys");i.onsuccess=function(){try{t(i.result||null)}catch(o){kn(e,o)}}}getSecretStorePrivateKey(e,t,n){var i=e.objectStore("account"),o=i.get("ssss_cache:".concat(n));o.onsuccess=function(){try{t(o.result||null)}catch(u){kn(e,u)}}}storeSecretStorePrivateKey(e,t,n){var i=e.objectStore("account");i.put(n,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var n=e.objectStore("sessions"),i=n.count();i.onsuccess=function(){try{t(i.result)}catch(o){kn(e,o)}}}getEndToEndSessions(e,t,n){var i=t.objectStore("sessions"),o=i.index("deviceKey"),u=o.openCursor(e),d={};u.onsuccess=function(){var h=u.result;if(h)d[h.value.sessionId]={session:h.value.session,lastReceivedMessageTs:h.value.lastReceivedMessageTs},h.continue();else try{n(d)}catch(f){kn(t,f)}}}getEndToEndSession(e,t,n,i){var o=n.objectStore("sessions"),u=o.get([e,t]);u.onsuccess=function(){try{u.result?i({session:u.result.session,lastReceivedMessageTs:u.result.lastReceivedMessageTs}):i(null)}catch(d){kn(n,d)}}}storeEndToEndSession(e,t,n,i){var o=i.objectStore("sessions");o.put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return D(function*(){var t=[];return yield e.doTxn("readonly",[ct.STORE_SESSIONS],n=>{var i=n.objectStore(ct.STORE_SESSIONS),o=i.openCursor();o.onsuccess=function(){try{var u=o.result;u&&(t.push(u.value),t.length<Qs&&u.continue())}catch(d){kn(n,d)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return D(function*(){yield t.doTxn("readwrite",[ct.STORE_SESSIONS],(function(){var n=D(function*(i){try{var o=i.objectStore(ct.STORE_SESSIONS),u=function*(){var m=o.delete([d,h]);yield new Promise(g=>{m.onsuccess=g})};for(var{deviceKey:d,sessionId:h}of e)yield*u()}catch(f){kn(i,f)}});return function(i){return n.apply(this,arguments)}})())})()}getEndToEndInboundGroupSession(e,t,n,i){var o=!1,u=!1,d=n.objectStore("inbound_group_sessions"),h=d.get([e,t]);h.onsuccess=function(){try{h.result?o=h.result.session:o=null,u!==!1&&i(o,u)}catch(g){kn(n,g)}};var f=n.objectStore("inbound_group_sessions_withheld"),m=f.get([e,t]);m.onsuccess=function(){try{m.result?u=m.result.session:u=null,o!==!1&&i(o,u)}catch(g){kn(n,g)}}}storeEndToEndInboundGroupSession(e,t,n,i){var o=i.objectStore("inbound_group_sessions");o.put({senderCurve25519Key:e,sessionId:t,session:n})}countEndToEndInboundGroupSessions(){var e=this;return D(function*(){var t=0;return yield e.doTxn("readonly",[ct.STORE_INBOUND_GROUP_SESSIONS],n=>{var i=n.objectStore(ct.STORE_INBOUND_GROUP_SESSIONS),o=i.count();o.onsuccess=()=>{t=o.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return D(function*(){var t=[];return yield e.doTxn("readonly",[ct.STORE_INBOUND_GROUP_SESSIONS,ct.STORE_BACKUP],n=>{var i=n.objectStore(ct.STORE_INBOUND_GROUP_SESSIONS),o=n.objectStore(ct.STORE_BACKUP),u=i.openCursor();u.onsuccess=function(){try{var d=u.result;if(d){var h=o.get(d.key);h.onsuccess=()=>{t.push({senderKey:d.value.senderCurve25519Key,sessionId:d.value.sessionId,sessionData:d.value.session,needsBackup:h.result!==void 0}),t.length<Qs&&d.continue()}}}catch(f){kn(n,f)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return D(function*(){yield t.doTxn("readwrite",[ct.STORE_INBOUND_GROUP_SESSIONS],(function(){var n=D(function*(i){try{var o=i.objectStore(ct.STORE_INBOUND_GROUP_SESSIONS),u=function*(){var m=o.delete([d,h]);yield new Promise(g=>{m.onsuccess=g})};for(var{senderKey:d,sessionId:h}of e)yield*u()}catch(f){kn(i,f)}});return function(i){return n.apply(this,arguments)}})())})()}getEndToEndDeviceData(e,t){var n=e.objectStore("device_data"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(o){kn(e,o)}}}getEndToEndRooms(e,t){var n={},i=e.objectStore("rooms"),o=i.openCursor();o.onsuccess=function(){var u=o.result;if(u)n[u.key]=u.value,u.continue();else try{t(n)}catch(d){kn(e,d)}}}markSessionsNeedingBackup(e,t){var n=this;return D(function*(){t||(t=n.db.transaction("sessions_needing_backup","readwrite"));var i=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(o=>new Promise((u,d)=>{var h=i.put({senderCurve25519Key:o.senderKey,sessionId:o.sessionId});h.onsuccess=u,h.onerror=d})))})()}doTxn(e,t,n){var i=this.db.transaction(t,e),o=NA(i),u=n(i);return o.then(()=>u)}}var wT=[s=>{PA(s)},s=>{s.createObjectStore("account")},s=>{var e=s.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},s=>{s.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},s=>{s.createObjectStore("device_data")},s=>{s.createObjectStore("rooms")},s=>{s.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},s=>{s.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},s=>{var e=s.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),s.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},s=>{s.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},s=>{s.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],CT=wT.length;function UA(s,e){N.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(CT)),wT.forEach((t,n)=>{e<=n&&t(s)})}function PA(s){var e=s.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function kn(s,e){s._mx_abortexception=e;try{s.abort()}catch{}}function NA(s){return new Promise((e,t)=>{s.oncomplete=()=>{s._mx_abortexception!==void 0&&t(s._mx_abortexception),e(null)},s.onerror=n=>{s._mx_abortexception!==void 0?t(s._mx_abortexception):(N.log("Error performing indexeddb txn",n),t(s.error))},s.onabort=n=>{s._mx_abortexception!==void 0?t(s._mx_abortexception):(N.log("Error performing indexeddb txn",n),t(s.error))}})}class ct{static exists(e,t){return _T(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((n,i)=>{var o=!0,u=e.open(t);u.onupgradeneeded=()=>{o=!1},u.onblocked=()=>i(u.error),u.onsuccess=()=>{var d=u.result;if(!o)d.close(),e.deleteDatabase(t),n(!1);else{var h=d.transaction([ct.STORE_ACCOUNT],"readonly"),f=h.objectStore(ct.STORE_ACCOUNT),m=f.get(bv);m.onsuccess=()=>{var g,S=(g=m.result)!==null&&g!==void 0?g:Xs.NOT_STARTED;n(S===Xs.NOT_STARTED)},m.onerror=()=>{i(m.error)},d.close()}},u.onerror=()=>i(u.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,y(this,"backendPromise",void 0),y(this,"backend",void 0)}containsData(){var e=this;return D(function*(){return ct.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}N.log("connecting to indexeddb ".concat(this.dbName));var n=this.indexedDB.open(this.dbName,CT);n.onupgradeneeded=i=>{var o=n.result,u=i.oldVersion;UA(o,u)},n.onblocked=()=>{N.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{N.log("Error connecting to indexeddb",i),t(n.error)},n.onsuccess=()=>{var i=n.result;N.log("connected to indexeddb ".concat(this.dbName)),e(new kA(i))}}).then(e=>e.doTxn("readonly",[ct.STORE_INBOUND_GROUP_SESSIONS,ct.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw N.warn("Crypto DB is too new for us to use!",e),new jm(xm.TooNew);N.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new _d(globalThis.localStorage)}catch(t){return N.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new ld}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}N.log("Removing indexeddb instance: ".concat(this.dbName));var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{N.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{N.log("Error deleting data from indexeddb",i),t(n.error)},n.onsuccess=()=>{N.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{N.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this.backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}storeEndToEndSession(e,t,n,i){this.backend.storeEndToEndSession(e,t,n,i)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,n,i){this.backend.getEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this.backend.storeEndToEndInboundGroupSession(e,t,n,i)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,n,i){return this.backend.doTxn(e,t,n,i)}}y(ct,"STORE_ACCOUNT","account");y(ct,"STORE_SESSIONS","sessions");y(ct,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");y(ct,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");y(ct,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");y(ct,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");y(ct,"STORE_DEVICE_DATA","device_data");y(ct,"STORE_ROOMS","rooms");y(ct,"STORE_BACKUP","sessions_needing_backup");var LA=(function(s){return s.Email="email",s.Phone="msisdn",s})({}),xA=new Yt("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),jA=(function(s){return s.Gitlab="gitlab",s.Github="github",s.Apple="apple",s.Google="google",s.Facebook="facebook",s.Twitter="twitter",s})({}),BA=(function(s){return s.LOGIN="login",s.REGISTER="register",s})({}),FA="m.tz",qA="us.cloke.msc4175.tz";class KA{constructor(e){y(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(n=>n.on(e,t))}off(e,t){this.relations.forEach(n=>n.off(e,t))}}var HA=(function(s){return s.Global="Global",s.SetItemError="setItem",s.GetItemError="getItem",s.RemoveItemError="removeItem",s.ClearError="clear",s.QuotaExceededError="QuotaExceededError",s})({});class VA extends Lt{}var GA=new VA,IT=()=>new ld;function OT(s){IT=s}function MT(s){var e,t,n;return s.store=(e=s.store)!==null&&e!==void 0?e:new Wm({localStorage:globalThis.localStorage}),s.scheduler=(t=s.scheduler)!==null&&t!==void 0?t:new Zs,s.cryptoStore=(n=s.cryptoStore)!==null&&n!==void 0?n:IT(),s}function lm(s){return new bd(MT(s))}function zA(s,e,t,n){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new yT(s,e,t,MT(n),i)}const WA=Object.freeze(Object.defineProperty({__proto__:null,AuthType:om,AutoDiscovery:We,AutoDiscoveryAction:Xn,AutoDiscoveryError:hr,Beacon:m0,BeaconEvent:Nt,CallEvent:et,CallFeedEvent:Ur,Category:li,ClientEvent:Ue,ClientPrefix:Vt,ClientStoppedError:aM,ConditionKind:en,ConditionOperator:TO,ConnectionError:Ga,ContentHelpers:eI,DELEGATED_OIDC_COMPATIBILITY:xA,DEVICE_CODE_SCOPE:YM,DMMemberCountCondition:RO,DebugLogger:vm,Device:yA,DeviceVerification:bT,Direction:Qe,DuplicateStrategy:Pl,EVENT_VISIBILITY_CHANGE_TYPE:La,EventEmitterEvents:q_,EventStatus:He,EventTimeline:Oe,EventTimelineSet:qs,EventType:Z,FILTER_RELATED_BY_REL_TYPES:Ys,FILTER_RELATED_BY_SENDERS:Ws,FeatureSupport:bn,Filter:Qn,GET_LOGIN_TOKEN_CAPABILITY:eA,GroupCall:Am,GroupCallEvent:It,GroupCallIntent:x0,GroupCallState:Ft,GroupCallStatsReportEvent:Dl,GroupCallType:md,GuestAccess:rd,HTTPError:Ka,HistoryVisibility:Pm,HttpApiEvent:Av,IdentityPrefix:oi,IdentityProviderBrand:jA,IndexedDBCryptoStore:ct,IndexedDBStore:CA,InteractiveAuth:EA,InvalidCryptoStoreError:jm,InvalidCryptoStoreState:xm,JoinRule:B0,KNOWN_SAFE_ROOM_VERSION:A0,KeySignatureUploadError:iM,KnownMembership:Ye,LOCAL_NOTIFICATION_SETTINGS_PREFIX:G_,LocalStorageCryptoStore:_d,LocalStorageErrors:HA,LocationAssetType:Js,MAIN_ROOM_TIMELINE:nu,MAXIMUM_MATRIX_VERSION:DO,MAX_STICKY_DURATION_MS:zm,MINIMUM_MATRIX_VERSION:AO,MSC3912_RELATION_BASED_REDACTIONS_PROP:wv,MXID_PATTERN:mm,M_ASSET:eu,M_BEACON:Vv,M_BEACON_INFO:Nm,M_HTML:WC,M_LOCATION:tu,M_MESSAGE:zC,M_POLL_END:td,M_POLL_KIND_DISCLOSED:nI,M_POLL_KIND_UNDISCLOSED:rI,M_POLL_RESPONSE:Gl,M_POLL_START:iI,M_TEXT:bm,M_TIMESTAMP:na,M_TOPIC:Em,MatrixClient:bd,MatrixError:Dt,MatrixEvent:yn,MatrixEventEvent:mt,MatrixHttpApi:I0,MatrixSafetyError:R0,MatrixSafetyErrorCode:T0,MatrixScheduler:Zs,MediaHandlerEvent:ka,MediaPrefix:Vs,MemoryCryptoStore:ld,MemoryStore:Wm,Method:se,MsgType:jr,NoAuthFlowFoundError:ET,NotificationCountType:ht,OidcError:En,OidcTokenRefresher:XM,PUSHER_DEVICE_ID:DC,PUSHER_ENABLED:Cv,PendingEventOrdering:no,Poll:y0,PollEvent:zi,Preset:Um,ProfileKeyMSC4175Timezone:qA,ProfileKeyTimezone:FA,PushRuleActionName:$i,PushRuleKind:un,REFERENCE_RELATION:i0,ReceiptType:Tn,RelatedRelations:KA,RelationType:Mt,Relations:Sm,RelationsEvent:Fc,RestrictedAllowType:PO,Room:hd,RoomCreateTypeField:Qc,RoomEvent:ke,RoomMember:Hl,RoomMemberEvent:Un,RoomNameType:kr,RoomState:$l,RoomStateEvent:rt,RoomSummary:n0,RoomType:Hs,RoomVersionStability:O0,RoomWidgetClient:yT,RoomWidgetClientEvent:zc,RuleId:ln,SERVICE_TYPES:qv,SSOAction:BA,STABLE_MSC4133_EXTENDED_PROFILES:lT,SUPPORTED_MATRIX_VERSIONS:Wl,SearchOrderBy:F0,SearchResult:pd,SecretStorage:eM,ServerCapabilities:M0,SetPresence:D0,SlidingSyncEvent:Hv,StatsReport:hi,SyncAccumulator:ST,SyncState:gt,THREAD_RELATION_TYPE:wt,Thread:At,ThreadEvent:Rn,ThreadFilterType:Er,ThreepidMedium:LA,TimelineIndex:sm,TimelineWindow:bA,ToDeviceMessageId:dd,TokenRefreshError:_0,TokenRefreshLogoutError:Rm,TweakName:Dm,TypedEventEmitter:Lt,UNSIGNED_MEMBERSHIP_FIELD:z_,UNSIGNED_THREAD_ID_FIELD:Zc,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:V_,UNSTABLE_MSC2666_MUTUAL_ROOMS:aT,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:sT,UNSTABLE_MSC2666_SHARED_ROOMS:iT,UNSTABLE_MSC2716_MARKER:H_,UNSTABLE_MSC3088_ENABLED:Tv,UNSTABLE_MSC3088_PURPOSE:_v,UNSTABLE_MSC3089_BRANCH:ci,UNSTABLE_MSC3089_LEAF:K_,UNSTABLE_MSC3089_TREE_SUBTYPE:Rv,UNSTABLE_MSC3852_LAST_SEEN_UA:$M,UNSTABLE_MSC4133_EXTENDED_PROFILES:oT,UNSTABLE_MSC4140_DELAYED_EVENTS:pn,UNSTABLE_MSC4354_STICKY_EVENTS:am,UnsupportedDelayedEventsEndpointError:Zn,UnsupportedStickyEventsEndpointError:Qv,UpdateDelayedEventAction:Fa,User:pi,UserEvent:Jn,Visibility:UO,anySignal:w0,calculateRetryBackoff:C0,completeAuthorizationCodeGrant:WM,createClient:lm,createNewMatrixCall:zl,createRoomWidgetClient:zA,decodeBase64:Ba,decodeIdToken:eT,determineFeatureSupport:Vc,discoverAndValidateOIDCIssuerWellKnown:Vm,encodeBase64:Nl,encodeUnpaddedBase64:Mm,encodeUnpaddedBase64Url:vd,fixNotificationCountOnDecryption:uT,generateAuthorizationParams:HM,generateAuthorizationUrl:VM,generateOidcAuthorizationUrl:GM,generateScope:Sd,getBeaconInfoIdentifier:ed,getHttpUriForMxc:ud,inMainTimelineForReceipt:Zl,isDmMemberCountCondition:wO,isEventTypeSame:YC,isPollEvent:S0,isSendDelayedEventRequestOpts:Kv,isTimestampInDuration:Ov,localStorageErrorsEventsEmitter:GA,parseErrorResponse:wm,registerOidcClient:JM,retryNetworkOperation:Dv,safeGetRetryAfterMs:Tm,setCryptoStoreFactory:OT,threadFilterTypeToFilter:cT,threadIdForReceipt:ro,timeoutSignal:fd,validateAuthMetadata:$0,validateAuthMetadataAndKeys:Gm,validateBearerTokenResponse:rT,validateIdToken:tT,validateStoredUserState:nT},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var um;try{um=globalThis.indexedDB}catch{}um&&OT(()=>new ct(um,"matrix-js-sdk:crypto"));globalThis.matrixcs=WA;function YA(){try{return JSON.parse(localStorage.getItem("happychat_session")||"null")}catch{return null}}function JA(s){localStorage.setItem("happychat_session",JSON.stringify(s))}function XA(){localStorage.removeItem("happychat_session")}function QA(s){const e=(s||"").trim();return e?e.startsWith("http://")||e.startsWith("https://")?e:`https://${e}`:""}function ZA(s,e){const t=(s||"").trim();if(!t)return"";if(t.startsWith("@")&&t.includes(":"))return t;const n=(e||"").split(":")[1]||"matrix.org";return`@${t.startsWith("@")?t.slice(1):t}:${n}`}function $A(s){if(!s)return"";const e=new Date(s),t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");return`${t}:${n}`}function cm(s){return typeof s!="string"?"":s}function eD(s,e=18){if(!s||s.length<=e)return s;const t=Math.ceil((e-3)/2),n=Math.floor((e-3)/2);return`${s.slice(0,t)}...${s.slice(s.length-n)}`}function dm(s){try{return s?.getType?.()==="m.room.message"&&!!s?.getContent?.()?.body}catch{return!1}}function tD(){const[s,e]=st.useState(YA()),[t,n]=st.useState(null),[i,o]=st.useState([]),[u,d]=st.useState(null),[h,f]=st.useState([]),[m,g]=st.useState(""),[S,_]=st.useState(typeof window<"u"?window.innerWidth<900:!1),[b,T]=st.useState(""),[k,A]=st.useState(!1),[C,U]=st.useState(""),[O,M]=st.useState(!1),[E,I]=st.useState([]),w=s?.userId||null,q=st.useMemo(()=>!t||!u?null:t.getRoom(u)||null,[t,u]),z=st.useRef(null),ue=st.useRef(!1),Se=st.useRef(null);st.useEffect(()=>{z.current=u},[u]),st.useEffect(()=>{ue.current=S},[S]),st.useEffect(()=>{Se.current=w},[w]),st.useEffect(()=>{const B=document.documentElement,F=document.body,x=B.style.overflowX,j=F.style.overflowX;return B.style.overflowX="hidden",F.style.overflowX="hidden",()=>{B.style.overflowX=x,F.style.overflowX=j}},[]),st.useEffect(()=>{function B(){_(window.innerWidth<900)}return window.addEventListener("resize",B),()=>window.removeEventListener("resize",B)},[]);function Ie(B,F){if(!B||!F)return F||"";try{const x=B.getMember?.(F);return x?.name||x?.rawDisplayName||x?.displayName||F}catch{return F}}function Ze(B,F=64){if(!t||!B)return null;try{return B.getAvatarUrl?.(t.getHomeserverUrl(),F,F,"scale",!0)||null}catch{return null}}const me=st.useRef(!1);st.useEffect(()=>{if(!s)return;const B=lm({baseUrl:s.baseUrl,accessToken:s.accessToken,userId:s.userId,deviceId:s.deviceId});n(B);let F=null;const x=()=>{const re=B.getRooms().slice().sort((ye,Be)=>(Be.getLastActiveTimestamp?.()||0)-(ye.getLastActiveTimestamp?.()||0));o(re),!ue.current&&!me.current&&!z.current&&re[0]&&(me.current=!0,d(re[0].roomId))},j=()=>{F||(F=setTimeout(()=>{F=null,x()},500))},P=()=>{const re=z.current;if(!re)return I([]);const ye=B.getRoom(re);if(!ye)return I([]);const Be=Se.current,Ae=(ye.getTypingMembers?.()||[]).filter(qe=>qe?.userId&&qe.userId!==Be).map(qe=>qe?.name||qe?.rawDisplayName||qe?.displayName||qe?.userId).filter(Boolean).slice(0,3);I(Ae)},G=re=>{re==="PREPARED"&&(x(),P())},V=()=>j(),Y=(re,ye,Be)=>{if(Be)return;const Pe=z.current;Pe&&(!ye||ye.roomId!==Pe||dm(re)&&(f(Ae=>{const qe=Ae.concat(re);return qe.length>180?qe.slice(qe.length-180):qe}),j()))},$=re=>{const ye=z.current;!ye||!re||re.roomId!==ye||P()};return B.on("sync",G),B.on("Room",V),B.on("Room.timeline",Y),B.on("RoomMember.typing",$),(async()=>{try{typeof B.initRustCrypto=="function"&&await B.initRustCrypto({useIndexedDB:!0,cryptoDatabasePrefix:`happychat_${(s.userId||"u").replace(/[^a-z0-9]/gi,"_")}`})}catch(re){console.warn("E2E init failed:",re)}B.startClient({initialSyncLimit:10,lazyLoadMembers:!0})})(),()=>{B.removeListener("sync",G),B.removeListener("Room",V),B.removeListener("Room.timeline",Y),B.removeListener("RoomMember.typing",$);try{B.stopClient()}catch{}F&&clearTimeout(F)}},[s]),st.useEffect(()=>{if(!t||!u){f([]),I([]);return}const B=t.getRoom(u);if(!B){f([]),I([]);return}try{const x=B.getLiveTimeline().getEvents().filter(dm);f(x.slice(-180))}catch{f([])}try{const x=(B.getTypingMembers?.()||[]).filter(j=>j?.userId&&j.userId!==w).map(j=>j?.name||j?.rawDisplayName||j?.displayName||j?.userId).filter(Boolean).slice(0,3);I(x)}catch{I([])}},[t,u,w]);async function J({homeserver:B,username:F,password:x}){const j=QA(B);if(!j)throw new Error("Homeserver is empty");const G=await lm({baseUrl:j}).login("m.login.password",{user:F,password:x}),V={baseUrl:j,accessToken:G.access_token,userId:G.user_id,deviceId:G.device_id};JA(V),me.current=!1,e(V)}async function oe(){try{t&&await t.logout()}catch{}XA(),n(null),e(null),o([]),d(null),f([]),T(""),I([]),me.current=!1}async function pe(){if(!t||!u)return;const B=b.trim();if(!B)return;try{await t.sendTyping(u,!1)}catch{}const F=t.makeTxnId?t.makeTxnId():`${Date.now()}`;await t.sendEvent(u,"m.room.message",{msgtype:"m.text",body:B},F),T("")}async function Te(){if(!t||!w)return;const B=ZA(C,w);if(B){M(!0);try{const F=await t.createRoom({invite:[B],is_direct:!0,preset:"trusted_private_chat",name:`DM with ${B}`,initial_state:[{type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]}),x=F?.room_id||F?.roomId;A(!1),U(""),x&&d(x)}catch(F){alert(String(F?.message||F))}finally{M(!1)}}}const De=st.useRef(null),H=st.useRef(!1);async function le(B){if(!(!t||!u))try{B?H.current||(H.current=!0,await t.sendTyping(u,!0,4e3)):(H.current=!1,await t.sendTyping(u,!1))}catch{}}function Re(B){if(T(B),!B.trim()){De.current&&clearTimeout(De.current),De.current=setTimeout(()=>le(!1),200);return}le(!0),De.current&&clearTimeout(De.current),De.current=setTimeout(()=>le(!1),1400)}const X=st.useMemo(()=>{const B=m.trim().toLowerCase();return B?i.filter(F=>{const x=(F.name||F.roomId||"").toLowerCase(),j=(F.getLastLiveEvent?.()?.getContent?.()?.body||"").toLowerCase();return x.includes(B)||j.includes(B)}):i},[i,m]);if(!s)return Ee.jsx(iD,{onLogin:J});const fe={height:"100vh",width:"100vw",maxWidth:"100vw",overflowX:"hidden",fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Arial",background:"#fff",color:"#111"};return S?Ee.jsxs("div",{style:fe,children:[Ee.jsx(rD,{title:"HappyChat",right:Ee.jsxs(Ee.Fragment,{children:[Ee.jsx(xr,{onClick:()=>A(!0),children:"New"}),Ee.jsx(xr,{onClick:oe,subtle:!0,children:"Logout"})]})}),u?Ee.jsx(A_,{myUserId:w,room:q,events:h,typingUsers:E,message:b,setMessage:Re,onSend:pe,onBack:()=>d(null),client:t,senderDisplayName:Ie}):Ee.jsxs("div",{style:{padding:12,maxWidth:"100vw",overflowX:"hidden"},children:[Ee.jsx(O_,{value:m,onChange:g}),Ee.jsx("div",{style:{height:10}}),Ee.jsx(M_,{rooms:X,activeRoomId:null,onOpen:B=>d(B),roomAvatarUrl:Ze,senderDisplayName:Ie,emptyHint:"  .  New.",myUserId:w})]}),k?Ee.jsxs(D_,{title:"New chat (E2E DM)",onClose:()=>!O&&A(!1),children:[Ee.jsxs("div",{style:{color:"#666",fontSize:13,marginBottom:10},children:[" Matrix ID (",Ee.jsx("code",{children:"@user:matrix.org"}),")  . DM   ",Ee.jsx("b",{children:" E2E"}),"."]}),Ee.jsx("input",{value:C,onChange:B=>U(B.target.value),placeholder:"@user:matrix.org",autoCapitalize:"none",autoCorrect:"off",style:Fl}),Ee.jsx("div",{style:{height:12}}),Ee.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[Ee.jsx(xr,{subtle:!0,onClick:()=>!O&&A(!1),children:"Cancel"}),Ee.jsx(xr,{onClick:Te,disabled:O||!C.trim(),children:O?"Creating...":"Create"})]})]}):null]}):Ee.jsxs("div",{style:{...fe,display:"flex"},children:[Ee.jsxs("aside",{style:nD,children:[Ee.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:[Ee.jsx("div",{style:{fontWeight:800,letterSpacing:.2},children:"HappyChat"}),Ee.jsxs("div",{style:{display:"flex",gap:8},children:[Ee.jsx(xr,{onClick:()=>A(!0),children:"New"}),Ee.jsx(xr,{onClick:oe,subtle:!0,children:"Logout"})]})]}),Ee.jsx("div",{style:{height:12}}),Ee.jsx(O_,{value:m,onChange:g}),Ee.jsx("div",{style:{height:12}}),Ee.jsx("div",{style:{overflow:"auto",height:"calc(100vh - 120px)"},children:Ee.jsx(M_,{rooms:X,activeRoomId:u,onOpen:B=>d(B),roomAvatarUrl:Ze,senderDisplayName:Ie,emptyHint:"  .  New.",myUserId:w})})]}),Ee.jsx("main",{style:{flex:1,minWidth:0},children:q?Ee.jsx(A_,{myUserId:w,room:q,events:h,typingUsers:E,message:b,setMessage:Re,onSend:pe,client:t,senderDisplayName:Ie}):Ee.jsx("div",{style:{height:"100vh",display:"grid",placeItems:"center",color:"#666"},children:"     New."})}),k?Ee.jsxs(D_,{title:"New chat (E2E DM)",onClose:()=>!O&&A(!1),children:[Ee.jsxs("div",{style:{color:"#666",fontSize:13,marginBottom:10},children:[" Matrix ID (",Ee.jsx("code",{children:"@user:matrix.org"}),")  . DM   ",Ee.jsx("b",{children:" E2E"}),"."]}),Ee.jsx("input",{value:C,onChange:B=>U(B.target.value),placeholder:"@user:matrix.org",autoCapitalize:"none",autoCorrect:"off",style:Fl}),Ee.jsx("div",{style:{height:12}}),Ee.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[Ee.jsx(xr,{subtle:!0,onClick:()=>!O&&A(!1),children:"Cancel"}),Ee.jsx(xr,{onClick:Te,disabled:O||!C.trim(),children:O?"Creating...":"Create"})]})]}):null]})}const nD={width:360,borderRight:"1px solid #eee",padding:14,boxSizing:"border-box",minWidth:0},Fl={width:"100%",padding:"12px 12px",borderRadius:12,border:"1px solid #ddd",outline:"none",fontSize:14,boxSizing:"border-box"};function rD({title:s,right:e}){return Ee.jsxs("header",{style:{height:52,padding:"0 12px",borderBottom:"1px solid #eee",display:"flex",alignItems:"center",justifyContent:"space-between",gap:10},children:[Ee.jsx("div",{style:{fontWeight:800},children:s}),Ee.jsx("div",{style:{display:"flex",gap:8},children:e})]})}function xr({children:s,onClick:e,subtle:t,disabled:n}){return Ee.jsx("button",{onClick:e,disabled:n,style:{padding:"8px 12px",borderRadius:12,border:"1px solid "+(t?"#e6e6e6":"#111"),background:t?"#fff":"#111",color:t?"#111":"#fff",fontWeight:700,cursor:n?"not-allowed":"pointer",opacity:n?.6:1},children:s})}function O_({value:s,onChange:e}){return Ee.jsx("input",{value:s,onChange:t=>e(t.target.value),placeholder:"Search chats...",style:{width:"100%",padding:"10px 12px",borderRadius:12,border:"1px solid #ddd",outline:"none",fontSize:14,boxSizing:"border-box"}})}function M_({rooms:s,activeRoomId:e,onOpen:t,roomAvatarUrl:n,senderDisplayName:i,emptyHint:o,myUserId:u}){return s.length?Ee.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8,maxWidth:"100vw",overflowX:"hidden"},children:s.map(d=>{const h=n?.(d,64),f=d.getLastLiveEvent?.(),m=f?.getContent?.()?.body||"",g=f?.getSender?.()||"",S=g?i(d,g):"",_=e&&d.roomId===e,b=cm(m)&&`${g?(g===u?"You":eD(S||g,18))+": ":""}${cm(m)}`;return Ee.jsxs("div",{role:"button",tabIndex:0,onClick:()=>t(d.roomId),onKeyDown:T=>T.key==="Enter"?t(d.roomId):null,style:{display:"flex",gap:10,padding:10,borderRadius:14,border:"1px solid "+(_?"#111":"#eee"),background:_?"#111":"#fff",cursor:"pointer",userSelect:"none",minWidth:0,maxWidth:"100%",overflow:"hidden"},children:[Ee.jsx("div",{style:{width:44,height:44,borderRadius:14,overflow:"hidden",background:_?"#222":"#f3f3f3",display:"grid",placeItems:"center",flex:"0 0 auto"},children:h?Ee.jsx("img",{src:h,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"}}):Ee.jsx("div",{style:{fontWeight:900,color:_?"#fff":"#111"},children:(d.name||"C").slice(0,1).toUpperCase()})}),Ee.jsxs("div",{style:{minWidth:0,flex:1,maxWidth:"100%",overflow:"hidden"},children:[Ee.jsx("div",{style:{fontWeight:800,color:_?"#fff":"#111",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},title:d.name||d.roomId,children:d.name||d.roomId}),Ee.jsx("div",{style:{fontSize:13,color:_?"#cfcfcf":"#666",marginTop:2,minWidth:0,maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:b||"",children:b||""})]})]},d.roomId)})}):Ee.jsx("div",{style:{color:"#666",padding:12},children:o})}function A_({myUserId:s,room:e,events:t,typingUsers:n,message:i,setMessage:o,onSend:u,onBack:d,client:h,senderDisplayName:f}){const m=st.useRef(null),g=st.useMemo(()=>(t||[]).filter(dm),[t]);st.useEffect(()=>{m.current?.scrollIntoView({block:"end",behavior:"smooth"})},[g.length,e?.roomId]),st.useEffect(()=>{if(!h||!e||!g.length)return;const _=[...g].reverse().find(b=>b.getSender?.()&&b.getSender?.()!==s);if(_)try{typeof h.sendReadReceipt=="function"&&h.sendReadReceipt(_)}catch{}},[h,e?.roomId,g.length,s]);const S=(n||[]).filter(Boolean).join(", ");return Ee.jsxs("div",{style:{height:"100vh",display:"flex",flexDirection:"column",minWidth:0,overflowX:"hidden"},children:[Ee.jsxs("header",{style:{height:64,padding:"0 12px",borderBottom:"1px solid #eee",display:"flex",alignItems:"center",gap:10,minWidth:0},children:[d?Ee.jsx("button",{onClick:d,style:{width:40,height:40,borderRadius:12,border:"1px solid #eee",background:"#fff",cursor:"pointer",fontSize:18,flex:"0 0 auto"},children:""}):null,Ee.jsxs("div",{style:{minWidth:0,flex:1},children:[Ee.jsx("div",{style:{fontWeight:900,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:e?.name||"Chat"}),Ee.jsx("div",{style:{fontSize:12,color:"#666",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:S?`${S} typing`:e?.roomId})]})]}),Ee.jsxs("div",{style:{flex:1,overflow:"auto",padding:12,background:"#fafafa"},children:[g.map(_=>{const b=_.getSender?.()||"",T=!!s&&b===s,k=b?f(e,b):"",A=cm(_.getContent?.()?.body),C=_.getTs?.();return Ee.jsx("div",{style:{display:"flex",justifyContent:T?"flex-end":"flex-start",marginBottom:10},children:Ee.jsxs("div",{style:{maxWidth:"78%",padding:"10px 12px",borderRadius:16,background:T?"#111":"#fff",border:T?"1px solid #111":"1px solid #e8e8e8",color:T?"#fff":"#111",minWidth:0},children:[T?null:Ee.jsx("div",{style:{fontSize:12,color:"#666",marginBottom:4,maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:k||b,children:k||b}),Ee.jsx("div",{style:{whiteSpace:"pre-wrap",overflowWrap:"anywhere"},children:A}),Ee.jsx("div",{style:{fontSize:11,marginTop:6,color:T?"#cfcfcf":"#888",textAlign:"right"},children:$A(C)})]})},_.getId?.()||`${b}-${C}-${Math.random()}`)}),Ee.jsx("div",{ref:m})]}),Ee.jsx("footer",{style:{padding:12,borderTop:"1px solid #eee",background:"#fff"},children:Ee.jsxs("div",{style:{display:"flex",gap:8},children:[Ee.jsx("input",{value:i,onChange:_=>o(_.target.value),onKeyDown:_=>_.key==="Enter"?u():null,placeholder:"Message",style:{flex:1,padding:"12px 12px",borderRadius:14,border:"1px solid #ddd",outline:"none",fontSize:14,minWidth:0}}),Ee.jsx(xr,{onClick:u,disabled:!i.trim(),children:"Send"})]})})]})}function D_({title:s,children:e,onClose:t}){return Ee.jsx("div",{onMouseDown:t,style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",display:"grid",placeItems:"center",padding:12,zIndex:1e3},children:Ee.jsxs("div",{onMouseDown:n=>n.stopPropagation(),style:{width:"min(520px, 100%)",background:"#fff",borderRadius:18,border:"1px solid #eee",padding:14,boxShadow:"0 10px 30px rgba(0,0,0,0.18)",maxWidth:"100vw",overflowX:"hidden"},children:[Ee.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:10},children:[Ee.jsx("div",{style:{fontWeight:900},children:s}),Ee.jsx("button",{onClick:t,style:{width:40,height:40,borderRadius:12,border:"1px solid #eee",background:"#fff",cursor:"pointer",fontSize:18},children:""})]}),Ee.jsx("div",{style:{height:12}}),e]})})}function iD({onLogin:s}){const[e,t]=st.useState("matrix.org"),[n,i]=st.useState(""),[o,u]=st.useState(""),[d,h]=st.useState(""),[f,m]=st.useState(!1);return Ee.jsxs("div",{style:{maxWidth:440,margin:"40px auto",padding:12,fontFamily:"system-ui",maxWidth:"100vw",overflowX:"hidden"},children:[Ee.jsx("h2",{style:{marginBottom:6},children:"Login"}),Ee.jsxs("div",{style:{color:"#666",fontSize:13,marginBottom:16},children:["Homeserver: ",Ee.jsx("code",{children:"matrix.org"}),". Username  : ",Ee.jsx("code",{children:"@name:server"}),"."]}),Ee.jsxs("div",{style:{display:"grid",gap:10},children:[Ee.jsxs("div",{children:[Ee.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"Homeserver"}),Ee.jsx("input",{value:e,onChange:g=>t(g.target.value),style:Fl,autoCapitalize:"none",autoCorrect:"off"})]}),Ee.jsxs("div",{children:[Ee.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"Username"}),Ee.jsx("input",{value:n,onChange:g=>i(g.target.value),style:Fl,autoCapitalize:"none",autoCorrect:"off"})]}),Ee.jsxs("div",{children:[Ee.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"Password"}),Ee.jsx("input",{type:"password",value:o,onChange:g=>u(g.target.value),style:Fl})]}),d?Ee.jsx("div",{style:{color:"crimson"},children:d}):null,Ee.jsx(xr,{onClick:async()=>{h(""),m(!0);try{await s({homeserver:e,username:n,password:o})}catch(g){h(String(g?.message||g)),m(!1)}},disabled:f||!e.trim()||!n.trim()||!o,children:f?"Loading...":"Login"})]})]})}Zw.createRoot(document.getElementById("root")).render(Ee.jsx(st.StrictMode,{children:Ee.jsx(tD,{})}));export{uD as A,mD as B,on as C,XO as D,Z as E,ct as F,Xs as G,Pm as H,fD as I,ZO as J,Ye as K,oD as L,se as M,Ua as S,Lt as T,cD as U,D as _,y as a,lD as b,dd as c,Ba as d,Ce as e,C0 as f,k_ as g,bT as h,yA as i,lo as j,jr as k,sD as l,Dt as m,Vt as n,aM as o,Nl as p,ud as q,dD as r,iu as s,hD as t,Zi as u,mt as v,mi as w,zE as x,JO as y,vD as z};
